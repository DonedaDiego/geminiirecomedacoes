<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Long & Short - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#000000',
            light: '#ffffff',
            subtle: 'rgba(255,255,255,0.1)',
            geminii: '#ba39af'
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
      min-height: 100vh;
    }
    
    .longshort-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      transition: all 0.3s ease;
    }
    
    .longshort-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(186, 57, 175, 0.15);
      border-color: rgba(186, 57, 175, 0.3);
    }
    
    .spinner {
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 2px solid #ba39af;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .pair-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin: 10px 0;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .pair-card:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(186, 57, 175, 0.3);
      transform: translateY(-2px);
    }
    
    .direction-buy {
      color: #22c55e;
      font-weight: 600;
    }
    
    .direction-sell {
      color: #ef4444;
      font-weight: 600;
    }
    
    .direction-compra {
      color: #22c55e;
      font-weight: 600;
    }
    
    .direction-venda {
      color: #ef4444;
      font-weight: 600;
    }
    
    .status-favoravel {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-cautela {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-nao-recomendado {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .metric-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }
    
    .tab-active {
      background: rgba(186, 57, 175, 0.2);
      border-color: #ba39af;
      color: #ba39af;
    }
    
    .tab-inactive {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.2);
      color: #9ca3af;
    }
    
    .financial-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      margin: 8px 0;
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    select {
      background-color: rgba(255, 255, 255, 0.1) !important;
      color: white !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
    }
    
    select option {
      background-color: #1f2937 !important;
      color: white !important;
    }
    
    select:focus {
      border-color: #ba39af !important;
      outline: none !important;
    }
  </style>
</head>
<body class="bg-black text-white">
  <div class="relative min-h-screen">
    
    <!-- Glass floating navbar -->
    <nav class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-opacity-5 border-opacity-10 bg-white border-white border rounded-full px-4 py-3 shadow-xl backdrop-blur-md">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <img src="/assets/logo.png" alt="Geminii Logo" class="w-6 h-6 cursor-pointer" onclick="window.location.href='/dashboard'">
        </div>
        <div class="hidden md:flex items-center space-x-6 text-xs text-gray-300 ml-8">
          <a href="/dashboard" class="hover:text-white transition-colors">Dashboard</a>
          <span class="text-white font-medium">Long & Short</span>
          <a href="/regimes-volatilidade.html" class="hover:text-white transition-colors">Regime de Volatilidade</a>
        </div>
        <div class="flex items-center space-x-3 ml-8">
          <div id="apiStatus" class="w-8 h-8 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-full flex items-center justify-center relative">
            <i class="fas fa-chart-line text-green-500 text-xs"></i>
            <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
          </div>
        </div>
      </div>
    </nav>
    
    <!-- Content -->
    <div class="relative z-10 pt-32 pb-16">
      <div class="max-w-7xl mx-auto px-6">
        
        <!-- Header -->
        <div class="text-center mb-8">
          <h1 class="text-4xl md:text-5xl font-bold mb-4">
             <span class="text-geminii">Long & Short</span>
          </h1>
          <p class="text-xl text-gray-300 mb-6">An√°lise por Cointegra√ß√£o de Pares</p>
          <p class="text-gray-400 max-w-3xl mx-auto">
            Identifique oportunidades de arbitragem estat√≠stica atrav√©s da an√°lise de cointegra√ß√£o entre pares de a√ß√µes.
            Estrat√©gia baseada na revers√£o √† m√©dia de spreads estatisticamente significativos.
          </p>
        </div>

        <!-- Par√¢metros de An√°lise -->
        <div class="longshort-card p-6 mb-8">
          <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
            <i class="fas fa-cogs text-geminii"></i>
            Par√¢metros de An√°lise
          </h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div>
              <label class="block text-sm text-gray-400 mb-2">Investimento (R$)</label>
              <input 
                id="investimentoInput" 
                type="number" 
                min="1000" 
                step="1000" 
                value="10000"
                class="w-full px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-geminii"
              >
            </div>
            
            <div>
              <label class="block text-sm text-gray-400 mb-2">Per√≠odo (dias)</label>
              <select 
                id="diasInput" 
                class="w-full px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white focus:outline-none focus:border-geminii"
              >
                <option value="60">60 dias</option>
                <option value="90">90 dias</option>
                <option value="120">120 dias</option>
                <option value="140">140 dias</option>
                <option value="180">180 dias</option>
                <option value="200">200 dias</option>
                <option value="240" selected>240 dias</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm text-gray-400 mb-2">Z-Score M√≠nimo</label>
              <input 
                id="zscoreInput" 
                type="number" 
                min="1.0" 
                max="4.0" 
                step="0.1" 
                value="2.0"
                class="w-full px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-geminii"
              >
            </div>
            
            <div class="flex items-end">
              <button 
                id="analyzeBtn" 
                class="w-full px-6 py-2 bg-gradient-to-r from-pink-500 to-purple-600 hover:shadow-lg rounded-lg transition-all font-medium"
              >
                <i class="fas fa-search mr-2"></i>Analisar Pares
              </button>
            </div>
          </div>
          
          <div id="statusMessage" class="hidden p-4 rounded-lg text-center">
            <!-- Status da an√°lise -->
          </div>
        </div>

        <!-- Resultados -->
        <div id="resultsSection" class="hidden">
          
          <!-- Estat√≠sticas Gerais -->
          <div class="longshort-card p-6 mb-8">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
              <i class="fas fa-chart-bar text-geminii"></i>
              Resultado da An√°lise
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div class="metric-card">
                <div class="text-2xl font-bold text-geminii" id="totalAnalysed">0</div>
                <div class="text-sm text-gray-400 mt-1">Pares Analisados</div>
              </div>
              
              <div class="metric-card">
                <div class="text-2xl font-bold text-green-400" id="totalOpportunities">0</div>
                <div class="text-sm text-gray-400 mt-1">Oportunidades</div>
              </div>
              
              <div class="metric-card">
                <div class="text-2xl font-bold text-blue-400" id="sectorsInvolved">0</div>
                <div class="text-sm text-gray-400 mt-1">Setores Envolvidos</div>
              </div>
              
              <div class="metric-card">
                <div class="text-2xl font-bold text-yellow-400" id="successRate">0%</div>
                <div class="text-sm text-gray-400 mt-1">Taxa de Sucesso</div>
              </div>
            </div>
          </div>
          
          <!-- Lista de Pares -->
          <div class="longshort-card p-6 mb-8">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
              <i class="fas fa-list text-geminii"></i>
              Oportunidades Identificadas
            </h2>
            
            <div id="pairsList" class="space-y-4">
              <!-- Pares ser√£o inseridos aqui -->
            </div>
          </div>
        </div>

        <!-- An√°lise Detalhada -->
        <div id="detailedAnalysisSection" class="hidden">
          <div class="longshort-card p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-bold flex items-center gap-2">
                <i class="fas fa-microscope text-geminii"></i>
                An√°lise Detalhada: <span id="pairTitle">Carregando...</span>
              </h2>
              <button 
                id="backToListBtn" 
                class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition-all text-sm"
              >
                <i class="fas fa-arrow-left mr-2"></i>Voltar
              </button>
            </div>
            
            <!-- Tabs -->
            <div class="flex flex-wrap gap-2 mb-6 border-b border-gray-600">
              <button class="tab-btn tab-active px-4 py-2 rounded-t-lg border-b-2 transition-all" data-tab="overview">
                <i class="fas fa-chart-line mr-2"></i>Vis√£o Geral
              </button>
              <button class="tab-btn tab-inactive px-4 py-2 rounded-t-lg border-b-2 transition-all" data-tab="financial">
                <i class="fas fa-calculator mr-2"></i>Resumo Financeiro
              </button>
              <button class="tab-btn tab-inactive px-4 py-2 rounded-t-lg border-b-2 transition-all" data-tab="charts">
                <i class="fas fa-chart-area mr-2"></i>Gr√°ficos
              </button>
              <button class="tab-btn tab-inactive px-4 py-2 rounded-t-lg border-b-2 transition-all" data-tab="margin">
                <i class="fas fa-coins mr-2"></i>Margem & Custos
              </button>
              <button class="tab-btn tab-inactive px-4 py-2 rounded-t-lg border-b-2 transition-all" data-tab="stability">
                <i class="fas fa-balance-scale mr-2"></i>Estabilidade
              </button>
            </div>
            
            <!-- Tab Contents -->
            <div id="tabContents">
              <!-- Conte√∫do das tabs ser√° inserido aqui -->
            </div>
          </div>
        </div>
        
        <!-- Disclaimer -->
        <div class="longshort-card p-6">
          <h3 class="text-lg font-bold mb-4 text-yellow-400">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            Importante - Disclaimer
          </h3>
          <div class="text-gray-300 space-y-3 text-sm">
            <p>
              <strong>Din√¢mica de Mercado:</strong> A efic√°cia desta estrat√©gia depende da din√¢mica do mercado. 
              Nem sempre os pares se comportam como esperado, pois eventos inesperados, mudan√ßas no cen√°rio econ√¥mico, 
              not√≠cias ou fundamentos das empresas podem afetar a rela√ß√£o entre os pre√ßos.
            </p>
            <p>
              <strong>Monitoramento Constante:</strong> O sucesso da estrat√©gia depende de monitorar constantemente 
              os trades e adaptar os par√¢metros conforme as condi√ß√µes do mercado mudam.
            </p>
            <p>
              <strong>Aviso Legal:</strong> O conte√∫do deste material √© destinado exclusivamente a fins informativos 
              e educacionais. As an√°lises, opini√µes e informa√ß√µes apresentadas n√£o constituem recomenda√ß√£o de investimento. 
              Cada investidor deve fazer sua pr√≥pria an√°lise e tomar suas decis√µes de forma independente.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== ESTADO DA APLICA√á√ÉO =====
    let currentAnalysis = null;
    let dadosCache = null;
    let currentDetailedData = null;
    
    // ===== ELEMENTOS DOM =====
    const analyzeBtn = document.getElementById('analyzeBtn');
    const investimentoInput = document.getElementById('investimentoInput');
    const diasInput = document.getElementById('diasInput');
    const zscoreInput = document.getElementById('zscoreInput');
    const statusMessage = document.getElementById('statusMessage');
    const resultsSection = document.getElementById('resultsSection');
    const detailedAnalysisSection = document.getElementById('detailedAnalysisSection');
    
    // ===== EVENT LISTENERS =====
    analyzeBtn.addEventListener('click', executarAnalise);
    document.getElementById('backToListBtn').addEventListener('click', voltarParaLista);
    
    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const tabName = e.target.dataset.tab;
        switchTab(tabName);
      });
    });
    
    // ===== FUN√á√ÉO PRINCIPAL DE AN√ÅLISE =====
    async function executarAnalise() {
      try {
        showStatus('Iniciando an√°lise de pares... Isso pode levar alguns minutos.', 'info');
        setLoading(analyzeBtn, true);
        
        const dados = {
          investimento: parseFloat(investimentoInput.value),
          dias: parseInt(diasInput.value),
          zscore_minimo: parseFloat(zscoreInput.value)
        };
        
        // Valida√ß√µes
        if (dados.investimento < 1000) {
          showStatus('Investimento deve ser maior que R$ 1.000', 'error');
          return;
        }
        
        if (dados.zscore_minimo < 1.0 || dados.zscore_minimo > 4.0) {
          showStatus('Z-Score deve estar entre 1.0 e 4.0', 'error');
          return;
        }
        
        // Fazer requisi√ß√£o
        const response = await fetch('/api/long-short/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dados)
        });
        
        const result = await response.json();
        
        if (result.success) {
          currentAnalysis = result.data;
          dadosCache = result.data.dados_cache;
          displayResults(result.data);
          showStatus(`An√°lise conclu√≠da! ${result.data.total_oportunidades} oportunidades encontradas.`, 'success');
        } else {
          showStatus(`Erro: ${result.error}`, 'error');
        }
        
      } catch (error) {
        showStatus(`Erro na an√°lise: ${error.message}`, 'error');
        console.error('Erro na an√°lise:', error);
      } finally {
        setLoading(analyzeBtn, false);
      }
    }
    
    // ===== EXIBIR RESULTADOS =====
    function displayResults(data) {
      // Estat√≠sticas gerais
      document.getElementById('totalAnalysed').textContent = data.total_analisados.toLocaleString('pt-BR');
      document.getElementById('totalOpportunities').textContent = data.total_oportunidades.toLocaleString('pt-BR');
      document.getElementById('sectorsInvolved').textContent = data.setores_envolvidos.toLocaleString('pt-BR');
      
      const successRate = ((data.total_oportunidades / data.total_analisados) * 100).toFixed(2);
      document.getElementById('successRate').textContent = `${successRate}%`;
      
      // Lista de pares
      const pairsList = document.getElementById('pairsList');
      pairsList.innerHTML = '';
      
      if (data.pares_oportunidade.length === 0) {
        pairsList.innerHTML = `
          <div class="text-center py-8 text-gray-400">
            <i class="fas fa-search text-4xl mb-4"></i>
            <p>Nenhuma oportunidade encontrada com os par√¢metros atuais.</p>
            <p class="text-sm mt-2">Tente ajustar o Z-Score m√≠nimo ou o per√≠odo de an√°lise.</p>
          </div>
        `;
      } else {
        data.pares_oportunidade.forEach((par, index) => {
          const pairCard = createPairCard(par, index);
          pairsList.appendChild(pairCard);
        });
      }
      
      resultsSection.classList.remove('hidden');
    }
    
    // ===== CRIAR CARD DE PAR =====
    function createPairCard(par, index) {
      const card = document.createElement('div');
      card.className = 'pair-card';
      card.onclick = () => analisarParDetalhado(par);
      
      const statusClass = getStatusClass(par.status_beta);
      const zscoreColor = par.zscore_atual > 0 ? 'text-red-400' : 'text-green-400';
      const zscoreIcon = par.zscore_atual > 0 ? '‚Üë' : '‚Üì';
      
      card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 class="text-lg font-bold text-white">#${index + 1} ${par.acao1} √ó ${par.acao2}</h3>
            <div class="flex gap-4 text-sm text-gray-400 mt-1">
              <span><i class="fas fa-industry mr-1"></i>${par.setor1}</span>
              <span><i class="fas fa-industry mr-1"></i>${par.setor2}</span>
            </div>
          </div>
          <div class="text-right">
            <div class="text-xl font-bold ${zscoreColor}">
              ${zscoreIcon} ${Math.abs(par.zscore_atual).toFixed(2)}
            </div>
            <div class="text-sm text-gray-400">Z-Score</div>
          </div>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
          <div class="text-center">
            <div class="text-sm text-gray-400">Beta</div>
            <div class="font-semibold">${par.beta.toFixed(3)}</div>
          </div>
          <div class="text-center">
            <div class="text-sm text-gray-400">Correla√ß√£o</div>
            <div class="font-semibold">${par.correlacao.toFixed(3)}</div>
          </div>
          <div class="text-center">
            <div class="text-sm text-gray-400">Meia-vida</div>
            <div class="font-semibold">${par.meia_vida.toFixed(1)}d</div>
          </div>
          <div class="text-center">
            <div class="text-sm text-gray-400">Status Beta</div>
            <div class="${statusClass}">${par.status_beta}</div>
          </div>
        </div>
        
        <div class="flex justify-between items-center">
          <div class="flex gap-4">
            <span class="direction-${par.direcao_acao1.toLowerCase()}">
              <i class="fas fa-arrow-${par.direcao_acao1 === 'Compra' ? 'up' : 'down'} mr-1"></i>
              ${par.acao1}: ${par.direcao_acao1}
            </span>
            <span class="direction-${par.direcao_acao2.toLowerCase()}">
              <i class="fas fa-arrow-${par.direcao_acao2 === 'Compra' ? 'up' : 'down'} mr-1"></i>
              ${par.acao2}: ${par.direcao_acao2}
            </span>
          </div>
          <button class="text-geminii hover:text-purple-300 transition-colors">
            <i class="fas fa-chevron-right mr-1"></i>Analisar
          </button>
        </div>
      `;
      
      return card;
    }
    
    // ===== FUN√á√ÉO PARA CLASSE DE STATUS =====
    function getStatusClass(status) {
      switch (status) {
        case 'Favor√°vel': return 'status-favoravel';
        case 'Cautela': return 'status-cautela';
        case 'N√£o Recomendado': return 'status-nao-recomendado';
        default: return 'text-gray-400';
      }
    }
    
    // ===== AN√ÅLISE DETALHADA =====
    async function analisarParDetalhado(par) {
      try {
        showStatus('Carregando an√°lise detalhada...', 'info');
        
        const response = await fetch('/api/long-short/pair-detail', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            acao1: par.acao1,
            acao2: par.acao2,
            dados_cache: dadosCache,
            investimento: parseFloat(investimentoInput.value)
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          displayDetailedAnalysis(result.data);
          resultsSection.classList.add('hidden');
          detailedAnalysisSection.classList.remove('hidden');
          statusMessage.classList.add('hidden');
        } else {
          showStatus(`Erro: ${result.error}`, 'error');
        }
        
      } catch (error) {
        showStatus(`Erro na an√°lise detalhada: ${error.message}`, 'error');
        console.error('Erro na an√°lise detalhada:', error);
      }
    }
    
    // ===== EXIBIR AN√ÅLISE DETALHADA =====
    function displayDetailedAnalysis(data) {
      document.getElementById('pairTitle').textContent = `${data.acao1} √ó ${data.acao2}`;
      currentDetailedData = data;
      
      // Carregar aba inicial
      switchTab('overview');
    }
    
    // ===== SISTEMA DE TABS =====
    function switchTab(tabName) {
      // Atualizar apar√™ncia das tabs
      document.querySelectorAll('.tab-btn').forEach(btn => {
        if (btn.dataset.tab === tabName) {
          btn.className = 'tab-btn tab-active px-4 py-2 rounded-t-lg border-b-2 transition-all';
        } else {
          btn.className = 'tab-btn tab-inactive px-4 py-2 rounded-t-lg border-b-2 transition-all';
        }
      });
      
      // Carregar conte√∫do da tab
      const tabContents = document.getElementById('tabContents');
      
      switch (tabName) {
        case 'overview':
          loadOverviewTab(tabContents);
          break;
        case 'financial':
          loadFinancialTab(tabContents);
          break;
        case 'charts':
          loadChartsTab(tabContents);
          break;
        case 'margin':
          loadMarginTab(tabContents);
          break;
        case 'stability':
          loadStabilityTab(tabContents);
          break;
      }
    }
    
    // ===== CARREGAR TAB OVERVIEW =====
    function loadOverviewTab(container) {
      if (!currentDetailedData) return;
      
      const data = currentDetailedData;
      
      container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h3 class="text-lg font-semibold mb-4">Informa√ß√µes dos Ativos</h3>
            <div class="space-y-4">
              <div class="financial-item">
                <span><i class="fas fa-chart-line mr-2"></i>${data.acao1} (${data.setor1})</span>
                <span class="font-semibold">R$ ${data.ultimo_preco1.toFixed(2)}</span>
              </div>
              <div class="financial-item">
                <span><i class="fas fa-chart-line mr-2"></i>${data.acao2} (${data.setor2})</span>
                <span class="font-semibold">R$ ${data.ultimo_preco2.toFixed(2)}</span>
              </div>
            </div>
          </div>
          
          <div>
            <h3 class="text-lg font-semibold mb-4">M√©tricas Estat√≠sticas</h3>
            <div class="space-y-4">
              <div class="financial-item">
                <span><i class="fas fa-calculator mr-2"></i>Beta</span>
                <span class="font-semibold">${data.beta.toFixed(4)}</span>
              </div>
              <div class="financial-item">
                <span><i class="fas fa-link mr-2"></i>Correla√ß√£o</span>
                <span class="font-semibold">${data.correlacao.toFixed(4)}</span>
              </div>
              <div class="financial-item">
                <span><i class="fas fa-chart-area mr-2"></i>R¬≤</span>
                <span class="font-semibold">${data.r_squared.toFixed(4)}</span>
              </div>
              <div class="financial-item">
                <span><i class="fas fa-clock mr-2"></i>Meia-vida</span>
                <span class="font-semibold">${data.meia_vida ? data.meia_vida.toFixed(1) + ' dias' : 'N/A'}</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="mt-8">
          <h3 class="text-lg font-semibold mb-4">Situa√ß√£o Atual do Par</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="metric-card">
              <div class="text-2xl font-bold ${data.zscore_atual > 0 ? 'text-red-400' : 'text-green-400'}">
                ${data.zscore_atual.toFixed(3)}
              </div>
              <div class="text-sm text-gray-400 mt-1">Z-Score Atual</div>
            </div>
            
            <div class="metric-card">
              <div class="text-lg font-bold direction-${data.direcao_acao1.toLowerCase()}">
                ${data.acao1}: ${data.direcao_acao1}
              </div>
              <div class="text-sm text-gray-400 mt-1">Dire√ß√£o Sugerida</div>
            </div>
            
            <div class="metric-card">
              <div class="text-lg font-bold direction-${data.direcao_acao2.toLowerCase()}">
                ${data.acao2}: ${data.direcao_acao2}
              </div>
              <div class="text-sm text-gray-400 mt-1">Dire√ß√£o Sugerida</div>
            </div>
          </div>
        </div>
      `;
    }
    // ===== CARREGAR TAB FINANCEIRO =====
    function loadFinancialTab(container) {
      if (!currentDetailedData) return;
      
      const data = currentDetailedData;
      const valorTotal = data.valor_total_acao1 + data.valor_total_acao2;
      
      container.innerHTML = `
        <div class="space-y-6">
          <h3 class="text-lg font-semibold">Resumo da Opera√ß√£o</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 class="font-semibold mb-4 text-geminii">${data.acao1}</h4>
              <div class="space-y-3">
                <div class="financial-item">
                  <span>Dire√ß√£o</span>
                  <span class="direction-${data.direcao_acao1.toLowerCase()}">${data.direcao_acao1}</span>
                </div>
                <div class="financial-item">
                  <span>Quantidade</span>
                  <span class="font-semibold">${data.qtd1.toLocaleString('pt-BR')}</span>
                </div>
                <div class="financial-item">
                  <span>Pre√ßo Unit√°rio</span>
                  <span class="font-semibold">R$ ${data.ultimo_preco1.toFixed(2)}</span>
                </div>
                <div class="financial-item">
                  <span>Valor Total</span>
                  <span class="font-semibold">R$ ${data.valor_total_acao1.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                </div>
              </div>
            </div>
            
            <div>
              <h4 class="font-semibold mb-4 text-geminii">${data.acao2}</h4>
              <div class="space-y-3">
                <div class="financial-item">
                  <span>Dire√ß√£o</span>
                  <span class="direction-${data.direcao_acao2.toLowerCase()}">${data.direcao_acao2}</span>
                </div>
                <div class="financial-item">
                  <span>Quantidade</span>
                  <span class="font-semibold">${data.qtd2.toLocaleString('pt-BR')}</span>
                </div>
                <div class="financial-item">
                  <span>Pre√ßo Unit√°rio</span>
                  <span class="font-semibold">R$ ${data.ultimo_preco2.toFixed(2)}</span>
                </div>
                <div class="financial-item">
                  <span>Valor Total</span>
                  <span class="font-semibold">R$ ${data.valor_total_acao2.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="longshort-card p-6">
            <h4 class="font-semibold mb-4">Stop Loss & Take Profit (ATR)</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="financial-item bg-red-500 bg-opacity-20">
                <span><i class="fas fa-stop-circle mr-2"></i>Stop Loss</span>
                <span class="font-semibold text-red-400">R$ ${data.valor_stop.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
              </div>
              <div class="financial-item bg-green-500 bg-opacity-20">
                <span><i class="fas fa-target mr-2"></i>Take Profit</span>
                <span class="font-semibold text-green-400">R$ ${data.valor_gain.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
              </div>
            </div>
          </div>
          
          <div class="financial-item bg-geminii bg-opacity-20 p-4 rounded-lg">
            <span class="text-lg"><i class="fas fa-calculator mr-2"></i>Investimento Total</span>
            <span class="text-xl font-bold text-geminii">R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
          </div>
        </div>
      `;
    }
    
    // ===== CARREGAR TAB GR√ÅFICOS =====
    function loadChartsTab(container) {
      if (!currentDetailedData) return;
      
      const data = currentDetailedData;
      
      container.innerHTML = `
        <div class="space-y-8">
          <div>
            <h3 class="text-lg font-semibold mb-4">Z-Score Hist√≥rico</h3>
            <div class="h-64 bg-white bg-opacity-5 rounded-lg p-4">
              <canvas id="zscoreChart"></canvas>
            </div>
            <div class="mt-2 text-sm text-gray-400">
              <p><strong>Interpreta√ß√£o:</strong> Z-Score acima de +2 indica que o spread est√° acima da m√©dia (vender a√ß√£o1, comprar a√ß√£o2). 
              Z-Score abaixo de -2 indica spread abaixo da m√©dia (comprar a√ß√£o1, vender a√ß√£o2).</p>
            </div>
          </div>
          
          <div>
            <h3 class="text-lg font-semibold mb-4">Spread (Raz√£o de Pre√ßos)</h3>
            <div class="h-64 bg-white bg-opacity-5 rounded-lg p-4">
              <canvas id="spreadChart"></canvas>
            </div>
            <div class="mt-2 text-sm text-gray-400">
              <p><strong>Interpreta√ß√£o:</strong> Mostra a evolu√ß√£o da raz√£o entre os pre√ßos dos dois ativos. 
              Tend√™ncia de alta/baixa indica diverg√™ncia tempor√°ria que pode retornar √† m√©dia.</p>
            </div>
          </div>
          
          <div>
            <h3 class="text-lg font-semibold mb-4">Beta Rotativo (60 dias)</h3>
            <div class="h-64 bg-white bg-opacity-5 rounded-lg p-4">
              <canvas id="betaChart"></canvas>
            </div>
            <div class="mt-2 text-sm text-gray-400">
              <p><strong>Interpreta√ß√£o:</strong> Beta rotativo mostra como a sensibilidade entre os ativos muda ao longo do tempo. 
              Valores est√°veis indicam rela√ß√£o consistente entre os pares.</p>
            </div>
          </div>
        </div>
      `;
      
      // Renderizar gr√°ficos ap√≥s um pequeno delay
      setTimeout(() => {
        createZScoreChart(data.graficos.zscore);
        createSpreadChart(data.graficos.spread);
        createBetaChart(data.graficos.beta_rotativo);
      }, 100);
    }
    
    // ===== CARREGAR TAB MARGEM =====
    function loadMarginTab(container) {
      container.innerHTML = `
        <div class="space-y-6">
          <h3 class="text-lg font-semibold">Calculadora de Margem e Custos Operacionais</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 class="font-semibold mb-4">Par√¢metros Operacionais</h4>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm text-gray-400 mb-2">Percentual de Garantia (%)</label>
                  <input id="percentualGarantia" type="number" value="25" min="0" max="100" step="0.1" 
                    class="w-full px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white">
                  <div class="text-xs text-gray-500 mt-1">Margem exigida pela corretora sobre posi√ß√µes vendidas</div>
                </div>
                <div>
                  <label class="block text-sm text-gray-400 mb-2">Taxa BTC Anual (%)</label>
                  <input id="taxaBtcAnual" type="number" value="2.0" min="0" step="0.1" 
                    class="w-full px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white">
                  <div class="text-xs text-gray-500 mt-1">Taxa de empr√©stimo de a√ß√µes para venda descoberta</div>
                </div>
                <div>
                  <label class="block text-sm text-gray-400 mb-2">Dias da Opera√ß√£o</label>
                  <input id="diasOperacao" type="number" value="10" min="1" max="365" 
                    class="w-full px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white">
                  <div class="text-xs text-gray-500 mt-1">Tempo estimado para manter a posi√ß√£o</div>
                </div>
                <div>
                  <label class="block text-sm text-gray-400 mb-2">Taxa Corretora sobre BTC (%)</label>
                  <input id="taxaCorretoraBtc" type="number" value="35" min="0" step="1" 
                    class="w-full px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white">
                  <div class="text-xs text-gray-500 mt-1">Percentual que a corretora cobra sobre o BTC</div>
                </div>
                <button id="calcularMargemBtn" class="w-full px-4 py-2 bg-geminii hover:bg-purple-600 rounded-lg transition-all font-medium">
                  <i class="fas fa-calculator mr-2"></i>Calcular Margem e Custos
                </button>
              </div>
            </div>
            
            <div>
              <h4 class="font-semibold mb-4">Resultados do C√°lculo</h4>
              <div id="margemResults" class="space-y-3">
                <div class="text-center py-12 text-gray-400">
                  <i class="fas fa-calculator text-3xl mb-3"></i>
                  <p>Configure os par√¢metros ao lado</p>
                  <p class="text-sm">e clique em "Calcular Margem e Custos"</p>
                </div>
              </div>
            </div>
          </div>
          
          <div class="longshort-card p-6">
            <h4 class="font-semibold mb-4 text-blue-400">
              <i class="fas fa-info-circle mr-2"></i>
              Explica√ß√£o dos Custos
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-300">
              <div>
                <h5 class="font-semibold text-white mb-2">Garantias:</h5>
                <ul class="space-y-1 text-xs">
                  <li>‚Ä¢ <strong>Garantia de Venda:</strong> Margem exigida para posi√ß√µes vendidas</li>
                  <li>‚Ä¢ <strong>Contragarantia:</strong> Margem para posi√ß√µes compradas</li>
                  <li>‚Ä¢ <strong>Margem L√≠quida:</strong> Diferen√ßa entre garantias (valor a imobilizar)</li>
                </ul>
              </div>
              <div>
                <h5 class="font-semibold text-white mb-2">Custos Operacionais:</h5>
                <ul class="space-y-1 text-xs">
                  <li>‚Ä¢ <strong>Emolumentos B3:</strong> 0,0325% sobre volume negociado</li>
                  <li>‚Ä¢ <strong>BTC (Aluguel):</strong> Taxa para emprestar a√ß√µes vendidas</li>
                  <li>‚Ä¢ <strong>Taxa Corretora:</strong> Comiss√£o sobre o BTC</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Adicionar event listener para o bot√£o
      document.getElementById('calcularMargemBtn').addEventListener('click', calcularMargem);
    }
    
    // ===== CARREGAR TAB ESTABILIDADE =====
    function loadStabilityTab(container) {
      container.innerHTML = `
        <div class="space-y-6">
          <h3 class="text-lg font-semibold">An√°lise de Estabilidade da Cointegra√ß√£o</h3>
          
          <div class="text-center py-8">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-400">Analisando estabilidade em m√∫ltiplos per√≠odos...</p>
            <p class="text-sm text-gray-500 mt-2">Isso pode levar alguns segundos</p>
          </div>
        </div>
      `;
      
      // Carregar an√°lise de estabilidade
      loadStabilityAnalysis();
    }
    
    // ===== FUN√á√ïES DE GR√ÅFICOS =====
    function createZScoreChart(data) {
      const ctx = document.getElementById('zscoreChart');
      if (!ctx || !data.dates.length) return;
      
      console.log('üîç Dados do Z-Score Chart:', data);
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.dates,
          datasets: [{
            label: 'Z-Score',
            data: data.values,
            borderColor: '#ba39af',
            backgroundColor: 'rgba(186, 57, 175, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.4,
            pointRadius: 0,
            pointHoverRadius: 4
          },
          // ‚úÖ LINHA DE RESIST√äNCIA SUPERIOR (+2)
          {
            label: 'Resist√™ncia (+2)',
            data: Array(data.dates.length).fill(2),
            borderColor: '#ef4444',
            borderWidth: 2,
            borderDash: [10, 5],
            fill: false,
            pointRadius: 0,
            pointHoverRadius: 0
          },
          // ‚úÖ LINHA DE SUPORTE INFERIOR (-2)
          {
            label: 'Suporte (-2)',
            data: Array(data.dates.length).fill(-2),
            borderColor: '#22c55e',
            borderWidth: 2,
            borderDash: [10, 5],
            fill: false,
            pointRadius: 0,
            pointHoverRadius: 0
          },
          // ‚úÖ LINHA NEUTRA (0)
          {
            label: 'Linha Neutra',
            data: Array(data.dates.length).fill(0),
            borderColor: '#6b7280',
            borderWidth: 1,
            borderDash: [5, 5],
            fill: false,
            pointRadius: 0,
            pointHoverRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: { 
              labels: { color: 'white' },
              display: true
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: 'white',
              bodyColor: 'white',
              borderColor: '#ba39af',
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  if (context.datasetIndex === 0) {
                    return `Z-Score: ${context.parsed.y.toFixed(3)}`;
                  }
                  return null; // N√£o mostrar tooltip para linhas de refer√™ncia
                }
              },
              filter: function(tooltipItem) {
                return tooltipItem.datasetIndex === 0; // S√≥ mostrar tooltip do Z-Score
              }
            }
          },
          scales: {
            x: { 
              ticks: { 
                color: 'white',
                maxTicksLimit: 10
              }, 
              grid: { 
                color: 'rgba(255,255,255,0.1)',
                borderColor: 'rgba(255,255,255,0.3)'
              },
              title: {
                display: true,
                text: 'Data',
                color: 'white'
              }
            },
            y: { 
              ticks: { 
                color: 'white',
                callback: function(value) {
                  return value.toFixed(2);
                }
              }, 
              grid: { 
                color: 'rgba(255,255,255,0.1)',
                borderColor: 'rgba(255,255,255,0.3)'
              },
              title: {
                display: true,
                text: 'Z-Score',
                color: 'white'
              }
            }
          }
        }
      });
      
      console.log('‚úÖ Z-Score Chart renderizado com linhas de refer√™ncia');
    }

    function createSpreadChart(data) {
      const ctx = document.getElementById('spreadChart');
      if (!ctx || !data.dates.length) return;
      
      console.log('üîç Dados do Spread Chart:', data);
      
      // Calcular m√©dia para linha de refer√™ncia
      const values = data.values.filter(v => !isNaN(v) && v !== null);
      const mean = values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.dates,
          datasets: [{
            label: 'Spread (Raz√£o de Pre√ßos)',
            data: data.values,
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 0,
            pointHoverRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: { 
              labels: { color: 'white' },
              display: true
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: 'white',
              bodyColor: 'white',
              borderColor: '#f59e0b',
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  return `Spread: ${context.parsed.y.toFixed(4)}`;
                }
              }
            }
          },
          scales: {
            x: { 
              ticks: { 
                color: 'white',
                maxTicksLimit: 10
              }, 
              grid: { 
                color: 'rgba(255,255,255,0.1)',
                borderColor: 'rgba(255,255,255,0.3)'
              },
              title: {
                display: true,
                text: 'Data',
                color: 'white'
              }
            },
            y: { 
              ticks: { 
                color: 'white',
                callback: function(value) {
                  return value.toFixed(4);
                }
              }, 
              grid: { 
                color: 'rgba(255,255,255,0.1)',
                borderColor: 'rgba(255,255,255,0.3)'
              },
              title: {
                display: true,
                text: 'Spread (A√ß√£o1/A√ß√£o2)',
                color: 'white'
              }
            }
          }
        }
      });
      
      console.log('‚úÖ Spread Chart renderizado');
    }
    
    function createSpreadChart(data) {
      const ctx = document.getElementById('spreadChart');
      if (!ctx || !data.dates.length) return;
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.dates,
          datasets: [{
            label: 'Spread (Raz√£o)',
            data: data.values,
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
              labels: { color: 'white' },
              display: true
            }
          },
          scales: {
            x: { 
              ticks: { color: 'white' }, 
              grid: { color: 'rgba(255,255,255,0.1)' } 
            },
            y: { 
              ticks: { color: 'white' }, 
              grid: { color: 'rgba(255,255,255,0.1)' } 
            }
          }
        }
      });
    }
    
    function createBetaChart(data) {
      const ctx = document.getElementById('betaChart');
      if (!ctx) return;
      
      console.log('üîç Dados do Beta Chart:', data);
      
      if (!data.dates || !data.values || data.dates.length === 0) {
        ctx.parentElement.innerHTML = `
          <div class="text-center py-8 text-gray-400">
            <i class="fas fa-chart-line text-3xl mb-3"></i>
            <p>Dados de Beta Rotativo n√£o dispon√≠veis</p>
            <p class="text-sm">Per√≠odo insuficiente para c√°lculo (m√≠nimo 60 dias)</p>
          </div>
        `;
        return;
      }
      
      // Filtrar valores v√°lidos
      const validData = data.values.filter(v => !isNaN(v) && v !== null && v !== undefined);
      if (validData.length === 0) {
        ctx.parentElement.innerHTML = `
          <div class="text-center py-8 text-gray-400">
            <i class="fas fa-chart-line text-3xl mb-3"></i>
            <p>Dados de Beta inv√°lidos</p>
            <p class="text-sm">N√£o foi poss√≠vel calcular beta para este per√≠odo</p>
          </div>
        `;
        return;
      }
      
      // Calcular estat√≠sticas para linhas de refer√™ncia
      const mean = validData.reduce((a, b) => a + b, 0) / validData.length;
      const variance = validData.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / validData.length;
      const stdDev = Math.sqrt(variance);
      
      console.log(`üìä Beta Stats: m√©dia=${mean.toFixed(4)}, desvio=${stdDev.toFixed(4)}, pontos=${validData.length}`);
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.dates,
          datasets: [{
            label: 'Beta Rotativo (60 dias)',
            data: data.values,
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.4,
            pointRadius: 0,
            pointHoverRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: { 
              labels: { color: 'white' },
              display: true
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: 'white',
              bodyColor: 'white',
              borderColor: '#22c55e',
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  return `Beta: ${context.parsed.y.toFixed(4)}`;
                }
              }
            }
          },
          scales: {
            x: { 
              ticks: { 
                color: 'white',
                maxTicksLimit: 10
              }, 
              grid: { 
                color: 'rgba(255,255,255,0.1)',
                borderColor: 'rgba(255,255,255,0.3)'
              },
              title: {
                display: true,
                text: 'Data',
                color: 'white'
              }
            },
            y: { 
              ticks: { 
                color: 'white',
                callback: function(value) {
                  return value.toFixed(4);
                }
              }, 
              grid: { 
                color: 'rgba(255,255,255,0.1)',
                borderColor: 'rgba(255,255,255,0.3)'
              },
              title: {
                display: true,
                text: 'Beta (Sensibilidade)',
                color: 'white'
              }
            }
          }
        }
      });
      
      console.log('‚úÖ Beta Chart renderizado com sucesso');
    }
    // ===== FUN√á√ÉO PARA CALCULAR MARGEM =====
    async function calcularMargem() {
      if (!currentDetailedData) return;
      
      const data = currentDetailedData;
      const params = {
        valor_vendido: data.direcao_acao1 === 'Venda' ? data.valor_total_acao1 : data.valor_total_acao2,
        valor_comprado: data.direcao_acao1 === 'Compra' ? data.valor_total_acao1 : data.valor_total_acao2,
        percentual_garantia: parseFloat(document.getElementById('percentualGarantia').value),
        taxa_btc_anual: parseFloat(document.getElementById('taxaBtcAnual').value),
        dias_operacao: parseInt(document.getElementById('diasOperacao').value),
        taxa_corretora_btc: parseFloat(document.getElementById('taxaCorretoraBtc').value)
      };
      
      // Valida√ß√µes
      if (isNaN(params.percentual_garantia) || params.percentual_garantia < 0) {
        showStatus('Percentual de garantia deve ser um n√∫mero positivo', 'error');
        return;
      }
      
      try {
        const btn = document.getElementById('calcularMargemBtn');
        setLoading(btn, true);
        
        const response = await fetch('/api/long-short/margin-costs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(params)
        });
        
        const result = await response.json();
        
        if (result.success) {
          displayMarginResults(result.data);
        } else {
          showStatus(`Erro no c√°lculo: ${result.error}`, 'error');
        }
      } catch (error) {
        showStatus(`Erro: ${error.message}`, 'error');
      } finally {
        const btn = document.getElementById('calcularMargemBtn');
        setLoading(btn, false);
      }
    }
    
    // ===== EXIBIR RESULTADOS DE MARGEM =====
    function displayMarginResults(data) {
      const container = document.getElementById('margemResults');
      
      container.innerHTML = `
        <div class="space-y-4">
          <h5 class="font-semibold text-geminii mb-3">Garantias e Margem</h5>
          
          <div class="financial-item">
            <span><i class="fas fa-shield-alt mr-2"></i>Garantia sobre Vendas</span>
            <span class="font-semibold">R$ ${data.garantia_venda.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
          </div>
          
          <div class="financial-item">
            <span><i class="fas fa-handshake mr-2"></i>Contragarantia sobre Compras</span>
            <span class="font-semibold">R$ ${data.garantia_compra.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
          </div>
          
          <div class="financial-item bg-yellow-500 bg-opacity-20 border border-yellow-500 border-opacity-30">
            <span class="font-semibold"><i class="fas fa-piggy-bank mr-2"></i>Margem Necess√°ria</span>
            <span class="font-semibold text-yellow-400">R$ ${data.margem_necessaria.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
          </div>
          
          <hr class="border-gray-600 my-4">
          
          <h5 class="font-semibold text-geminii mb-3">Custos Operacionais</h5>
          
          <div class="financial-item">
            <span><i class="fas fa-building mr-2"></i>Emolumentos B3</span>
            <span class="font-semibold">R$ ${data.emolumentos.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
          </div>
          
          <div class="financial-item">
            <span><i class="fas fa-percentage mr-2"></i>Custo BTC (${data.parametros.dias_operacao} dias)</span>
            <span class="font-semibold">R$ ${data.custo_btc_periodo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
          </div>
          
          <div class="financial-item">
            <span><i class="fas fa-user-tie mr-2"></i>Taxa Corretora BTC</span>
            <span class="font-semibold">R$ ${data.taxa_corretora.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
          </div>
          
          <hr class="border-gray-600 my-4">
          
          <div class="financial-item bg-red-500 bg-opacity-20 border border-red-500 border-opacity-30 p-4">
            <span class="text-lg font-bold"><i class="fas fa-calculator mr-2"></i>Custo Total Estimado</span>
            <span class="text-xl font-bold text-red-400">R$ ${data.custo_total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
          </div>
          
          <div class="text-xs text-gray-400 bg-gray-800 bg-opacity-50 p-3 rounded-lg">
            <p><strong>Importante:</strong> Estes s√£o custos estimados baseados nos par√¢metros informados. 
            Custos reais podem variar conforme as condi√ß√µes de mercado e pol√≠ticas da corretora.</p>
          </div>
        </div>
      `;
    }
    
    // ===== CARREGAR AN√ÅLISE DE ESTABILIDADE =====
    async function loadStabilityAnalysis() {
      if (!currentDetailedData || !dadosCache) return;
      
      try {
        const data = currentDetailedData;
        
        const response = await fetch('/api/long-short/stability-analysis', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            acao1: data.acao1,
            acao2: data.acao2,
            dados_cache: dadosCache
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          displayStabilityResults(result.data);
        } else {
          showStatus(`Erro na an√°lise de estabilidade: ${result.error}`, 'error');
        }
      } catch (error) {
        showStatus(`Erro: ${error.message}`, 'error');
        console.error('Erro na an√°lise de estabilidade:', error);
      }
    }
    
    // ===== EXIBIR RESULTADOS DE ESTABILIDADE =====
    function displayStabilityResults(data) {
      const container = document.querySelector('#tabContents .space-y-6');
      if (!container) return;
      
      container.innerHTML = `
        <h3 class="text-lg font-semibold">An√°lise de Estabilidade da Cointegra√ß√£o</h3>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div>
            <h4 class="font-semibold mb-4">An√°lise por Per√≠odos</h4>
            <div class="space-y-2">
              ${data.analise_periodos.map(periodo => `
                <div class="financial-item">
                  <div>
                    <span class="font-semibold">${periodo.periodo} dias</span>
                    <div class="text-sm text-gray-400">
                      P-valor: ${periodo.pvalor_cointegra√ß√£o || 'N/A'} | R¬≤: ${periodo.r_squared || 'N/A'}
                      ${periodo.meia_vida ? ` | Meia-vida: ${periodo.meia_vida}d` : ''}
                    </div>
                  </div>
                  <span class="${periodo.status === 'Cointegrado' ? 'text-green-400' : periodo.status === 'Erro' ? 'text-gray-400' : 'text-red-400'} font-semibold">
                    ${periodo.status}
                  </span>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div>
            <h4 class="font-semibold mb-4">Diagn√≥stico Geral</h4>
            <div class="longshort-card p-6">
              <div class="text-center mb-4">
                <div class="text-4xl mb-2">${data.diagnostico.status_icon}</div>
                <div class="text-lg font-semibold">${data.diagnostico.texto}</div>
              </div>
              
              <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                  <span>Per√≠odos Cointegrados:</span>
                  <span class="font-semibold">${data.diagnostico.periodos_cointegrados} de ${data.diagnostico.total_periodos}</span>
                </div>
                <div class="flex justify-between">
                  <span>R¬≤ M√©dio:</span>
                  <span class="font-semibold">${data.diagnostico.r2_medio}</span>
                </div>
                <div class="flex justify-between">
                  <span>Taxa de Sucesso:</span>
                  <span class="font-semibold">${((data.diagnostico.periodos_cointegrados / data.diagnostico.total_periodos) * 100).toFixed(1)}%</span>
                </div>
              </div>
              
              <div class="mt-4 p-3 bg-blue-500 bg-opacity-20 rounded-lg">
                <div class="text-xs text-blue-300">
                  <strong>Interpreta√ß√£o:</strong> R¬≤ > 0.95 indica excelente ader√™ncia do modelo. 
                  Cointegra√ß√£o est√°vel em m√∫ltiplos per√≠odos sugere rela√ß√£o robusta e duradoura entre os ativos.
                  ${data.diagnostico.periodos_cointegrados === data.diagnostico.total_periodos ? 
                    ' Este par apresenta cointegra√ß√£o consistente.' : 
                    ' Monitore a estabilidade da rela√ß√£o.'}
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="longshort-card p-6">
          <h4 class="font-semibold mb-3 text-blue-400">
            <i class="fas fa-lightbulb mr-2"></i>
            Recomenda√ß√µes Baseadas na Estabilidade
          </h4>
          <div class="text-sm text-gray-300">
            ${data.diagnostico.periodos_cointegrados === data.diagnostico.total_periodos ? 
              `<div class="text-green-400">
                <p><strong>‚úÖ Par Altamente Recomendado:</strong></p>
                <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                  <li>Cointegra√ß√£o est√°vel em todos os per√≠odos analisados</li>
                  <li>Rela√ß√£o estat√≠stica robusta e consistente</li>
                  <li>Maior probabilidade de revers√£o √† m√©dia</li>
                  <li>Adequado para estrat√©gias de longo prazo</li>
                </ul>
              </div>` :
              data.diagnostico.periodos_cointegrados >= data.diagnostico.total_periodos * 0.7 ?
              `<div class="text-yellow-400">
                <p><strong>‚ö†Ô∏è Par com Cautela:</strong></p>
                <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                  <li>Cointegra√ß√£o presente na maioria dos per√≠odos</li>
                  <li>Monitoramento mais frequente recomendado</li>
                  <li>Considere reduzir tamanho da posi√ß√£o</li>
                  <li>Stops mais pr√≥ximos podem ser necess√°rios</li>
                </ul>
              </div>` :
              `<div class="text-red-400">
                <p><strong>‚ùå Par N√£o Recomendado:</strong></p>
                <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                  <li>Cointegra√ß√£o inconsistente entre per√≠odos</li>
                  <li>Rela√ß√£o estat√≠stica inst√°vel</li>
                  <li>Alto risco de diverg√™ncia permanente</li>
                  <li>Evite este par ou aguarde melhor momento</li>
                </ul>
              </div>`
            }
          </div>
        </div>
      `;
    }
    
    // ===== FUN√á√ïES AUXILIARES =====
    function voltarParaLista() {
      detailedAnalysisSection.classList.add('hidden');
      resultsSection.classList.remove('hidden');
      statusMessage.classList.add('hidden');
      currentDetailedData = null;
    }
    
    function showStatus(message, type) {
      statusMessage.className = `p-4 rounded-lg text-center ${
        type === 'success' ? 'bg-green-500 bg-opacity-20 text-green-400 border border-green-500 border-opacity-30' :
        type === 'error' ? 'bg-red-500 bg-opacity-20 text-red-400 border border-red-500 border-opacity-30' :
        'bg-blue-500 bg-opacity-20 text-blue-400 border border-blue-500 border-opacity-30'
      }`;
      statusMessage.textContent = message;
      statusMessage.classList.remove('hidden');
      
      if (type === 'success') {
        setTimeout(() => {
          statusMessage.classList.add('hidden');
        }, 5000);
      }
    }
    
    function setLoading(element, loading) {
      if (loading) {
        element.disabled = true;
        element.classList.add('loading');
        const originalHTML = element.innerHTML;
        element.setAttribute('data-original', originalHTML);
        element.innerHTML = '<div class="spinner mr-2"></div>Processando...';
      } else {
        element.disabled = false;
        element.classList.remove('loading');
        const originalHTML = element.getAttribute('data-original');
        if (originalHTML) {
          element.innerHTML = originalHTML;
        }
      }
    }
    
    // ===== VERIFICAR STATUS DA API =====
    async function checkApiStatus() {
      try {
        const response = await fetch('/api/long-short/status');
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('apiStatus').innerHTML = `
            <i class="fas fa-shield-alt text-green-500 text-xs"></i>
            <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
          `;
        } else {
          throw new Error('API offline');
        }
      } catch (error) {
        document.getElementById('apiStatus').innerHTML = `
          <i class="fas fa-shield-alt text-red-500 text-xs"></i>
          <div class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
        `;
      }
    }
    
    // ===== FORMATA√á√ÉO =====
    function formatCurrency(value) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(value);
    }
    
    // ===== INICIALIZA√á√ÉO =====
    document.addEventListener('DOMContentLoaded', () => {
      console.log(' Long & Short System inicializado');
      console.log(' Pronto para an√°lise de cointegra√ß√£o de pares');
      
      // Verificar status da API
      checkApiStatus();
      setInterval(checkApiStatus, 30000); // Check a cada 30 segundos
      
      // Mostrar status inicial
      showStatus('Sistema carregado! Configure os par√¢metros e clique em "Analisar Pares" para come√ßar.', 'info');
    });
    
    // ===== HANDLE PAGE VISIBILITY =====
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        checkApiStatus();
      }
    });
    
    // ===== GLOBAL ERROR HANDLER =====
    window.addEventListener('error', (event) => {
      console.error('Erro global capturado:', event.error);
      showStatus('Erro inesperado. Recarregue a p√°gina se necess√°rio.', 'error');
    });
    
    // ===== PREVENT FORM SUBMISSION =====
    document.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
        e.preventDefault();
      }
    });
    
    console.log('‚úÖ Long & Short - Sistema de An√°lise de Cointegra√ß√£o');
    console.log('üìà Geminii Tech - Trading Automatizado');
  </script>
</body>
</html>