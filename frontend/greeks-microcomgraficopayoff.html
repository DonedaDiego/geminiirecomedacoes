<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Greeks Micro 4D - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#000000',
            light: '#ffffff',
            subtle: 'rgba(255,255,255,0.1)',
            geminii: '#fb1ebb'
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      background: #0a0a0a;
      min-height: 100vh;
    }
    
    .greeks-card {
      background: rgba(30, 30, 30, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      transition: all 0.3s ease;
    }
    
    .greeks-card:hover {
      border-color: rgba(186, 57, 175, 0.3);
      box-shadow: 0 8px 32px rgba(186, 57, 175, 0.1);
    }
    
    .metric-box {
      background: rgba(20, 20, 20, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s ease;
    }

    .metric-box:hover {
      background: rgba(30, 30, 30, 0.9);
      border-color: rgba(186, 57, 175, 0.2);
      transform: translateY(-2px);
    }
    
    .spinner {
      border: 3px solid rgba(186, 57, 175, 0.1);
      border-radius: 50%;
      border-top: 3px solid #fb1ebb;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .chart-wrapper {
      background: rgba(20, 20, 20, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 24px;
      height: 450px;
    }

    .chart-container {
      width: 100%;
      height: 100%;
    }

    #expirationSelect {
      background-color: rgba(30, 30, 30, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: white;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    #expirationSelect option {
      background-color: #1a1a1a;
      color: white;
      padding: 10px;
    }

    #expirationSelect:focus {
      outline: none;
      border-color: #fb1ebb;
      box-shadow: 0 0 0 3px rgba(186, 57, 175, 0.15);
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .greek-badge {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.05em;
      padding: 4px 10px;
      border-radius: 6px;
      text-transform: uppercase;
    }

    .badge-gamma { background: rgba(6, 182, 212, 0.15); color: #06b6d4; border: 1px solid rgba(6, 182, 212, 0.3); }
    .badge-delta { background: rgba(168, 85, 247, 0.15); color: #a855f7; border: 1px solid rgba(168, 85, 247, 0.3); }
    .badge-vega { background: rgba(245, 158, 11, 0.15); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); }
    .badge-theta { background: rgba(220, 38, 38, 0.15); color: #dc2626; border: 1px solid rgba(220, 38, 38, 0.3); }

    .input-field {
      background: rgba(30, 30, 30, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: white;
      padding: 12px 16px;
      border-radius: 12px;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
    }

    .input-field:focus {
      outline: none;
      border-color: #fb1ebb;
      box-shadow: 0 0 0 3px rgba(186, 57, 175, 0.15);
      background: rgba(40, 40, 40, 0.95);
    }

    .input-field::placeholder { color: rgba(255, 255, 255, 0.4); }

    .btn-primary {
      background: linear-gradient(135deg, #fb1ebb 0%, #8b2f7d 100%);
      color: white;
      padding: 12px 28px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(186, 57, 175, 0.4);
    }

    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

    .btn-secondary {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.3);
      padding: 12px 28px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-secondary:hover:not(:disabled) {
      background: rgba(59, 130, 246, 0.25);
      border-color: rgba(59, 130, 246, 0.5);
      transform: translateY(-2px);
    }

    .status-badge {
      padding: 8px 16px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .status-success { background: rgba(34, 197, 94, 0.15); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); }
    .status-error { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
    .status-info { background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }

    /* Tabela Mestre */
    .master-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 12px;
    }

    .master-table th {
      background: rgba(40, 40, 40, 0.9);
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .master-table td {
      padding: 10px 8px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      color: #ccc;
    }

    .master-table tr:hover td {
      background: rgba(186, 57, 175, 0.05);
    }

    .master-table tr.active-scenario td {
      background: rgba(186, 57, 175, 0.15);
      color: #fff;
      font-weight: 500;
    }

    .master-table tr.active-scenario td:first-child {
      border-left: 3px solid #fb1ebb;
    }

    /* Diagnostic Card */
    .diagnostic-card {
      background: linear-gradient(135deg, rgba(30, 30, 30, 0.95) 0%, rgba(20, 20, 20, 0.95) 100%);
      border: 2px solid rgba(186, 57, 175, 0.3);
      border-radius: 20px;
      padding: 32px;
      position: relative;
      overflow: hidden;
    }

    .diagnostic-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #fb1ebb, #06b6d4, #a855f7, #f59e0b);
    }

    /* Structure Card */
    .structure-card {
      background: rgba(25, 25, 25, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .structure-card:hover {
      border-color: rgba(34, 197, 94, 0.3);
      transform: translateY(-2px);
    }

    .structure-card.primary {
      border-color: rgba(34, 197, 94, 0.4);
      background: rgba(34, 197, 94, 0.05);
    }

    /* Alert Item */
    .alert-item {
      background: rgba(25, 25, 25, 0.8);
      border-left: 3px solid;
      padding: 12px 16px;
      border-radius: 0 8px 8px 0;
      margin-bottom: 8px;
    }

    .alert-item.alert-danger { border-color: #ef4444; }
    .alert-item.alert-warning { border-color: #f59e0b; }
    .alert-item.alert-info { border-color: #3b82f6; }
    .alert-item.alert-success { border-color: #22c55e; }

    /* Dimension Indicator */
    .dim-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .dim-positive { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .dim-negative { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .dim-neutral { background: rgba(156, 163, 175, 0.15); color: #9ca3af; }
    .dim-high { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .dim-low { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }

    /* Responsividade Mobile */
    @media (max-width: 768px) {
      .chart-wrapper {
        height: 350px;
        padding: 16px;
      }

      .metric-box {
        padding: 16px;
      }

      .diagnostic-card {
        padding: 24px;
      }

      .greeks-card {
        padding: 16px;
      }

      .section-title {
        font-size: 16px;
      }

      .master-table {
        font-size: 10px;
      }

      .master-table th,
      .master-table td {
        padding: 8px 4px;
      }

      /* Navbar mobile */
      nav {
        top: 4px;
        padding: 8px 12px;
      }

      nav .hidden {
        display: none !important;
      }

      /* Controles em coluna no mobile */
      .controls-mobile {
        flex-direction: column !important;
        width: 100%;
      }

      .controls-mobile > * {
        width: 100% !important;
      }
    }

    @media (max-width: 1024px) {
      .chart-wrapper {
        height: 380px;
      }
    }

    /* Landscape mobile */
    @media (max-width: 896px) and (orientation: landscape) {
      .chart-wrapper {
        height: 300px;
      }

      .pt-32 {
        padding-top: 80px;
      }
    }

    /* Tablets */
    @media (min-width: 769px) and (max-width: 1024px) {
      .diagnostic-card {
        padding: 28px;
      }
    }

    /* Modal Payoff */
    .payoff-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }

    .payoff-modal.active {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .payoff-content {
      background: linear-gradient(135deg, rgba(20, 20, 20, 0.98) 0%, rgba(30, 30, 30, 0.98) 100%);
      border: 2px solid rgba(186, 57, 175, 0.5);
      border-radius: 24px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      animation: slideUp 0.3s ease;
      box-shadow: 0 20px 60px rgba(186, 57, 175, 0.3);
    }

    @keyframes slideUp {
      from { 
        transform: translateY(30px);
        opacity: 0;
      }
      to { 
        transform: translateY(0);
        opacity: 1;
      }
    }

    .payoff-header {
      background: linear-gradient(135deg, #fb1ebb 0%, #8b2f7d 100%);
      padding: 24px 32px;
      border-radius: 22px 22px 0 0;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .payoff-close {
      position: absolute;
      top: 20px;
      right: 24px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .payoff-close:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }

    .payoff-body {
      padding: 32px;
    }

    .payoff-chart-container {
      background: rgba(10, 10, 10, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      height: 400px;
    }

    .payoff-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .payoff-metric {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .payoff-metric-label {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .payoff-metric-value {
      font-size: 20px;
      font-weight: 700;
      color: white;
    }

    .payoff-legs {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 20px;
    }

    .payoff-leg {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .payoff-leg:last-child {
      border-bottom: none;
    }

    .view-payoff-btn {
      background: linear-gradient(135deg, rgba(186, 57, 175, 0.2) 0%, rgba(139, 47, 125, 0.2) 100%);
      border: 1px solid rgba(186, 57, 175, 0.4);
      color: #fb1ebb;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .view-payoff-btn:hover {
      background: linear-gradient(135deg, rgba(186, 57, 175, 0.3) 0%, rgba(139, 47, 125, 0.3) 100%);
      border-color: rgba(186, 57, 175, 0.6);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(186, 57, 175, 0.3);
    }
  </style>
</head>

<body class="text-white">
  
  <!-- Navbar -->
  <nav class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-opacity-5 border-opacity-10 bg-white border-white border rounded-full px-4 py-3 shadow-xl backdrop-blur-md">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <a href="/dashboard.html">
          <img src="logo.png" alt="Geminii Logo" class="w-6 h-6 cursor-pointer">
        </a>       
      </div>
      <div class="hidden md:flex items-center space-x-6 text-xs text-gray-300 ml-8">
        <span class="text-white font-medium">Greeks Micro 4D</span>
        <a href="gamma-levels.html" class="hover:text-white transition-colors">Gamma Full</a>
        <a href="delta-levels.html" class="hover:text-white transition-colors">Delta Full</a>
        <a href="vega-levels.html" class="hover:text-white transition-colors">Vega Full</a>
        <a href="theta-levels.html" class="hover:text-white transition-colors">Theta Full</a>
      </div>
      <div class="flex items-center space-x-3 ml-8">
        <div class="w-8 h-8 bg-purple-500 bg-opacity-10 border border-purple-500 border-opacity-30 rounded-full flex items-center justify-center relative">
          <i class="fas fa-layer-group text-purple-500 text-xs"></i>
          <div class="absolute -top-1 -right-1 w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Content -->
  <div class="pt-32 pb-16">
    <div class="max-w-[1800px] mx-auto px-6">
      
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-black mb-3">
          <span style="color: #fb1ebb;">Greeks</span>
          <span class="text-white font-light">Micro 4D</span>
        </h1>
        <p class="text-neutral-400 text-base max-w-2xl mx-auto">
          Analise integrada GEX + DEX + VEX + TEX com diagnostico automatico de cenario e estruturas recomendadas.
        </p>
      </div>

      <!-- Controles -->
      <div class="greeks-card p-6 mb-8">
        <div class="flex flex-col md:flex-row gap-4 items-center justify-center controls-mobile">
          <input 
            id="tickerInput" 
            type="text" 
            placeholder="Digite o ticker (ex: BOVA11)" 
            class="input-field w-full md:w-56"
          >
          <select id="expirationSelect" class="input-field w-full md:w-56">
            <option value="">Vencimento Automatico</option>
          </select>
          <button id="loadExpirationsBtn" class="btn-secondary w-full md:w-auto">
            <i class="fas fa-calendar"></i>Carregar Vencimentos
          </button>
          <button id="analyzeBtn" class="btn-primary w-full md:w-auto">
            <i class="fas fa-bolt"></i>Executar Analise 4D
          </button>
        </div>
      </div>

      <!-- Status -->
      <div id="statusMsg" class="mb-6 text-center hidden"></div>

      <!-- Resultados -->
      <div id="resultsSection" class="hidden">
        
        <!-- Row 1: Metricas Principais -->
        <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-8">
          <div class="metric-box text-center">
            <div class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Spot Price</div>
            <div class="text-2xl font-black text-white" id="spotPrice">--</div>
          </div>
          <div class="metric-box text-center">
            <div class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Gamma Flip</div>
            <div class="text-2xl font-black text-orange-400" id="flipStrike">--</div>
          </div>
          <div class="metric-box text-center">
            <div class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">GEX Desc.</div>
            <div class="text-2xl font-black text-cyan-400" id="gexDescoberto">--</div>
          </div>
          <div class="metric-box text-center">
            <div class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">DEX Desc.</div>
            <div class="text-2xl font-black text-purple-400" id="dexDescoberto">--</div>
          </div>
          <div class="metric-box text-center">
            <div class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">IV Atual</div>
            <div class="text-2xl font-black text-amber-400" id="ivAtual">--</div>
          </div>
          <div class="metric-box text-center">
            <div class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Dias Venc.</div>
            <div class="text-2xl font-black text-red-400" id="diasVenc">--</div>
          </div>
        </div>

        <!-- Row 2: Diagnostico 4D + Estruturas -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          
          <!-- Diagnostico 4D -->
          <div class="diagnostic-card">
            <div class="section-title mb-6">
              <i class="fas fa-diagnoses" style="color: #fb1ebb;"></i>
              Diagnostico 4D
            </div>
            
            <!-- Cenario Identificado -->
            <div class="mb-6">
              <div class="text-xs text-gray-500 uppercase tracking-wider mb-2">Cenario Identificado</div>
              <div class="text-xl font-bold text-white mb-1" id="scenarioName">--</div>
              <div class="text-sm text-gray-400" id="scenarioNumber">Cenario #--</div>
            </div>

            <!-- 4 Dimensoes -->
            <div class="grid grid-cols-2 gap-4 mb-6">
              <div>
                <div class="text-xs text-gray-500 mb-2">GEX (Gamma)</div>
                <div id="gexIndicator" class="dim-indicator dim-neutral">--</div>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-2">DEX (Delta)</div>
                <div id="dexIndicator" class="dim-indicator dim-neutral">--</div>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-2">VEX (Vega)</div>
                <div id="vexIndicator" class="dim-indicator dim-neutral">--</div>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-2">TEX (Theta)</div>
                <div id="texIndicator" class="dim-indicator dim-neutral">--</div>
              </div>
            </div>

            <!-- Interpretacao -->
            <div class="bg-black/30 rounded-xl p-4 mb-6">
              <div class="text-xs text-gray-500 uppercase tracking-wider mb-2">Interpretacao</div>
              <div class="text-sm text-gray-300 leading-relaxed" id="scenarioInterpretation">--</div>
            </div>

            <!-- Forca do Sinal e Direcao -->
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Forca do Sinal</div>
                <div class="text-2xl font-black" id="signalStrength">--</div>
                <div class="text-xs text-gray-500 mt-1" id="signalDescription">--</div>
              </div>
              <div>
                <div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Direcao Provavel</div>
                <div class="text-2xl font-black" id="probableDirection">--</div>
              </div>
              <div>
                <div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Intensidade</div>
                <div class="text-lg font-bold text-gray-300" id="intensityLevel">--</div>
              </div>
            </div>
          </div>

          <!-- Estruturas Recomendadas -->
          <div class="greeks-card p-6">
            <div class="section-title mb-4">
              <i class="fas fa-chess" style="color: #22c55e;"></i>
              Estruturas Recomendadas
            </div>
            
            <div id="structuresContainer" class="space-y-4">
              <!-- Preenchido via JS -->
            </div>
          </div>

        </div>

        <!-- Row 3: Alertas + O Que Olhar -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          
          <!-- Alertas -->
          <div class="greeks-card p-6">
            <div class="section-title mb-4">
              <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
              Alertas de Mudanca de Cenario
            </div>
            <div id="alertsContainer">
              <!-- Preenchido via JS -->
            </div>
          </div>

          <!-- O Que Evitar -->
          <div class="greeks-card p-6">
            <div class="section-title mb-4">
              <i class="fas fa-ban" style="color: #ef4444;"></i>
              O Que Evitar
            </div>
            <div id="avoidContainer">
              <!-- Preenchido via JS -->
            </div>
          </div>

        </div>

        <!-- Row 4: Graficos Principais -->
        <div class="greeks-card p-6 mb-8">
          <div class="section-title mb-4">
            <i class="fas fa-chart-area" style="color: #06b6d4;"></i>
            Graficos Principais
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="chart-wrapper">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-gray-300">GEX Descoberto</h3>
                <span class="greek-badge badge-gamma">Gamma</span>
              </div>
              <div class="chart-container"><div id="gexDescChart"></div></div>
            </div>
            <div class="chart-wrapper">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-gray-300">DEX Momentum</h3>
                <span class="greek-badge badge-delta">Delta</span>
              </div>
              <div class="chart-container"><div id="dexMomentumChart"></div></div>
            </div>
            <div class="chart-wrapper">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-gray-300">VEX Descoberto</h3>
                <span class="greek-badge badge-vega">Vega</span>
              </div>
              <div class="chart-container"><div id="vexDescChart"></div></div>
            </div>
            <div class="chart-wrapper">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-gray-300">TEX Cumulativo</h3>
                <span class="greek-badge badge-theta">Theta</span>
              </div>
              <div class="chart-container"><div id="texCumChart"></div></div>
            </div>
          </div>
        </div>

        <!-- Row 5: Tabela Mestre dos 16 Cenarios -->
        <div class="greeks-card p-6">
          <div class="section-title mb-4">
            <i class="fas fa-table" style="color: #a855f7;"></i>
            Matriz de Decisao 4D - 16 Cenarios
          </div>
          <div class="overflow-x-auto">
            <table class="master-table" id="masterTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>GEX</th>
                  <th>DEX</th>
                  <th>VEX</th>
                  <th>TEX</th>
                  <th>Cenario</th>
                  <th>Estrutura Ideal</th>
                  <th>Evitar</th>
                </tr>
              </thead>
              <tbody id="masterTableBody">
                <!-- Preenchido via JS -->
              </tbody>
            </table>
          </div>
        </div>

      </div>

    </div>
  </div>

  <!-- Modal Payoff -->
  <div id="payoffModal" class="payoff-modal">
    <div class="payoff-content">
      <div class="payoff-header">
        <h2 class="text-2xl font-black text-white" id="payoffTitle">Visualizador de Payoff</h2>
        <p class="text-white/70 text-sm mt-1" id="payoffSubtitle">Análise completa da estrutura</p>
        <button class="payoff-close" onclick="closePayoffModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="payoff-body">
        <!-- Gráfico de Payoff -->
        <div class="payoff-chart-container">
          <div id="payoffChart" style="width: 100%; height: 100%;"></div>
        </div>

        <!-- Métricas da Estrutura -->
        <div class="payoff-metrics" id="payoffMetrics">
          <!-- Preenchido via JS -->
        </div>

        <!-- Breakdown das Pernas -->
        <div class="payoff-legs">
          <h3 class="text-sm font-bold text-white mb-3 flex items-center gap-2">
            <i class="fas fa-list"></i>
            Composição da Estrutura
          </h3>
          <div id="payoffLegsBreakdown">
            <!-- Preenchido via JS -->
          </div>
        </div>

        <!-- Greeks da Estrutura -->
        <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="metric-box text-center">
            <div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Delta Total</div>
            <div class="text-lg font-bold text-purple-400" id="structureDelta">--</div>
          </div>
          <div class="metric-box text-center">
            <div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Gamma Total</div>
            <div class="text-lg font-bold text-cyan-400" id="structureGamma">--</div>
          </div>
          <div class="metric-box text-center">
            <div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Theta Total</div>
            <div class="text-lg font-bold text-red-400" id="structureTheta">--</div>
          </div>
          <div class="metric-box text-center">
            <div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Vega Total</div>
            <div class="text-lg font-bold text-amber-400" id="structureVega">--</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    // TABELA MESTRE DOS 16 CENARIOS
    // ============================================================
    const SCENARIOS_TABLE = {
      1: {
        gex: 'SHORT', dex: 'POS', vex: 'ALTO', tex: 'ALTO',
        name: 'Squeeze Explosivo Urgente',
        structures: ['Long Call ATM', 'Call Spread agressivo'],
        avoid: ['Venda descoberta', 'Short Straddle'],
        interpretation: 'Movimentos amplificados para CIMA com urgencia temporal. MMs vao comprar junto em rompimentos. Vol alta amplifica ganhos.',
        direction: 'ALTA', intensity: 'EXPLOSIVA', urgency: 'ALTA'
      },
      2: {
        gex: 'SHORT', dex: 'POS', vex: 'ALTO', tex: 'BAIXO',
        name: 'Squeeze Explosivo Paciente',
        structures: ['Call Spread', 'Call Diagonal', 'Ratio 1x2'],
        avoid: ['Iron Condor', 'Venda de vol'],
        interpretation: 'Movimentos amplificados para CIMA mas sem urgencia. Tempo para esperar confirmacao. Vol subindo beneficia compras.',
        direction: 'ALTA', intensity: 'EXPLOSIVA', urgency: 'BAIXA'
      },
      3: {
        gex: 'SHORT', dex: 'POS', vex: 'BAIXO', tex: 'ALTO',
        name: 'Squeeze Tecnico Urgente',
        structures: ['Call Spread curto', 'Ratio Call'],
        avoid: ['Compra de vol', 'Straddle'],
        interpretation: 'Movimento tecnico para cima com theta acelerado. Precisa ser rapido. Vol baixa = estruturas baratas.',
        direction: 'ALTA', intensity: 'MODERADA', urgency: 'ALTA'
      },
      4: {
        gex: 'SHORT', dex: 'POS', vex: 'BAIXO', tex: 'BAIXO',
        name: 'Squeeze Tecnico Paciente',
        structures: ['Call Calendar', 'PMCC', 'Call Diagonal longa'],
        avoid: ['Straddle', 'Long vol'],
        interpretation: 'Setup ideal para estruturas de tempo. Vies de alta sem pressa. Theta controlado.',
        direction: 'ALTA', intensity: 'MODERADA', urgency: 'BAIXA'
      },
      5: {
        gex: 'SHORT', dex: 'NEG', vex: 'ALTO', tex: 'ALTO',
        name: 'CRASH IMINENTE',
        structures: ['Long Put', 'Put Spread agressivo'],
        avoid: ['Qualquer posicao comprada', 'Venda de Put'],
        interpretation: 'PERIGO MAXIMO. Movimentos amplificados para BAIXO com vol explodindo. Protecao urgente.',
        direction: 'QUEDA', intensity: 'EXPLOSIVA', urgency: 'CRITICA'
      },
      6: {
        gex: 'SHORT', dex: 'NEG', vex: 'ALTO', tex: 'BAIXO',
        name: 'Crash em Formacao',
        structures: ['Put Spread largo', 'Collar', 'Long Put'],
        avoid: ['Calls', 'Posicoes direcionais de alta'],
        interpretation: 'Pressao vendedora com vol alta. Queda pode ser violenta mas tem tempo para se posicionar.',
        direction: 'QUEDA', intensity: 'EXPLOSIVA', urgency: 'MODERADA'
      },
      7: {
        gex: 'SHORT', dex: 'NEG', vex: 'BAIXO', tex: 'ALTO',
        name: 'Correcao Tecnica Urgente',
        structures: ['Put Spread curto', 'Bear Call Spread'],
        avoid: ['Long stock', 'Calls'],
        interpretation: 'Correcao tecnica acelerada pelo theta. Movimento limitado mas rapido.',
        direction: 'QUEDA', intensity: 'MODERADA', urgency: 'ALTA'
      },
      8: {
        gex: 'SHORT', dex: 'NEG', vex: 'BAIXO', tex: 'BAIXO',
        name: 'Correcao Tecnica Lenta',
        structures: ['Bear Put Calendar', 'Put Diagonal'],
        avoid: ['Posicoes agressivas', 'Long gamma'],
        interpretation: 'Correcao lenta e controlada. Tempo para ajustar posicoes. Sem urgencia.',
        direction: 'QUEDA', intensity: 'LEVE', urgency: 'BAIXA'
      },
      9: {
        gex: 'LONG', dex: 'POS', vex: 'ALTO', tex: 'ALTO',
        name: 'Rally Controlado + Vol',
        structures: ['Iron Condor bullish', 'Jade Lizard', 'Venda de Put'],
        avoid: ['Long Straddle', 'Compra de vol'],
        interpretation: 'Subida controlada pelos MMs. Vol alta = premios gordos para vender. Theta acelera.',
        direction: 'ALTA', intensity: 'CONTROLADA', urgency: 'MODERADA'
      },
      10: {
        gex: 'LONG', dex: 'POS', vex: 'ALTO', tex: 'BAIXO',
        name: 'Rally Saudavel',
        structures: ['Covered Call', 'Put Write', 'Iron Condor'],
        avoid: ['Compra de vol', 'Long Straddle'],
        interpretation: 'Melhor cenario para vendedores de opcoes. Alta saudavel, vol alta, tempo sobrando.',
        direction: 'ALTA', intensity: 'CONTROLADA', urgency: 'BAIXA'
      },
      11: {
        gex: 'LONG', dex: 'POS', vex: 'BAIXO', tex: 'ALTO',
        name: 'Grind Up Acelerado',
        structures: ['Venda de Put OTM', 'Bull Put Spread'],
        avoid: ['Compra de opcoes caras'],
        interpretation: 'Subida lenta com theta acelerado. Ideal para venda de puts.',
        direction: 'ALTA', intensity: 'LEVE', urgency: 'MODERADA'
      },
      12: {
        gex: 'LONG', dex: 'POS', vex: 'BAIXO', tex: 'BAIXO',
        name: 'Grind Up Perfeito',
        structures: ['PMCC', 'Call Diagonal', 'Covered Call longo'],
        avoid: ['Straddle', 'Posicoes de vol'],
        interpretation: 'Cenario ideal para buy and hold com opcoes. Tudo estavel e favoravel.',
        direction: 'ALTA', intensity: 'LEVE', urgency: 'BAIXA'
      },
      13: {
        gex: 'LONG', dex: 'NEG', vex: 'ALTO', tex: 'ALTO',
        name: 'Correcao Suave + Vol',
        structures: ['Iron Condor bearish', 'Venda de Call OTM'],
        avoid: ['Long Call', 'Posicoes de alta'],
        interpretation: 'Correcao controlada com vol alta. Bom para vender calls.',
        direction: 'QUEDA', intensity: 'CONTROLADA', urgency: 'MODERADA'
      },
      14: {
        gex: 'LONG', dex: 'NEG', vex: 'ALTO', tex: 'BAIXO',
        name: 'Pullback Saudavel',
        structures: ['Cash-Secured Put', 'Put Diagonal'],
        avoid: ['Long OTM', 'Calls'],
        interpretation: 'Pullback controlado. Oportunidade de entrar vendendo puts.',
        direction: 'QUEDA', intensity: 'CONTROLADA', urgency: 'BAIXA'
      },
      15: {
        gex: 'LONG', dex: 'NEG', vex: 'BAIXO', tex: 'ALTO',
        name: 'Grind Down Acelerado',
        structures: ['Bear Call Spread', 'Venda de Call'],
        avoid: ['Long stock', 'Calls'],
        interpretation: 'Queda lenta com theta comendo. Venda de calls funciona.',
        direction: 'QUEDA', intensity: 'LEVE', urgency: 'MODERADA'
      },
      16: {
        gex: 'LONG', dex: 'NEG', vex: 'BAIXO', tex: 'BAIXO',
        name: 'Grind Down Lento',
        structures: ['Put Calendar', 'Bear Put Diagonal'],
        avoid: ['Posicoes agressivas', 'Long gamma'],
        interpretation: 'Queda muito lenta. Mercado adormecido para baixo. Paciencia.',
        direction: 'QUEDA', intensity: 'LEVE', urgency: 'BAIXA'
      }
    };

    // ============================================================
    // VARIAVEIS GLOBAIS
    // ============================================================
    let userToken = localStorage.getItem('geminii_token');
    if (!userToken) window.location.href = '/login.html';

    let gammaData = null;
    let deltaData = null;
    let vegaData = null;
    let thetaData = null;
    let currentScenario = null;

    // ============================================================
    // CALCULADORA DE PAYOFF E BLACK-SCHOLES
    // ============================================================
    
    // Black-Scholes simplificado para estimar greeks
    function blackScholesGreeks(S, K, T, r, sigma, isCall) {
      if (T <= 0) T = 0.001;
      const d1 = (Math.log(S / K) + (r + 0.5 * sigma * sigma) * T) / (sigma * Math.sqrt(T));
      const d2 = d1 - sigma * Math.sqrt(T);
      
      const normCDF = (x) => {
        const t = 1 / (1 + 0.2316419 * Math.abs(x));
        const d = 0.3989423 * Math.exp(-x * x / 2);
        const prob = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
        return x > 0 ? 1 - prob : prob;
      };
      
      const normPDF = (x) => Math.exp(-0.5 * x * x) / Math.sqrt(2 * Math.PI);
      
      let delta, gamma, theta, vega;
      
      if (isCall) {
        delta = normCDF(d1);
        theta = (-S * normPDF(d1) * sigma / (2 * Math.sqrt(T)) - r * K * Math.exp(-r * T) * normCDF(d2)) / 365;
      } else {
        delta = normCDF(d1) - 1;
        theta = (-S * normPDF(d1) * sigma / (2 * Math.sqrt(T)) + r * K * Math.exp(-r * T) * normCDF(-d2)) / 365;
      }
      
      gamma = normPDF(d1) / (S * sigma * Math.sqrt(T));
      vega = S * normPDF(d1) * Math.sqrt(T) / 100;
      
      return { delta, gamma, theta, vega };
    }

    function calculatePayoff(structure, spotPrice, scenario) {
      const S = spotPrice;
      const T = (scenario.raw?.texDays || 30) / 365; // Dias até vencimento
      const r = 0.1375; // Taxa Selic
      const sigma = (scenario.raw?.vexRisk === 'HIGH' ? 0.45 : scenario.raw?.vexRisk === 'MODERATE' ? 0.30 : 0.20);
      
      // Range de preços para o gráfico (±20% do spot)
      const minPrice = S * 0.80;
      const maxPrice = S * 1.20;
      const priceRange = [];
      const payoffValues = [];
      
      for (let price = minPrice; price <= maxPrice; price += (maxPrice - minPrice) / 100) {
        priceRange.push(price);
        
        let totalPayoff = 0;
        let totalDelta = 0;
        let totalGamma = 0;
        let totalTheta = 0;
        let totalVega = 0;
        
        structure.legs.forEach(leg => {
          const K = leg.strike;
          const isCall = leg.type === 'Call';
          const multiplier = leg.action === 'Compra' ? 1 : -1;
          
          // Payoff no vencimento
          let intrinsic = 0;
          if (isCall) {
            intrinsic = Math.max(0, price - K);
          } else {
            intrinsic = Math.max(0, K - price);
          }
          
          totalPayoff += intrinsic * multiplier;
          
          // Greeks estimados
          const greeks = blackScholesGreeks(price, K, T, r, sigma, isCall);
          totalDelta += greeks.delta * multiplier;
          totalGamma += greeks.gamma * multiplier;
          totalTheta += greeks.theta * multiplier;
          totalVega += greeks.vega * multiplier;
        });
        
        payoffValues.push(totalPayoff);
        
        // Salvar greeks no spot price atual
        if (Math.abs(price - S) < (maxPrice - minPrice) / 200) {
          structure.greeks = {
            delta: totalDelta,
            gamma: totalGamma,
            theta: totalTheta,
            vega: totalVega
          };
        }
      }
      
      // Calcular métricas
      const maxProfit = Math.max(...payoffValues);
      const maxLoss = Math.min(...payoffValues);
      
      // Breakevens (onde payoff = 0)
      const breakevens = [];
      for (let i = 1; i < payoffValues.length; i++) {
        if ((payoffValues[i-1] < 0 && payoffValues[i] >= 0) || 
            (payoffValues[i-1] >= 0 && payoffValues[i] < 0)) {
          breakevens.push(priceRange[i]);
        }
      }
      
      return {
        priceRange,
        payoffValues,
        metrics: {
          maxProfit: maxProfit === Infinity ? 'Ilimitado' : `R$ ${maxProfit.toFixed(2)}`,
          maxLoss: maxLoss === -Infinity ? 'Ilimitado' : `R$ ${Math.abs(maxLoss).toFixed(2)}`,
          breakevens: breakevens.map(b => `R$ ${b.toFixed(2)}`).join(', ') || 'N/A',
          riskReward: maxLoss < 0 ? (maxProfit / Math.abs(maxLoss)).toFixed(2) : 'N/A'
        }
      };
    }

    function openPayoffModal(structure, scenario) {
      const modal = document.getElementById('payoffModal');
      const spotPrice = gammaData?.spot_price || 0;
      
      // Atualizar título
      document.getElementById('payoffTitle').textContent = structure.name;
      document.getElementById('payoffSubtitle').textContent = structure.logic;
      
      // Calcular payoff
      const payoffData = calculatePayoff(structure, spotPrice, scenario);
      
      // Renderizar gráfico
      renderPayoffChart(payoffData, spotPrice);
      
      // Renderizar métricas
      renderPayoffMetrics(payoffData.metrics);
      
      // Renderizar pernas
      renderPayoffLegs(structure.legs, spotPrice);
      
      // Renderizar greeks
      if (structure.greeks) {
        document.getElementById('structureDelta').textContent = structure.greeks.delta.toFixed(3);
        document.getElementById('structureGamma').textContent = structure.greeks.gamma.toFixed(4);
        document.getElementById('structureTheta').textContent = structure.greeks.theta.toFixed(2);
        document.getElementById('structureVega').textContent = structure.greeks.vega.toFixed(2);
      }
      
      modal.classList.add('active');
    }

    function closePayoffModal() {
      document.getElementById('payoffModal').classList.remove('active');
    }

    function renderPayoffChart(payoffData, spotPrice) {
      const trace = {
        x: payoffData.priceRange,
        y: payoffData.payoffValues,
        type: 'scatter',
        mode: 'lines',
        fill: 'tozeroy',
        line: {
          color: '#fb1ebb',
          width: 3
        },
        fillcolor: 'rgba(186, 57, 175, 0.1)',
        name: 'P&L'
      };
      
      // Linha vertical no spot price
      const spotLine = {
        x: [spotPrice, spotPrice],
        y: [Math.min(...payoffData.payoffValues), Math.max(...payoffData.payoffValues)],
        type: 'scatter',
        mode: 'lines',
        line: {
          color: '#06b6d4',
          width: 2,
          dash: 'dash'
        },
        name: 'Spot Atual'
      };
      
      const layout = {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { color: '#888888', family: 'Inter, sans-serif', size: 11 },
        margin: { l: 60, r: 20, t: 30, b: 50 },
        height: 400,
        xaxis: {
          title: 'Preço do Ativo',
          gridcolor: 'rgba(255,255,255,0.08)',
          color: '#888888',
          showgrid: true,
          zeroline: false
        },
        yaxis: {
          title: 'Lucro / Prejuízo (R$)',
          gridcolor: 'rgba(255,255,255,0.08)',
          color: '#888888',
          showgrid: true,
          zeroline: true,
          zerolinecolor: 'rgba(255,255,255,0.3)',
          zerolinewidth: 2
        },
        showlegend: true,
        legend: {
          font: { color: '#ffffff' },
          bgcolor: 'rgba(0,0,0,0.5)',
          bordercolor: 'rgba(255,255,255,0.2)',
          borderwidth: 1
        },
        hovermode: 'x unified',
        hoverlabel: {
          bgcolor: 'rgba(20, 20, 20, 0.95)',
          bordercolor: '#fb1ebb',
          font: { family: 'Inter, sans-serif', size: 13, color: '#ffffff' }
        }
      };
      
      const config = { responsive: true, displayModeBar: false, displaylogo: false };
      
      Plotly.newPlot('payoffChart', [trace, spotLine], layout, config);
    }

    function renderPayoffMetrics(metrics) {
      const container = document.getElementById('payoffMetrics');
      container.innerHTML = `
        <div class="payoff-metric">
          <div class="payoff-metric-label">Lucro Máximo</div>
          <div class="payoff-metric-value text-green-400">${metrics.maxProfit}</div>
        </div>
        <div class="payoff-metric">
          <div class="payoff-metric-label">Perda Máxima</div>
          <div class="payoff-metric-value text-red-400">${metrics.maxLoss}</div>
        </div>
        <div class="payoff-metric">
          <div class="payoff-metric-label">Breakeven(s)</div>
          <div class="payoff-metric-value text-cyan-400" style="font-size: 14px;">${metrics.breakevens}</div>
        </div>
        <div class="payoff-metric">
          <div class="payoff-metric-label">Risco/Retorno</div>
          <div class="payoff-metric-value text-amber-400">${metrics.riskReward}</div>
        </div>
      `;
    }

    function renderPayoffLegs(legs, spotPrice) {
      const container = document.getElementById('payoffLegsBreakdown');
      container.innerHTML = legs.map(leg => {
        const moneyness = leg.type === 'Call' 
          ? (spotPrice < leg.strike ? 'OTM' : spotPrice > leg.strike ? 'ITM' : 'ATM')
          : (spotPrice > leg.strike ? 'OTM' : spotPrice < leg.strike ? 'ITM' : 'ATM');
        
        const moneynessColor = moneyness === 'ITM' ? 'text-green-400' : moneyness === 'OTM' ? 'text-red-400' : 'text-yellow-400';
        
        return `
          <div class="payoff-leg">
            <div class="flex items-center gap-3">
              <span class="${leg.action === 'Compra' ? 'text-green-400' : 'text-red-400'} font-bold text-sm">
                ${leg.action}
              </span>
              <span class="text-gray-300 text-sm">${leg.type} R$ ${leg.strike}</span>
              ${leg.note ? `<span class="text-gray-500 text-xs">(${leg.note})</span>` : ''}
            </div>
            <span class="${moneynessColor} text-xs font-semibold">${moneyness}</span>
          </div>
        `;
      }).join('');
    }

    window.closePayoffModal = closePayoffModal;
    window.openPayoffModal = openPayoffModal;

    // ============================================================
    // FUNCOES UTILITARIAS
    // ============================================================
    function formatLargeNumber(value) {
      if (value === null || value === undefined) return '--';
      const absValue = Math.abs(value);
      if (absValue >= 1000000000) return (value / 1000000000).toFixed(1) + 'B';
      if (absValue >= 1000000) return (value / 1000000).toFixed(1) + 'M';
      if (absValue >= 1000) return (value / 1000).toFixed(1) + 'K';
      return value.toFixed(0);
    }

    function showStatus(message, type = 'info') {
      const statusMsg = document.getElementById('statusMsg');
      const statusClass = type === 'success' ? 'status-success' : type === 'error' ? 'status-error' : 'status-info';
      const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
      statusMsg.className = `mb-6 text-center status-badge ${statusClass}`;
      statusMsg.innerHTML = `<i class="fas ${icon}"></i>${message}`;
      statusMsg.classList.remove('hidden');
      setTimeout(() => statusMsg.classList.add('hidden'), 5000);
    }

    function setLoading(button, loading) {
      button.disabled = loading;
      if (loading) {
        button.setAttribute('data-original', button.innerHTML);
        button.innerHTML = '<span class="spinner mr-2"></span>Processando...';
      } else {
        const original = button.getAttribute('data-original');
        if (original) button.innerHTML = original;
      }
    }

    // ============================================================
    // CLASSIFICACAO DO CENARIO
    // ============================================================
    function classifyScenario(gamma, delta, vega, theta) {
      // Classificar GEX
      const gexValue = gamma?.gex_levels?.total_gex_descoberto || 0;
      const gexSign = gexValue < 0 ? 'SHORT' : 'LONG';
      
      // Classificar DEX
      const dexValue = delta?.dex_levels?.total_dex_descoberto || 0;
      const dexSign = dexValue > 0 ? 'POS' : 'NEG';
      
      // Classificar VEX
      const vexRisk = vega?.vol_regime?.volatility_risk || 'LOW';
      const vexLevel = (vexRisk === 'HIGH' || vexRisk === 'MODERATE') ? 'ALTO' : 'BAIXO';
      
      // Classificar TEX
      const texDays = theta?.decay_regime?.weighted_days || 30;
      const texLevel = texDays < 20 ? 'ALTO' : 'BAIXO';
      
      // Encontrar cenario correspondente
      for (let i = 1; i <= 16; i++) {
        const s = SCENARIOS_TABLE[i];
        if (s.gex === gexSign && s.dex === dexSign && s.vex === vexLevel && s.tex === texLevel) {
          return {
            number: i,
            ...s,
            raw: { gexValue, dexValue, vexRisk, texDays, gexSign, dexSign, vexLevel, texLevel }
          };
        }
      }
      
      // Fallback
      return { number: 0, name: 'Indefinido', raw: { gexSign, dexSign, vexLevel, texLevel } };
    }

    function calculateSignalStrength(scenario, gamma, delta, vega, theta) {
      let alignedFactors = 0;
      let intensityScore = 0;
      
      // Verificar alinhamento direcional
      const gexValue = gamma?.gex_levels?.total_gex_descoberto || 0;
      const dexValue = delta?.dex_levels?.total_dex_descoberto || 0;
      const direction = scenario.direction;
      
      // GEX alinhado com direcao?
      if (direction === 'ALTA' && gexValue < 0) alignedFactors++; // Short gamma + alta = squeeze
      if (direction === 'QUEDA' && gexValue < 0) alignedFactors++; // Short gamma + queda = crash
      if (direction === 'ALTA' && gexValue > 0) alignedFactors++; // Long gamma + alta = controlado
      if (direction === 'QUEDA' && gexValue > 0) alignedFactors++; // Long gamma + queda = controlado
      
      // DEX alinhado com direcao?
      if (direction === 'ALTA' && dexValue > 0) alignedFactors++;
      if (direction === 'QUEDA' && dexValue < 0) alignedFactors++;
      
      // VEX intenso?
      const vexRisk = vega?.vol_regime?.volatility_risk || 'LOW';
      if (vexRisk === 'HIGH' || vexRisk === 'MODERATE') intensityScore++;
      
      // TEX pressionando?
      const texDays = theta?.decay_regime?.weighted_days || 30;
      if (texDays < 20) intensityScore++;
      
      // Magnitude dos sinais
      const gexMagnitude = Math.abs(gexValue);
      const dexMagnitude = Math.abs(dexValue);
      
      if (gexMagnitude > 5000000000) intensityScore++;
      if (dexMagnitude > 200000000) intensityScore++;
      
      // Calcular forca total
      const totalScore = alignedFactors + intensityScore;
      
      if (totalScore >= 5) {
        return { level: 'FORTE', class: 'text-green-400', description: 'Todos indicadores alinhados' };
      } else if (totalScore >= 3) {
        return { level: 'MODERADO', class: 'text-yellow-400', description: 'Maioria dos indicadores alinhados' };
      } else {
        return { level: 'FRACO', class: 'text-red-400', description: 'Sinais mistos ou baixa intensidade' };
      }
    }

    // ============================================================
    // CALCULAR ESTRUTURAS DINAMICAS
    // ============================================================
    function calculateStructures(scenario, gamma, delta) {
      const spotPrice = gamma?.spot_price || 0;
      const flipStrike = gamma?.flip_strike || spotPrice;
      const gexSign = scenario.raw?.gexSign || 'LONG';
      const vexLevel = scenario.raw?.vexLevel || 'BAIXO';
      
      // Arredondar para strikes validos
      const roundStrike = (price) => Math.round(price);
      
      const structures = [];
      
      // LONG GAMMA = Venda de opcoes (mercado controlado)
      // SHORT GAMMA = Compra de opcoes (mercado explosivo)
      
      if (gexSign === 'LONG') {
        // Mercado controlado - estruturas de VENDA
        
        if (scenario.direction === 'ALTA') {
          // Rally controlado - vender puts, covered calls
          structures.push({
            name: 'Cash-Secured Put',
            primary: true,
            legs: [
              { action: 'Vende', type: 'Put', strike: roundStrike(spotPrice - 3) }
            ],
            logic: `Mercado em long gamma sobe controlado. Vende put OTM e coleta premio. Se exercido, compra mais barato.`
          });
          
          structures.push({
            name: 'Iron Condor Bullish',
            primary: false,
            legs: [
              { action: 'Vende', type: 'Put', strike: roundStrike(spotPrice - 4) },
              { action: 'Compra', type: 'Put', strike: roundStrike(spotPrice - 8) },
              { action: 'Vende', type: 'Call', strike: roundStrike(spotPrice + 6) },
              { action: 'Compra', type: 'Call', strike: roundStrike(spotPrice + 10) }
            ],
            logic: 'Long gamma = baixa vol realizada. Vende asas e coleta theta. Asa de put mais apertada (vies alta).'
          });
          
        } else {
          // Correcao controlada - vender calls
          structures.push({
            name: 'Bear Call Spread',
            primary: true,
            legs: [
              { action: 'Vende', type: 'Call', strike: roundStrike(spotPrice + 2) },
              { action: 'Compra', type: 'Call', strike: roundStrike(spotPrice + 6) }
            ],
            logic: `Mercado em long gamma cai controlado. Vende call spread e coleta premio na queda.`
          });
          
          structures.push({
            name: 'Iron Condor Bearish',
            primary: false,
            legs: [
              { action: 'Vende', type: 'Put', strike: roundStrike(spotPrice - 6) },
              { action: 'Compra', type: 'Put', strike: roundStrike(spotPrice - 10) },
              { action: 'Vende', type: 'Call', strike: roundStrike(spotPrice + 3) },
              { action: 'Compra', type: 'Call', strike: roundStrike(spotPrice + 7) }
            ],
            logic: 'Long gamma = baixa vol realizada. Vende asas e coleta theta. Asa de call mais apertada (vies baixa).'
          });
        }
        
      } else {
        // SHORT GAMMA = Mercado explosivo - estruturas de COMPRA
        
        if (scenario.direction === 'ALTA') {
          // Squeeze bullish - comprar calls
          const callBuy = roundStrike(Math.max(flipStrike, spotPrice - 1));
          const callSell = roundStrike(callBuy + 6);
          
          structures.push({
            name: 'Call Spread',
            primary: true,
            legs: [
              { action: 'Compra', type: 'Call', strike: callBuy },
              { action: 'Vende', type: 'Call', strike: callSell }
            ],
            logic: `Short gamma = movimento explosivo. Compra call no flip (R$ ${callBuy}), vende acima. Risco limitado.`
          });
          
          if (scenario.urgency !== 'CRITICA') {
            structures.push({
              name: 'Call Diagonal',
              primary: false,
              legs: [
                { action: 'Compra', type: 'Call', strike: roundStrike(spotPrice - 2), note: 'venc. longo' },
                { action: 'Vende', type: 'Call', strike: roundStrike(spotPrice + 4), note: 'venc. curto' }
              ],
              logic: 'Theta trabalha a favor. Se subir devagar, ganha nas duas pontas. Se explodir, call longa captura.'
            });
          }
          
        } else {
          // Crash - comprar puts
          const putBuy = roundStrike(spotPrice - 2);
          const putSell = roundStrike(putBuy - 6);
          
          structures.push({
            name: 'Put Spread',
            primary: true,
            legs: [
              { action: 'Compra', type: 'Put', strike: putBuy },
              { action: 'Vende', type: 'Put', strike: putSell }
            ],
            logic: `Short gamma = queda explosiva. Compra put proximo, vende abaixo. Captura aceleracao.`
          });
          
          structures.push({
            name: 'Bear Put Spread',
            primary: false,
            legs: [
              { action: 'Compra', type: 'Put', strike: roundStrike(spotPrice) },
              { action: 'Vende', type: 'Put', strike: roundStrike(spotPrice - 8) }
            ],
            logic: 'Spread mais largo para capturar movimento maior. Maior custo, maior ganho potencial.'
          });
        }
      }
      
      return structures;
    }

    // ============================================================
    // CALCULAR ALERTAS DINAMICOS
    // ============================================================
    function calculateAlerts(scenario, gamma, delta, vega, theta) {
      const alerts = [];
      const spotPrice = gamma?.spot_price || 0;
      const flipStrike = gamma?.flip_strike || spotPrice;
      const dexValue = delta?.dex_levels?.total_dex_descoberto || 0;
      const ivAtual = vega?.vol_regime?.weighted_iv || 0;
      const diasVenc = theta?.decay_regime?.weighted_days || 30;
      
      // Alerta de Flip
      const flipDistance = ((spotPrice - flipStrike) / spotPrice * 100).toFixed(2);
      if (Math.abs(flipDistance) < 2) {
        alerts.push({
          type: 'warning',
          title: 'Proximo do Gamma Flip',
          message: `Spot esta a apenas ${Math.abs(flipDistance)}% do flip (R$ ${flipStrike.toFixed(2)}). Rompimento pode mudar regime.`
        });
      }
      
      // Alerta de inversao
      if (scenario.direction === 'ALTA') {
        const invalidation = Math.round(flipStrike - 2);
        alerts.push({
          type: 'danger',
          title: 'Nivel de Invalidacao',
          message: `Se perder R$ ${invalidation}, cenario muda para QUEDA. Considere stop ou hedge.`
        });
      } else {
        const invalidation = Math.round(flipStrike + 2);
        alerts.push({
          type: 'danger',
          title: 'Nivel de Invalidacao',
          message: `Se romper R$ ${invalidation}, cenario muda para ALTA. Revise posicoes vendidas.`
        });
      }
      
      // Alerta de DEX
      if (Math.abs(dexValue) < 50000000) {
        alerts.push({
          type: 'info',
          title: 'DEX Fraco',
          message: 'Pressao direcional fraca. Vies pode mudar facilmente.'
        });
      }
      
      // Alerta de Theta
      if (diasVenc < 14) {
        alerts.push({
          type: 'warning',
          title: 'Theta Acelerado',
          message: `Apenas ${diasVenc} dias ate vencimento. Theta comeca a acelerar exponencialmente.`
        });
      }
      
      // Alerta de IV
      if (ivAtual > 50) {
        alerts.push({
          type: 'info',
          title: 'IV Elevada',
          message: 'Volatilidade implicita alta. Opcoes estao caras. Considere estruturas de venda.'
        });
      }
      
      return alerts;
    }

    // ============================================================
    // RENDERIZACAO
    // ============================================================
    function renderMasterTable(activeScenario) {
      const tbody = document.getElementById('masterTableBody');
      tbody.innerHTML = '';
      
      for (let i = 1; i <= 16; i++) {
        const s = SCENARIOS_TABLE[i];
        const isActive = activeScenario === i;
        
        const tr = document.createElement('tr');
        if (isActive) tr.classList.add('active-scenario');
        
        tr.innerHTML = `
          <td class="font-mono">${i}</td>
          <td><span class="dim-indicator ${s.gex === 'SHORT' ? 'dim-negative' : 'dim-positive'}">${s.gex}</span></td>
          <td><span class="dim-indicator ${s.dex === 'POS' ? 'dim-positive' : 'dim-negative'}">${s.dex}</span></td>
          <td><span class="dim-indicator ${s.vex === 'ALTO' ? 'dim-high' : 'dim-low'}">${s.vex}</span></td>
          <td><span class="dim-indicator ${s.tex === 'ALTO' ? 'dim-high' : 'dim-low'}">${s.tex}</span></td>
          <td class="font-medium">${s.name}</td>
          <td class="text-green-400 text-xs">${s.structures.slice(0, 2).join(', ')}</td>
          <td class="text-red-400 text-xs">${s.avoid.slice(0, 2).join(', ')}</td>
        `;
        
        tbody.appendChild(tr);
      }
    }

    function renderDiagnostic(scenario, signalStrength) {
      // Nome e numero
      document.getElementById('scenarioName').textContent = scenario.name || '--';
      document.getElementById('scenarioNumber').textContent = `Cenario #${scenario.number || '--'}`;
      
      // Indicadores
      const gexInd = document.getElementById('gexIndicator');
      const dexInd = document.getElementById('dexIndicator');
      const vexInd = document.getElementById('vexIndicator');
      const texInd = document.getElementById('texIndicator');
      
      gexInd.textContent = scenario.raw?.gexSign || '--';
      gexInd.className = `dim-indicator ${scenario.raw?.gexSign === 'SHORT' ? 'dim-negative' : 'dim-positive'}`;
      
      dexInd.textContent = scenario.raw?.dexSign || '--';
      dexInd.className = `dim-indicator ${scenario.raw?.dexSign === 'POS' ? 'dim-positive' : 'dim-negative'}`;
      
      vexInd.textContent = scenario.raw?.vexLevel || '--';
      vexInd.className = `dim-indicator ${scenario.raw?.vexLevel === 'ALTO' ? 'dim-high' : 'dim-low'}`;
      
      texInd.textContent = scenario.raw?.texLevel || '--';
      texInd.className = `dim-indicator ${scenario.raw?.texLevel === 'ALTO' ? 'dim-high' : 'dim-low'}`;
      
      // Interpretacao
      document.getElementById('scenarioInterpretation').textContent = scenario.interpretation || '--';
      
      // Forca do Sinal
      const strengthEl = document.getElementById('signalStrength');
      strengthEl.textContent = signalStrength.level;
      strengthEl.className = `text-2xl font-black ${signalStrength.class}`;
      document.getElementById('signalDescription').textContent = signalStrength.description;
      
      // Direcao
      const dirEl = document.getElementById('probableDirection');
      dirEl.textContent = scenario.direction || '--';
      dirEl.className = `text-2xl font-black ${scenario.direction === 'ALTA' ? 'text-green-400' : 'text-red-400'}`;
      
      // Intensidade
      document.getElementById('intensityLevel').textContent = scenario.intensity || '--';
    }

    function renderStructures(structures) {
      const container = document.getElementById('structuresContainer');
      container.innerHTML = '';
      
      structures.forEach((struct, idx) => {
        const card = document.createElement('div');
        card.className = `structure-card ${struct.primary ? 'primary' : ''}`;
        
        const legsHtml = struct.legs.map(leg => 
          `<div class="flex items-center gap-2 text-sm">
            <span class="${leg.action === 'Compra' ? 'text-green-400' : 'text-red-400'} font-semibold">${leg.action}</span>
            <span class="text-gray-300">${leg.type} R$ ${leg.strike}</span>
            ${leg.note ? `<span class="text-gray-500 text-xs">(${leg.note})</span>` : ''}
          </div>`
        ).join('');
        
        card.innerHTML = `
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-bold text-white">${struct.name}</h4>
            ${struct.primary ? '<span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">PRINCIPAL</span>' : ''}
          </div>
          <div class="space-y-1 mb-3">${legsHtml}</div>
          <div class="text-xs text-gray-400 mb-3">${struct.logic}</div>
          <button class="view-payoff-btn" onclick='openPayoffModal(${JSON.stringify(struct)}, currentScenario)'>
            <i class="fas fa-chart-line"></i>
            Ver Gráfico de Payoff
          </button>
        `;
        
        container.appendChild(card);
      });
    }

    function renderAlerts(alerts) {
      const container = document.getElementById('alertsContainer');
      container.innerHTML = '';
      
      alerts.forEach(alert => {
        const item = document.createElement('div');
        item.className = `alert-item alert-${alert.type}`;
        item.innerHTML = `
          <div class="font-semibold text-sm text-white mb-1">${alert.title}</div>
          <div class="text-xs text-gray-400">${alert.message}</div>
        `;
        container.appendChild(item);
      });
    }

    function renderAvoid(scenario) {
      const container = document.getElementById('avoidContainer');
      container.innerHTML = '';
      
      (scenario.avoid || []).forEach(item => {
        const div = document.createElement('div');
        div.className = 'alert-item alert-danger';
        div.innerHTML = `
          <div class="flex items-center gap-2">
            <i class="fas fa-times-circle text-red-400"></i>
            <span class="text-sm text-gray-300">${item}</span>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // ============================================================
    // RENDERIZACAO DE GRAFICOS - PADRAO GEX FULL
    // ============================================================
    function renderCharts() {
      if (typeof Plotly === 'undefined') {
        console.error('Plotly não carregado');
        return;
      }

      try {
        // Renderizar cada gráfico completo usando o padrão GEX Full
        renderSingleChart('gexDescChart', gammaData.plot_json, 'GEX Descoberto');
        renderSingleChart('dexMomentumChart', deltaData.plot_json, 'DEX Momentum');
        renderSingleChart('vexDescChart', vegaData.plot_json, 'VEX Descoberto');
        renderSingleChart('texCumChart', thetaData.plot_json, 'TEX Cumulativo');

      } catch (error) {
        console.error('Erro ao renderizar graficos:', error);
      }
    }

    function renderSingleChart(elementId, plotJson, title) {
      if (!plotJson) {
        console.warn(`Plot JSON não encontrado para ${elementId}`);
        return;
      }

      try {
        const plotData = JSON.parse(plotJson);
        
        // Configuração do gráfico - IGUAL AO GEX FULL
        const config = {
          responsive: true,
          displayModeBar: false,
          displaylogo: false
        };

        // Layout customizado para gráfico individual - IGUAL AO GEX FULL
        const layout = {
          ...plotData.layout,
          height: 380,
          margin: { l: 60, r: 20, t: 30, b: 50 },
          paper_bgcolor: 'rgba(0,0,0,0)',
          plot_bgcolor: 'rgba(0,0,0,0)',
          font: { 
            color: '#888888', 
            family: 'Inter, sans-serif', 
            size: 10 
          },
          xaxis: {
            ...plotData.layout.xaxis,
            gridcolor: 'rgba(255,255,255,0.08)',
            color: '#666666',
            showgrid: true,
            zeroline: false,
            showline: false
          },
          yaxis: {
            ...plotData.layout.yaxis,
            gridcolor: 'rgba(255,255,255,0.08)',
            color: '#666666',
            showgrid: true,
            zeroline: true,
            zerolinecolor: 'rgba(255,255,255,0.2)',
            showline: false
          },
          showlegend: false,
          hovermode: 'x unified',
          
          // ============ CORES DO HOVER/TOOLTIP ============
          hoverlabel: {
            bgcolor: 'rgba(20, 20, 20, 0.95)',     // Fundo do tooltip - MUDA AQUI
            bordercolor: '#fb1ebb',                 // Borda do tooltip - MUDA AQUI  
            font: {
              family: 'Inter, sans-serif',
              size: 13,                             // Tamanho da fonte - MUDA AQUI
              color: '#ffffff'                      // Cor do texto - MUDA AQUI (branco)
            }
          },
          // ================================================
          
          title: {
            text: '',
            font: { size: 14, color: '#ffffff' }
          },
          annotations: [] // Remove todos os títulos de subplot
        };

        // Criar o gráfico - IGUAL AO GEX FULL
        Plotly.newPlot(elementId, plotData.data, layout, config);
        
        // Forçar resize após um pequeno delay - IGUAL AO GEX FULL
        setTimeout(() => {
          try {
            Plotly.Plots.resize(elementId);
          } catch (e) {
            console.warn('Resize falhou:', e);
          }
        }, 100);

      } catch (error) {
        console.error(`Erro ao renderizar ${elementId}:`, error);
        document.getElementById(elementId).innerHTML = 
          '<div class="text-center text-red-400 text-xs p-4">Erro ao carregar gráfico</div>';
      }
    }

    // ============================================================
    // DISPLAY PRINCIPAL
    // ============================================================
    function displayResults() {
      // Metricas basicas
      document.getElementById('spotPrice').textContent = `R$ ${gammaData.spot_price?.toFixed(2) || '--'}`;
      document.getElementById('flipStrike').textContent = gammaData.flip_strike ? `R$ ${gammaData.flip_strike.toFixed(2)}` : 'N/A';
      document.getElementById('gexDescoberto').textContent = formatLargeNumber(gammaData.gex_levels?.total_gex_descoberto);
      document.getElementById('dexDescoberto').textContent = formatLargeNumber(deltaData.dex_levels?.total_dex_descoberto);
      document.getElementById('ivAtual').textContent = vegaData.vol_regime?.weighted_iv ? `${vegaData.vol_regime.weighted_iv.toFixed(1)}%` : '--';
      document.getElementById('diasVenc').textContent = thetaData.decay_regime?.weighted_days ? `${Math.round(thetaData.decay_regime.weighted_days)}d` : '--';
      
      // Classificar cenario
      currentScenario = classifyScenario(gammaData, deltaData, vegaData, thetaData);
      const signalStrength = calculateSignalStrength(currentScenario, gammaData, deltaData, vegaData, thetaData);
      
      // Renderizar componentes
      renderMasterTable(currentScenario.number);
      renderDiagnostic(currentScenario, signalStrength);
      
      const structures = calculateStructures(currentScenario, gammaData, deltaData);
      renderStructures(structures);
      
      const alerts = calculateAlerts(currentScenario, gammaData, deltaData, vegaData, thetaData);
      renderAlerts(alerts);
      
      renderAvoid(currentScenario);
      renderCharts();
      
      document.getElementById('resultsSection').classList.remove('hidden');
    }

    // ============================================================
    // API CALLS
    // ============================================================
    async function loadExpirations() {
      const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
      if (!ticker) { showStatus('Digite um ticker primeiro', 'error'); return; }

      const btn = document.getElementById('loadExpirationsBtn');
      setLoading(btn, true);

      try {
        const response = await fetch('/pro/gamma/expirations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
          body: JSON.stringify({ ticker })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error);

        const select = document.getElementById('expirationSelect');
        select.innerHTML = '<option value="">Vencimento Automatico</option>';
        
        data.expirations.forEach(exp => {
          const option = document.createElement('option');
          option.value = exp.code;
          option.textContent = `${exp.desc} (${exp.data_count} contratos)`;
          option.disabled = !exp.available;
          select.appendChild(option);
        });
        
        showStatus(`${data.total_available} vencimentos carregados`, 'success');

      } catch (error) {
        showStatus('Erro: ' + error.message, 'error');
      } finally {
        setLoading(btn, false);
      }
    }

    async function runFullAnalysis() {
      const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
      if (!ticker) { showStatus('Digite um ticker', 'error'); return; }

      const btn = document.getElementById('analyzeBtn');
      setLoading(btn, true);
      showStatus('Executando analise completa 4D...', 'info');

      try {
        const requestBody = { ticker, days_back: 60 };
        const expiration = document.getElementById('expirationSelect').value;
        if (expiration) requestBody.expiration_code = expiration;

        const [gammaRes, deltaRes, vegaRes, thetaRes] = await Promise.all([
          fetch('/pro/gamma/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` }, body: JSON.stringify(requestBody) }),
          fetch('/pro/delta/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` }, body: JSON.stringify(requestBody) }),
          fetch('/pro/vega/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` }, body: JSON.stringify(requestBody) }),
          fetch('/pro/theta/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` }, body: JSON.stringify(requestBody) })
        ]);

        gammaData = await gammaRes.json();
        deltaData = await deltaRes.json();
        vegaData = await vegaRes.json();
        thetaData = await thetaRes.json();
        
        if (!gammaRes.ok) throw new Error(gammaData.error);
        if (!deltaRes.ok) throw new Error(deltaData.error);
        if (!vegaRes.ok) throw new Error(vegaData.error);
        if (!thetaRes.ok) throw new Error(thetaData.error);

        displayResults();
        showStatus(`Analise 4D de ${ticker} concluida!`, 'success');

      } catch (error) {
        showStatus('Erro: ' + error.message, 'error');
      } finally {
        setLoading(btn, false);
      }
    }

    // ============================================================
    // EVENT LISTENERS
    // ============================================================
    document.getElementById('loadExpirationsBtn').addEventListener('click', loadExpirations);
    document.getElementById('analyzeBtn').addEventListener('click', runFullAnalysis);
    document.getElementById('tickerInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') runFullAnalysis(); });

    // Resize handler - IGUAL AO GEX FULL + Mobile
    let resizeTimeout;
    window.addEventListener('resize', function() {
      if (document.getElementById('resultsSection').classList.contains('hidden')) return;
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        ['gexDescChart', 'dexMomentumChart', 'vexDescChart', 'texCumChart'].forEach(id => {
          try { 
            Plotly.Plots.resize(id);
            // Forçar redraw em mobile
            if (window.innerWidth < 768) {
              const element = document.getElementById(id);
              if (element && element.layout) {
                Plotly.relayout(id, {
                  'xaxis.autorange': true,
                  'yaxis.autorange': true
                });
              }
            }
          } catch (e) {}
        });
      }, 200);
    });

    // Detectar orientação em mobile
    window.addEventListener('orientationchange', function() {
      setTimeout(() => {
        ['gexDescChart', 'dexMomentumChart', 'vexDescChart', 'texCumChart'].forEach(id => {
          try { Plotly.Plots.resize(id); } catch (e) {}
        });
      }, 300);
    });

    // Init - IGUAL AO GEX FULL
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar se Plotly carregou
      if (typeof Plotly === 'undefined') {
        console.error('Plotly não carregou - tentando carregar alternativo');
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/plotly.js-dist@2.26.0/plotly.min.js';
        document.head.appendChild(script);
      }
      
      renderMasterTable(0); // Renderiza tabela vazia
      showStatus('Sistema Greeks Micro 4D carregado. Digite um ticker para comecar.', 'info');
      
      // Fechar modal clicando fora
      document.getElementById('payoffModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closePayoffModal();
        }
      });
      
      // Fechar modal com ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closePayoffModal();
        }
      });
    });

  </script>

</body>
</html>