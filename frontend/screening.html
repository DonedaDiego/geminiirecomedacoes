<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Screening de Opções - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#000000',
            light: '#ffffff',
            subtle: 'rgba(255,255,255,0.1)',
            geminii: '#ba39af'
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
      min-height: 100vh;
    }
    
    .screening-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 2rem;
      transition: all 0.3s ease;
    }
    
    .screening-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(186, 57, 175, 0.15);
      border-color: rgba(186, 57, 175, 0.3);
    }

    .screening-type-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .screening-type-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(186, 57, 175, 0.3);
    }

    .screening-type-card.active {
      background: linear-gradient(135deg, rgba(186, 57, 175, 0.2), rgba(139, 92, 246, 0.2));
      border-color: #ba39af;
    }

    .screening-type-card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .filter-section {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .range-slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.1);
      outline: none;
      -webkit-appearance: none;
    }

    .range-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #ba39af;
      cursor: pointer;
    }

    .range-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #ba39af;
      cursor: pointer;
      border: none;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .spinner {
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 2px solid #ba39af;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .result-table {
      overflow-x: auto;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
    }

    .result-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .result-table th,
    .result-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .result-table th {
      background: rgba(255, 255, 255, 0.05);
      font-weight: 600;
      color: #ba39af;
    }

    .profit-positive {
      color: #10b981;
      font-weight: 600;
    }

    .profit-negative {
      color: #ef4444;
      font-weight: 600;
    }

    .vencimento-checkbox {
      margin: 0.5rem;
      accent-color: #ba39af;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.2);
      transition: 0.4s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: #ba39af;
    }

    input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    /* Estilo específico para select/combobox */
    select {
      background: #1f2937 !important;
      color: white !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
    }

    select:focus {
      background: #374151 !important;
      border-color: #ba39af !important;
      outline: none !important;
    }

    select option {
      background: #1f2937 !important;
      color: white !important;
      padding: 8px !important;
    }

    select option:hover {
      background: #374151 !important;
    }

    select option:checked {
      background: #ba39af !important;
    }
  </style>
</head>
<body class="text-white">
  
  <!-- Navbar -->
  <nav class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-opacity-5 border-opacity-10 bg-white border-white border rounded-full px-4 py-3 shadow-xl backdrop-blur-md">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <img src="logo.png" alt="Geminii Logo" class="w-6 h-6 cursor-pointer" onclick="window.location.href='/'">
      </div>
      <div class="hidden md:flex items-center space-x-6 text-xs text-gray-300 ml-8">
        <a href="/dashboard" class="hover:text-white transition-colors">Dashboard</a>
        <a href="opcoes.html" class="hover:text-white transition-colors">Walls</a>
        <a href="calculadora.html" class="hover:text-white transition-colors">Calc vol</a>
        <a href="rank-volatilidade.html" class="hover:text-white transition-colors">IV Scanner</a>

        <span class="text-white font-medium">Screening</span>
      </div>
      <div class="flex items-center space-x-3 ml-8">
        <div id="apiStatus" class="w-8 h-8 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-full flex items-center justify-center relative">
          <i class="fas fa-search text-green-500 text-xs"></i>
          <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Content -->
  <div class="pt-32 pb-16">
    <div class="max-w-7xl mx-auto px-6">
      
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">
          <span style="color: #ba39af; font-weight: 900;">Screening</span>
          <span class="text-white font-light">de Opções</span>
        </h1>
        <p class="text-neutral-300 text-lg max-w-2xl mx-auto">
          Radar inteligente para identificar oportunidades de trading em opções
        </p>
      </div>

      <!-- Seleção do Tipo de Screening -->
      <div class="screening-card mb-8">
        <h2 class="text-2xl font-bold mb-6 text-center">
          <i class="fas fa-radar mr-2 text-purple-400"></i>
          Escolha o Tipo de Screening
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="screening-types">
          <!-- Screening types will be populated here -->
        </div>
      </div>

      <!-- Painel de Configuração -->
      <div class="screening-card mb-8" id="config-panel" style="display: none;">
        <h3 class="text-xl font-bold mb-6">
          <i class="fas fa-sliders-h mr-2 text-blue-400"></i>
          Configuração do Screening
        </h3>

        <!-- Seleção de Ativos -->
        <div class="filter-section">
          <h4 class="text-lg font-semibold mb-4">Seleção de Ativos</h4>
          
          <div class="flex flex-wrap gap-4 mb-4">
            <label class="flex items-center space-x-2 cursor-pointer">
              <input type="radio" name="asset-selection" value="lista" class="text-purple-500" checked>
              <span>Lista Predefinida</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
              <input type="radio" name="asset-selection" value="manual" class="text-purple-500">
              <span>Ativos Específicos</span>
            </label>
          </div>

          <div id="lista-selection" class="mb-4">
            <select id="lista-predefinida" class="w-full p-3 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white">
              <option value="">Selecione uma lista...</option>
            </select>
          </div>

          <div id="manual-selection" class="mb-4" style="display: none;">
            <input type="text" id="simbolos-manual" placeholder="Digite os códigos separados por vírgula (ex: PETR4, VALE3, ITUB4)" 
                   class="w-full p-3 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white placeholder-gray-400">
          </div>
        </div>

        <!-- Filtros Dinâmicos por Tipo -->
        <div id="dynamic-filters">
          <!-- Filtros específicos aparecerão aqui -->
        </div>

        <!-- Botão Executar -->
        <div class="text-center">
          <button id="execute-screening" class="px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:shadow-lg rounded-lg transition-all font-semibold text-lg">
            <i class="fas fa-play mr-2"></i>
            Executar Screening
          </button>
        </div>
      </div>

      <!-- Status Messages -->
      <div id="status-msg" class="mb-6 p-4 rounded-lg hidden backdrop-blur-sm"></div>

      <!-- Progress Panel -->
      <div id="progress-panel" class="screening-card mb-8" style="display: none;">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold">
            <i class="fas fa-cog fa-spin mr-2 text-purple-400"></i>
            Executando Screening
          </h3>
          <div class="text-sm text-gray-400" id="progress-timer">00:00</div>
        </div>
        
        <!-- Progress Bar -->
        <div class="mb-4">
          <div class="flex justify-between text-sm mb-2">
            <span>Progresso</span>
            <span id="progress-text">0/0</span>
          </div>
          <div class="w-full bg-gray-700 rounded-full h-2">
            <div id="progress-bar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
          </div>
        </div>
        
        <!-- Current Status -->
        <div class="mb-4 p-3 bg-white bg-opacity-5 rounded-lg">
          <div class="text-sm text-gray-400">Status atual:</div>
          <div id="current-status" class="font-medium">Iniciando...</div>
        </div>
        
        <!-- Progress Log -->
        <div class="bg-black bg-opacity-30 rounded-lg p-3 h-32 overflow-y-auto">
          <div id="progress-log" class="text-sm font-mono space-y-1">
            <!-- Log entries will appear here -->
          </div>
        </div>
        
        <!-- Statistics -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
          <div class="text-center">
            <div id="stats-processed" class="text-2xl font-bold text-green-400">0</div>
            <div class="text-xs text-gray-400">Processados</div>
          </div>
          <div class="text-center">
            <div id="stats-opportunities" class="text-2xl font-bold text-purple-400">0</div>
            <div class="text-xs text-gray-400">Oportunidades</div>
          </div>
          <div class="text-center">
            <div id="stats-errors" class="text-2xl font-bold text-red-400">0</div>
            <div class="text-xs text-gray-400">Erros</div>
          </div>
          <div class="text-center">
            <div id="stats-remaining" class="text-2xl font-bold text-blue-400">0</div>
            <div class="text-xs text-gray-400">Restantes</div>
          </div>
        </div>
      </div>

      <!-- Resultados -->
      <div id="results-panel" class="screening-card" style="display: none;">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold">
            <i class="fas fa-chart-line mr-2 text-green-400"></i>
            Resultados do Screening
          </h3>
          <div class="flex gap-2">
            <button id="export-csv" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm">
              <i class="fas fa-download mr-1"></i>
              Exportar CSV
            </button>
            <button id="save-config" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm">
              <i class="fas fa-save mr-1"></i>
              Salvar Config
            </button>
          </div>
        </div>

        <!-- Resumo -->
        <div id="results-summary" class="mb-6">
          <!-- Summary cards will appear here -->
        </div>

        <!-- Tabela de Resultados -->
        <div id="results-table-container" class="result-table">
          <!-- Results table will appear here -->
        </div>
      </div>

    </div>
  </div>

  <script>
    // Configurações - Estrutura Modular
    const API_ENDPOINTS = {
      arbitragem_puts: '/api/arbi-puts',
      collar_protegido: '/api/collar',
      box_tres_pontas: '/api/box3',
      strangle_vendido: '/api/strangle',
      health: '/screening/health'
    };
    
    // Tipos de Screening Disponíveis
    const availableTypes = {
      'arbitragem_puts': {
        'nome': 'Arbitragem de Puts',
        'descricao': 'Busca oportunidades de arbitragem em puts com valor extrínseco negativo',
        'status': 'ativo'
      },
      'collar_protegido': {
        'nome': 'Collar Protegido',
        'descricao': 'Proteção com put + venda de call',
        'status': 'em_desenvolvimento'
      },
      'box_tres_pontas': {
        'nome': 'Box de 3 Pontas',
        'descricao': 'Renda fixa sintética com ativo + call + put',
        'status': 'ativo'
      },
      'strangle_vendido': {
        'nome': 'Strangle Vendido',
        'descricao': 'Venda de call OTM + put OTM',
        'status': 'em_desenvolvimento'
      }
    };

    // Listas predefinidas (será carregado dinamicamente)
    let availableLists = {};
    
    // State
    let currentScreeningType = null;
    let progressTimer = null;
    let startTime = null;
    
    // Elements
    const statusMsg = document.getElementById('status-msg');
    const configPanel = document.getElementById('config-panel');
    const resultsPanel = document.getElementById('results-panel');
    const progressPanel = document.getElementById('progress-panel');
    const executeBtn = document.getElementById('execute-screening');
    
    // Progress Elements
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const currentStatus = document.getElementById('current-status');
    const progressLog = document.getElementById('progress-log');
    const progressTimerEl = document.getElementById('progress-timer');
    const statsProcessed = document.getElementById('stats-processed');
    const statsOpportunities = document.getElementById('stats-opportunities');
    const statsErrors = document.getElementById('stats-errors');
    const statsRemaining = document.getElementById('stats-remaining');
    
    // Utility Functions
    function showStatus(message, type = 'info') {
      const bgClass = type === 'success' ? 'bg-green-600 bg-opacity-20 border-green-500 border-opacity-30' : 
                     type === 'error' ? 'bg-red-600 bg-opacity-20 border-red-500 border-opacity-30' : 
                     type === 'warning' ? 'bg-yellow-600 bg-opacity-20 border-yellow-500 border-opacity-30' :
                     'bg-blue-600 bg-opacity-20 border-blue-500 border-opacity-30';
      
      statusMsg.className = `mb-6 p-4 rounded-lg border backdrop-blur-sm ${bgClass}`;
      statusMsg.textContent = message;
      statusMsg.classList.remove('hidden');
      setTimeout(() => statusMsg.classList.add('hidden'), 5000);
    }
    
    function setLoading(element, loading) {
      if (loading) {
        element.classList.add('loading');
        const icon = element.querySelector('i');
        if (icon) icon.className = 'fas fa-spinner fa-spin mr-2';
      } else {
        element.classList.remove('loading');
        const icon = element.querySelector('i');
        if (icon) icon.className = 'fas fa-play mr-2';
      }
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(value);
    }

    function formatPercent(value) {
      return `${value.toFixed(2)}%`;
    }

    // Progress Functions
    function showProgress(totalAssets) {
      progressPanel.style.display = 'block';
      resultsPanel.style.display = 'none';
      
      // Reset progress
      progressBar.style.width = '0%';
      progressText.textContent = `0/${totalAssets}`;
      progressLog.innerHTML = '';
      
      // Reset stats
      statsProcessed.textContent = '0';
      statsOpportunities.textContent = '0';
      statsErrors.textContent = '0';
      statsRemaining.textContent = totalAssets;
      
      // Start timer
      startTime = Date.now();
      progressTimer = setInterval(updateTimer, 1000);
      
      // Initial log
      addProgressLog('🔍 Iniciando screening...', 'info');
    }
    
    function hideProgress() {
      progressPanel.style.display = 'none';
      
      // Stop timer
      if (progressTimer) {
        clearInterval(progressTimer);
        progressTimer = null;
      }
    }
    
    function updateProgress(current, total, currentAsset, status) {
      const percentage = (current / total) * 100;
      progressBar.style.width = `${percentage}%`;
      progressText.textContent = `${current}/${total}`;
      
      if (currentAsset) {
        currentStatus.textContent = `Analisando ${currentAsset}...`;
      }
      
      // Update remaining
      statsRemaining.textContent = total - current;
      
      // Add to log
      if (currentAsset && status) {
        addProgressLog(`${currentAsset}: ${status}`, getLogType(status));
      }
    }
    
    function updateProgressStats(processed, opportunities, errors) {
      statsProcessed.textContent = processed;
      statsOpportunities.textContent = opportunities;
      statsErrors.textContent = errors;
    }
    
    function addProgressLog(message, type = 'info') {
      const logEntry = document.createElement('div');
      const timestamp = new Date().toLocaleTimeString();
      
      let icon = '📋';
      let color = 'text-gray-300';
      
      switch(type) {
        case 'success':
          icon = '✅';
          color = 'text-green-400';
          break;
        case 'error':
          icon = '❌';
          color = 'text-red-400';
          break;
        case 'warning':
          icon = '⚪';
          color = 'text-yellow-400';
          break;
        case 'info':
          icon = '🔍';
          color = 'text-blue-400';
          break;
      }
      
      logEntry.className = `${color}`;
      logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${icon} ${message}`;
      
      progressLog.appendChild(logEntry);
      progressLog.scrollTop = progressLog.scrollHeight;
    }
    
    function getLogType(status) {
      if (status.includes('oportunidades encontradas')) return 'success';
      if (status.includes('Sem oportunidades')) return 'warning';
      if (status.includes('Erro') || status.includes('não encontrado')) return 'error';
      return 'info';
    }
    
    function updateTimer() {
      if (!startTime) return;
      
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      
      progressTimerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function completeProgress(totalOpportunities) {
      currentStatus.textContent = 'Screening concluído!';
      progressBar.style.width = '100%';
      
      addProgressLog(`🎉 Screening concluído! ${totalOpportunities} oportunidades encontradas`, 'success');
      
      // Hide progress after 2 seconds
      setTimeout(() => {
        hideProgress();
      }, 2000);
    }

    // Load Initial Data
    async function loadInitialData() {
      try {
        // Render screening types (usando dados locais)
        renderScreeningTypes();
     
        // Load predefined lists baseado no tipo de screening
        try {
          let listsEndpoint = '/api/arbi-puts/listas'; // Default
          
          // Se já tem um tipo selecionado, usar o endpoint específico
          if (currentScreeningType === 'box_tres_pontas') {
            listsEndpoint = '/api/box3/listas';
          }
          
          const listsResponse = await fetch(listsEndpoint);
          const listsData = await listsResponse.json();
          
          if (listsData.success) {
            availableLists = listsData.listas;
            renderListOptions();
          } else {
            // Se API não responder, não carregar nada - usuário pode usar manual
            availableLists = {};
            renderListOptions();
          }
        } catch (error) {
          console.log('API de listas não disponível - usando modo manual');
          availableLists = {};
          renderListOptions();
        }
     
      } catch (error) {
        showStatus('Erro ao carregar dados iniciais', 'error');
        console.error(error);
      }
     }

    // Render Screening Types
    function renderScreeningTypes() {
      const container = document.getElementById('screening-types');
      container.innerHTML = '';

      Object.entries(availableTypes).forEach(([key, type]) => {
        const isDisabled = type.status === 'em_desenvolvimento';
        const card = document.createElement('div');
        card.className = `screening-type-card ${isDisabled ? 'disabled' : ''}`;
        card.innerHTML = `
          <div class="text-center">
            <i class="fas fa-${getIconForType(key)} text-3xl mb-3 text-purple-400"></i>
            <h4 class="font-semibold mb-2">${type.nome}</h4>
            <p class="text-sm text-gray-400 mb-3">${type.descricao}</p>
            ${isDisabled ? '<span class="text-xs text-orange-400">Em Desenvolvimento</span>' : ''}
          </div>
        `;
        
        if (!isDisabled) {
          card.addEventListener('click', () => selectScreeningType(key));
        } else {
          card.addEventListener('click', () => {
            showStatus('Este tipo de screening está em desenvolvimento', 'warning');
          });
        }
        
        container.appendChild(card);
      });
    }

    function getIconForType(type) {
      const icons = {
        'arbitragem_puts': 'chart-line',
        'collar_protegido': 'shield-alt',
        'box_tres_pontas': 'cube',
        'strangle_vendido': 'expand-arrows-alt'
      };
      return icons[type] || 'chart-bar';
    }

    // Select Screening Type
    function selectScreeningType(type) {
      // Verificar se o endpoint está disponível
      if (!API_ENDPOINTS[type]) {
        showStatus('Serviço ainda não implementado', 'warning');
        return;
      }

      currentScreeningType = type;
      
      // Update visual selection
      document.querySelectorAll('.screening-type-card').forEach(card => {
        card.classList.remove('active');
      });
      event.currentTarget.classList.add('active');
      
      // Show config panel
      configPanel.style.display = 'block';
      
      // Render specific filters
      renderDynamicFilters(type);
      
      // Hide results
      resultsPanel.style.display = 'none';
      
      // Carregar listas específicas do tipo selecionado
      loadListsForScreeningType(type);
      
      showStatus(`Tipo de screening selecionado: ${availableTypes[type].nome}`, 'success');
    }

    // Carregar listas específicas por tipo de screening
    async function loadListsForScreeningType(type) {
      try {
        let endpoint = '/api/arbi-puts/listas'; // Default
        
        if (type === 'box_tres_pontas') {
          endpoint = '/api/box3/listas';
        }
        // Adicionar outros tipos quando implementados
        
        const response = await fetch(endpoint);
        const data = await response.json();
        
        if (data.success) {
          availableLists = data.listas;
          renderListOptions();
        }
      } catch (error) {
        console.log(`Erro ao carregar listas para ${type}:`, error);
      }
    }

    // Render Dynamic Filters
    function renderDynamicFilters(type) {
      const container = document.getElementById('dynamic-filters');
      
      if (type === 'arbitragem_puts') {
        container.innerHTML = `
          <!-- Parâmetros Gerais -->
          <div class="filter-section">
            <h4 class="text-lg font-semibold mb-4">Parâmetros Gerais</h4>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium mb-2">Taxa CDI Mensal (%)</label>
                <input type="number" id="taxa-cdi" value="1.0" min="0" max="10" step="0.1" 
                       class="w-full p-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Volume Mínimo</label>
                <input type="number" id="volume-min" value="100" min="0" max="10000" step="10" 
                       class="w-full p-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Rentabilidade Mínima (%)</label>
                <input type="number" id="rentabilidade-min" value="1.2" min="0" max="50" step="0.1" 
                       class="w-full p-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white">
              </div>
            </div>
          </div>

          <!-- Filtros Avançados -->
          <div class="filter-section">
            <h4 class="text-lg font-semibold mb-4">Filtros Avançados</h4>
            
            <!-- Range de Delta -->
            <div class="mb-6">
              <label class="block text-sm font-medium mb-2">Range de Delta (Entre 0.15 e 0.7)</label>
              <div class="flex items-center space-x-4">
                <input type="range" id="delta-min" class="range-slider" min="0.05" max="0.95" step="0.01" value="0.15">
                <span id="delta-min-value" class="text-sm w-12">0.15</span>
                <span class="text-sm">até</span>
                <input type="range" id="delta-max" class="range-slider" min="0.05" max="0.95" step="0.01" value="0.7">
                <span id="delta-max-value" class="text-sm w-12">0.7</span>
              </div>
            </div>

            <!-- Distância do ATM -->
            <div class="mb-6">
              <label class="block text-sm font-medium mb-2">Distância do ATM (Entre 5% e 10%)</label>
              <div class="flex items-center space-x-4">
                <input type="range" id="atm-min" class="range-slider" min="1" max="20" step="1" value="5">
                <span id="atm-min-value" class="text-sm w-12">5%</span>
                <span class="text-sm">até</span>
                <input type="range" id="atm-max" class="range-slider" min="1" max="20" step="1" value="10">
                <span id="atm-max-value" class="text-sm w-12">10%</span>
              </div>
            </div>

            <!-- Lucro Mínimo -->
            <div class="mb-6">
              <label class="block text-sm font-medium mb-2">Lucro Mínimo Esperado (%)</label>
              <div class="flex items-center space-x-4">
                <input type="range" id="lucro-min" class="range-slider" min="0" max="10" step="0.1" value="0">
                <span id="lucro-min-value" class="text-sm w-12">0%</span>
              </div>
            </div>

            <!-- Vencimentos -->
            <div class="mb-6">
              <label class="block text-sm font-medium mb-4">Vencimentos</label>
              <div class="flex items-center space-x-4 mb-4">
                <label class="toggle-switch">
                  <input type="checkbox" id="vencimentos-mensais" checked>
                  <span class="toggle-slider"></span>
                </label>
                <span class="text-sm">Mensais</span>
                
                <label class="toggle-switch ml-6">
                  <input type="checkbox" id="vencimentos-semanais">
                  <span class="toggle-slider"></span>
                </label>
                <span class="text-sm">Semanais</span>
              </div>
              
              <div class="grid grid-cols-6 gap-2" id="vencimentos-grid">
                <!-- Vencimentos checkboxes will be populated here -->
              </div>
            </div>
          </div>
        `;
        
        // Add event listeners for range sliders
        setupRangeSliders();
        populateVencimentos();
      } else if (type === 'box_tres_pontas') {
        container.innerHTML = `
          <!-- Parâmetros Gerais Box 3 Pontas -->
          <div class="filter-section">
            <h4 class="text-lg font-semibold mb-4">Parâmetros Gerais</h4>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium mb-2">Volume Mínimo</label>
                <input type="number" id="volume-min-box" value="100" min="0" max="10000" step="10" 
                       class="w-full p-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Custo Operacional (%)</label>
                <input type="number" id="custo-operacional" value="0.3" min="0" max="5" step="0.1" 
                       class="w-full p-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Spread CDI Mínimo (%)</label>
                <input type="number" id="spread-cdi-min" value="0.5" min="0" max="10" step="0.1" 
                       class="w-full p-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white">
              </div>
            </div>
          </div>

          <!-- Filtros Avançados Box 3 Pontas -->
          <div class="filter-section">
            <h4 class="text-lg font-semibold mb-4">Filtros Avançados</h4>
            
            <!-- TIA Mínima -->
            <div class="mb-6">
              <label class="block text-sm font-medium mb-2">TIA Mínima (%)</label>
              <div class="flex items-center space-x-4">
                <input type="range" id="tia-min" class="range-slider" min="0" max="20" step="0.1" value="0">
                <span id="tia-min-value" class="text-sm w-12">0%</span>
              </div>
            </div>
            
            <!-- Informações sobre Box 3 Pontas -->
            <div class="bg-blue-500 bg-opacity-10 border border-blue-500 border-opacity-30 rounded-lg p-4">
              <h5 class="font-semibold text-blue-400 mb-2">
                <i class="fas fa-info-circle mr-2"></i>
                Como funciona o Box de 3 Pontas
              </h5>
              <ul class="text-sm text-gray-300 space-y-1">
                <li>• <strong>Operação:</strong> Compra do ativo + Venda de call + Compra de put (mesmo strike)</li>
                <li>• <strong>Resultado:</strong> Renda fixa sintética que paga o valor do strike no vencimento</li>
                <li>• <strong>Risco:</strong> Baixo - resultado conhecido antecipadamente</li>
                <li>• <strong>Retorno:</strong> TIA (Taxa Implícita Anualizada) calculada</li>
              </ul>
            </div>
          </div>
        `;
        
        // Setup range slider para TIA
        const tiaSlider = document.getElementById('tia-min');
        const tiaValue = document.getElementById('tia-min-value');
        if (tiaSlider && tiaValue) {
          tiaSlider.addEventListener('input', function() {
            tiaValue.textContent = this.value + '%';
          });
        }
      } else {
        // Para outros tipos de screening, mostrar mensagem de desenvolvimento
        container.innerHTML = `
          <div class="filter-section">
            <div class="text-center py-8">
              <i class="fas fa-tools text-4xl text-orange-400 mb-4"></i>
              <h4 class="text-lg font-semibold text-orange-400 mb-2">Em Desenvolvimento</h4>
              <p class="text-gray-400">Os filtros para este tipo de screening estão sendo desenvolvidos.</p>
            </div>
          </div>
        `;
      }
    }

    // Setup Range Sliders
    function setupRangeSliders() {
      const sliders = [
        { id: 'delta-min', valueId: 'delta-min-value', suffix: '' },
        { id: 'delta-max', valueId: 'delta-max-value', suffix: '' },
        { id: 'atm-min', valueId: 'atm-min-value', suffix: '%' },
        { id: 'atm-max', valueId: 'atm-max-value', suffix: '%' },
        { id: 'lucro-min', valueId: 'lucro-min-value', suffix: '%' }
      ];

      sliders.forEach(slider => {
        const element = document.getElementById(slider.id);
        const valueElement = document.getElementById(slider.valueId);
        
        if (element && valueElement) {
          element.addEventListener('input', function() {
            valueElement.textContent = this.value + slider.suffix;
          });
        }
      });
    }

    // Populate Vencimentos
    function populateVencimentos() {
      const grid = document.getElementById('vencimentos-grid');
      if (!grid) return;
      
      const vencimentos = ['1º', '2º', '3º', '4º', '5º', '6º', '7º', '8º', '9º', '10º', '11º', '12º'];
      const weeklies = ['1º W1', '1º W2', '1º W3', '1º W4', '1º W5', '2º W1', '2º W2', '2º W3', '2º W4', '2º W5'];
      
      // Monthly options
      vencimentos.forEach(venc => {
        const checkbox = document.createElement('label');
        checkbox.className = 'flex items-center space-x-1 cursor-pointer';
        checkbox.innerHTML = `
          <input type="checkbox" class="vencimento-checkbox" value="${venc}" checked>
          <span class="text-sm">${venc}</span>
        `;
        grid.appendChild(checkbox);
      });
      
      // Weekly options (initially hidden)
      weeklies.forEach(venc => {
        const checkbox = document.createElement('label');
        checkbox.className = 'flex items-center space-x-1 cursor-pointer weekly-vencimento';
        checkbox.style.display = 'none';
        checkbox.innerHTML = `
          <input type="checkbox" class="vencimento-checkbox" value="${venc}">
          <span class="text-sm">${venc}</span>
        `;
        grid.appendChild(checkbox);
      });

      // Toggle weekly vencimentos
      const semanaisToggle = document.getElementById('vencimentos-semanais');
      if (semanaisToggle) {
        semanaisToggle.addEventListener('change', function() {
          const weeklyElements = document.querySelectorAll('.weekly-vencimento');
          weeklyElements.forEach(el => {
            el.style.display = this.checked ? 'flex' : 'none';
          });
        });
      }
    }

    // Render List Options
    function renderListOptions() {
      const select = document.getElementById('lista-predefinida');
      select.innerHTML = '<option value="">Selecione uma lista...</option>';
      
      Object.entries(availableLists).forEach(([key, list]) => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = `${key.toUpperCase()} (${list.length} ativos)`;
        select.appendChild(option);
      });
    }

    // Asset Selection Toggle
    document.addEventListener('change', function(e) {
      if (e.target.name === 'asset-selection') {
        const listaDiv = document.getElementById('lista-selection');
        const manualDiv = document.getElementById('manual-selection');
        
        if (e.target.value === 'lista') {
          listaDiv.style.display = 'block';
          manualDiv.style.display = 'none';
        } else {
          listaDiv.style.display = 'none';
          manualDiv.style.display = 'block';
        }
      }
    });

    // Execute Screening
    executeBtn.addEventListener('click', async function() {
      if (!currentScreeningType) {
        showStatus('Selecione um tipo de screening primeiro', 'error');
        return;
      }

      // Verificar se o endpoint está disponível
      const endpoint = API_ENDPOINTS[currentScreeningType];
      if (!endpoint) {
        showStatus('Endpoint não configurado para este tipo de screening', 'error');
        return;
      }

      const payload = buildPayload();
      if (!payload) return;

      setLoading(executeBtn, true);
      resultsPanel.style.display = 'none';
      
      // Get total assets for progress
      const totalAssets = payload.simbolos ? payload.simbolos.length : 
                         (payload.lista_predefinida ? availableLists[payload.lista_predefinida].length : 0);
      
      showProgress(totalAssets);
      showStatus('Executando screening... Acompanhe o progresso abaixo', 'info');

      try {
        // Simulate progress updates (since we can't get real-time updates from backend)
        const progressInterval = setInterval(() => {
          // This is just visual feedback - real progress comes from backend logs
          const currentProgress = parseInt(progressText.textContent.split('/')[0]);
          if (currentProgress < totalAssets) {
            // Don't update here - let the backend logs handle it
          }
        }, 1000);

        const response = await fetch(`${endpoint}/screening`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        const data = await response.json();
        clearInterval(progressInterval);

        if (data.success) {
          // Update final progress
          completeProgress(data.total_oportunidades);
          
          // Update final stats
          updateProgressStats(
            data.ativos_processados || data.total_ativos_analisados,
            data.total_oportunidades,
            data.ativos_com_erro || 0
          );
          
          // Show results
          setTimeout(() => {
            displayResults(data);
            showStatus(`Screening concluído! ${data.total_oportunidades} oportunidades encontradas`, 'success');
          }, 2000);
        } else {
          hideProgress();
          showStatus(data.error || 'Erro no screening', 'error');
        }
      } catch (error) {
        hideProgress();
        showStatus('Erro ao executar screening', 'error');
        console.error(error);
      }

      setLoading(executeBtn, false);
    });

    // Build Payload
    function buildPayload() {
      const assetSelection = document.querySelector('input[name="asset-selection"]:checked').value;
      const payload = {};

      // Asset selection
      if (assetSelection === 'lista') {
        const lista = document.getElementById('lista-predefinida').value;
        if (!lista) {
          showStatus('Selecione uma lista predefinida', 'error');
          return null;
        }
        payload.lista_predefinida = lista;
      } else {
        const simbolos = document.getElementById('simbolos-manual').value.trim();
        if (!simbolos) {
          showStatus('Digite os símbolos dos ativos', 'error');
          return null;
        }
        payload.simbolos = simbolos.split(',').map(s => s.trim().toUpperCase());
      }

      // Specific filters for arbitragem_puts
      if (currentScreeningType === 'arbitragem_puts') {
        const taxaCdi = document.getElementById('taxa-cdi');
        const volumeMin = document.getElementById('volume-min');
        const rentabilidadeMin = document.getElementById('rentabilidade-min');
        
        if (taxaCdi && volumeMin && rentabilidadeMin) {
          payload.taxa_cdi_mensal = parseFloat(taxaCdi.value);
          payload.volume_min = parseInt(volumeMin.value);
          payload.rentabilidade_min = parseFloat(rentabilidadeMin.value);
          
          // Advanced filters
          const deltaMin = document.getElementById('delta-min');
          const deltaMax = document.getElementById('delta-max');
          const atmMin = document.getElementById('atm-min');
          const atmMax = document.getElementById('atm-max');
          const lucroMin = document.getElementById('lucro-min');
          
          if (deltaMin && deltaMax && atmMin && atmMax && lucroMin) {
            payload.filtros = {
              delta_min: parseFloat(deltaMin.value),
              delta_max: parseFloat(deltaMax.value),
              atm_min: parseInt(atmMin.value),
              atm_max: parseInt(atmMax.value),
              lucro_min: parseFloat(lucroMin.value)
            };

            // Vencimentos selecionados
            const vencimentosSelecionados = [];
            document.querySelectorAll('.vencimento-checkbox:checked').forEach(checkbox => {
              vencimentosSelecionados.push(checkbox.value);
            });
            payload.filtros.vencimentos = vencimentosSelecionados;
          }
        }
      } else if (currentScreeningType === 'box_tres_pontas') {
        // Filtros específicos para Box de 3 Pontas
        const volumeMinBox = document.getElementById('volume-min-box');
        const custoOperacional = document.getElementById('custo-operacional');
        const spreadCdiMin = document.getElementById('spread-cdi-min');
        const tiaMin = document.getElementById('tia-min');
        
        if (volumeMinBox && custoOperacional && spreadCdiMin && tiaMin) {
          payload.volume_min = parseInt(volumeMinBox.value);
          payload.custo_operacional = parseFloat(custoOperacional.value) / 100; // Converter para decimal
          payload.min_spread_cdi = parseFloat(spreadCdiMin.value);
          payload.tia_min = parseFloat(tiaMin.value);
        }
      }

      return payload;
    }

    // Display Results
    function displayResults(data) {
      resultsPanel.style.display = 'block';
      
      // Display summary
      displaySummary(data);
      
      // Display results table
      displayResultsTable(data);
      
      // Scroll to results
      resultsPanel.scrollIntoView({ behavior: 'smooth' });
    }

    // Display Summary
    function displaySummary(data) {
      const container = document.getElementById('results-summary');
      
      // Campos específicos por tipo de screening
      let extraInfo = '';
      if (currentScreeningType === 'arbitragem_puts') {
        extraInfo = `
          <div class="bg-white bg-opacity-5 p-4 rounded-lg text-center">
            <div class="text-2xl font-bold text-orange-400">${data.parametros?.taxa_cdi_mensal || '1.0'}%</div>
            <div class="text-sm text-gray-400">Taxa CDI Mensal</div>
          </div>
        `;
      } else if (currentScreeningType === 'box_tres_pontas') {
        extraInfo = `
          <div class="bg-white bg-opacity-5 p-4 rounded-lg text-center">
            <div class="text-2xl font-bold text-orange-400">${data.parametros?.taxa_cdi || '11.46'}%</div>
            <div class="text-sm text-gray-400">Taxa CDI Anual</div>
          </div>
        `;
      }
      
      container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="bg-white bg-opacity-5 p-4 rounded-lg text-center">
            <div class="text-2xl font-bold text-blue-400">${data.total_ativos_analisados}</div>
            <div class="text-sm text-gray-400">Ativos Analisados</div>
          </div>
          <div class="bg-white bg-opacity-5 p-4 rounded-lg text-center">
            <div class="text-2xl font-bold text-green-400">${data.total_oportunidades}</div>
            <div class="text-sm text-gray-400">Oportunidades Encontradas</div>
          </div>
          <div class="bg-white bg-opacity-5 p-4 rounded-lg text-center">
            <div class="text-2xl font-bold text-purple-400">${Object.keys(data.resultados_por_ativo || {}).length}</div>
            <div class="text-sm text-gray-400">Ativos com Oportunidades</div>
          </div>
          ${extraInfo}
        </div>
      `;
    }

    // AQUI ESTÁ A FUNÇÃO MODIFICADA - Display Results Table
    function displayResultsTable(data) {
      const container = document.getElementById('results-table-container');
      
      if (data.total_oportunidades === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-400">Nenhuma oportunidade encontrada</h3>
            <p class="text-gray-500">Tente ajustar os filtros para encontrar mais oportunidades</p>
          </div>
        `;
        return;
      }

      // MUDANÇA PRINCIPAL: Buscar TODOS os resultados, não apenas o top 10
      let allResults = [];
      
      // Se tiver ranking_top10, use ele primeiro
      if (data.ranking_top10) {
        allResults = [...data.ranking_top10];
      }
      
      // Se tiver resultados_por_ativo, extrair todas as oportunidades
      if (data.resultados_por_ativo) {
        Object.entries(data.resultados_por_ativo).forEach(([simbolo, ativoData]) => {
          if (ativoData.oportunidades && ativoData.oportunidades.length > 0) {
            ativoData.oportunidades.forEach(oportunidade => {
              // Verificar se já não está no ranking_top10
              const jaExiste = allResults.some(item => 
                item.simbolo === simbolo && 
                item.symbol === oportunidade.symbol
              );
              
              if (!jaExiste) {
                // Adicionar estrutura compatível com o ranking
                allResults.push({
                  simbolo: simbolo,
                  symbol: oportunidade.symbol,
                  strike: oportunidade.strike,
                  due_date_formatted: oportunidade.due_date_formatted || oportunidade.vencimento,
                  ask: oportunidade.ask || oportunidade.preco_ask,
                  volume: oportunidade.volume || 0,
                  lucro_pct_bruto: oportunidade.lucro_pct_bruto || oportunidade.lucro_bruto_pct,
                  lucro_pct_liquido: oportunidade.lucro_pct_liquido || oportunidade.lucro_liquido_pct,
                  vantagem_mensal_vs_cdi: oportunidade.vantagem_mensal_vs_cdi || oportunidade.vantagem_vs_cdi,
                  vale_pena: oportunidade.vale_pena
                });
              }
            });
          }
        });
      }
      
      // Se ainda não tiver dados, tentar outras estruturas possíveis
      if (allResults.length === 0 && data.oportunidades) {
        allResults = data.oportunidades;
      }
      
      // Ordenar por melhor vantagem vs CDI (decrescente)
      allResults.sort((a, b) => {
        const vantA = a.vantagem_mensal_vs_cdi || 0;
        const vantB = b.vantagem_mensal_vs_cdi || 0;
        return vantB - vantA;
      });

      // Criar cabeçalho da tabela com informação de total
      let tableHTML = `
        <div class="mb-4 flex justify-between items-center">
          <h4 class="text-lg font-semibold">
            <i class="fas fa-list mr-2 text-green-400"></i>
            Todas as Oportunidades (${allResults.length} encontradas)
          </h4>
          <div class="text-sm text-gray-400">
            Ordenado por melhor ${currentScreeningType === 'box_tres_pontas' ? 'TIA líquida' : 'vantagem vs CDI'}
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Ativo</th>
              <th>Opção</th>
              <th>Strike</th>
              <th>Vencimento</th>
              <th>Preço Ask</th>
              <th>Volume</th>
              ${currentScreeningType === 'box_tres_pontas' ? 
                '<th>TIA Líquida</th><th>Spread CDI</th>' : 
                '<th>Lucro Bruto</th><th>Lucro Líquido</th><th>Vantagem vs CDI</th>'
              }
              <th>Vale a Pena?</th>
            </tr>
          </thead>
          <tbody>
      `;

      // Renderizar TODAS as oportunidades
      allResults.forEach((item, index) => {
        const valePena = item.vale_pena ? 'SIM' : 'NÃO';
        const valePenaClass = item.vale_pena ? 'profit-positive' : 'profit-negative';
        
        // Destacar top 10 com badge
        const isTop10 = index < 10;
        const rankBadge = isTop10 ? 
          `<span class="font-bold text-purple-400">#${index + 1}</span>` : 
          `<span class="text-gray-400">#${index + 1}</span>`;
        
        // Colunas específicas por tipo de screening
        let specificColumns = '';
        if (currentScreeningType === 'box_tres_pontas') {
          specificColumns = `
            <td class="${(item.tia_liquida_pct || 0) > 0 ? 'profit-positive' : 'profit-negative'}">${formatPercent(item.tia_liquida_pct || 0)}</td>
            <td class="${(item.spread_cdi || 0) > 0 ? 'profit-positive' : 'profit-negative'}">${formatPercent(item.spread_cdi || 0)}</td>
          `;
        } else {
          specificColumns = `
            <td class="${(item.lucro_pct_bruto || 0) > 0 ? 'profit-positive' : 'profit-negative'}">${formatPercent(item.lucro_pct_bruto || 0)}</td>
            <td class="${(item.lucro_pct_liquido || 0) > 0 ? 'profit-positive' : 'profit-negative'}">${formatPercent(item.lucro_pct_liquido || 0)}</td>
            <td class="${(item.vantagem_mensal_vs_cdi || 0) > 0 ? 'profit-positive' : 'profit-negative'}">${formatPercent(item.vantagem_mensal_vs_cdi || 0)}</td>
          `;
        }
        
        tableHTML += `
          <tr ${isTop10 ? 'class="bg-purple-500 bg-opacity-10"' : ''}>
            <td>${rankBadge}</td>
            <td class="font-semibold">${item.simbolo}</td>
            <td class="font-medium text-blue-400">${item.symbol || item.call_symbol || item.put_symbol || '-'}</td>
            <td>${formatCurrency(item.strike)}</td>
            <td>${item.due_date_formatted || item.vencimento_formatado || '-'}</td>
            <td>${formatCurrency(item.ask || item.call_bid || item.put_ask || 0)}</td>
            <td>${(item.volume || item.volume_call || item.volume_put || 0).toLocaleString()}</td>
            ${specificColumns}
            <td class="${valePenaClass}">${valePena}</td>
          </tr>
        `;
      });

      tableHTML += `
          </tbody>
        </table>
      `;

      container.innerHTML = tableHTML;
    }

    // Export CSV
    document.getElementById('export-csv').addEventListener('click', function() {
      showStatus('Funcionalidade de exportação em desenvolvimento', 'info');
    });

    // Save Config
    document.getElementById('save-config').addEventListener('click', function() {
      showStatus('Funcionalidade de salvar configuração em desenvolvimento', 'info');
    });

    // Health Check
    async function checkHealth() {
      try {
        const response = await fetch(API_ENDPOINTS.health);
        const data = await response.json();
        
        if (data.status === 'OK') {
          console.log('✅ Serviço de Screening funcionando:', data.message);
        } else {
          console.warn('⚠️ Serviço com problemas:', data.message);
        }
      } catch (error) {
        console.error('❌ Erro ao verificar saúde do serviço:', error);
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      checkHealth();
      loadInitialData();
      showStatus('Screening de Opções carregado! Selecione um tipo de screening para começar.', 'info');
    });
  </script>
</body>
</html>