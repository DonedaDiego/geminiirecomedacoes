<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recomenda√ß√µes Free - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            secondary: '#8b5cf6',
            accent: '#06b6d4',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            geminii: '#ba39af'
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #0f0f0f;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .navbar {
      background: rgba(15, 15, 15, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .recommendation-card {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.05));
      border: 1px solid rgba(99, 102, 241, 0.2);
      backdrop-filter: blur(20px);
      transition: all 0.3s ease;
    }
    
    .recommendation-card:hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.08));
      border-color: rgba(99, 102, 241, 0.3);
      transform: translateY(-2px);
    }
    
    .buy-signal {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
      border-color: rgba(16, 185, 129, 0.3);
    }
    
    .sell-signal {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
      border-color: rgba(239, 68, 68, 0.3);
    }
    
    .pulse-glow {
      animation: pulseGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes pulseGlow {
      from { box-shadow: 0 0 20px rgba(186, 57, 175, 0.3); }
      to { box-shadow: 0 0 30px rgba(186, 57, 175, 0.6); }
    }
    
    .loading-skeleton {
      background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%);
      background-size: 400% 100%;
      animation: skeleton-loading 1.4s ease-in-out infinite;
    }

    @keyframes skeleton-loading {
      0% { background-position: 100% 50%; }
      100% { background-position: 0 50%; }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-ativa {
      background-color: rgba(16, 185, 129, 0.2);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-ganho {
      background-color: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .status-perda {
      background-color: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .error-card {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05));
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .retry-btn {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      transition: all 0.3s ease;
    }

    .retry-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
    }

    /* üî• NOVOS ESTILOS PARA UPDATE INDICATOR */
    .update-indicator {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .price-updated {
      position: relative;
    }

    .price-updated::after {
      content: '';
      position: absolute;
      top: -2px;
      right: -2px;
      width: 6px;
      height: 6px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
  </style>
</head>
<body class="min-h-screen text-white">
  
  <!-- Navigation -->
  <nav class="navbar fixed top-0 left-0 right-0 z-50 px-6 py-4">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center space-x-8">
        <div class="flex items-center space-x-3">
          <img src="assets/logo.png" alt="Geminii Logo" class="w-8 h-8 rounded-lg">
          <span class="text-xl font-bold text-white">Geminii</span>
        </div>
        <div class="hidden md:flex items-center space-x-6">
          <a href="dashboard.html" class="text-gray-300 hover:text-primary transition-colors">Dashboard</a>
          <a href="recomendacoes-free.html" class="text-primary font-medium">Recomenda√ß√µes Free</a>
        </div>
      </div>
      
      <div class="flex items-center space-x-4">
        <div id="connectionStatus" class="flex items-center space-x-2">
          <div class="w-2 h-2 bg-success rounded-full animate-pulse"></div>
          <span class="text-sm text-gray-300">Online</span>
        </div>
        <!-- üî• BOT√ÉO DE ATUALIZA√á√ÉO MANUAL -->
        <button onclick="refreshRecommendations()" class="bg-primary hover:bg-primary/80 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
          <i class="fas fa-sync mr-2"></i>Atualizar
        </button>
        <button onclick="logout()" class="bg-red-50 hover:bg-red-100 text-red-600 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
          Sair
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="pt-24 px-6 pb-12">
    <div class="max-w-7xl mx-auto">
      
      <!-- Header -->
      <div class="card rounded-2xl p-8 mb-8 fade-in">
        <div class="flex flex-col lg:flex-row items-center justify-between gap-6">
          <div>
            <h1 class="text-3xl font-bold text-white mb-2">
              <i class="fas fa-brain text-geminii mr-3"></i>
              Recomenda√ß√µes Free Mensais
            </h1>
            <p class="text-gray-300">
              An√°lises geradas por Machine Learning com dados reais do mercado
            </p>
          </div>
          <div class="flex items-center gap-4">
            <div class="text-center">
              <div class="text-sm text-gray-400">√öltima Atualiza√ß√£o</div>
              <div id="lastUpdate" class="text-lg font-semibold text-white">--</div>
            </div>
            <div class="text-center">
              <div class="text-sm text-gray-400">Pr√≥xima em</div>
              <div id="nextUpdate" class="text-lg font-semibold text-accent">--</div>
            </div>
            <!-- üî• INDICADOR DE AUTO-UPDATE -->
            <div class="text-center">
              <div class="text-sm text-gray-400">Auto-Update</div>
              <div id="autoUpdateStatus" class="text-sm font-semibold text-success">
                <i class="fas fa-play mr-1"></i>Ativo
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="card rounded-xl p-6 fade-in">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-white" id="totalRecommendations">0</div>
              <div class="text-sm text-gray-400">Recomenda√ß√µes Ativas</div>
            </div>
            <div class="w-12 h-12 bg-primary/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-chart-line text-primary"></i>
            </div>
          </div>
        </div>
        
        <div class="card rounded-xl p-6 fade-in">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-success" id="buySignals">0</div>
              <div class="text-sm text-gray-400">Sinais de Compra</div>
            </div>
            <div class="w-12 h-12 bg-success/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-arrow-up text-success"></i>
            </div>
          </div>
        </div>
        
        <div class="card rounded-xl p-6 fade-in">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-danger" id="sellSignals">0</div>
              <div class="text-sm text-gray-400">Sinais de Venda</div>
            </div>
            <div class="w-12 h-12 bg-danger/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-arrow-down text-danger"></i>
            </div>
          </div>
        </div>
        
        <div class="card rounded-xl p-6 fade-in">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-warning" id="successRate">--</div>
              <div class="text-sm text-gray-400">Taxa de Acerto</div>
            </div>
            <div class="w-12 h-12 bg-warning/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-percentage text-warning"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Active Recommendations -->
      <div class="mb-8">
        <h2 class="text-2xl font-bold text-white mb-6">
          <i class="fas fa-robot mr-2 text-geminii"></i>
          Recomenda√ß√µes Ativas
          <!-- üî• INDICADOR DE PERFORMANCE EM TEMPO REAL -->
          <span class="text-sm text-gray-400 ml-2">
            <i class="fas fa-wifi text-success"></i> Performance em tempo real
          </span>
        </h2>
        
        <div id="recommendationsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Loading skeleton -->
          <div class="recommendation-card rounded-xl p-6 loading-skeleton h-96"></div>
          <div class="recommendation-card rounded-xl p-6 loading-skeleton h-96"></div>
        </div>
      </div>

      <!-- Historical Performance -->
      <div class="card rounded-2xl p-8">
        <h2 class="text-2xl font-bold text-white mb-6">
          <i class="fas fa-history mr-2 text-primary"></i>
          Hist√≥rico de Performance
        </h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="col-span-2">
            <canvas id="performanceChart" height="300"></canvas>
          </div>
          <div class="space-y-4">
            <div class="bg-white/5 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-white mb-3">Estat√≠sticas do M√™s</h3>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-gray-400">Recomenda√ß√µes Fechadas:</span>
                  <span class="text-white font-medium" id="closedRecommendations">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Ganho M√©dio:</span>
                  <span class="text-success font-medium" id="avgGain">+0%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Perda M√©dia:</span>
                  <span class="text-danger font-medium" id="avgLoss">-0%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Retorno Acumulado:</span>
                  <span class="text-white font-medium" id="cumulativeReturn">+0%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Profit Factor:</span>
                  <span class="text-white font-medium" id="profitFactor">0.0</span>
                </div>
              </div>
            </div>
            
            <div class="bg-white/5 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-white mb-3">Melhor Performance</h3>
              <div id="bestPerformance" class="text-center py-4">
                <div class="text-2xl font-bold text-success">--</div>
                <div class="text-sm text-gray-400">Aguardando dados</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal para Detalhes -->
  <div id="detailsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-gray-900 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-800">
          <div class="flex items-center justify-between">
            <h3 class="text-2xl font-bold text-white">Detalhes da Recomenda√ß√£o</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
        </div>
        <div id="modalContent" class="p-6">
          <!-- Content will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== VARI√ÅVEIS GLOBAIS =====
    let recommendations = [];
    let allRecommendations = [];
    let performanceChart = null;
    let userToken = null;
    let currentUser = null;
    let retryCount = 0;
    const MAX_RETRIES = 3;

    // üî• NOVAS VARI√ÅVEIS PARA AUTO-UPDATE
    let autoUpdateInterval = null;
    let lastUpdateTime = null;
    const UPDATE_INTERVAL = 5 * 60 * 1000; // 5 minutos

    // ===== INICIALIZA√á√ÉO =====
    async function init() {
      console.log('üöÄ Inicializando Recomenda√ß√µes Free...');
      
      userToken = localStorage.getItem('geminii_token');
      if (!userToken) {
        console.log(' Token n√£o encontrado - redirecionando para login');
        window.location.href = '/login.html';
        return;
      }

      console.log(' Token encontrado');
      
      try {
        await verifyAuthWithRetry();
        await loadRecommendationsWithRetry();
        initPerformanceChart();
        updateTimers();
        
        // üî• INICIAR AUTO-UPDATE
        startAutoUpdate();
        
        setInterval(updateTimers, 60000);
        setInterval(checkConnection, 30000);
        
        console.log(' Inicializa√ß√£o conclu√≠da com sucesso!');
      } catch (error) {
        console.error(' Erro na inicializa√ß√£o:', error);
        showGlobalError('Erro na inicializa√ß√£o. Tentando novamente...');
        setTimeout(() => window.location.reload(), 3000);
      }
    }

    // ===== VERIFICAR AUTENTICA√á√ÉO =====
    async function verifyAuthWithRetry(attempt = 1) {
      try {
        console.log(`üîç Verificando autentica√ß√£o (tentativa ${attempt})...`);
        
        const response = await fetch('/auth/verify', {
          headers: { 
            'Authorization': `Bearer ${userToken}`,
            'Content-Type': 'application/json'
          },
          cache: 'no-cache'
        });

        console.log('üì° Status da verifica√ß√£o:', response.status);

        if (response.status === 401 || response.status === 403) {
          throw new Error('Token inv√°lido ou expirado');
        }

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const result = await response.json();
        if (!result.success) {
          throw new Error('Verifica√ß√£o falhou: ' + (result.error || 'Erro desconhecido'));
        }

        currentUser = result.data.user;
        console.log(' Usu√°rio autenticado:', currentUser.name);
        updateConnectionStatus(true);
        
        return result;
      } catch (error) {
        console.error(` Erro na verifica√ß√£o (tentativa ${attempt}):`, error);
        updateConnectionStatus(false);
        
        if (error.message.includes('Token inv√°lido') || error.message.includes('expirado')) {
          console.log('üö™ Token inv√°lido - fazendo logout...');
          logout();
          return;
        }
        
        if (attempt < MAX_RETRIES) {
          console.log(`üîÑ Tentando novamente em 2 segundos...`);
          await new Promise(resolve => setTimeout(resolve, 2000));
          return verifyAuthWithRetry(attempt + 1);
        }
        
        throw error;
      }
    }

    // üî• FUN√á√ÉO DE ATUALIZA√á√ÉO DE PRE√áOS (NOVA)
    async function updateCurrentPrices() {
      console.log('üí∞ Atualizando pre√ßos atuais...');
      
      try {
        const response = await fetch('/api/recommendations/free/update-prices', {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${userToken}`,
            'Content-Type': 'application/json'
          },
          cache: 'no-cache'
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success) {
          console.log(' Pre√ßos atualizados:', result.message);
          
          // Atualizar dados locais
          if (result.recommendations) {
            recommendations = result.recommendations.filter(r => r.status === 'ATIVA');
            allRecommendations = result.recommendations;
            
            // Atualizar UI
            displayRecommendations();
            updateStats();
            updatePerformanceChart();
            
            lastUpdateTime = new Date();
            updateLastUpdateDisplay();
            
            // Mostrar feedback visual sutil (apenas em auto-update)
            if (!event || !event.target) {
              showPriceUpdateFeedback();
            }
          }
          
          return result;
        } else {
          throw new Error(result.error);
        }
        
      } catch (error) {
        console.error(' Erro ao atualizar pre√ßos:', error);
        return { success: false, error: error.message };
      }
    }

    // üî• FUN√á√ÉO PARA INICIAR AUTO-UPDATE
    function startAutoUpdate() {
      if (autoUpdateInterval) {
        clearInterval(autoUpdateInterval);
      }
      
      console.log(`üîÑ Iniciando auto-update a cada ${UPDATE_INTERVAL / 1000 / 60} minutos`);
      
      autoUpdateInterval = setInterval(async () => {
        console.log('‚è∞ Auto-update disparado');
        await updateCurrentPrices();
      }, UPDATE_INTERVAL);

      // Atualizar status visual
      updateAutoUpdateStatus(true);
    }

    // üî• FUN√á√ÉO PARA PARAR AUTO-UPDATE
    function stopAutoUpdate() {
      if (autoUpdateInterval) {
        clearInterval(autoUpdateInterval);
        autoUpdateInterval = null;
        console.log('‚èπÔ∏è Auto-update parado');
        updateAutoUpdateStatus(false);
      }
    }

    // üî• ATUALIZAR STATUS DO AUTO-UPDATE
    function updateAutoUpdateStatus(isActive) {
      const statusEl = document.getElementById('autoUpdateStatus');
      if (statusEl) {
        if (isActive) {
          statusEl.innerHTML = '<i class="fas fa-play mr-1"></i>Ativo';
          statusEl.className = 'text-sm font-semibold text-success';
        } else {
          statusEl.innerHTML = '<i class="fas fa-pause mr-1"></i>Pausado';
          statusEl.className = 'text-sm font-semibold text-warning';
        }
      }
    }

    // ===== CARREGAR RECOMENDA√á√ïES COM AUTO-UPDATE =====
    async function loadRecommendationsWithRetry(attempt = 1) {
      console.log(`üì° Carregando recomenda√ß√µes (tentativa ${attempt})...`);
      
      try {
        // üî• USAR ENDPOINT CORRETO COM AUTO-UPDATE
        const response = await fetch('/api/recommendations/free/all', {
          headers: { 
            'Authorization': `Bearer ${userToken}`,
            'Content-Type': 'application/json'
          },
          cache: 'no-cache'
        });

        console.log(' Status da resposta:', response.status, response.statusText);

        if (response.status === 401) {
          console.log('üîë Token expirado - tentando renovar...');
          await verifyAuthWithRetry();
          if (attempt < MAX_RETRIES) {
            return loadRecommendationsWithRetry(attempt + 1);
          }
        }

        if (!response.ok) {
          throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        console.log('üìÑ Resultado da API recebido');
        
        if (result.success) {
          allRecommendations = result.recommendations || [];
          console.log(` Total de recomenda√ß√µes: ${allRecommendations.length}`);
          
          recommendations = allRecommendations.filter(r => r.status === 'ATIVA');
          console.log(` Recomenda√ß√µes ativas: ${recommendations.length}`);
          
          displayRecommendations();
          updateStats();
          updatePerformanceChart();
          updateConnectionStatus(true);
          
          lastUpdateTime = new Date();
          updateLastUpdateDisplay();
          
          return result;
        } else {
          throw new Error(result.error || 'Erro desconhecido da API');
        }
      } catch (error) {
        console.error(` Erro ao carregar recomenda√ß√µes (tentativa ${attempt}):`, error);
        updateConnectionStatus(false);
        
        if (attempt < MAX_RETRIES) {
          console.log(`üîÑ Tentando novamente em 3 segundos...`);
          await new Promise(resolve => setTimeout(resolve, 3000));
          return loadRecommendationsWithRetry(attempt + 1);
        }
        
        showError(error.message || 'Erro de conex√£o. Verifique sua internet e tente novamente.');
        throw error;
      }
    }

    // ===== REFRESH MANUAL COMPLETO =====
    async function refreshRecommendations() {
      const btn = event.target.closest('button');
      const originalText = btn.innerHTML;
      
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Atualizando...';
      
      try {
        retryCount = 0;
        
        // üî• USAR ENDPOINT DE REFRESH COMPLETO
        console.log('üîÑ Refresh completo...');
        const response = await fetch('/api/recommendations/free/refresh', {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${userToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          // Atualizar dados
          allRecommendations = result.recommendations || [];
          recommendations = allRecommendations.filter(r => r.status === 'ATIVA');
          
          // Atualizar UI
          displayRecommendations();
          updateStats();
          updatePerformanceChart();
          
          lastUpdateTime = new Date();
          updateLastUpdateDisplay();
          
          // Show success feedback
          btn.innerHTML = '<i class="fas fa-check mr-2"></i>Atualizado!';
          
          if (result.price_update_success) {
            showToast(' Pre√ßos e dados atualizados com sucesso!', 'success');
          } else {
            showToast('‚ö†Ô∏è Dados recarregados, mas alguns pre√ßos podem estar desatualizados', 'warning');
          }
        } else {
          throw new Error(result.error);
        }
        
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 2000);
        
      } catch (error) {
        console.error('Erro ao atualizar:', error);
        btn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Erro';
        showToast(' Erro ao atualizar: ' + error.message, 'error');
        
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 3000);
      }
    }

    // ===== ATUALIZAR STATUS DA CONEX√ÉO =====
    function updateConnectionStatus(isOnline) {
      const statusEl = document.getElementById('connectionStatus');
      if (!statusEl) return;
      
      if (isOnline) {
        statusEl.innerHTML = `
          <div class="w-2 h-2 bg-success rounded-full animate-pulse"></div>
          <span class="text-sm text-gray-300">Online</span>
        `;
      } else {
        statusEl.innerHTML = `
          <div class="w-2 h-2 bg-danger rounded-full animate-pulse"></div>
          <span class="text-sm text-gray-300">Offline</span>
        `;
      }
    }

    // ===== VERIFICAR CONEX√ÉO =====
    async function checkConnection() {
      try {
        const response = await fetch('/auth/verify', {
          headers: { 'Authorization': `Bearer ${userToken}` },
          cache: 'no-cache'
        });
        updateConnectionStatus(response.ok);
      } catch (error) {
        updateConnectionStatus(false);
      }
    }

    // ===== EXIBIR RECOMENDA√á√ïES COM INDICADORES DE UPDATE =====
    function displayRecommendations() {
      const container = document.getElementById('recommendationsContainer');
      
      if (!recommendations || recommendations.length === 0) {
        container.innerHTML = `
          <div class="col-span-2 text-center py-12">
            <i class="fas fa-inbox text-6xl text-gray-600 mb-4"></i>
            <p class="text-xl text-gray-400">Nenhuma recomenda√ß√£o ativa no momento</p>
            <p class="text-sm text-gray-500 mt-2">Novas recomenda√ß√µes s√£o geradas mensalmente</p>
            <button onclick="refreshRecommendations()" class="mt-4 retry-btn text-white px-6 py-3 rounded-lg font-medium">
              <i class="fas fa-sync mr-2"></i>Tentar Novamente
            </button>
          </div>
        `;
        return;
      }

      console.log('Exibindo recomenda√ß√µes:', recommendations.length);
      container.innerHTML = recommendations.map(rec => createRecommendationCard(rec)).join('');
      
      setTimeout(loadMiniCharts, 100);
    }

    // ===== CRIAR CARD DE RECOMENDA√á√ÉO COM PERFORMANCE REAL =====
    function createRecommendationCard(rec) {
      const isCompra = rec.action === 'COMPRA';
      const cardClass = isCompra ? 'buy-signal' : 'sell-signal';
      const actionIcon = isCompra ? 'fa-arrow-trend-up' : 'fa-arrow-trend-down';
      const actionColor = isCompra ? 'text-success' : 'text-danger';
      
      // üî• USAR DADOS REAIS DO BACKEND (J√Å ATUALIZADOS)
      const currentPrice = rec.current_price || rec.entry_price;
      const performance = rec.performance || 0; // Performance j√° calculada no backend
      const potentialProfit = ((rec.target_price - rec.entry_price) / rec.entry_price * 100);
      const risk = Math.abs((rec.entry_price - rec.stop_loss) / rec.entry_price * 100);
      const riskReward = risk > 0 ? (Math.abs(potentialProfit) / risk) : 0;

      // üî• INDICADOR DE ATUALIZA√á√ÉO RECENTE
      const isRecentUpdate = lastUpdateTime && (new Date() - lastUpdateTime) < (10 * 60 * 1000); // 10 min
      const updateIndicator = isRecentUpdate ? 
        '<div class="absolute top-2 right-2 w-3 h-3 bg-green-400 rounded-full animate-pulse" title="Pre√ßos atualizados recentemente"></div>' : '';

      return `
        <div class="recommendation-card ${cardClass} rounded-xl p-6 fade-in cursor-pointer relative" onclick="showDetails('${rec.id}')">
          ${updateIndicator}
          
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-white/10 rounded-lg flex items-center justify-center">
                <i class="fas ${actionIcon} ${actionColor} text-xl"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold text-white">${rec.ticker}</h3>
                <p class="text-sm text-gray-400">${rec.company_name || 'A√ß√£o Brasileira'}</p>
              </div>
            </div>
            <div class="text-right">
              <span class="status-badge status-ativa">
                ${rec.action}
              </span>
              <div class="text-xs text-gray-400 mt-1">${formatDate(rec.created_at)}</div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <p class="text-sm text-gray-400">Pre√ßo Entrada</p>
              <p class="text-lg font-semibold text-white">R$ ${rec.entry_price.toFixed(2)}</p>
            </div>
            <div>
              <p class="text-sm text-gray-400">Pre√ßo Atual</p>
              <p class="text-lg font-semibold ${performance >= 0 ? 'text-success' : 'text-danger'} ${isRecentUpdate ? 'price-updated' : ''}">
                R$ ${currentPrice.toFixed(2)}
                ${isRecentUpdate ? '<span class="text-xs ml-1"></span>' : ''}
              </p>
            </div>
            <div>
              <p class="text-sm text-gray-400">Alvo</p>
              <p class="text-lg font-semibold text-accent">R$ ${rec.target_price.toFixed(2)}</p>
            </div>
            <div>
              <p class="text-sm text-gray-400">Stop Loss</p>
              <p class="text-lg font-semibold text-warning">R$ ${rec.stop_loss.toFixed(2)}</p>
            </div>
          </div>

          <div class="flex items-center justify-between text-sm mb-4">
            <div class="flex items-center gap-4">
              <span class="text-gray-400">
                <i class="fas fa-chart-line mr-1"></i>
                Performance: <span class="${performance >= 0 ? 'text-success' : 'text-danger'} font-medium">
                  ${performance >= 0 ? '+' : ''}${performance.toFixed(2)}%
                </span>
              </span>
              <span class="text-gray-400">
                <i class="fas fa-target mr-1"></i>
                Potencial: <span class="${potentialProfit >= 0 ? 'text-success' : 'text-danger'} font-medium">
                  ${potentialProfit >= 0 ? '+' : ''}${potentialProfit.toFixed(2)}%
                </span>
              </span>
            </div>
          </div>

          <div class="flex items-center justify-between text-sm">
            <span class="text-gray-400">
              <i class="fas fa-shield-alt mr-1"></i>
              R/R: <span class="text-white font-medium">1:${riskReward.toFixed(1)}</span>
            </span>
            <span class="text-gray-400">
              <i class="fas fa-brain mr-1"></i>
              Confian√ßa: <span class="text-white font-medium">${rec.confidence || 85}%</span>
            </span>
          </div>

          <div class="mt-4 pt-4 border-t border-white/10">
            <canvas id="miniChart${rec.id}" height="80"></canvas>
          </div>
        </div>
      `;
    }

    // ===== CARREGAR MINI CHARTS =====
    function loadMiniCharts() {
      recommendations.forEach(rec => {
        const canvas = document.getElementById(`miniChart${rec.id}`);
        if (canvas) {
          const ctx = canvas.getContext('2d');
          
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: ['', '', '', '', '', '', ''],
              datasets: [{
                data: generateMiniChartData(rec),
                borderColor: rec.action === 'COMPRA' ? '#10b981' : '#ef4444',
                borderWidth: 2,
                tension: 0.4,
                pointRadius: 0,
                fill: true,
                backgroundColor: rec.action === 'COMPRA' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
              },
              scales: {
                x: { display: false },
                y: { display: false }
              }
            }
          });
        }
      });
    }

    // ===== GERAR DADOS PARA MINI CHART =====
    function generateMiniChartData(rec) {
      const basePrice = rec.entry_price;
      const currentPrice = rec.current_price || rec.entry_price;
      const trend = rec.action === 'COMPRA' ? 1 : -1;
      const volatility = 0.015;
      
      return Array.from({length: 7}, (_, i) => {
        const progress = i / 6;
        const trendPrice = basePrice + ((currentPrice - basePrice) * progress);
        const randomFactor = (Math.random() - 0.5) * volatility * basePrice;
        return Math.max(0, trendPrice + randomFactor);
      });
    }

    // ===== MOSTRAR DETALHES NO MODAL =====
    function showDetails(recId) {
      const rec = recommendations.find(r => r.id == recId);
      if (!rec) return;

      const modal = document.getElementById('detailsModal');
      const content = document.getElementById('modalContent');

      const currentPrice = rec.current_price || rec.entry_price;
      const performance = rec.performance || 0; // Performance real do backend
      const potentialProfit = ((rec.target_price - rec.entry_price) / rec.entry_price * 100);
      const distanceToTarget = ((rec.target_price - currentPrice) / currentPrice * 100);
      const distanceToStop = Math.abs((currentPrice - rec.stop_loss) / currentPrice * 100);

      content.innerHTML = `
        <div class="space-y-6">
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white/5 rounded-lg p-4">
              <p class="text-sm text-gray-400">Ativo</p>
              <p class="text-xl font-bold text-white">${rec.ticker}</p>
            </div>
            <div class="bg-white/5 rounded-lg p-4">
              <p class="text-sm text-gray-400">A√ß√£o</p>
              <p class="text-xl font-bold ${rec.action === 'COMPRA' ? 'text-success' : 'text-danger'}">${rec.action}</p>
            </div>
            <div class="bg-white/5 rounded-lg p-4">
              <p class="text-sm text-gray-400">Status</p>
              <p class="text-xl font-bold text-accent">${rec.status}</p>
            </div>
            <div class="bg-white/5 rounded-lg p-4">
              <p class="text-sm text-gray-400">Dura√ß√£o</p>
              <p class="text-xl font-bold text-white">${calculateDuration(rec.created_at)}</p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white/5 rounded-lg p-4">
              <h4 class="text-lg font-semibold text-white mb-3">Par√¢metros da Opera√ß√£o</h4>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-gray-400">Entrada:</span>
                  <span class="text-white font-medium">R$ ${rec.entry_price.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Alvo:</span>
                  <span class="text-accent font-medium">R$ ${rec.target_price.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Stop Loss:</span>
                  <span class="text-warning font-medium">R$ ${rec.stop_loss.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Confian√ßa:</span>
                  <span class="text-white font-medium">${rec.confidence || 85}%</span>
                </div>
              </div>
            </div>

            <div class="bg-white/5 rounded-lg p-4">
              <h4 class="text-lg font-semibold text-white mb-3">Performance Atual</h4>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-gray-400">Pre√ßo Atual:</span>
                  <span class="text-white font-medium">R$ ${currentPrice.toFixed(2)} 
                    ${lastUpdateTime && (new Date() - lastUpdateTime) < (10 * 60 * 1000) ? '<span class="text-green-400 text-xs ml-1"></span>' : ''}
                  </span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Performance:</span>
                  <span class="${performance >= 0 ? 'text-success' : 'text-danger'} font-medium">
                    ${performance >= 0 ? '+' : ''}${performance.toFixed(2)}%
                  </span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Dist. do Alvo:</span>
                  <span class="text-white font-medium">${distanceToTarget.toFixed(2)}%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Dist. do Stop:</span>
                  <span class="text-white font-medium">${distanceToStop.toFixed(2)}%</span>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white/5 rounded-lg p-4">
            <h4 class="text-lg font-semibold text-white mb-3">An√°lise da Recomenda√ß√£o</h4>
            <p class="text-gray-300">${rec.reason || 'Recomenda√ß√£o gerada por algoritmos de Machine Learning considerando padr√µes hist√≥ricos, momentum e indicadores t√©cnicos avan√ßados.'}</p>
            
            ${lastUpdateTime ? `
              <div class="mt-3 pt-3 border-t border-gray-700">
                <p class="text-xs text-gray-500">
                  <i class="fas fa-clock mr-1"></i>
                  Performance atualizada em tempo real ‚Ä¢ √öltima atualiza√ß√£o: ${formatDateTime(lastUpdateTime)}
                </p>
              </div>
            ` : ''}
          </div>
        </div>
      `;

      modal.classList.remove('hidden');
    }

    // ===== FECHAR MODAL =====
    function closeModal() {
      document.getElementById('detailsModal').classList.add('hidden');
    }

    // ===== ATUALIZAR ESTAT√çSTICAS =====
    function updateStats() {
      const activeCount = recommendations.length;
      const buyCount = recommendations.filter(r => r.action === 'COMPRA').length;
      const sellCount = recommendations.filter(r => r.action === 'VENDA').length;
      
      document.getElementById('totalRecommendations').textContent = activeCount;
      document.getElementById('buySignals').textContent = buyCount;
      document.getElementById('sellSignals').textContent = sellCount;

      calculateSuccessRate();
    }

    
    // ===== CALCULAR TAXA DE SUCESSO =====
    // ===== CALCULAR TAXA DE SUCESSO - VERS√ÉO DEBUG =====
function calculateSuccessRate() {
  try {
    console.log('üîç Calculando taxa de sucesso...');
    console.log('Total de recomenda√ß√µes:', allRecommendations.length);
    
    // Filtrar apenas recomenda√ß√µes realmente fechadas
    const closedRecs = allRecommendations.filter(r => {
      const isClosed = r.status && (
        r.status === 'FINALIZADA_GANHO' || 
        r.status === 'FINALIZADA_PERDA' ||
        r.status === 'FINALIZADA_MANUAL'
      );
      return isClosed;
    });
    
    console.log('Recomenda√ß√µes fechadas:', closedRecs.length);
    console.log('Status encontrados:', [...new Set(allRecommendations.map(r => r.status))]);
    
    const wins = closedRecs.filter(r => 
      r.status === 'FINALIZADA_GANHO' || 
      (r.status === 'FINALIZADA_MANUAL' && (r.performance || 0) > 0)
    );
    
    const losses = closedRecs.filter(r => 
      r.status === 'FINALIZADA_PERDA' || 
      (r.status === 'FINALIZADA_MANUAL' && (r.performance || 0) < 0)
    );
    
    console.log('Ganhos:', wins.length);
    console.log('Perdas:', losses.length);
    
    //  C√ÅLCULO CORRETO DA TAXA DE SUCESSO
    const successRate = closedRecs.length > 0 ? (wins.length / closedRecs.length * 100) : 0;
    
    const avgGain = wins.length > 0 ? wins.reduce((sum, r) => sum + Math.abs(r.performance || 0), 0) / wins.length : 0;
    const avgLoss = losses.length > 0 ? Math.abs(losses.reduce((sum, r) => sum + (r.performance || 0), 0)) / losses.length : 0;
    const profitFactor = avgLoss > 0 ? (avgGain / avgLoss) : 0;
    
    //  CALCULAR RETORNO ACUMULADO
    const cumulativeReturn = closedRecs.reduce((sum, r) => sum + (r.performance || 0), 0);
    
    console.log('Taxa de sucesso calculada:', successRate.toFixed(1) + '%');
    console.log('Retorno acumulado:', cumulativeReturn.toFixed(2) + '%');
    
    // Atualizar UI
    document.getElementById('successRate').textContent = closedRecs.length > 0 ? `${successRate.toFixed(1)}%` : '--';
    document.getElementById('closedRecommendations').textContent = closedRecs.length;
    document.getElementById('avgGain').textContent = avgGain > 0 ? `+${avgGain.toFixed(2)}%` : '--';
    document.getElementById('avgLoss').textContent = avgLoss > 0 ? `-${avgLoss.toFixed(2)}%` : '--';
    document.getElementById('profitFactor').textContent = profitFactor > 0 ? profitFactor.toFixed(2) : '--';
    
    //  MOSTRAR RETORNO ACUMULADO (ADICIONAR ESTE CAMPO NO HTML)
    const cumulativeEl = document.getElementById('cumulativeReturn');
    if (cumulativeEl) {
      cumulativeEl.textContent = closedRecs.length > 0 ? 
        `${cumulativeReturn >= 0 ? '+' : ''}${cumulativeReturn.toFixed(2)}%` : '--';
      cumulativeEl.className = `font-medium ${cumulativeReturn >= 0 ? 'text-success' : 'text-danger'}`;
    }
    
    // Melhor performance
    if (wins.length > 0) {
      const bestWin = wins.reduce((best, current) => 
        (current.performance || 0) > (best.performance || 0) ? current : best
      );
      
      document.getElementById('bestPerformance').innerHTML = `
        <div class="text-2xl font-bold text-success">${bestWin.ticker}</div>
        <div class="text-lg text-success">+${(bestWin.performance || 0).toFixed(2)}%</div>
        <div class="text-sm text-gray-400">${formatDate(bestWin.created_at)}</div>
      `;
    } else {
      document.getElementById('bestPerformance').innerHTML = `
        <div class="text-2xl font-bold text-gray-400">--</div>
        <div class="text-sm text-gray-400">Nenhuma finalizada</div>
      `;
    }
    
  } catch (error) {
    console.error('Erro ao calcular estat√≠sticas:', error);
    // Valores padr√£o em caso de erro
    document.getElementById('successRate').textContent = '--';
    document.getElementById('closedRecommendations').textContent = '0';
    document.getElementById('avgGain').textContent = '--';
    document.getElementById('avgLoss').textContent = '--';
    document.getElementById('profitFactor').textContent = '--';
  }
}

    // ===== INICIALIZAR GR√ÅFICO DE PERFORMANCE =====
    function initPerformanceChart() {
      const ctx = document.getElementById('performanceChart').getContext('2d');
      
      performanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Performance (%)',
            data: [],
            backgroundColor: [],
            borderColor: [],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              ticks: { color: '#9ca3af' }
            },
            y: {
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              ticks: { 
                color: '#9ca3af',
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          }
        }
      });
    }

    // ===== ATUALIZAR GR√ÅFICO DE PERFORMANCE =====
    function updatePerformanceChart() {
      try {
        const closedRecs = allRecommendations.filter(r => 
          r.status && r.status.startsWith('FINALIZADA') && r.performance !== undefined
        );
        
        const recentClosed = closedRecs.slice(-10);
        
        if (recentClosed.length > 0) {
          performanceChart.data.labels = recentClosed.map(d => d.ticker);
          performanceChart.data.datasets[0].data = recentClosed.map(d => d.performance || 0);
          performanceChart.data.datasets[0].backgroundColor = recentClosed.map(d => 
            (d.performance || 0) >= 0 ? 'rgba(16, 185, 129, 0.6)' : 'rgba(239, 68, 68, 0.6)'
          );
          performanceChart.data.datasets[0].borderColor = recentClosed.map(d => 
            (d.performance || 0) >= 0 ? '#10b981' : '#ef4444'
          );
        }
        
        performanceChart.update();
      } catch (error) {
        console.error('Erro ao atualizar gr√°fico de performance:', error);
      }
    }

    // ===== ATUALIZAR TIMERS =====
    function updateTimers() {
      const now = new Date();
      const lastUpdate = new Date(now.getFullYear(), now.getMonth(), 1);
      const nextUpdate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      
      document.getElementById('lastUpdate').textContent = formatDate(lastUpdate);
      
      const daysUntilNext = Math.ceil((nextUpdate - now) / (1000 * 60 * 60 * 24));
      document.getElementById('nextUpdate').textContent = `${daysUntilNext} dias`;
    }

    // üî• MOSTRAR FEEDBACK DE ATUALIZA√á√ÉO DE PRE√áOS
    function showPriceUpdateFeedback() {
      const indicator = document.createElement('div');
      indicator.className = 'fixed top-20 right-4 bg-success text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
      indicator.innerHTML = '<i class="fas fa-check mr-2"></i>Pre√ßos atualizados';
      
      document.body.appendChild(indicator);
      
      setTimeout(() => {
        indicator.style.opacity = '0';
        setTimeout(() => {
          if (document.body.contains(indicator)) {
            document.body.removeChild(indicator);
          }
        }, 300);
      }, 2000);
    }

    // üî• ATUALIZAR DISPLAY DO √öLTIMO UPDATE
    function updateLastUpdateDisplay() {
      const lastUpdateEl = document.getElementById('lastUpdate');
      if (lastUpdateEl && lastUpdateTime) {
        lastUpdateEl.textContent = new Date(lastUpdateTime).toLocaleTimeString('pt-BR');
      }
    }

    // ===== MOSTRAR TOAST =====
    function showToast(message, type = 'info') {
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-yellow-500'
      };
      
      const toast = document.createElement('div');
      toast.className = `fixed top-20 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300`;
      toast.textContent = message;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, 4000);
    }

    // ===== MOSTRAR ERRO GLOBAL =====
    function showGlobalError(message) {
      const container = document.getElementById('recommendationsContainer');
      container.innerHTML = `
        <div class="col-span-2 error-card rounded-xl p-8 text-center">
          <i class="fas fa-exclamation-triangle text-6xl text-danger mb-4"></i>
          <h3 class="text-xl font-bold text-white mb-2">Erro de Conex√£o</h3>
          <p class="text-gray-300 mb-4">${message}</p>
          <div class="space-y-2 text-sm text-gray-400 mb-6">
            <p>‚Ä¢ Verifique sua conex√£o com a internet</p>
            <p>‚Ä¢ O servidor pode estar temporariamente indispon√≠vel</p>
            <p>‚Ä¢ Sua sess√£o pode ter expirado</p>
          </div>
          <div class="flex gap-4 justify-center">
            <button onclick="refreshRecommendations()" class="retry-btn text-white px-6 py-3 rounded-lg font-medium">
              <i class="fas fa-sync mr-2"></i>Tentar Novamente
            </button>
            <button onclick="window.location.reload()" class="bg-gray-600 hover:bg-gray-500 text-white px-6 py-3 rounded-lg font-medium">
              <i class="fas fa-refresh mr-2"></i>Recarregar P√°gina
            </button>
          </div>
        </div>
      `;
    }

    // ===== MOSTRAR ERRO =====
    function showError(message = 'Erro ao carregar recomenda√ß√µes') {
      const container = document.getElementById('recommendationsContainer');
      container.innerHTML = `
        <div class="col-span-2 text-center py-12">
          <i class="fas fa-exclamation-triangle text-6xl text-danger mb-4"></i>
          <p class="text-xl text-gray-400">${message}</p>
          <p class="text-sm text-gray-500 mt-2">Verifique sua conex√£o e tente novamente</p>
          <button onclick="refreshRecommendations()" class="mt-4 retry-btn text-white px-6 py-2 rounded-lg">
            <i class="fas fa-sync mr-2"></i>Tentar Novamente
          </button>
        </div>
      `;
    }

    // ===== FUN√á√ïES UTILIT√ÅRIAS =====
    function formatDate(dateString) {
      if (!dateString) return '--';
      return new Date(dateString).toLocaleDateString('pt-BR');
    }

    function formatDateTime(dateString) {
      if (!dateString) return '--';
      return new Date(dateString).toLocaleString('pt-BR');
    }

    function calculateDuration(startDate) {
      if (!startDate) return '--';
      const start = new Date(startDate);
      const now = new Date();
      const days = Math.floor((now - start) / (1000 * 60 * 60 * 24));
      return `${days} dias`;
    }

    // ===== LOGOUT =====
    function logout() {
      localStorage.removeItem('geminii_token');
      localStorage.removeItem('geminii_user');
      window.location.href = '/';
    }

    // ===== EVENT LISTENERS =====
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üìÑ DOM carregado - inicializando...');
      init();
    });

    window.addEventListener('load', function() {
      console.log(' Window loaded - verificando inicializa√ß√£o...');
      if (!userToken) {
        init();
      }
    });

    // üî• GERENCIAR AUTO-UPDATE BASEADO NA VISIBILIDADE DA P√ÅGINA
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopAutoUpdate();
        console.log('üì± P√°gina oculta - pausando auto-update');
      } else {
        startAutoUpdate();
        console.log('üëÅÔ∏è P√°gina vis√≠vel - retomando auto-update');
        // Atualizar imediatamente quando voltar a ser vis√≠vel
        setTimeout(updateCurrentPrices, 1000);
      }
    });

    // Handle online/offline events
    window.addEventListener('online', function() {
      console.log('üåê Conex√£o restaurada');
      updateConnectionStatus(true);
      startAutoUpdate();
      refreshRecommendations();
    });

    window.addEventListener('offline', function() {
      console.log('üì° Conex√£o perdida');
      updateConnectionStatus(false);
      stopAutoUpdate();
    });

    // Cleanup when leaving page
    window.addEventListener('beforeunload', () => {
      stopAutoUpdate();
    });

    // üî• FUN√á√ïES DE DEBUG (DESENVOLVIMENTO)
    window.debugInfo = function() {
      console.log('üîç Debug Info:');
      console.log('Token:', userToken ? 'Present' : 'Missing');
      console.log('User:', currentUser);
      console.log('Recommendations:', recommendations.length);
      console.log('All Recommendations:', allRecommendations.length);
      console.log('Auto-Update Active:', !!autoUpdateInterval);
      console.log('Last Update:', lastUpdateTime);
    };

    window.forceUpdate = function() {
      console.log('üîÑ For√ßando atualiza√ß√£o...');
      updateCurrentPrices();
    };
  </script>
</body>
</html>