<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recomendações Free - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            secondary: '#8b5cf6',
            accent: '#06b6d4',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            geminii: '#ba39af'
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #0f0f0f;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .navbar {
      background: rgba(15, 15, 15, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .recommendation-card {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.05));
      border: 1px solid rgba(99, 102, 241, 0.2);
      backdrop-filter: blur(20px);
      transition: all 0.3s ease;
    }
    
    .recommendation-card:hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.08));
      border-color: rgba(99, 102, 241, 0.3);
      transform: translateY(-2px);
    }
    
    .buy-signal {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
      border-color: rgba(16, 185, 129, 0.3);
    }
    
    .sell-signal {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
      border-color: rgba(239, 68, 68, 0.3);
    }
    
    .pulse-glow {
      animation: pulseGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes pulseGlow {
      from { box-shadow: 0 0 20px rgba(186, 57, 175, 0.3); }
      to { box-shadow: 0 0 30px rgba(186, 57, 175, 0.6); }
    }
    
    .loading-skeleton {
      background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%);
      background-size: 400% 100%;
      animation: skeleton-loading 1.4s ease-in-out infinite;
    }

    @keyframes skeleton-loading {
      0% { background-position: 100% 50%; }
      100% { background-position: 0 50%; }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="min-h-screen text-white">
  
  <!-- Navigation -->
  <nav class="navbar fixed top-0 left-0 right-0 z-50 px-6 py-4">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center space-x-8">
        <div class="flex items-center space-x-3">
          <img src="assets/logo.png" alt="Geminii Logo" class="w-8 h-8 rounded-lg">
          <span class="text-xl font-bold text-white">Geminii</span>
        </div>
        <div class="hidden md:flex items-center space-x-6">
          <a href="dashboard.html" class="text-gray-300 hover:text-primary transition-colors">Dashboard</a>
          <a href="recomendacoes.html" class="text-primary font-medium">Recomendações Free</a>
        </div>
      </div>
      
      <div class="flex items-center space-x-4">
        <button onclick="refreshRecommendations()" class="bg-primary hover:bg-primary/80 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
          <i class="fas fa-sync mr-2"></i>Atualizar
        </button>
        <button onclick="logout()" class="bg-red-50 hover:bg-red-100 text-red-600 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
          Sair
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="pt-24 px-6 pb-12">
    <div class="max-w-7xl mx-auto">
      
      <!-- Header -->
      <div class="card rounded-2xl p-8 mb-8 fade-in">
        <div class="flex flex-col lg:flex-row items-center justify-between gap-6">
          <div>
            <h1 class="text-3xl font-bold text-white mb-2">
              <i class="fas fa-brain text-geminii mr-3"></i>
              Recomendações Free Mensais
            </h1>
            <p class="text-gray-300">
              Análises geradas por Machine Learning com dados reais do mercado
            </p>
          </div>
          <div class="flex items-center gap-4">
            <div class="text-center">
              <div class="text-sm text-gray-400">Última Atualização</div>
              <div id="lastUpdate" class="text-lg font-semibold text-white">--</div>
            </div>
            <div class="text-center">
              <div class="text-sm text-gray-400">Próxima em</div>
              <div id="nextUpdate" class="text-lg font-semibold text-accent">--</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="card rounded-xl p-6 fade-in">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-white" id="totalRecommendations">0</div>
              <div class="text-sm text-gray-400">Recomendações Ativas</div>
            </div>
            <div class="w-12 h-12 bg-primary/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-chart-line text-primary"></i>
            </div>
          </div>
        </div>
        
        <div class="card rounded-xl p-6 fade-in">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-success" id="buySignals">0</div>
              <div class="text-sm text-gray-400">Sinais de Compra</div>
            </div>
            <div class="w-12 h-12 bg-success/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-arrow-up text-success"></i>
            </div>
          </div>
        </div>
        
        <div class="card rounded-xl p-6 fade-in">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-danger" id="sellSignals">0</div>
              <div class="text-sm text-gray-400">Sinais de Venda</div>
            </div>
            <div class="w-12 h-12 bg-danger/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-arrow-down text-danger"></i>
            </div>
          </div>
        </div>
        
        <div class="card rounded-xl p-6 fade-in">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-warning" id="successRate">--</div>
              <div class="text-sm text-gray-400">Taxa de Acerto</div>
            </div>
            <div class="w-12 h-12 bg-warning/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-percentage text-warning"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Active Recommendations -->
      <div class="mb-8">
        <h2 class="text-2xl font-bold text-white mb-6">
          <i class="fas fa-robot mr-2 text-geminii"></i>
          Recomendações Ativas
        </h2>
        
        <div id="recommendationsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Loading skeleton -->
          <div class="recommendation-card rounded-xl p-6 loading-skeleton h-96"></div>
          <div class="recommendation-card rounded-xl p-6 loading-skeleton h-96"></div>
        </div>
      </div>

      <!-- Historical Performance -->
      <div class="card rounded-2xl p-8">
        <h2 class="text-2xl font-bold text-white mb-6">
          <i class="fas fa-history mr-2 text-primary"></i>
          Histórico de Performance
        </h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="col-span-2">
            <canvas id="performanceChart" height="300"></canvas>
          </div>
          <div class="space-y-4">
            <div class="bg-white/5 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-white mb-3">Estatísticas do Mês</h3>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-gray-400">Recomendações Fechadas:</span>
                  <span class="text-white font-medium" id="closedRecommendations">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Ganho Médio:</span>
                  <span class="text-success font-medium" id="avgGain">+0%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Perda Média:</span>
                  <span class="text-danger font-medium" id="avgLoss">-0%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Profit Factor:</span>
                  <span class="text-white font-medium" id="profitFactor">0.0</span>
                </div>
              </div>
            </div>
            
            <div class="bg-white/5 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-white mb-3">Melhor Performance</h3>
              <div id="bestPerformance" class="text-center py-4">
                <div class="text-2xl font-bold text-success">--</div>
                <div class="text-sm text-gray-400">Aguardando dados</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal para Detalhes -->
  <div id="detailsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-gray-900 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-800">
          <div class="flex items-center justify-between">
            <h3 class="text-2xl font-bold text-white">Detalhes da Recomendação</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
        </div>
        <div id="modalContent" class="p-6">
          <!-- Content will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    let recommendations = [];
    let performanceChart = null;
    let userToken = null;

    // Initialize
    async function init() {
      userToken = localStorage.getItem('geminii_token');
      if (!userToken) {
        window.location.href = '/login.html';
        return;
      }

      await loadRecommendations();
      initPerformanceChart();
      updateTimers();
      setInterval(updateTimers, 60000); // Update every minute
    }

    // Load recommendations
    async function loadRecommendations() {
      try {
        const response = await fetch('/api/recommendations/free/active', {
          headers: { 'Authorization': `Bearer ${userToken}` }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            recommendations = result.recommendations;
            displayRecommendations();
            updateStats();
            updatePerformanceChart();
          }
        }
      } catch (error) {
        console.error('Error loading recommendations:', error);
        showError();
      }
    }

    // Display recommendations
    function displayRecommendations() {
      const container = document.getElementById('recommendationsContainer');
      
      if (!recommendations || recommendations.length === 0) {
        container.innerHTML = `
          <div class="col-span-2 text-center py-12">
            <i class="fas fa-inbox text-6xl text-gray-600 mb-4"></i>
            <p class="text-xl text-gray-400">Nenhuma recomendação ativa no momento</p>
            <p class="text-sm text-gray-500 mt-2">Novas recomendações são geradas mensalmente</p>
          </div>
        `;
        return;
      }

      container.innerHTML = recommendations.map(rec => createRecommendationCard(rec)).join('');
    }

    // Create recommendation card
    function createRecommendationCard(rec) {
      const isCompra = rec.action === 'COMPRA';
      const cardClass = isCompra ? 'buy-signal' : 'sell-signal';
      const actionIcon = isCompra ? 'fa-arrow-trend-up' : 'fa-arrow-trend-down';
      const actionColor = isCompra ? 'text-success' : 'text-danger';
      
      // Calculate potential profit
      const potentialProfit = ((rec.target_price - rec.entry_price) / rec.entry_price * 100).toFixed(2);
      const risk = ((rec.entry_price - rec.stop_loss) / rec.entry_price * 100).toFixed(2);
      const riskReward = (Math.abs(potentialProfit) / Math.abs(risk)).toFixed(2);

      return `
        <div class="recommendation-card ${cardClass} rounded-xl p-6 fade-in cursor-pointer" onclick="showDetails('${rec.id}')">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-white/10 rounded-lg flex items-center justify-center">
                <i class="fas ${actionIcon} ${actionColor} text-xl"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold text-white">${rec.ticker}</h3>
                <p class="text-sm text-gray-400">${rec.company_name || 'Carregando...'}</p>
              </div>
            </div>
            <span class="px-3 py-1 rounded-full text-sm font-semibold ${isCompra ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger'}">
              ${rec.action}
            </span>
          </div>

          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <p class="text-sm text-gray-400">Preço Entrada</p>
              <p class="text-lg font-semibold text-white">R$ ${rec.entry_price.toFixed(2)}</p>
            </div>
            <div>
              <p class="text-sm text-gray-400">Preço Atual</p>
              <p class="text-lg font-semibold ${rec.current_price > rec.entry_price ? 'text-success' : 'text-danger'}">
                R$ ${rec.current_price.toFixed(2)}
              </p>
            </div>
            <div>
              <p class="text-sm text-gray-400">Alvo</p>
              <p class="text-lg font-semibold text-accent">R$ ${rec.target_price.toFixed(2)}</p>
            </div>
            <div>
              <p class="text-sm text-gray-400">Stop Loss</p>
              <p class="text-lg font-semibold text-warning">R$ ${rec.stop_loss.toFixed(2)}</p>
            </div>
          </div>

          <div class="flex items-center justify-between text-sm">
            <div class="flex items-center gap-4">
              <span class="text-gray-400">
                <i class="fas fa-chart-line mr-1"></i>
                Potencial: <span class="${potentialProfit > 0 ? 'text-success' : 'text-danger'} font-medium">${potentialProfit > 0 ? '+' : ''}${potentialProfit}%</span>
              </span>
              <span class="text-gray-400">
                <i class="fas fa-shield-alt mr-1"></i>
                R/R: <span class="text-white font-medium">1:${riskReward}</span>
              </span>
            </div>
            <span class="text-gray-400">
              <i class="fas fa-calendar mr-1"></i>
              ${formatDate(rec.created_at)}
            </span>
          </div>

          <div class="mt-4 pt-4 border-t border-white/10">
            <canvas id="miniChart${rec.id}" height="120"></canvas>
          </div>
        </div>
      `;
    }

    // Show details modal
    async function showDetails(recId) {
      const rec = recommendations.find(r => r.id === recId);
      if (!rec) return;

      const modal = document.getElementById('detailsModal');
      const content = document.getElementById('modalContent');

      // Load detailed chart
      content.innerHTML = `
        <div class="space-y-6">
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white/5 rounded-lg p-4">
              <p class="text-sm text-gray-400">Ativo</p>
              <p class="text-xl font-bold text-white">${rec.ticker}</p>
            </div>
            <div class="bg-white/5 rounded-lg p-4">
              <p class="text-sm text-gray-400">Ação</p>
              <p class="text-xl font-bold ${rec.action === 'COMPRA' ? 'text-success' : 'text-danger'}">${rec.action}</p>
            </div>
            <div class="bg-white/5 rounded-lg p-4">
              <p class="text-sm text-gray-400">Status</p>
              <p class="text-xl font-bold text-accent">${rec.status}</p>
            </div>
            <div class="bg-white/5 rounded-lg p-4">
              <p class="text-sm text-gray-400">Duração</p>
              <p class="text-xl font-bold text-white">${calculateDuration(rec.created_at)}</p>
            </div>
          </div>

          <div>
            <h4 class="text-lg font-semibold text-white mb-3">Análise Técnica</h4>
            <canvas id="detailChart" height="400"></canvas>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white/5 rounded-lg p-4">
              <h4 class="text-lg font-semibold text-white mb-3">Parâmetros da Operação</h4>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-gray-400">Entrada:</span>
                  <span class="text-white font-medium">R$ ${rec.entry_price.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Alvo:</span>
                  <span class="text-accent font-medium">R$ ${rec.target_price.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Stop Loss:</span>
                  <span class="text-warning font-medium">R$ ${rec.stop_loss.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Risk/Reward:</span>
                  <span class="text-white font-medium">1:${rec.risk_reward || '2.0'}</span>
                </div>
              </div>
            </div>

            <div class="bg-white/5 rounded-lg p-4">
              <h4 class="text-lg font-semibold text-white mb-3">Performance Atual</h4>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-gray-400">Preço Atual:</span>
                  <span class="text-white font-medium">R$ ${rec.current_price.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Variação:</span>
                  <span class="${rec.performance > 0 ? 'text-success' : 'text-danger'} font-medium">
                    ${rec.performance > 0 ? '+' : ''}${rec.performance.toFixed(2)}%
                  </span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Dist. do Alvo:</span>
                  <span class="text-white font-medium">${((rec.target_price - rec.current_price) / rec.current_price * 100).toFixed(2)}%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Dist. do Stop:</span>
                  <span class="text-white font-medium">${((rec.current_price - rec.stop_loss) / rec.current_price * 100).toFixed(2)}%</span>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white/5 rounded-lg p-4">
            <h4 class="text-lg font-semibold text-white mb-3">Análise ML</h4>
            <p class="text-gray-300">${rec.ml_analysis || 'Análise gerada por algoritmos de Machine Learning considerando padrões históricos, momentum e indicadores técnicos.'}</p>
          </div>
        </div>
      `;

      modal.classList.remove('hidden');
      
      // Load detailed chart
      setTimeout(() => loadDetailChart(rec), 100);
    }

    // Load detail chart
    async function loadDetailChart(rec) {
      try {
        const response = await fetch(`/api/recommendations/free/${rec.id}/chart-data`, {
          headers: { 'Authorization': `Bearer ${userToken}` }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            createDetailChart(result.data, rec);
          }
        }
      } catch (error) {
        console.error('Error loading chart data:', error);
      }
    }

    // Create detail chart
    function createDetailChart(data, rec) {
      const ctx = document.getElementById('detailChart').getContext('2d');
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.dates,
          datasets: [{
            label: 'Preço',
            data: data.prices,
            borderColor: '#6366f1',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            borderWidth: 2,
            tension: 0.1,
            pointRadius: 0,
            pointHoverRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            annotation: {
              annotations: {
                entryLine: {
                  type: 'line',
                  yMin: rec.entry_price,
                  yMax: rec.entry_price,
                  borderColor: '#6366f1',
                  borderWidth: 2,
                  borderDash: [5, 5],
                  label: {
                    content: `Entrada: R$ ${rec.entry_price.toFixed(2)}`,
                    enabled: true,
                    position: 'start'
                  }
                },
                targetLine: {
                  type: 'line',
                  yMin: rec.target_price,
                  yMax: rec.target_price,
                  borderColor: '#10b981',
                  borderWidth: 2,
                  borderDash: [5, 5],
                  label: {
                    content: `Alvo: R$ ${rec.target_price.toFixed(2)}`,
                    enabled: true,
                    position: 'start'
                  }
                },
                stopLine: {
                  type: 'line',
                  yMin: rec.stop_loss,
                  yMax: rec.stop_loss,
                  borderColor: '#ef4444',
                  borderWidth: 2,
                  borderDash: [5, 5],
                  label: {
                    content: `Stop: R$ ${rec.stop_loss.toFixed(2)}`,
                    enabled: true,
                    position: 'start'
                  }
                }
              }
            }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              ticks: { color: '#9ca3af' }
            },
            y: {
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              ticks: { 
                color: '#9ca3af',
                callback: function(value) {
                  return 'R$ ' + value.toFixed(2);
                }
              }
            }
          }
        }
      });
    }

    // Close modal
    function closeModal() {
      document.getElementById('detailsModal').classList.add('hidden');
    }

    // Update stats
    function updateStats() {
      const buyCount = recommendations.filter(r => r.action === 'COMPRA').length;
      const sellCount = recommendations.filter(r => r.action === 'VENDA').length;
      
      document.getElementById('totalRecommendations').textContent = recommendations.length;
      document.getElementById('buySignals').textContent = buyCount;
      document.getElementById('sellSignals').textContent = sellCount;

      // Calculate success rate from historical data
      calculateSuccessRate();
    }

    // Calculate success rate
    async function calculateSuccessRate() {
      try {
        const response = await fetch('/api/recommendations/free/statistics', {
          headers: { 'Authorization': `Bearer ${userToken}` }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            const stats = result.statistics;
            document.getElementById('successRate').textContent = `${stats.success_rate.toFixed(1)}%`;
            document.getElementById('closedRecommendations').textContent = stats.closed_count;
            document.getElementById('avgGain').textContent = `+${stats.avg_gain.toFixed(2)}%`;
            document.getElementById('avgLoss').textContent = `${stats.avg_loss.toFixed(2)}%`;
            document.getElementById('profitFactor').textContent = stats.profit_factor.toFixed(2);
            
            if (stats.best_performance) {
              document.getElementById('bestPerformance').innerHTML = `
                <div class="text-2xl font-bold text-success">${stats.best_performance.ticker}</div>
                <div class="text-lg text-success">+${stats.best_performance.gain.toFixed(2)}%</div>
                <div class="text-sm text-gray-400">${formatDate(stats.best_performance.date)}</div>
              `;
            }
          }
        }
      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }

    // Initialize performance chart
    function initPerformanceChart() {
      const ctx = document.getElementById('performanceChart').getContext('2d');
      
      performanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Performance (%)',
            data: [],
            backgroundColor: [],
            borderColor: [],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              ticks: { color: '#9ca3af' }
            },
            y: {
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              ticks: { 
                color: '#9ca3af',
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          }
        }
      });
    }

    // Update performance chart
    async function updatePerformanceChart() {
      try {
        const response = await fetch('/api/recommendations/free/performance-history', {
          headers: { 'Authorization': `Bearer ${userToken}` }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            const data = result.history;
            
            performanceChart.data.labels = data.map(d => d.ticker);
            performanceChart.data.datasets[0].data = data.map(d => d.performance);
            performanceChart.data.datasets[0].backgroundColor = data.map(d => 
              d.performance >= 0 ? 'rgba(16, 185, 129, 0.6)' : 'rgba(239, 68, 68, 0.6)'
            );
            performanceChart.data.datasets[0].borderColor = data.map(d => 
              d.performance >= 0 ? '#10b981' : '#ef4444'
            );
            
            performanceChart.update();
          }
        }
      } catch (error) {
        console.error('Error loading performance history:', error);
      }
    }

    // Update timers
    function updateTimers() {
      const now = new Date();
      const lastUpdate = new Date(now.getFullYear(), now.getMonth(), 1); // First day of month
      const nextUpdate = new Date(now.getFullYear(), now.getMonth() + 1, 1); // First day of next month
      
      document.getElementById('lastUpdate').textContent = formatDate(lastUpdate);
      
      const daysUntilNext = Math.ceil((nextUpdate - now) / (1000 * 60 * 60 * 24));
      document.getElementById('nextUpdate').textContent = `${daysUntilNext} dias`;
    }

    // Refresh recommendations
    async function refreshRecommendations() {
      const btn = event.target.closest('button');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Atualizando...';
      
      await loadRecommendations();
      
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-sync mr-2"></i>Atualizar';
    }

    // Format date
    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('pt-BR');
    }

    // Calculate duration
    function calculateDuration(startDate) {
      const start = new Date(startDate);
      const now = new Date();
      const days = Math.floor((now - start) / (1000 * 60 * 60 * 24));
      return `${days} dias`;
    }

    // Show error
    function showError() {
      const container = document.getElementById('recommendationsContainer');
      container.innerHTML = `
        <div class="col-span-2 text-center py-12">
          <i class="fas fa-exclamation-triangle text-6xl text-danger mb-4"></i>
          <p class="text-xl text-gray-400">Erro ao carregar recomendações</p>
          <button onclick="loadRecommendations()" class="mt-4 bg-primary hover:bg-primary/80 text-white px-6 py-2 rounded-lg">
            Tentar Novamente
          </button>
        </div>
      `;
    }

    // Logout
    function logout() {
      localStorage.removeItem('geminii_token');
      localStorage.removeItem('geminii_user');
      window.location.href = '/';
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', init);

    // Load mini charts after cards are rendered
    async function loadMiniCharts() {
      for (const rec of recommendations) {
        const canvas = document.getElementById(`miniChart${rec.id}`);
        if (canvas) {
          const ctx = canvas.getContext('2d');
          
          // Simple mini chart with fake data for now
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: ['', '', '', '', '', '', ''],
              datasets: [{
                data: generateMiniChartData(rec),
                borderColor: rec.action === 'COMPRA' ? '#10b981' : '#ef4444',
                borderWidth: 2,
                tension: 0.4,
                pointRadius: 0,
                fill: true,
                backgroundColor: rec.action === 'COMPRA' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
              },
              scales: {
                x: { display: false },
                y: { display: false }
              }
            }
          });
        }
      }
    }

    // Generate mini chart data
    function generateMiniChartData(rec) {
      const basePrice = rec.entry_price;
      const trend = rec.action === 'COMPRA' ? 1 : -1;
      const volatility = 0.02;
      
      return Array.from({length: 7}, (_, i) => {
        const randomFactor = (Math.random() - 0.5) * volatility;
        const trendFactor = trend * (i / 7) * 0.03;
        return basePrice * (1 + trendFactor + randomFactor);
      });
    }

    // Call loadMiniCharts after displaying recommendations
    window.displayRecommendations = function() {
      displayRecommendations();
      setTimeout(loadMiniCharts, 100);
    }