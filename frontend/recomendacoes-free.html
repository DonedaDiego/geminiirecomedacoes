<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recomenda√ß√µes Free - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            secondary: '#8b5cf6',
            accent: '#06b6d4',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            geminii: '#ba39af'
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #0f0f0f;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .navbar {
      background: rgba(15, 15, 15, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .recommendation-card {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.05));
      border: 1px solid rgba(99, 102, 241, 0.2);
      backdrop-filter: blur(20px);
      transition: all 0.3s ease;
    }
    
    .recommendation-card:hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.08));
      border-color: rgba(99, 102, 241, 0.3);
      transform: translateY(-2px);
    }
    
    .buy-signal {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
      border-color: rgba(16, 185, 129, 0.3);
    }
    
    .sell-signal {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
      border-color: rgba(239, 68, 68, 0.3);
    }
    
    .pulse-glow {
      animation: pulseGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes pulseGlow {
      from { box-shadow: 0 0 20px rgba(186, 57, 175, 0.3); }
      to { box-shadow: 0 0 30px rgba(186, 57, 175, 0.6); }
    }
    
    .loading-skeleton {
      background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%);
      background-size: 400% 100%;
      animation: skeleton-loading 1.4s ease-in-out infinite;
    }

    @keyframes skeleton-loading {
      0% { background-position: 100% 50%; }
      100% { background-position: 0 50%; }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-ativa {
      background-color: rgba(16, 185, 129, 0.2);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-ganho {
      background-color: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .status-perda {
      background-color: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .error-card {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05));
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .retry-btn {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      transition: all 0.3s ease;
    }

    .retry-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
    }
  </style>
</head>
<body class="min-h-screen text-white">
  
  <!-- Navigation -->
  <nav class="navbar fixed top-0 left-0 right-0 z-50 px-6 py-4">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center space-x-8">
        <div class="flex items-center space-x-3">
          <img src="assets/logo.png" alt="Geminii Logo" class="w-8 h-8 rounded-lg">
          <span class="text-xl font-bold text-white">Geminii</span>
        </div>
        <div class="hidden md:flex items-center space-x-6">
          <a href="dashboard.html" class="text-gray-300 hover:text-primary transition-colors">Dashboard</a>
          <a href="recomendacoes-free.html" class="text-primary font-medium">Recomenda√ß√µes Free</a>
        </div>
      </div>
      
      <div class="flex items-center space-x-4">
        <div id="connectionStatus" class="flex items-center space-x-2">
          <div class="w-2 h-2 bg-success rounded-full animate-pulse"></div>
          <span class="text-sm text-gray-300">Online</span>
        </div>
        <button onclick="refreshRecommendations()" class="bg-primary hover:bg-primary/80 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
          <i class="fas fa-sync mr-2"></i>Atualizar
        </button>
        <button onclick="logout()" class="bg-red-50 hover:bg-red-100 text-red-600 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
          Sair
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="pt-24 px-6 pb-12">
    <div class="max-w-7xl mx-auto">
      
      <!-- Header -->
      <div class="card rounded-2xl p-8 mb-8 fade-in">
        <div class="flex flex-col lg:flex-row items-center justify-between gap-6">
          <div>
            <h1 class="text-3xl font-bold text-white mb-2">
              <i class="fas fa-brain text-geminii mr-3"></i>
              Recomenda√ß√µes Free Mensais
            </h1>
            <p class="text-gray-300">
              An√°lises geradas por Machine Learning com dados reais do mercado
            </p>
          </div>
          <div class="flex items-center gap-4">
            <div class="text-center">
              <div class="text-sm text-gray-400">√öltima Atualiza√ß√£o</div>
              <div id="lastUpdate" class="text-lg font-semibold text-white">--</div>
            </div>
            <div class="text-center">
              <div class="text-sm text-gray-400">Pr√≥xima em</div>
              <div id="nextUpdate" class="text-lg font-semibold text-accent">--</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="card rounded-xl p-6 fade-in">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-white" id="totalRecommendations">0</div>
              <div class="text-sm text-gray-400">Recomenda√ß√µes Ativas</div>
            </div>
            <div class="w-12 h-12 bg-primary/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-chart-line text-primary"></i>
            </div>
          </div>
        </div>
        
        <div class="card rounded-xl p-6 fade-in">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-success" id="buySignals">0</div>
              <div class="text-sm text-gray-400">Sinais de Compra</div>
            </div>
            <div class="w-12 h-12 bg-success/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-arrow-up text-success"></i>
            </div>
          </div>
        </div>
        
        <div class="card rounded-xl p-6 fade-in">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-danger" id="sellSignals">0</div>
              <div class="text-sm text-gray-400">Sinais de Venda</div>
            </div>
            <div class="w-12 h-12 bg-danger/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-arrow-down text-danger"></i>
            </div>
          </div>
        </div>
        
        <div class="card rounded-xl p-6 fade-in">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-warning" id="successRate">--</div>
              <div class="text-sm text-gray-400">Taxa de Acerto</div>
            </div>
            <div class="w-12 h-12 bg-warning/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-percentage text-warning"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Active Recommendations -->
      <div class="mb-8">
        <h2 class="text-2xl font-bold text-white mb-6">
          <i class="fas fa-robot mr-2 text-geminii"></i>
          Recomenda√ß√µes Ativas
        </h2>
        
        <div id="recommendationsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Loading skeleton -->
          <div class="recommendation-card rounded-xl p-6 loading-skeleton h-96"></div>
          <div class="recommendation-card rounded-xl p-6 loading-skeleton h-96"></div>
        </div>
      </div>

      <!-- Historical Performance -->
      <div class="card rounded-2xl p-8">
        <h2 class="text-2xl font-bold text-white mb-6">
          <i class="fas fa-history mr-2 text-primary"></i>
          Hist√≥rico de Performance
        </h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="col-span-2">
            <canvas id="performanceChart" height="300"></canvas>
          </div>
          <div class="space-y-4">
            <div class="bg-white/5 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-white mb-3">Estat√≠sticas do M√™s</h3>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-gray-400">Recomenda√ß√µes Fechadas:</span>
                  <span class="text-white font-medium" id="closedRecommendations">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Ganho M√©dio:</span>
                  <span class="text-success font-medium" id="avgGain">+0%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Perda M√©dia:</span>
                  <span class="text-danger font-medium" id="avgLoss">-0%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Profit Factor:</span>
                  <span class="text-white font-medium" id="profitFactor">0.0</span>
                </div>
              </div>
            </div>
            
            <div class="bg-white/5 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-white mb-3">Melhor Performance</h3>
              <div id="bestPerformance" class="text-center py-4">
                <div class="text-2xl font-bold text-success">--</div>
                <div class="text-sm text-gray-400">Aguardando dados</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal para Detalhes -->
  <div id="detailsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-gray-900 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-800">
          <div class="flex items-center justify-between">
            <h3 class="text-2xl font-bold text-white">Detalhes da Recomenda√ß√£o</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
        </div>
        <div id="modalContent" class="p-6">
          <!-- Content will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let recommendations = [];
    let allRecommendations = [];
    let performanceChart = null;
    let userToken = null;
    let currentUser = null;
    let retryCount = 0;
    const MAX_RETRIES = 3;

    // Initialize
    async function init() {
      console.log('üöÄ Inicializando Recomenda√ß√µes Free...');
      
      // Verificar token
      userToken = localStorage.getItem('geminii_token');
      if (!userToken) {
        console.log('‚ùå Token n√£o encontrado - redirecionando para login');
        window.location.href = '/login.html';
        return;
      }

      console.log('‚úÖ Token encontrado');
      
      try {
        // Verificar autentica√ß√£o primeiro
        await verifyAuthWithRetry();
        
        // Carregar dados
        await loadRecommendationsWithRetry();
        initPerformanceChart();
        updateTimers();
        
        // Atualizar a cada minuto
        setInterval(updateTimers, 60000);
        
        // Verificar conex√£o a cada 30 segundos
        setInterval(checkConnection, 30000);
        
        console.log('‚úÖ Inicializa√ß√£o conclu√≠da com sucesso!');
      } catch (error) {
        console.error('‚ùå Erro na inicializa√ß√£o:', error);
        showGlobalError('Erro na inicializa√ß√£o. Tentando novamente...');
        setTimeout(() => window.location.reload(), 3000);
      }
    }

    // Verificar autentica√ß√£o com retry
    async function verifyAuthWithRetry(attempt = 1) {
      try {
        console.log(`üîç Verificando autentica√ß√£o (tentativa ${attempt})...`);
        
        const response = await fetch('/api/auth/verify', {
          headers: { 
            'Authorization': `Bearer ${userToken}`,
            'Content-Type': 'application/json'
          },
          cache: 'no-cache'
        });

        console.log('üì° Status da verifica√ß√£o:', response.status);

        if (response.status === 401 || response.status === 403) {
          throw new Error('Token inv√°lido ou expirado');
        }

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const result = await response.json();
        if (!result.success) {
          throw new Error('Verifica√ß√£o falhou: ' + (result.error || 'Erro desconhecido'));
        }

        currentUser = result.data.user;
        console.log('‚úÖ Usu√°rio autenticado:', currentUser.name);
        updateConnectionStatus(true);
        
        return result;
      } catch (error) {
        console.error(`‚ùå Erro na verifica√ß√£o (tentativa ${attempt}):`, error);
        updateConnectionStatus(false);
        
        if (error.message.includes('Token inv√°lido') || error.message.includes('expirado')) {
          console.log('üö™ Token inv√°lido - fazendo logout...');
          logout();
          return;
        }
        
        if (attempt < MAX_RETRIES) {
          console.log(`üîÑ Tentando novamente em 2 segundos...`);
          await new Promise(resolve => setTimeout(resolve, 2000));
          return verifyAuthWithRetry(attempt + 1);
        }
        
        throw error;
      }
    }

    // Carregar recomenda√ß√µes com retry
    async function loadRecommendationsWithRetry(attempt = 1) {
      console.log(`üì° Carregando recomenda√ß√µes (tentativa ${attempt})...`);
      
      try {
        const response = await fetch('/api/recommendations/admin/all', {
          headers: { 
            'Authorization': `Bearer ${userToken}`,
            'Content-Type': 'application/json'
          },
          cache: 'no-cache'
        });

        console.log('üìä Status da resposta:', response.status, response.statusText);

        // Tratamento espec√≠fico para diferentes c√≥digos de erro
        if (response.status === 401) {
          console.log('üîë Token expirado - tentando renovar...');
          await verifyAuthWithRetry();
          if (attempt < MAX_RETRIES) {
            return loadRecommendationsWithRetry(attempt + 1);
          }
        }

        if (response.status === 403) {
          console.log('üö´ Acesso negado - verificando permiss√µes...');
          
          // Verificar se o usu√°rio tem as permiss√µes necess√°rias
          if (!currentUser) {
            await verifyAuthWithRetry();
          }
          
          // Se ainda assim n√£o conseguir, mostrar erro espec√≠fico
          throw new Error('Acesso negado. Verifique suas permiss√µes ou contate o suporte.');
        }

        if (response.status === 404) {
          console.log('üîç Endpoint n√£o encontrado');
          throw new Error('Servi√ßo temporariamente indispon√≠vel');
        }

        if (response.status >= 500) {
          console.log('üõ†Ô∏è Erro do servidor');
          throw new Error('Erro interno do servidor. Tente novamente em alguns minutos.');
        }

        if (!response.ok) {
          throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        console.log('üìÑ Resultado da API recebido');
        
        if (result.success) {
          allRecommendations = result.recommendations || [];
          console.log(`üìà Total de recomenda√ß√µes: ${allRecommendations.length}`);
          
          // Filtrar apenas as ativas para mostrar ao usu√°rio
          recommendations = allRecommendations.filter(r => r.status === 'ATIVA');
          console.log(`üéØ Recomenda√ß√µes ativas: ${recommendations.length}`);
          
          displayRecommendations();
          updateStats();
          updatePerformanceChart();
          updateConnectionStatus(true);
          
          return result;
        } else {
          throw new Error(result.error || 'Erro desconhecido da API');
        }
      } catch (error) {
        console.error(`‚ùå Erro ao carregar recomenda√ß√µes (tentativa ${attempt}):`, error);
        updateConnectionStatus(false);
        
        if (attempt < MAX_RETRIES) {
          console.log(`üîÑ Tentando novamente em 3 segundos...`);
          await new Promise(resolve => setTimeout(resolve, 3000));
          return loadRecommendationsWithRetry(attempt + 1);
        }
        
        // Se esgotar tentativas, mostrar erro
        showError(error.message || 'Erro de conex√£o. Verifique sua internet e tente novamente.');
        throw error;
      }
    }

    // Atualizar status da conex√£o
    function updateConnectionStatus(isOnline) {
      const statusEl = document.getElementById('connectionStatus');
      if (!statusEl) return;
      
      if (isOnline) {
        statusEl.innerHTML = `
          <div class="w-2 h-2 bg-success rounded-full animate-pulse"></div>
          <span class="text-sm text-gray-300">Online</span>
        `;
      } else {
        statusEl.innerHTML = `
          <div class="w-2 h-2 bg-danger rounded-full animate-pulse"></div>
          <span class="text-sm text-gray-300">Offline</span>
        `;
      }
    }

    // Verificar conex√£o
    async function checkConnection() {
      try {
        const response = await fetch('/api/auth/verify', {
          headers: { 'Authorization': `Bearer ${userToken}` },
          cache: 'no-cache'
        });
        updateConnectionStatus(response.ok);
      } catch (error) {
        updateConnectionStatus(false);
      }
    }

    // Display recommendations
    function displayRecommendations() {
      const container = document.getElementById('recommendationsContainer');
      
      if (!recommendations || recommendations.length === 0) {
        container.innerHTML = `
          <div class="col-span-2 text-center py-12">
            <i class="fas fa-inbox text-6xl text-gray-600 mb-4"></i>
            <p class="text-xl text-gray-400">Nenhuma recomenda√ß√£o ativa no momento</p>
            <p class="text-sm text-gray-500 mt-2">Novas recomenda√ß√µes s√£o geradas mensalmente</p>
            <button onclick="refreshRecommendations()" class="mt-4 retry-btn text-white px-6 py-3 rounded-lg font-medium">
              <i class="fas fa-sync mr-2"></i>Tentar Novamente
            </button>
          </div>
        `;
        return;
      }

      console.log('üé® Exibindo recomenda√ß√µes:', recommendations.length);
      container.innerHTML = recommendations.map(rec => createRecommendationCard(rec)).join('');
      
      // Carregar mini charts ap√≥s um pequeno delay
      setTimeout(loadMiniCharts, 100);
    }

    // Create recommendation card
    function createRecommendationCard(rec) {
      const isCompra = rec.action === 'COMPRA';
      const cardClass = isCompra ? 'buy-signal' : 'sell-signal';
      const actionIcon = isCompra ? 'fa-arrow-trend-up' : 'fa-arrow-trend-down';
      const actionColor = isCompra ? 'text-success' : 'text-danger';
      
      // Calculate metrics
      const currentPrice = rec.current_price || rec.entry_price;
      const performance = ((currentPrice - rec.entry_price) / rec.entry_price * 100);
      const potentialProfit = ((rec.target_price - rec.entry_price) / rec.entry_price * 100);
      const risk = Math.abs((rec.entry_price - rec.stop_loss) / rec.entry_price * 100);
      const riskReward = risk > 0 ? (Math.abs(potentialProfit) / risk) : 0;

      return `
        <div class="recommendation-card ${cardClass} rounded-xl p-6 fade-in cursor-pointer" onclick="showDetails('${rec.id}')">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-white/10 rounded-lg flex items-center justify-center">
                <i class="fas ${actionIcon} ${actionColor} text-xl"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold text-white">${rec.ticker}</h3>
                <p class="text-sm text-gray-400">${rec.company_name || 'A√ß√£o Brasileira'}</p>
              </div>
            </div>
            <div class="text-right">
              <span class="status-badge status-ativa">
                ${rec.action}
              </span>
              <div class="text-xs text-gray-400 mt-1">${formatDate(rec.created_at)}</div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <p class="text-sm text-gray-400">Pre√ßo Entrada</p>
              <p class="text-lg font-semibold text-white">R$ ${rec.entry_price.toFixed(2)}</p>
            </div>
            <div>
              <p class="text-sm text-gray-400">Pre√ßo Atual</p>
              <p class="text-lg font-semibold ${performance >= 0 ? 'text-success' : 'text-danger'}">
                R$ ${currentPrice.toFixed(2)}
              </p>
            </div>
            <div>
              <p class="text-sm text-gray-400">Alvo</p>
              <p class="text-lg font-semibold text-accent">R$ ${rec.target_price.toFixed(2)}</p>
            </div>
            <div>
              <p class="text-sm text-gray-400">Stop Loss</p>
              <p class="text-lg font-semibold text-warning">R$ ${rec.stop_loss.toFixed(2)}</p>
            </div>
          </div>

          <div class="flex items-center justify-between text-sm mb-4">
            <div class="flex items-center gap-4">
              <span class="text-gray-400">
                <i class="fas fa-chart-line mr-1"></i>
                Performance: <span class="${performance >= 0 ? 'text-success' : 'text-danger'} font-medium">
                  ${performance >= 0 ? '+' : ''}${performance.toFixed(2)}%
                </span>
              </span>
              <span class="text-gray-400">
                <i class="fas fa-target mr-1"></i>
                Potencial: <span class="${potentialProfit >= 0 ? 'text-success' : 'text-danger'} font-medium">
                  ${potentialProfit >= 0 ? '+' : ''}${potentialProfit.toFixed(2)}%
                </span>
              </span>
            </div>
          </div>

          <div class="flex items-center justify-between text-sm">
            <span class="text-gray-400">
              <i class="fas fa-shield-alt mr-1"></i>
              R/R: <span class="text-white font-medium">1:${riskReward.toFixed(1)}</span>
            </span>
            <span class="text-gray-400">
              <i class="fas fa-brain mr-1"></i>
              Confian√ßa: <span class="text-white font-medium">${rec.confidence || 85}%</span>
            </span>
          </div>

          <div class="mt-4 pt-4 border-t border-white/10">
            <canvas id="miniChart${rec.id}" height="80"></canvas>
          </div>
        </div>
      `;
    }

    // Load mini charts
    function loadMiniCharts() {
      recommendations.forEach(rec => {
        const canvas = document.getElementById(`miniChart${rec.id}`);
        if (canvas) {
          const ctx = canvas.getContext('2d');
          
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: ['', '', '', '', '', '', ''],
              datasets: [{
                data: generateMiniChartData(rec),
                borderColor: rec.action === 'COMPRA' ? '#10b981' : '#ef4444',
                borderWidth: 2,
                tension: 0.4,
                pointRadius: 0,
                fill: true,
                backgroundColor: rec.action === 'COMPRA' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
              },
              scales: {
                x: { display: false },
                y: { display: false }
              }
            }
          });
        }
      });
    }

    // Generate mini chart data
    function generateMiniChartData(rec) {
      const basePrice = rec.entry_price;
      const currentPrice = rec.current_price || rec.entry_price;
      const trend = rec.action === 'COMPRA' ? 1 : -1;
      const volatility = 0.015;
      
      return Array.from({length: 7}, (_, i) => {
        const progress = i / 6;
        const trendPrice = basePrice + ((currentPrice - basePrice) * progress);
        const randomFactor = (Math.random() - 0.5) * volatility * basePrice;
        return Math.max(0, trendPrice + randomFactor);
      });
    }

    // Show details modal
    function showDetails(recId) {
      const rec = recommendations.find(r => r.id == recId);
      if (!rec) return;

      const modal = document.getElementById('detailsModal');
      const content = document.getElementById('modalContent');

      const currentPrice = rec.current_price || rec.entry_price;
      const performance = ((currentPrice - rec.entry_price) / rec.entry_price * 100);
      const potentialProfit = ((rec.target_price - rec.entry_price) / rec.entry_price * 100);
      const distanceToTarget = ((rec.target_price - currentPrice) / currentPrice * 100);
      const distanceToStop = Math.abs((currentPrice - rec.stop_loss) / currentPrice * 100);

      content.innerHTML = `
        <div class="space-y-6">
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white/5 rounded-lg p-4">
              <p class="text-sm text-gray-400">Ativo</p>
              <p class="text-xl font-bold text-white">${rec.ticker}</p>
            </div>
            <div class="bg-white/5 rounded-lg p-4">
              <p class="text-sm text-gray-400">A√ß√£o</p>
              <p class="text-xl font-bold ${rec.action === 'COMPRA' ? 'text-success' : 'text-danger'}">${rec.action}</p>
            </div>
            <div class="bg-white/5 rounded-lg p-4">
              <p class="text-sm text-gray-400">Status</p>
              <p class="text-xl font-bold text-accent">${rec.status}</p>
            </div>
            <div class="bg-white/5 rounded-lg p-4">
              <p class="text-sm text-gray-400">Dura√ß√£o</p>
              <p class="text-xl font-bold text-white">${calculateDuration(rec.created_at)}</p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white/5 rounded-lg p-4">
              <h4 class="text-lg font-semibold text-white mb-3">Par√¢metros da Opera√ß√£o</h4>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-gray-400">Entrada:</span>
                  <span class="text-white font-medium">R$ ${rec.entry_price.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Alvo:</span>
                  <span class="text-accent font-medium">R$ ${rec.target_price.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Stop Loss:</span>
                  <span class="text-warning font-medium">R$ ${rec.stop_loss.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Confian√ßa:</span>
                  <span class="text-white font-medium">${rec.confidence || 85}%</span>
                </div>
              </div>
            </div>

            <div class="bg-white/5 rounded-lg p-4">
              <h4 class="text-lg font-semibold text-white mb-3">Performance Atual</h4>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-gray-400">Pre√ßo Atual:</span>
                  <span class="text-white font-medium">R$ ${currentPrice.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Performance:</span>
                  <span class="${performance >= 0 ? 'text-success' : 'text-danger'} font-medium">
                    ${performance >= 0 ? '+' : ''}${performance.toFixed(2)}%
                  </span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Dist. do Alvo:</span>
                  <span class="text-white font-medium">${distanceToTarget.toFixed(2)}%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Dist. do Stop:</span>
                  <span class="text-white font-medium">${distanceToStop.toFixed(2)}%</span>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white/5 rounded-lg p-4">
            <h4 class="text-lg font-semibold text-white mb-3">An√°lise da Recomenda√ß√£o</h4>
            <p class="text-gray-300">${rec.reason || 'Recomenda√ß√£o gerada por algoritmos de Machine Learning considerando padr√µes hist√≥ricos, momentum e indicadores t√©cnicos avan√ßados.'}</p>
          </div>
        </div>
      `;

      modal.classList.remove('hidden');
    }

    // Close modal
    function closeModal() {
      document.getElementById('detailsModal').classList.add('hidden');
    }

    // Update stats
    function updateStats() {
      const activeCount = recommendations.length;
      const buyCount = recommendations.filter(r => r.action === 'COMPRA').length;
      const sellCount = recommendations.filter(r => r.action === 'VENDA').length;
      
      document.getElementById('totalRecommendations').textContent = activeCount;
      document.getElementById('buySignals').textContent = buyCount;
      document.getElementById('sellSignals').textContent = sellCount;

      // Calculate success rate from all recommendations
      calculateSuccessRate();
    }

    // Calculate success rate
    function calculateSuccessRate() {
      try {
        const closedRecs = allRecommendations.filter(r => r.status && r.status.startsWith('FINALIZADA'));
        const wins = closedRecs.filter(r => r.status === 'FINALIZADA_GANHO');
        const losses = closedRecs.filter(r => r.status === 'FINALIZADA_PERDA');
        
        const successRate = closedRecs.length > 0 ? (wins.length / closedRecs.length * 100) : 0;
        const avgGain = wins.length > 0 ? wins.reduce((sum, r) => sum + (r.performance || 0), 0) / wins.length : 0;
        const avgLoss = losses.length > 0 ? losses.reduce((sum, r) => sum + (r.performance || 0), 0) / losses.length : 0;
        const profitFactor = Math.abs(avgLoss) > 0 ? Math.abs(avgGain / avgLoss) : 0;
        
        // Update UI
        document.getElementById('successRate').textContent = `${successRate.toFixed(1)}%`;
        document.getElementById('closedRecommendations').textContent = closedRecs.length;
        document.getElementById('avgGain').textContent = `+${Math.abs(avgGain).toFixed(2)}%`;
        document.getElementById('avgLoss').textContent = `${avgLoss.toFixed(2)}%`;
        document.getElementById('profitFactor').textContent = profitFactor.toFixed(2);
        
        // Best performance
        if (wins.length > 0) {
          const bestWin = wins.reduce((best, current) => 
            (current.performance || 0) > (best.performance || 0) ? current : best
          );
          
          document.getElementById('bestPerformance').innerHTML = `
            <div class="text-2xl font-bold text-success">${bestWin.ticker}</div>
            <div class="text-lg text-success">+${(bestWin.performance || 0).toFixed(2)}%</div>
            <div class="text-sm text-gray-400">${formatDate(bestWin.created_at)}</div>
          `;
        }
      } catch (error) {
        console.error('Erro ao calcular estat√≠sticas:', error);
      }
    }

    // Initialize performance chart
    function initPerformanceChart() {
      const ctx = document.getElementById('performanceChart').getContext('2d');
      
      performanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Performance (%)',
            data: [],
            backgroundColor: [],
            borderColor: [],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              ticks: { color: '#9ca3af' }
            },
            y: {
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              ticks: { 
                color: '#9ca3af',
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          }
        }
      });
    }

    // Update performance chart
    function updatePerformanceChart() {
      try {
        // Filter closed recommendations with performance data
        const closedRecs = allRecommendations.filter(r => 
          r.status && r.status.startsWith('FINALIZADA') && r.performance !== undefined
        );
        
        // Get the most recent 10
        const recentClosed = closedRecs.slice(-10);
        
        if (recentClosed.length > 0) {
          performanceChart.data.labels = recentClosed.map(d => d.ticker);
          performanceChart.data.datasets[0].data = recentClosed.map(d => d.performance || 0);
          performanceChart.data.datasets[0].backgroundColor = recentClosed.map(d => 
            (d.performance || 0) >= 0 ? 'rgba(16, 185, 129, 0.6)' : 'rgba(239, 68, 68, 0.6)'
          );
          performanceChart.data.datasets[0].borderColor = recentClosed.map(d => 
            (d.performance || 0) >= 0 ? '#10b981' : '#ef4444'
          );
        }
        
        performanceChart.update();
      } catch (error) {
        console.error('Erro ao atualizar gr√°fico de performance:', error);
      }
    }

    // Update timers
    function updateTimers() {
      const now = new Date();
      const lastUpdate = new Date(now.getFullYear(), now.getMonth(), 1); // First day of month
      const nextUpdate = new Date(now.getFullYear(), now.getMonth() + 1, 1); // First day of next month
      
      document.getElementById('lastUpdate').textContent = formatDate(lastUpdate);
      
      const daysUntilNext = Math.ceil((nextUpdate - now) / (1000 * 60 * 60 * 24));
      document.getElementById('nextUpdate').textContent = `${daysUntilNext} dias`;
    }

    // Refresh recommendations with better error handling
    async function refreshRecommendations() {
      const btn = event.target.closest('button');
      const originalText = btn.innerHTML;
      
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Atualizando...';
      
      try {
        retryCount = 0;
        await loadRecommendationsWithRetry();
        
        // Show success feedback
        btn.innerHTML = '<i class="fas fa-check mr-2"></i>Atualizado!';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 2000);
        
      } catch (error) {
        console.error('Erro ao atualizar:', error);
        btn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Erro';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 3000);
      }
    }

    // Show global error
    function showGlobalError(message) {
      const container = document.getElementById('recommendationsContainer');
      container.innerHTML = `
        <div class="col-span-2 error-card rounded-xl p-8 text-center">
          <i class="fas fa-exclamation-triangle text-6xl text-danger mb-4"></i>
          <h3 class="text-xl font-bold text-white mb-2">Erro de Conex√£o</h3>
          <p class="text-gray-300 mb-4">${message}</p>
          <div class="space-y-2 text-sm text-gray-400 mb-6">
            <p>‚Ä¢ Verifique sua conex√£o com a internet</p>
            <p>‚Ä¢ O servidor pode estar temporariamente indispon√≠vel</p>
            <p>‚Ä¢ Sua sess√£o pode ter expirado</p>
          </div>
          <div class="flex gap-4 justify-center">
            <button onclick="refreshRecommendations()" class="retry-btn text-white px-6 py-3 rounded-lg font-medium">
              <i class="fas fa-sync mr-2"></i>Tentar Novamente
            </button>
            <button onclick="window.location.reload()" class="bg-gray-600 hover:bg-gray-500 text-white px-6 py-3 rounded-lg font-medium">
              <i class="fas fa-refresh mr-2"></i>Recarregar P√°gina
            </button>
          </div>
        </div>
      `;
    }

    // Show error
    function showError(message = 'Erro ao carregar recomenda√ß√µes') {
      const container = document.getElementById('recommendationsContainer');
      container.innerHTML = `
        <div class="col-span-2 text-center py-12">
          <i class="fas fa-exclamation-triangle text-6xl text-danger mb-4"></i>
          <p class="text-xl text-gray-400">${message}</p>
          <p class="text-sm text-gray-500 mt-2">Verifique sua conex√£o e tente novamente</p>
          <button onclick="refreshRecommendations()" class="mt-4 retry-btn text-white px-6 py-2 rounded-lg">
            <i class="fas fa-sync mr-2"></i>Tentar Novamente
          </button>
        </div>
      `;
    }

    // Format date
    function formatDate(dateString) {
      if (!dateString) return '--';
      return new Date(dateString).toLocaleDateString('pt-BR');
    }

    // Calculate duration
    function calculateDuration(startDate) {
      if (!startDate) return '--';
      const start = new Date(startDate);
      const now = new Date();
      const days = Math.floor((now - start) / (1000 * 60 * 60 * 24));
      return `${days} dias`;
    }

    // Logout
    function logout() {
      localStorage.removeItem('geminii_token');
      localStorage.removeItem('geminii_user');
      window.location.href = '/';
    }

    // Enhanced error logging for debugging
    window.debugInfo = function() {
      console.log('üîç Debug Info:');
      console.log('Token:', userToken ? 'Present' : 'Missing');
      console.log('User:', currentUser);
      console.log('Recommendations:', recommendations.length);
      console.log('All Recommendations:', allRecommendations.length);
      console.log('Retry Count:', retryCount);
    };

    // Test connection function
    window.testConnection = async function() {
      console.log('üß™ Testando conex√£o...');
      try {
        const response = await fetch('/api/recommendations/admin/all', {
          headers: { 
            'Authorization': `Bearer ${userToken}`,
            'Content-Type': 'application/json'
          }
        });
        console.log('Status:', response.status);
        console.log('Headers:', [...response.headers.entries()]);
        const data = await response.json();
        console.log('Data:', data);
      } catch (error) {
        console.error('Erro:', error);
      }
    };

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üìÑ DOM carregado - inicializando...');
      init();
    });

    // Backup initialization
    window.addEventListener('load', function() {
      console.log('üéØ Window loaded - verificando inicializa√ß√£o...');
      if (!userToken) {
        init();
      }
    });

    // Handle online/offline events
    window.addEventListener('online', function() {
      console.log('üåê Conex√£o restaurada');
      updateConnectionStatus(true);
      refreshRecommendations();
    });

    window.addEventListener('offline', function() {
      console.log('üì° Conex√£o perdida');
      updateConnectionStatus(false);
    });
  </script>
</body>
</html>