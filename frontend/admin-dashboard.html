<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            geminii: '#ba39af'
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
    }
    
    .admin-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      transition: all 0.3s ease;
    }
    
    .admin-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(186, 57, 175, 0.15);
      border-color: rgba(186, 57, 175, 0.3);
    }
    
    .stat-card {
      background: linear-gradient(135deg, rgba(186, 57, 175, 0.1), rgba(217, 70, 239, 0.05));
      border: 1px solid rgba(186, 57, 175, 0.2);
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, #ba39af, #d946ef);
    }
    
    .action-btn {
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .action-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }
    
    .sidebar {
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .nav-item {
      transition: all 0.3s ease;
      border-radius: 8px;
      margin: 4px 0;
    }
    
    .nav-item:hover, .nav-item.active {
      background: rgba(186, 57, 175, 0.2);
      border-color: rgba(186, 57, 175, 0.3);
    }
    
    .table-row {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    
    .table-row:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .spinner {
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 2px solid #ba39af;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

  </style>
</head>
<body class="bg-black text-white min-h-screen">
  
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <div class="sidebar w-64 p-6">
      <div class="mb-8">
        <h1 class="text-2xl font-bold text-geminii">
          <i class="fas fa-crown mr-2"></i>
          Admin Panel
        </h1>
        <p class="text-gray-400 text-sm">Geminii Tech</p>
      </div>
      
      <nav class="space-y-2">
        <a href="#dashboard" class="nav-item active flex items-center p-3 text-white border border-transparent" onclick="showSection('dashboard')">
          <i class="fas fa-tachometer-alt mr-3"></i>
          Dashboard
        </a>
        <a href="#users" class="nav-item flex items-center p-3 text-gray-300 border border-transparent" onclick="showSection('users')">
          <i class="fas fa-users mr-3"></i>
          Usuários
        </a>
        <a href="#recommendationsFree" class="nav-item flex items-center p-3 text-gray-300 border border-transparent" onclick="showSection('recommendationsFree')">
          <i class="fas fa-gift mr-3"></i>
          Recomendações Free
        </a>
      </nav>
      
      <div class="mt-auto pt-8">
        <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 py-2 px-4 rounded-lg text-sm font-medium">
          <i class="fas fa-sign-out-alt mr-2"></i>
          Sair
        </button>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="flex-1 p-6">
      
      <!-- Header -->
      <div class="flex items-center justify-between mb-8">
        <div>
          <h2 class="text-3xl font-bold text-white" id="sectionTitle">Dashboard</h2>
          <p class="text-gray-400" id="sectionSubtitle">Visão geral do sistema</p>
        </div>
        <div class="flex items-center space-x-4">
          <div class="text-sm text-gray-400">
            <i class="fas fa-user-shield mr-1"></i>
            <span id="adminName">Admin</span>
          </div>
          <div id="apiStatus" class="w-8 h-8 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-full flex items-center justify-center">
            <i class="fas fa-shield-alt text-green-500 text-xs"></i>
          </div>
        </div>
      </div>
      
      <!-- Dashboard Section -->
      <div id="dashboardSection" class="section">
        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="admin-card stat-card p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-400">Total Usuários</p>
                <p class="text-2xl font-bold text-white" id="totalUsers">0</p>
              </div>
              <div class="w-12 h-12 bg-blue-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                <i class="fas fa-users text-blue-500"></i>
              </div>
            </div>
          </div>
          
          <div class="admin-card stat-card p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-400">Assinantes Premium</p>
                <p class="text-2xl font-bold text-green-400" id="premiumUsers">0</p>
              </div>
              <div class="w-12 h-12 bg-green-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                <i class="fas fa-crown text-green-500"></i>
              </div>
            </div>
          </div>
          
          <div class="admin-card stat-card p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-400">Recomendações Ativas</p>
                <p class="text-2xl font-bold text-yellow-400" id="activeRecommendations">0</p>
              </div>
              <div class="w-12 h-12 bg-yellow-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                <i class="fas fa-gift text-yellow-500"></i>
              </div>
            </div>
          </div>
          
          <div class="admin-card stat-card p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-400">Taxa de Sucesso</p>
                <p class="text-2xl font-bold text-purple-400" id="successRate">0%</p>
              </div>
              <div class="w-12 h-12 bg-purple-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                <i class="fas fa-chart-line text-purple-500"></i>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="admin-card p-6">
          <h3 class="text-xl font-bold text-white mb-4">
            <i class="fas fa-clock mr-2"></i>
            Atividade Recente
          </h3>
          <div id="recentActivity" class="space-y-3">
            <!-- Activity items will be loaded here -->
          </div>
        </div>
      </div>
      
      
    <!-- Users Section -->
    <div id="usersSection" class="section hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Lista de Usuários -->
        <div class="lg:col-span-2">
          <div class="admin-card p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-white">
                <i class="fas fa-users mr-2"></i>
                Lista de Usuários
              </h3>
              <button onclick="loadUsersEnhanced()" class="bg-blue-600 hover:bg-blue-700 py-2 px-4 rounded-lg text-sm">
                <i class="fas fa-sync mr-1"></i>
                Atualizar
              </button>
            </div>

            <div class="overflow-x-auto">
              <!-- Substitua a tabela de usuários por esta versão LIMPA: -->
              <table class="w-full">
                <thead>
                  <tr class="text-left border-b border-gray-600">
                    <th class="py-3 px-2 text-gray-400">Usuário</th>
                    <th class="py-3 px-2 text-gray-400">Plano</th>
                    <th class="py-3 px-2 text-gray-400">Status</th>
                    <th class="py-3 px-2 text-gray-400">Tempo</th>
                    <th class="py-3 px-2 text-gray-400">Ações</th>
                  </tr>
                </thead>
                <tbody id="usersTableEnhanced">
                  <tr>
                    <td colspan="5" class="text-center py-8">
                      <div class="spinner mx-auto mb-2"></div>
                      <p class="text-gray-400">Carregando usuários...</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Painel de Controle -->
        <div class="space-y-6">
          
          <!-- Criar Novo Usuário -->
          <div class="admin-card p-6">
            <h3 class="text-lg font-bold text-white mb-4">
              <i class="fas fa-user-plus mr-2"></i>
              Criar Novo Usuário
            </h3>
          
            <div class="space-y-4">
              <div>
                <label class="block text-sm text-gray-300 mb-1">Nome Completo</label>
                <input type="text" id="newUserName" 
                      class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm"
                      placeholder="João Silva">
              </div>
              
              <div>
                <label class="block text-sm text-gray-300 mb-1">Email</label>
                <input type="email" id="newUserEmail" 
                      class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm"
                      placeholder="joao@email.com">
              </div>
              
              <div>
                <label class="block text-sm text-gray-300 mb-1">Trial Inicial</label>
                <select id="newUserTrialDays" class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm">
                  <option value="3">3 dias</option>
                  <option value="7" selected>7 dias</option>
                  <option value="14">14 dias</option>
                  <option value="30">30 dias</option>
                </select>
              </div>
              
              <div class="bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded-lg p-3">
                <div class="flex items-center mb-2">
                  <i class="fas fa-info-circle text-yellow-400 mr-2"></i>
                  <span class="text-yellow-400 text-sm font-medium">Informação Importante</span>
                </div>
                <p class="text-yellow-200 text-xs">
                  Senha padrão: <strong>123456</strong><br>
                  O usuário deve alterar após primeiro login
                </p>
              </div>
              
              <button onclick="createNewUser()" class="action-btn w-full bg-geminii hover:bg-purple-700 py-2 px-4 rounded-lg text-sm font-medium">
                <i class="fas fa-user-plus mr-1"></i>
                Criar Usuário em Trial
              </button>
            </div>
          </div>

          <!-- Gerenciar Usuário Existente -->
          <div class="admin-card p-6">
            <h3 class="text-lg font-bold text-white mb-4">
              <i class="fas fa-user-cog mr-2"></i>
              Gerenciar Usuário
            </h3>
          
            <div class="space-y-4">
              <div>
                <label class="block text-sm text-gray-300 mb-1">E-mail do Usuário</label>
                <input type="email" id="manageUserEmail" 
                      class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm"
                      placeholder="usuario@email.com">
              </div>
          
              <div>
                <label class="block text-sm text-gray-300 mb-1">Novo Plano</label>
                <select id="newPlanId" class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm">
                  <option value="3">Free</option>
                  <option value="4">Community</option>
                </select>
              </div>
          
              <div class="flex flex-col gap-2">
                <button onclick="grantSubscription()" class="action-btn bg-green-600 hover:bg-green-700 py-2 px-4 rounded-lg text-sm font-medium">
                  <i class="fas fa-plus mr-1"></i>
                  Dar Assinatura
                </button>
                <button onclick="removeUserPlan()" class="action-btn bg-orange-600 hover:bg-orange-700 py-2 px-4 rounded-lg text-sm font-medium">
                  <i class="fas fa-minus mr-1"></i>
                  Remover Assinatura
                </button>
                <button onclick="promoteToAdmin()" class="action-btn bg-purple-600 hover:bg-purple-700 py-2 px-4 rounded-lg text-sm font-medium">
                  <i class="fas fa-crown mr-1"></i>
                  Promover a Admin
                </button>
                <button onclick="deleteUser()" class="action-btn bg-red-600 hover:bg-red-700 py-2 px-4 rounded-lg text-sm font-medium">
                  <i class="fas fa-trash mr-1"></i>
                  Remover Usuário
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

      <!-- Recommendations Free Section -->
      <div id="recommendationsFreeSection" class="section hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          
          <!-- Lista de Recomendações -->
          <div class="lg:col-span-2">
            <div class="admin-card p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-white">
                  <i class="fas fa-gift mr-2"></i>
                  Recomendações Free Mensais
                </h3>
                <div class="flex gap-2">
                  <button onclick="updateAllPrices()" class="bg-blue-600 hover:bg-blue-700 py-2 px-4 rounded-lg text-sm">
                    <i class="fas fa-sync mr-1"></i>
                    Atualizar Preços
                  </button>
                  <button onclick="generateMonthlyRecommendations()" class="bg-green-600 hover:bg-green-700 py-2 px-4 rounded-lg text-sm">
                    <i class="fas fa-robot mr-1"></i>
                    Gerar Mensais
                  </button>
                </div>
              </div>

              <div id="recommendationsList" class="space-y-3">
                <div class="text-center py-4 text-gray-400">
                  <div class="spinner mx-auto mb-2"></div>
                  <p class="text-sm">Carregando recomendações...</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Criar Recomendação -->
          <div>
            <div class="admin-card p-6">
              <h3 class="text-lg font-bold text-white mb-4">
                <i class="fas fa-plus mr-2"></i>
                Nova Recomendação
              </h3>
              
              <form id="recommendationFreeForm" class="space-y-4">
                <div>
                  <label class="block text-sm text-gray-300 mb-1">Ticker</label>
                  <input type="text" id="recFreeTicker" required
                        class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm"
                        placeholder="PETR4">
                </div>
                
                <div>
                  <label class="block text-sm text-gray-300 mb-1">Ação</label>
                  <select id="recFreeAction" required class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm">
                    <option value="">Selecione...</option>
                    <option value="COMPRA">Compra</option>
                    <option value="VENDA">Venda</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm text-gray-300 mb-1">Preço de Entrada (R$)</label>
                  <input type="number" id="recFreeEntryPrice" required min="0" step="0.01"
                        class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm"
                        placeholder="35.50">
                </div>
                
                <div>
                  <label class="block text-sm text-gray-300 mb-1">Stop Loss (R$)</label>
                  <input type="number" id="recFreeStopLoss" required min="0" step="0.01"
                        class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm"
                        placeholder="33.00">
                </div>
                
                <div>
                  <label class="block text-sm text-gray-300 mb-1">Alvo (R$)</label>
                  <input type="number" id="recFreeTargetPrice" required min="0" step="0.01"
                        class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm"
                        placeholder="40.00">
                </div>
                
                <div>
                  <label class="block text-sm text-gray-300 mb-1">Confiança (%)</label>
                  <input type="number" id="recFreeConfidence" min="0" max="100" step="1" value="85"
                        class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm">
                </div>
                
                <button type="button" onclick="createRecommendationFree()" class="action-btn w-full bg-geminii hover:bg-purple-700 py-2 px-4 rounded-lg text-sm font-medium">
                  <i class="fas fa-plus mr-1"></i>
                  Criar Recomendação
                </button>
              </form>
            </div>

            <!-- Estatísticas -->
            <div class="admin-card p-6 mt-6">
              <h3 class="text-lg font-bold text-white mb-4">
                <i class="fas fa-chart-line mr-2"></i>
                Estatísticas
              </h3>
              
              <div id="recommendationsStats" class="space-y-3">
                <div class="flex justify-between">
                  <span class="text-gray-400">Total:</span>
                  <span class="text-white font-medium" id="recStatsTotal">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Ativas:</span>
                  <span class="text-green-400 font-medium" id="recStatsActive">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Finalizadas:</span>
                  <span class="text-gray-300 font-medium" id="recStatsClosed">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Taxa de Acerto:</span>
                  <span class="text-yellow-400 font-medium" id="recStatsSuccess">0%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Ganho Médio:</span>
                  <span class="text-green-400 font-medium" id="recStatsAvgGain">+0%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Perda Média:</span>
                  <span class="text-red-400 font-medium" id="recStatsAvgLoss">-0%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    let adminToken = null;
    let currentUser = null;

    // Check admin authentication
    async function checkAdminAuth() {
      const token = localStorage.getItem('geminii_token');
      const userData = localStorage.getItem('geminii_user');

      if (!token || !userData) {
        window.location.href = '/login.html';
        return;
      }

      try {
        const response = await fetch('/auth/verify', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const result = await response.json();

        if (result.success) {
          currentUser = result.data.user;
          adminToken = token;
          
          // Check if user is admin
          const isAdmin = currentUser.user_type === 'admin' || currentUser.user_type === 'master';
          
          if (!isAdmin) {
            alert(' Acesso negado! Você não tem privilégios de administrador.');
            window.location.href = '/dashboard.html';
            return;
          }
          
          // Update UI with admin info
          document.getElementById('adminName').textContent = currentUser.name;
          
        } else {
          localStorage.removeItem('geminii_token');
          localStorage.removeItem('geminii_user');
          window.location.href = '/login.html';
        }

      } catch (error) {
        console.error('Auth check failed:', error);
        window.location.href = '/login.html';
      }
    }

    // Load dashboard statistics
    async function loadDashboardStats() {
      try {
        const response = await fetch('/api/admin/stats', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            const stats = result.data;
            
            document.getElementById('totalUsers').textContent = stats.total_users || 0;
            document.getElementById('premiumUsers').textContent = stats.premium_users || 0;
            document.getElementById('activeRecommendations').textContent = stats.active_recommendations || 0;
            document.getElementById('successRate').textContent = `${stats.success_rate || 0}%`;
          }
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load recent activity
    async function loadRecentActivity() {
      try {
        const response = await fetch('/api/admin/recent-activity', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            displayRecentActivity(result.activities);
            return;
          }
        }

        // Fallback to mock data
        displayMockActivity();
        
      } catch (error) {
        console.log('Using mock activity data');
        displayMockActivity();
      }
    }

    function displayRecentActivity(activities) {
      const container = document.getElementById('recentActivity');
      
      if (!activities || activities.length === 0) {
        container.innerHTML = `
          <div class="text-center py-6 text-gray-400">
            <i class="fas fa-clock text-2xl mb-2"></i>
            <p>Nenhuma atividade recente</p>
          </div>
        `;
        return;
      }

      container.innerHTML = activities.map(activity => `
        <div class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 hover:bg-opacity-30 transition-colors">
          <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
            <i class="${activity.icon} text-sm ${activity.color}"></i>
          </div>
          <div class="flex-1">
            <p class="text-sm text-white">${activity.message}</p>
            <p class="text-xs text-gray-400">${activity.time}</p>
          </div>
        </div>
      `).join('');
    }

    function displayMockActivity() {
      const mockActivities = [
        { icon: 'fas fa-user-plus', color: 'text-green-400', message: 'Novo usuário registrado', time: 'há 5 minutos' },
        { icon: 'fas fa-crown', color: 'text-yellow-400', message: 'Assinatura Premium ativada', time: 'há 15 minutos' },
        { icon: 'fas fa-chart-line', color: 'text-blue-400', message: 'Nova recomendação criada', time: 'há 1 hora' },
        { icon: 'fas fa-sync', color: 'text-purple-400', message: 'Preços atualizados', time: 'há 2 horas' }
      ];
      displayRecentActivity(mockActivities);
    }
    
    // Show section
    function showSection(sectionName) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
      });
      
      // Show selected section
      document.getElementById(sectionName + 'Section').classList.remove('hidden');
      
      // Update navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      event.target.closest('.nav-item').classList.add('active');
      
      // Update title
      const titles = {
        dashboard: { title: 'Dashboard', subtitle: 'Visão geral do sistema' },
        users: { title: 'Usuários', subtitle: 'Gerenciar usuários e assinaturas' },
        recommendationsFree: { title: 'Recomendações Free', subtitle: 'Recomendações gratuitas mensais' }
      };
      
      document.getElementById('sectionTitle').textContent = titles[sectionName].title;
      document.getElementById('sectionSubtitle').textContent = titles[sectionName].subtitle;
      
      // Load section data
      if (sectionName === 'users') loadUsers();
      if (sectionName === 'recommendationsFree') loadRecommendationsFree();
    }

    // ===== USER MANAGEMENT =====

    // Load users
    async function loadUsers() {
      try {
        const response = await fetch('/api/admin/list-users', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            displayUsers(result.users);
          }
        }
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    function displayUsers(users) {
      const tbody = document.getElementById('usersTable');
      
      if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-400">Nenhum usuário encontrado</td></tr>';
        return;
      }

      tbody.innerHTML = users.map(user => `
        <tr class="table-row">
          <td class="py-3 px-2">
            <div class="font-medium text-white">${user.name}</div>
            <div class="text-xs text-gray-400">${user.formatted_date || 'N/A'}</div>
          </td>
          <td class="py-3 px-2 text-gray-300">${user.email}</td>
          <td class="py-3 px-2">
            <span class="px-2 py-1 rounded text-xs font-medium ${getPlanBadgeClass(user.plan)}">
              ${user.plan}
            </span>
          </td>
          <td class="py-3 px-2">
            <span class="px-2 py-1 rounded text-xs font-medium ${getTypeBadgeClass(user.type)}">
              ${user.type || 'regular'}
            </span>
          </td>
          <td class="py-3 px-2">
            <button onclick="fillUserEmail('${user.email}')" class="text-blue-400 hover:text-blue-300 text-sm">
              <i class="fas fa-edit mr-1"></i>Editar
            </button>
          </td>
        </tr>
      `).join('');
    }

    function getPlanBadgeClass(plan) {
      const classes = {
        'Básico': 'bg-gray-600 text-gray-200',
        'Pro': 'bg-yellow-600 text-yellow-200',
        'Premium': 'bg-purple-600 text-purple-200'
      };
      return classes[plan] || 'bg-gray-600 text-gray-200';
    }

    function getTypeBadgeClass(type) {
      const classes = {
        'admin': 'bg-red-600 text-red-200',
        'master': 'bg-orange-600 text-orange-200',
        'regular': 'bg-gray-600 text-gray-200'
      };
      return classes[type] || 'bg-gray-600 text-gray-200';
    }

    // Fill user email in form
    function fillUserEmail(email) {
      document.getElementById('manageUserEmail').value = email;
    }

    // Grant subscription
    async function grantSubscription() {
      const email = document.getElementById('manageUserEmail').value;
      const planId = document.getElementById('newPlanId').value;
      
      if (!email) {
        alert('Digite o e-mail do usuário');
        return;
      }
      
      try {
        const response = await fetch('/api/admin/manage-subscription', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({
            user_email: email,
            action: 'grant',
            plan_id: parseInt(planId)
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' ' + result.message);
          document.getElementById('manageUserEmail').value = '';
          loadUsers();
          loadDashboardStats();
        } else {
          alert(' ' + result.error);
        }
        
      } catch (error) {
        alert(' Erro de conexão');
      }
    }

    // Remove user plan
    async function removeUserPlan() {
      const email = document.getElementById('manageUserEmail').value;
      
      if (!email) {
        alert('Digite o e-mail do usuário');
        return;
      }
      
      if (!confirm(`Remover assinatura de ${email}?`)) return;
      
      try {
        const response = await fetch('/api/admin/manage-subscription', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({
            user_email: email,
            action: 'revoke'
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' ' + result.message);
          document.getElementById('manageUserEmail').value = '';
          loadUsers();
          loadDashboardStats();
        } else {
          alert(' ' + result.error);
        }
        
      } catch (error) {
        alert(' Erro de conexão');
      }
    }

    // Promote to admin
    async function promoteToAdmin() {
      const email = document.getElementById('manageUserEmail').value;
      
      if (!email) {
        alert('Digite o e-mail do usuário');
        return;
      }
      
      if (!confirm(`Promover ${email} a administrador?`)) return;
      
      try {
        const response = await fetch('/api/admin/promote-user', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({
            user_email: email,
            user_type: 'admin'
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' ' + result.message);
          document.getElementById('manageUserEmail').value = '';
          loadUsers();
        } else {
          alert(' ' + result.error);
        }
        
      } catch (error) {
        alert(' Erro de conexão');
      }
    }

    // Delete user
    async function deleteUser() {
      const email = document.getElementById('manageUserEmail').value;
      
      if (!email) {
        alert('Digite o e-mail do usuário');
        return;
      }
      
      if (!confirm(`⚠️ ATENÇÃO: Remover usuário ${email}?\n\nEsta ação marcará o usuário como removido.\nDeseja continuar?`)) {
        return;
      }
      
      try {
        const response = await fetch('/api/admin/users/delete', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ email: email })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' ' + result.message);
          document.getElementById('manageUserEmail').value = '';
          loadUsers();
          loadDashboardStats();
        } else {
          alert(' ' + result.error);
        }
        
      } catch (error) {
        console.error('Error deleting user:', error);
        alert(' Erro de conexão');
      }
    }

    // ===== RECOMMENDATIONS FREE =====

    // Load recommendations
    async function loadRecommendationsFree() {
      try {
        const response = await fetch('/api/recommendations/admin/all', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            displayRecommendationsFree(result.recommendations);
            updateRecommendationsStats(result.recommendations);
          }
        }
      } catch (error) {
        console.error('Error loading recommendations:', error);
      }
    }

    // Display recommendations
    function displayRecommendationsFree(recommendations) {
      const container = document.getElementById('recommendationsList');
      
      if (!recommendations || recommendations.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-gift text-4xl text-gray-600 mb-4"></i>
            <p class="text-gray-400 text-lg mb-2">Nenhuma recomendação encontrada</p>
            <p class="text-gray-500 text-sm">Crie novas recomendações ou gere automaticamente</p>
          </div>
        `;
        return;
      }

      container.innerHTML = recommendations.map(rec => {
        const isCompra = rec.action === 'COMPRA';
        const statusColor = getStatusColor(rec.status);
        const statusText = getStatusText(rec.status);
        
        return `
          <div class="border border-gray-600 rounded-lg p-4 hover:border-geminii transition-all duration-300">
            <!-- Header da Recomendação -->
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-lg flex items-center justify-center ${isCompra ? 'bg-green-600' : 'bg-red-600'}">
                  <i class="fas ${isCompra ? 'fa-arrow-up' : 'fa-arrow-down'} text-white text-lg"></i>
                </div>
                <div>
                  <h4 class="text-xl font-bold text-white">${rec.ticker}</h4>
                  <p class="text-sm text-gray-400">${rec.company_name || 'N/A'}</p>
                </div>
              </div>
              <div class="text-right">
                <span class="px-3 py-1 rounded-full text-xs font-medium ${statusColor}">${statusText}</span>
                <div class="text-xs text-gray-400 mt-1">${formatDate(rec.created_at)}</div>
              </div>
            </div>
            
            <!-- Grid de Preços -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm mb-4">
              <div class="text-center bg-gray-800 bg-opacity-30 rounded-lg p-3">
                <div class="text-xs text-gray-400 mb-1">Entrada</div>
                <div class="font-bold text-blue-400">R$ ${rec.entry_price.toFixed(2)}</div>
              </div>
              <div class="text-center bg-gray-800 bg-opacity-30 rounded-lg p-3">
                <div class="text-xs text-gray-400 mb-1">Atual</div>
                <div class="font-bold text-white">R$ ${rec.current_price.toFixed(2)}</div>
              </div>
              <div class="text-center bg-gray-800 bg-opacity-30 rounded-lg p-3">
                <div class="text-xs text-gray-400 mb-1">Alvo</div>
                <div class="font-bold text-green-400">R$ ${rec.target_price.toFixed(2)}</div>
              </div>
              <div class="text-center bg-gray-800 bg-opacity-30 rounded-lg p-3">
                <div class="text-xs text-gray-400 mb-1">Stop</div>
                <div class="font-bold text-red-400">R$ ${rec.stop_loss.toFixed(2)}</div>
              </div>
            </div>
            
            <!-- Performance -->
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-4 text-sm">
                <div class="flex items-center gap-2">
                  <span class="text-gray-400">Performance:</span>
                  <span class="font-bold ${rec.performance >= 0 ? 'text-green-400' : 'text-red-400'}">
                    ${rec.performance >= 0 ? '+' : ''}${rec.performance.toFixed(2)}%
                  </span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-gray-400">Confiança:</span>
                  <span class="font-bold text-white">${rec.confidence}%</span>
                </div>
              </div>
            </div>
            
            <!-- Ações -->
            <div class="flex items-center justify-between pt-3 border-t border-gray-700">
              <div class="text-xs text-gray-500">
                ID: ${rec.id} | Criado: ${formatDate(rec.created_at)}
              </div>
              <div class="flex gap-2">
                ${rec.status === 'ATIVA' ? `
                  <button onclick="closeRecommendationFree(${rec.id})" 
                          class="bg-orange-600 hover:bg-orange-700 px-3 py-1 rounded text-xs font-medium transition-colors">
                    <i class="fas fa-times mr-1"></i>Encerrar
                  </button>
                ` : ''}
                <button onclick="deleteRecommendationFree(${rec.id})" 
                        class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-xs font-medium transition-colors">
                  <i class="fas fa-trash mr-1"></i>Remover
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function getStatusColor(status) {
      const colors = {
        'ATIVA': 'bg-green-600 text-green-200',
        'FINALIZADA_GANHO': 'bg-blue-600 text-blue-200', 
        'FINALIZADA_PERDA': 'bg-red-600 text-red-200',
        'FINALIZADA_MANUAL': 'bg-gray-600 text-gray-200'
      };
      return colors[status] || 'bg-gray-600 text-gray-200';
    }
    
    function getStatusText(status) {
      const texts = {
        'ATIVA': 'Ativa',
        'FINALIZADA_GANHO': 'Ganho',
        'FINALIZADA_PERDA': 'Perda', 
        'FINALIZADA_MANUAL': 'Manual'
      };
      return texts[status] || status;
    }
    
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      return new Date(dateString).toLocaleDateString('pt-BR');
    }

    // Update statistics
    function updateRecommendationsStats(recommendations) {
      const total = recommendations.length;
      const active = recommendations.filter(r => r.status === 'ATIVA').length;
      const closed = recommendations.filter(r => r.status.startsWith('FINALIZADA')).length;
      const wins = recommendations.filter(r => r.status === 'FINALIZADA_GANHO').length;
      
      const successRate = closed > 0 ? (wins / closed * 100) : 0;
      
      const gains = recommendations
        .filter(r => r.status === 'FINALIZADA_GANHO')
        .map(r => r.performance);
      const avgGain = gains.length > 0 ? gains.reduce((a, b) => a + b, 0) / gains.length : 0;
      
      const losses = recommendations
        .filter(r => r.status === 'FINALIZADA_PERDA')
        .map(r => r.performance);
      const avgLoss = losses.length > 0 ? losses.reduce((a, b) => a + b, 0) / losses.length : 0;
      
      // Update elements
      document.getElementById('recStatsTotal').textContent = total;
      document.getElementById('recStatsActive').textContent = active;
      document.getElementById('recStatsClosed').textContent = closed;
      document.getElementById('recStatsSuccess').textContent = `${successRate.toFixed(1)}%`;
      document.getElementById('recStatsAvgGain').textContent = `+${avgGain.toFixed(2)}%`;
      document.getElementById('recStatsAvgLoss').textContent = `${avgLoss.toFixed(2)}%`;
    }


    // Adicione estas funções no seu script

    // Timer utilities
  
    function formatTimeWithUs(days) {
      if (days < 1) return 'Hoje';
      if (days === 1) return '1 dia';
      if (days < 30) return `${days} dias`;
      if (days < 365) {
        const months = Math.floor(days / 30);
        return months === 1 ? '1 mês' : `${months} meses`;
      }
      const years = Math.floor(days / 365);
      const remainingMonths = Math.floor((days % 365) / 30);
      
      let result = years === 1 ? '1 ano' : `${years} anos`;
      if (remainingMonths > 0) {
        result += remainingMonths === 1 ? ', 1 mês' : `, ${remainingMonths} meses`;
      }
      return result;
    }

    // Enhanced user loading
    async function loadUsersEnhanced() {
      try {
        const response = await fetch('/api/admin/list-users-enhanced', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });
    
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            displayUsersEnhanced(result.users);
          }
        }
      } catch (error) {
        console.error('Error loading enhanced users:', error);
        // Fallback para versão básica se enhanced não funcionar
        loadUsers();
      }
    }
    
    // Display users LIMPO (sem último login)
    function displayUsersEnhanced(users) {
      const tbody = document.getElementById('usersTableEnhanced');
      
      if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-400">Nenhum usuário encontrado</td></tr>';
        return;
      }
    
      // Clear existing timers
      window.userTimers = window.userTimers || [];
      window.userTimers.forEach(timer => clearInterval(timer));
      window.userTimers = [];
    
      tbody.innerHTML = users.map((user, index) => {
        const uniqueId = `countdown-${user.id}-${index}`;
        let timeInfo = '';
        let statusBadge = '';
        
        // Status badge
        if (user.subscription_status === 'trial') {
          statusBadge = '<span class="px-2 py-1 rounded text-xs font-medium bg-yellow-600 text-yellow-200">Trial</span>';
        } else if (user.subscription_status === 'active') {
          statusBadge = '<span class="px-2 py-1 rounded text-xs font-medium bg-green-600 text-green-200">Ativo</span>';
        } else if (user.is_expired) {
          statusBadge = '<span class="px-2 py-1 rounded text-xs font-medium bg-red-600 text-red-200">Expirado</span>';
        } else {
          statusBadge = '<span class="px-2 py-1 rounded text-xs font-medium bg-gray-600 text-gray-200">Free</span>';
        }
        
        // Time info
        if (user.has_trial && user.plan_expires_at) {
          if (user.is_expired) {
            timeInfo = `
              <div class="text-xs text-red-400">Expirou</div>
              <div class="text-xs text-gray-500">Conosco: ${formatTimeWithUs(user.days_with_us)}</div>
            `;
          } else {
            timeInfo = `
              <div class="text-xs" id="${uniqueId}">Calculando...</div>
              <div class="text-xs text-gray-500">Conosco: ${formatTimeWithUs(user.days_with_us)}</div>
            `;
            
            // Create countdown timer
            setTimeout(() => {
              const timer = createCountdownTimer(user.plan_expires_at, uniqueId);
              window.userTimers.push(timer);
            }, 100);
          }
        } else {
          timeInfo = `
            <div class="text-xs text-gray-400">Sem expiração</div>
            <div class="text-xs text-gray-500">Conosco: ${formatTimeWithUs(user.days_with_us)}</div>
          `;
        }
        
        return `
          <tr class="table-row">
            <td class="py-3 px-2">
              <div class="font-medium text-white">${user.name}</div>
              <div class="text-xs text-gray-400">${user.email}</div>
              <div class="text-xs text-gray-500 mt-1">${user.formatted_date}</div>
            </td>
            <td class="py-3 px-2">
              <span class="px-2 py-1 rounded text-xs font-medium ${getPlanBadgeClass(user.plan)}">
                ${user.plan}
              </span>
              <div class="text-xs text-gray-500 mt-1">${getTypeBadgeText(user.type)}</div>
            </td>
            <td class="py-3 px-2">
              ${statusBadge}
            </td>
            <td class="py-3 px-2">
              ${timeInfo}
            </td>
            <td class="py-3 px-2">
              <button onclick="fillUserEmail('${user.email}')" class="text-blue-400 hover:text-blue-300 text-sm">
                <i class="fas fa-edit mr-1"></i>Editar
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function getTypeBadgeText(type) {
      const types = {
        'admin': 'Administrador',
        'master': 'Master',
        'regular': 'Regular',
        'trial': 'Em Trial'
      };
      return types[type] || 'Regular';
    }

    // Trial management functions
    async function grantTrial() {
      const email = document.getElementById('manageUserEmail').value;
      const days = document.getElementById('trialDays').value;
      
      if (!email) {
        alert(' Digite o email do usuário');
        return;
      }
      
      try {
        const response = await fetch('/api/admin/manage-trial', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({
            user_email: email,
            action: 'grant',
            days: parseInt(days)
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' ' + result.message);
          document.getElementById('manageUserEmail').value = '';
          loadUsersEnhanced();
        } else {
          alert(' ' + result.error);
        }
        
      } catch (error) {
        alert(' Erro de conexão');
      }
    }

    async function revokeTrial() {
      const email = document.getElementById('manageUserEmail').value;
      
      if (!email) {
        alert(' Digite o email do usuário');
        return;
      }
      
      try {
        const response = await fetch('/api/admin/manage-trial', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({
            user_email: email,
            action: 'revoke'
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' ' + result.message);
          document.getElementById('manageUserEmail').value = '';
          loadUsersEnhanced();
        } else {
          alert(' ' + result.error);
        }
        
      } catch (error) {
        alert(' Erro de conexão');
      }
    }

    // Update the showSection function to use enhanced users
    function showSection(sectionName) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
      });
      
      // Show selected section
      document.getElementById(sectionName + 'Section').classList.remove('hidden');
      
      // Update navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      event.target.closest('.nav-item').classList.add('active');
      
      // Update title
      const titles = {
        dashboard: { title: 'Dashboard', subtitle: 'Visão geral do sistema' },
        users: { title: 'Usuários', subtitle: 'Gerenciar usuários e assinaturas' },
        recommendationsFree: { title: 'Recomendações Free', subtitle: 'Recomendações gratuitas mensais' }
      };
      
      document.getElementById('sectionTitle').textContent = titles[sectionName].title;
      document.getElementById('sectionSubtitle').textContent = titles[sectionName].subtitle;
      
      // Load section data
      if (sectionName === 'users') loadUsersEnhanced(); // Use enhanced version
      if (sectionName === 'recommendationsFree') loadRecommendationsFree();
    }


    // Adicione estas funções no seu script

// Criar novo usuário
async function createNewUser() {
  const name = document.getElementById('newUserName').value.trim();
  const email = document.getElementById('newUserEmail').value.trim();
  const trialDays = document.getElementById('newUserTrialDays').value;
  
  if (!name || !email) {
    alert(' Nome e email são obrigatórios');
    return;
  }
  
  if (!confirm(`Criar usuário "${name}" com trial de ${trialDays} dias?`)) return;
  
  try {
    const response = await fetch('/api/admin/create-user', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${adminToken}`
      },
      body: JSON.stringify({
        name: name,
        email: email,
        trial_days: parseInt(trialDays)
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert(` Usuário criado!\nEmail: ${email}\nSenha: 123456\nTrial: ${trialDays} dias`);
      
      // Limpar formulário
      document.getElementById('newUserName').value = '';
      document.getElementById('newUserEmail').value = '';
      
      // Recarregar
      loadUsersEnhanced();
      loadDashboardStats();
    } else {
      alert(' ' + result.error);
    }
    
  } catch (error) {
    alert(' Erro de conexão');
  }
}

// Função atualizada para mostrar informações de último login
function displayUsersEnhanced(users) {
  const tbody = document.getElementById('usersTableEnhanced');
  
  if (!users || users.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-400">Nenhum usuário encontrado</td></tr>';
    return;
  }

  // Clear existing timers
  window.userTimers = window.userTimers || [];
  window.userTimers.forEach(timer => clearInterval(timer));
  window.userTimers = [];

  tbody.innerHTML = users.map((user, index) => {
    const uniqueId = `countdown-${user.id}-${index}`;
    let timeInfo = '';
    let statusBadge = '';
    let lastLoginInfo = '';
    
    // Status badge
    if (user.subscription_status === 'trial') {
      statusBadge = '<span class="px-2 py-1 rounded text-xs font-medium bg-yellow-600 text-yellow-200">Trial</span>';
    } else if (user.subscription_status === 'active') {
      statusBadge = '<span class="px-2 py-1 rounded text-xs font-medium bg-green-600 text-green-200">Ativo</span>';
    } else if (user.is_expired) {
      statusBadge = '<span class="px-2 py-1 rounded text-xs font-medium bg-red-600 text-red-200">Expirado</span>';
    } else {
      statusBadge = '<span class="px-2 py-1 rounded text-xs font-medium bg-gray-600 text-gray-200">Free</span>';
    }
    
    // Last login info
    if (user.last_login) {
      const lastLogin = new Date(user.last_login);
      const now = new Date();
      const diffDays = Math.floor((now - lastLogin) / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) {
        lastLoginInfo = `<div class="text-xs text-green-400">Hoje</div>`;
      } else if (diffDays === 1) {
        lastLoginInfo = `<div class="text-xs text-yellow-400">Ontem</div>`;
      } else if (diffDays <= 7) {
        lastLoginInfo = `<div class="text-xs text-orange-400">${diffDays} dias atrás</div>`;
      } else {
        lastLoginInfo = `<div class="text-xs text-red-400">${diffDays} dias atrás</div>`;
      }
      lastLoginInfo += `<div class="text-xs text-gray-500">${user.formatted_last_login}</div>`;
    } else {
      lastLoginInfo = `
        <div class="text-xs text-gray-400">Nunca logou</div>
        <div class="text-xs text-red-500">Usuário novo</div>
      `;
    }
    
    // Time info
    if (user.has_trial && user.plan_expires_at) {
      if (user.is_expired) {
        timeInfo = `
          <div class="text-xs text-red-400">Expirou</div>
          <div class="text-xs text-gray-500">Conosco: ${formatTimeWithUs(user.days_with_us)}</div>
        `;
      } else {
        timeInfo = `
          <div class="text-xs" id="${uniqueId}">Calculando...</div>
          <div class="text-xs text-gray-500">Conosco: ${formatTimeWithUs(user.days_with_us)}</div>
        `;
        
        // Create countdown timer
        setTimeout(() => {
          const timer = createCountdownTimer(user.plan_expires_at, uniqueId);
          window.userTimers.push(timer);
        }, 100);
      }
    } else {
      timeInfo = `
        <div class="text-xs text-gray-400">Sem expiração</div>
        <div class="text-xs text-gray-500">Conosco: ${formatTimeWithUs(user.days_with_us)}</div>
      `;
    }
    
    return `
      <tr class="table-row">
        <td class="py-3 px-2">
          <div class="font-medium text-white">${user.name}</div>
          <div class="text-xs text-gray-400">${user.email}</div>
          <div class="text-xs text-gray-500 mt-1">${user.formatted_date}</div>
        </td>
        <td class="py-3 px-2">
          <span class="px-2 py-1 rounded text-xs font-medium ${getPlanBadgeClass(user.plan)}">
            ${user.plan}
          </span>
          <div class="text-xs text-gray-500 mt-1">${getTypeBadgeText(user.type)}</div>
        </td>
        <td class="py-3 px-2">
          ${statusBadge}
        </td>
        <td class="py-3 px-2">
          ${timeInfo}
        </td>
        <td class="py-3 px-2">
          ${lastLoginInfo}
        </td>
        <td class="py-3 px-2">
          <button onclick="fillUserEmail('${user.email}')" class="text-blue-400 hover:text-blue-300 text-sm">
            <i class="fas fa-edit mr-1"></i>Editar
          </button>
        </td>
      </tr>
    `;
  }).join('');
}

    // Create recommendation
    async function createRecommendationFree() {
      const formData = {
        ticker: document.getElementById('recFreeTicker').value.toUpperCase().trim(),
        action: document.getElementById('recFreeAction').value,
        entry_price: parseFloat(document.getElementById('recFreeEntryPrice').value),
        stop_loss: parseFloat(document.getElementById('recFreeStopLoss').value),
        target_price: parseFloat(document.getElementById('recFreeTargetPrice').value),
        confidence: parseFloat(document.getElementById('recFreeConfidence').value) || 85
      };

      // Validations
      if (!formData.ticker || !formData.action || !formData.entry_price || !formData.stop_loss || !formData.target_price) {
        alert(' Preencha todos os campos obrigatórios!');
        return;
      }

      try {
        const response = await fetch('/api/recommendations/admin/create-single', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' Recomendação criada com sucesso!');
          
          // Clear form
          document.getElementById('recFreeTicker').value = '';
          document.getElementById('recFreeAction').value = '';
          document.getElementById('recFreeEntryPrice').value = '';
          document.getElementById('recFreeStopLoss').value = '';
          document.getElementById('recFreeTargetPrice').value = '';
          document.getElementById('recFreeConfidence').value = '85';
          
          // Reload list
          loadRecommendationsFree();
        } else {
          alert(' ' + result.error);
        }
        
      } catch (error) {
        console.error('Error creating recommendation:', error);
        alert(' Erro de conexão com o servidor');
      }
    }

    // Close recommendation
    async function closeRecommendationFree(recId) {
      if (!confirm('Encerrar esta recomendação?')) return;

      try {
        const response = await fetch(`/api/recommendations/admin/close/${recId}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            status: 'FINALIZADA_MANUAL'
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' Recomendação encerrada com sucesso!');
          loadRecommendationsFree();
        } else {
          alert(' ' + result.error);
        }
        
      } catch (error) {
        console.error('Error closing recommendation:', error);
        alert(' Erro de conexão com o servidor');
      }
    }

    // Delete recommendation
    async function deleteRecommendationFree(recId) {
      if (!confirm('⚠️ Remover esta recomendação permanentemente?')) return;

      try {
        const response = await fetch(`/api/recommendations/admin/delete/${recId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' Recomendação removida com sucesso!');
          loadRecommendationsFree();
        } else {
          alert(' ' + result.error);
        }
        
      } catch (error) {
        console.error('Error deleting recommendation:', error);
        alert(' Erro de conexão com o servidor');
      }
    }

    // Generate monthly recommendations
    async function generateMonthlyRecommendations() {
      if (!confirm('Gerar novas recomendações mensais automaticamente?')) return;
      
      const button = event.target;
      const originalText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Gerando...';
      
      try {
        const response = await fetch('/api/recommendations/admin/generate', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(` ${result.message}\n\n${result.recommendations.length} recomendações criadas!`);
          loadRecommendationsFree();
        } else {
          alert(' ' + result.error);
        }
        
      } catch (error) {
        console.error('Error generating recommendations:', error);
        alert(' Erro de conexão com o servidor');
      } finally {
        button.disabled = false;
        button.innerHTML = originalText;
      }
    }

    // Update all prices
    async function updateAllPrices() {
      const button = event.target;
      const originalText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Atualizando...';
      
      try {
        const response = await fetch('/api/recommendations/admin/update-prices', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' Preços atualizados com sucesso!');
          loadRecommendationsFree();
        } else {
          alert(' ' + result.error);
        }
        
      } catch (error) {
        console.error('Error updating prices:', error);
        alert(' Erro de conexão com o servidor');
      } finally {
        button.disabled = false;
        button.innerHTML = originalText;
      }
    }

    // Logout
    function logout() {
      if (confirm('Deseja realmente sair do painel administrativo?')) {
        localStorage.removeItem('geminii_token');
        localStorage.removeItem('geminii_user');
        window.location.href = '/';
      }
    }

    // Initialize admin dashboard
    async function initAdminDashboard() {
      console.log('🔐 Inicializando Admin Dashboard...');
      
      await checkAdminAuth();
      await loadDashboardStats();
      loadRecentActivity();
      
      console.log(' Admin Dashboard carregado!');
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initAdminDashboard);
  </script>
</body>
</html>