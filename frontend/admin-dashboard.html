<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            geminii: '#fb1ebb'
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
    }
    
    .admin-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      transition: all 0.3s ease;
    }
    
    .admin-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(186, 57, 175, 0.15);
      border-color: rgba(186, 57, 175, 0.3);
    }
    
    .stat-card {
      background: linear-gradient(135deg, rgba(186, 57, 175, 0.1), rgba(217, 70, 239, 0.05));
      border: 1px solid rgba(186, 57, 175, 0.2);
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, #fb1ebb, #fb1ebb);
    }
    
    .action-btn {
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .action-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }
    
    .sidebar {
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .nav-item {
      transition: all 0.3s ease;
      border-radius: 8px;
      margin: 4px 0;
    }
    
    .nav-item:hover, .nav-item.active {
      background: rgba(186, 57, 175, 0.2);
      border-color: rgba(186, 57, 175, 0.3);
    }
    
    .table-row {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    
    .table-row:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .spinner {
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 2px solid #fb1ebb;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

  </style>
</head>
<body class="bg-black text-white min-h-screen">
  
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <div class="sidebar w-64 p-6">
      <div class="mb-8">
        <h1 class="text-2xl font-bold text-geminii">
          <i class="fas fa-crown mr-2"></i>
          Admin Panel
        </h1>
        <p class="text-gray-400 text-sm">Geminii Tech</p>
      </div>
      
      <nav class="space-y-2">
        <a href="javascript:void(0)" data-section="dashboard" class="nav-item active flex items-center p-3 text-white border border-transparent">
          <i class="fas fa-tachometer-alt mr-3"></i>
          Dashboard
        </a>
        <a href="javascript:void(0)" data-section="users" class="nav-item flex items-center p-3 text-gray-300 border border-transparent">
          <i class="fas fa-users mr-3"></i>
          Usu√°rios
        </a>
        <a href="javascript:void(0)" data-section="recommendationsFree" class="nav-item flex items-center p-3 text-gray-300 border border-transparent">
          <i class="fas fa-gift mr-3"></i>
          Recomenda√ß√µes Free
        </a>
        <a href="javascript:void(0)" data-section="railway" class="nav-item flex items-center p-3 text-gray-300 border border-transparent">
          <i class="fas fa-database mr-3"></i>
          Sync Railway
        </a>
      </nav>
      
      <div class="mt-auto pt-8">
        <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 py-2 px-4 rounded-lg text-sm font-medium">
          <i class="fas fa-sign-out-alt mr-2"></i>
          Sair
        </button>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="flex-1 p-6">
      
      <!-- Header -->
      <div class="flex items-center justify-between mb-8">
        <div>
          <h2 class="text-3xl font-bold text-white" id="sectionTitle">Dashboard</h2>
          <p class="text-gray-400" id="sectionSubtitle">Vis√£o geral do sistema</p>
        </div>
        <div class="flex items-center space-x-4">
          <div class="text-sm text-gray-400">
            <i class="fas fa-user-shield mr-1"></i>
            <span id="adminName">Admin</span>
          </div>
          <div id="apiStatus" class="w-8 h-8 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-full flex items-center justify-center">
            <i class="fas fa-shield-alt text-green-500 text-xs"></i>
          </div>
        </div>
      </div>
      
      <!-- Dashboard Section -->
      <div id="dashboardSection" class="section">
        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="admin-card stat-card p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-400">Total Usu√°rios</p>
                <p class="text-2xl font-bold text-white" id="totalUsers">0</p>
              </div>
              <div class="w-12 h-12 bg-blue-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                <i class="fas fa-users text-blue-500"></i>
              </div>
            </div>
          </div>
          
          <div class="admin-card stat-card p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-400">Assinantes Premium</p>
                <p class="text-2xl font-bold text-green-400" id="premiumUsers">0</p>
              </div>
              <div class="w-12 h-12 bg-green-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                <i class="fas fa-crown text-green-500"></i>
              </div>
            </div>
          </div>
          
          <div class="admin-card stat-card p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-400">Recomenda√ß√µes Ativas</p>
                <p class="text-2xl font-bold text-yellow-400" id="activeRecommendations">0</p>
              </div>
              <div class="w-12 h-12 bg-yellow-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                <i class="fas fa-gift text-yellow-500"></i>
              </div>
            </div>
          </div>
          
          <div class="admin-card stat-card p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-400">Taxa de Sucesso</p>
                <p class="text-2xl font-bold text-purple-400" id="successRate">0%</p>
              </div>
              <div class="w-12 h-12 bg-purple-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                <i class="fas fa-chart-line text-purple-500"></i>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="admin-card p-6">
          <h3 class="text-xl font-bold text-white mb-4">
            <i class="fas fa-clock mr-2"></i>
            Atividade Recente
          </h3>
          <div id="recentActivity" class="space-y-3">
            <!-- Activity items will be loaded here -->
          </div>
        </div>
      </div>
      
      
    <!-- Users Section -->
    <div id="usersSection" class="section hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Lista de Usu√°rios -->
        <div class="lg:col-span-2">
          <div class="admin-card p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-white">
                <i class="fas fa-users mr-2"></i>
                Lista de Usu√°rios
              </h3>
              <div class="flex gap-2">
                <button onclick="exportUsers()" class="bg-green-600 hover:bg-green-700 py-2 px-4 rounded-lg text-sm">
                  <i class="fas fa-download mr-1"></i>
                  Exportar CSV
                </button>
                <button onclick="loadUsersEnhanced()" class="bg-blue-600 hover:bg-blue-700 py-2 px-4 rounded-lg text-sm">
                  <i class="fas fa-sync mr-1"></i>
                  Atualizar
                </button>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="text-left border-b border-gray-600">
                    <th class="py-3 px-2 text-gray-400">Usu√°rio</th>
                    <th class="py-3 px-2 text-gray-400">Plano</th>
                    <th class="py-3 px-2 text-gray-400">Status</th>
                    <th class="py-3 px-2 text-gray-400">Tempo</th>
                    <th class="py-3 px-2 text-gray-400">√öltimo Login</th>
                    <th class="py-3 px-2 text-gray-400">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="usersTableEnhanced">
                    <tr>
                      <td colspan="6" class="text-center py-8">
                        <div class="spinner mx-auto mb-2"></div>
                        <p class="text-gray-400">Carregando usu√°rios...</p>
                      </td>
                    </tr>
                  </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Painel de Controle -->
        <div class="space-y-6">
          
          <!-- Criar Novo Usu√°rio -->
          <div class="admin-card p-6">
            <h3 class="text-lg font-bold text-white mb-4">
              <i class="fas fa-user-plus mr-2"></i>
              Criar Novo Usu√°rio
            </h3>
          
            <div class="space-y-4">
              <div>
                <label class="block text-sm text-gray-300 mb-1">Nome Completo</label>
                <input type="text" id="newUserName" 
                      class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm"
                      placeholder="Jo√£o Silva">
              </div>
              
              <div>
                <label class="block text-sm text-gray-300 mb-1">Email</label>
                <input type="email" id="newUserEmail" 
                      class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm"
                      placeholder="joao@email.com">
              </div>
              
              <div>
                <label class="block text-sm text-gray-300 mb-1">Trial Inicial</label>
                <select id="newUserTrialDays" class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm">
                  <option value="3">3 dias</option>
                  <option value="7" selected>7 dias</option>
                  <option value="14">14 dias</option>
                  <option value="30">30 dias</option>
                </select>
              </div>
              
              <div class="bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded-lg p-3">
                <div class="flex items-center mb-2">
                  <i class="fas fa-info-circle text-yellow-400 mr-2"></i>
                  <span class="text-yellow-400 text-sm font-medium">Informa√ß√£o Importante</span>
                </div>
                <p class="text-yellow-200 text-xs">
                  Senha padr√£o: <strong>123456</strong><br>
                  O usu√°rio deve alterar ap√≥s primeiro login
                </p>
              </div>
              
              <button onclick="createNewUser()" class="action-btn w-full bg-geminii hover:bg-purple-700 py-2 px-4 rounded-lg text-sm font-medium">
                <i class="fas fa-user-plus mr-1"></i>
                Criar Usu√°rio em Trial
              </button>
            </div>
          </div>

         <!-- Gerenciar Usu√°rio Existente -->
          <div class="admin-card p-6">
            <h3 class="text-lg font-bold text-white mb-4">
              <i class="fas fa-user-cog mr-2"></i>
              Gerenciar Usu√°rio
            </h3>

            <div class="space-y-4">
              <div>
                <label class="block text-sm text-gray-300 mb-1">E-mail do Usu√°rio</label>
                <input type="email" id="manageUserEmail" 
                      class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm"
                      placeholder="usuario@email.com">
              </div>

              <!-- Telefone (readonly) -->
              <div>
                <label class="block text-sm text-gray-300 mb-1">
                  <i class="fas fa-phone text-blue-400 mr-1"></i>Telefone
                </label>
                <input type="text" id="userPhone" readonly
                      class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-400 text-sm cursor-not-allowed"
                      placeholder="N√£o informado">
              </div>

              <!-- Origem (readonly) -->
              <div>
                <label class="block text-sm text-gray-300 mb-1">
                  <i class="fas fa-map-marker-alt text-green-400 mr-1"></i>Onde nos conheceu
                </label>
                <input type="text" id="userSource" readonly
                      class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-400 text-sm cursor-not-allowed"
                      placeholder="N√£o informado">
              </div>

              <div>
                <label class="block text-sm text-gray-300 mb-1">Novo Plano</label>
                <select id="newPlanId" class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm">
                  <option value="3">Free</option>
                  <option value="4">Community</option>
                </select>
              </div>

              <div class="flex flex-col gap-2">
                <button onclick="grantSubscription()" class="action-btn bg-green-600 hover:bg-green-700 py-2 px-4 rounded-lg text-sm font-medium">
                  <i class="fas fa-plus mr-1"></i>
                  Dar Assinatura
                </button>
                <button onclick="removeUserPlan()" class="action-btn bg-orange-600 hover:bg-orange-700 py-2 px-4 rounded-lg text-sm font-medium">
                  <i class="fas fa-minus mr-1"></i>
                  Remover Assinatura
                </button>
                <button onclick="promoteToAdmin()" class="action-btn bg-purple-600 hover:bg-purple-700 py-2 px-4 rounded-lg text-sm font-medium">
                  <i class="fas fa-crown mr-1"></i>
                  Promover a Admin
                </button>
                <button onclick="deleteUser()" class="action-btn bg-red-600 hover:bg-red-700 py-2 px-4 rounded-lg text-sm font-medium">
                  <i class="fas fa-trash mr-1"></i>
                  Remover Usu√°rio
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recommendations Free Section -->
    <div id="recommendationsFreeSection" class="section hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Lista de Recomenda√ß√µes -->
        <div class="lg:col-span-2">
          <div class="admin-card p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-white">
                <i class="fas fa-gift mr-2"></i>
                Recomenda√ß√µes Free Mensais
              </h3>
              <div class="flex gap-2">
                <button onclick="updateAllPrices()" class="bg-blue-600 hover:bg-blue-700 py-2 px-4 rounded-lg text-sm">
                  <i class="fas fa-sync mr-1"></i>
                  Atualizar Pre√ßos
                </button>
                <button onclick="generateMonthlyRecommendations()" class="bg-green-600 hover:bg-green-700 py-2 px-4 rounded-lg text-sm">
                  <i class="fas fa-robot mr-1"></i>
                  Gerar Mensais
                </button>
              </div>
            </div>

            <div id="recommendationsList" class="space-y-3">
              <div class="text-center py-4 text-gray-400">
                <div class="spinner mx-auto mb-2"></div>
                <p class="text-sm">Carregando recomenda√ß√µes...</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Criar Recomenda√ß√£o -->
        <div>
          <div class="admin-card p-6">
            <h3 class="text-lg font-bold text-white mb-4">
              <i class="fas fa-plus mr-2"></i>
              Nova Recomenda√ß√£o
            </h3>
            
            <form id="recommendationFreeForm" class="space-y-4">
              <div>
                <label class="block text-sm text-gray-300 mb-1">Ticker</label>
                <input type="text" id="recFreeTicker" required
                      class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm"
                      placeholder="PETR4">
              </div>
              
              <div>
                <label class="block text-sm text-gray-300 mb-1">A√ß√£o</label>
                <select id="recFreeAction" required class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm">
                  <option value="">Selecione...</option>
                  <option value="COMPRA">Compra</option>
                  <option value="VENDA">Venda</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm text-gray-300 mb-1">Pre√ßo de Entrada (R$)</label>
                <input type="number" id="recFreeEntryPrice" required min="0" step="0.01"
                      class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm"
                      placeholder="35.50">
              </div>
              
              <div>
                <label class="block text-sm text-gray-300 mb-1">Stop Loss (R$)</label>
                <input type="number" id="recFreeStopLoss" required min="0" step="0.01"
                      class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm"
                      placeholder="33.00">
              </div>
              
              <div>
                <label class="block text-sm text-gray-300 mb-1">Alvo (R$)</label>
                <input type="number" id="recFreeTargetPrice" required min="0" step="0.01"
                      class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm"
                      placeholder="40.00">
              </div>
              
              <div>
                <label class="block text-sm text-gray-300 mb-1">Confian√ßa (%)</label>
                <input type="number" id="recFreeConfidence" min="0" max="100" step="1" value="85"
                      class="w-full px-3 py-2 bg-white bg-opacity-10 border border-gray-600 rounded-lg text-white text-sm">
              </div>
              
              <button type="button" onclick="createRecommendationFree()" class="action-btn w-full bg-geminii hover:bg-purple-700 py-2 px-4 rounded-lg text-sm font-medium">
                <i class="fas fa-plus mr-1"></i>
                Criar Recomenda√ß√£o
              </button>
            </form>
          </div>

          <!-- Estat√≠sticas -->
          <div class="admin-card p-6 mt-6">
            <h3 class="text-lg font-bold text-white mb-4">
              <i class="fas fa-chart-line mr-2"></i>
              Estat√≠sticas
            </h3>
            
            <div id="recommendationsStats" class="space-y-3">
              <div class="flex justify-between">
                <span class="text-gray-400">Total:</span>
                <span class="text-white font-medium" id="recStatsTotal">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Ativas:</span>
                <span class="text-green-400 font-medium" id="recStatsActive">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Finalizadas:</span>
                <span class="text-gray-300 font-medium" id="recStatsClosed">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Taxa de Acerto:</span>
                <span class="text-yellow-400 font-medium" id="recStatsSuccess">0%</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Ganho M√©dio:</span>
                <span class="text-green-400 font-medium" id="recStatsAvgGain">+0%</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Perda M√©dia:</span>
                <span class="text-red-400 font-medium" id="recStatsAvgLoss">-0%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Railway Sync Section -->
    <div id="railwaySection" class="section hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Terminal / Console -->
        <div class="lg:col-span-2">
          <div class="admin-card p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-white">
                <i class="fas fa-terminal mr-2"></i>
                Console de Sincroniza√ß√£o
              </h3>
              <button onclick="clearSyncConsole()" class="bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg text-sm">
                <i class="fas fa-eraser mr-1"></i>
                Limpar
              </button>
            </div>

            <!-- Console Output -->
            <div id="syncConsole" class="bg-black bg-opacity-50 rounded-lg p-4 font-mono text-sm h-96 overflow-y-auto border border-gray-700">
              <div class="text-green-400">üöÇ Railway Sync Console - Pronto</div>
              <div class="text-gray-500">Aguardando comando...</div>
            </div>

            <!-- Bot√£o de Sincroniza√ß√£o -->
            <div class="mt-4">
              <button id="syncButton" onclick="runRailwaySync()" 
                      class="action-btn w-full bg-geminii hover:bg-purple-700 py-3 px-4 rounded-lg text-base font-medium">
                <i class="fas fa-sync-alt mr-2"></i>
                Sincronizar Dados B3 ‚Üí Railway
              </button>
            </div>
          </div>
        </div>

        <!-- Status e Estat√≠sticas -->
        <div class="space-y-6">
          
          <!-- Status Atual -->
          <div class="admin-card p-6">
            <h3 class="text-lg font-bold text-white mb-4">
              <i class="fas fa-info-circle mr-2"></i>
              Status do Banco
            </h3>
            
            <div id="railwayStatus" class="space-y-3">
              <div class="text-center py-4">
                <div class="spinner mx-auto mb-2"></div>
                <p class="text-gray-400 text-sm">Carregando status...</p>
              </div>
            </div>
          </div>

          <!-- Datas Dispon√≠veis -->
          <div class="admin-card p-6">
            <h3 class="text-lg font-bold text-white mb-4">
              <i class="fas fa-calendar-alt mr-2"></i>
              Datas Configuradas
            </h3>
            
            <div id="railwayDates" class="space-y-2 text-sm max-h-64 overflow-y-auto">
              <div class="text-center py-4">
                <div class="spinner mx-auto mb-2"></div>
                <p class="text-gray-400 text-sm">Carregando datas...</p>
              </div>
            </div>
          </div>

          <!-- Resumo Executivo -->
          <div class="admin-card p-6">
            <h3 class="text-lg font-bold text-white mb-4">
              <i class="fas fa-chart-pie mr-2"></i>
              Resumo
            </h3>
            
            <div id="railwayResumo" class="space-y-3">
              <div class="flex justify-between">
                <span class="text-gray-400">Total Registros:</span>
                <span class="text-white font-medium" id="railwayTotalReg">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Datas no Banco:</span>
                <span class="text-green-400 font-medium" id="railwayDatasDisp">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">√öltima Atualiza√ß√£o:</span>
                <span class="text-yellow-400 font-medium text-xs" id="railwayUltimaData">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Progresso:</span>
                <span class="text-purple-400 font-medium" id="railwayProgresso">0%</span>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    </div>
  </div>

  <script>
    let adminToken = null;
    let currentUser = null;

    // Check admin authentication
    async function checkAdminAuth() {
      const token = localStorage.getItem('geminii_token');
      const userData = localStorage.getItem('geminii_user');

      if (!token || !userData) {
        window.location.href = '/login.html';
        return;
      }

      try {
        const response = await fetch('/auth/verify', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const result = await response.json();

        if (result.success) {
          currentUser = result.data.user;
          adminToken = token;
          
          // Check if user is admin
          const isAdmin = currentUser.user_type === 'admin' || currentUser.user_type === 'master';
          
          if (!isAdmin) {
            alert('‚ùå Acesso negado! Voc√™ n√£o tem privil√©gios de administrador.');
            window.location.href = '/dashboard.html';
            return;
          }
          
          // Update UI with admin info
          document.getElementById('adminName').textContent = currentUser.name;
          
        } else {
          localStorage.removeItem('geminii_token');
          localStorage.removeItem('geminii_user');
          window.location.href = '/login.html';
        }

      } catch (error) {
        console.error('Auth check failed:', error);
        window.location.href = '/login.html';
      }
    }

    // Load dashboard statistics
    async function loadDashboardStats() {
      try {
        const response = await fetch('/api/admin/stats', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            const stats = result.data;
            
            document.getElementById('totalUsers').textContent = stats.total_users || 0;
            document.getElementById('premiumUsers').textContent = stats.premium_users || 0;
            document.getElementById('activeRecommendations').textContent = stats.active_recommendations || 0;
            document.getElementById('successRate').textContent = `${stats.success_rate || 0}%`;
          }
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load recent activity
    async function loadRecentActivity() {
      try {
        const response = await fetch('/api/admin/recent-activity', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            displayRecentActivity(result.activities);
            return;
          }
        }

        // Fallback to mock data
        displayMockActivity();
        
      } catch (error) {
        console.log('Using mock activity data');
        displayMockActivity();
      }
    }

    function displayRecentActivity(activities) {
      const container = document.getElementById('recentActivity');
      
      if (!activities || activities.length === 0) {
        container.innerHTML = `
          <div class="text-center py-6 text-gray-400">
            <i class="fas fa-clock text-2xl mb-2"></i>
            <p>Nenhuma atividade recente</p>
          </div>
        `;
        return;
      }

      container.innerHTML = activities.map(activity => `
        <div class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 hover:bg-opacity-30 transition-colors">
          <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
            <i class="${activity.icon} text-sm ${activity.color}"></i>
          </div>
          <div class="flex-1">
            <p class="text-sm text-white">${activity.message}</p>
            <p class="text-xs text-gray-400">${activity.time}</p>
          </div>
        </div>
      `).join('');
    }

    function displayMockActivity() {
      const mockActivities = [
        { icon: 'fas fa-user-plus', color: 'text-green-400', message: 'Novo usu√°rio registrado', time: 'h√° 5 minutos' },
        { icon: 'fas fa-crown', color: 'text-yellow-400', message: 'Assinatura Premium ativada', time: 'h√° 15 minutos' },
        { icon: 'fas fa-chart-line', color: 'text-blue-400', message: 'Nova recomenda√ß√£o criada', time: 'h√° 1 hora' },
        { icon: 'fas fa-sync', color: 'text-purple-400', message: 'Pre√ßos atualizados', time: 'h√° 2 horas' }
      ];
      displayRecentActivity(mockActivities);
    }
    
    // ===== NAVIGATION FIX =====
    function showSection(sectionName) {
      console.log('Showing section:', sectionName);
      
      // Hide all sections
      const sections = document.querySelectorAll('.section');
      sections.forEach(section => {
        section.classList.add('hidden');
      });
      
      // Show selected section
      const targetSection = document.getElementById(sectionName + 'Section');
      if (targetSection) {
        targetSection.classList.remove('hidden');
      } else {
        console.error('Section not found:', sectionName + 'Section');
      }
      
      // Update navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      const activeItem = document.querySelector(`[data-section="${sectionName}"]`);
      if (activeItem) {
        activeItem.classList.add('active');
      }
      
      // Update title      
      const titles = {
        dashboard: { title: 'Dashboard', subtitle: 'Vis√£o geral do sistema' },
        users: { title: 'Usu√°rios', subtitle: 'Gerenciar usu√°rios e assinaturas' },
        recommendationsFree: { title: 'Recomenda√ß√µes Free', subtitle: 'Recomenda√ß√µes gratuitas mensais' },
        railway: { title: 'Sincroniza√ß√£o Railway', subtitle: 'Sincronizar dados B3 com banco Railway' }
      };

      if (titles[sectionName]) {
        document.getElementById('sectionTitle').textContent = titles[sectionName].title;
        document.getElementById('sectionSubtitle').textContent = titles[sectionName].subtitle;
      }

      // Load section data
      if (sectionName === 'users') loadUsersEnhanced();
      if (sectionName === 'recommendationsFree') loadRecommendationsFree();
      if (sectionName === 'railway') loadRailwaySync();
    }

    // Setup navigation event listeners
    function setupNavigation() {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const sectionName = this.getAttribute('data-section');
          if (sectionName) {
            showSection(sectionName);
          }
        });
      });
    }

    // ===== USER MANAGEMENT =====

    // Load users
    async function loadUsers() {
      try {
        const response = await fetch('/api/admin/list-users', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            displayUsers(result.users);
          }
        }
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    function displayUsers(users) {
      const tbody = document.getElementById('usersTable');
      
      if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-400">Nenhum usu√°rio encontrado</td></tr>';
        return;
      }

      tbody.innerHTML = users.map(user => `
        <tr class="table-row">
          <td class="py-3 px-2">
            <div class="font-medium text-white">${user.name}</div>
            <div class="text-xs text-gray-400">${user.formatted_date || 'N/A'}</div>
          </td>
          <td class="py-3 px-2 text-gray-300">${user.email}</td>
          <td class="py-3 px-2">
            <span class="px-2 py-1 rounded text-xs font-medium ${getPlanBadgeClass(user.plan)}">
              ${user.plan}
            </span>
          </td>
          <td class="py-3 px-2">
            <span class="px-2 py-1 rounded text-xs font-medium ${getTypeBadgeClass(user.type)}">
              ${user.type || 'regular'}
            </span>
          </td>
          <td class="py-3 px-2">
            <button onclick="fillUserEmail('${user.email}')" class="text-blue-400 hover:text-blue-300 text-sm">
              <i class="fas fa-edit mr-1"></i>Editar
            </button>
          </td>
        </tr>
      `).join('');
    }

    function getPlanBadgeClass(plan) {
      const classes = {
        'B√°sico': 'bg-gray-600 text-gray-200',
        'Pro': 'bg-yellow-600 text-yellow-200',
        'Premium': 'bg-purple-600 text-purple-200'
      };
      return classes[plan] || 'bg-gray-600 text-gray-200';
    }

    function getTypeBadgeClass(type) {
      const classes = {
        'admin': 'bg-red-600 text-red-200',
        'master': 'bg-orange-600 text-orange-200',
        'regular': 'bg-gray-600 text-gray-200'
      };
      return classes[type] || 'bg-gray-600 text-gray-200';
    }

    // Fill user email in form
    async function fillUserEmail(email) {
      document.getElementById('manageUserEmail').value = email;
      
      // Limpar campos
      document.getElementById('userPhone').value = 'Carregando...';
      document.getElementById('userSource').value = 'Carregando...';
      
      try {
          const response = await fetch('/api/admin/get-user-by-email', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${adminToken}`
              },
              body: JSON.stringify({ email: email })
          });
          
          const result = await response.json();
          
          if (result.success) {
              const user = result.user;
              document.getElementById('newPlanId').value = user.plan_id;
              document.getElementById('userPhone').value = user.phone || 'N√£o informado';
              document.getElementById('userSource').value = user.source || 'N√£o informado';
          } else {
              document.getElementById('userPhone').value = 'Erro ao carregar';
              document.getElementById('userSource').value = 'Erro ao carregar';
          }
      } catch (error) {
          console.error('Erro:', error);
          document.getElementById('userPhone').value = 'Erro ao carregar';
          document.getElementById('userSource').value = 'Erro ao carregar';
      }
    }

    // Grant subscription
    async function grantSubscription() {
      const email = document.getElementById('manageUserEmail').value;
      const planId = document.getElementById('newPlanId').value;
      
      if (!email) {
        alert('‚ùå Digite o e-mail do usu√°rio');
        return;
      }
      
      try {
        const response = await fetch('/api/admin/manage-subscription', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({
            user_email: email,
            action: 'grant',
            plan_id: parseInt(planId)
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' ' + result.message);
          document.getElementById('manageUserEmail').value = '';
          loadUsers();
          loadDashboardStats();
        } else {
          alert('‚ùå ' + result.error);
        }
        
      } catch (error) {
        alert('‚ùå Erro de conex√£o');
      }
    }

    // Remove user plan
    async function removeUserPlan() {
      const email = document.getElementById('manageUserEmail').value;
      
      if (!email) {
        alert('‚ùå Digite o e-mail do usu√°rio');
        return;
      }
      
      if (!confirm(`Remover assinatura de ${email}?`)) return;
      
      try {
        const response = await fetch('/api/admin/manage-subscription', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({
            user_email: email,
            action: 'revoke'
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' ' + result.message);
          document.getElementById('manageUserEmail').value = '';
          loadUsers();
          loadDashboardStats();
        } else {
          alert('‚ùå ' + result.error);
        }
        
      } catch (error) {
        alert('‚ùå Erro de conex√£o');
      }
    }

    // Promote to admin
    async function promoteToAdmin() {
      const email = document.getElementById('manageUserEmail').value;
      
      if (!email) {
        alert('‚ùå Digite o e-mail do usu√°rio');
        return;
      }
      
      if (!confirm(`Promover ${email} a administrador?`)) return;
      
      try {
        const response = await fetch('/api/admin/promote-user', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({
            user_email: email,
            user_type: 'admin'
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' ' + result.message);
          document.getElementById('manageUserEmail').value = '';
          loadUsers();
        } else {
          alert('‚ùå ' + result.error);
        }
        
      } catch (error) {
        alert('‚ùå Erro de conex√£o');
      }
    }

    // Delete user
    async function deleteUser() {
      const email = document.getElementById('manageUserEmail').value;
      
      if (!email) {
        alert('‚ùå Digite o e-mail do usu√°rio');
        return;
      }
      
      if (!confirm(` ATEN√á√ÉO: Remover usu√°rio ${email}?\n\nEsta a√ß√£o marcar√° o usu√°rio como removido.\nDeseja continuar?`)) {
        return;
      }
      
      try {
        const response = await fetch('/api/admin/users/delete', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({ email: email })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' ' + result.message);
          document.getElementById('manageUserEmail').value = '';
          loadUsers();
          loadDashboardStats();
        } else {
          alert('‚ùå ' + result.error);
        }
        
      } catch (error) {
        console.error('Error deleting user:', error);
        alert('‚ùå Erro de conex√£o');
      }
    }

    // ===== RECOMMENDATIONS FREE =====

    // Load recommendations
    async function loadRecommendationsFree() {
      try {
        const response = await fetch('/api/recommendations/admin/all', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            displayRecommendationsFree(result.recommendations);
            updateRecommendationsStats(result.recommendations);
          }
        }
      } catch (error) {
        console.error('Error loading recommendations:', error);
      }
    }

    // Display recommendations
    function displayRecommendationsFree(recommendations) {
      const container = document.getElementById('recommendationsList');
      
      if (!recommendations || recommendations.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-gift text-4xl text-gray-600 mb-4"></i>
            <p class="text-gray-400 text-lg mb-2">Nenhuma recomenda√ß√£o encontrada</p>
            <p class="text-gray-500 text-sm">Crie novas recomenda√ß√µes ou gere automaticamente</p>
          </div>
        `;
        return;
      }

      container.innerHTML = recommendations.map(rec => {
        const isCompra = rec.action === 'COMPRA';
        const statusColor = getStatusColor(rec.status);
        const statusText = getStatusText(rec.status);
        
        return `
          <div class="border border-gray-600 rounded-lg p-4 hover:border-geminii transition-all duration-300">
            <!-- Header da Recomenda√ß√£o -->
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-lg flex items-center justify-center ${isCompra ? 'bg-green-600' : 'bg-red-600'}">
                  <i class="fas ${isCompra ? 'fa-arrow-up' : 'fa-arrow-down'} text-white text-lg"></i>
                </div>
                <div>
                  <h4 class="text-xl font-bold text-white">${rec.ticker}</h4>
                  <p class="text-sm text-gray-400">${rec.company_name || 'N/A'}</p>
                </div>
              </div>
              <div class="text-right">
                <span class="px-3 py-1 rounded-full text-xs font-medium ${statusColor}">${statusText}</span>
                <div class="text-xs text-gray-400 mt-1">${formatDate(rec.created_at)}</div>
              </div>
            </div>
            
            <!-- Grid de Pre√ßos -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm mb-4">
              <div class="text-center bg-gray-800 bg-opacity-30 rounded-lg p-3">
                <div class="text-xs text-gray-400 mb-1">Entrada</div>
                <div class="font-bold text-blue-400">R$ ${rec.entry_price.toFixed(2)}</div>
              </div>
              <div class="text-center bg-gray-800 bg-opacity-30 rounded-lg p-3">
                <div class="text-xs text-gray-400 mb-1">Atual</div>
                <div class="font-bold text-white">R$ ${rec.current_price.toFixed(2)}</div>
              </div>
              <div class="text-center bg-gray-800 bg-opacity-30 rounded-lg p-3">
                <div class="text-xs text-gray-400 mb-1">Alvo</div>
                <div class="font-bold text-green-400">R$ ${rec.target_price.toFixed(2)}</div>
              </div>
              <div class="text-center bg-gray-800 bg-opacity-30 rounded-lg p-3">
                <div class="text-xs text-gray-400 mb-1">Stop</div>
                <div class="font-bold text-red-400">R$ ${rec.stop_loss.toFixed(2)}</div>
              </div>
            </div>
            
            <!-- Performance -->
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-4 text-sm">
                <div class="flex items-center gap-2">
                  <span class="text-gray-400">Performance:</span>
                  <span class="font-bold ${rec.performance >= 0 ? 'text-green-400' : 'text-red-400'}">
                    ${rec.performance >= 0 ? '+' : ''}${rec.performance.toFixed(2)}%
                  </span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-gray-400">Confian√ßa:</span>
                  <span class="font-bold text-white">${rec.confidence}%</span>
                </div>
              </div>
            </div>
            
            <!-- A√ß√µes -->
            <div class="flex items-center justify-between pt-3 border-t border-gray-700">
              <div class="text-xs text-gray-500">
                ID: ${rec.id} | Criado: ${formatDate(rec.created_at)}
              </div>
              <div class="flex gap-2">
                ${rec.status === 'ATIVA' ? `
                  <button onclick="closeRecommendationFree(${rec.id})" 
                          class="bg-orange-600 hover:bg-orange-700 px-3 py-1 rounded text-xs font-medium transition-colors">
                    <i class="fas fa-times mr-1"></i>Encerrar
                  </button>
                ` : ''}
                <button onclick="deleteRecommendationFree(${rec.id})" 
                        class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-xs font-medium transition-colors">
                  <i class="fas fa-trash mr-1"></i>Remover
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function getStatusColor(status) {
      const colors = {
        'ATIVA': 'bg-green-600 text-green-200',
        'FINALIZADA_GANHO': 'bg-blue-600 text-blue-200', 
        'FINALIZADA_PERDA': 'bg-red-600 text-red-200',
        'FINALIZADA_MANUAL': 'bg-gray-600 text-gray-200'
      };
      return colors[status] || 'bg-gray-600 text-gray-200';
    }
    
    function getStatusText(status) {
      const texts = {
        'ATIVA': 'Ativa',
        'FINALIZADA_GANHO': 'Ganho',
        'FINALIZADA_PERDA': 'Perda', 
        'FINALIZADA_MANUAL': 'Manual'
      };
      return texts[status] || status;
    }
    
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      return new Date(dateString).toLocaleDateString('pt-BR');
    }

    // Update statistics
    function updateRecommendationsStats(recommendations) {
      const total = recommendations.length;
      const active = recommendations.filter(r => r.status === 'ATIVA').length;
      const closed = recommendations.filter(r => r.status.startsWith('FINALIZADA')).length;
      const wins = recommendations.filter(r => r.status === 'FINALIZADA_GANHO').length;
      
      const successRate = closed > 0 ? (wins / closed * 100) : 0;
      
      const gains = recommendations
        .filter(r => r.status === 'FINALIZADA_GANHO')
        .map(r => r.performance);
      const avgGain = gains.length > 0 ? gains.reduce((a, b) => a + b, 0) / gains.length : 0;
      
      const losses = recommendations
        .filter(r => r.status === 'FINALIZADA_PERDA')
        .map(r => r.performance);
      const avgLoss = losses.length > 0 ? losses.reduce((a, b) => a + b, 0) / losses.length : 0;
      
      // Update elements
      document.getElementById('recStatsTotal').textContent = total;
      document.getElementById('recStatsActive').textContent = active;
      document.getElementById('recStatsClosed').textContent = closed;
      document.getElementById('recStatsSuccess').textContent = `${successRate.toFixed(1)}%`;
      document.getElementById('recStatsAvgGain').textContent = `+${avgGain.toFixed(2)}%`;
      document.getElementById('recStatsAvgLoss').textContent = `${avgLoss.toFixed(2)}%`;
    }
  
    function formatTimeWithUs(days) {
      if (days < 1) return 'Hoje';
      if (days === 1) return '1 dia';
      if (days < 30) return `${days} dias`;
      if (days < 365) {
        const months = Math.floor(days / 30);
        return months === 1 ? '1 m√™s' : `${months} meses`;
      }
      const years = Math.floor(days / 365);
      const remainingMonths = Math.floor((days % 365) / 30);
      
      let result = years === 1 ? '1 ano' : `${years} anos`;
      if (remainingMonths > 0) {
        result += remainingMonths === 1 ? ', 1 m√™s' : `, ${remainingMonths} meses`;
      }
      return result;
    }

    // Enhanced user loading
    async function loadUsersEnhanced() {
      try {
        const timestamp = new Date().getTime();
        
        const response = await fetch(`/api/admin/list-users-enhanced?_t=${timestamp}`, {
          headers: { 
            'Authorization': `Bearer ${adminToken}`,
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            console.log(' Usu√°rios carregados:', result.users);
            displayUsersEnhanced(result.users);
          }
        }
      } catch (error) {
        console.error('‚ùå Erro ao carregar usu√°rios:', error);
        loadUsers();
      }
    }


    function displayUsersEnhanced(users) {
      const tbody = document.getElementById('usersTableEnhanced');
      
      if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-400">Nenhum usu√°rio encontrado</td></tr>';
        return;
      }

      window.userTimers = window.userTimers || [];
      window.userTimers.forEach(timer => clearInterval(timer));
      window.userTimers = [];

      tbody.innerHTML = users.map((user, index) => {
        const uniqueId = `countdown-${user.id}-${index}`;
        let timeInfo = '';
        let statusBadge = '';
        
        if (user.subscription_status === 'trial') {
          statusBadge = '<span class="px-2 py-1 rounded text-xs font-medium bg-yellow-600 text-yellow-200">Trial</span>';
        } else if (user.subscription_status === 'active') {
          statusBadge = '<span class="px-2 py-1 rounded text-xs font-medium bg-green-600 text-green-200">Ativo</span>';
        } else if (user.is_expired) {
          statusBadge = '<span class="px-2 py-1 rounded text-xs font-medium bg-red-600 text-red-200">Expirado</span>';
        } else {
          statusBadge = '<span class="px-2 py-1 rounded text-xs font-medium bg-gray-600 text-gray-200">Free</span>';
        }
        
        if (user.has_trial && user.plan_expires_at) {
          if (user.is_expired) {
            timeInfo = `
              <div class="text-xs text-red-400">Expirou</div>
              <div class="text-xs text-gray-500">Conosco: ${formatTimeWithUs(user.days_with_us)}</div>
            `;
          } else {
            timeInfo = `
              <div class="text-xs" id="${uniqueId}">Calculando...</div>
              <div class="text-xs text-gray-500">Conosco: ${formatTimeWithUs(user.days_with_us)}</div>
            `;
            
            setTimeout(() => {
              const timer = createCountdownTimer(user.plan_expires_at, uniqueId);
              window.userTimers.push(timer);
            }, 100);
          }
        } else {
          timeInfo = `
            <div class="text-xs text-gray-400">Sem expira√ß√£o</div>
            <div class="text-xs text-gray-500">Conosco: ${formatTimeWithUs(user.days_with_us)}</div>
          `;
        }
        
        let lastLoginInfo = '';
        if (user.last_login) {
          const lastLoginDate = new Date(user.last_login);
          const now = new Date();
          
          // Zerar horas para comparar apenas datas
          const lastLoginDay = new Date(lastLoginDate.getFullYear(), lastLoginDate.getMonth(), lastLoginDate.getDate());
          const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          
          const diffMs = today - lastLoginDay;
          const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
          
          const dateStr = lastLoginDate.toLocaleDateString('pt-BR');
          
          let timeAgo = '';
          if (diffDays === 0) {
            timeAgo = 'Hoje';
          } else if (diffDays === 1) {
            timeAgo = 'Ontem';
          } else if (diffDays < 7) {
            timeAgo = `${diffDays}d atr√°s`;
          } else if (diffDays < 30) {
            const weeks = Math.floor(diffDays / 7);
            timeAgo = `${weeks}sem atr√°s`;
          } else if (diffDays < 365) {
            const months = Math.floor(diffDays / 30);
            timeAgo = `${months}m atr√°s`;
          } else {
            const years = Math.floor(diffDays / 365);
            timeAgo = `${years}a atr√°s`;
          }
          
          let colorClass = 'text-green-400';
          if (diffDays > 7) colorClass = 'text-yellow-400';
          if (diffDays > 30) colorClass = 'text-orange-400';
          if (diffDays > 90) colorClass = 'text-red-400';
          
          lastLoginInfo = `
            <div class="text-xs ${colorClass}">${dateStr}</div>
            <div class="text-xs text-gray-500">${timeAgo}</div>
          `;
        } else {
          lastLoginInfo = '<div class="text-xs text-gray-500">Nunca</div>';
        }
        
        return `
          <tr class="table-row">
            <td class="py-3 px-2">
              <div class="font-medium text-white">${user.name}</div>
              <div class="text-xs text-gray-400">${user.email}</div>
              <div class="text-xs text-gray-500 mt-1">${user.formatted_date}</div>
            </td>
            <td class="py-3 px-2">
              <span class="px-2 py-1 rounded text-xs font-medium ${getPlanBadgeClass(user.plan)}">
                ${user.plan}
              </span>
              <div class="text-xs text-gray-500 mt-1">${getTypeBadgeText(user.type)}</div>
            </td>
            <td class="py-3 px-2">
              ${statusBadge}
            </td>
            <td class="py-3 px-2">
              ${timeInfo}
            </td>
            <td class="py-3 px-2">
              ${lastLoginInfo}
            </td>
            <td class="py-3 px-2">
              <button onclick="fillUserEmail('${user.email}')" class="text-blue-400 hover:text-blue-300 text-sm">
                <i class="fas fa-edit mr-1"></i>Editar
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }


    function getTypeBadgeText(type) {
      const types = {
        'admin': 'Administrador',
        'master': 'Master',
        'regular': 'Regular',
        'trial': 'Em Trial'
      };
      return types[type] || 'Regular';
    }

    // Trial management functions
    async function grantTrial() {
      const email = document.getElementById('manageUserEmail').value;
      const days = document.getElementById('trialDays').value;
      
      if (!email) {
        alert('‚ùå Digite o email do usu√°rio');
        return;
      }
      
      try {
        const response = await fetch('/api/admin/manage-trial', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({
            user_email: email,
            action: 'grant',
            days: parseInt(days)
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' ' + result.message);
          document.getElementById('manageUserEmail').value = '';
          loadUsersEnhanced();
        } else {
          alert('‚ùå ' + result.error);
        }
        
      } catch (error) {
        alert('‚ùå Erro de conex√£o');
      }
    }

    async function revokeTrial() {
      const email = document.getElementById('manageUserEmail').value;
      
      if (!email) {
        alert('‚ùå Digite o email do usu√°rio');
        return;
      }
      
      try {
        const response = await fetch('/api/admin/manage-trial', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminToken}`
          },
          body: JSON.stringify({
            user_email: email,
            action: 'revoke'
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' ' + result.message);
          document.getElementById('manageUserEmail').value = '';
          loadUsersEnhanced();
        } else {
          alert('‚ùå ' + result.error);
        }
        
      } catch (error) {
        alert('‚ùå Erro de conex√£o');
      }
    }

  // Criar novo usu√°rio
  async function createNewUser() {
    const name = document.getElementById('newUserName').value.trim();
    const email = document.getElementById('newUserEmail').value.trim();
    const trialDays = document.getElementById('newUserTrialDays').value;
    
    if (!name || !email) {
      alert('‚ùå Nome e email s√£o obrigat√≥rios');
      return;
    }
    
    if (!confirm(`Criar usu√°rio "${name}" com trial de ${trialDays} dias?`)) return;
    
    try {
      const response = await fetch('/api/admin/create-user', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${adminToken}`
        },
        body: JSON.stringify({
          name: name,
          email: email,
          trial_days: parseInt(trialDays)
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        alert(` Usu√°rio criado!\nEmail: ${email}\nSenha: 123456\nTrial: ${trialDays} dias`);
        
        // Limpar formul√°rio
        document.getElementById('newUserName').value = '';
        document.getElementById('newUserEmail').value = '';
        
        // Recarregar
        loadUsersEnhanced();
        loadDashboardStats();
      } else {
        alert('‚ùå ' + result.error);
      }
      
    } catch (error) {
      alert('‚ùå Erro de conex√£o');
    }
  }

  // Countdown timer function
  function createCountdownTimer(expiryDate, elementId) {
    const updateCountdown = () => {
      const now = new Date().getTime();
      const expiry = new Date(expiryDate).getTime();
      const distance = expiry - now;
      
      const element = document.getElementById(elementId);
      if (!element) return;
      
      if (distance < 0) {
        element.innerHTML = '<span class="text-red-400">Expirado</span>';
        return;
      }
      
      const days = Math.floor(distance / (1000 * 60 * 60 * 24));
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      
      if (days > 0) {
        element.innerHTML = `<span class="text-green-400">${days}d ${hours}h restantes</span>`;
      } else if (hours > 0) {
        element.innerHTML = `<span class="text-yellow-400">${hours}h ${minutes}m restantes</span>`;
      } else {
        element.innerHTML = `<span class="text-orange-400">${minutes}m restantes</span>`;
      }
    };
    
    updateCountdown();
    return setInterval(updateCountdown, 60000); // Update every minute
  }

    // Create recommendation
    async function createRecommendationFree() {
      const formData = {
        ticker: document.getElementById('recFreeTicker').value.toUpperCase().trim(),
        action: document.getElementById('recFreeAction').value,
        entry_price: parseFloat(document.getElementById('recFreeEntryPrice').value),
        stop_loss: parseFloat(document.getElementById('recFreeStopLoss').value),
        target_price: parseFloat(document.getElementById('recFreeTargetPrice').value),
        confidence: parseFloat(document.getElementById('recFreeConfidence').value) || 85
      };

      // Validations
      if (!formData.ticker || !formData.action || !formData.entry_price || !formData.stop_loss || !formData.target_price) {
        alert('‚ùå Preencha todos os campos obrigat√≥rios!');
        return;
      }

      try {
        const response = await fetch('/api/recommendations/admin/create-single', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' Recomenda√ß√£o criada com sucesso!');
          
          // Clear form
          document.getElementById('recFreeTicker').value = '';
          document.getElementById('recFreeAction').value = '';
          document.getElementById('recFreeEntryPrice').value = '';
          document.getElementById('recFreeStopLoss').value = '';
          document.getElementById('recFreeTargetPrice').value = '';
          document.getElementById('recFreeConfidence').value = '85';
          
          // Reload list
          loadRecommendationsFree();
        } else {
          alert('‚ùå ' + result.error);
        }
        
      } catch (error) {
        console.error('Error creating recommendation:', error);
        alert('‚ùå Erro de conex√£o com o servidor');
      }
    }

    // Close recommendation
    async function closeRecommendationFree(recId) {
      if (!confirm('Encerrar esta recomenda√ß√£o?')) return;

      try {
        const response = await fetch(`/api/recommendations/admin/close/${recId}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            status: 'FINALIZADA_MANUAL'
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' Recomenda√ß√£o encerrada com sucesso!');
          loadRecommendationsFree();
        } else {
          alert('‚ùå ' + result.error);
        }
        
      } catch (error) {
        console.error('Error closing recommendation:', error);
        alert('‚ùå Erro de conex√£o com o servidor');
      }
    }

    // Delete recommendation
    async function deleteRecommendationFree(recId) {
      if (!confirm('‚ùå Remover esta recomenda√ß√£o permanentemente?')) return;

      try {
        const response = await fetch(`/api/recommendations/admin/delete/${recId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' Recomenda√ß√£o removida com sucesso!');
          loadRecommendationsFree();
        } else {
          alert('‚ùå ' + result.error);
        }
        
      } catch (error) {
        console.error('Error deleting recommendation:', error);
        alert('‚ùå Erro de conex√£o com o servidor');
      }
    }

    // Generate monthly recommendations
    async function generateMonthlyRecommendations() {
      if (!confirm('Gerar novas recomenda√ß√µes mensais automaticamente?')) return;
      
      const button = event.target;
      const originalText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Gerando...';
      
      try {
        const response = await fetch('/api/recommendations/admin/generate', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(` ${result.message}\n\n${result.recommendations.length} recomenda√ß√µes criadas!`);
          loadRecommendationsFree();
        } else {
          alert('‚ùå ' + result.error);
        }
        
      } catch (error) {
        console.error('Error generating recommendations:', error);
        alert('‚ùå Erro de conex√£o com o servidor');
      } finally {
        button.disabled = false;
        button.innerHTML = originalText;
      }
    }

    // Update all prices
    async function updateAllPrices() {
      const button = event.target;
      const originalText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Atualizando...';
      
      try {
        const response = await fetch('/api/recommendations/admin/update-prices', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(' Pre√ßos atualizados com sucesso!');
          loadRecommendationsFree();
        } else {
          alert('‚ùå ' + result.error);
        }
        
      } catch (error) {
        console.error('Error updating prices:', error);
        alert('‚ùå Erro de conex√£o com o servidor');
      } finally {
        button.disabled = false;
        button.innerHTML = originalText;
      }
    }

    function exportUsers() {
      const token = localStorage.getItem('geminii_token');
      
      if (!token) {
          alert('‚ùå Token n√£o encontrado. Fa√ßa login novamente.');
          return;
      }
      
      fetch('/api/admin/export-users', {
          method: 'GET',
          headers: {
              'Authorization': `Bearer ${token}`
          }
      })
      .then(response => {
          if (!response.ok) {
              throw new Error('Erro ao exportar');
          }
          return response.blob();
      })
      .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `usuarios_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
      })
      .catch(error => {
          alert('‚ùå Erro ao exportar: ' + error.message);
      });
    }  

    // Logout
    function logout() {
      if (confirm('Deseja realmente sair do painel administrativo?')) {
        localStorage.removeItem('geminii_token');
        localStorage.removeItem('geminii_user');
        window.location.href = '/';
      }
    }

    // ===== RAILWAY SYNC FUNCTIONS =====

    // Load Railway status on section open
    async function loadRailwaySync() {
      loadRailwayStatus();
      loadRailwayDates();
      loadRailwayResumo();
    }

    // Load status
    async function loadRailwayStatus() {
      try {
        const response = await fetch('/railway/status', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            displayRailwayStatus(result.data);
          }
        }
      } catch (error) {
        console.error('Error loading railway status:', error);
        document.getElementById('railwayStatus').innerHTML = `
          <div class="text-red-400 text-sm">‚ùå Erro ao conectar</div>
        `;
      }
    }

    function displayRailwayStatus(status) {
      const container = document.getElementById('railwayStatus');
      
      if (status.status === 'erro') {
        container.innerHTML = `
          <div class="text-red-400 text-sm">‚ùå ${status.mensagem}</div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="flex justify-between text-sm">
          <span class="text-gray-400">Status:</span>
          <span class="text-green-400"> Conectado</span>
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-gray-400">Total Registros:</span>
          <span class="text-white">${status.total_registros.toLocaleString('pt-BR')}</span>
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-gray-400">Datas:</span>
          <span class="text-white">${status.datas_disponiveis}</span>
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-gray-400">√öltima:</span>
          <span class="text-white">${status.ultima_atualizacao || 'N/A'}</span>
        </div>
      `;
    }

    // Load dates
    async function loadRailwayDates() {
      try {
        const response = await fetch('/railway/datas-disponiveis', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            displayRailwayDates(result.datas);
          }
        }
      } catch (error) {
        console.error('Error loading dates:', error);
      }
    }

    function displayRailwayDates(datas) {
      const container = document.getElementById('railwayDates');
      
      container.innerHTML = datas.slice(0, 10).map(data => `
        <div class="flex items-center justify-between p-2 rounded ${data.existe_no_banco ? 'bg-green-900 bg-opacity-20' : 'bg-gray-800 bg-opacity-30'}">
          <span class="text-xs text-gray-300">${data.data_formatada}</span>
          <span class="text-xs ${data.existe_no_banco ? 'text-green-400' : 'text-gray-500'}">
            ${data.existe_no_banco ? '' : '‚è≥'}
          </span>
        </div>
      `).join('');
      
      if (datas.length > 10) {
        container.innerHTML += `
          <div class="text-xs text-gray-500 text-center mt-2">
            +${datas.length - 10} datas...
          </div>
        `;
      }
    }

    // Load resumo
    async function loadRailwayResumo() {
      try {
        const response = await fetch('/railway/resumo', {
          headers: { 'Authorization': `Bearer ${adminToken}` }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            const resumo = result.resumo;
            document.getElementById('railwayTotalReg').textContent = resumo.total_registros.toLocaleString('pt-BR');
            document.getElementById('railwayDatasDisp').textContent = resumo.datas_no_banco;
            document.getElementById('railwayUltimaData').textContent = resumo.ultima_atualizacao || '-';
            document.getElementById('railwayProgresso').textContent = `${resumo.percentual_completo}%`;
          }
        }
      } catch (error) {
        console.error('Error loading resumo:', error);
      }
    }

    // Run sync
    async function runRailwaySync() {
      const button = document.getElementById('syncButton');
      const console = document.getElementById('syncConsole');
      
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sincronizando...';
      
      console.innerHTML = `
        <div class="text-green-400">üöÇ Iniciando sincroniza√ß√£o...</div>
        <div class="text-gray-400">üì° Conectando ao Railway...</div>
      `;
      
      try {
        const response = await fetch('/railway/sync', {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${adminToken}`,
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();
        
        if (result.success) {
          const data = result.data;
          
          console.innerHTML += `
            <div class="text-blue-400 mt-2"> Processando datas...</div>
          `;
          
          data.detalhes.forEach(det => {
            let icon = det.status === 'sucesso' ? '' : det.status === 'pulado' ? '‚è≠Ô∏è' : '‚ùå';
            let color = det.status === 'sucesso' ? 'text-green-400' : det.status === 'pulado' ? 'text-yellow-400' : 'text-red-400';
            
            console.innerHTML += `
              <div class="${color}">${icon} ${det.data} - ${det.status.toUpperCase()}${det.registros ? ` (${det.registros} registros)` : ''}</div>
            `;
          });
          
          console.innerHTML += `
            <div class="text-white mt-3">‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</div>
            <div class="text-green-400"> RESUMO:</div>
            <div class="text-white"> Sucesso: ${data.resumo.sucesso}</div>
            <div class="text-yellow-400">‚è≠Ô∏è  Pulados: ${data.resumo.pulados}</div>
            <div class="text-red-400">‚ùå Falhas: ${data.resumo.falhas}</div>
            <div class="text-white mt-2">üíæ Total no banco: ${data.banco.total_registros.toLocaleString('pt-BR')} registros</div>
            <div class="text-green-400 mt-3"> Sincroniza√ß√£o conclu√≠da!</div>
          `;
          
          loadRailwayStatus();
          loadRailwayDates();
          loadRailwayResumo();
          
        } else {
          console.innerHTML += `
            <div class="text-red-400 mt-2">‚ùå Erro: ${result.error}</div>
          `;
        }
        
      } catch (error) {
        console.innerHTML += `
          <div class="text-red-400 mt-2">‚ùå Erro de conex√£o: ${error.message}</div>
        `;
      } finally {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Sincronizar Dados B3 ‚Üí Railway';
        console.scrollTop = console.scrollHeight;
      }
    }

    // Clear console
    function clearSyncConsole() {
      document.getElementById('syncConsole').innerHTML = `
        <div class="text-green-400">üöÇ Railway Sync Console - Pronto</div>
        <div class="text-gray-500">Aguardando comando...</div>
      `;
    }

    // Initialize admin dashboard
    async function initAdminDashboard() {
      console.log('üöÄ Inicializando Admin Dashboard...');
      
      await checkAdminAuth();
      await loadDashboardStats();
      loadRecentActivity();
      
      // Setup navigation event listeners
      setupNavigation();
      
      console.log(' Admin Dashboard carregado!');
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initAdminDashboard);

  </script>
</body>
</html>