<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ranking Volatilidade Impl√≠cita - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#000000',
            light: '#ffffff',
            subtle: 'rgba(255,255,255,0.1)',
            geminii: '#ba39af'
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
      min-height: 100vh;
    }
    
    .rank-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 2rem;
      transition: all 0.3s ease;
    }
    
    .rank-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(186, 57, 175, 0.15);
      border-color: rgba(186, 57, 175, 0.3);
    }

    .metric-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(186, 57, 175, 0.3);
    }

    .top-highlight {
      background: linear-gradient(135deg, rgba(186, 57, 175, 0.2), rgba(139, 92, 246, 0.2));
      border-color: #ba39af;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .spinner {
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 2px solid #ba39af;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .rank-table {
      overflow-x: auto;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
    }

    .rank-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .rank-table th,
    .rank-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .rank-table th {
      background: rgba(255, 255, 255, 0.05);
      font-weight: 600;
      color: #ba39af;
    }

    .rank-table .rank-1 { color: #ffd700; font-weight: bold; }
    .rank-table .rank-2 { color: #c0c0c0; font-weight: bold; }
    .rank-table .rank-3 { color: #cd7f32; font-weight: bold; }

    .iv-high { color: #ef4444; font-weight: 600; }
    .iv-medium { color: #f59e0b; font-weight: 600; }
    .iv-low { color: #10b981; font-weight: 600; }

    .volume-high { color: #8b5cf6; }
    .volume-medium { color: #06b6d4; }
    .volume-low { color: #6b7280; }

    .chart-container {
      position: relative;
      height: 400px;
      width: 100%;
    }

    .filter-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .filter-tab {
      padding: 0.75rem 1.5rem;
      border-radius: 25px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #d1d5db;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .filter-tab:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(186, 57, 175, 0.3);
    }

    .filter-tab.active {
      background: linear-gradient(135deg, #ba39af, #8b5cf6);
      border-color: #ba39af;
      color: white;
    }

    .pulse-glow {
      animation: pulseGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes pulseGlow {
      from { box-shadow: 0 0 20px rgba(186, 57, 175, 0.3); }
      to { box-shadow: 0 0 30px rgba(186, 57, 175, 0.6); }
    }

    .status-critical { color: #ef4444; }
    .status-high { color: #f59e0b; }
    .status-medium { color: #3b82f6; }
    .status-low { color: #10b981; }

    .percentil-critical { color: #ef4444; font-weight: 600; }
    .percentil-high { color: #f59e0b; font-weight: 600; }
    .percentil-medium { color: #3b82f6; font-weight: 600; }
    .percentil-low { color: #10b981; font-weight: 600; }

    .ratio-critical { color: #ef4444; font-weight: 600; }
    .ratio-high { color: #f59e0b; font-weight: 600; }
    .ratio-medium { color: #3b82f6; font-weight: 600; }
    .ratio-low { color: #10b981; font-weight: 600; }
  </style>
</head>
<body class="text-white">
  
  <!-- Navbar -->
  <nav class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-opacity-5 border-opacity-10 bg-white border-white border rounded-full px-4 py-3 shadow-xl backdrop-blur-md">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <img src="logo.png" alt="Geminii Logo" class="w-6 h-6 cursor-pointer" onclick="window.location.href='/'">
      </div>
      <div class="hidden md:flex items-center space-x-6 text-xs text-gray-300 ml-8">
        <a href="/dashboard" class="hover:text-white transition-colors">Dashboard</a>
        <a href="opcoes.html" class="hover:text-white transition-colors">Op√ß√µes</a>
        <span class="text-white font-medium">Rank IV</span>
      </div>
      <div class="flex items-center space-x-3 ml-8">
        <div id="apiStatus" class="w-8 h-8 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-full flex items-center justify-center relative">
          <i class="fas fa-chart-line text-green-500 text-xs"></i>
          <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Content -->
  <div class="pt-32 pb-16">
    <div class="max-w-7xl mx-auto px-6">
      
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">
          <span style="color: #ba39af; font-weight: 900;">Ranking</span>
          <span class="text-white font-light">Volatilidade Impl√≠cita</span>
        </h1>
        <p class="text-neutral-300 text-lg max-w-2xl mx-auto">
          An√°lise completa das oportunidades em op√ß√µes por volatilidade impl√≠cita
        </p>
      </div>

      <!-- Status Banner -->
      <div id="statusBanner" class="rank-card mb-8 text-center hidden">
        <div class="flex items-center justify-center gap-3 mb-3">
          <div class="spinner"></div>
          <span class="text-lg font-semibold">Carregando dados...</span>
        </div>
        <p class="text-gray-400">Buscando dados atualizados do mercado</p>
      </div>

      <!-- Top 5 Cards - IV Alta e Baixa -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        
        <!-- Top 5 IV Alta -->
        <div class="rank-card pulse-glow">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-red-400">
              <i class="fas fa-fire mr-2"></i>
              Top 5 IV Mais Alta
            </h2>
            <span class="px-3 py-1 bg-red-500 bg-opacity-20 text-red-300 rounded-full text-sm font-semibold">
              VENDAS
            </span>
          </div>
          <p class="text-gray-300 mb-4">Ideal para vendedores de op√ß√µes - pr√™mios elevados</p>
          
          <div id="topIvAlta" class="space-y-3">
            <!-- Top 5 IV alta ser√° carregado aqui -->
          </div>
          
          <div class="mt-4 p-3 bg-red-500 bg-opacity-10 border border-red-500 border-opacity-30 rounded-lg">
            <p class="text-sm text-red-300">
              <i class="fas fa-info-circle mr-2"></i>
              <strong>Estrat√©gia:</strong> Venda de op√ß√µes com pr√™mios altos devido √† alta volatilidade impl√≠cita
            </p>
          </div>
        </div>

        <!-- Top 5 IV Baixa -->
        <div class="rank-card pulse-glow">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-green-400">
              <i class="fas fa-snowflake mr-2"></i>
              Top 5 IV Mais Baixa
            </h2>
            <span class="px-3 py-1 bg-green-500 bg-opacity-20 text-green-300 rounded-full text-sm font-semibold">
              COMPRAS
            </span>
          </div>
          <p class="text-gray-300 mb-4">Ideal para compradores de op√ß√µes - pr√™mios baixos</p>
          
          <div id="topIvBaixa" class="space-y-3">
            <!-- Top 5 IV baixa ser√° carregado aqui -->
          </div>
          
          <div class="mt-4 p-3 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-lg">
            <p class="text-sm text-green-300">
              <i class="fas fa-info-circle mr-2"></i>
              <strong>Estrat√©gia:</strong> Compra de op√ß√µes com pr√™mios baixos devido √† baixa volatilidade impl√≠cita
            </p>
          </div>
        </div>

      </div>

      <!-- Filtros -->
      <div class="rank-card mb-8">
        <h3 class="text-xl font-bold mb-4">
          <i class="fas fa-filter mr-2 text-purple-400"></i>
          Visualiza√ß√µes Dispon√≠veis
        </h3>
        
        <div class="filter-tabs">
          <div class="filter-tab active" onclick="selectFilter('iv_atual')" id="tab-iv_atual">
            <i class="fas fa-chart-line mr-2"></i>
            IV Atual
          </div>
          <div class="filter-tab" onclick="selectFilter('iv_vs_6m')" id="tab-iv_vs_6m">
            <i class="fas fa-chart-bar mr-2"></i>
            IV vs 6M M√°ximo
          </div>
          <div class="filter-tab" onclick="selectFilter('iv_percentil')" id="tab-iv_percentil">
            <i class="fas fa-percentage mr-2"></i>
            IV Percentil
          </div>
          <div class="filter-tab" onclick="selectFilter('iv_vs_volume')" id="tab-iv_vs_volume">
            <i class="fas fa-chart-scatter mr-2"></i>
            IV vs Volume
          </div>
        </div>
      </div>

      <!-- Painel Principal -->
      <div class="rank-card mb-8">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold" id="mainTitle">
            <i class="fas fa-trophy mr-2 text-yellow-400"></i>
            Ranking por Volatilidade Impl√≠cita Atual
          </h3>
          <div class="flex gap-2">
            <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition-colors">
              <i class="fas fa-sync-alt mr-1"></i>
              Atualizar
            </button>
          </div>
        </div>

        <!-- Estat√≠sticas R√°pidas -->
        <div id="quickStats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <!-- Estat√≠sticas ser√£o carregadas aqui -->
        </div>

        <!-- Conte√∫do Principal -->
        <div id="mainContent">
          <!-- Conte√∫do principal ser√° carregado aqui -->
        </div>
      </div>

      <!-- Gr√°fico de Dispers√£o IV vs Volume -->
      <div id="scatterSection" class="rank-card mb-8" style="display: none;">
        <h3 class="text-2xl font-bold mb-6">
          <i class="fas fa-chart-scatter mr-2 text-blue-400"></i>
          Volatilidade Impl√≠cita vs Volume Financeiro
        </h3>
        <div class="chart-container">
          <canvas id="scatterChart"></canvas>
        </div>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
          <div class="metric-card">
            <div class="text-lg font-bold text-blue-400" id="scatterHighVolume">--</div>
            <div class="text-sm text-gray-400">Alto Volume + Alta IV</div>
          </div>
          <div class="metric-card">
            <div class="text-lg font-bold text-green-400" id="scatterLowVolume">--</div>
            <div class="text-sm text-gray-400">Baixo Volume + Baixa IV</div>
          </div>
          <div class="metric-card">
            <div class="text-lg font-bold text-purple-400" id="scatterCorrelation">--</div>
            <div class="text-sm text-gray-400">Correla√ß√£o IV-Volume</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // Estado da aplica√ß√£o
    let currentFilter = 'iv_atual';
    let currentData = {};
    let scatterChart = null;
    
    // Elementos DOM
    const statusBanner = document.getElementById('statusBanner');
    const mainContent = document.getElementById('mainContent');
    const mainTitle = document.getElementById('mainTitle');
    const quickStats = document.getElementById('quickStats');
    const scatterSection = document.getElementById('scatterSection');
    
    // API Endpoints
    const API_BASE = '/api/rank';
    
    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Ranking Volatilidade Impl√≠cita carregado');
      loadInitialData();
      checkApiHealth();
    });
    
    // Verificar sa√∫de da API
    async function checkApiHealth() {
      try {
        const response = await fetch(`${API_BASE}/health`);
        const data = await response.json();
        
        const statusEl = document.getElementById('apiStatus');
        if (data.status === 'OK') {
          statusEl.className = 'w-8 h-8 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-full flex items-center justify-center relative';
          console.log('‚úÖ API de Ranking funcionando:', data.message);
        } else {
          statusEl.className = 'w-8 h-8 bg-red-500 bg-opacity-10 border border-red-500 border-opacity-30 rounded-full flex items-center justify-center relative';
          console.warn('‚ö†Ô∏è API com problemas:', data.message);
        }
      } catch (error) {
        console.error('‚ùå Erro ao verificar API:', error);
        const statusEl = document.getElementById('apiStatus');
        statusEl.className = 'w-8 h-8 bg-red-500 bg-opacity-10 border border-red-500 border-opacity-30 rounded-full flex items-center justify-center relative';
      }
    }
    
    // Carregar dados iniciais
    async function loadInitialData() {
      showLoading();
      
      try {
        // Carregar dados principais
        await Promise.all([
          loadRankingData('iv_atual'),
          loadTopIV('alta'),
          loadTopIV('baixa'),
          loadQuickStats()
        ]);
        
        console.log('‚úÖ Dados iniciais carregados');
      } catch (error) {
        console.error('‚ùå Erro ao carregar dados iniciais:', error);
        showError('Erro ao carregar dados iniciais');
      }
      
      hideLoading();
    }
    
    // Mostrar loading
    function showLoading() {
      statusBanner.classList.remove('hidden');
      statusBanner.className = 'rank-card mb-8 text-center';
      const spinner = document.querySelector('#statusBanner .spinner');
      const text = document.querySelector('#statusBanner span');
      if (spinner) spinner.style.display = 'inline-block';
      if (text) text.textContent = 'Carregando dados...';
    }
    
    // Esconder loading
    function hideLoading() {
      statusBanner.classList.add('hidden');
    }
    
    // Mostrar erro
    function showError(message) {
      statusBanner.classList.remove('hidden');
      statusBanner.className = 'rank-card mb-8 text-center bg-red-500 bg-opacity-10 border-red-500 border-opacity-30';
      const spinner = document.querySelector('#statusBanner .spinner');
      const text = document.querySelector('#statusBanner span');
      const subtext = document.querySelector('#statusBanner p');
      
      if (spinner) spinner.style.display = 'none';
      if (text) text.textContent = 'Erro';
      if (subtext) subtext.textContent = message;
    }
    
    // Carregar Top 5 IV
    async function loadTopIV(tipo) {
      try {
        const response = await fetch(`${API_BASE}/top-iv?tipo=${tipo}&quantidade=5`);
        const data = await response.json();
        
        if (data.success) {
          renderTopIV(tipo, data.top_acoes);
        } else {
          console.error(`Erro ao carregar top IV ${tipo}:`, data.error);
        }
      } catch (error) {
        console.error(`Erro ao buscar top IV ${tipo}:`, error);
      }
    }
    
    // Renderizar Top 5 IV
    function renderTopIV(tipo, acoes) {
      const containerId = tipo === 'alta' ? 'topIvAlta' : 'topIvBaixa';
      const container = document.getElementById(containerId);
      
      if (!acoes || acoes.length === 0) {
        container.innerHTML = '<p class="text-gray-500">Nenhum dado dispon√≠vel</p>';
        return;
      }
      
      const colorClass = tipo === 'alta' ? 'text-red-400' : 'text-green-400';
      
      container.innerHTML = acoes.map((acao, index) => `
        <div class="flex items-center justify-between p-3 bg-white bg-opacity-5 rounded-lg hover:bg-opacity-10 transition-colors">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center font-bold text-sm">
              ${index + 1}
            </div>
            <div>
              <div class="font-semibold text-white">${acao.symbol}</div>
              <div class="text-xs text-gray-400">${acao.name || 'N/A'}</div>
            </div>
          </div>
          <div class="text-right">
            <div class="font-bold ${colorClass}">${acao.iv_current?.toFixed(2) || '0.00'}%</div>
            <div class="text-xs text-gray-400">R$ ${(acao.close || 0).toFixed(2)}</div>
          </div>
        </div>
      `).join('');
    }
    
    // Carregar estat√≠sticas r√°pidas
    async function loadQuickStats() {
      try {
        const response = await fetch(`${API_BASE}/estatisticas`);
        const data = await response.json();
        
        if (data.success) {
          renderQuickStats(data);
        }
      } catch (error) {
        console.error('Erro ao carregar estat√≠sticas:', error);
      }
    }
    
    // Renderizar estat√≠sticas r√°pidas
    function renderQuickStats(data) {
      const stats = data.estatisticas_iv || {};
      
      quickStats.innerHTML = `
        <div class="metric-card text-center">
          <div class="text-2xl font-bold text-blue-400">${data.total_acoes_processadas || 0}</div>
          <div class="text-sm text-gray-400">A√ß√µes Analisadas</div>
        </div>
        <div class="metric-card text-center">
          <div class="text-2xl font-bold text-purple-400">${stats.iv_media?.toFixed(2) || '0.00'}%</div>
          <div class="text-sm text-gray-400">IV M√©dia</div>
        </div>
        <div class="metric-card text-center">
          <div class="text-2xl font-bold text-red-400">${stats.iv_max?.toFixed(2) || '0.00'}%</div>
          <div class="text-sm text-gray-400">IV M√°xima</div>
        </div>
        <div class="metric-card text-center">
          <div class="text-2xl font-bold text-green-400">${stats.iv_min?.toFixed(2) || '0.00'}%</div>
          <div class="text-sm text-gray-400">IV M√≠nima</div>
        </div>
      `;
    }
    
    // Selecionar filtro
    function selectFilter(filter) {
      // Atualizar visual dos tabs
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      const activeTab = document.getElementById(`tab-${filter}`);
      if (activeTab) activeTab.classList.add('active');
      
      currentFilter = filter;
      
      // Carregar dados do filtro
      loadRankingData(filter);
      
      // Atualizar t√≠tulo
      updateMainTitle(filter);
      
      // Mostrar/esconder se√ß√µes espec√≠ficas
      if (filter === 'iv_vs_volume') {
        scatterSection.style.display = 'block';
        loadScatterData();
      } else {
        scatterSection.style.display = 'none';
      }
    }
    
    // Atualizar t√≠tulo principal
    function updateMainTitle(filter) {
      const titles = {
        'iv_atual': 'üèÜ Ranking por Volatilidade Impl√≠cita Atual',
        'iv_vs_6m': 'üìä IV Atual vs IV 6M M√°ximo',
        'iv_percentil': 'üìà Ranking por Percentil de IV',
        'iv_vs_volume': 'üíπ IV vs Volume Financeiro'
      };
      
      const title = titles[filter] || titles['iv_atual'];
      mainTitle.innerHTML = `<i class="fas fa-trophy mr-2 text-yellow-400"></i>${title}`;
    }
    
    // Carregar dados de ranking
    async function loadRankingData(filter) {
      try {
        showLoading();
        
        let endpoint = '';
        const params = 'top_n=20';
        
        switch (filter) {
          case 'iv_atual':
            endpoint = `${API_BASE}/iv-ranking?rank_by=iv_current&${params}`;
            break;
          case 'iv_vs_6m':
            endpoint = `${API_BASE}/iv-6m-comparison?${params}`;
            break;
          case 'iv_percentil':
            endpoint = `${API_BASE}/iv-percentil?${params}`;
            break;
          case 'iv_vs_volume':
            endpoint = `${API_BASE}/iv-vs-volume?${params}`;
            break;
          default:
            endpoint = `${API_BASE}/iv-ranking?rank_by=iv_current&${params}`;
        }
        
        const response = await fetch(endpoint);
        const data = await response.json();
        
        if (data.success) {
          currentData[filter] = data;
          renderMainContent(filter, data);
        } else {
          showError(data.error || 'Erro ao carregar dados');
        }
        
      } catch (error) {
        console.error(`Erro ao carregar dados ${filter}:`, error);
        showError('Erro de conex√£o');
      }
      
      hideLoading();
    }
    
    // Renderizar conte√∫do principal
    function renderMainContent(filter, data) {
      switch (filter) {
        case 'iv_atual':
          renderIVAtualTable(data);
          break;
        case 'iv_vs_6m':
          renderIVComparison(data);
          break;
        case 'iv_percentil':
          renderIVPercentil(data);
          break;
        case 'iv_vs_volume':
          renderIVVolume(data);
          break;
        default:
          renderIVAtualTable(data);
      }
    }
    
    // Renderizar tabela IV Atual
    function renderIVAtualTable(data) {
      const ranking = data.rankings?.iv_atual || [];
      
      if (ranking.length === 0) {
        mainContent.innerHTML = '<p class="text-center text-gray-500">Nenhum dado dispon√≠vel</p>';
        return;
      }
      
      mainContent.innerHTML = `
        <div class="rank-table">
          <table>
            <thead>
              <tr>
                <th>Posi√ß√£o</th>
                <th>Ativo</th>
                <th>Nome</th>
                <th>IV Atual</th>
                <th>Pre√ßo</th>
                <th>Volume</th>
                <th>Volume Financeiro</th>
                <th>Varia√ß√£o</th>
              </tr>
            </thead>
            <tbody>
              ${ranking.map(item => `
                <tr>
                  <td class="rank-${item.posicao <= 3 ? item.posicao : ''}">#${item.posicao}</td>
                  <td class="font-bold text-white">${item.symbol}</td>
                  <td class="text-gray-300">${item.name || 'N/A'}</td>
                  <td class="${getIVClass(item.iv_current)}">${item.iv_current?.toFixed(2) || '0.00'}%</td>
                  <td>R$ ${(item.close || 0).toFixed(2)}</td>
                  <td class="${getVolumeClass(item.volume)}">${formatNumber(item.volume || 0)}</td>
                  <td class="${getVolumeClass(item.financial_volume)}">${formatCurrency(item.financial_volume || 0)}</td>
                  <td class="${item.variation >= 0 ? 'text-green-400' : 'text-red-400'}">${(item.variation || 0).toFixed(2)}%</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    // Renderizar compara√ß√£o IV
    function renderIVComparison(data) {
      const comparison = data.comparison_data || [];
      
      if (comparison.length === 0) {
        mainContent.innerHTML = '<p class="text-center text-gray-500">Nenhum dado dispon√≠vel</p>';
        return;
      }
      
      mainContent.innerHTML = `
        <div class="mb-4">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="metric-card text-center">
              <div class="text-lg font-bold text-blue-400">${data.estatisticas?.ratio_medio?.toFixed(2) || '0.00'}</div>
              <div class="text-sm text-gray-400">Ratio M√©dio</div>
            </div>
            <div class="metric-card text-center">
              <div class="text-lg font-bold text-red-400">${data.estatisticas?.acoes_perto_maximo || 0}</div>
              <div class="text-sm text-gray-400">Perto do M√°ximo</div>
            </div>
            <div class="metric-card text-center">
              <div class="text-lg font-bold text-yellow-400">${data.estatisticas?.acoes_alto || 0}</div>
              <div class="text-sm text-gray-400">Alto</div>
            </div>
            <div class="metric-card text-center">
              <div class="text-lg font-bold text-green-400">${data.estatisticas?.acoes_baixo || 0}</div>
              <div class="text-sm text-gray-400">Baixo</div>
            </div>
          </div>
        </div>
        
        <div class="rank-table">
          <table>
            <thead>
              <tr>
                <th>Ativo</th>
                <th>IV Atual</th>
                <th>IV 6M Max</th>
                <th>Ratio</th>
                <th>Status</th>
                <th>Pre√ßo</th>
                <th>Volume Financeiro</th>
              </tr>
            </thead>
            <tbody>
              ${comparison.map(item => `
                <tr>
                  <td class="font-bold text-white">${item.symbol}</td>
                  <td class="${getIVClass(item.iv_current)}">${item.iv_current?.toFixed(2) || '0.00'}%</td>
                  <td class="text-gray-300">${item.iv_6m_max?.toFixed(2) || '0.00'}%</td>
                  <td class="${getRatioClass(item.ratio)}">${(item.ratio_percent || 0).toFixed(1)}%</td>
                  <td class="${getStatusClass(item.status)}">${item.status}</td>
                  <td>R$ ${(item.close || 0).toFixed(2)}</td>
                  <td class="${getVolumeClass(item.financial_volume)}">${formatCurrency(item.financial_volume || 0)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    // Renderizar IV Percentil
    function renderIVPercentil(data) {
      const ranking = data.ranking || [];
      const categorias = data.resumo_categorias || {};
      
      if (ranking.length === 0) {
        mainContent.innerHTML = '<p class="text-center text-gray-500">Nenhum dado dispon√≠vel</p>';
        return;
      }
      
      mainContent.innerHTML = `
        <div class="mb-6">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="metric-card text-center">
              <div class="text-lg font-bold text-red-400">${categorias.criticos || 0}</div>
              <div class="text-sm text-gray-400">Cr√≠ticos (>80%)</div>
            </div>
            <div class="metric-card text-center">
              <div class="text-lg font-bold text-orange-400">${categorias.altos || 0}</div>
              <div class="text-sm text-gray-400">Altos (60-80%)</div>
            </div>
            <div class="metric-card text-center">
              <div class="text-lg font-bold text-yellow-400">${categorias.medios || 0}</div>
              <div class="text-sm text-gray-400">M√©dios (40-60%)</div>
            </div>
            <div class="metric-card text-center">
              <div class="text-lg font-bold text-green-400">${categorias.baixos || 0}</div>
              <div class="text-sm text-gray-400">Baixos (<40%)</div>
            </div>
          </div>
        </div>
        
        <div class="rank-table">
          <table>
            <thead>
              <tr>
                <th>Posi√ß√£o</th>
                <th>Ativo</th>
                <th>IV Atual</th>
                <th>Percentil 6M</th>
                <th>Categoria</th>
                <th>Pre√ßo</th>
                <th>Volume</th>
              </tr>
            </thead>
            <tbody>
              ${ranking.map((item, index) => {
                const percentil = item.iv_6m_percentile || 0;
                return `
                  <tr>
                    <td class="rank-${index < 3 ? index + 1 : ''}">#${index + 1}</td>
                    <td class="font-bold text-white">${item.symbol}</td>
                    <td class="${getIVClass(item.iv_current)}">${item.iv_current?.toFixed(2) || '0.00'}%</td>
                    <td class="${getPercentilClass(percentil)}">${percentil.toFixed(1)}%</td>
                    <td class="${getPercentilCategoryClass(percentil)}">${getPercentilCategory(percentil)}</td>
                    <td>R$ ${(item.close || 0).toFixed(2)}</td>
                    <td class="${getVolumeClass(item.volume)}">${formatNumber(item.volume || 0)}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    // Renderizar IV vs Volume
    function renderIVVolume(data) {
      const scatterData = data.scatter_data || [];
      
      if (scatterData.length === 0) {
        mainContent.innerHTML = '<p class="text-center text-gray-500">Nenhum dado dispon√≠vel</p>';
        return;
      }
      
      mainContent.innerHTML = `
        <div class="rank-table">
          <table>
            <thead>
              <tr>
                <th>Ativo</th>
                <th>IV Atual</th>
                <th>Volume Financeiro</th>
                <th>Pre√ßo</th>
                <th>Varia√ß√£o</th>
                <th>Classifica√ß√£o</th>
              </tr>
            </thead>
            <tbody>
              ${scatterData.map(item => `
                <tr>
                  <td class="font-bold text-white">${item.symbol}</td>
                  <td class="${getIVClass(item.iv_current)}">${item.iv_current?.toFixed(2) || '0.00'}%</td>
                  <td class="${getVolumeClass(item.financial_volume)}">${formatCurrency(item.financial_volume || 0)}</td>
                  <td>R$ ${(item.close || 0).toFixed(2)}</td>
                  <td class="${item.variation >= 0 ? 'text-green-400' : 'text-red-400'}">${(item.variation || 0).toFixed(2)}%</td>
                  <td class="${getIVVolumeClass(item)}">${getIVVolumeLabel(item)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    // Carregar dados do scatter plot
    async function loadScatterData() {
      try {
        const response = await fetch(`${API_BASE}/iv-vs-volume?top_n=30`);
        const data = await response.json();
        
        if (data.success) {
          renderScatterChart(data.scatter_data);
          updateScatterStats(data.scatter_data);
        }
      } catch (error) {
        console.error('Erro ao carregar dados do scatter:', error);
      }
    }
    
    // Renderizar gr√°fico de dispers√£o
    function renderScatterChart(scatterData) {
      const ctx = document.getElementById('scatterChart');
      if (!ctx) return;
      
      const context = ctx.getContext('2d');
      
      // Destruir gr√°fico anterior se existir
      if (scatterChart) {
        scatterChart.destroy();
      }
      
      const chartData = scatterData.map(item => ({
        x: item.financial_volume || 0,
        y: item.iv_current || 0,
        label: item.symbol
      }));
      
      scatterChart = new Chart(context, {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'IV vs Volume',
            data: chartData,
            backgroundColor: 'rgba(186, 57, 175, 0.6)',
            borderColor: 'rgba(186, 57, 175, 1)',
            borderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: '#ffffff'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              callbacks: {
                title: function(context) {
                  return context[0].raw.label;
                },
                label: function(context) {
                  return [
                    `IV: ${context.parsed.y.toFixed(2)}%`,
                    `Volume: ${formatCurrency(context.parsed.x)}`
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              type: 'logarithmic',
              title: {
                display: true,
                text: 'Volume Financeiro (R$)',
                color: '#ffffff'
              },
              ticks: {
                color: '#cccccc',
                callback: function(value) {
                  return formatCurrency(value);
                }
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Volatilidade Impl√≠cita (%)',
                color: '#ffffff'
              },
              ticks: {
                color: '#cccccc'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            }
          }
        }
      });
    }
    
    // Atualizar estat√≠sticas do scatter
    function updateScatterStats(scatterData) {
      if (!scatterData || scatterData.length === 0) return;
      
      // Calcular correla√ß√£o simples
      const volumes = scatterData.map(item => item.financial_volume || 0);
      const ivs = scatterData.map(item => item.iv_current || 0);
      
      const correlation = calculateCorrelation(volumes, ivs);
      
      // Contar categorias
      let highVolumeHighIV = 0;
      let lowVolumeLowIV = 0;
      
      const sortedVolumes = [...volumes].sort((a, b) => a - b);
      const sortedIVs = [...ivs].sort((a, b) => a - b);
      const medianVolume = sortedVolumes[Math.floor(sortedVolumes.length / 2)];
      const medianIV = sortedIVs[Math.floor(sortedIVs.length / 2)];
      
      scatterData.forEach(item => {
        const vol = item.financial_volume || 0;
        const iv = item.iv_current || 0;
        
        if (vol > medianVolume && iv > medianIV) highVolumeHighIV++;
        if (vol < medianVolume && iv < medianIV) lowVolumeLowIV++;
      });
      
      const highVolumeEl = document.getElementById('scatterHighVolume');
      const lowVolumeEl = document.getElementById('scatterLowVolume');
      const correlationEl = document.getElementById('scatterCorrelation');
      
      if (highVolumeEl) highVolumeEl.textContent = highVolumeHighIV;
      if (lowVolumeEl) lowVolumeEl.textContent = lowVolumeLowIV;
      if (correlationEl) correlationEl.textContent = correlation.toFixed(3);
    }
    
    // Calcular correla√ß√£o
    function calculateCorrelation(x, y) {
      const n = x.length;
      if (n === 0) return 0;
      
      const sumX = x.reduce((a, b) => a + b, 0);
      const sumY = y.reduce((a, b) => a + b, 0);
      const sumXY = x.reduce((total, xi, i) => total + xi * y[i], 0);
      const sumX2 = x.reduce((total, xi) => total + xi * xi, 0);
      const sumY2 = y.reduce((total, yi) => total + yi * yi, 0);
      
      const numerator = n * sumXY - sumX * sumY;
      const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
      
      return denominator === 0 ? 0 : numerator / denominator;
    }
    
    // Fun√ß√µes auxiliares para classes CSS
    function getIVClass(iv) {
      if (iv >= 60) return 'iv-high';
      if (iv >= 40) return 'iv-medium';
      return 'iv-low';
    }
    
    function getVolumeClass(volume) {
      if (volume >= 10000000) return 'volume-high';
      if (volume >= 1000000) return 'volume-medium';
      return 'volume-low';
    }
    
    function getRatioClass(ratio) {
      if (ratio >= 0.9) return 'ratio-critical';
      if (ratio >= 0.7) return 'ratio-high';
      if (ratio >= 0.5) return 'ratio-medium';
      return 'ratio-low';
    }
    
    function getStatusClass(status) {
      switch (status) {
        case 'Perto do m√°ximo': return 'status-critical';
        case 'Alto': return 'status-high';
        case 'M√©dio': return 'status-medium';
        case 'Baixo': return 'status-low';
        default: return 'text-gray-400';
      }
    }
    
    function getPercentilClass(percentil) {
      if (percentil >= 80) return 'percentil-critical';
      if (percentil >= 60) return 'percentil-high';
      if (percentil >= 40) return 'percentil-medium';
      return 'percentil-low';
    }
    
    function getPercentilCategory(percentil) {
      if (percentil >= 80) return 'Cr√≠tico';
      if (percentil >= 60) return 'Alto';
      if (percentil >= 40) return 'M√©dio';
      return 'Baixo';
    }
    
    function getPercentilCategoryClass(percentil) {
      if (percentil >= 80) return 'text-red-400';
      if (percentil >= 60) return 'text-orange-400';
      if (percentil >= 40) return 'text-yellow-400';
      return 'text-green-400';
    }
    
    function getIVVolumeClass(item) {
      const iv = item.iv_current || 0;
      const volume = item.financial_volume || 0;
      
      if (iv > 50 && volume > 1000000) return 'text-purple-400';
      if (iv < 30 && volume < 100000) return 'text-green-400';
      if (iv > 40) return 'text-orange-400';
      return 'text-blue-400';
    }
    
    function getIVVolumeLabel(item) {
      const iv = item.iv_current || 0;
      const volume = item.financial_volume || 0;
      
      if (iv > 50 && volume > 1000000) return 'Alta IV + Alto Volume';
      if (iv < 30 && volume < 100000) return 'Baixa IV + Baixo Volume';
      if (iv > 40) return 'Alta IV';
      return 'Padr√£o';
    }
    
    // Fun√ß√µes de formata√ß√£o
    function formatNumber(num) {
      if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
      }
      if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
      }
      return num.toLocaleString('pt-BR');
    }
    
    function formatCurrency(value) {
      if (value >= 1000000000) {
        return 'R$ ' + (value / 1000000000).toFixed(1) + 'B';
      }
      if (value >= 1000000) {
        return 'R$ ' + (value / 1000000).toFixed(1) + 'M';
      }
      if (value >= 1000) {
        return 'R$ ' + (value / 1000).toFixed(1) + 'K';
      }
      return 'R$ ' + value.toLocaleString('pt-BR', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      });
    }
    
    // Fun√ß√£o para atualizar dados
    function refreshData() {
      console.log('üîÑ Atualizando dados...');
      loadInitialData();
    }
    
    // Event listeners globais
    window.selectFilter = selectFilter;
    window.refreshData = refreshData;
    
    // Auto-refresh a cada 5 minutos
    setInterval(() => {
      console.log('üîÑ Auto-refresh...');
      loadInitialData();
    }, 5 * 60 * 1000);
    
    // Detectar mudan√ßas de visibilidade da p√°gina
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        console.log('üîÑ P√°gina vis√≠vel - atualizando dados...');
        loadInitialData();
      }
    });
  </script>
</body>
</html>