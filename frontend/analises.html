<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>An√°lises & Carteiras - Geminii Tech</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            secondary: '#8b5cf6',
            accent: '#06b6d4',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            geminii: '#ba39af'
          }
        }
      }
    }
  </script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    * {
      scroll-behavior: smooth;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: #0f0f0f;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .navbar {
      background: rgba(15, 15, 15, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .nav-active {
      color: #6366f1;
      font-weight: 600;
      border-bottom: 2px solid #6366f1;
      padding-bottom: 4px;
    }
    
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 3px solid #8b5cf6;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Modal scrollbar */
    #modalContent::-webkit-scrollbar {
      width: 6px;
    }
    
    #modalContent::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }
    
    #modalContent::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, 0.5);
      border-radius: 3px;
    }
    
    #modalContent::-webkit-scrollbar-thumb:hover {
      background: rgba(139, 92, 246, 0.7);
    }
  </style>
</head>
<body class="min-h-screen">
  
  <!-- Navigation -->
  <nav class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-opacity-5 border-opacity-10 bg-white border-white border rounded-full px-4 py-3 shadow-xl backdrop-blur-md">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <img src="logo.png" alt="Geminii Logo" class="w-6 h-6 cursor-pointer" onclick="window.location.href='/'">
      </div>
      <div class="hidden md:flex items-center space-x-6 text-xs text-gray-300 ml-8">
        <a href="/dashboard" class="hover:text-white transition-colors">Dashboard</a>
        <span class="text-white font-medium">Carteiras</span>
      </div>
      <div class="flex items-center space-x-3 ml-8">
        <div id="apiStatus" class="w-8 h-8 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-full flex items-center justify-center relative">
          <i class="fas fa-chart-line text-green-500 text-xs"></i>
          <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="pt-20 px-6 pb-12">
    <div class="max-w-7xl mx-auto">
      
      <!-- Page Header -->
      <div class="mb-8">
        <h1 class="text-4xl font-bold text-white mb-2">An√°lises & Carteiras</h1>
        <p class="text-gray-300 text-lg">Suas recomenda√ß√µes personalizadas de investimento com analytics avan√ßado</p>
      </div>

      <!-- Container Principal das Carteiras -->
      <div id="portfoliosContainer">
        <!-- Loading inicial -->
        <div class="card rounded-2xl p-8 fade-in">
          <div class="text-center py-12">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-300">Carregando suas carteiras...</p>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Modal de Analytics -->
  <div id="analyticsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-gray-900 rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
      <!-- Header do Modal -->
      <div class="flex items-center justify-between p-6 border-b border-gray-700">
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg flex items-center justify-center">
            <i class="fas fa-chart-area text-white text-sm"></i>
          </div>
          <div>
            <h2 id="modalTitle" class="text-xl font-bold text-white">Analytics da Carteira</h2>
            <p id="modalSubtitle" class="text-gray-400 text-sm">An√°lise de performance e m√©tricas</p>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <!-- Bot√£o de Refresh -->
          <button id="refreshBtn" onclick="refreshAnalytics()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm transition-colors">
            <i class="fas fa-sync-alt"></i> Atualizar
          </button>
          <button onclick="closeModal()" class="text-gray-400 hover:text-white transition-colors">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      
      <!-- Conte√∫do do Modal -->
      <div id="modalContent" class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
        <!-- Conte√∫do ser√° inserido aqui -->
      </div>
    </div>
  </div>

  <script>
    // ===== VARI√ÅVEIS GLOBAIS =====
    let userToken = null;
    let currentUser = null;
    let currentPortfolioId = null;
    let currentPortfolioName = null;

    // ===== INICIALIZA√á√ÉO =====
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ Inicializando Analytics...');
      
      if (!checkAuth()) return;
      
      await loadPortfolios();
      
      console.log('‚úÖ Analytics inicializado!');
    });

    // ===== AUTENTICA√á√ÉO =====
    function checkAuth() {
      userToken = localStorage.getItem('authToken') || localStorage.getItem('geminii_token');
      const userData = localStorage.getItem('geminii_user');
      
      if (!userToken) {
        console.log('‚ùå Token n√£o encontrado');
        window.location.href = '/login.html';
        return false;
      }
      
      if (userData) {
        try {
          currentUser = JSON.parse(userData);
          console.log('‚úÖ Usu√°rio logado:', currentUser.name);
        } catch (error) {
          console.error('Erro ao parsear dados do usu√°rio:', error);
        }
      }
      
      return true;
    }

    function logout() {
      if (confirm('Deseja realmente sair?')) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('geminii_token');
        localStorage.removeItem('geminii_user');
        window.location.href = '/';
      }
    }

    // ===== CARREGAR CARTEIRAS =====
    async function loadPortfolios() {
      const container = document.getElementById('portfoliosContainer');
      
      try {
        showLoading();
        
        // Tentar sistema real primeiro
        let response = await fetch('/chart_ativos/user/portfolios', {
          headers: {
            'Authorization': `Bearer ${userToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        let data, source = 'REAL';
        
        if (response.ok) {
          data = await response.json();
          if (data.success && data.portfolios && data.portfolios.length > 0) {
            console.log('üìä Usando sistema REAL:', data.portfolios.length, 'carteiras');
            displayPortfolios(data.portfolios, source);
            return;
          }
        }
        
        // Fallback para API antiga
        console.log('‚ö†Ô∏è Fallback para API antiga');
        response = await fetch('/api/user/my-portfolios', {
          headers: {
            'Authorization': `Bearer ${userToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          if (response.status === 401) {
            localStorage.removeItem('authToken');
            localStorage.removeItem('geminii_token');
            window.location.href = '/login.html';
            return;
          }
          throw new Error(`HTTP ${response.status}`);
        }
        
        data = await response.json();
        source = 'API_ANTIGA';
        
        if (data.success && data.portfolios) {
          console.log('üìä Usando API antiga:', data.portfolios.length, 'carteiras');
          displayPortfolios(data.portfolios, source);
        } else {
          throw new Error('Nenhuma carteira encontrada');
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar carteiras:', error);
        showError(error.message);
      }
    }

    // ===== EXIBIR CARTEIRAS =====
    function displayPortfolios(portfolios, source) {
      const container = document.getElementById('portfoliosContainer');
      
      if (portfolios.length === 0) {
        showNoData();
        return;
      }
      
      let html = '';
      
      portfolios.forEach(portfolio => {
        // Adaptar estrutura conforme a fonte
        const data = source === 'REAL' ? {
          id: portfolio.id,
          name: portfolio.name,
          display_name: portfolio.display_name || portfolio.name,
          description: portfolio.description,
          asset_count: portfolio.asset_count,
          creation_date: portfolio.created_at || portfolio.creation_date,
          granted_at: portfolio.granted_at
        } : {
          id: portfolio.name,
          name: portfolio.name,
          display_name: portfolio.display_name || portfolio.name,
          description: portfolio.description,
          asset_count: null,
          creation_date: null,
          granted_at: portfolio.granted_at
        };
        
        html += `
          <div class="card rounded-2xl p-8 mb-6 fade-in">
            <div class="flex items-center justify-between mb-6">
              <div>
                <h2 class="text-2xl font-bold text-white flex items-center">
                  <i class="fas fa-briefcase text-primary mr-3"></i>
                  ${data.display_name}
                </h2>
                <p class="text-gray-400 mb-2">${data.description || 'Carteira de investimentos'}</p>
                
                <!-- üî• NOVA SE√á√ÉO: INFORMA√á√ïES DE DATA -->
                <div class="flex items-center space-x-4 mt-3 text-sm">
                  ${data.asset_count ? `<span class="bg-blue-900/30 text-blue-400 px-2 py-1 rounded">${data.asset_count} ativos</span>` : ''}
                  ${data.creation_date ? `<span class="bg-green-900/30 text-green-400 px-2 py-1 rounded">Criada em: ${formatDate(data.creation_date)}</span>` : ''}
                  ${data.granted_at ? `<span class="bg-purple-900/30 text-purple-400 px-2 py-1 rounded">Acesso: ${formatDate(data.granted_at)}</span>` : ''}
                  <span class="px-2 py-1 rounded text-xs ${source === 'REAL' ? 'bg-green-900/30 text-green-400' : 'bg-blue-900/30 text-blue-400'}">
                    ${source === 'REAL' ? 'üîÑ Sistema Real' : 'üìä API Cl√°ssica'}
                  </span>
                </div>
              </div>
              
              <div class="flex space-x-2">
                <!-- BOT√ÉO 1: ATIVOS -->
                <button onclick="showAssets('${data.id}')" class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded-lg text-white text-sm transition-colors">
                  <i class="fas fa-list mr-1"></i>
                  Ativos
                </button>
                <!-- BOT√ÉO 2: RECOMENDA√á√ïES -->
                <button onclick="showRecommendations('${data.id}')" class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded-lg text-white text-sm transition-colors">
                  <i class="fas fa-lightbulb mr-1"></i>
                  Recomenda√ß√µes
                </button>
                <!-- BOT√ÉO 3: ANALYTICS REAIS -->
                <button onclick="openAnalytics('${data.id}', '${data.display_name}', '${source}')" class="bg-purple-600 hover:bg-purple-700 px-3 py-2 rounded-lg text-white text-sm transition-colors">
                  <i class="fas fa-chart-area mr-1"></i>
                  Analytics Reais
                </button>
              </div>
            </div>
            
            <!-- Container para carregar conte√∫do -->
            <div id="content-${data.id}" class="bg-gray-800 bg-opacity-30 rounded-lg p-6 min-h-24">
              <p class="text-gray-300 text-center">
                <i class="fas fa-chart-line text-primary mr-2"></i>
                Selecione uma op√ß√£o acima para ver os detalhes da carteira ${data.display_name}
              </p>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // ===== MOSTRAR ATIVOS =====
    async function showAssets(portfolioId) {
      const contentDiv = document.getElementById(`content-${portfolioId}`);
      if (!contentDiv) return;
      
      try {
        contentDiv.innerHTML = '<div class="text-center py-4"><div class="spinner mx-auto mb-2"></div><p class="text-gray-400">Carregando ativos...</p></div>';
        
        const response = await fetch(`/api/user/portfolio/${portfolioId}/assets`, {
          headers: { 'Authorization': `Bearer ${userToken}` }
        });
        
        if (!response.ok) throw new Error(`Erro ${response.status}`);
        
        const data = await response.json();
        
        if (data.success && data.assets) {
          displayAssets(data.assets, contentDiv, data.total_weight);
        } else {
          contentDiv.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum ativo encontrado</p>';
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar ativos:', error);
        contentDiv.innerHTML = '<p class="text-red-400 text-center py-4">Erro ao carregar ativos</p>';
      }
    }

    // ===== MOSTRAR RECOMENDA√á√ïES =====
    async function showRecommendations(portfolioId) {
      const contentDiv = document.getElementById(`content-${portfolioId}`);
      if (!contentDiv) return;
      
      try {
        contentDiv.innerHTML = '<div class="text-center py-4"><div class="spinner mx-auto mb-2"></div><p class="text-gray-400">Carregando recomenda√ß√µes...</p></div>';
        
        const response = await fetch(`/api/user/portfolio/${portfolioId}/recommendations`, {
          headers: { 'Authorization': `Bearer ${userToken}` }
        });
        
        if (!response.ok) throw new Error(`Erro ${response.status}`);
        
        const data = await response.json();
        
        if (data.success && data.recommendations) {
          displayRecommendations(data.recommendations, contentDiv);
        } else {
          contentDiv.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhuma recomenda√ß√£o encontrada</p>';
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar recomenda√ß√µes:', error);
        contentDiv.innerHTML = '<p class="text-red-400 text-center py-4">Erro ao carregar recomenda√ß√µes</p>';
      }
    }

    // ===== ABRIR ANALYTICS =====
    async function openAnalytics(portfolioId, portfolioName, source) {
      console.log(`üìä Abrindo Analytics para: ${portfolioId} (${source})`);
      
      currentPortfolioId = portfolioId;
      currentPortfolioName = portfolioName;
      
      const modal = document.getElementById('analyticsModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalSubtitle = document.getElementById('modalSubtitle');
      const modalContent = document.getElementById('modalContent');
      
      // Atualizar t√≠tulo
      modalTitle.textContent = `Analytics Reais - ${portfolioName}`;
      modalSubtitle.textContent = 'Coletando dados do Yahoo Finance e IBOVESPA...';
      
      // Mostrar modal com loading
      modalContent.innerHTML = `
        <div class="text-center py-12">
          <div class="spinner mx-auto mb-4"></div>
          <p class="text-gray-300">Coletando dados em tempo real...</p>
          <p class="text-gray-500 text-sm mt-2">Yahoo Finance ‚Ä¢ IBOVESPA ‚Ä¢ Calculando m√©tricas</p>
        </div>
      `;
      
      modal.classList.remove('hidden');
      
      try {
        // üî• BUSCAR DADOS EM PARALELO
        const [portfolioResponse, ibovResponse] = await Promise.all([
          fetch(`/chart_ativos/portfolio/${portfolioId}/analytics`, {
            headers: {
              'Authorization': `Bearer ${userToken}`,
              'Content-Type': 'application/json'
            }
          }),
          fetchIbovData()
        ]);
        
        if (!portfolioResponse.ok) {
          throw new Error(`Erro ${portfolioResponse.status}: ${portfolioResponse.statusText}`);
        }
        
        const portfolioResult = await portfolioResponse.json();
        console.log('üìà Portfolio analytics:', portfolioResult);
        console.log('üìä IBOVESPA data:', ibovResponse);
        
        if (portfolioResult.success && portfolioResult.data) {
          // üî• ENRIQUECER COM DATAS DE ENTRADA
          const enrichedData = await enrichWithDates(portfolioResult.data, portfolioId);
          
          // üî• EXIBIR ANALYTICS COMPLETO
          displayRealAnalytics(enrichedData, ibovResponse);
          
          // Atualizar subtitle
          const creationDate = enrichedData.portfolio_creation_date;
          modalSubtitle.textContent = `Carteira criada em: ${formatDate(creationDate)} ‚Ä¢ √öltima an√°lise: ${formatDateTime(enrichedData.analysis_date)}`;
        } else {
          throw new Error(portfolioResult.error || 'Dados n√£o encontrados');
        }
        
      } catch (error) {
        console.error('‚ùå Erro no Analytics:', error);
        showModalError(error.message);
      }
    }

    // ===== BUSCAR DADOS DO IBOVESPA =====
    async function fetchIbovData() {
      try {
        console.log('üìä Buscando IBOVESPA...');
        
        // Tentar via API do sistema
        let response = await fetch('/api/stocks/BVSP', {
          headers: { 'Authorization': `Bearer ${userToken}` }
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success && result.data) {
            console.log('‚úÖ IBOVESPA via API Geminii');
            return {
              current_price: result.data.current_price,
              change: result.data.change || 0,
              change_percent: result.data.change_percent || 0,
              name: 'IBOVESPA',
              source: 'API_GEMINII',
              last_update: new Date().toISOString()
            };
          }
        }
        
        // Fallback: YFinance
        response = await fetch('/api/yfinance/BVSP', {
          headers: { 'Authorization': `Bearer ${userToken}` }
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success && result.data) {
            console.log('‚úÖ IBOVESPA via YFinance');
            return {
              current_price: result.data.current_price,
              change: result.data.change || 0,
              change_percent: result.data.change_percent || 0,
              name: 'IBOVESPA',
              source: 'YFINANCE',
              last_update: new Date().toISOString()
            };
          }
        }
        
        // √öltimo fallback: dados de refer√™ncia
        console.log('‚ö†Ô∏è Usando dados de refer√™ncia IBOVESPA');
        return {
          current_price: 125000,
          change: 1200,
          change_percent: 1.85,
          name: 'IBOVESPA (refer√™ncia)',
          source: 'REFERENCE',
          last_update: new Date().toISOString()
        };
        
      } catch (error) {
        console.error('‚ùå Erro ao buscar IBOVESPA:', error);
        return {
          current_price: 0,
          change: 0,
          change_percent: 0,
          name: 'IBOVESPA (indispon√≠vel)',
          source: 'ERROR',
          last_update: null
        };
      }
    }

    // ===== ENRIQUECER COM DATAS =====
    async function enrichWithDates(portfolioData, portfolioId) {
      try {
        console.log('üìÖ Buscando datas de entrada...');
        
        const response = await fetch(`/api/user/portfolio/${portfolioId}/assets`, {
          headers: { 'Authorization': `Bearer ${userToken}` }
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success && result.assets) {
            const assets = result.assets;
            
            // Encontrar data de cria√ß√£o da carteira (ativo mais antigo)
            const entryDates = assets
              .map(asset => asset.entry_date)
              .filter(date => date)
              .sort();
            
            const portfolioCreationDate = entryDates.length > 0 ? entryDates[0] : new Date().toISOString();
            const portfolioAge = calculateDays(portfolioCreationDate);
            
            // Enriquecer assets_performance com datas
            if (portfolioData.metrics && portfolioData.metrics.assets_performance) {
              Object.keys(portfolioData.metrics.assets_performance).forEach(ticker => {
                const asset = assets.find(a => a.ticker === ticker);
                if (asset) {
                  portfolioData.metrics.assets_performance[ticker].entry_date = asset.entry_date;
                  portfolioData.metrics.assets_performance[ticker].days_in_portfolio = calculateDays(asset.entry_date);
                }
              });
            }
            
            // Adicionar info de datas
            portfolioData.portfolio_creation_date = portfolioCreationDate;
            portfolioData.portfolio_age_days = portfolioAge;
            
            console.log('üìÖ Datas encontradas:', {
              creation: portfolioCreationDate,
              age: portfolioAge,
              assets: assets.length
            });
          }
        }
        
        return portfolioData;
        
      } catch (error) {
        console.error('‚ùå Erro ao buscar datas:', error);
        portfolioData.portfolio_creation_date = new Date().toISOString();
        portfolioData.portfolio_age_days = 0;
        return portfolioData;
      }
    }

    // ===== EXIBIR ANALYTICS REAIS =====
    function displayRealAnalytics(data, ibovData) {
      const modalContent = document.getElementById('modalContent');
      const metrics = data.metrics;
      const updateInfo = data.update_info;
      const portfolioAge = data.portfolio_age_days || 0;
      const creationDate = data.portfolio_creation_date;
      
      // Calcular performance do IBOV no per√≠odo
      const ibovPeriodPerformance = calculateIbovPeriodReturn(ibovData, portfolioAge);
      
      modalContent.innerHTML = `
        <div class="space-y-6">
          
          <!-- üî• INFORMA√á√ïES DA CARTEIRA E DATAS -->
          <div class="bg-gradient-to-r from-blue-900/30 to-purple-900/30 border border-blue-500/30 rounded-xl p-6">
            <h3 class="text-lg font-bold text-white mb-4 flex items-center">
              <i class="fas fa-calendar-alt text-blue-400 mr-3"></i>
              üìÖ Informa√ß√µes da Carteira
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="bg-white/10 rounded-lg p-4 text-center">
                <div class="text-lg font-bold text-blue-400 mb-1">
                  ${formatDate(creationDate)}
                </div>
                <div class="text-white font-semibold">Data de Cria√ß√£o</div>
                <div class="text-gray-400 text-sm">Primeira gera√ß√£o</div>
              </div>
              <div class="bg-white/10 rounded-lg p-4 text-center">
                <div class="text-lg font-bold text-purple-400 mb-1">
                  ${portfolioAge} dias
                </div>
                <div class="text-white font-semibold">Idade da Carteira</div>
                <div class="text-gray-400 text-sm">Desde cria√ß√£o</div>
              </div>
              <div class="bg-white/10 rounded-lg p-4 text-center">
                <div class="text-lg font-bold text-green-400 mb-1">
                  ${metrics.number_of_assets} ativos
                </div>
                <div class="text-white font-semibold">Composi√ß√£o</div>
                <div class="text-gray-400 text-sm">Total atual</div>
              </div>
            </div>
          </div>

          <!-- üî• STATUS DE ATUALIZA√á√ÉO -->
          ${updateInfo ? `
            <div class="p-4 rounded-lg ${updateInfo.prices_updated ? 'bg-green-900/30 border border-green-500/30' : 'bg-yellow-900/30 border border-yellow-500/30'}">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-white font-medium">
                    ${updateInfo.prices_updated ? '‚úÖ Pre√ßos atualizados!' : '‚è∞ Pre√ßos desatualizados'}
                  </p>
                  <p class="text-sm text-gray-400">${updateInfo.update_message}</p>
                  ${updateInfo.last_update ? `<p class="text-xs text-gray-500">√öltima atualiza√ß√£o: ${formatDateTime(updateInfo.last_update)}</p>` : ''}
                </div>
                ${!updateInfo.prices_updated ? `
                  <button onclick="refreshAnalytics()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded-lg text-sm">
                    <i class="fas fa-sync-alt mr-1"></i> Atualizar Agora
                  </button>
                ` : ''}
              </div>
            </div>
          ` : ''}
          
          <!-- üî• COMPARATIVO CARTEIRA vs IBOVESPA -->
          <div class="bg-gradient-to-r from-purple-900/30 to-blue-900/30 border border-purple-500/30 rounded-xl p-6">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
              <i class="fas fa-chart-area text-purple-400 mr-3"></i>
              üìä Performance: ${data.portfolio_name} vs IBOVESPA
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <!-- Performance da Carteira -->
              <div class="bg-white/10 rounded-lg p-4 text-center">
                <div class="text-3xl font-bold ${metrics.total_return >= 0 ? 'text-green-400' : 'text-red-400'} mb-2">
                  ${metrics.total_return >= 0 ? '+' : ''}${metrics.total_return.toFixed(2)}%
                </div>
                <div class="text-white font-semibold">${data.portfolio_name}</div>
                <div class="text-gray-400 text-sm">Retorno em ${portfolioAge} dias</div>
                <div class="text-xs text-gray-500 mt-1">Desde ${formatDate(creationDate)}</div>
              </div>
              
              <!-- Performance do IBOVESPA -->
              <div class="bg-white/10 rounded-lg p-4 text-center">
                <div class="text-3xl font-bold ${ibovPeriodPerformance >= 0 ? 'text-green-400' : 'text-red-400'} mb-2">
                  ${ibovPeriodPerformance >= 0 ? '+' : ''}${ibovPeriodPerformance.toFixed(2)}%
                </div>
                <div class="text-white font-semibold">IBOVESPA</div>
                <div class="text-gray-400 text-sm">Mesmo per√≠odo (${portfolioAge} dias)</div>
                <div class="text-xs text-gray-500 mt-1">
                  ${getSourceBadge(ibovData.source)}
                </div>
              </div>
              
              <!-- Alpha (Excesso) -->
              <div class="bg-white/10 rounded-lg p-4 text-center">
                <div class="text-3xl font-bold ${(metrics.total_return - ibovPeriodPerformance) >= 0 ? 'text-green-400' : 'text-red-400'} mb-2">
                  ${(metrics.total_return - ibovPeriodPerformance) >= 0 ? '+' : ''}${(metrics.total_return - ibovPeriodPerformance).toFixed(2)}%
                </div>
                <div class="text-white font-semibold">Alpha (Excesso)</div>
                <div class="text-gray-400 text-sm">vs IBOVESPA</div>
                <div class="text-xs text-gray-500 mt-1">
                  ${getAlphaEmoji(metrics.total_return - ibovPeriodPerformance)}
                </div>
              </div>
            </div>
            
            <!-- Interpreta√ß√£o -->
            <div class="bg-white/5 rounded-lg p-4 border border-white/10">
              <div class="flex items-center gap-3">
                <i class="fas fa-lightbulb text-yellow-400 text-xl"></i>
                <div>
                  <div class="text-white font-semibold">An√°lise de Performance:</div>
                  <div class="text-gray-300 text-sm">
                    ${getPerformanceAnalysis(metrics.total_return, ibovPeriodPerformance, portfolioAge)}
                  </div>
                  <div class="text-xs text-gray-400 mt-2">
                    ‚Ä¢ Per√≠odo: ${portfolioAge} dias (${formatDate(creationDate)} at√© hoje)
                    ‚Ä¢ IBOV hoje: ${ibovData.change_percent >= 0 ? '+' : ''}${ibovData.change_percent.toFixed(2)}%
                    ‚Ä¢ Atualizado: ${formatDateTime(ibovData.last_update)}
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- üî• PERFORMANCE INDIVIDUAL DOS ATIVOS -->
          ${metrics.assets_performance ? `
            <div class="bg-gray-800/50 rounded-xl p-6 border border-gray-600">
              <h4 class="text-white font-semibold mb-4 flex items-center">
                <i class="fas fa-chart-bar text-green-400 mr-2"></i>
                Performance Individual dos Ativos (${Object.keys(metrics.assets_performance).length} ativos)
              </h4>
              
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="border-b border-gray-700">
                      <th class="text-left py-3 px-2 text-gray-400 font-semibold">Ativo</th>
                      <th class="text-left py-3 px-2 text-gray-400 font-semibold">Data Entrada</th>
                      <th class="text-right py-3 px-2 text-gray-400 font-semibold">Dias</th>
                      <th class="text-right py-3 px-2 text-gray-400 font-semibold">Peso</th>
                      <th class="text-right py-3 px-2 text-gray-400 font-semibold">Entrada</th>
                      <th class="text-right py-3 px-2 text-gray-400 font-semibold">Atual</th>
                      <th class="text-right py-3 px-2 text-gray-400 font-semibold">Retorno</th>
                      <th class="text-center py-3 px-2 text-gray-400 font-semibold">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${Object.entries(metrics.assets_performance).map(([ticker, assetData]) => {
                      const returnPercent = assetData.return || 0;
                      const isPositive = returnPercent >= 0;
                      const entryDate = assetData.entry_date;
                      const daysInPortfolio = assetData.days_in_portfolio || 0;
                      
                      return `
                        <tr class="border-b border-gray-800 hover:bg-gray-700/30 transition-colors">
                          <td class="py-3 px-2">
                            <div class="flex items-center gap-2">
                              <span class="text-white font-bold">${ticker}</span>
                              <div class="w-3 h-3 rounded-full ${isPositive ? 'bg-green-400' : 'bg-red-400'} animate-pulse"></div>
                            </div>
                            <div class="text-xs text-gray-500">${assetData.sector || 'N/A'}</div>
                          </td>
                          <td class="py-3 px-2">
                            <div class="text-gray-300 text-xs">
                              ${entryDate ? formatDate(entryDate) : 'N/A'}
                            </div>
                          </td>
                          <td class="py-3 px-2 text-right">
                            <span class="text-cyan-400 text-xs">${daysInPortfolio}</span>
                          </td>
                          <td class="py-3 px-2 text-right">
                            <span class="text-cyan-400 font-semibold">${assetData.weight.toFixed(1)}%</span>
                          </td>
                          <td class="py-3 px-2 text-right text-gray-300">
                            R$ ${assetData.entry_price.toFixed(2)}
                          </td>
                          <td class="py-3 px-2 text-right text-white font-semibold">
                            R$ ${assetData.current_price.toFixed(2)}
                          </td>
                          <td class="py-3 px-2 text-right">
                            <span class="font-bold ${isPositive ? 'text-green-400' : 'text-red-400'}">
                              ${returnPercent >= 0 ? '+' : ''}${returnPercent.toFixed(2)}%
                            </span>
                            ${daysInPortfolio > 0 ? `
                              <div class="text-xs text-gray-500">
                                ${(returnPercent / daysInPortfolio * 30).toFixed(1)}%/m√™s
                              </div>
                            ` : ''}
                          </td>
                          <td class="py-3 px-2 text-center">
                            ${getPerformanceEmoji(returnPercent)}
                          </td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
              
              <!-- Resumo da Performance -->
              <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-3 text-center">
                  <div class="text-lg font-bold text-green-400">
                    ${Object.values(metrics.assets_performance).filter(asset => asset.return > 0).length}
                  </div>
                  <div class="text-xs text-green-300">Ativos em Ganho</div>
                </div>
                <div class="bg-red-900/20 border border-red-500/30 rounded-lg p-3 text-center">
                  <div class="text-lg font-bold text-red-400">
                    ${Object.values(metrics.assets_performance).filter(asset => asset.return < 0).length}
                  </div>
                  <div class="text-xs text-red-300">Ativos em Perda</div>
                </div>
                <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-3 text-center">
                  <div class="text-lg font-bold text-blue-400">
                    R$ ${Object.values(metrics.assets_performance).reduce((sum, asset) => sum + (asset.profit_loss || 0), 0).toFixed(2)}
                  </div>
                  <div class="text-xs text-blue-300">P&L Total</div>
                </div>
                <div class="bg-purple-900/20 border border-purple-500/30 rounded-lg p-3 text-center">
                  <div class="text-lg font-bold text-purple-400">
                    ${(Object.values(metrics.assets_performance).reduce((sum, asset) => sum + (asset.return || 0), 0) / Object.values(metrics.assets_performance).length).toFixed(1)}%
                  </div>
                  <div class="text-xs text-purple-300">Retorno M√©dio</div>
                </div>
              </div>
            </div>
          ` : `
            <div class="bg-gray-800/50 rounded-xl p-6 border border-gray-600 text-center">
              <i class="fas fa-chart-bar text-gray-400 text-3xl mb-3"></i>
              <h4 class="text-white font-semibold mb-2">Performance Individual Indispon√≠vel</h4>
              <p class="text-gray-400 text-sm">Dados detalhados n√£o est√£o dispon√≠veis.</p>
              <button onclick="refreshAnalytics()" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                <i class="fas fa-sync-alt mr-1"></i> Tentar Atualizar
              </button>
            </div>
          `}
          
          <!-- üî• DISTRIBUI√á√ÉO POR SETORES -->
          ${metrics.assets_performance ? `
            <div class="bg-gray-800/50 rounded-xl p-6 border border-gray-600">
              <h4 class="text-white font-semibold mb-4 flex items-center">
                <i class="fas fa-pie-chart text-orange-400 mr-2"></i>
                Distribui√ß√£o por Setores
              </h4>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                ${getSectorDistribution(metrics.assets_performance)}
              </div>
            </div>
          ` : ''}
          
          <!-- üî• INFORMA√á√ïES T√âCNICAS -->
          <div class="bg-gray-800/30 rounded-xl p-6 border border-gray-600">
            <h4 class="text-white font-semibold mb-4 flex items-center">
              <i class="fas fa-info-circle text-blue-400 mr-2"></i>
              Informa√ß√µes da An√°lise
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-3">
                <div class="flex justify-between">
                  <span class="text-gray-400">Carteira:</span>
                  <span class="text-white font-medium">${data.portfolio_name}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Criada em:</span>
                  <span class="text-white">${formatDate(creationDate)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Idade:</span>
                  <span class="text-white">${portfolioAge} dias</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Total de Ativos:</span>
                  <span class="text-cyan-400 font-semibold">${metrics.number_of_assets}</span>
                </div>
              </div>
              <div class="space-y-3">
                <div class="flex justify-between">
                  <span class="text-gray-400">IBOVESPA (hoje):</span>
                  <span class="text-white">${ibovData.change_percent >= 0 ? '+' : ''}${ibovData.change_percent.toFixed(2)}%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Fonte IBOV:</span>
                  <span class="text-purple-400">${getSourceName(ibovData.source)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">√öltima atualiza√ß√£o:</span>
                  <span class="text-white">${formatDateTime(ibovData.last_update)}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">An√°lise:</span>
                  <span class="text-white">${formatDateTime(data.analysis_date)}</span>
                </div>
              </div>
            </div>
            
            <!-- Disclaimer -->
            <div class="mt-4 p-3 bg-yellow-900/20 border border-yellow-500/30 rounded-lg">
              <div class="flex items-start gap-2">
                <i class="fas fa-exclamation-triangle text-yellow-400 mt-0.5"></i>
                <div class="text-xs text-yellow-300">
                  <strong>Disclaimer:</strong> Dados baseados em Yahoo Finance com poss√≠vel delay. 
                  Compara√ß√£o com IBOVESPA √© indicativa. N√£o constitui recomenda√ß√£o de investimento.
                </div>
              </div>
            </div>
          </div>
          
        </div>
      `;
    }

    // ===== FUN√á√ïES DE REFRESH =====
    async function refreshAnalytics() {
      if (!currentPortfolioId) return;
      
      const refreshBtn = document.getElementById('refreshBtn');
      const originalText = refreshBtn.innerHTML;
      
      try {
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
        
        console.log(`üîÑ Refresh: ${currentPortfolioId}`);
        
        // Tentar endpoint de refresh
        const response = await fetch(`/chart_ativos/portfolio/${currentPortfolioId}/refresh`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${userToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast(`‚úÖ ${result.message}`, 'success');
          // Reabrir analytics
          await openAnalytics(currentPortfolioId, currentPortfolioName, 'REAL');
        } else {
          throw new Error(result.error);
        }
        
      } catch (error) {
        console.error('‚ùå Erro no refresh:', error);
        showToast(`‚ùå Erro: ${error.message}`, 'error');
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = originalText;
      }
    }

    // ===== FUN√á√ïES AUXILIARES =====
    function calculateDays(dateString) {
      if (!dateString) return 0;
      const start = new Date(dateString);
      const today = new Date();
      return Math.ceil((today - start) / (1000 * 60 * 60 * 24));
    }

    function calculateIbovPeriodReturn(ibovData, days) {
      if (!ibovData || !ibovData.change_percent || days <= 0) return 0;
      // Estimativa simples baseada na performance di√°ria
      const dailyReturn = ibovData.change_percent / 100;
      return Math.pow(1 + dailyReturn, days) - 1;
    }

    function getSourceBadge(source) {
      const badges = {
        'API_GEMINII': 'üü¢ API Geminii',
        'YFINANCE': 'üü° Yahoo Finance',
        'REFERENCE': 'üîµ Refer√™ncia',
        'ERROR': 'üî¥ Indispon√≠vel'
      };
      return badges[source] || '‚ùì Desconhecido';
    }

    function getSourceName(source) {
      const names = {
        'API_GEMINII': 'API Geminii',
        'YFINANCE': 'Yahoo Finance',
        'REFERENCE': 'Refer√™ncia',
        'ERROR': 'Indispon√≠vel'
      };
      return names[source] || 'Desconhecido';
    }

    function getAlphaEmoji(alpha) {
      if (alpha >= 5) return 'üöÄ Excelente!';
      if (alpha >= 0) return 'üìà Superando';
      if (alpha >= -5) return 'üòê Pr√≥ximo';
      return 'üìâ Abaixo';
    }

    function getPerformanceEmoji(returnPercent) {
      if (returnPercent >= 15) return '<span class="text-green-400 text-lg">üöÄ</span>';
      if (returnPercent >= 5) return '<span class="text-green-400 text-lg">üìà</span>';
      if (returnPercent >= 0) return '<span class="text-yellow-400 text-lg">üòä</span>';
      if (returnPercent >= -10) return '<span class="text-orange-400 text-lg">üòê</span>';
      return '<span class="text-red-400 text-lg">üìâ</span>';
    }

    function getPerformanceAnalysis(portfolioReturn, ibovReturn, days) {
      const alpha = portfolioReturn - ibovReturn;
      
      if (alpha >= 5) {
        return `üéâ Excelente! Sua carteira superou o IBOVESPA em ${alpha.toFixed(2)} pontos percentuais nos √∫ltimos ${days} dias.`;
      } else if (alpha >= 0) {
        return `üìà Parab√©ns! Sua estrat√©gia est√° funcionando, batendo o mercado em ${alpha.toFixed(2)}%.`;
      } else if (alpha >= -3) {
        return `üòê Performance pr√≥xima ao mercado. Diferen√ßa de apenas ${Math.abs(alpha).toFixed(2)}%.`;
      } else {
        return `‚ö†Ô∏è Carteira ${Math.abs(alpha).toFixed(2)}% abaixo do IBOV. Considere revisar posi√ß√µes.`;
      }
    }

    function getSectorDistribution(assetsPerformance) {
      // Agrupar por setor
      const sectors = {};
      Object.values(assetsPerformance).forEach(asset => {
        const sector = asset.sector || 'Outros';
        if (!sectors[sector]) {
          sectors[sector] = { count: 0, totalWeight: 0, avgReturn: 0 };
        }
        sectors[sector].count++;
        sectors[sector].totalWeight += asset.weight || 0;
        sectors[sector].avgReturn += asset.return || 0;
      });
      
      // Calcular m√©dia
      Object.keys(sectors).forEach(sector => {
        sectors[sector].avgReturn = sectors[sector].avgReturn / sectors[sector].count;
      });
      
      return Object.entries(sectors).map(([sector, data]) => `
        <div class="bg-gray-700/50 rounded-lg p-3 border border-gray-600">
          <div class="text-white font-medium text-sm mb-1">${sector}</div>
          <div class="text-xs text-gray-400 space-y-1">
            <div>${data.count} ${data.count === 1 ? 'ativo' : 'ativos'}</div>
            <div class="text-cyan-400">${data.totalWeight.toFixed(1)}% peso</div>
            <div class="${data.avgReturn >= 0 ? 'text-green-400' : 'text-red-400'}">
              ${data.avgReturn >= 0 ? '+' : ''}${data.avgReturn.toFixed(1)}% m√©dia
            </div>
          </div>
        </div>
      `).join('');
    }

    // ===== EXIBIR ATIVOS =====
    function displayAssets(assets, container, totalWeight) {
      if (!assets || assets.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum ativo encontrado</p>';
        return;
      }
      
      let html = `
        <div class="mb-4 text-center">
          <p class="text-white font-semibold">üìä ${assets.length} ativos ‚Ä¢ Peso total: ${totalWeight || 0}%</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-80 overflow-y-auto">
      `;
      
      assets.forEach(asset => {
        const entryPrice = asset.entry_price || 0;
        const currentPrice = asset.current_price || 0;
        const targetPrice = asset.target_price || 0;
        const entryDate = asset.entry_date;
        
        const performance = currentPrice && entryPrice ? ((currentPrice - entryPrice) / entryPrice * 100) : 0;
        const performanceColor = performance >= 0 ? 'text-green-400' : 'text-red-400';
        
        html += `
          <div class="bg-gray-700 bg-opacity-50 rounded-lg p-4 border border-gray-600">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-bold text-white">${asset.ticker}</h4>
              <span class="text-sm text-geminii font-semibold">${asset.weight}%</span>
            </div>
            <p class="text-xs text-gray-400 mb-1">${asset.sector}</p>
            ${entryDate ? `<p class="text-xs text-purple-400 mb-3">Entrada: ${formatDate(entryDate)}</p>` : ''}
            
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-400">Entrada:</span>
                <span class="text-white">R$ ${entryPrice.toFixed(2)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Atual:</span>
                <span class="text-white">R$ ${currentPrice.toFixed(2)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Alvo:</span>
                <span class="text-green-400">R$ ${targetPrice.toFixed(2)}</span>
              </div>
              ${performance !== 0 ? `
                <div class="flex justify-between">
                  <span class="text-gray-400">Performance:</span>
                  <span class="${performanceColor} font-semibold">
                    ${performance > 0 ? '+' : ''}${performance.toFixed(2)}%
                  </span>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    // ===== UTILIT√ÅRIOS =====
    function formatDateTime(dateString) {
      if (!dateString) return 'N/A';
      return new Date(dateString).toLocaleString('pt-BR');
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      return new Date(dateString).toLocaleDateString('pt-BR');
    }

    function showToast(message, type = 'info') {
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-yellow-500'
      };
      
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300`;
      toast.textContent = message;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }

    // ===== FECHAR MODAL =====
    function closeModal() {
      const modal = document.getElementById('analyticsModal');
      if (modal) {
        modal.classList.add('hidden');
        currentPortfolioId = null;
        currentPortfolioName = null;
      }
    }

    // ===== ESTADOS DA UI =====
    function showLoading() {
      const container = document.getElementById('portfoliosContainer');
      if (container) {
        container.innerHTML = `
          <div class="card rounded-2xl p-8 fade-in">
            <div class="text-center py-12">
              <div class="spinner mx-auto mb-4"></div>
              <p class="text-gray-300">Carregando suas carteiras...</p>
            </div>
          </div>
        `;
      }
    }

    function showNoData() {
      const container = document.getElementById('portfoliosContainer');
      if (container) {
        container.innerHTML = `
          <div class="card rounded-2xl p-8 fade-in">
            <div class="text-center py-12">
              <i class="fas fa-inbox text-5xl text-gray-400 mb-4"></i>
              <h3 class="text-xl font-bold mb-2 text-gray-300">Nenhuma carteira dispon√≠vel</h3>
              <p class="text-gray-400 mb-4">Voc√™ ainda n√£o tem acesso a nenhuma carteira.</p>
              <div class="flex justify-center space-x-4">
                <a href="/planos.html" class="bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 px-6 py-2 rounded-lg text-white font-medium">
                  <i class="fas fa-crown mr-2"></i>Fazer Upgrade
                </a>
                <button onclick="loadPortfolios()" class="bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded-lg text-white">
                  <i class="fas fa-refresh mr-1"></i>Atualizar
                </button>
              </div>
            </div>
          </div>
        `;
      }
    }

    function showError(message) {
      const container = document.getElementById('portfoliosContainer');
      if (container) {
        container.innerHTML = `
          <div class="card rounded-2xl p-8 fade-in">
            <div class="text-center py-12">
              <i class="fas fa-exclamation-triangle text-5xl text-danger mb-4"></i>
              <h3 class="text-xl font-bold mb-2 text-red-400">Erro ao carregar</h3>
              <p class="text-gray-400 mb-4">${message}</p>
              <button onclick="loadPortfolios()" class="bg-primary hover:bg-secondary px-6 py-2 rounded-lg text-white">
                <i class="fas fa-refresh mr-1"></i>Tentar Novamente
              </button>
            </div>
          </div>
        `;
      }
    }

    function showModalError(message) {
      const modalContent = document.getElementById('modalContent');
      modalContent.innerHTML = `
        <div class="text-center py-12">
          <i class="fas fa-exclamation-triangle text-5xl text-red-400 mb-4"></i>
          <h3 class="text-xl font-bold mb-2 text-red-400">Erro ao Carregar Analytics</h3>
          <p class="text-gray-400 mb-4">${message}</p>
          <div class="space-x-4">
            <button onclick="closeModal()" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg text-white">
              Fechar
            </button>
            <button onclick="refreshAnalytics()" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg text-white">
              <i class="fas fa-sync-alt mr-1"></i>Tentar Novamente
            </button>
          </div>
        </div>
      `;
    }

    // ===== EXIBIR RECOMENDA√á√ïES ===== (FUN√á√ÉO DO C√ìDIGO ANTIGO)
    function displayRecommendations(recommendations, container) {
      if (!recommendations || recommendations.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhuma recomenda√ß√£o ativa para esta carteira</p>';
        return;
      }
      
      const buy = recommendations.filter(r => r.action_type === 'BUY').length;
      const sell = recommendations.filter(r => r.action_type === 'SELL').length;
      const hold = recommendations.filter(r => r.action_type === 'HOLD').length;
      
      let html = `
        <div class="grid grid-cols-3 gap-3 mb-4">
          <div class="bg-green-600 bg-opacity-20 border border-green-600 border-opacity-30 rounded-lg p-3 text-center">
            <div class="text-xl font-bold text-green-400">${buy}</div>
            <div class="text-xs text-green-300">Comprar</div>
          </div>
          <div class="bg-red-600 bg-opacity-20 border border-red-600 border-opacity-30 rounded-lg p-3 text-center">
            <div class="text-xl font-bold text-red-400">${sell}</div>
            <div class="text-xs text-red-300">Vender</div>
          </div>
          <div class="bg-yellow-600 bg-opacity-20 border border-yellow-600 border-opacity-30 rounded-lg p-3 text-center">
            <div class="text-xl font-bold text-yellow-400">${hold}</div>
            <div class="text-xs text-yellow-300">Manter</div>
          </div>
        </div>
        
        <div class="space-y-3 max-h-80 overflow-y-auto">
      `;
      
      recommendations.forEach(rec => {
        const actionColors = {
          'BUY': 'bg-green-600 text-green-200',
          'SELL': 'bg-red-600 text-red-200',
          'HOLD': 'bg-yellow-600 text-yellow-200'
        };
        
        const actionTexts = {
          'BUY': 'Comprar',
          'SELL': 'Vender',
          'HOLD': 'Manter'
        };
        
        html += `
          <div class="bg-gray-700 bg-opacity-50 rounded-lg p-4 border border-gray-600">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center space-x-2">
                <h4 class="font-bold text-white">${rec.ticker}</h4>
                ${rec.company_name ? `<span class="text-xs text-gray-400">${rec.company_name}</span>` : ''}
              </div>
              <span class="px-2 py-1 rounded text-xs font-medium ${actionColors[rec.action_type] || 'bg-gray-600 text-gray-200'}">
                ${actionTexts[rec.action_type] || rec.action_type}
              </span>
            </div>
            
            <div class="space-y-1 text-sm">
              ${rec.price_target ? `
                <div class="flex justify-between">
                  <span class="text-gray-400">Pre√ßo alvo:</span>
                  <span class="text-green-400">R$ ${rec.price_target.toFixed(2)}</span>
                </div>
              ` : ''}
              
              ${rec.current_price ? `
                <div class="flex justify-between">
                  <span class="text-gray-400">Pre√ßo atual:</span>
                  <span class="text-white">R$ ${rec.current_price.toFixed(2)}</span>
                </div>
              ` : ''}
              
              ${rec.target_weight ? `
                <div class="flex justify-between">
                  <span class="text-gray-400">Peso sugerido:</span>
                  <span class="text-geminii">${rec.target_weight}%</span>
                </div>
              ` : ''}
            </div>
            
            ${rec.reason ? `
              <div class="mt-3 p-3 bg-gray-600 bg-opacity-30 rounded">
                <p class="text-xs text-gray-300">${rec.reason}</p>
              </div>
            ` : ''}
            
            <div class="mt-2 text-xs text-gray-500">
              Recomenda√ß√£o de ${formatDate(rec.recommendation_date)}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    // ===== EVENT LISTENERS =====
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
      }
    });

    // Fechar modal clicando fora
    document.getElementById('analyticsModal').addEventListener('click', (e) => {
      if (e.target.id === 'analyticsModal') {
        closeModal();
      }
    });

  </script>
</body>
</html>
    