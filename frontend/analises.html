<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>An√°lises & Carteiras - Geminii Tech</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            secondary: '#8b5cf6',
            accent: '#06b6d4',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            geminii: '#ba39af'
          }
        }
      }
    }
  </script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  
  <style>
    * {
      scroll-behavior: smooth;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: #0f0f0f;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .navbar {
      background: rgba(15, 15, 15, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .nav-active {
      color: #6366f1;
      font-weight: 600;
      border-bottom: 2px solid #6366f1;
      padding-bottom: 4px;
    }
    
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 3px solid #8b5cf6;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Modal scrollbar */
    #modalContent::-webkit-scrollbar {
      width: 6px;
    }
    
    #modalContent::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }
    
    #modalContent::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, 0.5);
      border-radius: 3px;
    }
    
    #modalContent::-webkit-scrollbar-thumb:hover {
      background: rgba(139, 92, 246, 0.7);
    }
  </style>
</head>
<body class="min-h-screen">
  
  <!-- Navigation -->
  <nav class="navbar fixed top-0 left-0 right-0 z-50 px-6 py-4">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center space-x-8">
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-gradient-to-r from-primary to-secondary rounded-lg"></div>
          <span class="text-xl font-bold text-white">Geminii</span>
        </div>
        <div class="hidden md:flex items-center space-x-6">
          <a href="dashboard.html" class="text-gray-300 hover:text-primary transition-colors font-medium">Dashboard</a>
          <a href="analises.html" class="nav-active transition-colors font-medium">Smart Carteiras</a>
          <a href="relatorios.html" class="text-gray-300 hover:text-primary transition-colors">Machine Learning</a>
        </div>
      </div>
      
      <div class="flex items-center space-x-4">
        <div id="statusIndicator" class="flex items-center space-x-2">
          <div class="w-2 h-2 bg-success rounded-full animate-pulse"></div>
          <span class="text-sm text-gray-300">Online</span>
        </div>
        <button onclick="logout()" class="bg-red-50 hover:bg-red-100 text-red-600 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
          Sair
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="pt-20 px-6 pb-12">
    <div class="max-w-7xl mx-auto">
      
      <!-- Page Header -->
      <div class="mb-8">
        <h1 class="text-4xl font-bold text-white mb-2">An√°lises & Carteiras</h1>
        <p class="text-gray-300 text-lg">Suas recomenda√ß√µes personalizadas de investimento com analytics avan√ßado</p>
      </div>

      <!-- Container Principal das Carteiras -->
      <div id="portfoliosContainer">
        <!-- Loading inicial -->
        <div class="card rounded-2xl p-8 fade-in">
          <div class="text-center py-12">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-300">Carregando suas carteiras...</p>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Modal de Analytics -->
  <div id="analyticsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-gray-900 rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
      <!-- Header do Modal -->
      <div class="flex items-center justify-between p-6 border-b border-gray-700">
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg flex items-center justify-center">
            <i class="fas fa-chart-area text-white text-sm"></i>
          </div>
          <div>
            <h2 id="modalTitle" class="text-xl font-bold text-white">Analytics da Carteira</h2>
            <p id="modalSubtitle" class="text-gray-400 text-sm">An√°lise de performance e m√©tricas</p>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <!-- Bot√£o de Refresh -->
          <button id="refreshBtn" onclick="refreshCurrentPortfolio()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm transition-colors">
            <i class="fas fa-sync-alt"></i> Atualizar
          </button>
          <button onclick="closeAnalyticsModal()" class="text-gray-400 hover:text-white transition-colors">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      
      <!-- Conte√∫do do Modal -->
      <div id="modalContent" class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
        <!-- Conte√∫do ser√° inserido aqui -->
      </div>
    </div>
  </div>

  <script>
    // ===== VARI√ÅVEIS GLOBAIS =====
    let userToken = null;
    let currentUser = null;
    let currentPortfolioName = null; // Para refresh no modal

    // ===== INICIALIZA√á√ÉO =====
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ P√°gina An√°lises carregada');
      initAnalises();
    });

    async function initAnalises() {
      console.log('üîç Inicializando sistema de an√°lises...');
      
      // Verificar autentica√ß√£o
      if (!checkAuth()) return;
      
      // Carregar dados das carteiras
      await loadPortfolioData();
      
      console.log('‚úÖ An√°lises inicializadas!');
    }

    // ===== AUTENTICA√á√ÉO =====
    function checkAuth() {
      userToken = localStorage.getItem('authToken') || localStorage.getItem('geminii_token');
      const userData = localStorage.getItem('geminii_user');
      
      if (!userToken) {
        console.log('‚ùå Token n√£o encontrado, redirecionando...');
        window.location.href = '/login';
        return false;
      }
      
      if (userData) {
        try {
          currentUser = JSON.parse(userData);
        } catch (error) {
          console.error('Erro ao parsear dados do usu√°rio:', error);
        }
      }
      
      return true;
    }

    function logout() {
      if (confirm('Deseja realmente sair?')) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('geminii_token');
        localStorage.removeItem('geminii_user');
        window.location.href = '/';
      }
    }

    // ===== CARREGAR DADOS DAS CARTEIRAS - SISTEMA H√çBRIDO =====
    async function loadPortfolioData() {
      const container = document.getElementById('portfoliosContainer');
      
      try {
        console.log('üîç Buscando dados das carteiras...');
        showLoading();
        
        // INTEGRA√á√ÉO 1: Tentar endpoint REAL primeiro
        let response, data;
        try {
          response = await fetch('/chart_ativos/user/portfolios', {
            headers: {
              'Authorization': `Bearer ${userToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            data = await response.json();
            console.log('üìä Dados do sistema REAL:', data);
            
            if (data.success && data.portfolios && data.portfolios.length > 0) {
              displayPortfolios(data.portfolios, 'REAL');
              return;
            }
          }
        } catch (realError) {
          console.log('‚ö†Ô∏è Sistema real n√£o dispon√≠vel, tentando API antiga:', realError.message);
        }
        
        // INTEGRA√á√ÉO 2: Fallback para API antiga
        response = await fetch('/api/user/my-portfolios', {
          headers: {
            'Authorization': `Bearer ${userToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        console.log('üì° Response status API antiga:', response.status);
        
        if (!response.ok) {
          if (response.status === 401) {
            localStorage.removeItem('authToken');
            localStorage.removeItem('geminii_token');
            window.location.href = '/login';
            return;
          }
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        data = await response.json();
        console.log('üìä Dados da API antiga:', data);
        
        if (data.success && data.portfolios) {
          displayPortfolios(data.portfolios, 'API_ANTIGA');
        } else {
          throw new Error(data.error || 'Nenhuma carteira encontrada');
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar dados:', error);
        showError(error.message);
      }
    }

    // ===== EXIBIR CARTEIRAS - SISTEMA H√çBRIDO =====
    function displayPortfolios(portfolios, source) {
      const container = document.getElementById('portfoliosContainer');
      if (!container) return;
      
      console.log(`üìä Exibindo ${portfolios.length} carteiras (fonte: ${source})`);
      
      if (portfolios.length === 0) {
        showNoData();
        return;
      }
      
      let html = '';
      
      portfolios.forEach(portfolio => {
        // Adaptar estrutura conforme a fonte
        const portfolioData = source === 'REAL' ? {
          id: portfolio.id,
          name: portfolio.name,
          display_name: portfolio.display_name || portfolio.name,
          description: portfolio.description,
          asset_count: portfolio.asset_count,
          granted_at: portfolio.granted_at
        } : {
          id: portfolio.name,
          name: portfolio.display_name || portfolio.name,
          display_name: portfolio.display_name || portfolio.name,
          description: portfolio.description,
          asset_count: null,
          granted_at: portfolio.granted_at
        };
        
        html += `
          <div class="card rounded-2xl p-8 mb-6 fade-in">
            <div class="flex items-center justify-between mb-6">
              <div>
                <h2 class="text-2xl font-bold text-white flex items-center">
                  <i class="fas fa-briefcase text-primary mr-3"></i>
                  ${portfolioData.display_name}
                </h2>
                <p class="text-gray-400">${portfolioData.description || 'Carteira de investimentos'}</p>
                <div class="flex items-center space-x-4 mt-2 text-sm text-gray-500">
                  ${portfolioData.asset_count ? `<span>${portfolioData.asset_count} ativos</span>` : ''}
                  ${portfolioData.granted_at ? `<span>Acesso: ${formatDate(portfolioData.granted_at)}</span>` : ''}
                  <span class="px-2 py-1 rounded text-xs ${source === 'REAL' ? 'bg-green-900/30 text-green-400' : 'bg-blue-900/30 text-blue-400'}">
                    ${source === 'REAL' ? 'üîÑ Sistema Real' : 'üìä API Cl√°ssica'}
                  </span>
                </div>
              </div>
              <div class="flex space-x-2">
                <!-- BOT√ÉO 1: ATIVOS -->
                <button onclick="loadPortfolioAssets('${portfolioData.id}')" class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded-lg text-white text-sm transition-colors">
                  <i class="fas fa-list mr-1"></i>
                  Ativos
                </button>
                <!-- BOT√ÉO 2: RECOMENDA√á√ïES -->
                <button onclick="loadPortfolioRecommendations('${portfolioData.id}')" class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded-lg text-white text-sm transition-colors">
                  <i class="fas fa-lightbulb mr-1"></i>
                  Recomenda√ß√µes
                </button>
                <!-- BOT√ÉO 3: ANALYTICS REAIS -->
                <button onclick="${source === 'REAL' ? `openRealAnalyticsModal('${portfolioData.id}', '${portfolioData.name}')` : `openAnalyticsModal('${portfolioData.id}', '${portfolioData.name}')`}" class="bg-purple-600 hover:bg-purple-700 px-3 py-2 rounded-lg text-white text-sm transition-colors">
                  <i class="fas fa-chart-area mr-1"></i>
                  ${source === 'REAL' ? 'Analytics Reais' : 'Analytics'}
                </button>
              </div>
            </div>
            
            <!-- Container para carregar conte√∫do -->
            <div id="portfolio-${portfolioData.id}-content" class="bg-gray-800 bg-opacity-30 rounded-lg p-6 min-h-24">
              <p class="text-gray-300 text-center">
                <i class="fas fa-chart-line text-primary mr-2"></i>
                Selecione uma op√ß√£o acima para ver os detalhes da carteira ${portfolioData.display_name}
              </p>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // ===== CARREGAR ATIVOS =====
    async function loadPortfolioAssets(portfolioName) {
      const contentDiv = document.getElementById(`portfolio-${portfolioName}-content`);
      if (!contentDiv) return;
      
      try {
        contentDiv.innerHTML = '<div class="text-center py-4"><div class="spinner mx-auto mb-2"></div><p class="text-gray-400">Carregando ativos...</p></div>';
        
        const response = await fetch(`/api/user/portfolio/${portfolioName}/assets`, {
          headers: { 'Authorization': `Bearer ${userToken}` }
        });
        
        if (!response.ok) {
          throw new Error(`Erro ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.assets) {
          displayAssets(data.assets, contentDiv, data.total_weight);
        } else {
          contentDiv.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum ativo encontrado nesta carteira</p>';
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar ativos:', error);
        contentDiv.innerHTML = '<p class="text-red-400 text-center py-4">Erro ao carregar ativos</p>';
      }
    }

    // ===== CARREGAR RECOMENDA√á√ïES =====
    async function loadPortfolioRecommendations(portfolioName) {
      const contentDiv = document.getElementById(`portfolio-${portfolioName}-content`);
      if (!contentDiv) return;
      
      try {
        contentDiv.innerHTML = '<div class="text-center py-4"><div class="spinner mx-auto mb-2"></div><p class="text-gray-400">Carregando recomenda√ß√µes...</p></div>';
        
        const response = await fetch(`/api/user/portfolio/${portfolioName}/recommendations`, {
          headers: { 'Authorization': `Bearer ${userToken}` }
        });
        
        if (!response.ok) {
          throw new Error(`Erro ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.recommendations) {
          displayRecommendations(data.recommendations, contentDiv);
        } else {
          contentDiv.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhuma recomenda√ß√£o encontrada nesta carteira</p>';
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar recomenda√ß√µes:', error);
        contentDiv.innerHTML = '<p class="text-red-400 text-center py-4">Erro ao carregar recomenda√ß√µes</p>';
      }
    }

    // ===== MODAL ANALYTICS REAIS =====
    async function openRealAnalyticsModal(portfolioId, portfolioName) {
      console.log(`üìä Abrindo analytics REAL para: ${portfolioId}`);
      
      currentPortfolioName = portfolioId; // Salvar para refresh
      
      const modal = document.getElementById('analyticsModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalSubtitle = document.getElementById('modalSubtitle');
      const modalContent = document.getElementById('modalContent');
      
      // Atualizar t√≠tulo
      modalTitle.textContent = `Analytics Reais - ${portfolioName}`;
      modalSubtitle.textContent = 'Coletando dados do Yahoo Finance...';
      
      // Mostrar modal com loading
      modalContent.innerHTML = `
        <div class="text-center py-12">
          <div class="spinner mx-auto mb-4"></div>
          <p class="text-gray-300">Coletando dados do Yahoo Finance...</p>
          <p class="text-gray-500 text-sm mt-2">Atualizando pre√ßos e calculando m√©tricas</p>
        </div>
      `;
      
      modal.classList.remove('hidden');
      
      try {
        // Chamar endpoint REAL dos analytics
        const response = await fetch(`/chart_ativos/portfolio/${portfolioId}/analytics`, {
          headers: {
            'Authorization': `Bearer ${userToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`Erro ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('üìà Analytics reais recebidos:', result);
        
        if (result.success && result.data) {
          displayRealAnalytics(result.data);
          modalSubtitle.textContent = `√öltima atualiza√ß√£o: ${formatDateTime(result.data.analysis_date)}`;
        } else {
          throw new Error(result.error || 'Dados de analytics n√£o encontrados');
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar analytics reais:', error);
        showAnalyticsError(error.message);
      }
    }

    // ===== MODAL ANALYTICS ANTIGO =====
    async function openAnalyticsModal(portfolioName, displayName) {
      console.log(`üìä Abrindo analytics ANTIGO para: ${portfolioName}`);
      
      const modal = document.getElementById('analyticsModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalSubtitle = document.getElementById('modalSubtitle');
      const modalContent = document.getElementById('modalContent');
      
      // Atualizar t√≠tulo
      modalTitle.textContent = `Analytics - ${displayName}`;
      modalSubtitle.textContent = 'Coletando dados do Yahoo Finance...';
      
      // Mostrar modal com loading
      modalContent.innerHTML = `
        <div class="text-center py-12">
          <div class="spinner mx-auto mb-4"></div>
          <p class="text-gray-300">Calculando m√©tricas de performance...</p>
          <p class="text-gray-500 text-sm mt-2">Analisando dados hist√≥ricos e comparando com IBOVESPA</p>
        </div>
      `;
      
      modal.classList.remove('hidden');
      
      try {
        const response = await fetch(`/chart_ativos/portfolio/${portfolioName}/analytics`, {
          headers: {
            'Authorization': `Bearer ${userToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`Erro ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success && result.analytics_data) {
          displayAnalyticsInModal(result.analytics_data);
          modalSubtitle.textContent = `Per√≠odo: ${formatDate(result.analytics_data.analysis_period.start_date)} at√© ${formatDate(result.analytics_data.analysis_period.end_date)}`;
        } else if (result.success && result.data) {
          // Se retornar formato novo, usar fun√ß√£o nova
          displayRealAnalytics(result.data);
        } else {
          throw new Error(result.error || 'Dados de analytics n√£o encontrados');
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar analytics:', error);
        showAnalyticsError(error.message);
      }
    }

    // ===== FUN√á√ÉO DE REFRESH =====
    async function refreshCurrentPortfolio() {
      if (!currentPortfolioName) return;
      
      const refreshBtn = document.getElementById('refreshBtn');
      const originalText = refreshBtn.innerHTML;
      
      try {
        // Atualizar bot√£o
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
        
        console.log(`üîÑ Fazendo refresh da carteira: ${currentPortfolioName}`);
        
        // Endpoint de refresh for√ßado
        const response = await fetch(`/chart_ativos/portfolio/${currentPortfolioName}/refresh`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${userToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Mostrar toast de sucesso
          showToast(`‚úÖ ${result.message}`, 'success');
          
          // Recarregar analytics
          const portfolioName = document.getElementById('modalTitle').textContent.replace('Analytics Reais - ', '').replace('Analytics - ', '');
          await openRealAnalyticsModal(currentPortfolioName, portfolioName);
          
        } else {
          throw new Error(result.error);
        }
        
      } catch (error) {
        console.error('‚ùå Erro no refresh:', error);
        showToast(`‚ùå Erro: ${error.message}`, 'error');
      } finally {
        // Restaurar bot√£o
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = originalText;
      }
    }

    // ===== EXIBIR ANALYTICS REAIS =====
    function displayRealAnalytics(data) {
      const modalContent = document.getElementById('modalContent');
      const metrics = data.metrics;
      const updateInfo = data.update_info;
      
      modalContent.innerHTML = `
        <div class="space-y-6">
          
          <!-- Info de Atualiza√ß√£o -->
          ${updateInfo ? `
            <div class="p-4 rounded-lg ${updateInfo.prices_updated ? 'bg-green-900/30 border border-green-500/30' : updateInfo.needs_refresh ? 'bg-yellow-900/30 border border-yellow-500/30' : 'bg-blue-900/30 border border-blue-500/30'}">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-white font-medium">
                    ${updateInfo.prices_updated ? '‚úÖ Pre√ßos atualizados!' : updateInfo.needs_refresh ? '‚è∞ Pre√ßos desatualizados' : '‚úÖ Dados atuais'}
                  </p>
                  <p class="text-sm text-gray-400">${updateInfo.update_message}</p>
                  ${updateInfo.last_update ? `<p class="text-xs text-gray-500">√öltima atualiza√ß√£o: ${formatDateTime(updateInfo.last_update)}</p>` : ''}
                </div>
                ${updateInfo.needs_refresh ? `
                  <button onclick="refreshCurrentPortfolio()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded-lg text-sm">
                    <i class="fas fa-sync-alt mr-1"></i> Atualizar Agora
                  </button>
                ` : ''}
              </div>
            </div>
          ` : ''}
          
          <!-- M√©tricas Principais -->
          <div class="bg-gradient-to-r from-purple-900/30 to-pink-900/30 rounded-xl p-6 border border-purple-500/20">
            <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
              <i class="fas fa-trophy text-yellow-400 mr-2"></i>
              Performance da Carteira
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="text-center">
                <div class="text-2xl font-bold ${metrics.total_return >= 0 ? 'text-green-400' : 'text-red-400'}">
                  ${metrics.total_return > 0 ? '+' : ''}${metrics.total_return}%
                </div>
                <div class="text-xs text-gray-400">Retorno Total</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-blue-400">${metrics.number_of_assets}</div>
                <div class="text-xs text-gray-400">Ativos</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-purple-400">${data.assets_count}</div>
                <div class="text-xs text-gray-400">Total Analisados</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-cyan-400">
                  ${data.has_historical_data ? 'Sim' : 'N√£o'}
                </div>
                <div class="text-xs text-gray-400">Dados Hist√≥ricos</div>
              </div>
            </div>
          </div>
          
          <!-- Performance dos Ativos -->
          ${metrics.assets_performance ? `
            <div class="bg-gray-800/50 rounded-xl p-6">
              <h4 class="text-white font-semibold mb-4 flex items-center">
                <i class="fas fa-chart-bar text-green-400 mr-2"></i>
                Performance Individual dos Ativos
              </h4>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="border-b border-gray-700">
                      <th class="text-left py-2 text-gray-400">Ativo</th>
                      <th class="text-left py-2 text-gray-400">Setor</th>
                      <th class="text-right py-2 text-gray-400">Peso</th>
                      <th class="text-right py-2 text-gray-400">Entrada</th>
                      <th class="text-right py-2 text-gray-400">Atual</th>
                      <th class="text-right py-2 text-gray-400">Retorno</th>
                      <th class="text-right py-2 text-gray-400">P&L</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${Object.entries(metrics.assets_performance).map(([ticker, data]) => `
                      <tr class="border-b border-gray-800">
                        <td class="py-2 text-white font-medium">${ticker}</td>
                        <td class="py-2 text-gray-400 text-xs">${data.sector}</td>
                        <td class="py-2 text-right text-cyan-400">${data.weight}%</td>
                        <td class="py-2 text-right text-gray-300">R$ ${data.entry_price.toFixed(2)}</td>
                        <td class="py-2 text-right text-white">R$ ${data.current_price.toFixed(2)}</td>
                        <td class="py-2 text-right ${data.return >= 0 ? 'text-green-400' : 'text-red-400'}">
                          ${data.return >= 0 ? '+' : ''}${data.return}%
                        </td>
                        <td class="py-2 text-right ${data.profit_loss >= 0 ? 'text-green-400' : 'text-red-400'}">
                          R$ ${data.profit_loss.toFixed(2)}
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          ` : ''}
          
          <!-- Informa√ß√µes T√©cnicas -->
          <div class="bg-gray-800/30 rounded-xl p-6 border border-gray-600">
            <h4 class="text-white font-semibold mb-4 flex items-center">
              <i class="fas fa-info-circle text-blue-400 mr-2"></i>
              Informa√ß√µes da An√°lise
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div>
                <p class="text-gray-300"><strong class="text-white">Carteira:</strong> ${data.portfolio_name}</p>
                <p class="text-gray-300"><strong class="text-white">An√°lise:</strong> ${formatDateTime(data.analysis_date)}</p>
                <p class="text-gray-300"><strong class="text-white">Per√≠odo:</strong> ${data.period_analyzed}</p>
              </div>
              <div>
                <p class="text-gray-300"><strong class="text-white">Dados Hist√≥ricos:</strong> ${data.has_historical_data ? 'Dispon√≠veis' : 'N√£o dispon√≠veis'}</p>
                <p class="text-gray-300"><strong class="text-white">√öltima atualiza√ß√£o:</strong> ${updateInfo?.last_update ? formatDateTime(updateInfo.last_update) : 'N/A'}</p>
                <p class="text-gray-300"><strong class="text-white">Status:</strong> 
                  <span class="${updateInfo?.needs_refresh ? 'text-yellow-400' : 'text-green-400'}">
                    ${updateInfo?.needs_refresh ? 'Necessita atualiza√ß√£o' : 'Atualizado'}
                  </span>
                </p>
              </div>
            </div>
          </div>
          
        </div>
      `;
    }

    // ===== EXIBIR ANALYTICS ANTIGO =====
    function displayAnalyticsInModal(analyticsData) {
      const modalContent = document.getElementById('modalContent');
      const metrics = analyticsData.performance_metrics;
      const chartData = analyticsData.chart_data;
      const assetsInfo = analyticsData.assets_analyzed;
      
      modalContent.innerHTML = `
        <div class="space-y-6">
          
          <!-- Resumo Executivo -->
          <div class="bg-gradient-to-r from-purple-900/30 to-pink-900/30 rounded-xl p-6 border border-purple-500/20">
            <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
              <i class="fas fa-trophy text-yellow-400 mr-2"></i>
              Resumo da Performance
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="text-center">
                <div class="text-2xl font-bold ${metrics.total_return_portfolio >= 0 ? 'text-green-400' : 'text-red-400'}">
                  ${metrics.total_return_portfolio > 0 ? '+' : ''}${metrics.total_return_portfolio}%
                </div>
                <div class="text-xs text-gray-400">Retorno Total</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-yellow-400">${metrics.volatility_portfolio}%</div>
                <div class="text-xs text-gray-400">Volatilidade</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-blue-400">${metrics.sharpe_portfolio}</div>
                <div class="text-xs text-gray-400">Sharpe Ratio</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-purple-400">${metrics.max_drawdown_portfolio}%</div>
                <div class="text-xs text-gray-400">Max Drawdown</div>
              </div>
            </div>
          </div>
          
          <!-- Compara√ß√£o com IBOVESPA -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Carteira vs Benchmark -->
            <div class="bg-gray-800/50 rounded-xl p-6">
              <h4 class="text-white font-semibold mb-4 flex items-center">
                <i class="fas fa-balance-scale text-cyan-400 mr-2"></i>
                Carteira vs IBOVESPA
              </h4>
              <div class="space-y-3">
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Retorno Carteira:</span>
                  <span class="${metrics.total_return_portfolio >= 0 ? 'text-green-400' : 'text-red-400'} font-semibold">
                    ${metrics.total_return_portfolio > 0 ? '+' : ''}${metrics.total_return_portfolio}%
                  </span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Retorno IBOV:</span>
                  <span class="${metrics.total_return_benchmark >= 0 ? 'text-green-400' : 'text-red-400'} font-semibold">
                    ${metrics.total_return_benchmark > 0 ? '+' : ''}${metrics.total_return_benchmark}%
                  </span>
                </div>
                <div class="flex justify-between items-center border-t border-gray-700 pt-2">
                  <span class="text-gray-400">Alpha (Excesso):</span>
                  <span class="text-geminii font-bold">
                    ${(metrics.total_return_portfolio - metrics.total_return_benchmark) > 0 ? '+' : ''}${(metrics.total_return_portfolio - metrics.total_return_benchmark).toFixed(2)}%
                  </span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">Beta:</span>
                  <span class="text-cyan-400 font-semibold">${metrics.beta_portfolio}</span>
                </div>
              </div>
            </div>
            
            <!-- Informa√ß√µes dos Ativos -->
            <div class="bg-gray-800/50 rounded-xl p-6">
              <h4 class="text-white font-semibold mb-4 flex items-center">
                <i class="fas fa-pie-chart text-orange-400 mr-2"></i>
                Composi√ß√£o da Carteira
              </h4>
              <div class="space-y-3">
                <div class="flex justify-between">
                  <span class="text-gray-400">Total de Ativos:</span>
                  <span class="text-white font-semibold">${assetsInfo.total_assets}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Com Dados:</span>
                  <span class="text-green-400 font-semibold">${assetsInfo.assets_with_data}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Per√≠odo Analisado:</span>
                  <span class="text-white">${analyticsData.analysis_period.days} dias</span>
                </div>
                
                <!-- Lista de Ativos -->
                <div class="mt-4 pt-3 border-t border-gray-700">
                  <p class="text-gray-400 text-sm mb-2">Ativos na Carteira:</p>
                  <div class="grid grid-cols-2 gap-2">
                    ${assetsInfo.tickers.map((ticker, index) => `
                      <div class="bg-gray-700/50 rounded px-2 py-1 text-xs">
                        <span class="text-white font-medium">${ticker.replace('.SA', '')}</span>
                        <span class="text-gray-400 ml-1">${(assetsInfo.weights[index] * 100).toFixed(1)}%</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Gr√°fico de Performance -->
          <div class="bg-gray-800/50 rounded-xl p-6">
            <h4 class="text-white font-semibold mb-4 flex items-center">
              <i class="fas fa-chart-line text-green-400 mr-2"></i>
              Performance Hist√≥rica
            </h4>
            <div class="relative h-64">
              <canvas id="performanceChart"></canvas>
            </div>
          </div>
          
          <!-- Interpreta√ß√£o das M√©tricas -->
          <div class="bg-gray-800/30 rounded-xl p-6 border border-gray-600">
            <h4 class="text-white font-semibold mb-4 flex items-center">
              <i class="fas fa-lightbulb text-yellow-400 mr-2"></i>
              Interpreta√ß√£o das M√©tricas
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div>
                <p class="text-gray-300"><strong class="text-white">Sharpe Ratio ${metrics.sharpe_portfolio}:</strong></p>
                <p class="text-gray-400">${getSharpeInterpretation(metrics.sharpe_portfolio)}</p>
              </div>
              <div>
                <p class="text-gray-300"><strong class="text-white">Beta ${metrics.beta_portfolio}:</strong></p>
                <p class="text-gray-400">${getBetaInterpretation(metrics.beta_portfolio)}</p>
              </div>
              <div>
                <p class="text-gray-300"><strong class="text-white">Volatilidade ${metrics.volatility_portfolio}%:</strong></p>
                <p class="text-gray-400">${getVolatilityInterpretation(metrics.volatility_portfolio)}</p>
              </div>
              <div>
                <p class="text-gray-300"><strong class="text-white">Alpha ${(metrics.total_return_portfolio - metrics.total_return_benchmark).toFixed(2)}%:</strong></p>
                <p class="text-gray-400">${getAlphaInterpretation(metrics.total_return_portfolio - metrics.total_return_benchmark)}</p>
              </div>
            </div>
          </div>
          
        </div>
      `;
      
      // Aguardar DOM e criar gr√°fico
      setTimeout(() => {
        createPerformanceChart(chartData);
      }, 100);
    }

    // ===== CRIAR GR√ÅFICO =====
    function createPerformanceChart(chartData) {
      const canvas = document.getElementById('performanceChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      
      if (typeof Chart === 'undefined') {
        canvas.parentElement.innerHTML = `
          <div class="text-center py-8 text-gray-400">
            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
            <p>Chart.js n√£o carregado</p>
          </div>
        `;
        return;
      }
      
      // Destruir gr√°fico anterior
      if (window.performanceChartInstance) {
        window.performanceChartInstance.destroy();
      }
      
      const dates = chartData.dates || [];
      const portfolioData = chartData.portfolio_normalized || [];
      const benchmarkData = chartData.benchmark_normalized || [];
      
      if (dates.length === 0 || portfolioData.length === 0) {
        canvas.parentElement.innerHTML = `
          <div class="text-center py-8 text-gray-400">
            <i class="fas fa-chart-line text-2xl mb-2"></i>
            <p>Dados insuficientes para gr√°fico</p>
          </div>
        `;
        return;
      }
      
      // Converter para percentual
      const portfolioPercent = portfolioData.map(val => (val - 1) * 100);
      const benchmarkPercent = benchmarkData.length > 0 ? benchmarkData.map(val => (val - 1) * 100) : [];
      
      // Configura√ß√£o do gr√°fico
      const config = {
        type: 'line',
        data: {
          labels: dates.map(date => {
            const d = new Date(date);
            return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
          }),
          datasets: [
            {
              label: 'Carteira',
              data: portfolioPercent,
              borderColor: '#8b5cf6',
              backgroundColor: 'rgba(139, 92, 246, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: '#ffffff',
                font: { size: 12 }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#8b5cf6',
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: '#9ca3af',
                maxTicksLimit: 8
              },
              grid: {
                color: 'rgba(156, 163, 175, 0.1)'
              }
            },
            y: {
              ticks: {
                color: '#9ca3af',
                callback: function(value) {
                  return value.toFixed(1) + '%';
                }
              },
              grid: {
                color: 'rgba(156, 163, 175, 0.1)'
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      };
      
      // Adicionar IBOVESPA se temos dados
      if (benchmarkPercent.length > 0) {
        config.data.datasets.push({
          label: 'IBOVESPA',
          data: benchmarkPercent,
          borderColor: '#ef4444',
          backgroundColor: 'rgba(239, 68, 68, 0.1)',
          borderWidth: 2,
          borderDash: [5, 5],
          fill: false,
          tension: 0.1
        });
      }
      
      // Criar gr√°fico
      window.performanceChartInstance = new Chart(ctx, config);
    }

    // ===== INTERPRETA√á√ïES =====
    function getSharpeInterpretation(sharpe) {
      if (sharpe > 2) return "Excelente! Retorno muito bom ajustado ao risco.";
      if (sharpe > 1) return "Bom. Retorno adequado para o risco assumido.";
      if (sharpe > 0) return "Aceit√°vel. Retorno positivo, mas pode melhorar.";
      return "Abaixo do esperado. Risco alto para o retorno obtido.";
    }

    function getBetaInterpretation(beta) {
      if (beta > 1.2) return "Alta correla√ß√£o com mercado. Mais vol√°til que IBOV.";
      if (beta > 0.8) return "Movimento similar ao mercado.";
      if (beta > 0) return "Menos vol√°til que o mercado.";
      return "Movimento contr√°rio ao mercado.";
    }

    function getVolatilityInterpretation(vol) {
      if (vol > 30) return "Alta volatilidade. Carteira de maior risco.";
      if (vol > 20) return "Volatilidade moderada-alta.";
      if (vol > 15) return "Volatilidade moderada.";
      return "Baixa volatilidade. Carteira mais conservadora.";
    }

    function getAlphaInterpretation(alpha) {
      if (alpha > 5) return "Excelente! Superou significativamente o benchmark.";
      if (alpha > 0) return "Positivo. Superou o benchmark.";
      if (alpha > -5) return "Pr√≥ximo ao benchmark.";
      return "Abaixo do benchmark. Revisar estrat√©gia.";
    }

    // ===== EXIBIR ATIVOS =====
    function displayAssets(assets, container, totalWeight) {
      if (!assets || assets.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-4">Carteira vazia - nenhum ativo cadastrado</p>';
        return;
      }
      
      let html = `
        <div class="mb-4 text-center">
          <p class="text-white font-semibold">üìä ${assets.length} ativos ‚Ä¢ Peso total: ${totalWeight || 0}%</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-80 overflow-y-auto">
      `;
      
      assets.forEach(asset => {
        const entryPrice = asset.entry_price || 0;
        const currentPrice = asset.current_price || 0;
        const targetPrice = asset.target_price || 0;
        
        const performance = currentPrice && entryPrice ? ((currentPrice - entryPrice) / entryPrice * 100) : 0;
        const performanceColor = performance >= 0 ? 'text-green-400' : 'text-red-400';
        
        html += `
          <div class="bg-gray-700 bg-opacity-50 rounded-lg p-4 border border-gray-600">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-bold text-white">${asset.ticker}</h4>
              <span class="text-sm text-geminii font-semibold">${asset.weight}%</span>
            </div>
            <p class="text-xs text-gray-400 mb-3">${asset.sector}</p>
            
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-400">Entrada:</span>
                <span class="text-white">R$ ${entryPrice.toFixed(2)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Atual:</span>
                <span class="text-white">R$ ${currentPrice.toFixed(2)}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-400">Alvo:</span>
                <span class="text-green-400">R$ ${targetPrice.toFixed(2)}</span>
              </div>
              ${performance !== 0 ? `
                <div class="flex justify-between">
                  <span class="text-gray-400">Performance:</span>
                  <span class="${performanceColor} font-semibold">
                    ${performance > 0 ? '+' : ''}${performance.toFixed(2)}%
                  </span>
                </div>
              ` : ''}
            </div>
            
            <div class="mt-3 text-xs text-gray-500">
              ${asset.company_name ? asset.company_name : asset.ticker}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    // ===== EXIBIR RECOMENDA√á√ïES =====
    function displayRecommendations(recommendations, container) {
      if (!recommendations || recommendations.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhuma recomenda√ß√£o ativa para esta carteira</p>';
        return;
      }
      
      const buy = recommendations.filter(r => r.action_type === 'BUY').length;
      const sell = recommendations.filter(r => r.action_type === 'SELL').length;
      const hold = recommendations.filter(r => r.action_type === 'HOLD').length;
      
      let html = `
        <div class="grid grid-cols-3 gap-3 mb-4">
          <div class="bg-green-600 bg-opacity-20 border border-green-600 border-opacity-30 rounded-lg p-3 text-center">
            <div class="text-xl font-bold text-green-400">${buy}</div>
            <div class="text-xs text-green-300">Comprar</div>
          </div>
          <div class="bg-red-600 bg-opacity-20 border border-red-600 border-opacity-30 rounded-lg p-3 text-center">
            <div class="text-xl font-bold text-red-400">${sell}</div>
            <div class="text-xs text-red-300">Vender</div>
          </div>
          <div class="bg-yellow-600 bg-opacity-20 border border-yellow-600 border-opacity-30 rounded-lg p-3 text-center">
            <div class="text-xl font-bold text-yellow-400">${hold}</div>
            <div class="text-xs text-yellow-300">Manter</div>
          </div>
        </div>
        
        <div class="space-y-3 max-h-80 overflow-y-auto">
      `;
      
      recommendations.forEach(rec => {
        const actionColors = {
          'BUY': 'bg-green-600 text-green-200',
          'SELL': 'bg-red-600 text-red-200',
          'HOLD': 'bg-yellow-600 text-yellow-200'
        };
        
        const actionTexts = {
          'BUY': 'Comprar',
          'SELL': 'Vender',
          'HOLD': 'Manter'
        };
        
        html += `
          <div class="bg-gray-700 bg-opacity-50 rounded-lg p-4 border border-gray-600">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center space-x-2">
                <h4 class="font-bold text-white">${rec.ticker}</h4>
                ${rec.company_name ? `<span class="text-xs text-gray-400">${rec.company_name}</span>` : ''}
              </div>
              <span class="px-2 py-1 rounded text-xs font-medium ${actionColors[rec.action_type] || 'bg-gray-600 text-gray-200'}">
                ${actionTexts[rec.action_type] || rec.action_type}
              </span>
            </div>
            
            <div class="space-y-1 text-sm">
              ${rec.price_target ? `
                <div class="flex justify-between">
                  <span class="text-gray-400">Pre√ßo alvo:</span>
                  <span class="text-green-400">R$ ${rec.price_target.toFixed(2)}</span>
                </div>
              ` : ''}
              
              ${rec.current_price ? `
                <div class="flex justify-between">
                  <span class="text-gray-400">Pre√ßo atual:</span>
                  <span class="text-white">R$ ${rec.current_price.toFixed(2)}</span>
                </div>
              ` : ''}
              
              ${rec.target_weight ? `
                <div class="flex justify-between">
                  <span class="text-gray-400">Peso sugerido:</span>
                  <span class="text-geminii">${rec.target_weight}%</span>
                </div>
              ` : ''}
            </div>
            
            ${rec.reason ? `
              <div class="mt-3 p-3 bg-gray-600 bg-opacity-30 rounded">
                <p class="text-xs text-gray-300">${rec.reason}</p>
              </div>
            ` : ''}
            
            <div class="mt-2 text-xs text-gray-500">
              Recomenda√ß√£o de ${formatDate(rec.recommendation_date)}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    // ===== HELPER FUNCTIONS =====
    function formatDateTime(dateString) {
      if (!dateString) return 'N/A';
      return new Date(dateString).toLocaleString('pt-BR');
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      return new Date(dateString).toLocaleDateString('pt-BR');
    }

    // ===== TOAST NOTIFICATIONS =====
    function showToast(message, type = 'info') {
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-yellow-500'
      };
      
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300`;
      toast.textContent = message;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }

    // ===== FECHAR MODAL =====
    function closeAnalyticsModal() {
      const modal = document.getElementById('analyticsModal');
      if (modal) {
        modal.classList.add('hidden');
        currentPortfolioName = null;
        // Destruir gr√°fico ao fechar
        if (window.performanceChartInstance) {
          window.performanceChartInstance.destroy();
          window.performanceChartInstance = null;
        }
      }
    }

    // ===== ESTADOS DA UI =====
    function showLoading() {
      const container = document.getElementById('portfoliosContainer');
      if (container) {
        container.innerHTML = `
          <div class="card rounded-2xl p-8 fade-in">
            <div class="text-center py-12">
              <div class="spinner mx-auto mb-4"></div>
              <p class="text-gray-300">Carregando suas carteiras...</p>
            </div>
          </div>
        `;
      }
    }

    function showNoData() {
      const container = document.getElementById('portfoliosContainer');
      if (container) {
        container.innerHTML = `
          <div class="card rounded-2xl p-8 fade-in">
            <div class="text-center py-12">
              <i class="fas fa-inbox text-5xl text-gray-400 mb-4"></i>
              <h3 class="text-xl font-bold mb-2 text-gray-300">Nenhuma carteira dispon√≠vel</h3>
              <p class="text-gray-400 mb-4">Voc√™ ainda n√£o tem acesso a nenhuma carteira. Entre em contato com o administrador para solicitar acesso.</p>
              <div class="flex justify-center space-x-4">
                <a href="/planos.html" class="bg-gradient-to-r from-primary to-secondary hover:from-primary/90 hover:to-secondary/90 px-6 py-2 rounded-lg text-white font-medium">
                  <i class="fas fa-crown mr-2"></i>
                  Fazer Upgrade
                </a>
                <button onclick="loadPortfolioData()" class="bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded-lg text-white">
                  <i class="fas fa-refresh mr-1"></i>
                  Atualizar
                </button>
              </div>
            </div>
          </div>
        `;
      }
    }

    function showError(message) {
      const container = document.getElementById('portfoliosContainer');
      if (container) {
        container.innerHTML = `
          <div class="card rounded-2xl p-8 fade-in">
            <div class="text-center py-12">
              <i class="fas fa-exclamation-triangle text-5xl text-danger mb-4"></i>
              <h3 class="text-xl font-bold mb-2 text-red-400">Erro ao carregar dados</h3>
              <p class="text-gray-400 mb-4">${message}</p>
              <button onclick="loadPortfolioData()" class="bg-primary hover:bg-secondary px-6 py-2 rounded-lg text-white">
                <i class="fas fa-refresh mr-1"></i>
                Tentar Novamente
              </button>
            </div>
          </div>
        `;
      }
    }

    function showAnalyticsError(message) {
      const modalContent = document.getElementById('modalContent');
      modalContent.innerHTML = `
        <div class="text-center py-12">
          <i class="fas fa-exclamation-triangle text-5xl text-red-400 mb-4"></i>
          <h3 class="text-xl font-bold mb-2 text-red-400">Erro ao Carregar Analytics</h3>
          <p class="text-gray-400 mb-4">${message}</p>
          <div class="space-x-4">
            <button onclick="closeAnalyticsModal()" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg text-white">
              Fechar
            </button>
            <button onclick="refreshCurrentPortfolio()" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg text-white">
              <i class="fas fa-sync-alt mr-1"></i>
              Tentar Novamente
            </button>
          </div>
        </div>
      `;
    }

    // ===== EVENT LISTENERS =====
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeAnalyticsModal();
      }
    });

    // Fechar modal clicando fora
    document.getElementById('analyticsModal').addEventListener('click', (e) => {
      if (e.target.id === 'analyticsModal') {
        closeAnalyticsModal();
      }
    });

    // ===== FUN√á√ÉO GLOBAL PARA REFRESH =====
    window.refreshAnalyses = function() {
      console.log('üîÑ Atualizando an√°lises...');
      loadPortfolioData();
    };

  </script>
</body>
</html>