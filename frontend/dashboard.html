<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#000000',
            light: '#ffffff',
            subtle: 'rgba(255,255,255,0.1)',
            geminii: '#ba39af'
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      overflow-x: hidden;
    }
    
    .dashboard-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px) brightness(0.9);
      -webkit-backdrop-filter: blur(20px) brightness(0.9);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .dashboard-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 20px 40px rgba(186, 57, 175, 0.15);
      border-color: rgba(186, 57, 175, 0.3);
    }
    
    .stat-card {
      background: linear-gradient(135deg, rgba(186, 57, 175, 0.1), rgba(217, 70, 239, 0.05));
      border: 1px solid rgba(186, 57, 175, 0.2);
    }
    
    .stat-card.green {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05));
      border-color: rgba(16, 185, 129, 0.2);
    }
    
    .stat-card.yellow {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.05));
      border-color: rgba(245, 158, 11, 0.2);
    }
    
    .stat-card.red {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05));
      border-color: rgba(239, 68, 68, 0.2);
    }
    
    .quick-action-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }
    
    .quick-action-btn:hover {
      background: rgba(186, 57, 175, 0.2);
      border-color: rgba(186, 57, 175, 0.4);
      transform: translateY(-2px);
    }
    
    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ba39af, #d946ef);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 24px;
      margin: 0 auto;
    }
    
    .plan-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .plan-badge.free {
      background: rgba(107, 114, 128, 0.2);
      color: #9ca3af;
      border: 1px solid rgba(107, 114, 128, 0.3);
    }
    
    .plan-badge.premium {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    .plan-badge.strategic {
      background: rgba(139, 92, 246, 0.2);
      color: #8b5cf6;
      border: 1px solid rgba(139, 92, 246, 0.3);
    }
    
    .progress-bar {
      background: rgba(255, 255, 255, 0.1);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      background: linear-gradient(90deg, #ba39af, #d946ef);
      height: 100%;
      transition: width 0.3s ease;
    }
    
    .alert-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
    }
    
    .alert-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #3b82f6;
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .spinner {
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 2px solid #ba39af;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Estilos para recomenda√ß√µes */
    .recommendation-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      transition: all 0.3s ease;
    }
    
    .recommendation-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(186, 57, 175, 0.3);
      transform: translateY(-2px);
    }
    
    .recommendation-badge {
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }
    
    .recommendation-badge.compra {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }
    
    .recommendation-badge.compra-forte {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    .recommendation-badge.venda {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }
    
    .recommendation-badge.manter {
      background: rgba(107, 114, 128, 0.2);
      color: #9ca3af;
      border: 1px solid rgba(107, 114, 128, 0.3);
    }
    
    .recommendation-badge.indisponivel {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .performance-positive {
      color: #22c55e;
    }
    
    .performance-negative {
      color: #ef4444;
    }
    
    .performance-neutral {
      color: #9ca3af;
    }

    .floating-element:nth-child(1) {
      width: 200px;
      height: 200px;
      top: 10%;
      left: 5%;
      animation-delay: 0s;
    }

    .floating-element:nth-child(2) {
      width: 150px;
      height: 150px;
      top: 60%;
      right: 10%;
      animation-delay: 5s;
    }

    .floating-element:nth-child(3) {
      width: 100px;
      height: 100px;
      bottom: 20%;
      left: 20%;
      animation-delay: 2s;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-40px) rotate(180deg); }
    }
  </style>
</head>
<body class="bg-black text-white">
  <div class="relative min-h-screen">
    <!-- Glass floating navbar -->
    <nav class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-opacity-5 border-opacity-10 bg-white border-white border rounded-full pt-4 pr-4 pb-4 pl-4 shadow-xl backdrop-blur-md">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <img src="https://app.geminii.com.br/wp-content/uploads/2025/06/logo.png" alt="Geminii Logo" class="w-6 h-6 cursor-pointer" onclick="window.location.href='/home.html'">
        </div>
        <div class="hidden md:flex items-center space-x-6 text-xs text-gray-300 ml-8">
          <a href="/home.html" class="hover:text-white transition-colors">Home</a>
         </div>
        <div class="flex items-center space-x-3 ml-8">
          <div id="apiStatus" class="w-8 h-8 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-full flex items-center justify-center relative">
            <i class="fas fa-shield-alt text-green-500 text-xs"></i>
            <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
          </div>
          <button onclick="logout()" class="hover:bg-red-200 transition-colors text-xs font-medium text-black bg-red-100 rounded-full pt-1.5 pr-3 pb-1.5 pl-3">Sair</button>
        </div>
      </div>
    </nav>
    
    <!-- Content -->
    <div class="relative z-10 pt-32 pb-16">
      <div class="max-w-7xl mx-auto px-6">
        
        <!-- Welcome Alert -->
        <div id="welcomeAlert" class="alert-success p-4 rounded-lg mb-8 backdrop-blur-sm">
          <div class="flex items-center gap-3">
            <i class="fas fa-check-circle text-xl"></i>
            <div>
              <h4 class="font-semibold">Bem-vindo √† sua conta Geminii!</h4>
              <p class="text-sm opacity-90">Suas recomenda√ß√µes personalizadas est√£o prontas abaixo.</p>
            </div>
          </div>
        </div>

        <!-- Header with User Info -->
        <div class="dashboard-card p-8 mb-8">
          <div class="flex flex-col md:flex-row items-center gap-6">
            <div class="user-avatar" id="userAvatar">
              <span id="userInitials">U</span>
            </div>
            
            <div class="text-center md:text-left flex-1">
              <h1 class="text-3xl md:text-4xl font-bold mb-2">
                Ol√°, <span class="text-geminii" id="userName">Usu√°rio</span>!
              </h1>
              <p class="text-gray-300 mb-4" id="userEmail">email@example.com</p>
              
              <div class="flex flex-col sm:flex-row items-center gap-4">
                <div class="flex items-center gap-3">
                  <span class="text-gray-400">Plano Atual:</span>
                  <span id="userPlanBadge" class="plan-badge free">B√°sico</span>
                </div>
                
                <div class="text-sm text-gray-400">
                  <i class="fas fa-calendar-alt mr-1"></i>
                  Membro desde: <span id="memberSince">Hoje</span>
                </div>
              </div>
            </div>
            
            <div class="flex flex-col gap-3">
              <a href="planos.html" class="quick-action-btn px-6 py-3 rounded-lg text-center transition-all">
                <i class="fas fa-crown mr-2"></i>
                Fazer Upgrade
              </a>
              <a href="conta.html" class="quick-action-btn px-6 py-3 rounded-lg text-center transition-all">
                <i class="fas fa-user-cog mr-2"></i>
                Configura√ß√µes
              </a>
            </div>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="dashboard-card stat-card p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="text-2xl">üìä</div>
              <div class="text-right">
                <div class="text-2xl font-bold text-white" id="totalAnalysis">0</div>
                <div class="text-sm text-gray-400">Recomenda√ß√µes Ativas</div>
              </div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 0%" id="analysisProgress"></div>
            </div>
          </div>
          
          <div class="dashboard-card stat-card green p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="text-2xl">üî•</div>
              <div class="text-right">
                <div class="text-2xl font-bold text-green-400" id="comprasCount">0</div>
                <div class="text-sm text-gray-400">Sinais de Compra</div>
              </div>
            </div>
            <div class="text-xs text-green-400">
              <i class="fas fa-arrow-up mr-1"></i>
              <span id="comprasText">Oportunidades identificadas</span>
            </div>
          </div>
          
          <div class="dashboard-card stat-card yellow p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="text-2xl">üìà</div>
              <div class="text-right">
                <div class="text-2xl font-bold text-yellow-400" id="portfolioPerformance">0%</div>
                <div class="text-sm text-gray-400">Performance M√©dia</div>
              </div>
            </div>
            <div class="text-xs text-yellow-400">
              <i class="fas fa-chart-line mr-1"></i>
              <span id="performanceText">Desde entrada</span>
            </div>
          </div>
          
          <div class="dashboard-card stat-card red p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="text-2xl">‚è∞</div>
              <div class="text-right">
                <div class="text-2xl font-bold text-red-400" id="lastUpdate">Agora</div>
                <div class="text-sm text-gray-400">√öltima Atualiza√ß√£o</div>
              </div>
            </div>
            <div class="text-xs text-red-400" id="updateInfo">
              <i class="fas fa-sync mr-1"></i>
              <span>Dados em tempo real</span>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="dashboard-card p-6 mb-8">
          <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
            <i class="fas fa-bolt text-geminii"></i>
            A√ß√µes R√°pidas
          </h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <a href="/monitor-basico.html" class="quick-action-btn p-4 rounded-lg block">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-green-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <i class="fas fa-chart-line text-green-500"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-white">Monitor Beta</h3>
                  <p class="text-xs text-gray-400">An√°lise de risco vs IBOVESPA</p>
                </div>
              </div>
            </a>
            
            <div onclick="showPremiumFeature('Long & Short')" class="quick-action-btn p-4 rounded-lg block cursor-pointer relative">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-purple-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <i class="fas fa-exchange-alt text-purple-500"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-white">Long & Short</h3>
                  <p class="text-xs text-gray-400">An√°lise de Cointegra√ß√£o</p>
                </div>
              </div>
              <div class="absolute top-2 right-2 text-xs bg-yellow-500 text-black px-2 py-1 rounded-full font-bold">
                PRO
              </div>
            </div>
            
            <a href="/relatorios.html" class="quick-action-btn p-4 rounded-lg block border-2 border-purple-500">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-purple-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <i class="fas fa-file-chart-line text-purple-500"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-purple-400">Relat√≥rios Premium</h3>
                  <p class="text-xs text-gray-400">An√°lises do Diego Doneda</p>
                </div>
              </div>
              <div class="absolute top-2 right-2 text-xs bg-purple-500 text-white px-2 py-1 rounded-full font-bold">
                ANALISTA
              </div>
            </a>

            <div onclick="showPremiumFeature('RSL')" class="quick-action-btn p-4 rounded-lg block cursor-pointer relative">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-purple-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <i class="fas fa-robot text-purple-500"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-white">RSL Premium</h3>
                  <p class="text-xs text-gray-400">Indicadores avan√ßados</p>
                </div>
              </div>
              <div class="absolute top-2 right-2 text-xs bg-yellow-500 text-black px-2 py-1 rounded-full font-bold">
                PRO
              </div>
            </div>
            
            <div onclick="showPremiumFeature('Backtests')" class="quick-action-btn p-4 rounded-lg block cursor-pointer relative">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-orange-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <i class="fas fa-history text-orange-500"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-white">Backtests</h3>
                  <p class="text-xs text-gray-400">Simula√ß√£o de estrat√©gias</p>
                </div>
              </div>
              <div class="absolute top-2 right-2 text-xs bg-yellow-500 text-black px-2 py-1 rounded-full font-bold">
                PRO
              </div>
            </div>
            
            <div onclick="showPremiumFeature('IA')" class="quick-action-btn p-4 rounded-lg block cursor-pointer relative">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-pink-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <i class="fas fa-brain text-pink-500"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-white">IA Estrat√©gica</h3>
                  <p class="text-xs text-gray-400">Recomenda√ß√µes inteligentes</p>
                </div>
              </div>
              <div class="absolute top-2 right-2 text-xs bg-purple-500 text-white px-2 py-1 rounded-full font-bold">
                PREMIUM+
              </div>
            </div>
            
            <a href="planos.html" class="quick-action-btn p-4 rounded-lg block border-2 border-geminii">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-geminii bg-opacity-20 rounded-lg flex items-center justify-center">
                  <i class="fas fa-crown text-geminii"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-geminii">Fazer Upgrade</h3>
                  <p class="text-xs text-gray-400">Desbloqueie todos os recursos</p>
                </div>
              </div>
            </a>
          </div>
        </div>

        <!-- Recomenda√ß√µes Section -->
        <div class="dashboard-card p-6 mb-8">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-white flex items-center gap-2">
              <i class="fas fa-lightbulb text-geminii"></i>
              Recomenda√ß√µes da Carteira BDR
            </h2>
            <div class="flex items-center gap-3">
              <button onclick="refreshRecommendations()" class="text-sm text-gray-400 hover:text-white transition-colors">
                <i class="fas fa-sync-alt mr-1" id="refreshIcon"></i>
                Atualizar
              </button>
              <div class="text-xs text-gray-400" id="dataSource">
                Dados: DB + Yahoo Finance
              </div>
            </div>
          </div>
          
          <!-- Loading State -->
          <div id="recommendationsLoading" class="flex items-center justify-center py-12">
            <div class="spinner mr-3"></div>
            <span class="text-gray-400">Carregando recomenda√ß√µes...</span>
          </div>
          
          <!-- Error State -->
          <div id="recommendationsError" class="hidden bg-red-500 bg-opacity-10 border border-red-500 border-opacity-30 rounded-lg p-4">
            <div class="flex items-center gap-3">
              <i class="fas fa-exclamation-triangle text-red-500"></i>
              <div>
                <h4 class="font-semibold text-red-400">Erro ao carregar recomenda√ß√µes</h4>
                <p class="text-sm text-red-300" id="errorMessage">Falha na conex√£o com o servidor</p>
              </div>
            </div>
          </div>
          
          <!-- Recommendations Grid -->
          <div id="recommendationsContainer" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="recommendationsGrid">
              <!-- Recommendations will be loaded here -->
            </div>
            
            <!-- Portfolio Statistics -->
            <div class="mt-6 pt-6 border-t border-gray-700">
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                  <div class="text-2xl font-bold text-white" id="totalStocks">0</div>
                  <div class="text-xs text-gray-400">Total de A√ß√µes</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-blue-400" id="buySignals">0</div>
                  <div class="text-xs text-gray-400">Sinais Compra</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-green-400" id="sellSignals">0</div>
                  <div class="text-xs text-gray-400">Sinais Venda</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-yellow-400" id="avgPerformance">0%</div>
                  <div class="text-xs text-gray-400">Performance M√©dia</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let userToken = null;
    let dashboardData = null;

    // Check authentication and load user data
    async function checkAuth() {
      const token = localStorage.getItem('geminii_token');
      const userData = localStorage.getItem('geminii_user');

      if (!token || !userData) {
        window.location.href = '/login.html';
        return;
      }

      try {
        const response = await fetch('/api/auth/verify', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const result = await response.json();

        if (result.success) {
          userToken = token;
          currentUser = result.data.user;
          updateUserInterface(currentUser);
          loadDashboardData();
        } else {
          localStorage.removeItem('geminii_token');
          localStorage.removeItem('geminii_user');
          window.location.href = '/login.html';
        }

      } catch (error) {
        console.error('Auth check failed:', error);
        localStorage.removeItem('geminii_token');
        localStorage.removeItem('geminii_user');
        window.location.href = '/login.html';
      }
    }

    // Update user interface with user data
    function updateUserInterface(user) {
      // User info
      const initials = user.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
      document.getElementById('userInitials').textContent = initials;
      document.getElementById('userName').textContent = user.name;
      document.getElementById('userEmail').textContent = user.email;

      // Plan badge
      const planBadge = document.getElementById('userPlanBadge');
      const planId = user.plan_id || 1;
      
      if (planId === 1) {
        planBadge.textContent = 'B√°sico';
        planBadge.className = 'plan-badge free';
      } else if (planId === 2) {
        planBadge.textContent = 'Premium';
        planBadge.className = 'plan-badge premium';
      } else if (planId >= 3) {
        planBadge.textContent = 'Estrat√©gico';
        planBadge.className = 'plan-badge strategic';
      }

      console.log('‚úÖ Dashboard carregado para:', user.name, '- Plano:', user.plan_name);
    }

    // Load dashboard data with recommendations
    async function loadDashboardData() {
      try {
        showLoading();
        
        const response = await fetch('/api/dashboard/recommendations?portfolio=carteira_bdr&limit=8', {
          headers: {
            'Authorization': `Bearer ${userToken}`
          }
        });

        const result = await response.json();

        if (result.success) {
          dashboardData = result.data;
          console.log('üìä Dados do dashboard:', dashboardData);
          
          updateDashboardStats(dashboardData);
          displayRecommendations(dashboardData.recommendations);
          hideLoading();
          
        } else {
          showError(result.error || 'Erro ao carregar dados');
        }

      } catch (error) {
        console.error('Failed to load dashboard data:', error);
        showError('Falha na conex√£o com servidor');
      }
    }

    // Update dashboard statistics
    function updateDashboardStats(data) {
      const recommendations = data.recommendations;
      const stats = recommendations.statistics;
      
      // Update main stats
      document.getElementById('totalAnalysis').textContent = stats.total_stocks;
      document.getElementById('comprasCount').textContent = stats.signals.compras;
      document.getElementById('portfolioPerformance').textContent = stats.avg_performance + '%';
      document.getElementById('lastUpdate').textContent = recommendations.last_update.split(' ')[1]; // Only time
      
      // Update progress bar based on performance
      const performanceProgress = Math.min(Math.max((stats.avg_performance + 10) * 5, 0), 100);
      document.getElementById('analysisProgress').style.width = performanceProgress + '%';
      
      // Update text descriptions
      document.getElementById('comprasText').textContent = 
        stats.signals.compras > 0 ? `${stats.signals.compras} oportunidades` : 'Sem sinais';
      
      const perfClass = stats.avg_performance >= 0 ? 'performance-positive' : 'performance-negative';
      document.getElementById('portfolioPerformance').className = `text-2xl font-bold ${perfClass}`;
      
      document.getElementById('performanceText').textContent = 
        stats.avg_performance >= 0 ? 'Performance positiva' : 'Performance negativa';
      
      // Update portfolio statistics
      document.getElementById('totalStocks').textContent = stats.total_stocks;
      document.getElementById('buySignals').textContent = stats.signals.compras;
      document.getElementById('sellSignals').textContent = stats.signals.vendas;
      document.getElementById('avgPerformance').textContent = stats.avg_performance + '%';
    }

    // Display recommendations
    function displayRecommendations(recommendationsData) {
      const container = document.getElementById('recommendationsGrid');
      const recommendations = recommendationsData.recommendations;
      
      if (!recommendations || recommendations.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center py-8">
            <i class="fas fa-inbox text-4xl text-gray-600 mb-4"></i>
            <p class="text-gray-400">Nenhuma recomenda√ß√£o dispon√≠vel</p>
          </div>
        `;
        return;
      }

      container.innerHTML = recommendations.map(rec => {
        const badgeClass = getBadgeClass(rec.recomendacao);
        const performanceClass = rec.performance.valor >= 0 ? 'performance-positive' : 'performance-negative';
        
        return `
          <div class="recommendation-card p-4">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2">
                <span class="text-lg">${rec.icone}</span>
                <div>
                  <h3 class="font-bold text-white">${rec.ticker}</h3>
                  <p class="text-xs text-gray-400">${rec.setor}</p>
                </div>
              </div>
              <span class="recommendation-badge ${badgeClass}">${rec.recomendacao}</span>
            </div>
            
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-400">Entrada:</span>
                <span class="text-white">R$ ${rec.entrada.preco.toFixed(2)}</span>
              </div>
              
              <div class="flex justify-between">
                <span class="text-gray-400">Atual:</span>
                <span class="text-white">R$ ${rec.atual.preco.toFixed(2)}</span>
              </div>
              
              <div class="flex justify-between">
                <span class="text-gray-400">Performance:</span>
                <span class="${performanceClass} font-semibold">
                  ${rec.performance.valor >= 0 ? '+' : ''}${rec.performance.valor.toFixed(2)}%
                </span>
              </div>
              
              <div class="flex justify-between">
                <span class="text-gray-400">Per√≠odo:</span>
                <span class="text-white">${rec.performance.dias} dias</span>
              </div>
              
              ${rec.fundamentals.sharpe ? `
                <div class="flex justify-between">
                  <span class="text-gray-400">Sharpe:</span>
                  <span class="text-white">${rec.fundamentals.sharpe.toFixed(2)}</span>
                </div>
              ` : ''}
            </div>
            
            <div class="mt-3 pt-3 border-t border-gray-700">
              <div class="flex justify-between text-xs text-gray-400">
                <span>Peso: ${rec.entrada.peso_percent.toFixed(1)}%</span>
                <span>Data: ${rec.entrada.data}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Get badge class based on recommendation type
    function getBadgeClass(recomendacao) {
      const recLower = recomendacao.toLowerCase();
      
      if (recLower.includes('compra forte')) return 'compra-forte';
      if (recLower.includes('compra')) return 'compra';
      if (recLower.includes('venda')) return 'venda';
      if (recLower.includes('manter')) return 'manter';
      return 'indisponivel';
    }

    // Show loading state
    function showLoading() {
      document.getElementById('recommendationsLoading').classList.remove('hidden');
      document.getElementById('recommendationsContainer').classList.add('hidden');
      document.getElementById('recommendationsError').classList.add('hidden');
    }

    // Hide loading state
    function hideLoading() {
      document.getElementById('recommendationsLoading').classList.add('hidden');
      document.getElementById('recommendationsContainer').classList.remove('hidden');
    }

    // Show error state
    function showError(message) {
      document.getElementById('recommendationsLoading').classList.add('hidden');
      document.getElementById('recommendationsContainer').classList.add('hidden');
      document.getElementById('recommendationsError').classList.remove('hidden');
      document.getElementById('errorMessage').textContent = message;
    }

    // Refresh recommendations
    async function refreshRecommendations() {
      const refreshIcon = document.getElementById('refreshIcon');
      refreshIcon.classList.add('fa-spin');
      
      try {
        await loadDashboardData();
      } catch (error) {
        console.error('Error refreshing:', error);
      } finally {
        setTimeout(() => {
          refreshIcon.classList.remove('fa-spin');
        }, 1000);
      }
    }

    // Show premium feature dialog
    function showPremiumFeature(featureName) {
      if (!currentUser) return;
    
      const userPlanId = currentUser.plan_id || 1;
      let requiredPlan = 2; // Premium by default
      
      if (featureName === 'IA') {
        requiredPlan = 3; // Strategic
      }
    
      if (featureName === 'Long & Short') {
        if (userPlanId >= 2) {
          // Usu√°rio tem plano Premium ou superior - redirecionar
          window.location.href = 'long-short.html';
          return;
        }
      }
    
      if (userPlanId >= requiredPlan) {
        // Para outras funcionalidades que ainda n√£o existem
        if (featureName !== 'Long & Short') {
          alert(`üéâ ${featureName}\n\nFuncionalidade dispon√≠vel em seu plano!\nEm breve ser√° implementada.`);
        }
      } else {
        const planNames = { 1: 'B√°sico', 2: 'Premium', 3: 'Estrat√©gico' };
        const message = `üíé Recurso ${requiredPlan >= 3 ? 'Premium+' : 'Premium'}\n\n${featureName} est√° dispon√≠vel apenas para planos ${planNames[requiredPlan]} ou superior.\n\nSeu plano atual: ${currentUser.plan_name}\nPlano necess√°rio: ${planNames[requiredPlan]}\n\nDeseja fazer upgrade agora?`;
        
        if (confirm(message)) {
          window.location.href = '/planos.html';
        }
      }
    }

    // Logout function
    async function logout() {
      try {
        if (userToken) {
          await fetch('/api/auth/logout', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${userToken}`
            }
          });
        }
      } catch (error) {
        console.error('Logout error:', error);
      } finally {
        localStorage.removeItem('geminii_token');
        localStorage.removeItem('geminii_user');
        window.location.href = '/';
      }
    }

    // Check API status
    async function checkApiStatus() {
      try {
        const response = await fetch('/api/status');
        const data = await response.json();
        
        if (data.status === 'online') {
          document.getElementById('apiStatus').innerHTML = `
            <i class="fas fa-shield-alt text-green-500 text-xs"></i>
            <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
          `;
        }
      } catch (error) {
        document.getElementById('apiStatus').innerHTML = `
          <i class="fas fa-shield-alt text-red-500 text-xs"></i>
          <div class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
        `;
      }
    }

    // Hide welcome alert after some time
    function hideWelcomeAlert() {
      setTimeout(() => {
        const alert = document.getElementById('welcomeAlert');
        if (alert) {
          alert.style.opacity = '0';
          alert.style.transform = 'translateY(-20px)';
          setTimeout(() => {
            alert.style.display = 'none';
          }, 300);
        }
      }, 5000); // Hide after 5 seconds
    }

    // Initialize dashboard
    async function initDashboard() {
      console.log('üöÄ Inicializando Dashboard com Recomenda√ß√µes...');
      
      // Check authentication first
      await checkAuth();
      
      // Check API status
      checkApiStatus();
      setInterval(checkApiStatus, 30000);
      
      // Hide welcome alert after delay
      hideWelcomeAlert();
      
      console.log('‚úÖ Dashboard inicializado com sucesso!');
    }

    // Make functions global
    window.logout = logout;
    window.showPremiumFeature = showPremiumFeature;
    window.refreshRecommendations = refreshRecommendations;

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initDashboard);

    // Handle page visibility change to refresh data
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden && dashboardData) {
        refreshRecommendations();
        checkApiStatus();
      }
    });

    // Auto-refresh recommendations every 5 minutes
    setInterval(() => {
      if (!document.hidden && dashboardData) {
        refreshRecommendations();
      }
    }, 5 * 60 * 1000);
  </script>
</body>
</html>