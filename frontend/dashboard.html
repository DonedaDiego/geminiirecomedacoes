<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#000000',
            light: '#ffffff',
            subtle: 'rgba(255,255,255,0.1)',
            geminii: '#ba39af'
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      overflow-x: hidden;
    }
    
    .dashboard-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px) brightness(0.9);
      -webkit-backdrop-filter: blur(20px) brightness(0.9);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .dashboard-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 20px 40px rgba(186, 57, 175, 0.15);
      border-color: rgba(186, 57, 175, 0.3);
    }
    
    .stat-card {
      background: linear-gradient(135deg, rgba(186, 57, 175, 0.1), rgba(217, 70, 239, 0.05));
      border: 1px solid rgba(186, 57, 175, 0.2);
    }
    
    .stat-card.green {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05));
      border-color: rgba(16, 185, 129, 0.2);
    }
    
    .stat-card.yellow {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.05));
      border-color: rgba(245, 158, 11, 0.2);
    }
    
    .stat-card.red {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05));
      border-color: rgba(239, 68, 68, 0.2);
    }
    
    .quick-action-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }
    
    .quick-action-btn:hover {
      background: rgba(186, 57, 175, 0.2);
      border-color: rgba(186, 57, 175, 0.4);
      transform: translateY(-2px);
    }
    
    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ba39af, #d946ef);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 24px;
      margin: 0 auto;
    }
    
    .plan-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .plan-badge.free {
      background: rgba(107, 114, 128, 0.2);
      color: #9ca3af;
      border: 1px solid rgba(107, 114, 128, 0.3);
    }
    
    .plan-badge.premium {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    .plan-badge.strategic {
      background: rgba(139, 92, 246, 0.2);
      color: #8b5cf6;
      border: 1px solid rgba(139, 92, 246, 0.3);
    }
    
    .progress-bar {
      background: rgba(255, 255, 255, 0.1);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      background: linear-gradient(90deg, #ba39af, #d946ef);
      height: 100%;
      transition: width 0.3s ease;
    }
    
    .alert-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
    }
    
    .alert-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #3b82f6;
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .spinner {
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 2px solid #ba39af;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .floating-elements {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
    }

    .floating-element {
      position: absolute;
      background: linear-gradient(135deg, rgba(186, 57, 175, 0.1), rgba(217, 70, 239, 0.1));
      border-radius: 50%;
      animation: float 10s ease-in-out infinite;
    }

    .floating-element:nth-child(1) {
      width: 200px;
      height: 200px;
      top: 10%;
      left: 5%;
      animation-delay: 0s;
    }

    .floating-element:nth-child(2) {
      width: 150px;
      height: 150px;
      top: 60%;
      right: 10%;
      animation-delay: 5s;
    }

    .floating-element:nth-child(3) {
      width: 100px;
      height: 100px;
      bottom: 20%;
      left: 20%;
      animation-delay: 2s;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-40px) rotate(180deg); }
    }
  </style>
</head>
<body class="bg-black text-white">
  <div class="relative min-h-screen">
    <!-- Spline 3D background -->
    <div class="fixed inset-0 z-0">
      <iframe src="https://my.spline.design/thresholddarkambientui-v0gkZCfi6zXm69kE0wccy70f/" frameborder="0" width="100%" height="100%" class="w-full h-full"></iframe>
    </div>
    
    <!-- Floating elements -->
    <div class="floating-elements">
      <div class="floating-element"></div>
      <div class="floating-element"></div>
      <div class="floating-element"></div>
    </div>
    
    <!-- Glass floating navbar -->
    <nav class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-opacity-5 border-opacity-10 bg-white border-white border rounded-full pt-4 pr-4 pb-4 pl-4 shadow-xl backdrop-blur-md">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <img src="https://app.geminii.com.br/wp-content/uploads/2025/06/logo.png" alt="Geminii Logo" class="w-6 h-6 cursor-pointer" onclick="window.location.href='/home.html'">
        </div>
        <div class="hidden md:flex items-center space-x-6 text-xs text-gray-300 ml-8">
          <a href="/home.html" class="hover:text-white transition-colors">Home</a>
          <a href="/monitor-basico.html" class="hover:text-white transition-colors">Scanner</a>
          <a href="/radar-setores.html" class="hover:text-white transition-colors">Radar de Setores</a>
          <a href="/planos.html" class="hover:text-white transition-colors">Planos</a>
          <a href="/relatorios.html" class="hover:text-white transition-colors">Relatórios</a>
          <span class="text-white font-medium">Dashboard</span>
          <a href="/conta.html" class="hover:text-white transition-colors">Conta</a>
        </div>
        <div class="flex items-center space-x-3 ml-8">
          <div id="apiStatus" class="w-8 h-8 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-full flex items-center justify-center relative">
            <i class="fas fa-shield-alt text-green-500 text-xs"></i>
            <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
          </div>
          <button onclick="logout()" class="hover:bg-red-200 transition-colors text-xs font-medium text-black bg-red-100 rounded-full pt-1.5 pr-3 pb-1.5 pl-3">Sair</button>
        </div>
      </div>
    </nav>
    
    <!-- Content -->
    <div class="relative z-10 pt-32 pb-16">
      <div class="max-w-7xl mx-auto px-6">
        
        <!-- Welcome Alert -->
        <div id="welcomeAlert" class="alert-success p-4 rounded-lg mb-8 backdrop-blur-sm">
          <div class="flex items-center gap-3">
            <i class="fas fa-check-circle text-xl"></i>
            <div>
              <h4 class="font-semibold">Bem-vindo à sua conta Geminii!</h4>
              <p class="text-sm opacity-90">Sua conta foi criada com sucesso. Explore nossos recursos abaixo.</p>
            </div>
          </div>
        </div>

        <!-- Header with User Info -->
        <div class="dashboard-card p-8 mb-8">
          <div class="flex flex-col md:flex-row items-center gap-6">
            <div class="user-avatar" id="userAvatar">
              <span id="userInitials">U</span>
            </div>
            
            <div class="text-center md:text-left flex-1">
              <h1 class="text-3xl md:text-4xl font-bold mb-2">
                Olá, <span class="text-geminii" id="userName">Usuário</span>!
              </h1>
              <p class="text-gray-300 mb-4" id="userEmail">email@example.com</p>
              
              <div class="flex flex-col sm:flex-row items-center gap-4">
                <div class="flex items-center gap-3">
                  <span class="text-gray-400">Plano Atual:</span>
                  <span id="userPlanBadge" class="plan-badge free">Básico</span>
                </div>
                
                <div class="text-sm text-gray-400">
                  <i class="fas fa-calendar-alt mr-1"></i>
                  Membro desde: <span id="memberSince">Hoje</span>
                </div>
              </div>
            </div>
            
            <div class="flex flex-col gap-3">
              <a href="/planos.html" class="quick-action-btn px-6 py-3 rounded-lg text-center transition-all">
                <i class="fas fa-crown mr-2"></i>
                Fazer Upgrade
              </a>
              <a href="/conta.html" class="quick-action-btn px-6 py-3 rounded-lg text-center transition-all">
                <i class="fas fa-user-cog mr-2"></i>
                Configurações
              </a>
            </div>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="dashboard-card stat-card p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="text-2xl">📊</div>
              <div class="text-right">
                <div class="text-2xl font-bold text-white" id="totalAnalysis">0</div>
                <div class="text-sm text-gray-400">Análises Realizadas</div>
              </div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 0%" id="analysisProgress"></div>
            </div>
          </div>
          
          <div class="dashboard-card stat-card green p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="text-2xl">⚡</div>
              <div class="text-right">
                <div class="text-2xl font-bold text-green-400" id="activeAlerts">0</div>
                <div class="text-sm text-gray-400">Alertas Ativos</div>
              </div>
            </div>
            <div class="text-xs text-green-400">
              <i class="fas fa-arrow-up mr-1"></i>
              Sistema monitorando
            </div>
          </div>
          
          <div class="dashboard-card stat-card yellow p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="text-2xl">🎯</div>
              <div class="text-right">
                <div class="text-2xl font-bold text-yellow-400" id="watchlistItems">3</div>
                <div class="text-sm text-gray-400">Ativos na Watchlist</div>
              </div>
            </div>
            <div class="text-xs text-yellow-400">
              <i class="fas fa-eye mr-1"></i>
              PETR4, VALE3, ITUB4
            </div>
          </div>
          
          <div class="dashboard-card stat-card red p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="text-2xl">🚀</div>
              <div class="text-right">
                <div class="text-2xl font-bold text-red-400">7</div>
                <div class="text-sm text-gray-400">Dias Restantes</div>
              </div>
            </div>
            <div class="text-xs text-red-400" id="trialInfo">
              <i class="fas fa-clock mr-1"></i>
              Trial Premium
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="dashboard-card p-6 mb-8">
          <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
            <i class="fas fa-bolt text-geminii"></i>
            Ações Rápidas
          </h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <a href="/monitor-basico.html" class="quick-action-btn p-4 rounded-lg block">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-green-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <i class="fas fa-chart-line text-green-500"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-white">Monitor Básico</h3>
                  <p class="text-xs text-gray-400">Análise técnica essencial</p>
                </div>
              </div>
            </a>
            
            <a href="/radar-setores.html" class="quick-action-btn p-4 rounded-lg block">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <i class="fas fa-industry text-blue-500"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-white">Radar de Setores</h3>
                  <p class="text-xs text-gray-400">Mapeamento por RSL</p>
                </div>
              </div>
            </a>
            <a href="/relatorios.html" class="quick-action-btn p-4 rounded-lg block border-2 border-purple-500">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 bg-purple-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-file-chart-line text-purple-500"></i>
                  </div>
                  <div>
                    <h3 class="font-semibold text-purple-400">Relatórios Premium</h3>
                    <p class="text-xs text-gray-400">Análises do Diego Doneda</p>
                  </div>
                </div>
                <div class="absolute top-2 right-2 text-xs bg-purple-500 text-white px-2 py-1 rounded-full font-bold">
                  ANALISTA
                </div>
              </a>

            <div onclick="showPremiumFeature('RSL')" class="quick-action-btn p-4 rounded-lg block cursor-pointer relative">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-purple-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <i class="fas fa-robot text-purple-500"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-white">RSL Premium</h3>
                  <p class="text-xs text-gray-400">Indicadores avançados</p>
                </div>
              </div>
              <div class="absolute top-2 right-2 text-xs bg-yellow-500 text-black px-2 py-1 rounded-full font-bold">
                PRO
              </div>
            </div>
            
            <div onclick="showPremiumFeature('Backtests')" class="quick-action-btn p-4 rounded-lg block cursor-pointer relative">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-orange-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <i class="fas fa-history text-orange-500"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-white">Backtests</h3>
                  <p class="text-xs text-gray-400">Simulação de estratégias</p>
                </div>
              </div>
              <div class="absolute top-2 right-2 text-xs bg-yellow-500 text-black px-2 py-1 rounded-full font-bold">
                PRO
              </div>
            </div>
            
            <div onclick="showPremiumFeature('IA')" class="quick-action-btn p-4 rounded-lg block cursor-pointer relative">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-pink-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                  <i class="fas fa-brain text-pink-500"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-white">IA Estratégica</h3>
                  <p class="text-xs text-gray-400">Recomendações inteligentes</p>
                </div>
              </div>
              <div class="absolute top-2 right-2 text-xs bg-purple-500 text-white px-2 py-1 rounded-full font-bold">
                PREMIUM+
              </div>
            </div>
            
            <a href="/planos.html" class="quick-action-btn p-4 rounded-lg block border-2 border-geminii">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-geminii bg-opacity-20 rounded-lg flex items-center justify-center">
                  <i class="fas fa-crown text-geminii"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-geminii">Fazer Upgrade</h3>
                  <p class="text-xs text-gray-400">Desbloqueie todos os recursos</p>
                </div>
              </div>
            </a>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="dashboard-card p-6 mb-8">
          <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
            <i class="fas fa-clock text-geminii"></i>
            Atividade Recente
          </h2>
          
          <div class="space-y-4" id="recentActivity">
            <div class="flex items-center gap-4 p-3 bg-white bg-opacity-5 rounded-lg">
              <div class="w-8 h-8 bg-green-500 bg-opacity-20 rounded-full flex items-center justify-center">
                <i class="fas fa-user-plus text-green-500 text-sm"></i>
              </div>
              <div class="flex-1">
                <p class="text-white font-medium">Conta criada com sucesso</p>
                <p class="text-xs text-gray-400">Agora mesmo</p>
              </div>
            </div>
            
            <div class="flex items-center gap-4 p-3 bg-white bg-opacity-5 rounded-lg">
              <div class="w-8 h-8 bg-blue-500 bg-opacity-20 rounded-full flex items-center justify-center">
                <i class="fas fa-eye text-blue-500 text-sm"></i>
              </div>
              <div class="flex-1">
                <p class="text-white font-medium">Watchlist padrão criada</p>
                <p class="text-xs text-gray-400">PETR4, VALE3, ITUB4 adicionados</p>
              </div>
            </div>
            
            <div class="flex items-center gap-4 p-3 bg-white bg-opacity-5 rounded-lg">
              <div class="w-8 h-8 bg-purple-500 bg-opacity-20 rounded-full flex items-center justify-center">
                <i class="fas fa-gift text-purple-500 text-sm"></i>
              </div>
              <div class="flex-1">
                <p class="text-white font-medium">Trial Premium ativado</p>
                <p class="text-xs text-gray-400">7 dias de acesso completo</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Market Overview -->
        <div class="dashboard-card p-6">
          <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
            <i class="fas fa-chart-area text-geminii"></i>
            Visão Geral do Mercado
          </h2>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <h3 class="text-lg font-semibold text-white mb-4">Principais Ações</h3>
              <div class="space-y-3" id="topStocks">
                <!-- Stocks will be loaded here -->
                <div class="flex items-center justify-between p-3 bg-white bg-opacity-5 rounded-lg">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold">P</div>
                    <div>
                      <p class="text-white font-medium">PETR4</p>
                      <p class="text-xs text-gray-400">Petrobras PN</p>
                    </div>
                  </div>
                  <div class="text-right">
                    <p class="text-white font-semibold">R$ 32,45</p>
                    <p class="text-xs text-green-400">+2,3%</p>
                  </div>
                </div>
              </div>
            </div>
            
            <div>
              <h3 class="text-lg font-semibold text-white mb-4">Performance da Carteira</h3>
              <div class="h-40 bg-white bg-opacity-5 rounded-lg flex items-center justify-center">
                <p class="text-gray-400">Gráfico em desenvolvimento</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let userToken = null;

    // Check authentication and load user data
    async function checkAuth() {
      const token = localStorage.getItem('geminii_token');
      const userData = localStorage.getItem('geminii_user');

      if (!token || !userData) {
        window.location.href = '/login.html';
        return;
      }

      try {
        const response = await fetch('/api/auth/verify', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const result = await response.json();

        if (result.success) {
          userToken = token;
          currentUser = result.data.user;
          updateUserInterface(currentUser);
          loadDashboardData();
        } else {
          localStorage.removeItem('geminii_token');
          localStorage.removeItem('geminii_user');
          window.location.href = '/login.html';
        }

      } catch (error) {
        console.error('Auth check failed:', error);
        localStorage.removeItem('geminii_token');
        localStorage.removeItem('geminii_user');
        window.location.href = '/login.html';
      }
    }

    // Update user interface with user data
    function updateUserInterface(user) {
      // User info
      const initials = user.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
      document.getElementById('userInitials').textContent = initials;
      document.getElementById('userName').textContent = user.name;
      document.getElementById('userEmail').textContent = user.email;

      // Plan badge
      const planBadge = document.getElementById('userPlanBadge');
      const planId = user.plan_id || 1;
      
      if (planId === 1) {
        planBadge.textContent = 'Básico';
        planBadge.className = 'plan-badge free';
        document.getElementById('trialInfo').innerHTML = '<i class="fas fa-info-circle mr-1"></i>Plano Gratuito';
      } else if (planId === 2) {
        planBadge.textContent = 'Premium';
        planBadge.className = 'plan-badge premium';
        document.getElementById('trialInfo').innerHTML = '<i class="fas fa-crown mr-1"></i>Plano Premium';
      } else if (planId >= 3) {
        planBadge.textContent = 'Estratégico';
        planBadge.className = 'plan-badge strategic';
        document.getElementById('trialInfo').innerHTML = '<i class="fas fa-gem mr-1"></i>Plano Estratégico';
      }

      console.log('✅ Dashboard carregado para:', user.name, '- Plano:', user.plan_name);
    }

    // Load dashboard data
    async function loadDashboardData() {
      try {
        const response = await fetch('/api/dashboard', {
          headers: {
            'Authorization': `Bearer ${userToken}`
          }
        });

        const result = await response.json();

        if (result.success) {
          console.log('📊 Dados do dashboard:', result.data);
          
          // Update stats (you can expand this)
          document.getElementById('totalAnalysis').textContent = Math.floor(Math.random() * 15);
          document.getElementById('activeAlerts').textContent = Math.floor(Math.random() * 5);
          
          // Update progress bar
          const progress = Math.floor(Math.random() * 100);
          document.getElementById('analysisProgress').style.width = progress + '%';
          
        }

      } catch (error) {
        console.error('Failed to load dashboard data:', error);
      }
    }

    // Show premium feature dialog
    function showPremiumFeature(featureName) {
      if (!currentUser) return;

      const userPlanId = currentUser.plan_id || 1;
      let requiredPlan = 2; // Premium by default
      
      if (featureName === 'IA') {
        requiredPlan = 3; // Strategic
      }

      if (userPlanId >= requiredPlan) {
        alert(`🎉 ${featureName}\n\nFuncionalidade disponível em seu plano!\nEm breve será implementada.`);
      } else {
        const planNames = { 1: 'Básico', 2: 'Premium', 3: 'Estratégico' };
        const message = `💎 Recurso ${requiredPlan >= 3 ? 'Premium+' : 'Premium'}\n\n${featureName} está disponível apenas para planos ${planNames[requiredPlan]} ou superior.\n\nSeu plano atual: ${currentUser.plan_name}\nPlano necessário: ${planNames[requiredPlan]}\n\nDeseja fazer upgrade agora?`;
        
        if (confirm(message)) {
          window.location.href = '/planos.html';
        }
      }
    }

    // Logout function
    async function logout() {
      try {
        if (userToken) {
          await fetch('/api/auth/logout', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${userToken}`
            }
          });
        }
      } catch (error) {
        console.error('Logout error:', error);
      } finally {
        localStorage.removeItem('geminii_token');
        localStorage.removeItem('geminii_user');
        window.location.href = '/home.html';
      }
    }

    // Load stock data
    async function loadStockData() {
      try {
        const response = await fetch('/api/stocks?symbols=PETR4,VALE3,ITUB4', {
          headers: userToken ? { 'Authorization': `Bearer ${userToken}` } : {}
        });

        const result = await response.json();

        if (result.success) {
          const stocksContainer = document.getElementById('topStocks');
          const stocks = Object.entries(result.data);
          
          stocksContainer.innerHTML = stocks.map(([symbol, data]) => {
            const isPositive = data.change >= 0;
            const colorClass = isPositive ? 'text-green-400' : 'text-red-400';
            const icon = isPositive ? '+' : '';
            
            return `
              <div class="flex items-center justify-between p-3 bg-white bg-opacity-5 rounded-lg">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
                    ${symbol[0]}
                  </div>
                  <div>
                    <p class="text-white font-medium">${symbol}</p>
                    <p class="text-xs text-gray-400">${getStockName(symbol)}</p>
                  </div>
                </div>
                <div class="text-right">
                  <p class="text-white font-semibold">R$ ${data.current_price}</p>
                  <p class="text-xs ${colorClass}">${icon}${data.change_percent.toFixed(2)}%</p>
                </div>
              </div>
            `;
          }).join('');
        }

      } catch (error) {
        console.error('Failed to load stock data:', error);
      }
    }

    // Get stock display name
    function getStockName(symbol) {
      const names = {
        'PETR4': 'Petrobras PN',
        'VALE3': 'Vale ON',
        'ITUB4': 'Itaú Unibanco PN'
      };
      return names[symbol] || symbol;
    }

    // Check API status
    async function checkApiStatus() {
      try {
        const response = await fetch('/api/status');
        const data = await response.json();
        
        if (data.status === 'online') {
          document.getElementById('apiStatus').innerHTML = `
            <i class="fas fa-shield-alt text-green-500 text-xs"></i>
            <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
          `;
        }
      } catch (error) {
        document.getElementById('apiStatus').innerHTML = `
          <i class="fas fa-shield-alt text-red-500 text-xs"></i>
          <div class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
        `;
      }
    }

    // Hide welcome alert after some time
    function hideWelcomeAlert() {
      setTimeout(() => {
        const alert = document.getElementById('welcomeAlert');
        if (alert) {
          alert.style.opacity = '0';
          alert.style.transform = 'translateY(-20px)';
          setTimeout(() => {
            alert.style.display = 'none';
          }, 300);
        }
      }, 5000); // Hide after 5 seconds
    }

    // Initialize dashboard
    async function initDashboard() {
      console.log('🚀 Inicializando Dashboard...');
      
      // Check authentication first
      await checkAuth();
      
      // Check API status
      checkApiStatus();
      setInterval(checkApiStatus, 30000);
      
      // Load additional data
      loadStockData();
      
      // Hide welcome alert after delay
      hideWelcomeAlert();
      
      console.log('✅ Dashboard inicializado com sucesso!');
    }

    // Make functions global
    window.logout = logout;
    window.showPremiumFeature = showPremiumFeature;

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initDashboard);

    // Handle page visibility change to refresh data
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        loadStockData();
        checkApiStatus();
      }
    });
  </script>
</body>
</html>