<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            secondary: '#8b5cf6',
            accent: '#06b6d4',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            geminii: '#ba39af'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif']
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      scroll-behavior: smooth;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: #282a36;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .stat-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.8));
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .navbar {
      background: rgba(40, 42, 54, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border: none;
      color: white;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
    }
    
    .recommendation-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }
    
    .recommendation-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    }
    
    .badge-compra-forte {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }
    
    .badge-compra {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
    }
    
    .badge-venda {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }
    
    .badge-manter {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: white;
    }
    
    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #6366f1;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="min-h-screen">
  
  <!-- Navigation -->
  <nav class="navbar fixed top-0 left-0 right-0 z-50 px-6 py-4">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center space-x-8">
        <div class="flex items-center space-x-3">
          <img src="./assets/logo.png" alt="Geminii" class="w-8 h-8">
          <span class="text-xl font-bold text-white">Geminii</span>
        </div>
        <div class="hidden md:flex items-center space-x-6">
          <a href="#" class="text-gray-300 hover:text-primary transition-colors font-medium">Dashboard</a>
          <a href="#" class="text-gray-300 hover:text-primary transition-colors">Análises</a>
          <a href="#" class="text-gray-300 hover:text-primary transition-colors">Relatórios</a>
        </div>
      </div>
      
      <div class="flex items-center space-x-4">
        <div id="statusIndicator" class="flex items-center space-x-2">
          <div class="w-2 h-2 bg-success rounded-full animate-pulse"></div>
          <span class="text-sm text-gray-300">Online</span>
        </div>
        <button onclick="logout()" class="bg-red-50 hover:bg-red-100 text-red-600 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
          Sair
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="pt-20 px-6 pb-12">
    <div class="max-w-7xl mx-auto">
      
      <!-- Header Section -->
      <div class="card rounded-2xl p-8 mb-8 fade-in">
        <div class="flex flex-col lg:flex-row items-center gap-8">
          <div class="flex-shrink-0">
            <div id="userAvatar" class="w-20 h-20 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center text-white text-xl font-bold shadow-lg">
              <span id="userInitials">U</span>
            </div>
          </div>
          
          <div class="flex-1 text-center lg:text-left">
            <h1 class="text-4xl font-bold text-white mb-2">
              Olá, <span id="userName" class="gradient-text">Usuário</span>!
            </h1>
            <p class="text-gray-300 text-lg mb-4" id="userEmail">Bem-vindo ao seu painel de investimentos</p>
            
            <div class="flex flex-col sm:flex-row items-center gap-4">
              <div class="flex items-center gap-2">
                <span class="text-gray-400">Plano:</span>
                <span id="userPlanBadge" class="px-3 py-1 rounded-full text-sm font-semibold bg-gray-100 text-gray-700">Básico</span>
              </div>
              <div class="text-sm text-gray-400">
                <i class="fas fa-calendar mr-2"></i>
                Membro desde: <span id="memberSince">Hoje</span>
              </div>
            </div>
          </div>
          
          <div class="flex flex-col gap-3">
            <button class="btn-primary px-6 py-3 rounded-xl font-semibold">
              <i class="fas fa-crown mr-2"></i>Fazer Upgrade
            </button>
            <button class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-6 py-3 rounded-xl font-semibold transition-colors">
              <i class="fas fa-cog mr-2"></i>Configurações
            </button>
          </div>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="stat-card rounded-xl p-6 fade-in">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
              <i class="fas fa-chart-line text-primary text-xl"></i>
            </div>
            <div class="text-right">
              <div id="totalAnalysis" class="text-2xl font-bold text-white">0</div>
              <div class="text-sm text-gray-400">Recomendações</div>
            </div>
          </div>
          <div class="w-full bg-gray-600 rounded-full h-2">
            <div id="analysisProgress" class="bg-primary rounded-full h-2 transition-all" style="width: 0%"></div>
          </div>
        </div>

        <div class="stat-card rounded-xl p-6 fade-in">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-success/10 rounded-lg flex items-center justify-center">
              <i class="fas fa-trending-up text-success text-xl"></i>
            </div>
            <div class="text-right">
              <div id="comprasCount" class="text-2xl font-bold text-success">0</div>
              <div class="text-sm text-gray-400">Sinais Compra</div>
            </div>
          </div>
          <div class="text-sm text-success flex items-center">
            <i class="fas fa-arrow-up mr-1"></i>
            <span id="comprasText">Oportunidades</span>
          </div>
        </div>

        <div class="stat-card rounded-xl p-6 fade-in">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-warning/10 rounded-lg flex items-center justify-center">
              <i class="fas fa-percentage text-warning text-xl"></i>
            </div>
            <div class="text-right">
              <div id="portfolioPerformance" class="text-2xl font-bold text-warning">0%</div>
              <div class="text-sm text-gray-400">Performance</div>
            </div>
          </div>
          <div class="text-sm text-warning flex items-center">
            <i class="fas fa-chart-line mr-1"></i>
            <span id="performanceText">Média geral</span>
          </div>
        </div>

        <div class="stat-card rounded-xl p-6 fade-in">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-accent/10 rounded-lg flex items-center justify-center">
              <i class="fas fa-clock text-accent text-xl"></i>
            </div>
            <div class="text-right">
              <div id="lastUpdate" class="text-2xl font-bold text-accent">Agora</div>
              <div class="text-sm text-gray-400">Última Sync</div>
            </div>
          </div>
          <div class="text-sm text-accent flex items-center">
            <i class="fas fa-sync mr-1"></i>
            <span>Tempo real</span>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card rounded-2xl p-8 mb-8 fade-in">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
          <i class="fas fa-bolt text-primary mr-3"></i>
          Ações Rápidas
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <a href="/monitor-basico.html" class="bg-gradient-to-r from-success/10 to-success/5 hover:from-success/20 hover:to-success/10 border border-success/20 rounded-xl p-6 transition-all group">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 bg-success/20 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                <i class="fas fa-chart-area text-success text-lg"></i>
              </div>
              <div>
                <h3 class="font-semibold text-white">Monitor Beta</h3>
                <p class="text-sm text-gray-300">Análise vs IBOVESPA</p>
              </div>
            </div>
          </a>

          <div onclick="showPremiumFeature('Long & Short')" class="bg-gradient-to-r from-secondary/10 to-secondary/5 hover:from-secondary/20 hover:to-secondary/10 border border-secondary/20 rounded-xl p-6 transition-all group cursor-pointer relative">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 bg-secondary/20 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                <i class="fas fa-exchange-alt text-secondary text-lg"></i>
              </div>
              <div>
                <h3 class="font-semibold text-white">Long & Short</h3>
                <p class="text-sm text-gray-300">Cointegração</p>
              </div>
            </div>
            <span class="absolute top-4 right-4 bg-warning text-white text-xs px-2 py-1 rounded-full font-bold">PRO</span>
          </div>

          <a href="/relatorios.html" class="bg-gradient-to-r from-primary/10 to-primary/5 hover:from-primary/20 hover:to-primary/10 border border-primary/20 rounded-xl p-6 transition-all group">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 bg-primary/20 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                <i class="fas fa-file-chart-line text-primary text-lg"></i>
              </div>
              <div>
                <h3 class="font-semibold text-white">Relatórios Premium</h3>
                <p class="text-sm text-gray-300">Análises especializadas</p>
              </div>
            </div>
            <span class="absolute top-4 right-4 bg-secondary text-white text-xs px-2 py-1 rounded-full font-bold">PREMIUM</span>
          </a>

          <div onclick="showPremiumFeature('RSL')" class="bg-gradient-to-r from-pink-100/50 to-pink-50/50 hover:from-pink-100 hover:to-pink-50 border border-pink-200 rounded-xl p-6 transition-all group cursor-pointer relative">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 bg-pink-200 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                <i class="fas fa-robot text-pink-600 text-lg"></i>
              </div>
              <div>
                <h3 class="font-semibold text-white">RSL Premium</h3>
                <p class="text-sm text-gray-300">Indicadores IA</p>
              </div>
            </div>
            <span class="absolute top-4 right-4 bg-warning text-white text-xs px-2 py-1 rounded-full font-bold">PRO</span>
          </div>

          <div onclick="showPremiumFeature('Backtests')" class="bg-gradient-to-r from-orange-100/50 to-orange-50/50 hover:from-orange-100 hover:to-orange-50 border border-orange-200 rounded-xl p-6 transition-all group cursor-pointer relative">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 bg-orange-200 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                <i class="fas fa-history text-orange-600 text-lg"></i>
              </div>
              <div>
                <h3 class="font-semibold text-white">Backtests</h3>
                <p class="text-sm text-gray-300">Simulações</p>
              </div>
            </div>
            <span class="absolute top-4 right-4 bg-warning text-white text-xs px-2 py-1 rounded-full font-bold">PRO</span>
          </div>

          <a href="planos.html" class="bg-gradient-to-r from-primary to-secondary text-white rounded-xl p-6 transition-all group hover:shadow-lg">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                <i class="fas fa-crown text-white text-lg"></i>
              </div>
              <div>
                <h3 class="font-semibold">Fazer Upgrade</h3>
                <p class="text-sm opacity-90">Todos os recursos</p>
              </div>
            </div>
          </a>
        </div>
      </div>

      <!-- Recommendations Section -->
      <div class="card rounded-2xl p-8 fade-in">
        <div class="flex items-center justify-between mb-8">
          <div>
            <h2 class="text-2xl font-bold text-white flex items-center">
              <i class="fas fa-lightbulb text-warning mr-3"></i>
              Carteira BDR
            </h2>
            <p class="text-gray-300 mt-1">Recomendações personalizadas</p>
          </div>
          
          <div class="flex items-center gap-4">
            <button onclick="refreshRecommendations()" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
              <i id="refreshIcon" class="fas fa-sync-alt mr-2"></i>Atualizar
            </button>
            <div class="text-sm text-gray-400">
              <i class="fas fa-database mr-1"></i>Yahoo Finance
            </div>
          </div>
        </div>

        <!-- Loading State -->
        <div id="recommendationsLoading" class="flex flex-col items-center justify-center py-16">
          <div class="spinner mb-4"></div>
          <p class="text-gray-400">Carregando recomendações...</p>
        </div>
        
        <!-- Error State -->
        <div id="recommendationsError" class="hidden bg-red-50 border border-red-200 rounded-xl p-6">
          <div class="flex items-center gap-3">
            <i class="fas fa-exclamation-triangle text-danger text-xl"></i>
            <div>
              <h4 class="font-semibold text-danger">Erro ao carregar recomendações</h4>
              <p class="text-sm text-red-600 mt-1" id="errorMessage">Falha na conexão com o servidor</p>
            </div>
          </div>
        </div>
        
        <!-- Recommendations Content -->
        <div id="recommendationsContainer" class="hidden">
          <div id="recommendationsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Recommendations will be loaded here -->
          </div>
          
          <!-- Portfolio Summary -->
          <div class="bg-gradient-to-r from-gray-700 to-gray-600 rounded-xl p-6 border border-gray-500">
            <h3 class="text-lg font-bold text-white mb-4">Resumo da Carteira</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
              <div class="text-center">
                <div id="totalStocks" class="text-2xl font-bold text-white">0</div>
                <div class="text-sm text-gray-300">Total de Ações</div>
              </div>
              <div class="text-center">
                <div id="buySignals" class="text-2xl font-bold text-primary">0</div>
                <div class="text-sm text-gray-300">Sinais Compra</div>
              </div>
              <div class="text-center">
                <div id="sellSignals" class="text-2xl font-bold text-success">0</div>
                <div class="text-sm text-gray-300">Sinais Venda</div>
              </div>
              <div class="text-center">
                <div id="avgPerformance" class="text-2xl font-bold text-warning">0%</div>
                <div class="text-sm text-gray-300">Performance Média</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    let currentUser = null;
    let userToken = null;
    let dashboardData = null;

    // Initialize dashboard
    async function initDashboard() {
      console.log('🚀 Inicializando Dashboard Geminii...');
      await checkAuth();
      checkApiStatus();
      setInterval(checkApiStatus, 30000);
      console.log('✅ Dashboard inicializado!');
    }

    // Check authentication
    async function checkAuth() {
      const token = localStorage.getItem('geminii_token');
      const userData = localStorage.getItem('geminii_user');

      if (!token || !userData) {
        window.location.href = '/login.html';
        return;
      }

      try {
        const response = await fetch('/api/auth/verify', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const result = await response.json();

        if (result.success) {
          userToken = token;
          currentUser = result.data.user;
          updateUserInterface(currentUser);
          loadDashboardData();
        } else {
          localStorage.removeItem('geminii_token');
          localStorage.removeItem('geminii_user');
          window.location.href = '/login.html';
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        localStorage.removeItem('geminii_token');
        localStorage.removeItem('geminii_user');
        window.location.href = '/login.html';
      }
    }

    // Update user interface
    function updateUserInterface(user) {
      const initials = user.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
      document.getElementById('userInitials').textContent = initials;
      document.getElementById('userName').textContent = user.name;
      document.getElementById('userEmail').textContent = user.email;

      const planBadge = document.getElementById('userPlanBadge');
      const planId = user.plan_id || 1;
      
      if (planId === 1) {
        planBadge.textContent = 'Básico';
        planBadge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-gray-600 text-gray-200';
      } else if (planId === 2) {
        planBadge.textContent = 'Premium';
        planBadge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-warning text-white';
      } else if (planId >= 3) {
        planBadge.textContent = 'Estratégico';
        planBadge.className = 'px-3 py-1 rounded-full text-sm font-semibold bg-secondary text-white';
      }

      console.log('✅ Usuário logado:', user.name);
    }

    // Load dashboard data
    async function loadDashboardData() {
      try {
        showLoading();
        
        const response = await fetch('/api/dashboard/recommendations?portfolio=carteira_bdr&limit=8', {
          headers: { 'Authorization': `Bearer ${userToken}` }
        });

        const result = await response.json();

        if (result.success) {
          dashboardData = result.data;
          updateDashboardStats(dashboardData);
          displayRecommendations(dashboardData.recommendations);
          hideLoading();
        } else {
          showError(result.error || 'Erro ao carregar dados');
        }
      } catch (error) {
        console.error('Failed to load dashboard data:', error);
        showError('Falha na conexão com servidor');
      }
    }

    // Update dashboard statistics
    function updateDashboardStats(data) {
      const stats = data.recommendations.statistics;
      
      document.getElementById('totalAnalysis').textContent = stats.total_stocks;
      document.getElementById('comprasCount').textContent = stats.signals.compras;
      document.getElementById('portfolioPerformance').textContent = stats.avg_performance + '%';
      document.getElementById('lastUpdate').textContent = data.recommendations.last_update.split(' ')[1];
      
      const performanceProgress = Math.min(Math.max((stats.avg_performance + 10) * 5, 0), 100);
      document.getElementById('analysisProgress').style.width = performanceProgress + '%';
      
      document.getElementById('comprasText').textContent = 
        stats.signals.compras > 0 ? `${stats.signals.compras} oportunidades` : 'Sem sinais';
      
      const perfElement = document.getElementById('portfolioPerformance');
      perfElement.className = `text-2xl font-bold ${stats.avg_performance >= 0 ? 'text-success' : 'text-danger'}`;
      
      document.getElementById('performanceText').textContent = 
        stats.avg_performance >= 0 ? 'Performance positiva' : 'Performance negativa';
      
      document.getElementById('totalStocks').textContent = stats.total_stocks;
      document.getElementById('buySignals').textContent = stats.signals.compras;
      document.getElementById('sellSignals').textContent = stats.signals.vendas;
      document.getElementById('avgPerformance').textContent = stats.avg_performance + '%';
    }

    // Display recommendations
    function displayRecommendations(recommendationsData) {
      const container = document.getElementById('recommendationsGrid');
      const recommendations = recommendationsData.recommendations;
      
      if (!recommendations || recommendations.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center py-12">
            <i class="fas fa-inbox text-5xl text-gray-300 mb-4"></i>
            <p class="text-gray-400">Nenhuma recomendação disponível</p>
          </div>
        `;
        return;
      }

      container.innerHTML = recommendations.map(rec => {
        const badgeClass = getBadgeClass(rec.recomendacao);
        const performanceClass = rec.performance.valor >= 0 ? 'text-success' : 'text-danger';
        
        return `
          <div class="recommendation-card rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="text-2xl">${rec.icone}</div>
                <div>
                  <h3 class="font-bold text-white">${rec.ticker}</h3>
                  <p class="text-sm text-gray-400">${rec.setor}</p>
                </div>
              </div>
              <span class="${badgeClass} px-3 py-1 rounded-full text-xs font-bold">${rec.recomendacao}</span>
            </div>
            
            <div class="space-y-3">
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Entrada:</span>
                <span class="font-semibold text-white">R$ ${rec.entrada.preco.toFixed(2)}</span>
              </div>
              
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Atual:</span>
                <span class="font-semibold text-white">R$ ${rec.atual.preco.toFixed(2)}</span>
              </div>
              
              <div class="flex justify-between text-sm">
                <span class="text-gray-400">Performance:</span>
                <span class="${performanceClass} font-bold">
                  ${rec.performance.valor >= 0 ? '+' : ''}${rec.performance.valor.toFixed(2)}%
                </span>
              </div>
              
              <div class="w-full bg-gray-600 rounded-full h-2">
                <div class="bg-gradient-to-r ${getProgressColor(rec.performance.valor)} h-2 rounded-full transition-all" 
                     style="width: ${Math.min(Math.max((rec.performance.valor + 10) * 5, 0), 100)}%"></div>
              </div>
              
              <div class="flex justify-between text-xs text-gray-500 pt-2 border-t border-gray-600">
                <span>Peso: ${rec.entrada.peso_percent.toFixed(1)}%</span>
                <span>Período: ${rec.performance.dias} dias</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Get badge class for recommendations
    function getBadgeClass(recomendacao) {
      const recLower = recomendacao.toLowerCase();
      
      if (recLower.includes('compra forte')) return 'badge-compra-forte';
      if (recLower.includes('compra')) return 'badge-compra';
      if (recLower.includes('venda')) return 'badge-venda';
      if (recLower.includes('manter')) return 'badge-manter';
      return 'badge-manter';
    }

    // Get progress bar color
    function getProgressColor(performance) {
      if (performance >= 5) return 'from-success to-emerald-600';
      if (performance >= 0) return 'from-primary to-blue-600';
      if (performance >= -5) return 'from-warning to-orange-600';
      return 'from-danger to-red-600';
    }

    // Show loading state
    function showLoading() {
      document.getElementById('recommendationsLoading').classList.remove('hidden');
      document.getElementById('recommendationsContainer').classList.add('hidden');
      document.getElementById('recommendationsError').classList.add('hidden');
    }

    // Hide loading state
    function hideLoading() {
      document.getElementById('recommendationsLoading').classList.add('hidden');
      document.getElementById('recommendationsContainer').classList.remove('hidden');
    }

    // Show error state
    function showError(message) {
      document.getElementById('recommendationsLoading').classList.add('hidden');
      document.getElementById('recommendationsContainer').classList.add('hidden');
      document.getElementById('recommendationsError').classList.remove('hidden');
      document.getElementById('errorMessage').textContent = message;
    }

    // Refresh recommendations
    async function refreshRecommendations() {
      const refreshIcon = document.getElementById('refreshIcon');
      refreshIcon.classList.add('fa-spin');
      
      try {
        await loadDashboardData();
      } catch (error) {
        console.error('Error refreshing:', error);
      } finally {
        setTimeout(() => {
          refreshIcon.classList.remove('fa-spin');
        }, 1000);
      }
    }

    // Show premium feature dialog
    function showPremiumFeature(featureName) {
      if (!currentUser) return;
    
      const userPlanId = currentUser.plan_id || 1;
      let requiredPlan = 2;
      
      if (featureName === 'IA') {
        requiredPlan = 3;
      }
    
      if (featureName === 'Long & Short' && userPlanId >= 2) {
        window.location.href = 'long-short.html';
        return;
      }
    
      if (userPlanId >= requiredPlan) {
        if (featureName !== 'Long & Short') {
          alert(`🎉 ${featureName}\n\nFuncionalidade disponível em seu plano!\nEm breve será implementada.`);
        }
      } else {
        const planNames = { 1: 'Básico', 2: 'Premium', 3: 'Estratégico' };
        const message = `💎 Recurso ${requiredPlan >= 3 ? 'Premium+' : 'Premium'}\n\n${featureName} está disponível apenas para planos ${planNames[requiredPlan]} ou superior.\n\nSeu plano atual: ${currentUser.plan_name}\nPlano necessário: ${planNames[requiredPlan]}\n\nDeseja fazer upgrade agora?`;
        
        if (confirm(message)) {
          window.location.href = '/planos.html';
        }
      }
    }

    // Logout function
    async function logout() {
      try {
        if (userToken) {
          await fetch('/api/auth/logout', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${userToken}` }
          });
        }
      } catch (error) {
        console.error('Logout error:', error);
      } finally {
        localStorage.removeItem('geminii_token');
        localStorage.removeItem('geminii_user');
        window.location.href = '/';
      }
    }

    // Check API status
    async function checkApiStatus() {
      try {
        const response = await fetch('/api/status');
        const data = await response.json();
        
        const statusEl = document.getElementById('statusIndicator');
        if (data.status === 'online') {
          statusEl.innerHTML = `
            <div class="w-2 h-2 bg-success rounded-full animate-pulse"></div>
            <span class="text-sm text-gray-300">Online</span>
          `;
        } else {
          statusEl.innerHTML = `
            <div class="w-2 h-2 bg-danger rounded-full animate-pulse"></div>
            <span class="text-sm text-gray-300">Offline</span>
          `;
        }
      } catch (error) {
        const statusEl = document.getElementById('statusIndicator');
        statusEl.innerHTML = `
          <div class="w-2 h-2 bg-danger rounded-full animate-pulse"></div>
          <span class="text-sm text-gray-600">Offline</span>
        `;
      }
    }

    // Make functions global
    window.logout = logout;
    window.showPremiumFeature = showPremiumFeature;
    window.refreshRecommendations = refreshRecommendations;

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initDashboard);

    // Handle page visibility change
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden && dashboardData) {
        refreshRecommendations();
        checkApiStatus();
      }
    });

    // Auto-refresh every 5 minutes
    setInterval(() => {
      if (!document.hidden && dashboardData) {
        refreshRecommendations();
      }
    }, 5 * 60 * 1000);
  </script>
</body>
</html>