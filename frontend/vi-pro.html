<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Análise de Volatilidade Implícita - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#000000',
            light: '#ffffff',
            subtle: 'rgba(255,255,255,0.1)',
            geminii: '#ba39af'
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
      min-height: 100vh;
    }
    
    .vi-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      transition: all 0.3s ease;
    }
    
    .vi-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(186, 57, 175, 0.15);
      border-color: rgba(186, 57, 175, 0.3);
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .spinner {
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 2px solid #ba39af;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-10px); }
    }

    .dark-select {
      background-color: rgba(30, 30, 30, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      backdrop-filter: blur(10px);
    }

    .dark-select option {
      background-color: #1a1a1a;
      color: white;
      padding: 8px;
    }

    .dark-select:focus {
      outline: none;
      border-color: #ba39af;
      box-shadow: 0 0 0 2px rgba(186, 57, 175, 0.2);
    }

    .signal-indicator {
      display: inline-flex;
      align-items: center;
      padding: 16px 24px;
      border-radius: 20px;
      font-size: 16px;
      font-weight: 700;
      border: 2px solid;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    .signal-q4 {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border-color: #10b981;
      box-shadow: 0 0 30px rgba(16, 185, 129, 0.4);
    }
    
    .signal-q3 {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      border-color: #22c55e;
      box-shadow: 0 0 30px rgba(34, 197, 94, 0.4);
    }
    
    .signal-q2 {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: white;
      border-color: #6b7280;
    }
    
    .signal-q1 {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border-color: #ef4444;
      box-shadow: 0 0 30px rgba(239, 68, 68, 0.4);
    }

    .metric-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(186, 57, 175, 0.3);
    }
    
    .calls-card {
      background: rgba(34, 197, 94, 0.1);
      border-color: rgba(34, 197, 94, 0.2);
      padding: 16px; 
      min-height: 140px; 
    }
    
    .calls-card:hover {
      background: rgba(34, 197, 94, 0.15);
      border-color: rgba(34, 197, 94, 0.4);
    }
    
    .puts-card {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.2);
      padding: 16px; 
      min-height: 140px; 
    }
    
    .puts-card:hover {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.4);
    }

    .chart-container {
      height: 300px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow: hidden;
      position: relative;
    }

    .chart-container > div {
      width: 100% !important;
      height: 100% !important;
    }

    .explanation-card {
      background: linear-gradient(135deg, rgba(186, 57, 175, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
      border: 1px solid rgba(186, 57, 175, 0.3);
    }

    .progress-ring {
      width: 120px;
      height: 120px;
      transform: rotate(-90deg);
    }

    .progress-ring-circle {
      stroke: #4b5563;
      stroke-width: 8;
      fill: transparent;
      r: 52;
      cx: 60;
      cy: 60;
    }

    .progress-ring-progress {
      stroke: #ba39af;
      stroke-width: 8;
      fill: transparent;
      r: 52;
      cx: 60;
      cy: 60;
      stroke-dasharray: 326.72;
      stroke-dashoffset: 326.72;
      transition: stroke-dashoffset 0.5s ease-in-out;
    }

    .quartile-bar {
      width: 100%;
      height: 8px;
      background: linear-gradient(to right, #ef4444 0%, #ef4444 25%, #6b7280 25%, #6b7280 50%, #22c55e 50%, #22c55e 75%, #10b981 75%, #10b981 100%);
      border-radius: 4px;
      position: relative;
      margin: 10px 0;
    }

    .quartile-indicator {
      position: absolute;
      top: -2px;
      width: 12px;
      height: 12px;
      background: white;
      border: 2px solid #ba39af;
      border-radius: 50%;
      transform: translateX(-50%);
    }
  </style>
</head>
<body class="text-white">
  
  <!-- Navbar -->
  <nav class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-opacity-5 border-opacity-10 bg-white border-white border rounded-full px-4 py-3 shadow-xl backdrop-blur-md">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <img src="logo.png" alt="Geminii Logo" class="w-6 h-6 cursor-pointer" onclick="window.location.href='/'">
      </div>
      <div class="hidden md:flex items-center space-x-6 text-xs text-gray-300 ml-8">
        <a href="/dashboard" class="hover:text-white transition-colors">Dashboard</a>
        <a href="opcoes.html" class="hover:text-white transition-colors">Hunter Walls</a>
        <span class="text-white font-medium">Implícita Sigma</span>
        <a href="regimes-pro.html" class="hover:text-white transition-colors">Bandas De Volatilidade</a>
        <a href="rank-volatilidade.html" class="hover:text-white transition-colors">IV Scanner</a>
        <a href="gamma-levels.html" class="hover:text-white transition-colors">Gamma Levels</a>
      </div>
      <div class="flex items-center space-x-3 ml-8">
        <div id="apiStatus" class="w-8 h-8 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-full flex items-center justify-center relative">
          <i class="fas fa-chart-line text-green-500 text-xs"></i>
          <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Content -->
  <div class="pt-32 pb-16">
    <div class="max-w-7xl mx-auto px-6">
      
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">
          <span style="color: #ba39af; font-weight: 900;">Implícita Sigma</span>
          <span class="text-white font-light">Calls vs Puts</span>
        </h1>
        <p class="text-neutral-300 text-lg max-w-3xl mx-auto">
          Análise quantitativa avançada de volatilidade implícita separando calls e puts para identificação do sentimento direcional do mercado e oportunidades específicas de trading.
        </p>
        
        <!-- Info Expander -->
        <div class="mt-8">
          <button onclick="toggleInfo()" class="bg-gradient-to-r from-geminii to-purple-600 hover:from-purple-600 hover:to-geminii text-white px-6 py-3 rounded-full font-semibold text-sm transition-all duration-300 flex items-center mx-auto shadow-lg hover:shadow-xl transform hover:scale-105">
            <i id="infoIcon" class="fas fa-info-circle mr-2 transition-transform duration-300"></i>
            Como Funciona a Análise Calls vs Puts
          </button>
          
          <div id="infoContent" class="hidden mt-8 max-w-5xl mx-auto">
            <div class="vi-card p-8 text-left">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <!-- Análise das Calls -->
                <div class="space-y-4">
                  <div class="flex items-center mb-4">
                    <div class="w-4 h-4 rounded-full bg-green-500 mr-3"></div>
                    <h3 class="text-xl font-bold text-white">Análise das Calls</h3>
                  </div>
                  <p class="text-gray-300 text-sm leading-relaxed mb-4">
                    Calls representam <strong>apostas de alta</strong> - quando investidores compram calls, apostam que o preço vai subir. A volatilidade implícita das calls revela o <strong>nível de otimismo</strong> do mercado.
                  </p>
                  <div class="bg-white/5 rounded-lg p-4">
                    <h4 class="text-white font-semibold text-sm mb-3">Sinais das Calls:</h4>
                    <ul class="text-gray-400 text-sm space-y-2">
                      <li>• <span class="text-white font-medium">VI Alta em Calls</span>: Otimismo excessivo no mercado</li>
                      <li>• <span class="text-white font-medium">VI Calls > VI Puts</span>: Sentimento bullish predominante</li>
                      <li>• <span class="text-white font-medium">VI Baixa em Calls</span>: Oportunidade de comprar calls baratas</li>
                    </ul>
                  </div>
                </div>
                
                <!-- Análise das Puts -->
                <div class="space-y-4">
                  <div class="flex items-center mb-4">
                    <div class="w-4 h-4 rounded-full bg-red-500 mr-3"></div>
                    <h3 class="text-xl font-bold text-white">Análise das Puts</h3>
                  </div>
                  <p class="text-gray-300 text-sm leading-relaxed mb-4">
                    Puts são <strong>proteção ou apostas de baixa</strong> - investidores compram puts para se proteger de quedas ou lucrar com elas. VI alta nas puts indica <strong>medo ou busca por proteção</strong>.
                  </p>
                  <div class="bg-white/5 rounded-lg p-4">
                    <h4 class="text-white font-semibold text-sm mb-3">Sinais das Puts:</h4>
                    <ul class="text-gray-400 text-sm space-y-2">
                      <li>• <span class="text-white font-medium">VI Alta em Puts</span>: Medo ou busca intensa por proteção</li>
                      <li>• <span class="text-white font-medium">VI Puts > VI Calls</span>: Sentimento bearish predominante</li>
                      <li>• <span class="text-white font-medium">VI Baixa em Puts</span>: Complacência - puts baratas para proteção</li>
                    </ul>
                  </div>
                </div>
                
              </div>
              
              <!-- Vantagem Estratégica -->
              <div class="mt-8 pt-6 border-t border-white/10">
                <div class="text-center">
                  <h4 class="text-geminii font-bold text-lg mb-3">Vantagem Estratégica</h4>
                  <p class="text-gray-300 text-sm max-w-3xl mx-auto">
                    Esta separação entre calls e puts revela <strong>assimetrias de sentimento</strong> que a VI geral não mostra. Quando há divergência significativa, surgem oportunidades de <strong>timing perfeito</strong> para estratégias direcionais específicas e <strong>arbitragem de volatilidade</strong>.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Controles -->
      <div class="vi-card p-6 mb-8">
        <div class="flex flex-col md:flex-row gap-4 items-center justify-center">
          <div class="flex gap-3 flex-wrap items-center">
            <input 
              id="stockInput" 
              type="text" 
              placeholder="Digite o código da ação (ex: PETR4)" 
              class="px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-geminii backdrop-blur-sm"
            >
            <div class="text-sm text-gray-400 bg-white bg-opacity-5 px-3 py-2 rounded-lg border border-white border-opacity-10">
              <i class="fas fa-calendar-alt mr-2"></i>Análise: 1 ano (252 dias)
            </div>
            <button id="analyzeBtn" class="px-6 py-2 bg-gradient-to-r from-pink-500 to-purple-600 hover:shadow-lg rounded-lg transition-all font-medium">
              <i class="fas fa-chart-area mr-2"></i>Analisar
            </button>
          </div>
        </div>
      </div>

      <!-- Status -->
      <div id="statusMsg" class="mb-6 p-4 rounded-lg hidden backdrop-blur-sm"></div>

      <!-- Sinal Principal -->
      <div id="mainSignal" class="mb-8 hidden">
        <div class="vi-card p-8">
          <div class="text-center mb-8">
            <h3 class="text-2xl font-bold mb-6 flex items-center">
              <i class="fas fa-balance-scale text-geminii mr-3"></i>Análise Calls vs Puts - Volatilidade Implícita
            </h3>
            <div id="signalIndicator" class="inline-block mb-6">
              <!-- Preenchido via JS -->
            </div>
          </div>
          
          <!-- GRID EXPANDIDO - 5 Cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
            
            <!-- Card do Quartil Atual -->
            <div class="metric-card text-center">
              <div class="text-sm text-gray-400 mb-2">Quartil VI Geral</div>
              <div class="relative inline-block">
                <svg class="progress-ring">
                  <circle class="progress-ring-circle"></circle>
                  <circle id="progressCircle" class="progress-ring-progress"></circle>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                  <div class="text-center">
                    <div id="signalValue" class="text-2xl font-bold text-white">--</div>
                    <div class="text-xs text-gray-400">Q1 a Q4</div>
                  </div>
                </div>
              </div>
              <!-- Barra de Quartis -->
              <div class="mt-4">
                <div class="quartile-bar">
                  <div id="quartileIndicator" class="quartile-indicator"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-400 mt-1">
                  <span>Q1</span>
                  <span>Q2</span>
                  <span>Q3</span>
                  <span>Q4</span>
                </div>
              </div>
            </div>
            
            <!-- Card do Preço -->
            <div class="metric-card">
              <div class="text-sm text-gray-400 mb-1">
                Preço Atual 
                <i class="fas fa-circle text-green-400 text-xs ml-1 animate-pulse" title="Tempo real"></i>
              </div>
              <div id="currentPrice" class="text-2xl font-bold text-white mb-1">--</div>
              <div class="text-sm text-gray-400">
                Confiança: <span id="signalConfidence" class="text-white font-medium">--</span>
              </div>
            </div>
            
            <!-- Card VI das Calls -->
            <div class="calls-card">
              <div class="text-sm text-gray-400 mb-1">
                <span class="text-green-400 font-bold">VI Calls</span>
                <i class="fas fa-arrow-up text-green-400 text-xs ml-1" title="Apostas de alta"></i>
              </div>
              <div id="viCallsCurrent" class="text-2xl font-bold text-green-400 mb-1">--</div>
              <div class="text-sm text-gray-400">
                Média: <span id="viCallsMean" class="text-green-300 font-medium">--</span>
              </div>
              <div class="mt-2">
                <div class="text-xs text-gray-500">
                  <span id="viCallsStatus" class="font-medium">--</span>
                </div>
              </div>
            </div>
            
            <!-- Card VI das Puts -->
            <div class="puts-card">
              <div class="text-sm text-gray-400 mb-1">
                <span class="text-red-400 font-bold">VI Puts</span>
                <i class="fas fa-shield-alt text-red-400 text-xs ml-1" title="Proteção/baixa"></i>
              </div>
              <div id="viPutsCurrent" class="text-2xl font-bold text-red-400 mb-1">--</div>
              <div class="text-sm text-gray-400">
                Média: <span id="viPutsMean" class="text-red-300 font-medium">--</span>
              </div>
              <div class="mt-2">
                <div class="text-xs text-gray-500">
                  <span id="viPutsStatus" class="font-medium">--</span>
                </div>
              </div>
            </div>
            
            <!-- Card das Volatilidades Gerais -->
            <div class="metric-card">
              <div class="text-sm text-gray-400 mb-1">Indicadores</div>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-sm text-gray-300">VI Geral:</span>
                  <span id="ivMean" class="text-sm font-medium text-orange-300">--</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-sm text-gray-300">C/P Ratio:</span>
                  <span id="callPutRatio" class="text-sm font-medium text-yellow-400">--</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-sm text-gray-300">Spread C-P:</span>
                  <span id="callPutSpread" class="text-sm font-medium text-purple-400">--</span>
                </div>
              </div>
            </div>
            
          </div>
        </div>
      </div>

      <!-- Gráficos -->
      <div id="chartsSection" class="mb-8 hidden">
        
        <!-- Gráfico Principal - Preço -->
        <div class="vi-card p-6 mb-6">
          <h4 class="text-xl font-bold mb-4 text-white">
            <i class="fas fa-chart-line mr-2"></i>Evolução do Preço
          </h4>
          <div class="chart-container" style="height: 350px;">
            <div id="priceChart" style="width: 100%; height: 100%;"></div>
          </div>
        </div>

        
        <!-- Gráfico Calls vs Puts -->
        <div class="vi-card p-6 mb-6">
          <h4 class="text-xl font-bold mb-4 text-white">
            <i class="fas fa-balance-scale mr-2"></i>VI Calls vs Puts - Sentimento do Mercado
          </h4>
          <div class="mb-4 text-sm text-gray-300">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="flex items-center">
                <div class="w-3 h-3 bg-green-400 rounded-full mr-2"></div>
                <span><strong>Calls (Verde):</strong> VI alta = Otimismo excessivo</span>
              </div>
              <div class="flex items-center">
                <div class="w-3 h-3 bg-red-400 rounded-full mr-2"></div>
                <span><strong>Puts (Vermelho):</strong> VI alta = Medo/proteção</span>
              </div>
            </div>
          </div>
          <div class="chart-container" style="height: 350px;">
            <div id="callsPutsChart" style="width: 100%; height: 100%;"></div>
          </div>
  
        </div>

        <!-- Gráfico VI vs Vol Histórica -->
        <div class="vi-card p-6 mb-6">
          <h4 class="text-xl font-bold mb-4 text-white">
            <i class="fas fa-chart-area mr-2"></i>Volatilidade Implícita vs Histórica
          </h4>
          <div class="chart-container" style="height: 350px;">
            <div id="volatilityChart" style="width: 100%; height: 100%;"></div>
          </div>
        </div>

        <!-- Gráfico do Sinal com Quartis -->
        <div class="vi-card p-6 mb-6">
          <h4 class="text-xl font-bold mb-4 text-white">
            <i class="fas fa-chart-bar mr-2"></i>Quartis da Volatilidade Implícita
          </h4>
          <div class="chart-container" style="height: 400px;">
            <div id="signalChart" style="width: 100%; height: 100%;"></div>
          </div>
        </div>

      </div>

    </div>
  </div>

  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    // Configurações
    const API_BASE = window.location.origin + '/api/vi';
    
    // Elementos DOM
    const stockInput = document.getElementById('stockInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const statusMsg = document.getElementById('statusMsg');
    const mainSignal = document.getElementById('mainSignal');
    const chartsSection = document.getElementById('chartsSection');
    
    // Função do expander
    function toggleInfo() {
      const content = document.getElementById('infoContent');
      const icon = document.getElementById('infoIcon');
      
      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        content.style.animation = 'fadeIn 0.5s ease-in-out';
        icon.classList.remove('fa-info-circle');
        icon.classList.add('fa-times');
      } else {
        content.style.animation = 'fadeOut 0.3s ease-in-out';
        setTimeout(() => {
          content.classList.add('hidden');
        }, 300);
        icon.classList.remove('fa-times');
        icon.classList.add('fa-info-circle');
      }
    }
    window.toggleInfo = toggleInfo;
    
    // Funções utilitárias
    function showStatus(message, type = 'info') {
      const bgClass = type === 'success' ? 'bg-green-600 bg-opacity-20 border-green-500 border-opacity-30' : 
                     type === 'error' ? 'bg-red-600 bg-opacity-20 border-red-500 border-opacity-30' : 
                     'bg-blue-600 bg-opacity-20 border-blue-500 border-opacity-30';
      
      statusMsg.className = `mb-6 p-4 rounded-lg border backdrop-blur-sm ${bgClass}`;
      statusMsg.textContent = message;
      statusMsg.classList.remove('hidden');
      
      setTimeout(() => statusMsg.classList.add('hidden'), 5000);
    }
    
    function formatCurrency(value) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(value);
    }
    
    function setLoading(button, loading) {
      if (loading) {
        button.classList.add('loading');
        button.innerHTML = '<span class="spinner mr-2"></span>Analizar';
      } else {
        button.classList.remove('loading');
        button.innerHTML = '<i class="fas fa-chart-area mr-2"></i>Analzar';
      }
    }
    
    // Testar conectividade da API
    async function testAPI() {
      try {
        const response = await fetch(`${API_BASE}/health`);
        const data = await response.json();
        
        if (response.ok) {
          document.getElementById('apiStatus').className = 'w-8 h-8 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-full flex items-center justify-center relative';
          return true;
        } else {
          throw new Error('API retornou erro');
        }
      } catch (error) {
        document.getElementById('apiStatus').className = 'w-8 h-8 bg-red-500 bg-opacity-10 border border-red-500 border-opacity-30 rounded-full flex items-center justify-center relative';
        return false;
      }
    }
    
    // Analisar ação individual
    // Analisar ação individual
    async function analyzeStock() {
      const symbol = stockInput.value.trim().toUpperCase();
      const period = 252; // Fixo em 1 ano
      
      if (!symbol) {
        showStatus('Digite o código de uma ação', 'error');
        return;
      }
      
      const cleanSymbol = symbol.replace('.SA', '');
      
      setLoading(analyzeBtn, true);
      showStatus('Executando análise de volatilidade implícita separando calls e puts (1 ano)...', 'info');
      
      try {
        const url = `${API_BASE}/analyze/${cleanSymbol}?period_days=${period}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (response.ok && data.success) {
          displayAnalysis(data);
          showStatus(`Análise de ${cleanSymbol} concluída com sucesso!`, 'success');
        } else {
          const errorMsg = data.error || `Erro HTTP ${response.status}`;
          showStatus(errorMsg, 'error');
        }
      } catch (error) {
        showStatus('Erro ao conectar com o servidor', 'error');
      }
      
      setLoading(analyzeBtn, false);
    }
    
    // Exibir análise individual
    function displayAnalysis(data) {
      displayMainSignal(data);
      
      if (data.chart_data) {
        displayCharts(data);
      }
      
      mainSignal.classList.remove('hidden');
      chartsSection.classList.remove('hidden');
    }
    
    // Exibir sinal principal
    function displayMainSignal(data) {
      const signal = data.current_signal || 0;
      const interpretation = data.signal_interpretation || {};
      
      // Determinar classe do sinal baseado nos quartis
      let signalClass = 'signal-q2';
      if (signal >= 60) signalClass = 'signal-q4';
      else if (signal >= 20) signalClass = 'signal-q3';
      else if (signal >= -20) signalClass = 'signal-q2';
      else signalClass = 'signal-q1';
      
      // Atualizar indicador do sinal
      const signalIndicator = document.getElementById('signalIndicator');
      signalIndicator.innerHTML = `
        <div class="signal-indicator ${signalClass}">
          <i class="fas fa-chart-bar mr-2"></i>
          ${interpretation.status || 'INDEFINIDO'}
        </div>
      `;
      
      // Atualizar progress ring
      updateProgressRing(signal);
      
      // Atualizar indicador de quartil na barra
      updateQuartileIndicator(signal);
      
      // Dados complementares
      document.getElementById('signalValue').textContent = getQuartileLabel(signal);
      document.getElementById('currentPrice').textContent = formatCurrency(data.current_price || 0);
      document.getElementById('signalConfidence').textContent = interpretation.confidence || '--';
      
      
      // NOVOS CAMPOS - VI das Calls e Puts
      let viCallsCurrent = '--', viPutsCurrent = '--';
      let viCallsStatus = '--', viPutsStatus = '--';
      
      if (data.chart_data && data.chart_data.daily_metrics) {
        const lastMetric = data.chart_data.daily_metrics[data.chart_data.daily_metrics.length - 1];
        
        if (lastMetric && lastMetric.iv_call) {
          viCallsCurrent = `${lastMetric.iv_call.toFixed(1)}%`;
          viCallsStatus = lastMetric.iv_call > (data.iv_call_mean || 0) ? 'Acima da média' : 'Abaixo da média';
        }
        
        if (lastMetric && lastMetric.iv_put) {
          viPutsCurrent = `${lastMetric.iv_put.toFixed(1)}%`;
          viPutsStatus = lastMetric.iv_put > (data.iv_put_mean || 0) ? 'Acima da média' : 'Abaixo da média';
        }
      }
      
      document.getElementById('viCallsCurrent').textContent = viCallsCurrent;
      document.getElementById('viCallsMean').textContent = data.iv_call_mean ? `${data.iv_call_mean.toFixed(1)}%` : '--';
      document.getElementById('viCallsStatus').textContent = viCallsStatus;
      
      document.getElementById('viPutsCurrent').textContent = viPutsCurrent;
      document.getElementById('viPutsMean').textContent = data.iv_put_mean ? `${data.iv_put_mean.toFixed(1)}%` : '--';
      document.getElementById('viPutsStatus').textContent = viPutsStatus;
      
      // Volatilidades gerais
      document.getElementById('ivMean').textContent = data.iv_mean ? `${data.iv_mean.toFixed(1)}%` : '--';
      document.getElementById('volHistMean').textContent = data.vol_hist_mean ? `${data.vol_hist_mean.toFixed(1)}%` : '--';
      
      // Call/Put Ratio e Spread
      if (data.iv_call_mean && data.iv_put_mean) {
        const cpRatio = (data.iv_call_mean / data.iv_put_mean).toFixed(2);
        const cpSpread = (data.iv_call_mean - data.iv_put_mean).toFixed(1);
        
        document.getElementById('callPutRatio').textContent = cpRatio;
        document.getElementById('callPutSpread').textContent = `${cpSpread}%`;
      } else {
        document.getElementById('callPutRatio').textContent = '--';
        document.getElementById('callPutSpread').textContent = '--';
      }
    }
    
    // Obter label do quartil
    function getQuartileLabel(signal) {
      if (signal >= 60) return 'Q4';
      else if (signal >= 20) return 'Q3';
      else if (signal >= -20) return 'Q2';
      else return 'Q1';
    }
    
    // Atualizar indicador de quartil na barra
    function updateQuartileIndicator(signal) {
      const indicator = document.getElementById('quartileIndicator');
      
      // Mapear sinal (-100 a +100) para posição na barra (0% a 100%)
      let position;
      if (signal >= 60) {
        position = 87.5; // Centro do Q4
      } else if (signal >= 20) {
        position = 62.5; // Centro do Q3
      } else if (signal >= -20) {
        position = 37.5; // Centro do Q2
      } else {
        position = 12.5; // Centro do Q1
      }
      
      indicator.style.left = `${position}%`;
    }
    
    // Atualizar progress ring
    function updateProgressRing(signal) {
      const circle = document.getElementById('progressCircle');
      const radius = 52;
      const circumference = 2 * Math.PI * radius;
      
      // Normalizar sinal para quartis (0-100%)
      let normalizedSignal;
      if (signal >= 60) {
        normalizedSignal = 87.5; // Q4
      } else if (signal >= 20) {
        normalizedSignal = 62.5; // Q3
      } else if (signal >= -20) {
        normalizedSignal = 37.5; // Q2
      } else {
        normalizedSignal = 12.5; // Q1
      }
      
      const offset = circumference - (normalizedSignal / 100) * circumference;
      circle.style.strokeDashoffset = offset;
      
      // Cor baseada no quartil
      if (signal >= 60) {
        circle.style.stroke = '#10b981'; // Verde Q4
      } else if (signal >= 20) {
        circle.style.stroke = '#22c55e'; // Verde claro Q3
      } else if (signal >= -20) {
        circle.style.stroke = '#6b7280'; // Cinza Q2
      } else {
        circle.style.stroke = '#ef4444'; // Vermelho Q1
      }
    }
    
    // Exibir gráficos
    function displayCharts(data) {
      if (!data.chart_data) return;
      
      const chartData = data.chart_data;
      
      const baseConfig = {
        responsive: true,
        displayModeBar: false,
        autosize: true
      };
      
      const baseLayout = {
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent',
        font: { color: 'white', size: 12 },
        margin: { t: 20, r: 20, b: 40, l: 60 },
        showlegend: true,
        autosize: true,
        xaxis: {
          gridcolor: 'rgba(255,255,255,0.1)',
          zerolinecolor: 'rgba(255,255,255,0.1)',
          type: 'date'
        },
        yaxis: {
          gridcolor: 'rgba(255,255,255,0.1)',
          zerolinecolor: 'rgba(255,255,255,0.1)'
        }
      };
      
      setTimeout(() => {
        
        // 1. Gráfico de Preço
        if (chartData.prices) {
          try {
            const priceTrace = {
              x: chartData.prices.dates,
              y: chartData.prices.values,
              type: 'scatter',
              mode: 'lines',
              name: 'Preço de Fechamento',
              line: { color: '#1f77b4', width: 2 },
              hovertemplate: '<b>Data:</b> %{x}<br><b>Preço:</b> R$ %{y:.2f}<extra></extra>'
            };
            
            const priceLayout = {
              ...baseLayout,
              yaxis: {
                ...baseLayout.yaxis,
                title: 'Preço (R$)'
              }
            };
            
            Plotly.newPlot('priceChart', [priceTrace], priceLayout, baseConfig);
          } catch (error) {
            console.error('Erro no gráfico de preço:', error);
          }
        }
        
        // 2. Gráfico Calls vs Puts
        try {
          const callsPutsTraces = [];
          
          if (chartData.daily_metrics && chartData.daily_metrics.length > 0) {
            const callsData = chartData.daily_metrics.filter(d => d.iv_call !== undefined && d.iv_call !== null);
            const putsData = chartData.daily_metrics.filter(d => d.iv_put !== undefined && d.iv_put !== null);
            
            if (callsData.length > 0) {
              callsPutsTraces.push({
                x: callsData.map(d => d.date),
                y: callsData.map(d => d.iv_call),
                type: 'scatter',
                mode: 'lines',
                name: 'VI Calls',
                line: { color: '#22c55e', width: 3 },
                hovertemplate: '<b>Data:</b> %{x}<br><b>VI Calls:</b> %{y:.1f}%<extra></extra>'
              });
              
              // Linha da média das calls
              const callsMean = data.iv_call_mean;
              if (callsMean) {
                callsPutsTraces.push({
                  x: [callsData[0].date, callsData[callsData.length - 1].date],
                  y: [callsMean, callsMean],
                  type: 'scatter',
                  mode: 'lines',
                  name: `Média Calls: ${callsMean.toFixed(1)}%`,
                  line: { color: '#22c55e', width: 1, dash: 'dot' },
                  showlegend: true,
                  hoverinfo: 'skip'
                });
              }
            }
            
            if (putsData.length > 0) {
              callsPutsTraces.push({
                x: putsData.map(d => d.date),
                y: putsData.map(d => d.iv_put),
                type: 'scatter',
                mode: 'lines',
                name: 'VI Puts',
                line: { color: '#ef4444', width: 3 },
                hovertemplate: '<b>Data:</b> %{x}<br><b>VI Puts:</b> %{y:.1f}%<extra></extra>'
              });
              
              // Linha da média das puts
              const putsMean = data.iv_put_mean;
              if (putsMean) {
                callsPutsTraces.push({
                  x: [putsData[0].date, putsData[putsData.length - 1].date],
                  y: [putsMean, putsMean],
                  type: 'scatter',
                  mode: 'lines',
                  name: `Média Puts: ${putsMean.toFixed(1)}%`,
                  line: { color: '#ef4444', width: 1, dash: 'dot' },
                  showlegend: true,
                  hoverinfo: 'skip'
                });
              }
            }
            
            if (callsPutsTraces.length > 0) {
              const callsPutsLayout = {
                ...baseLayout,
                yaxis: {
                  ...baseLayout.yaxis,
                  title: 'Volatilidade Implícita (%)'
                }
              };
              
              Plotly.newPlot('callsPutsChart', callsPutsTraces, callsPutsLayout, baseConfig);
              updateSentimentInterpretation(data);
              
            }
          }
        } catch (error) {
          console.error('Erro no gráfico calls vs puts:', error);
        }
        
        // 3. Gráfico de Volatilidade
        try {
          const volatilityTraces = [];
          
          if (chartData.daily_metrics && chartData.daily_metrics.length > 0) {
            const viData = chartData.daily_metrics.filter(d => d.iv_avg !== undefined && d.iv_avg !== null);
            
            if (viData.length > 0) {
              volatilityTraces.push({
                x: viData.map(d => d.date),
                y: viData.map(d => d.iv_avg),
                type: 'scatter',
                mode: 'lines',
                name: 'Volatilidade Implícita',
                line: { color: '#ff7f0e', width: 2 },
                hovertemplate: '<b>Data:</b> %{x}<br><b>VI:</b> %{y:.1f}%<extra></extra>'
              });
              
              const ivMean = viData.reduce((sum, d) => sum + d.iv_avg, 0) / viData.length;
              volatilityTraces.push({
                x: [viData[0].date, viData[viData.length - 1].date],
                y: [ivMean, ivMean],
                type: 'scatter',
                mode: 'lines',
                name: `VI Média: ${ivMean.toFixed(1)}%`,
                line: { color: '#ff7f0e', width: 1, dash: 'dot' },
                showlegend: false,
                hoverinfo: 'skip'
              });
            }
          }
          
          if (chartData.vol_hist && chartData.vol_hist.dates.length > 0) {
            const volHistData = chartData.vol_hist.values.filter(v => v > 0);
            if (volHistData.length > 0) {
              volatilityTraces.push({
                x: chartData.vol_hist.dates,
                y: chartData.vol_hist.values,
                type: 'scatter',
                mode: 'lines',
                name: 'Volatilidade Histórica (30d)',
                line: { color: '#2ca02c', width: 2, dash: 'dash' },
                hovertemplate: '<b>Data:</b> %{x}<br><b>Vol Hist:</b> %{y:.1f}%<extra></extra>'
              });
            }
          }
          
          if (volatilityTraces.length > 0) {
            const volatilityLayout = {
              ...baseLayout,
              yaxis: {
                ...baseLayout.yaxis,
                title: 'Volatilidade (%)'
              }
            };
            
            Plotly.newPlot('volatilityChart', volatilityTraces, volatilityLayout, baseConfig);
          }
        } catch (error) {
          console.error('Erro no gráfico de volatilidade:', error);
        }
        


        // 4. Gráfico dos Quartis
        if (chartData.daily_metrics && chartData.daily_metrics.length > 0) {
          try {
            const quartileData = chartData.daily_metrics.filter(d => d.options_signal !== undefined);
            
            if (quartileData.length > 0) {
              // Cores baseadas nos quartis
              const colors = quartileData.map(d => {
                const signal = d.options_signal;
                if (signal >= 60) return '#10b981';      // Q4 - Verde
                else if (signal >= 20) return '#22c55e'; // Q3 - Verde claro
                else if (signal >= -20) return '#6b7280'; // Q2 - Cinza
                else return '#ef4444';                    // Q1 - Vermelho
              });
              
              // Status text para hover
              const statusText = quartileData.map(d => {
                const signal = d.options_signal;
                if (signal >= 60) return 'Q4: VI muito alta - Vender volatilidade';
                else if (signal >= 20) return 'Q3: VI alta - Favorável para vender';
                else if (signal >= -20) return 'Q2: VI normal - Condições neutras';
                else return 'Q1: VI baixa - Comprar volatilidade';
              });
              
              const quartileTrace = {
                x: quartileData.map(d => d.date),
                y: quartileData.map(d => d.options_signal),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Quartil da VI',
                line: { color: '#1f77b4', width: 3 },
                marker: { 
                  size: 6, 
                  color: colors,
                  line: { width: 1, color: 'white' }
                },
                text: statusText,
                hovertemplate: '<b>Data:</b> %{x}<br><b>Quartil:</b> %{text}<extra></extra>'
              };
              
              const quartileLayout = {
                ...baseLayout,
                height: 380,
                yaxis: {
                  ...baseLayout.yaxis,
                  title: 'Quartil da VI',
                  range: [-100, 100],
                  tickvals: [-75, -25, 25, 75],
                  ticktext: ['Q1', 'Q2', 'Q3', 'Q4']
                },
                shapes: [
                  // Zonas dos quartis
                  { type: 'rect', x0: quartileData[0].date, x1: quartileData[quartileData.length-1].date, y0: 60, y1: 100, fillcolor: 'rgba(16, 185, 129, 0.15)', layer: 'below', line: { width: 0 } },
                  { type: 'rect', x0: quartileData[0].date, x1: quartileData[quartileData.length-1].date, y0: 20, y1: 60, fillcolor: 'rgba(34, 197, 94, 0.15)', layer: 'below', line: { width: 0 } },
                  { type: 'rect', x0: quartileData[0].date, x1: quartileData[quartileData.length-1].date, y0: -20, y1: 20, fillcolor: 'rgba(107, 114, 128, 0.15)', layer: 'below', line: { width: 0 } },
                  { type: 'rect', x0: quartileData[0].date, x1: quartileData[quartileData.length-1].date, y0: -100, y1: -20, fillcolor: 'rgba(239, 68, 68, 0.15)', layer: 'below', line: { width: 0 } },
                  
                  // Linhas de separação dos quartis
                  { type: 'line', x0: quartileData[0].date, x1: quartileData[quartileData.length-1].date, y0: 60, y1: 60, line: { color: '#10b981', width: 1, dash: 'dash' } },
                  { type: 'line', x0: quartileData[0].date, x1: quartileData[quartileData.length-1].date, y0: 20, y1: 20, line: { color: '#22c55e', width: 1, dash: 'dash' } },
                  { type: 'line', x0: quartileData[0].date, x1: quartileData[quartileData.length-1].date, y0: -20, y1: -20, line: { color: '#ef4444', width: 1, dash: 'dash' } }
                ],
                annotations: [
                  { x: quartileData[Math.floor(quartileData.length * 0.85)].date, y: 80, text: 'Q4 - VI MUITO ALTA', showarrow: false, font: { size: 10, color: '#10b981' }, xanchor: 'left' },
                  { x: quartileData[Math.floor(quartileData.length * 0.85)].date, y: 40, text: 'Q3 - VI ALTA', showarrow: false, font: { size: 10, color: '#22c55e' }, xanchor: 'left' },
                  { x: quartileData[Math.floor(quartileData.length * 0.85)].date, y: 0, text: 'Q2 - VI NORMAL', showarrow: false, font: { size: 10, color: '#6b7280' }, xanchor: 'left' },
                  { x: quartileData[Math.floor(quartileData.length * 0.85)].date, y: -60, text: 'Q1 - VI BAIXA', showarrow: false, font: { size: 10, color: '#ef4444' }, xanchor: 'left' }
                ]
              };
              
              Plotly.newPlot('signalChart', [quartileTrace], quartileLayout, baseConfig);
            }
          } catch (error) {
            console.error('Erro no gráfico de quartis:', error);
          }
        }
        
      }, 100);
      
    }
    
    function updateSentimentInterpretation(data) {
      const sentiment = data.sentiment_analysis;
      
      if (!sentiment || !sentiment.ratio) {
        document.getElementById('sentimentDescription').textContent = 'Dados insuficientes para análise de sentimento.';
        return;
      }
      
      const sentimentType = sentiment.sentiment;
      
      // Badge do sentimento com mais categorias
      const badge = document.getElementById('sentimentBadge');
      let badgeClass, badgeText;

      switch(sentimentType) {
        case 'bullish':
          badgeClass = 'bg-green-600/30 text-green-300 border border-green-500/40';
          badgeText = 'CALLS CARAS';
          break;
        case 'bearish':
          badgeClass = 'bg-red-600/30 text-red-300 border border-red-500/40';
          badgeText = 'PUTS CARAS';
          break;
        case 'mild_bullish':
          badgeClass = 'bg-green-500/20 text-green-400 border border-green-500/30';
          badgeText = 'CALLS +CARAS';
          break;
        case 'mild_bearish':
          badgeClass = 'bg-red-500/20 text-red-400 border border-red-500/30';
          badgeText = 'PUTS +CARAS';
          break;
        default:
          badgeClass = 'bg-gray-500/20 text-gray-400 border border-gray-500/30';
          badgeText = 'EQUILIBRADO';
      }
      badge.className = `px-3 py-1 rounded-full text-sm font-bold ${badgeClass}`;
      badge.textContent = badgeText;
      
      // Descrição e estratégia
      document.getElementById('sentimentDescription').textContent = sentiment.description;
      document.getElementById('sentimentStrategy').textContent = sentiment.strategy;
      
      // Métricas numéricas
      document.getElementById('sentimentRatio').textContent = sentiment.ratio.toFixed(2);
      document.getElementById('sentimentSpread').textContent = `${sentiment.spread > 0 ? '+' : ''}${sentiment.spread.toFixed(1)}%`;
      
      // Confiança baseada no nível de stress
      let confidence;
      if (sentiment.market_stress === 'alto') {
        confidence = 'Alta'; // Stress alto = sinais mais confiáveis
      } else if (sentiment.market_stress === 'moderado') {
        confidence = 'Média';
      } else {
        confidence = 'Baixa'; // Mercado calmo = sinais mais fracos
      }
      
      document.getElementById('sentimentConfidence').textContent = confidence;
    }

    // Event Listeners
    analyzeBtn.addEventListener('click', analyzeStock);
    
    stockInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') analyzeStock();
    });
    
    
    // Inicialização
    async function initialize() {
      const apiConnected = await testAPI();
      
      if (apiConnected) {
        showStatus('Sistema de Análise Calls vs Puts carregado! Digite uma ação para analisar.', 'info');
      } else {
        showStatus('Aviso: Erro na conectividade da API. Verifique se o servidor está rodando.', 'error');
      }
      
      // Foco no campo de input para facilitar a digitação
      stockInput.focus();
    }

    // Inicializar quando a página carregar
    initialize();
  </script>
</body>
</html>