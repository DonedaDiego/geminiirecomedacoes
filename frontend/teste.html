<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beta Regressivo - Geminii</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 1px solid rgba(0, 255, 170, 0.3);
            box-shadow: 0 0 20px rgba(0, 255, 170, 0.1);
        }

        .header h1 {
            font-size: 2.5em;
            color: #00FFAA;
            text-shadow: 0 0 10px rgba(0, 255, 170, 0.5);
            margin-bottom: 10px;
        }

        .header p {
            color: #AAB7FF;
            font-size: 1.1em;
        }

        .controls-section {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 0, 127, 0.3);
            box-shadow: 0 0 20px rgba(255, 0, 127, 0.1);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #AAB7FF;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid rgba(0, 191, 255, 0.3);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.5);
            color: #ffffff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #00BFFF;
            box-shadow: 0 0 10px rgba(0, 191, 255, 0.3);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #00FFAA, #00BFFF);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 170, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #FF007F, #FF6500);
            color: #fff;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 0, 127, 0.4);
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #00FFAA;
            font-size: 1.2em;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 255, 170, 0.3);
            border-radius: 50%;
            border-top-color: #00FFAA;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(0, 191, 255, 0.3);
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.3);
            border: none;
            color: #AAB7FF;
            font-size: 16px;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
        }

        .tab.active {
            background: linear-gradient(45deg, #00BFFF, #9400D3);
            color: #ffffff;
            box-shadow: 0 0 10px rgba(0, 191, 255, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(148, 0, 211, 0.3);
            box-shadow: 0 0 20px rgba(148, 0, 211, 0.1);
        }

        .chart-title {
            color: #9400D3;
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 10px rgba(148, 0, 211, 0.5);
        }

        .chart-wrapper {
            position: relative;
            height: 600px;
            margin-bottom: 20px;
        }

        .plotly-chart {
            width: 100%;
            height: 100%;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analysis-card {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(0, 255, 170, 0.3);
            box-shadow: 0 0 15px rgba(0, 255, 170, 0.1);
            text-align: center;
        }

        .analysis-card h3 {
            color: #00FFAA;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .analysis-card .value {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .analysis-card .description {
            color: #AAB7FF;
            font-size: 0.9em;
        }

        .status-compra { color: #00FFAA; }
        .status-venda { color: #FF3232; }
        .status-neutro { color: #969696; }

        .proximity-nova-compra { color: #00FFAA; }
        .proximity-preparando-compra { color: #FFFF00; }
        .proximity-iminente-venda { color: #FF3232; }
        .proximity-preparando-venda { color: #FFA500; }
        .proximity-neutro { color: #969696; }

        .bulk-table-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 165, 0, 0.3);
            box-shadow: 0 0 20px rgba(255, 165, 0, 0.1);
            overflow-x: auto;
        }

        .bulk-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .bulk-table th,
        .bulk-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bulk-table th {
            background: rgba(0, 0, 0, 0.5);
            color: #FFA500;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .bulk-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .trades-table-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border: 1px solid rgba(255, 0, 127, 0.3);
            box-shadow: 0 0 20px rgba(255, 0, 127, 0.1);
            overflow-x: auto;
        }

        .trades-table {
            width: 100%;
            border-collapse: collapse;
        }

        .trades-table th,
        .trades-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .trades-table th {
            background: rgba(0, 0, 0, 0.5);
            color: #FF007F;
            font-weight: 600;
            text-transform: uppercase;
        }

        .trade-gain { color: #00FFAA; }
        .trade-stop { color: #FF3232; }

        .error-message {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #FF6B6B;
        }

        .success-message {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #51CF66;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .chart-wrapper {
                height: 400px;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Beta Regressivo</h1>
            <p>Análise Avançada de Sinais com Regressão Móvel - Geminii Research</p>
        </div>

        <div class="controls-section">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('individual')">Análise Individual</button>
                <button class="tab" onclick="switchTab('bulk')">Análise em Lote</button>
            </div>

            <!-- Análise Individual -->
            <div id="individual-tab" class="tab-content active">
                <div class="controls-grid">
                    <div class="form-group">
                        <label for="individual-symbol">Código da Ação:</label>
                        <input type="text" id="individual-symbol" placeholder="Ex: PETR4" maxlength="10">
                    </div>
                    <div class="form-group">
                        <label for="individual-timeframe">Timeframe:</label>
                        <select id="individual-timeframe">
                            <option value="1d">Diário (1D)</option>
                            <option value="4h">4 Horas (4H)</option>
                            <option value="1h">1 Hora (1H)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="individual-anos">Período (Anos):</label>
                        <select id="individual-anos">
                            <option value="1">1 Ano</option>
                            <option value="2" selected>2 Anos</option>
                            <option value="3">3 Anos</option>
                            <option value="5">5 Anos</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="analyzeIndividual()">
                        📊 Analisar Ação
                    </button>
                </div>
            </div>

            <!-- Análise em Lote -->
            <div id="bulk-tab" class="tab-content">
                <div class="controls-grid">
                    <div class="form-group">
                        <label for="bulk-timeframe">Timeframe:</label>
                        <select id="bulk-timeframe">
                            <option value="1d">Diário (1D)</option>
                            <option value="4h">4 Horas (4H)</option>
                            <option value="1h">1 Hora (1H)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bulk-anos">Período (Anos):</label>
                        <select id="bulk-anos">
                            <option value="1">1 Ano</option>
                            <option value="2" selected>2 Anos</option>
                            <option value="3">3 Anos</option>
                            <option value="5">5 Anos</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="analyzeBulk()">
                        📈 Analisar Carteira Padrão
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading" style="display: none;">
            Processando análise...
        </div>

        <!-- Mensagens -->
        <div id="messages"></div>

        <!-- Análise Individual - Resultados -->
        <div id="individual-results" style="display: none;">
            <!-- Cards de Análise -->
            <div class="analysis-grid" id="analysis-cards"></div>

            <!-- Gráfico Plotly -->
            <div class="chart-container">
                <h3 class="chart-title">📊 Gráfico Completo (Plotly)</h3>
                <div id="plotly-chart" class="plotly-chart"></div>
            </div>

            <!-- Gráfico Chart.js -->
            <div class="chart-container">
                <h3 class="chart-title">📈 Análise Simplificada (Últimos 60 Períodos)</h3>
                <div class="chart-wrapper">
                    <canvas id="chartjs-chart"></canvas>
                </div>
            </div>

            <!-- Histórico de Trades -->
            <div class="trades-table-container">
                <h3 class="chart-title">💰 Histórico de Trades</h3>
                <div id="trades-history"></div>
            </div>
        </div>

        <!-- Análise em Lote - Resultados -->
        <div id="bulk-results" style="display: none;">
            <div class="bulk-table-container">
                <h3 class="chart-title">📋 Resumo da Carteira</h3>
                <div id="bulk-summary"></div>
                <table class="bulk-table" id="bulk-table">
                    <thead>
                        <tr>
                            <th>Ação</th>
                            <th>Sinal</th>
                            <th>Status Proximidade</th>
                            <th>Preço</th>
                            <th>Beta0 Norm</th>
                            <th>Ret. Bruto</th>
                            <th>Ret. Líquido</th>
                            <th>Trades</th>
                        </tr>
                    </thead>
                    <tbody id="bulk-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let individualChart = null;

        // Função para alternar entre abas
        function switchTab(tabName) {
            // Remover active de todas as abas
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Ativar aba selecionada
            document.querySelector(`#${tabName}-tab`).classList.add('active');
            document.querySelector(`button[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Esconder resultados
            document.getElementById('individual-results').style.display = 'none';
            document.getElementById('bulk-results').style.display = 'none';
        }

        // Função para mostrar loading
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('messages').innerHTML = '';
        }

        // Função para esconder loading
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Função para mostrar mensagem
        function showMessage(message, type = 'error') {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="${type}-message">${message}</div>`;
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 5000);
        }

        // Análise Individual
        async function analyzeIndividual() {
            const symbol = document.getElementById('individual-symbol').value.trim().toUpperCase();
            const timeframe = document.getElementById('individual-timeframe').value;
            const anos = document.getElementById('individual-anos').value;

            if (!symbol) {
                showMessage('Por favor, digite o código da ação');
                return;
            }

            showLoading();
            document.getElementById('individual-results').style.display = 'none';

            try {
                const response = await fetch('/beta_regression/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        timeframe: timeframe,
                        anos: parseInt(anos)
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayIndividualResults(data);
                } else {
                    showMessage(`Erro: ${data.error}`);
                }
            } catch (error) {
                showMessage(`Erro de conexão: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Função para exibir resultados individuais
        function displayIndividualResults(data) {
            const analysisData = data.analysis_data;
            
            // Cards de análise
            const cardsHtml = `
                <div class="analysis-card">
                    <h3>💹 Sinal Atual</h3>
                    <div class="value status-${analysisData.status.toLowerCase()}">${analysisData.status}</div>
                    <div class="description">Direção recomendada</div>
                </div>
                <div class="analysis-card">
                    <h3>💰 Preço Atual</h3>
                    <div class="value">R$ ${analysisData.last_close}</div>
                    <div class="description">Último fechamento</div>
                </div>
                <div class="analysis-card">
                    <h3>📊 Beta0 Norm</h3>
                    <div class="value">${analysisData.beta0_norm}</div>
                    <div class="description">Indicador principal</div>
                </div>
                <div class="analysis-card">
                    <h3>🎯 Status Proximidade</h3>
                    <div class="value proximity-${analysisData.proximity_status.toLowerCase().replace(/ /g, '-')}">${analysisData.proximity_status}</div>
                    <div class="description">Situação atual</div>
                </div>
                <div class="analysis-card">
                    <h3>📈 Retorno Bruto</h3>
                    <div class="value">${analysisData.acc_returns_final}%</div>
                    <div class="description">Performance sem taxas</div>
                </div>
                <div class="analysis-card">
                    <h3>💸 Retorno Líquido</h3>
                    <div class="value">${analysisData.acc_returns_after_fees_final}%</div>
                    <div class="description">Performance com taxas</div>
                </div>
            `;
            
            document.getElementById('analysis-cards').innerHTML = cardsHtml;
            
            // Gráfico Plotly
            if (data.chart_html) {
                document.getElementById('plotly-chart').innerHTML = data.chart_html;
            }
            
            // Gráfico Chart.js
            if (data.chart_data) {
                createChartJS(data.chart_data);
            }
            
            // Histórico de trades
            displayTradesHistory(data.trades_history);
            
            document.getElementById('individual-results').style.display = 'block';
            showMessage('Análise concluída com sucesso!', 'success');
        }

        // Função para criar gráfico Chart.js
        function createChartJS(chartData) {
            const ctx = document.getElementById('chartjs-chart').getContext('2d');
            
            // Destruir gráfico anterior
            if (individualChart) {
                individualChart.destroy();
            }
            
            // Criar segmentos coloridos baseados nos sinais
            const datasets = [];
            
            // Linha de preço com cores dinâmicas
            for (let i = 1; i < chartData.prices.length; i++) {
                const signal = chartData.trading_signals[i];
                let color;
                
                if (signal === 1) {
                    color = '#00FFAA'; // Verde para compra
                } else if (signal === -1) {
                    color = '#FF3232'; // Vermelho para venda
                } else {
                    color = '#969696'; // Cinza para neutro
                }
                
                datasets.push({
                    label: '',
                    data: [
                        { x: chartData.labels[i-1], y: chartData.prices[i-1] },
                        { x: chartData.labels[i], y: chartData.prices[i] }
                    ],
                    borderColor: color,
                    backgroundColor: color,
                    borderWidth: 2,
                    pointRadius: 0,
                    showLine: true,
                    tension: 0
                });
            }
            
            // Datasets para legenda
            datasets.push({
                label: 'Sinal de Compra',
                data: [],
                borderColor: '#00FFAA',
                backgroundColor: '#00FFAA',
                borderWidth: 2
            });
            
            datasets.push({
                label: 'Sinal de Venda',
                data: [],
                borderColor: '#FF3232',
                backgroundColor: '#FF3232',
                borderWidth: 2
            });
            
            datasets.push({
                label: 'Neutro',
                data: [],
                borderColor: '#969696',
                backgroundColor: '#969696',
                borderWidth: 2
            });
            
            // Média móvel
            if (chartData.mm) {
                datasets.push({
                    label: 'Média Móvel',
                    data: chartData.mm.map((value, index) => ({ x: chartData.labels[index], y: value })),
                    borderColor: '#FFA500',
                    backgroundColor: 'rgba(255, 165, 0, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    pointRadius: 0
                });
            }
            
            individualChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff',
                                font: { size: 12 },
                                usePointStyle: true,
                                filter: function(item) {
                                    return item.text !== '';
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#FF007F',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#AAB7FF',
                                maxTicksLimit: 10
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#AAB7FF',
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(2);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Função para exibir histórico de trades
        function displayTradesHistory(trades) {
            if (!trades || trades.length === 0) {
                document.getElementById('trades-history').innerHTML = '<p>Nenhum trade registrado no período.</p>';
                return;
            }
            
            let html = `
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>Data Entrada</th>
                            <th>Preço Entrada</th>
                            <th>Data Saída</th>
                            <th>Preço Saída</th>
                            <th>Tipo</th>
                            <th>PnL (%)</th>
                            <th>Resultado</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            trades.forEach(trade => {
                html += `
                    <tr>
                        <td>${trade['Entry Date']}</td>
                        <td>R$ ${trade['Entry Price']}</td>
                        <td>${trade['Exit Date']}</td>
                        <td>R$ ${trade['Exit Price']}</td>
                        <td>${trade.Type}</td>
                        <td class="trade-${trade.Outcome.toLowerCase()}">${trade['PnL (%)']}%</td>
                        <td class="trade-${trade.Outcome.toLowerCase()}">${trade.Outcome}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            document.getElementById('trades-history').innerHTML = html;
        }

        // Análise em Lote
        async function analyzeBulk() {
            const timeframe = document.getElementById('bulk-timeframe').value;
            const anos = document.getElementById('bulk-anos').value;

            showLoading();
            document.getElementById('bulk-results').style.display = 'none';

            try {
                const response = await fetch('/beta_regression/bulk_analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        timeframe: timeframe,
                        anos: parseInt(anos)
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayBulkResults(data);
                } else {
                    showMessage(`Erro: ${data.error}`);
                }
            } catch (error) {
                showMessage(`Erro de conexão: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Função para exibir resultados em lote
        function displayBulkResults(data) {
            // Resumo
            const compras = data.results.filter(r => r.status === 'COMPRA').length;
            const vendas = data.results.filter(r => r.status === 'VENDA').length;
            const neutros = data.results.filter(r => r.status === 'NEUTRO').length;
            
            const summaryHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div class="analysis-card">
                        <h3>📊 Total Analisado</h3>
                        <div class="value">${data.total_analyzed}</div>
                        <div class="description">Ações processadas</div>
                    </div>
                    <div class="analysis-card">
                        <h3>🟢 Sinais de Compra</h3>
                        <div class="value status-compra">${compras}</div>
                        <div class="description">Oportunidades</div>
                    </div>
                    <div class="analysis-card">
                        <h3>🔴 Sinais de Venda</h3>
                        <div class="value status-venda">${vendas}</div>
                        <div class="description">Alertas</div>
                    </div>
                    <div class="analysis-card">
                        <h3>⚪ Neutros</h3>
                        <div class="value status-neutro">${neutros}</div>
                        <div class="description">Sem sinal</div>
                    </div>
                    <div class="analysis-card">
                        <h3>❌ Erros</h3>
                        <div class="value">${data.total_errors}</div>
                        <div class="description">Falhas</div>
                    </div>
                </div>
            `;
            
            document.getElementById('bulk-summary').innerHTML = summaryHtml;
            
            // Tabela
            const tbody = document.getElementById('bulk-table-body');
            tbody.innerHTML = '';
            
            data.results.forEach(result => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${result.symbol}</strong></td>
                    <td><span class="status-${result.status.toLowerCase()}">${result.status}</span></td>
                    <td><span class="proximity-${result.proximity_status.toLowerCase().replace(/ /g, '-')}">${result.proximity_status}</span></td>
                    <td>R$ ${result.last_close}</td>
                    <td>${result.beta0_norm}</td>
                    <td class="${result.acc_returns_final >= 0 ? 'trade-gain' : 'trade-stop'}">${result.acc_returns_final}%</td>
                    <td class="${result.acc_returns_after_fees_final >= 0 ? 'trade-gain' : 'trade-stop'}">${result.acc_returns_after_fees_final}%</td>
                    <td>${result.total_trades}</td>
                `;
                
                // Adicionar evento de clique para análise individual
                row.style.cursor = 'pointer';
                row.addEventListener('click', () => {
                    document.getElementById('individual-symbol').value = result.symbol;
                    switchTab('individual');
                    analyzeIndividual();
                });
            });
            
            // Mostrar erros se houver
            if (data.errors && data.errors.length > 0) {
                const errorsHtml = `
                    <div class="error-message">
                        <strong>Erros encontrados:</strong><br>
                        ${data.errors.join('<br>')}
                    </div>
                `;
                document.getElementById('bulk-summary').innerHTML += errorsHtml;
            }
            
            document.getElementById('bulk-results').style.display = 'block';
            showMessage(`Análise em lote concluída! ${data.total_analyzed} ações processadas.`, 'success');
        }

        // Função para formatar status de proximidade
        function formatProximityStatus(status) {
            const statusMap = {
                'NOVA COMPRA': '🚀 NOVA COMPRA',
                'PREPARANDO COMPRA': '🟡 PREPARANDO COMPRA',
                'IMINENTE VENDA': '🔴 IMINENTE VENDA',
                'PREPARANDO VENDA': '🟠 PREPARANDO VENDA',
                'NEUTRO': '⚪ NEUTRO'
            };
            return statusMap[status] || status;
        }

        // Event listeners para Enter key
        document.getElementById('individual-symbol').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analyzeIndividual();
            }
        });

        // Função para verificar saúde do serviço
        async function checkHealth() {
            try {
                const response = await fetch('/beta_regression/health');
                const data = await response.json();
                
                if (data.status === 'OK') {
                    console.log('✅ Serviço Beta Regressivo funcionando:', data.message);
                } else {
                    console.warn('⚠️ Serviço com problemas:', data.message);
                }
            } catch (error) {
                console.error('❌ Erro ao verificar saúde do serviço:', error);
            }
        }

        // Verificar saúde do serviço ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            checkHealth();
            
            // Aplicar tema cyberpunk aos elementos Plotly quando carregarem
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length > 0) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.classList && node.classList.contains('plotly-graph-div')) {
                                // Aplicar estilo cyberpunk ao Plotly
                                node.style.background = 'rgba(0, 0, 0, 0.4)';
                                node.style.borderRadius = '10px';
                            }
                        });
                    }
                });
            });
            
            observer.observe(document.getElementById('plotly-chart'), {
                childList: true,
                subtree: true
            });
        });

        // Função para exportar dados
        function exportBulkData() {
            // Implementar exportação para CSV/Excel se necessário
            console.log('Função de exportação a ser implementada');
        }

        // Função para atualizar automaticamente (opcional)
        function startAutoRefresh() {
            // Implementar refresh automático se necessário
            console.log('Auto-refresh a ser implementado');
        }

        // Adicionar tooltips informativos
        function addTooltips() {
            const tooltips = {
                'Beta0 Norm': 'Indicador normalizado que varia de 0 a 1. Valores > 0.5 indicam tendência de alta.',
                'Status Proximidade': 'Indica a proximidade de sinais de compra ou venda baseado em cruzamentos.',
                'Retorno Bruto': 'Performance da estratégia sem considerar taxas de corretagem.',
                'Retorno Líquido': 'Performance real após descontar todas as taxas.'
            };
            
            // Implementar tooltips se necessário
        }
    </script>
</body>
</html>