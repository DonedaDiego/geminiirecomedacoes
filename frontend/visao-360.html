<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visão 360° - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            secondary: '#8b5cf6',
            accent: '#06b6d4',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            geminii: '#ba39af'
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #0f0f0f;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .mini-chart {
      height: 120px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }
    
    .loading-skeleton {
      background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%);
      background-size: 400% 100%;
      animation: skeleton-loading 1.4s ease-in-out infinite;
    }

    @keyframes skeleton-loading {
      0% { background-position: 100% 50%; }
      100% { background-position: 0 50%; }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #ba39af;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .iv-rank-high {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    .iv-rank-medium {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }

    .iv-rank-low {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .metric-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .metric-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .grid-dashboard {
      display: grid;
      grid-template-columns: 280px 1fr 280px;
      grid-template-rows: auto auto;
      gap: 1.5rem;
      grid-template-areas: 
        "sidebar main-chart iv-panel"
        "hunter-walls hunter-walls hunter-walls";
    }

    .sidebar { 
      grid-area: sidebar; 
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .main-chart { 
      grid-area: main-chart; 
      height: 500px;
    }
    .iv-panel { 
      grid-area: iv-panel; 
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .hunter-walls { 
      grid-area: hunter-walls; 
    }

    @media (max-width: 1280px) {
      .grid-dashboard {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto;
        grid-template-areas: 
          "sidebar"
          "main-chart"
          "iv-panel"
          "hunter-walls";
      }
      
      .main-chart {
        height: 400px;
      }
      
      .sidebar, .iv-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
      }
    }

    .btn-executive {
      background: linear-gradient(135deg, #ba39af, #8b5cf6);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(186, 57, 175, 0.3);
    }

    .btn-executive:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(186, 57, 175, 0.4);
    }

    .chart-container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-confiavel {
      background-color: rgba(16, 185, 129, 0.2);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-neutro {
      background-color: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .status-suspeito {
      background-color: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    /* Estilos para Hunter Walls */
    .letra-hunter-btn {
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }
    
    .letra-hunter-btn.selected {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
    }
    
    .letra-hunter-btn.related {
      background: rgba(99, 102, 241, 0.15) !important;
      border: 1px solid rgba(99, 102, 241, 0.4) !important;
    }

    /* Cores específicas por mês para Hunter */
    .mes-jan { background: rgba(255, 99, 132, 0.2) !important; border-color: rgba(255, 99, 132, 0.4) !important; }
    .mes-fev { background: rgba(54, 162, 235, 0.2) !important; border-color: rgba(54, 162, 235, 0.4) !important; }
    .mes-mar { background: rgba(255, 205, 86, 0.2) !important; border-color: rgba(255, 205, 86, 0.4) !important; }
    .mes-abr { background: rgba(75, 192, 192, 0.2) !important; border-color: rgba(75, 192, 192, 0.4) !important; }
    .mes-mai { background: rgba(153, 102, 255, 0.2) !important; border-color: rgba(153, 102, 255, 0.4) !important; }
    .mes-jun { background: rgba(255, 159, 64, 0.2) !important; border-color: rgba(255, 159, 64, 0.4) !important; }
    .mes-jul { background: rgba(201, 203, 207, 0.2) !important; border-color: rgba(201, 203, 207, 0.4) !important; }
    .mes-ago { background: rgba(255, 99, 255, 0.2) !important; border-color: rgba(255, 99, 255, 0.4) !important; }
    .mes-set { background: rgba(99, 255, 132, 0.2) !important; border-color: rgba(99, 255, 132, 0.4) !important; }
    .mes-out { background: rgba(255, 159, 132, 0.2) !important; border-color: rgba(255, 159, 132, 0.4) !important; }
    .mes-nov { background: rgba(132, 99, 255, 0.2) !important; border-color: rgba(132, 99, 255, 0.4) !important; }
    .mes-dez { background: rgba(255, 206, 84, 0.2) !important; border-color: rgba(255, 206, 84, 0.4) !important; }
  </style>
</head>
<body class="min-h-screen text-white">
  
  <!-- Navigation -->
  <nav class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-opacity-5 border-opacity-10 bg-white border-white border rounded-full px-4 py-3 shadow-xl backdrop-blur-md">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <img src="logo.png" alt="Geminii Logo" class="w-6 h-6 cursor-pointer" onclick="window.location.href='/'">
      </div>
      <div class="hidden md:flex items-center space-x-6 text-xs text-gray-300 ml-8">
        <a href="/dashboard" class="hover:text-white transition-colors">Dashboard</a>
        <span class="text-geminii font-medium">Visão 360° - Análise Executiva</span>
      </div>
      <div class="flex items-center space-x-3 ml-8">
        <div id="apiStatus" class="w-8 h-8 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-full flex items-center justify-center relative">
          <i class="fas fa-chart-line text-green-500 text-xs"></i>
          <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="pt-24 px-4 pb-8">
    <div class="pt-16 pb-8">
      <div class="max-w-[1600px] mx-auto">
        
        <!-- Header with Controls -->
        <div class="text-center mb-6">
          <h1 class="text-3xl md:text-4xl font-bold mb-4">
            <span class="text-geminii font-black">VISÃO 360°</span>
            <span class="text-white font-light">Painel Executivo</span>
          </h1>
          
          <!-- Quick Controls -->
          <div class="flex flex-wrap justify-center gap-4 mb-6">
            <div class="flex items-center gap-2">
              <input type="text" id="ticker" placeholder="PETR4, VALE3..." 
                     class="px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 w-32 text-sm">
              <input type="number" id="flowDays" value="30" min="7" max="90" placeholder="Dias" 
                     class="px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 w-20 text-sm">
              <button onclick="loadCompleteAnalysis()" class="btn-executive text-white px-6 py-2 rounded-lg font-semibold text-sm">
                <i class="fas fa-search mr-1"></i>Analisar
              </button>
            </div>
          </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="grid-dashboard">
          
          <!-- Sidebar - Mini Charts e Controles -->
          <div class="sidebar space-y-4">
            
            <!-- Quick Stats -->
            <div class="card rounded-lg p-4">
              <h3 class="text-sm font-bold text-white mb-3 flex items-center">
                <i class="fas fa-chart-line mr-2 text-geminii"></i>
                Quick Stats
              </h3>
              <div class="space-y-2 text-xs">
                <div class="metric-item rounded p-2">
                  <div class="flex justify-between">
                    <span class="text-gray-400">Preço:</span>
                    <span id="currentPrice" class="text-white font-bold">--</span>
                  </div>
                </div>
                <div class="metric-item rounded p-2">
                  <div class="flex justify-between">
                    <span class="text-gray-400">Volatilidade:</span>
                    <span id="volatilityPercent" class="text-warning font-medium">--</span>
                  </div>
                </div>
                <div class="metric-item rounded p-2">
                  <div class="flex justify-between">
                    <span class="text-gray-400">Regime:</span>
                    <span id="volRegime" class="text-secondary font-medium">--</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sinais de Bandas -->
            <div class="card rounded-lg p-4">
              <h3 class="text-sm font-bold text-white mb-3 flex items-center">
                <i class="fas fa-chart-area mr-2 text-warning"></i>
                Sinais de Bandas
              </h3>
              <div id="bandsSignalsContent" class="space-y-2 text-xs">
                <div class="text-gray-400 text-center py-2">
                  Carregue uma análise para ver os sinais
                </div>
              </div>
            </div>

            <!-- Mini Flow -->
            <div class="card rounded-lg p-4">
              <h3 class="text-sm font-bold text-white mb-3 flex items-center">
                <i class="fas fa-water mr-2 text-green-400"></i>
                Options Flow
              </h3>
              <div id="miniFlowChart" class="mini-chart mb-3"></div>
              <div class="space-y-2 text-xs">
                <div class="flex justify-between">
                  <span class="text-gray-400">C/P Ratio:</span>
                  <span id="cpRatio" class="text-white font-medium">--</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-400">Sentiment:</span>
                  <span id="flowSentiment" class="text-warning font-medium">--</span>
                </div>
              </div>
            </div>
            
          </div>

          <!-- Main Chart - Hybrid Volatility Bands -->
          <div class="main-chart">
            <div class="chart-container rounded-2xl p-6 h-full">
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                  <i class="fas fa-chart-line mr-2 text-geminii"></i>
                  Hybrid Volatility Bands
                </h2>
                <div class="flex items-center gap-3">
                  <div id="bandsStatus" class="text-sm text-gray-400">
                    <i class="fas fa-circle-notch fa-spin mr-1"></i>Aguardando...
                  </div>
                  <button onclick="refreshBands()" class="text-geminii hover:text-purple-300 transition-colors">
                    <i class="fas fa-sync"></i>
                  </button>
                </div>
              </div>
              <div id="mainBandsChart" class="w-full" style="height: calc(100% - 80px);"></div>
            </div>
          </div>

          <!-- IV Panel - Simplificado -->
          <div class="iv-panel space-y-4">
            
            <!-- IV Atual -->
            <div class="card rounded-lg p-4">
              <h3 class="text-sm font-bold text-white mb-4 text-center">
                <i class="fas fa-thermometer-half mr-2 text-warning"></i>
                IV Atual
              </h3>
              
              <!-- Display Simples do IV -->
              <div class="text-center mb-4">
                <div class="text-3xl font-bold text-warning mb-2">
                  <span id="ivCurrent">--</span>
                </div>
                <div class="text-xs text-gray-400">
                  Volatilidade Implícita Atual
                </div>
              </div>

              <!-- Status Visual -->
              <div id="ivStatus" class="text-center p-3 rounded-lg bg-gray-600/30">
                <div class="text-sm text-gray-300">
                  Carregue um ticker para ver o status
                </div>
              </div>
            </div>

            <!-- Top 10 IV Alta -->
            <div class="card rounded-lg p-4">
              <h3 class="text-sm font-bold text-white mb-3 flex items-center">
                <i class="fas fa-arrow-up mr-2 text-red-400"></i>
                Top 10 IV Alta
              </h3>
              <div id="topIVAlta" class="space-y-1 text-xs max-h-32 overflow-y-auto">
                <div class="loading-skeleton h-4 rounded mb-2"></div>
                <div class="loading-skeleton h-4 rounded mb-2"></div>
                <div class="loading-skeleton h-4 rounded mb-2"></div>
              </div>
            </div>

            <!-- Top 10 IV Baixa -->
            <div class="card rounded-lg p-4">
              <h3 class="text-sm font-bold text-white mb-3 flex items-center">
                <i class="fas fa-arrow-down mr-2 text-green-400"></i>
                Top 10 IV Baixa
              </h3>
              <div id="topIVBaixa" class="space-y-1 text-xs max-h-32 overflow-y-auto">
                <div class="loading-skeleton h-4 rounded mb-2"></div>
                <div class="loading-skeleton h-4 rounded mb-2"></div>
                <div class="loading-skeleton h-4 rounded mb-2"></div>
              </div>
            </div>

            <!-- Recomendação Geral -->
            <div class="card rounded-lg p-4">
              <h3 class="text-sm font-bold text-white mb-3">
                <i class="fas fa-lightbulb mr-2 text-geminii"></i>
                Recomendação
              </h3>
              <div id="generalRecommendation" class="text-xs text-gray-300 leading-relaxed">
                Selecione um ticker para ver a recomendação baseada em IV e Flow.
              </div>
            </div>
          </div>

          <!-- Hunter Walls - Bottom Panel MELHORADO -->
          <div class="hunter-walls">
            <div class="hunter-walls-container rounded-lg p-6">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white flex items-center">
                  <i class="fas fa-crosshairs mr-2 text-warning"></i>
                  Hunter Walls - Volume por Strike
                </h2>
                <div class="flex items-center gap-3">
                  <input 
                    type="text" 
                    id="tickerHunter"
                    placeholder="Ex: PETR4, VALE3..."
                    class="bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-white text-sm w-32"
                  >
                  <button onclick="buscarVencimentosHunter()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-colors">
                    <i class="fas fa-search mr-1"></i>Buscar
                  </button>
                </div>
              </div>

              <!-- Vencimentos disponíveis -->
              <div id="vencimentosHunter" class="hidden mb-6">
                <label class="block text-gray-300 font-medium mb-3">
                  <i class="fas fa-calendar-alt mr-2"></i>Vencimentos Disponíveis
                </label>
                
                <!-- Legenda de Meses -->
                <div class="bg-gray-800/50 rounded-lg p-3 mb-4 text-xs">
                  <div class="grid grid-cols-3 md:grid-cols-6 gap-2 text-gray-400">
                    <div><strong>Jan:</strong> A, M</div>
                    <div><strong>Fev:</strong> B, N</div>
                    <div><strong>Mar:</strong> C, O</div>
                    <div><strong>Abr:</strong> D, P</div>
                    <div><strong>Mai:</strong> E, Q</div>
                    <div><strong>Jun:</strong> F, R</div>
                    <div><strong>Jul:</strong> G, S</div>
                    <div><strong>Ago:</strong> H, T</div>
                    <div><strong>Set:</strong> I, U</div>
                    <div><strong>Out:</strong> J, V</div>
                    <div><strong>Nov:</strong> K, W</div>
                    <div><strong>Dez:</strong> L, X</div>
                  </div>
                </div>
                
                <div id="letrasHunterContainer" class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-12 gap-2 mb-4">
                  <!-- Letras serão inseridas aqui -->
                </div>

                <!-- Grupos de vencimentos -->
                <div class="mb-4">
                  <label class="block text-gray-300 font-medium mb-2">
                    <i class="fas fa-layer-group mr-2"></i>Grupos de Vencimentos
                  </label>
                  <div id="gruposHunterContainer" class="space-y-2">
                    <div class="flex gap-2 items-center">
                      <input 
                        type="text" 
                        placeholder="Ex: F,R (clique nas letras acima)"
                        class="bg-white/10 border border-white/20 rounded px-3 py-2 text-white text-sm flex-1"
                      >
                      <button onclick="adicionarGrupoHunter()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm transition-colors">
                        <i class="fas fa-plus"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <button onclick="executarHunterWalls()" class="bg-warning hover:bg-yellow-500 text-black px-6 py-2 rounded-lg font-semibold text-sm transition-colors">
                  <i class="fas fa-rocket mr-1"></i>Executar Hunter Walls
                </button>
              </div>

              <!-- Chart Container -->
              <div id="hunterWallsChart" class="w-full" style="height: 400px; min-height: 400px;"></div>
            </div>
          </div>

        </div>

      </div>
    </div>
  </main>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="card rounded-lg p-8 text-center">
      <div class="spinner mx-auto mb-4"></div>
      <p class="text-white text-lg">Carregando análise completa...</p>
      <p class="text-gray-400 text-sm mt-1">Processando dados de opções</p>
    </div>
  </div>

  <script>
    // ===== CONFIGURAÇÕES GLOBAIS =====
    let currentTicker = '';
    let userToken = localStorage.getItem('geminii_token');
    
    if (!userToken) {
      window.location.href = '/login.html';
    }

    // ===== FUNÇÕES DE LOADING =====
    function showLoading() {
      document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }

    function showToast(message, type = 'info') {
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-yellow-500'
      };
      
      const toast = document.createElement('div');
      toast.className = `fixed top-20 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300`;
      toast.textContent = message;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, 4000);
    }

    // ===== FUNÇÃO PRINCIPAL - ANÁLISE COMPLETA =====
    async function loadCompleteAnalysis() {
      const ticker = document.getElementById('ticker').value.trim().toUpperCase();
      if (!ticker) {
        showToast('Digite um ticker válido', 'warning');
        return;
      }

      currentTicker = ticker;
      showLoading();

      try {
        // Chamar a API de análise completa
        const response = await fetch('/pro/bandas/analyze', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${userToken}`
          },
          body: JSON.stringify({
            ticker: ticker,
            period: '6mo',
            flow_days: parseInt(document.getElementById('flowDays').value)
          })
        });

        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Erro na requisição');
        }

        // Processar e renderizar dados das bandas
        if (data.bands && data.bands.plot_data) {
          renderMainBandsChart(data.bands.plot_data);
          updateQuickStats(data.bands.signals);
          renderBandsSignals(data.bands.signals);
        }

        // Processar e renderizar dados de flow
        if (data.flow && data.flow.plot_data) {
          renderMiniFlowChart(data.flow.plot_data);
          updateFlowMetrics(data.flow.analysis);
        }

        // Carregar IV ranking
        await loadIVRanking();

        hideLoading();
        showToast(`Análise completa de ${ticker} carregada!`, 'success');

      } catch (error) {
        hideLoading();
        showToast('Erro ao carregar análise: ' + error.message, 'error');
        console.error('Erro:', error);
      }
    }

    // ===== RENDERIZAÇÃO DO GRÁFICO PRINCIPAL =====
    function renderMainBandsChart(plotData) {
      if (!plotData) return;

      // Candlestick
      const candlestick = {
        x: plotData.dates,
        open: plotData.ohlc.open,
        high: plotData.ohlc.high,
        low: plotData.ohlc.low,
        close: plotData.ohlc.close,
        type: 'candlestick',
        name: plotData.ticker,
        increasing: {line: {color: '#ffffff'}},
        decreasing: {line: {color: '#ef4444'}}
      };

      // Bandas
      const bandaSuperior2 = {
        x: plotData.dates,
        y: plotData.bands.superior_2sigma,
        type: 'scatter',
        mode: 'lines',
        name: 'Banda Superior 2σ',
        line: {color: '#FF6B6B', width: 2}
      };

      const bandaInferior2 = {
        x: plotData.dates,
        y: plotData.bands.inferior_2sigma,
        type: 'scatter',
        mode: 'lines',
        name: 'Banda Inferior 2σ',
        line: {color: '#2ED573', width: 2}
      };

      const bandaSuperior4 = {
        x: plotData.dates,
        y: plotData.bands.superior_4sigma,
        type: 'scatter',
        mode: 'lines',
        name: 'Banda Superior 4σ',
        line: {color: '#FF4757', width: 1.5, dash: 'dash'}
      };

      const bandaInferior4 = {
        x: plotData.dates,
        y: plotData.bands.inferior_4sigma,
        type: 'scatter',
        mode: 'lines',
        name: 'Banda Inferior 4σ',
        line: {color: '#2ED573', width: 1.5, dash: 'dash'}
      };

      const linhaCentral = {
        x: plotData.dates,
        y: plotData.bands.linha_central,
        type: 'scatter',
        mode: 'lines',
        name: 'Linha Central',
        line: {color: '#FFD700', width: 2}
      };

      const traces = [candlestick, bandaSuperior2, bandaInferior2, bandaSuperior4, bandaInferior4, linhaCentral];

      const layout = {
        title: {
          text: `${plotData.ticker} - Bandas de Volatilidade Híbridas (GARCH + XGBoost)`,
          font: {color: 'white', size: 16}
        },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(255,255,255,0.02)',
        font: {color: 'white', size: 11},
        showlegend: true,
        legend: {
          font: {color: 'white'},
          bgcolor: 'rgba(0,0,0,0.5)'
        },
        margin: {l: 50, r: 20, t: 50, b: 40},
        xaxis: {
          title: 'Data',
          rangeslider: {visible: false},
          gridcolor: 'rgba(255,255,255,0.1)',
          color: 'white'
        },
        yaxis: {
          title: `Preço (${plotData.currency || 'R$'})`,
          side: 'right',
          gridcolor: 'rgba(255,255,255,0.1)',
          color: 'white'
        }
      };

      Plotly.newPlot('mainBandsChart', traces, layout, {responsive: true});

      // Atualizar status
      document.getElementById('bandsStatus').innerHTML = `
        <i class="fas fa-check-circle text-green-400 mr-1"></i>
        Bandas Ativas
      `;
    }

    // ===== FUNÇÕES DE ATUALIZAÇÃO =====
    function updateQuickStats(signals) {
      if (!signals) return;

      const currency = signals.bandas ? (signals.bandas.superior_2σ > 1000 ? 'R$' : '') : 'R$';
      
      document.getElementById('currentPrice').textContent = `${currency}${signals.price?.toFixed(2) || '--'}`;
      document.getElementById('volatilityPercent').textContent = `${(signals.volatility * 100)?.toFixed(2) || '--'}%`;
      document.getElementById('volRegime').textContent = `${signals.vol_regime || '--'} Vol`;
    }

    function renderBandsSignals(signals) {
      if (!signals) return;
    
      const currency = signals.bandas && signals.bandas.superior_2σ > 1000 ? 'R$' : '';
      
      const html = `
        <div class="metric-item rounded p-2 mb-2">
          <div class="text-center">
            <span class="text-gray-400 text-xs">Posição Atual</span>
            <div class="text-white font-bold text-sm mt-1">${signals.position || 'N/A'}</div>
          </div>
        </div>
        
        <div class="space-y-1">
          <div class="flex justify-between items-center py-1 text-xs border-b border-white/10">
            <span class="text-gray-400">Linha Central</span>
            <span class="text-warning font-medium">${currency}${signals.bandas?.linha_central?.toFixed(2) || 'N/A'}</span>
          </div>
          <div class="flex justify-between items-center py-1 text-xs border-b border-white/10">
            <span class="text-gray-400">Sup 2σ</span>
            <span class="text-red-400 font-medium">${currency}${signals.bandas?.superior_2σ?.toFixed(2) || 'N/A'}</span>
          </div>
          <div class="flex justify-between items-center py-1 text-xs">
            <span class="text-gray-400">Inf 2σ</span>
            <span class="text-green-400 font-medium">${currency}${signals.bandas?.inferior_2σ?.toFixed(2) || 'N/A'}</span>
          </div>
        </div>

        ${signals.iv_validation ? `
          <div class="mt-3 p-2 rounded ${getStatusClass(signals.iv_validation.status)}">
            <div class="text-center text-xs font-semibold">
              ${signals.iv_validation.status}
            </div>
            <div class="text-xs mt-1 text-center opacity-80">
              ${signals.iv_validation.recommendation}
            </div>
          </div>
        ` : ''}
      `;

      document.getElementById('bandsSignalsContent').innerHTML = html;
    }

    function renderMiniFlowChart(plotData) {
      if (!plotData) return;

      const traces = [
        {
          x: plotData.dates,
          y: plotData.call_flow,
          type: 'scatter',
          mode: 'lines',
          name: 'Calls',
          line: {color: '#00FF88', width: 2},
          fill: 'tonexty'
        },
        {
          x: plotData.dates,
          y: plotData.put_flow.map(v => -v),
          type: 'scatter',
          mode: 'lines',
          name: 'Puts',
          line: {color: '#FF4444', width: 2},
          fill: 'tonexty'
        }
      ];

      const layout = {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(255,255,255,0.02)',
        font: {color: 'white', size: 9},
        showlegend: false,
        margin: {l: 30, r: 10, t: 10, b: 20},
        xaxis: {
          showgrid: false,
          showticklabels: false,
          color: 'white'
        },
        yaxis: {
          showgrid: false,
          showticklabels: false,
          color: 'white'
        }
      };

      Plotly.newPlot('miniFlowChart', traces, layout, {responsive: true});
    }

    function updateFlowMetrics(analysis) {
      if (!analysis) return;
      
      document.getElementById('cpRatio').textContent = analysis.cp_ratio?.toFixed(2) || '--';
      document.getElementById('flowSentiment').textContent = analysis.sentiment || '--';
    }

    // ===== APIS CALLS =====
    async function loadIVRanking() {
      try {
        const response = await fetch('/api/rank/iv-ranking?rank_by=iv_current&top_n=50', {
          headers: { 'Authorization': `Bearer ${userToken}` }
        });

        if (response.ok) {
          const data = await response.json();
          updateIVPanel(data);
          updateIVStatus(currentTicker, data);
        }
      } catch (error) {
        console.error('Erro ao carregar ranking IV:', error);
      }
    }

    // ===== HUNTER WALLS - SISTEMA COMPLETO =====
    let currentTickerHunter = '';
    let letrasHunterDisponiveis = [];
    let selectedLetrasHunter = new Set();

    // Mapeamento de letras para meses (Hunter Walls)
    const mesesMapHunter = {
      'A': { mes: 'Janeiro', pair: 'M', class: 'mes-jan' },
      'M': { mes: 'Janeiro', pair: 'A', class: 'mes-jan' },
      'B': { mes: 'Fevereiro', pair: 'N', class: 'mes-fev' },
      'N': { mes: 'Fevereiro', pair: 'B', class: 'mes-fev' },
      'C': { mes: 'Março', pair: 'O', class: 'mes-mar' },
      'O': { mes: 'Março', pair: 'C', class: 'mes-mar' },
      'D': { mes: 'Abril', pair: 'P', class: 'mes-abr' },
      'P': { mes: 'Abril', pair: 'D', class: 'mes-abr' },
      'E': { mes: 'Maio', pair: 'Q', class: 'mes-mai' },
      'Q': { mes: 'Maio', pair: 'E', class: 'mes-mai' },
      'F': { mes: 'Junho', pair: 'R', class: 'mes-jun' },
      'R': { mes: 'Junho', pair: 'F', class: 'mes-jun' },
      'G': { mes: 'Julho', pair: 'S', class: 'mes-jul' },
      'S': { mes: 'Julho', pair: 'G', class: 'mes-jul' },
      'H': { mes: 'Agosto', pair: 'T', class: 'mes-ago' },
      'T': { mes: 'Agosto', pair: 'H', class: 'mes-ago' },
      'I': { mes: 'Setembro', pair: 'U', class: 'mes-set' },
      'U': { mes: 'Setembro', pair: 'I', class: 'mes-set' },
      'J': { mes: 'Outubro', pair: 'V', class: 'mes-out' },
      'V': { mes: 'Outubro', pair: 'J', class: 'mes-out' },
      'K': { mes: 'Novembro', pair: 'W', class: 'mes-nov' },
      'W': { mes: 'Novembro', pair: 'K', class: 'mes-nov' },
      'L': { mes: 'Dezembro', pair: 'X', class: 'mes-dez' },
      'X': { mes: 'Dezembro', pair: 'L', class: 'mes-dez' }
    };

    async function buscarVencimentosHunter() {
      const ticker = document.getElementById('tickerHunter').value.trim().toUpperCase();
      
      if (!ticker) {
        showToast('Digite um ticker válido', 'warning');
        return;
      }

      try {
        const response = await fetch(`/api/opcoes/available-expirations?ticker=${ticker}`, {
          headers: { 'Authorization': `Bearer ${userToken}` }
        });

        const result = await response.json();

        if (result.success) {
          currentTickerHunter = ticker;
          letrasHunterDisponiveis = result.data.letras_disponiveis;
          displayLetrasHunter(letrasHunterDisponiveis);
          document.getElementById('vencimentosHunter').classList.remove('hidden');
          showToast(`Vencimentos carregados para ${ticker}`, 'success');
        } else {
          throw new Error(result.message);
        }

      } catch (error) {
        showToast('Erro ao buscar vencimentos: ' + error.message, 'error');
      }
    }

    function displayLetrasHunter(letras) {
      const container = document.getElementById('letrasHunterContainer');
      container.innerHTML = '';
      
      letras.forEach(letra => {
        const info = mesesMapHunter[letra] || { mes: 'Indefinido', class: '' };
        const span = document.createElement('span');
        span.className = `letra-hunter-btn bg-blue-500/20 text-blue-400 px-3 py-2 rounded-lg text-xs font-semibold cursor-pointer hover:bg-blue-500/30 transition-colors flex flex-col items-center min-w-[60px] border border-blue-500/30 ${info.class}`;
        span.setAttribute('data-letra', letra);
        span.innerHTML = `
          <div class="font-bold text-sm">${letra}</div>
          <div class="text-xs opacity-80">${info.mes.slice(0, 3)}</div>
        `;
        
        span.onclick = () => toggleLetraHunterSelection(letra, span);
        container.appendChild(span);
      });
    }

    function toggleLetraHunterSelection(letra, element) {
      const info = mesesMapHunter[letra];
      const pairLetter = info?.pair;
      
      // Toggle seleção da letra atual
      if (selectedLetrasHunter.has(letra)) {
        selectedLetrasHunter.delete(letra);
        element.classList.remove('selected');
      } else {
        selectedLetrasHunter.add(letra);
        element.classList.add('selected');
      }
      
      // Adicionar ao input
      adicionarLetraAoGrupoHunter(letra);
      
      // Destacar letra par do mesmo mês
      if (pairLetter) {
        const pairElement = document.querySelector(`#letrasHunterContainer [data-letra="${pairLetter}"]`);
        if (pairElement) {
          if (selectedLetrasHunter.has(letra)) {
            pairElement.classList.add('related');
          } else {
            pairElement.classList.remove('related');
          }
        }
      }
    }

    function adicionarLetraAoGrupoHunter(letra) {
      const inputs = document.querySelectorAll('#gruposHunterContainer input');
      const ultimoInput = inputs[inputs.length - 1];
      
      const currentValue = ultimoInput.value.trim();
      const letrasExistentes = currentValue ? currentValue.split(',').map(l => l.trim()) : [];
      
      // Toggle - se já existe, remove; se não existe, adiciona
      const index = letrasExistentes.indexOf(letra);
      if (index > -1) {
        letrasExistentes.splice(index, 1);
      } else {
        letrasExistentes.push(letra);
      }
      
      ultimoInput.value = letrasExistentes.filter(l => l).join(',');
    }

    function adicionarGrupoHunter() {
      const container = document.getElementById('gruposHunterContainer');
      const novoGrupo = document.createElement('div');
      novoGrupo.className = 'flex gap-2 items-center';
      novoGrupo.innerHTML = `
        <input 
          type="text" 
          placeholder="Ex: G,S (clique nas letras acima)"
          class="bg-white/10 border border-white/20 rounded px-3 py-2 text-white text-sm flex-1"
        >
        <button onclick="removerGrupoHunter(this)" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm transition-colors">
          <i class="fas fa-trash"></i>
        </button>
      `;
      container.appendChild(novoGrupo);
    }

    function removerGrupoHunter(btn) {
      btn.parentElement.remove();
    }

    async function executarHunterWalls() {
      if (!currentTickerHunter) {
        showToast('Primeiro busque um ticker válido', 'warning');
        return;
      }

      // Coletar grupos
      const inputs = document.querySelectorAll('#gruposHunterContainer input');
      const grupos = [];
      
      inputs.forEach(input => {
        const valor = input.value.trim().toUpperCase();
        if (valor) {
          const letras = valor.split(',').map(l => l.trim()).filter(l => l);
          if (letras.length > 0) {
            grupos.push(letras);
          }
        }
      });

      if (grupos.length === 0) {
        showToast('Configure pelo menos um grupo de vencimentos', 'warning');
        return;
      }

      try {
        const response = await fetch('/api/opcoes/hunter-walls', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${userToken}`
          },
          body: JSON.stringify({
            ticker: currentTickerHunter,
            grupos_vencimentos: grupos
          })
        });

        const result = await response.json();

        if (result.success) {
          renderHunterWallsChart(result.data);
          showToast('Hunter Walls executado!', 'success');
        } else {
          throw new Error(result.message);
        }

      } catch (error) {
        showToast('Erro: ' + error.message, 'error');
      }
    }

    function renderHunterWallsChart(data) {
      if (!data.chart_data) return;

      const chartData = Object.values(data.chart_data)[0];
      if (!chartData) return;

      const traces = [
        {
          x: chartData.strikes_values,
          y: chartData.calls_volumes.map(v => Math.abs(v)),
          type: 'bar',
          name: 'Calls',
          marker: {color: '#00FF88', opacity: 0.8},
          yaxis: 'y',
          hovertemplate: '<b>CALLS</b><br>Strike: R$ %{x}<br>Volume: %{y:,}<extra></extra>'
        },
        {
          x: chartData.strikes_values,
          y: chartData.puts_volumes.map(v => -Math.abs(v)),
          type: 'bar',
          name: 'Puts', 
          marker: {color: '#FF4444', opacity: 0.8},
          yaxis: 'y',
          hovertemplate: '<b>PUTS</b><br>Strike: R$ %{x}<br>Volume: %{text:,}<extra></extra>',
          text: chartData.puts_volumes.map(v => Math.abs(v))
        }
      ];

      const layout = {
        title: {
          text: `${currentTicker} - Volume por Strike`,
          font: {color: 'white', size: 16}
        },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(255,255,255,0.02)',
        font: {color: 'white', size: 10},
        showlegend: true,
        legend: {
          font: {color: 'white'},
          bgcolor: 'rgba(0,0,0,0.5)',
          orientation: 'h',
          yanchor: 'bottom',
          y: 1.02,
          xanchor: 'center',
          x: 0.5
        },
        margin: {l: 50, r: 30, t: 60, b: 50},
        xaxis: {
          title: 'Strike (R$)',
          gridcolor: 'rgba(255,255,255,0.1)',
          color: 'white'
        },
        yaxis: {
          title: 'Volume (Calls +) | (Puts -)',
          gridcolor: 'rgba(255,255,255,0.1)',
          color: 'white',
          zeroline: true,
          zerolinecolor: 'rgba(255,255,255,0.3)',
          zerolinewidth: 2
        },
        shapes: [{
          type: 'line',
          x0: data.ticker_info.current_price,
          y0: Math.min(...chartData.puts_volumes.map(v => -Math.abs(v))) * 1.1,
          x1: data.ticker_info.current_price,
          y1: Math.max(...chartData.calls_volumes.map(v => Math.abs(v))) * 1.1,
          line: {
            color: '#FFD700',
            width: 3,
            dash: 'dash'
          }
        }]
      };

      Plotly.newPlot('hunterWallsChart', traces, layout, {responsive: true});
    }

    // ===== ATUALIZAÇÃO DO PAINEL IV - SIMPLIFICADO =====
    function updateIVPanel(rankingData) {
      if (!rankingData.success) return;

      const rankings = rankingData.rankings.iv_atual || [];
      const topAlta = rankings.slice(0, 10);
      const topBaixa = rankings.slice(-10).reverse();

      // Top IV Alta
      const htmlAlta = topAlta.map((item, index) => `
        <div class="flex justify-between items-center py-1 px-2 rounded ${getIVRankClass(item.iv_current)}">
          <span class="font-mono">${index + 1}. ${item.symbol}</span>
          <span class="font-bold">${item.iv_current.toFixed(1)}%</span>
        </div>
      `).join('');

      // Top IV Baixa
      const htmlBaixa = topBaixa.map((item, index) => `
        <div class="flex justify-between items-center py-1 px-2 rounded ${getIVRankClass(item.iv_current)}">
          <span class="font-mono">${index + 1}. ${item.symbol}</span>
          <span class="font-bold">${item.iv_current.toFixed(1)}%</span>
        </div>
      `).join('');

      document.getElementById('topIVAlta').innerHTML = htmlAlta;
      document.getElementById('topIVBaixa').innerHTML = htmlBaixa;
    }

    function updateIVStatus(ticker, rankingData) {
      if (!rankingData.success || !ticker) return;

      const allStocks = rankingData.all_stocks || [];
      const currentStock = allStocks.find(stock => stock.symbol === ticker);

      if (currentStock) {
        const ivCurrent = currentStock.iv_current;
        
        // Atualizar IV Atual
        document.getElementById('ivCurrent').textContent = `${ivCurrent.toFixed(1)}%`;

        // Atualizar status visual baseado apenas no IV atual
        let statusHtml = '';
        let statusClass = '';

        if (ivCurrent >= 60) {
          statusClass = 'bg-red-500/20 border border-red-500/30';
          statusHtml = `
            <div class="text-red-400 font-bold">🔴 IV ALTO</div>
            <div class="text-xs text-red-300 mt-1">Favorável para venda de volatilidade</div>
          `;
        } else if (ivCurrent >= 30) {
          statusClass = 'bg-yellow-500/20 border border-yellow-500/30';
          statusHtml = `
            <div class="text-yellow-400 font-bold">🟡 IV MÉDIO</div>
            <div class="text-xs text-yellow-300 mt-1">Monitor de sinais direcionais</div>
          `;
        } else {
          statusClass = 'bg-green-500/20 border border-green-500/30';
          statusHtml = `
            <div class="text-green-400 font-bold">🟢 IV BAIXO</div>
            <div class="text-xs text-green-300 mt-1">Favorável para compra de volatilidade</div>
          `;
        }

        document.getElementById('ivStatus').className = `text-center p-3 rounded-lg ${statusClass}`;
        document.getElementById('ivStatus').innerHTML = statusHtml;

        // Atualizar recomendação simplificada
        updateSimpleRecommendation(ivCurrent);
      }
    }

    function updateSimpleRecommendation(ivCurrent) {
      let recommendation = '';

      if (ivCurrent >= 60) {
        recommendation = `🔴 IV ALTO (${ivCurrent.toFixed(1)}%): Considere estratégias de venda de volatilidade como iron condors ou vendas cobertas.`;
      } else if (ivCurrent >= 30) {
        recommendation = `🟡 IV MÉDIO (${ivCurrent.toFixed(1)}%): Monitore sinais direcionais. Aguarde confirmação de tendência.`;
      } else {
        recommendation = `🟢 IV BAIXO (${ivCurrent.toFixed(1)}%): Oportunidade para compra de volatilidade. Considere straddles ou strangles.`;
      }

      document.getElementById('generalRecommendation').textContent = recommendation;
    }

    // ===== FUNÇÕES AUXILIARES =====
    function getIVRankClass(ivValue) {
      if (ivValue >= 60) return 'iv-rank-high';
      if (ivValue >= 30) return 'iv-rank-medium';
      return 'iv-rank-low';
    }

    function getStatusClass(status) {
      switch(status) {
        case 'CONFIÁVEL': return 'status-confiavel';
        case 'SUSPEITO': return 'status-suspeito';
        default: return 'status-neutro';
      }
    }

    // ===== FUNÇÃO DE REFRESH =====
    async function refreshBands() {
      if (!currentTicker) {
        showToast('Nenhum ticker carregado', 'warning');
        return;
      }

      try {
        const response = await fetch('/pro/bandas/analyze-bands', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${userToken}`
          },
          body: JSON.stringify({
            ticker: currentTicker,
            period: '6mo'
          })
        });

        const data = await response.json();
        
        if (response.ok && data.plot_data) {
          renderMainBandsChart(data.plot_data);
          updateQuickStats(data.signals);
          renderBandsSignals(data.signals);
          showToast('Bandas atualizadas!', 'success');
        } else {
          throw new Error(data.error || 'Erro ao atualizar');
        }
      } catch (error) {
        showToast('Erro ao atualizar: ' + error.message, 'error');
      }
    }

    // ===== EVENT LISTENERS =====
    document.getElementById('ticker').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        loadCompleteAnalysis();
      }
    });

    // ===== INICIALIZAÇÃO =====
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar autenticação
      if (!userToken) {
        showToast('Sessão expirada. Redirecionando...', 'warning');
        setTimeout(() => {
          window.location.href = '/login.html';
        }, 2000);
        return;
      }

      // Carregar ranking IV inicial
      loadIVRanking().then(() => {
        console.log('Ranking IV carregado');
      }).catch(error => {
        console.error('Erro ao carregar ranking inicial:', error);
      });

      showToast('Visão 360° carregada! Digite um ticker para começar.', 'success');
    });

    // ===== RESPONSIVE HANDLERS =====
    window.addEventListener('resize', function() {
      // Redimensionar gráficos quando a janela mudar de tamanho
      if (document.getElementById('mainBandsChart').children.length > 0) {
        Plotly.Plots.resize('mainBandsChart');
      }
      if (document.getElementById('miniFlowChart').children.length > 0) {
        Plotly.Plots.resize('miniFlowChart');
      }
      if (document.getElementById('hunterWallsChart').children.length > 0) {
        Plotly.Plots.resize('hunterWallsChart');
      }
    });

  </script>
</body>
</html>