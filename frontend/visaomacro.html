<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visão Macro - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#000000',
            light: '#ffffff',
            subtle: 'rgba(255,255,255,0.1)',
            geminii: '#ba39af'
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
      min-height: 100vh;
    }

    .macro-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      transition: all 0.3s ease;
    }

    .macro-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(186, 57, 175, 0.15);
      border-color: rgba(186, 57, 175, 0.3);
    }

    .spinner {
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 2px solid #ba39af;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .chart-container {
      height: 600px;
      background: transparent;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .metric-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(186, 57, 175, 0.3);
    }

    .greek-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .badge-gamma { background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.4); }
    .badge-delta { background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.4); }
    .badge-vega { background: rgba(168, 85, 247, 0.2); color: #a855f7; border: 1px solid rgba(168, 85, 247, 0.4); }
    .badge-theta { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.4); }

    .alert-high { background: rgba(239, 68, 68, 0.15); border-left: 4px solid #ef4444; }
    .alert-medium { background: rgba(251, 191, 36, 0.15); border-left: 4px solid #fbbf24; }
    .alert-low { background: rgba(59, 130, 246, 0.15); border-left: 4px solid #3b82f6; }

  </style>
</head>

<body class="text-white">

  <!-- Navbar -->
  <nav class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-opacity-5 border-opacity-10 bg-white border-white border rounded-full px-4 py-3 shadow-xl backdrop-blur-md">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <a href="/dashboard.html">
          <img src="logo.png" alt="Geminii Logo" class="w-6 h-6 cursor-pointer">
        </a>
      </div>
      <div class="hidden md:flex items-center space-x-6 text-xs text-gray-300 ml-8">
        <span class="text-white font-medium">Visão Macro</span>
        <a href="gamma-levels.html" class="hover:text-white transition-colors">Gamma</a>
        <a href="delta-levels.html" class="hover:text-white transition-colors">Delta</a>
        <a href="vega-levels.html" class="hover:text-white transition-colors">Vega</a>
        <a href="theta-levels.html" class="hover:text-white transition-colors">Theta</a>
      </div>
      <div class="flex items-center space-x-3 ml-8">
        <div class="w-8 h-8 bg-purple-500 bg-opacity-10 border border-purple-500 border-opacity-30 rounded-full flex items-center justify-center relative">
          <i class="fas fa-layer-group text-purple-500 text-xs"></i>
          <div class="absolute -top-1 -right-1 w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Content -->
  <div class="pt-32 pb-16">
    <div class="max-w-7xl mx-auto px-6">

      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">
          <span style="color: #ba39af; font-weight: 900;">Visão</span>
          <span class="text-white font-light">Macro</span>
        </h1>
        <p class="text-neutral-300 text-lg max-w-3xl mx-auto">
          Análise multidimensional consolidando Gamma, Delta, Vega e Theta. Visão completa dos Greeks para tomada de decisão estratégica.
        </p>
      </div>

      <!-- Análise Form -->
      <div class="macro-card p-8 mb-8">
        <h2 class="text-2xl font-bold mb-6">Análise de Ativo</h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm text-gray-400 mb-2">Ticker</label>
            <input type="text" id="tickerInput" placeholder="Ex: PETR4"
              class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-geminii">
          </div>

          <div>
            <label class="block text-sm text-gray-400 mb-2">Vencimento (Opcional)</label>
            <input type="text" id="expirationInput" placeholder="Ex: 20251017"
              class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-geminii">
          </div>

          <div class="flex items-end">
            <button onclick="analyzeMacro()" id="analyzeBtn"
              class="w-full bg-gradient-to-r from-geminii to-purple-600 hover:from-purple-600 hover:to-geminii text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center">
              <i class="fas fa-chart-line mr-2"></i>
              Analisar
            </button>
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div id="loadingSection" class="hidden text-center py-12">
        <div class="spinner mx-auto mb-4"></div>
        <p class="text-gray-400">Agregando dados dos 4 Greeks...</p>
      </div>

      <!-- Results -->
      <div id="resultsSection" class="hidden">

        <!-- Informações Gerais -->
        <div class="macro-card p-6 mb-8">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
            <div>
              <p class="text-gray-400 text-sm mb-1">Ativo</p>
              <p class="text-2xl font-bold" id="displayTicker">-</p>
            </div>
            <div>
              <p class="text-gray-400 text-sm mb-1">Cotação</p>
              <p class="text-2xl font-bold text-yellow-400" id="displaySpot">-</p>
            </div>
            <div>
              <p class="text-gray-400 text-sm mb-1">Vencimento</p>
              <p class="text-lg font-semibold" id="displayExpiration">-</p>
            </div>
            <div>
              <p class="text-gray-400 text-sm mb-1">Análise</p>
              <p class="text-lg font-semibold text-purple-400" id="displayTimestamp">-</p>
            </div>
          </div>
        </div>

        <!-- Grid de Greeks -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

          <!-- Gamma Card -->
          <div class="metric-card">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold">Gamma</h3>
              <span class="greek-badge badge-gamma">GEX</span>
            </div>
            <div class="space-y-3">
              <div>
                <p class="text-xs text-gray-400">Flip Strike</p>
                <p class="text-xl font-bold text-green-400" id="gammaFlip">-</p>
              </div>
              <div>
                <p class="text-xs text-gray-400">Regime</p>
                <p class="text-sm font-semibold" id="gammaRegime">-</p>
              </div>
              <div>
                <p class="text-xs text-gray-400">GEX Descoberto</p>
                <p class="text-sm" id="gammaDescoberto">-</p>
              </div>
            </div>
          </div>

          <!-- Delta Card -->
          <div class="metric-card">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold">Delta</h3>
              <span class="greek-badge badge-delta">DEX</span>
            </div>
            <div class="space-y-3">
              <div>
                <p class="text-xs text-gray-400">Bias do Mercado</p>
                <p class="text-xl font-bold text-yellow-400" id="deltaBias">-</p>
              </div>
              <div>
                <p class="text-xs text-gray-400">DEX Descoberto</p>
                <p class="text-sm" id="deltaDescoberto">-</p>
              </div>
              <div>
                <p class="text-xs text-gray-400">Pressão Restante</p>
                <p class="text-sm" id="deltaPressure">-</p>
              </div>
            </div>
          </div>

          <!-- Vega Card -->
          <div class="metric-card">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold">Vega</h3>
              <span class="greek-badge badge-vega">VEX</span>
            </div>
            <div class="space-y-3">
              <div>
                <p class="text-xs text-gray-400">Vol Implícita Média</p>
                <p class="text-xl font-bold text-purple-400" id="vegaIV">-</p>
              </div>
              <div>
                <p class="text-xs text-gray-400">Maior Risco (Strike)</p>
                <p class="text-sm" id="vegaRisk">-</p>
              </div>
              <div>
                <p class="text-xs text-gray-400">Skew Call/Put</p>
                <p class="text-sm" id="vegaSkew">-</p>
              </div>
            </div>
          </div>

          <!-- Theta Card -->
          <div class="metric-card">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold">Theta</h3>
              <span class="greek-badge badge-theta">TEX</span>
            </div>
            <div class="space-y-3">
              <div>
                <p class="text-xs text-gray-400">Decay Diário</p>
                <p class="text-xl font-bold text-red-400" id="thetaDecay">-</p>
              </div>
              <div>
                <p class="text-xs text-gray-400">Maior Decay (Strike)</p>
                <p class="text-sm" id="thetaStrike">-</p>
              </div>
              <div>
                <p class="text-xs text-gray-400">Theta/Gamma Ratio</p>
                <p class="text-sm" id="thetaRatio">-</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Gráficos -->
        <div class="macro-card p-6 mb-8">
          <h2 class="text-2xl font-bold mb-6">Gráficos Consolidados</h2>
          <div id="macroChart" class="chart-container"></div>
        </div>

        <!-- Análise Integrada -->
        <div class="macro-card p-6">
          <h2 class="text-2xl font-bold mb-6">Análise Integrada</h2>

          <!-- Alertas -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-3 flex items-center">
              <i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i>
              Alertas
            </h3>
            <div id="alertsContainer" class="space-y-3">
              <!-- Preenchido via JS -->
            </div>
          </div>

          <!-- Oportunidades -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-3 flex items-center">
              <i class="fas fa-lightbulb text-yellow-400 mr-2"></i>
              Oportunidades
            </h3>
            <div id="opportunitiesContainer" class="space-y-3">
              <!-- Preenchido via JS -->
            </div>
          </div>

          <!-- Zonas de Risco -->
          <div>
            <h3 class="text-lg font-semibold mb-3 flex items-center">
              <i class="fas fa-shield-alt text-red-400 mr-2"></i>
              Zonas de Risco
            </h3>
            <div id="riskZonesContainer" class="space-y-3">
              <!-- Preenchido via JS -->
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>

  <script>
    const API_URL = window.location.origin;

    async function analyzeMacro() {
      const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();

      if (!ticker) {
        alert('Por favor, insira um ticker!');
        return;
      }

      const expiration = document.getElementById('expirationInput').value.trim();

      // Show loading
      document.getElementById('loadingSection').classList.remove('hidden');
      document.getElementById('resultsSection').classList.add('hidden');

      const analyzeBtn = document.getElementById('analyzeBtn');
      analyzeBtn.disabled = true;
      analyzeBtn.innerHTML = '<div class="spinner mr-2"></div>Analisando...';

      try {
        const payload = { ticker };
        if (expiration) payload.expiration_code = expiration;

        const response = await fetch(`${API_URL}/pro/visaomacro/analyze`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erro ao analisar');
        }

        if (data.success) {
          displayResults(data);
        } else {
          throw new Error('Análise falhou');
        }

      } catch (error) {
        console.error('Erro:', error);
        alert(`Erro: ${error.message}`);
      } finally {
        document.getElementById('loadingSection').classList.add('hidden');
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = '<i class="fas fa-chart-line mr-2"></i>Analisar';
      }
    }

    function displayResults(data) {
      // Info geral
      document.getElementById('displayTicker').textContent = data.ticker || '-';
      document.getElementById('displaySpot').textContent = data.spot_price ? `R$ ${data.spot_price.toFixed(2)}` : '-';
      document.getElementById('displayExpiration').textContent = data.expiration || '-';

      const timestamp = new Date(data.timestamp);
      document.getElementById('displayTimestamp').textContent = timestamp.toLocaleTimeString('pt-BR');

      // Gamma
      const gamma = data.gamma_data || {};
      document.getElementById('gammaFlip').textContent = gamma.flip_strike ? `R$ ${gamma.flip_strike.toFixed(2)}` : 'N/A';
      document.getElementById('gammaRegime').textContent = gamma.regime || '-';
      document.getElementById('gammaDescoberto').textContent = gamma.net_gex_descoberto ? formatNumber(gamma.net_gex_descoberto) : '-';

      // Delta
      const delta = data.delta_data || {};
      document.getElementById('deltaBias').textContent = delta.market_bias || '-';
      document.getElementById('deltaDescoberto').textContent = delta.net_dex_descoberto ? formatNumber(delta.net_dex_descoberto) : '-';
      document.getElementById('deltaPressure').textContent = delta.remaining_pressure ? formatNumber(delta.remaining_pressure) : '-';

      // Vega
      const vega = data.vega_data || {};
      document.getElementById('vegaIV').textContent = vega.iv_mean ? `${vega.iv_mean.toFixed(1)}%` : '-';
      document.getElementById('vegaRisk').textContent = vega.max_risk_strike ? `R$ ${vega.max_risk_strike.toFixed(2)}` : '-';
      const skew = vega.iv_skew || {};
      document.getElementById('vegaSkew').textContent = skew.call_iv && skew.put_iv ? `${skew.call_iv.toFixed(1)}% / ${skew.put_iv.toFixed(1)}%` : '-';

      // Theta
      const theta = data.theta_data || {};
      document.getElementById('thetaDecay').textContent = theta.daily_decay ? `R$ ${formatNumber(theta.daily_decay)}/dia` : '-';
      document.getElementById('thetaStrike').textContent = theta.max_decay_strike ? `R$ ${theta.max_decay_strike.toFixed(2)}` : '-';
      document.getElementById('thetaRatio').textContent = theta.theta_gamma_ratio ? theta.theta_gamma_ratio.toFixed(3) : '-';

      // Gráfico
      if (data.plot_json) {
        const plotData = JSON.parse(data.plot_json);
        Plotly.newPlot('macroChart', plotData.data, plotData.layout, {responsive: true});
      }

      // Análise Integrada
      displayIntegratedAnalysis(data.integrated_analysis || {});

      // Show results
      document.getElementById('resultsSection').classList.remove('hidden');
    }

    function displayIntegratedAnalysis(analysis) {
      // Alertas
      const alertsContainer = document.getElementById('alertsContainer');
      const alerts = analysis.alerts || [];

      if (alerts.length === 0) {
        alertsContainer.innerHTML = '<p class="text-gray-400 text-sm">Nenhum alerta no momento</p>';
      } else {
        alertsContainer.innerHTML = alerts.map(alert => {
          const severityClass = alert.severity === 'HIGH' ? 'alert-high' : alert.severity === 'MEDIUM' ? 'alert-medium' : 'alert-low';
          return `
            <div class="p-4 rounded-lg ${severityClass}">
              <p class="text-sm font-semibold">${alert.type.replace(/_/g, ' ')}</p>
              <p class="text-xs text-gray-300 mt-1">${alert.message}</p>
            </div>
          `;
        }).join('');
      }

      // Oportunidades
      const opportunitiesContainer = document.getElementById('opportunitiesContainer');
      const opportunities = analysis.best_opportunities || [];

      if (opportunities.length === 0) {
        opportunitiesContainer.innerHTML = '<p class="text-gray-400 text-sm">Nenhuma oportunidade identificada</p>';
      } else {
        opportunitiesContainer.innerHTML = opportunities.map(opp => `
          <div class="p-4 rounded-lg bg-green-900/20 border-l-4 border-green-500">
            <p class="text-sm font-semibold text-green-400">${opp.strategy.replace(/_/g, ' ')}</p>
            <p class="text-xs text-gray-300 mt-1">${opp.reason}</p>
            <p class="text-xs text-yellow-400 mt-2">Expectativa: ${opp.expected_gain}</p>
          </div>
        `).join('');
      }

      // Zonas de Risco
      const riskZonesContainer = document.getElementById('riskZonesContainer');
      const riskZones = analysis.risk_zones || [];

      if (riskZones.length === 0) {
        riskZonesContainer.innerHTML = '<p class="text-gray-400 text-sm">Nenhuma zona de risco crítica</p>';
      } else {
        riskZonesContainer.innerHTML = riskZones.map(zone => `
          <div class="p-4 rounded-lg bg-red-900/20 border-l-4 border-red-500">
            <p class="text-sm font-semibold text-red-400">Strike: R$ ${zone.strike ? zone.strike.toFixed(2) : 'N/A'}</p>
            <p class="text-xs text-gray-300 mt-1">${zone.reason}</p>
            <p class="text-xs text-orange-400 mt-2">Impacto: ${zone.impact}</p>
          </div>
        `).join('');
      }
    }

    function formatNumber(num) {
      if (Math.abs(num) >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
      } else if (Math.abs(num) >= 1000) {
        return (num / 1000).toFixed(1) + 'k';
      }
      return num.toFixed(0);
    }

    // Enter key
    document.getElementById('tickerInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') analyzeMacro();
    });
  </script>

</body>
</html>
