<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Debug - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #0f0f0f;
      color: white;
    }
    
    .debug-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
    }
    
    .debug-box {
      background: #1a1a1a;
      border: 2px solid #333;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      text-align: center;
    }
    
    .step {
      margin: 15px 0;
      padding: 10px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .step.loading {
      background: #1e40af;
      color: white;
    }
    
    .step.success {
      background: #059669;
      color: white;
    }
    
    .step.error {
      background: #dc2626;
      color: white;
    }
    
    .step.waiting {
      background: #374151;
      color: #9ca3af;
    }
    
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid transparent;
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .main-content {
      display: none;
    }
    
    .main-content.show {
      display: block;
    }
    
    .debug-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      z-index: 1000;
    }
    
    .debug-info {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: rgba(0, 0, 0, 0.9);
      color: #00ff00;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-width: 300px;
      max-height: 400px;
      overflow-y: auto;
      display: none;
      border: 1px solid #333;
    }
    
    .debug-info.show {
      display: block;
    }
  </style>
</head>
<body>

  <!-- Debug Overlay -->
  <div id="debugOverlay" class="debug-overlay">
    <div class="debug-box">
      <h1 class="text-2xl font-bold mb-6">üîç Carregando Dashboard</h1>
      
      <div id="step1" class="step waiting">
        <span>1. Verificando dados locais...</span>
        <div id="spinner1" class="spinner" style="display: none;"></div>
        <span id="status1">‚è≥</span>
      </div>
      
      <div id="step2" class="step waiting">
        <span>2. Validando token com servidor...</span>
        <div id="spinner2" class="spinner" style="display: none;"></div>
        <span id="status2">‚è≥</span>
      </div>
      
      <div id="step3" class="step waiting">
        <span>3. Carregando dados do usu√°rio...</span>
        <div id="spinner3" class="spinner" style="display: none;"></div>
        <span id="status3">‚è≥</span>
      </div>
      
      <div id="step4" class="step waiting">
        <span>4. Finalizando interface...</span>
        <div id="spinner4" class="spinner" style="display: none;"></div>
        <span id="status4">‚è≥</span>
      </div>
      
      <div id="errorDetails" style="display: none;" class="mt-6 p-4 bg-red-900 rounded text-left">
        <h3 class="font-bold text-red-300">‚ùå Erro Detectado:</h3>
        <pre id="errorText" class="text-sm mt-2 text-red-200"></pre>
        <div class="mt-4">
          <button onclick="retryLoad()" class="bg-red-700 hover:bg-red-600 px-4 py-2 rounded mr-2">
            üîÑ Tentar Novamente
          </button>
          <button onclick="goToLogin()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">
            üîê Ir para Login
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Debug Info Panel -->
  <div id="debugInfo" class="debug-info">
    <div style="color: #ffff00; font-weight: bold; margin-bottom: 10px;">üîç DEBUG LOG</div>
    <div id="debugContent"></div>
  </div>

  <!-- Debug Toggle -->
  <button id="debugToggle" class="debug-toggle" onclick="toggleDebugInfo()">
    üêõ
  </button>

  <!-- Main Content -->
  <div id="mainContent" class="main-content">
    <nav class="bg-gray-900 px-6 py-4">
      <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <span class="text-xl font-bold text-white">Geminii</span>
        </div>
        <div class="flex items-center space-x-4">
          <div id="statusIndicator" class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <span class="text-sm text-gray-300">Online</span>
          </div>
          <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
            Sair
          </button>
        </div>
      </div>
    </nav>

    <main class="p-6">
      <div class="max-w-7xl mx-auto">
        <div class="bg-gray-800 rounded-xl p-8 mb-8">
          <h1 class="text-3xl font-bold text-white mb-4">
            Ol√°, <span id="userName" class="text-blue-400">Usu√°rio</span>!
          </h1>
          <p id="userEmail" class="text-gray-300">Bem-vindo ao seu dashboard</p>
          <div class="mt-4">
            <span class="text-gray-400">Plano: </span>
            <span id="userPlan" class="px-3 py-1 bg-gray-700 text-white rounded-full text-sm">Carregando...</span>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-gray-800 rounded-xl p-6">
            <h3 class="text-lg font-semibold text-white mb-2">Carteiras</h3>
            <div id="portfoliosCount" class="text-2xl font-bold text-blue-400">-</div>
          </div>
          
          <div class="bg-gray-800 rounded-xl p-6">
            <h3 class="text-lg font-semibold text-white mb-2">Recomenda√ß√µes</h3>
            <div id="recommendationsCount" class="text-2xl font-bold text-green-400">-</div>
          </div>
          
          <div class="bg-gray-800 rounded-xl p-6">
            <h3 class="text-lg font-semibold text-white mb-2">Performance</h3>
            <div id="performanceValue" class="text-2xl font-bold text-yellow-400">-</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    let debugLog = [];
    let currentUser = null;
    let userToken = null;

    // Fun√ß√£o para adicionar ao debug log
    function addDebugLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${message}`;
      debugLog.push(logEntry);
      
      const debugContent = document.getElementById('debugContent');
      if (debugContent) {
        debugContent.innerHTML = debugLog.join('<br>');
        debugContent.scrollTop = debugContent.scrollHeight;
      }
      
      console.log(logEntry);
    }

    // Atualizar step visual
    function updateStep(stepNum, status, message = '') {
      const step = document.getElementById(`step${stepNum}`);
      const spinner = document.getElementById(`spinner${stepNum}`);
      const statusIcon = document.getElementById(`status${stepNum}`);
      
      // Remover classes antigas
      step.classList.remove('waiting', 'loading', 'success', 'error');
      
      if (status === 'loading') {
        step.classList.add('loading');
        spinner.style.display = 'block';
        statusIcon.textContent = '';
        addDebugLog(`STEP ${stepNum}: LOADING - ${message}`);
      } else if (status === 'success') {
        step.classList.add('success');
        spinner.style.display = 'none';
        statusIcon.textContent = '‚úÖ';
        addDebugLog(`STEP ${stepNum}: SUCCESS - ${message}`);
      } else if (status === 'error') {
        step.classList.add('error');
        spinner.style.display = 'none';
        statusIcon.textContent = '‚ùå';
        addDebugLog(`STEP ${stepNum}: ERROR - ${message}`);
      }
    }

    // Mostrar erro
    function showError(error) {
      const errorDetails = document.getElementById('errorDetails');
      const errorText = document.getElementById('errorText');
      
      errorText.textContent = error.toString();
      errorDetails.style.display = 'block';
      
      addDebugLog(`ERRO CR√çTICO: ${error.toString()}`, 'error');
    }

    // Esconder overlay e mostrar dashboard
    function showDashboard() {
      document.getElementById('debugOverlay').style.display = 'none';
      document.getElementById('mainContent').classList.add('show');
      addDebugLog('Dashboard carregado com sucesso!');
    }

    // STEP 1: Verificar dados locais
    async function step1_CheckLocalData() {
      updateStep(1, 'loading', 'Verificando localStorage...');
      
      try {
        await new Promise(resolve => setTimeout(resolve, 500)); // Simular delay
        
        const token = localStorage.getItem('geminii_token');
        const userData = localStorage.getItem('geminii_user');
        
        if (!token) {
          throw new Error('Token n√£o encontrado no localStorage');
        }
        
        if (!userData) {
          throw new Error('Dados do usu√°rio n√£o encontrados no localStorage');
        }
        
        const user = JSON.parse(userData);
        if (!user.name || !user.email) {
          throw new Error('Dados do usu√°rio est√£o incompletos');
        }
        
        userToken = token;
        currentUser = user;
        
        updateStep(1, 'success', `Token e dados encontrados para ${user.name}`);
        return true;
        
      } catch (error) {
        updateStep(1, 'error', error.message);
        throw error;
      }
    }

    // STEP 2: Validar token com servidor
    async function step2_ValidateToken() {
      updateStep(2, 'loading', 'Validando com /auth/verify...');
      
      try {
        const response = await fetch('/auth/verify', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${userToken}`,
            'Content-Type': 'application/json'
          },
          cache: 'no-cache'
        });
        
        addDebugLog(`Resposta do servidor: ${response.status} ${response.statusText}`);
        
        if (!response.ok) {
          throw new Error(`Servidor retornou ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(`API retornou erro: ${result.error || 'Erro desconhecido'}`);
        }
        
        if (!result.data || !result.data.user) {
          throw new Error('Dados do usu√°rio n√£o retornados pela API');
        }
        
        // Atualizar dados do usu√°rio com os mais recentes
        currentUser = result.data.user;
        localStorage.setItem('geminii_user', JSON.stringify(currentUser));
        
        updateStep(2, 'success', `Token v√°lido para ${currentUser.name}`);
        return true;
        
      } catch (error) {
        updateStep(2, 'error', error.message);
        throw error;
      }
    }

    // STEP 3: Carregar dados do usu√°rio
    async function step3_LoadUserData() {
      updateStep(3, 'loading', 'Atualizando interface...');
      
      try {
        await new Promise(resolve => setTimeout(resolve, 300)); // Simular delay
        
        // Atualizar elementos da interface
        const userNameEl = document.getElementById('userName');
        const userEmailEl = document.getElementById('userEmail');
        const userPlanEl = document.getElementById('userPlan');
        
        if (userNameEl) userNameEl.textContent = currentUser.name;
        if (userEmailEl) userEmailEl.textContent = currentUser.email;
        if (userPlanEl) {
          userPlanEl.textContent = currentUser.plan_name || 'B√°sico';
          
          // Aplicar cor baseada no plano
          if (currentUser.plan_id === 1) {
            userPlanEl.className = 'px-3 py-1 bg-yellow-600 text-white rounded-full text-sm';
          } else if (currentUser.plan_id === 2) {
            userPlanEl.className = 'px-3 py-1 bg-purple-600 text-white rounded-full text-sm';
          } else {
            userPlanEl.className = 'px-3 py-1 bg-gray-600 text-white rounded-full text-sm';
          }
        }
        
        updateStep(3, 'success', 'Interface atualizada');
        return true;
        
      } catch (error) {
        updateStep(3, 'error', error.message);
        throw error;
      }
    }

    // STEP 4: Finalizar
    async function step4_Finalize() {
      updateStep(4, 'loading', 'Finalizando...');
      
      try {
        await new Promise(resolve => setTimeout(resolve, 500)); // Delay para mostrar loading
        
        // Carregar estat√≠sticas b√°sicas
        const portfoliosEl = document.getElementById('portfoliosCount');
        const recommendationsEl = document.getElementById('recommendationsCount');
        const performanceEl = document.getElementById('performanceValue');
        
        if (portfoliosEl) portfoliosEl.textContent = '0';
        if (recommendationsEl) recommendationsEl.textContent = '0';
        if (performanceEl) performanceEl.textContent = '0%';
        
        updateStep(4, 'success', 'Dashboard pronto!');
        
        // Aguardar 1 segundo e mostrar dashboard
        setTimeout(showDashboard, 1000);
        
        return true;
        
      } catch (error) {
        updateStep(4, 'error', error.message);
        throw error;
      }
    }

    // Processo principal de inicializa√ß√£o
    async function initDashboard() {
      addDebugLog('üöÄ Iniciando processo de carregamento do dashboard...');
      
      try {
        await step1_CheckLocalData();
        await step2_ValidateToken();
        await step3_LoadUserData();
        await step4_Finalize();
        
      } catch (error) {
        addDebugLog(`‚ùå FALHA NO CARREGAMENTO: ${error.message}`);
        showError(error);
      }
    }

    // Fun√ß√µes auxiliares
    function retryLoad() {
      location.reload();
    }

    function goToLogin() {
      localStorage.removeItem('geminii_token');
      localStorage.removeItem('geminii_user');
      window.location.href = '/login.html';
    }

    function toggleDebugInfo() {
      const debugInfo = document.getElementById('debugInfo');
      debugInfo.classList.toggle('show');
    }

    function logout() {
      localStorage.removeItem('geminii_token');
      localStorage.removeItem('geminii_user');
      window.location.href = '/login.html';
    }

    // Inicializar quando p√°gina carregar
    document.addEventListener('DOMContentLoaded', function() {
      addDebugLog('DOM carregado, iniciando dashboard...');
      setTimeout(initDashboard, 500); // Pequeno delay para mostrar o loading
    });

    // Tornar fun√ß√µes globais
    window.retryLoad = retryLoad;
    window.goToLogin = goToLogin;
    window.toggleDebugInfo = toggleDebugInfo;
    window.logout = logout;
  </script>
</body>
</html>