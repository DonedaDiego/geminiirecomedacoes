<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Greeks Micro 4D - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#000000',
            light: '#ffffff',
            subtle: 'rgba(255,255,255,0.1)',
            geminii: '#fb1ebb'
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      background: #0a0a0a;
      min-height: 100vh;
    }
    
    .greeks-card {
      background: rgba(30, 30, 30, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      transition: all 0.3s ease;
    }
    
    .greeks-card:hover {
      border-color: rgba(186, 57, 175, 0.3);
      box-shadow: 0 8px 32px rgba(186, 57, 175, 0.1);
    }
    
    .metric-box {
      background: rgba(20, 20, 20, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s ease;
    }

    .metric-box:hover {
      background: rgba(30, 30, 30, 0.9);
      border-color: rgba(186, 57, 175, 0.2);
      transform: translateY(-2px);
    }
    
    .spinner {
      border: 3px solid rgba(186, 57, 175, 0.1);
      border-radius: 50%;
      border-top: 3px solid #fb1ebb;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .chart-wrapper {
      background: rgba(20, 20, 20, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 24px;
      height: 450px;
    }

    .chart-container {
      width: 100%;
      height: 100%;
    }

    #expirationSelect {
      background-color: rgba(30, 30, 30, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: white;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    #expirationSelect option {
      background-color: #1a1a1a;
      color: white;
      padding: 10px;
    }

    #expirationSelect:focus {
      outline: none;
      border-color: #fb1ebb;
      box-shadow: 0 0 0 3px rgba(186, 57, 175, 0.15);
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .greek-badge {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.05em;
      padding: 4px 10px;
      border-radius: 6px;
      text-transform: uppercase;
    }

    .badge-gamma { background: rgba(6, 182, 212, 0.15); color: #06b6d4; border: 1px solid rgba(6, 182, 212, 0.3); }
    .badge-delta { background: rgba(168, 85, 247, 0.15); color: #a855f7; border: 1px solid rgba(168, 85, 247, 0.3); }
    .badge-vega { background: rgba(245, 158, 11, 0.15); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); }
    .badge-theta { background: rgba(220, 38, 38, 0.15); color: #dc2626; border: 1px solid rgba(220, 38, 38, 0.3); }

    .input-field {
      background: rgba(30, 30, 30, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: white;
      padding: 12px 16px;
      border-radius: 12px;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
    }

    .input-field:focus {
      outline: none;
      border-color: #fb1ebb;
      box-shadow: 0 0 0 3px rgba(186, 57, 175, 0.15);
      background: rgba(40, 40, 40, 0.95);
    }

    .input-field::placeholder { color: rgba(255, 255, 255, 0.4); }

    .btn-primary {
      background: linear-gradient(135deg, #fb1ebb 0%, #8b2f7d 100%);
      color: white;
      padding: 12px 28px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(186, 57, 175, 0.4);
    }

    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

    .btn-secondary {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.3);
      padding: 12px 28px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-secondary:hover:not(:disabled) {
      background: rgba(59, 130, 246, 0.25);
      border-color: rgba(59, 130, 246, 0.5);
      transform: translateY(-2px);
    }

    .status-badge {
      padding: 8px 16px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .status-success { background: rgba(34, 197, 94, 0.15); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); }
    .status-error { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
    .status-info { background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }

    .master-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 12px;
    }

    .master-table th {
      background: rgba(40, 40, 40, 0.9);
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .master-table td {
      padding: 10px 8px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      color: #ccc;
    }

    .master-table tr:hover td {
      background: rgba(186, 57, 175, 0.05);
    }

    .master-table tr.active-scenario td {
      background: rgba(186, 57, 175, 0.15);
      color: #fff;
      font-weight: 500;
    }

    .master-table tr.active-scenario td:first-child {
      border-left: 3px solid #fb1ebb;
    }

    .diagnostic-card {
      background: linear-gradient(135deg, rgba(30, 30, 30, 0.95) 0%, rgba(20, 20, 20, 0.95) 100%);
      border: 2px solid rgba(186, 57, 175, 0.3);
      border-radius: 20px;
      padding: 32px;
      position: relative;
      overflow: hidden;
    }

    .diagnostic-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #fb1ebb, #06b6d4, #a855f7, #f59e0b);
    }

    .structure-card {
      background: rgba(25, 25, 25, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .structure-card:hover {
      border-color: rgba(34, 197, 94, 0.3);
      transform: translateY(-2px);
    }

    .structure-card.primary {
      border-color: rgba(34, 197, 94, 0.4);
      background: rgba(34, 197, 94, 0.05);
    }

    .alert-item {
      background: rgba(25, 25, 25, 0.8);
      border-left: 3px solid;
      padding: 12px 16px;
      border-radius: 0 8px 8px 0;
      margin-bottom: 8px;
    }

    .alert-item.alert-danger { border-color: #ef4444; }
    .alert-item.alert-warning { border-color: #f59e0b; }
    .alert-item.alert-info { border-color: #3b82f6; }
    .alert-item.alert-success { border-color: #22c55e; }

    .dim-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .dim-positive { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .dim-negative { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .dim-neutral { background: rgba(156, 163, 175, 0.15); color: #9ca3af; }
    .dim-high { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .dim-low { background: rgba(34, 197, 94, 0.15); color: #22c55e }

    .educational-badge {
      display: inline-block;
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.3);
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 8px;
    }

    .reasoning-box {
      background: rgba(59, 130, 246, 0.05);
      border-left: 3px solid #3b82f6;
      padding: 12px;
      border-radius: 0 8px 8px 0;
      margin-top: 12px;
    }

    .conditions-box {
      background: rgba(245, 158, 11, 0.05);
      border-left: 3px solid #f59e0b;
      padding: 12px;
      border-radius: 0 8px 8px 0;
      margin-top: 8px;
    }

    @media (max-width: 768px) {
      .chart-wrapper {
        height: 350px;
        padding: 16px;
      }

      .metric-box {
        padding: 16px;
      }

      .diagnostic-card {
        padding: 24px;
      }

      .greeks-card {
        padding: 16px;
      }

      .section-title {
        font-size: 16px;
      }

      .master-table {
        font-size: 10px;
      }

      .master-table th,
      .master-table td {
        padding: 8px 4px;
      }

      nav {
        top: 4px;
        padding: 8px 12px;
      }

      nav .hidden {
        display: none !important;
      }

      .controls-mobile {
        flex-direction: column !important;
        width: 100%;
      }

      .controls-mobile > * {
        width: 100% !important;
      }
    }

    @media (max-width: 1024px) {
      .chart-wrapper {
        height: 380px;
      }
    }

    @media (max-width: 896px) and (orientation: landscape) {
      .chart-wrapper {
        height: 300px;
      }

      .pt-32 {
        padding-top: 80px;
      }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      .diagnostic-card {
        padding: 28px;
      }
    }
  </style>
</head>

<body class="text-white">
  
  <nav class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-opacity-5 border-opacity-10 bg-white border-white border rounded-full px-4 py-3 shadow-xl backdrop-blur-md">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <a href="/dashboard.html">
          <img src="logo.png" alt="Geminii Logo" class="w-6 h-6 cursor-pointer">
        </a>       
      </div>
      <div class="hidden md:flex items-center space-x-6 text-xs text-gray-300 ml-8">
        <span class="text-white font-medium">Visao Global</span>
        <a href="gamma-levels.html" class="hover:text-white transition-colors">Gamma Exposure</a>
        <a href="delta-levels.html" class="hover:text-white transition-colors">Delta Exposure</a>
        <a href="vega-levels.html" class="hover:text-white transition-colors">Vega Exposure</a>
        <a href="theta-levels.html" class="hover:text-white transition-colors">Theta Exposure</a>
        <a href="historical-levels.html" class="hover:text-white transition-colors">Analise Historica</a>
      </div>
      <div class="flex items-center space-x-3 ml-8">
        <div class="w-8 h-8 bg-purple-500 bg-opacity-10 border border-purple-500 border-opacity-30 rounded-full flex items-center justify-center relative">
          <i class="fas fa-layer-group text-purple-500 text-xs"></i>
          <div class="absolute -top-1 -right-1 w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>
        </div>
      </div>
    </div>
  </nav>

  <div class="pt-32 pb-16">
    <div class="max-w-[1800px] mx-auto px-6">
      
      <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-black mb-3">
          <span style="color: #fb1ebb;">Visao</span>
          <span class="text-white font-light">Global Micro 4D</span>
        </h1>
        <p class="text-neutral-400 text-base max-w-2xl mx-auto">
          Analise integrada GEX + DEX + VEX + TEX com diagnostico automatico de cenario e estruturas educacionais.
        </p>
     
      </div>

      <div class="greeks-card p-6 mb-8">
        <div class="flex flex-col md:flex-row gap-4 items-center justify-center controls-mobile">
          <input 
            id="tickerInput" 
            type="text" 
            placeholder="Digite o ticker (ex: BOVA11)" 
            class="input-field w-full md:w-56"
          >
          <select id="expirationSelect" class="input-field w-full md:w-56">
            <option value="">Vencimento Automatico</option>
          </select>
          <button id="loadExpirationsBtn" class="btn-secondary w-full md:w-auto">
            <i class="fas fa-calendar"></i>Carregar Vencimentos
          </button>
          <button id="analyzeBtn" class="btn-primary w-full md:w-auto">
            <i class="fas fa-bolt"></i>Executar Analise 4D
          </button>
        </div>
      </div>

      <div id="statusMsg" class="mb-6 text-center hidden"></div>

      <div id="resultsSection" class="hidden">
        
        <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-8">
          <div class="metric-box text-center">
            <div class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Spot Price</div>
            <div class="text-2xl font-black text-white" id="spotPrice">--</div>
          </div>
          <div class="metric-box text-center">
            <div class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Gamma Flip</div>
            <div class="text-2xl font-black text-orange-400" id="flipStrike">--</div>
          </div>
          <div class="metric-box text-center">
            <div class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">GEX Desc.</div>
            <div class="text-2xl font-black text-cyan-400" id="gexDescoberto">--</div>
          </div>
          <div class="metric-box text-center">
            <div class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Volume Hedge</div>
            <div class="text-2xl font-black text-orange-400" id="volumeHedge">--</div>
          </div>
          <div class="metric-box text-center">
            <div class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">IV Atual</div>
            <div class="text-2xl font-black text-amber-400" id="ivAtual">--</div>
          </div>
          <div class="metric-box text-center">
            <div class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Dias Venc.</div>
            <div class="text-2xl font-black text-red-400" id="diasVenc">--</div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          
          <div class="diagnostic-card">
            <div class="section-title mb-6">
              <i class="fas fa-diagnoses" style="color: #fb1ebb;"></i>
              Diagnostico 4D
            </div>
            
            <div class="mb-6">
              <div class="text-xs text-gray-500 uppercase tracking-wider mb-2">Cenario Identificado</div>
              <div class="text-xl font-bold text-white mb-1" id="scenarioName">--</div>
              <div class="text-sm text-gray-400" id="scenarioNumber">Cenario #--</div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
              <div>
                <div class="text-xs text-gray-500 mb-2">GEX (Gamma)</div>
                <div id="gexIndicator" class="dim-indicator dim-neutral">--</div>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-2">DEX (Delta)</div>
                <div id="dexIndicator" class="dim-indicator dim-neutral">--</div>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-2">VEX (Vega)</div>
                <div id="vexIndicator" class="dim-indicator dim-neutral">--</div>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-2">TEX (Theta)</div>
                <div id="texIndicator" class="dim-indicator dim-neutral">--</div>
              </div>
            </div>

            <div class="bg-black/30 rounded-xl p-4 mb-6">
              <div class="text-xs text-gray-500 uppercase tracking-wider mb-2">Interpretacao</div>
              <div class="text-sm text-gray-300 leading-relaxed" id="scenarioInterpretation">--</div>
            </div>

            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Forca do Sinal</div>
                <div class="text-2xl font-black" id="signalStrength">--</div>
                <div class="text-xs text-gray-500 mt-1" id="signalDescription">--</div>
              </div>
              <div>
                <div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Direcao Provavel</div>
                <div class="text-2xl font-black" id="probableDirection">--</div>
              </div>
              <div>
                <div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Intensidade</div>
                <div class="text-lg font-bold text-gray-300" id="intensityLevel">--</div>
              </div>
            </div>
          </div>

          <div class="greeks-card p-6">
            <div class="section-title mb-4">
              <i class="fas fa-graduation-cap" style="color: #22c55e;"></i>
              Estrategias Educacionais
            </div>
            <div class="mb-4 text-xs text-gray-400 bg-blue-500/10 border border-blue-500/30 rounded-lg p-3">
              <i class="fas fa-info-circle text-blue-400 mr-2"></i>
              As estratégias abaixo são conceituais com base na condição das posições em aberto das opçoes. Não incluem strikes específicos.
            </div>
            <div id="structuresContainer" class="space-y-4">
            </div>
          </div>

        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          
          <div class="greeks-card p-6">
            <div class="section-title mb-4">
              <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
              Alertas de Mudanca de Cenario
            </div>
            <div id="alertsContainer">
            </div>
          </div>

          <div class="greeks-card p-6">
            <div class="section-title mb-4">
              <i class="fas fa-ban" style="color: #ef4444;"></i>
              O Que Evitar
            </div>
            <div id="avoidContainer">
            </div>
          </div>

        </div>

        <div class="greeks-card p-6 mb-8">
          <div class="section-title mb-4">
            <i class="fas fa-chart-area" style="color: #06b6d4;"></i>
            Graficos Principais
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="chart-wrapper">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-gray-300">GEX Descoberto</h3>
                <span class="greek-badge badge-gamma">Gamma</span>
              </div>
              <div class="chart-container"><div id="gexDescChart"></div></div>
            </div>
            <div class="chart-wrapper">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-gray-300">DEX Momentum</h3>
                <span class="greek-badge badge-delta">Delta</span>
              </div>
              <div class="chart-container"><div id="dexMomentumChart"></div></div>
            </div>
            <div class="chart-wrapper">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-gray-300">VEX Descoberto</h3>
                <span class="greek-badge badge-vega">Vega</span>
              </div>
              <div class="chart-container"><div id="vexDescChart"></div></div>
            </div>
            <div class="chart-wrapper">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-gray-300">TEX Cumulativo</h3>
                <span class="greek-badge badge-theta">Theta</span>
              </div>
              <div class="chart-container"><div id="texCumChart"></div></div>
            </div>
          </div>
        </div>

        <div class="greeks-card p-6">
          <div class="section-title mb-4">
            <i class="fas fa-table" style="color: #a855f7;"></i>
            Matriz de Decisao 4D - 16 Cenarios
          </div>
          <div class="overflow-x-auto">
            <table class="master-table" id="masterTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>GEX</th>
                  <th>DEX</th>
                  <th>VEX</th>
                  <th>TEX</th>
                  <th>Cenario</th>
                  <th>Estrutura Ideal</th>
                  <th>Evitar</th>
                </tr>
              </thead>
              <tbody id="masterTableBody">
              </tbody>
            </table>
          </div>
        </div>

      </div>

    </div>
  </div>

  <script>
    const SCENARIOS_TABLE = {
      1: {
        gex: 'SHORT', dex: 'POS', vex: 'ALTO', tex: 'ALTO',
        name: 'Squeeze Iminente',
        structures: ['Compra de Call', 'Broken Wing Butterfly', 'Compra de Straddle'],
        avoid: ['Venda descoberta', 'Posições vendidas'],
        interpretation: 'MOVIMENTO EXPLOSIVO PARA CIMA IMINENTE! Os market makers estão "short gamma" e serão forçados a comprar o ativo agressivamente conforme o preço sobe, criando um ciclo de alta autoalimentado (quanto mais sobe, mais eles compram → mais sobe ainda). A volatilidade alta amplifica os ganhos e o theta elevado pressiona quem está vendido em opções. É o setup clássico de gamma squeeze – prepare o foguete!',
        direction: 'ALTA', intensity: 'EXPLOSIVA', urgency: 'ALTA'
      },
      2: {
        gex: 'SHORT', dex: 'POS', vex: 'ALTO', tex: 'BAIXO',
        name: 'Squeeze Gradual',
        structures: ['Compra de Call', 'Compra de Straddle'],
        avoid: ['Venda de volatilidade'],
        interpretation: 'Movimento de alta explosivo em formação, mas sem urgência imediata. Dealers short gamma precisarão comprar gradualmente conforme o preço sobe. Há tempo para confirmação antes de entrar.',
        direction: 'ALTA', intensity: 'EXPLOSIVA', urgency: 'BAIXA'
      },
      3: {
        gex: 'SHORT', dex: 'POS', vex: 'BAIXO', tex: 'ALTO',
        name: 'Squeeze Rápido',
        structures: ['Compra de Call'],
        avoid: ['Compra de volatilidade'],
        interpretation: 'Movimento técnico rápido de alta. Volatilidade baixa torna as calls relativamente baratas, aumentando a alavancagem em um squeeze de gamma com theta acelerado.',
        direction: 'ALTA', intensity: 'MODERADA', urgency: 'ALTA'
      },
      4: {
        gex: 'SHORT', dex: 'POS', vex: 'BAIXO', tex: 'BAIXO',
        name: 'Squeeze Controlado',
        structures: ['Compra de Call'],
        avoid: ['Posições de volatilidade'],
        interpretation: 'Viés de alta presente, mas controlado e sem pressão temporal forte. Dealers short gamma, porém com baixa vega e theta, o movimento tende a ser mais previsível e menos volátil.',
        direction: 'ALTA', intensity: 'MODERADA', urgency: 'BAIXA'
      },
      5: {
        gex: 'SHORT', dex: 'NEG', vex: 'ALTO', tex: 'ALTO',
        name: 'Crash IMINENTE',
        structures: ['Compra de Put', 'Broken Wing Butterfly', 'Compra de Straddle'],
        avoid: ['Posições compradas', 'Venda de Put'],
        interpretation: 'Risco máximo de queda explosiva iminente. Dealers short gamma e delta negativo forçarão vendas agressivas à medida que o preço cai, criando ciclo autodestrutivo amplificado pela alta volatilidade.',
        direction: 'QUEDA', intensity: 'EXPLOSIVA', urgency: 'CRITICA'
      },
      6: {
        gex: 'SHORT', dex: 'NEG', vex: 'ALTO', tex: 'BAIXO',
        name: 'Crash em Formacao',
        structures: ['Compra de Put', 'Compra de Straddle'],
        avoid: ['Calls', 'Posições de alta'],
        interpretation: 'Forte pressão vendedora em desenvolvimento. Short gamma com delta negativo indica potencial para queda violenta, embora o theta baixo dê mais tempo para o movimento se materializar.',
        direction: 'QUEDA', intensity: 'EXPLOSIVA', urgency: 'MODERADA'
      },
      7: {
        gex: 'SHORT', dex: 'NEG', vex: 'BAIXO', tex: 'ALTO',
        name: 'Correção Técnica',
        structures: ['Compra de Put'],
        avoid: ['Posições de alta'],
        interpretation: 'Correção técnica rápida e limitada. Baixa volatilidade e theta alto favorecem movimento descendente curto, sem potencial para crash amplificado.',
        direction: 'QUEDA', intensity: 'MODERADA', urgency: 'ALTA'
      },
      8: {
        gex: 'SHORT', dex: 'NEG', vex: 'BAIXO', tex: 'BAIXO',
        name: 'Correção Gradual',
        structures: ['Compra de Put'],
        avoid: ['Posições agressivas'],
        interpretation: 'Correção lenta e controlada. Ausência de pressão de vega e theta permite ajuste gradual de posições sem risco de aceleração brusca.',
        direction: 'QUEDA', intensity: 'LEVE', urgency: 'BAIXA'
      },
      9: {
        gex: 'LONG', dex: 'POS', vex: 'ALTO', tex: 'ALTO',
        name: 'Alta Controlada com Volatilidade',
        structures: ['Box de 3 Pontas', 'Broken Wing Butterfly', 'Venda de Put'],
        avoid: ['Compra de volatilidade', 'Long Straddles'],
        interpretation: 'Cenário IDEAL para Box de 3 Pontas e Broken Wing Butterfly! Alta volatilidade oferece prêmios extremamente elevados, enquanto gamma positivo dos dealers limita movimentos bruscos. Vencimento próximo (TEX ALTO) permite montar broken wings com alta probabilidade de ganho. Box de 3 Pontas garante ganho conhecido com risco zero. Venda de puts também favorecida pelos prêmios inflados.',
        direction: 'ALTA', intensity: 'CONTROLADA', urgency: 'MODERADA'
      },
      10: {
        gex: 'LONG', dex: 'POS', vex: 'ALTO', tex: 'BAIXO',
        name: 'Alta Saudável',
        structures: ['Box de 3 Pontas', 'Venda de Put', 'Venda Coberta'],
        avoid: ['Compra de volatilidade'],
        interpretation: 'Cenário favorável para vendedores de opções. Alta sustentada com gamma positivo dos dealers e volatilidade elevada, oferecendo prêmios atrativos com risco controlado. Box de 3 Pontas aproveita prêmios inflados com ganho garantido.',
        direction: 'ALTA', intensity: 'CONTROLADA', urgency: 'BAIXA'
      },
      11: {
        gex: 'LONG', dex: 'POS', vex: 'BAIXO', tex: 'ALTO',
        name: 'Subida Gradual Acelerada',
        structures: ['Venda de Put', 'Collar de Alta'],
        avoid: ['Compra de opcoes caras'],
        interpretation: 'Subida gradual com decaimento temporal acelerado. Baixa volatilidade e theta alto favorecem estratégias de venda de puts, com gamma positivo contendo variações bruscas.',
        direction: 'ALTA', intensity: 'LEVE', urgency: 'MODERADA'
      },
      12: {
        gex: 'LONG', dex: 'POS', vex: 'BAIXO', tex: 'BAIXO',
        name: 'Subida Gradual',
        structures: ['Venda de Put', 'Venda Coberta'],
        avoid: ['Posições de volatilidade'],
        interpretation: 'Cenário ideal de estabilidade altista. Gamma positivo, baixa vega e theta controlado indicam tendência de alta suave e sustentável, perfeito para buy and hold ou venda coberta.',
        direction: 'ALTA', intensity: 'LEVE', urgency: 'BAIXA'
      },
      13: {
        gex: 'LONG', dex: 'NEG', vex: 'ALTO', tex: 'ALTO',
        name: 'Correção Leve com Volatilidade',
        structures: ['Broken Wing Butterfly', 'Collar de Baixa', 'Compra de Put'],
        avoid: ['Posições de alta', 'Calls descobertas'],
        interpretation: 'Correção controlada com alta volatilidade. Dealers long gamma limitam a queda, enquanto prêmios elevados favorecem broken wing butterfly bearish e proteção com puts. Vencimento próximo aumenta eficiência das estruturas.',
        direction: 'QUEDA', intensity: 'CONTROLADA', urgency: 'MODERADA'
      },
      14: {
        gex: 'LONG', dex: 'NEG', vex: 'ALTO', tex: 'BAIXO',
        name: 'Recuo Saudável',
        structures: ['Collar de Baixa'],
        avoid: ['Calls'],
        interpretation: 'Pullback saudável e controlado. Gamma positivo dos dealers contém a queda, oferecendo oportunidade de proteção ou ajuste de posições longas sem pânico.',
        direction: 'QUEDA', intensity: 'CONTROLADA', urgency: 'BAIXA'
      },
      15: {
        gex: 'LONG', dex: 'NEG', vex: 'BAIXO', tex: 'ALTO',
        name: 'Queda Gradual Acelerada',
        structures: ['Collar de Baixa'],
        avoid: ['Posições de alta'],
        interpretation: 'Queda gradual com decaimento temporal forte. Baixa volatilidade e theta alto corroem valor de posições longas em opções, favorecendo estratégias defensivas.',
        direction: 'QUEDA', intensity: 'LEVE', urgency: 'MODERADA'
      },
      16: {
        gex: 'LONG', dex: 'NEG', vex: 'BAIXO', tex: 'BAIXO',
        name: 'Queda Gradual Lenta',
        structures: ['Collar de Baixa'],
        avoid: ['Posições agressivas'],
        interpretation: 'Queda muito lenta em mercado de baixa energia. Ausência de pressão de vega e theta indica movimento prolongado e sem aceleração, típico de consolidação bearish.',
        direction: 'QUEDA', intensity: 'LEVE', urgency: 'BAIXA'
      }
    };

    let userToken = localStorage.getItem('geminii_token');
    if (!userToken) window.location.href = '/login.html';

    let gammaData = null;
    let deltaData = null;
    let vegaData = null;
    let thetaData = null;
    let currentScenario = null;

    function formatLargeNumber(value) {
      if (value === null || value === undefined) return '--';
      const absValue = Math.abs(value);
      if (absValue >= 1000000000) return (value / 1000000000).toFixed(1) + 'B';
      if (absValue >= 1000000) return (value / 1000000).toFixed(1) + 'M';
      if (absValue >= 1000) return (value / 1000).toFixed(1) + 'K';
      return value.toFixed(0);
    }

    function showStatus(message, type = 'info') {
      const statusMsg = document.getElementById('statusMsg');
      const statusClass = type === 'success' ? 'status-success' : type === 'error' ? 'status-error' : 'status-info';
      const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
      statusMsg.className = `mb-6 text-center status-badge ${statusClass}`;
      statusMsg.innerHTML = `<i class="fas ${icon}"></i>${message}`;
      statusMsg.classList.remove('hidden');
      setTimeout(() => statusMsg.classList.add('hidden'), 5000);
    }

    function setLoading(button, loading) {
      button.disabled = loading;
      if (loading) {
        button.setAttribute('data-original', button.innerHTML);
        button.innerHTML = '<span class="spinner mr-2"></span>Processando...';
      } else {
        const original = button.getAttribute('data-original');
        if (original) button.innerHTML = original;
      }
    }

    function classifyScenario(gamma, delta, vega, theta) {
      // ✅ USA O REGIME DA API (NÃO O SINAL DO VALOR)
      const gexRegime = gamma?.regime || 'Long Gamma';
      const gexSign = gexRegime.includes('Short') ? 'SHORT' : 'LONG';
      
      // ✅ USA O MARKET_BIAS DA API (NÃO O SINAL DO total_dex_descoberto)
      const marketBias = delta?.dex_levels?.market_bias || 'NEUTRAL';
      const dexSign = (marketBias === 'BULLISH') ? 'POS' : 
                      (marketBias === 'BEARISH') ? 'NEG' : 'POS';  // ✅ CORREÇÃO AQUI
      
      const vexRisk = vega?.vol_regime?.volatility_risk || 'LOW';
      const vexLevel = (vexRisk === 'HIGH') ? 'ALTO' : 'BAIXO';  
      
      const texDays = theta?.decay_regime?.weighted_days || 30;
      const texPressure = theta?.decay_regime?.time_pressure || 'LOW';
      const texLevel = (texPressure === 'HIGH') ? 'ALTO' : 'BAIXO';
      
      // Busca o cenário na tabela
      for (let i = 1; i <= 16; i++) {
        const s = SCENARIOS_TABLE[i];
        if (s.gex === gexSign && s.dex === dexSign && s.vex === vexLevel && s.tex === texLevel) {
          return {
            number: i,
            ...s,
            raw: { 
              gexValue: gamma?.gex_levels?.total_gex_descoberto || 0,
              dexValue: delta?.dex_levels?.total_dex_descoberto || 0,  // ✅ Manter valor real
              vexRisk, 
              texDays, 
              gexSign, 
              dexSign, 
              vexLevel, 
              texLevel 
            }
          };
        }
      }
      
      return { number: 0, name: 'Indefinido', raw: { gexSign, dexSign, vexLevel, texLevel } };
    }

    function calculateSignalStrength(scenario, gamma, delta, vega, theta) {
      let alignedFactors = 0;
      let intensityScore = 0;
      
      const gexValue = gamma?.gex_levels?.total_gex_descoberto || 0;
      const dexValue = delta?.dex_levels?.total_dex_descoberto || 0;
      const direction = scenario.direction;
      
      if (direction === 'ALTA' && gexValue < 0) alignedFactors++;
      if (direction === 'QUEDA' && gexValue < 0) alignedFactors++;
      if (direction === 'ALTA' && gexValue > 0) alignedFactors++;
      if (direction === 'QUEDA' && gexValue > 0) alignedFactors++;
      
      if (direction === 'ALTA' && dexValue > 0) alignedFactors++;
      if (direction === 'QUEDA' && dexValue < 0) alignedFactors++;
      
      const vexRisk = vega?.vol_regime?.volatility_risk || 'LOW';
      if (vexRisk === 'HIGH' || vexRisk === 'MODERATE') intensityScore++;
      
      const texDays = theta?.decay_regime?.weighted_days || 30;
      if (texDays < 20) intensityScore++;
      
      const gexMagnitude = Math.abs(gexValue);
      const dexMagnitude = Math.abs(dexValue);
      
      if (gexMagnitude > 5000000000) intensityScore++;
      if (dexMagnitude > 200000000) intensityScore++;
      
      const totalScore = alignedFactors + intensityScore;
      
      if (totalScore >= 5) {
        return { level: 'FORTE', class: 'text-green-400', description: 'Todos indicadores alinhados' };
      } else if (totalScore >= 3) {
        return { level: 'MODERADO', class: 'text-yellow-400', description: 'Maioria dos indicadores alinhados' };
      } else {
        return { level: 'FRACO', class: 'text-red-400', description: 'Sinais mistos ou baixa intensidade' };
      }
    }

    async function calculateStructuresReal(scenario, gamma, delta) {
      const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
      
      try {
        const response = await fetch('/api/oplab/estruturas-inteligentes', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${userToken}`
          },
          body: JSON.stringify({
            ticker: ticker,
            spot_price: gamma?.spot_price || 0,
            flip_strike: gamma?.flip_strike || 0,
            gex_descoberto: gamma?.gex_levels?.total_gex_descoberto || 0,
            cenario: {
              name: scenario.name,
              direction: scenario.direction,
              number: scenario.number
            }
          })
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
          console.error('Erro estruturas reais:', data.error || data.message);
          return [];
        }
        
        return data.data.estruturas.map(est => ({
          name: est.name,
          primary: est.primary || false,
          tipo_operacao: est.tipo_operacao,
          legs: est.legs,
          logic: est.logic,
          reasoning: est.reasoning,
          ideal_conditions: est.ideal_conditions,
          max_profit: est.max_profit,
          max_loss: est.max_loss
        }));
        
      } catch (error) {
        console.error('Erro requisicao estruturas:', error);
        return [];
      }
    }

    function calculateAlerts(scenario, gamma, delta, vega, theta) {
      const alerts = [];
      const spotPrice = gamma?.spot_price || 0;
      const flipStrike = gamma?.flip_strike || spotPrice;
      
      // ✅ PEGA OS WALLS REAIS DA API
      const supportWall = gamma?.walls?.support || null;
      const resistanceWall = gamma?.walls?.resistance || null;
      
      // ✅ REGIME ATUAL
      const currentRegime = gamma?.regime || 'Long Gamma';
      const isShortGamma = currentRegime.toLowerCase().includes('short');
      
      // ═══════════════════════════════════════════════════════════
      // ALERTAS BASEADOS NO REGIME ATUAL
      // ═══════════════════════════════════════════════════════════
      
      if (isShortGamma) {
        // ━━━ SHORT GAMMA: Movimento pode AMPLIFICAR ━━━
        
        alerts.push({
          type: 'danger',
          title: `Regime Atual: SHORT GAMMA (${scenario.direction === 'ALTA' ? 'Explosivo' : 'Crash'})`,
          message: `Dealers vão ${scenario.direction === 'ALTA' ? 'COMPRAR' : 'VENDER'} agressivamente conforme movimento se desenvolve, AMPLIFICANDO a direção. Zona de alta volatilidade.`
        });
        
        // ✅ BARREIRA DE ACELERAÇÃO = PRÓXIMO WALL NA DIREÇÃO
        if (scenario.direction === 'ALTA' && supportWall && supportWall > spotPrice) {
          alerts.push({
            type: 'warning',
            title: 'Barreira de Aceleração',
            message: `Acima de R$ ${supportWall.toFixed(2)}: Squeeze pode se intensificar. Wall de calls concentradas força dealers a comprar mais ações.`
          });
        } else if (scenario.direction === 'QUEDA' && resistanceWall && resistanceWall < spotPrice) {
          alerts.push({
            type: 'warning',
            title: 'Barreira de Aceleração',
            message: `Abaixo de R$ ${resistanceWall.toFixed(2)}: Queda pode acelerar. Wall de puts concentradas força dealers a vender mais ações.`
          });
        }
        
        // Mudança de Regime
        alerts.push({
          type: 'info',
          title: 'Mudança de Regime',
          message: `Se romper ${spotPrice < flipStrike ? 'acima' : 'abaixo'} de R$ ${flipStrike.toFixed(2)} (Gamma Flip), muda para LONG GAMMA. Movimento volta a ser contido pelos dealers.`
        });
        
      } else {
        // ━━━ LONG GAMMA: Movimento será CONTIDO ━━━
        
        alerts.push({
          type: 'success',
          title: `Regime Atual: LONG GAMMA (${scenario.direction === 'ALTA' ? 'Controlado' : 'Amortecido'})`,
          message: `Dealers vão ${scenario.direction === 'ALTA' ? 'VENDER' : 'COMPRAR'} conforme movimento se desenvolve, CONTENDO extremos. Zona de estabilidade.`
        });
        
        // ✅ BARREIRA DE CONTENÇÃO = WALL MAIS PRÓXIMO
        if (scenario.direction === 'ALTA' && supportWall && supportWall > spotPrice) {
          alerts.push({
            type: 'info',
            title: 'Barreira de Contenção (Resistência)',
            message: `Acima de R$ ${supportWall.toFixed(2)}: Resistência forte. Wall de calls obriga dealers a vender ações, contendo a alta.`
          });
        } else if (scenario.direction === 'QUEDA' && resistanceWall && resistanceWall < spotPrice) {
          alerts.push({
            type: 'info',
            title: 'Barreira de Contenção (Suporte)',
            message: `Abaixo de R$ ${resistanceWall.toFixed(2)}: Suporte forte. Wall de puts obriga dealers a comprar ações, contendo a queda.`
          });
        }
        
        // Mudança de Regime
        alerts.push({
          type: 'warning',
          title: 'Mudança de Regime',
          message: `Se romper ${spotPrice > flipStrike ? 'abaixo' : 'acima'} de R$ ${flipStrike.toFixed(2)} (Gamma Flip), muda para SHORT GAMMA. Movimento pode se tornar explosivo.`
        });
      }
      
      // ═══════════════════════════════════════════════════════════
      // ALERTAS DE DEX, VEX, TEX
      // ═══════════════════════════════════════════════════════════
      
      const dexValue = delta?.dex_levels?.total_dex_descoberto || 0;
      const ivAtual = vega?.vol_regime?.weighted_iv || 0;
      const diasVenc = theta?.decay_regime?.weighted_days || 30;
      
      // DEX
      if (Math.abs(dexValue) > 200000000) {
        alerts.push({
          type: 'info',
          title: `Pressão ${dexValue > 0 ? 'Compradora' : 'Vendedora'} Forte`,
          message: `DEX descoberto em ${formatLargeNumber(dexValue)}. ${dexValue > 0 ? 'Viés altista' : 'Viés baixista'} robusto dos MMs.`
        });
      } else if (Math.abs(dexValue) < 50000000) {
        alerts.push({
          type: 'info',
          title: 'DEX Fraco',
          message: 'Pressão direcional fraca. Viés pode mudar facilmente.'
        });
      }
      
      // TEX
      if (diasVenc < 7) {
        alerts.push({
          type: 'danger',
          title: 'Theta CRÍTICO',
          message: `Apenas ${Math.round(diasVenc)} dias até vencimento! Decay exponencial. Posições compradas sangram rapidamente.`
        });
      } else if (diasVenc < 14) {
        alerts.push({
          type: 'warning',
          title: 'Theta Acelerado',
          message: `${Math.round(diasVenc)} dias até vencimento. Theta começa a acelerar. Atenção em posições long.`
        });
      }
      
      // VEX
      if (ivAtual > 50) {
        alerts.push({
          type: 'info',
          title: 'IV Elevada',
          message: `IV em ${ivAtual.toFixed(1)}%. Opções caras. ${scenario.vex === 'ALTO' ? 'Ideal para vender volatilidade.' : 'Considere estruturas de venda.'}`
        });
      } else if (ivAtual < 20) {
        alerts.push({
          type: 'info',
          title: 'IV Comprimida',
          message: `IV em ${ivAtual.toFixed(1)}%. Opções baratas. Possível explosão de volatilidade à frente.`
        });
      }
      
      return alerts;
    }

    function calculateSmartBarriers(spot, flip, isShortGamma, direction) {
      const barriers = {};
      
      if (isShortGamma) {
        // SHORT GAMMA: Spot está ABAIXO do flip
        
        // Barreira de aceleração (próxima barreira na direção do movimento)
        if (direction === 'ALTA') {
          // Próximo strike psicológico acima (arredonda para cima)
          barriers.acceleration = Math.ceil(spot / 0.50) * 0.50 + 0.50;
        } else {
          // Próximo strike psicológico abaixo (arredonda para baixo)
          barriers.acceleration = Math.floor(spot / 0.50) * 0.50 - 0.50;
        }
        
        // Barreira de mudança de regime = Gamma Flip + margem
        barriers.regimeChange = flip + 0.25;
        
      } else {
        // LONG GAMMA: Spot está ACIMA do flip
        
        // Barreiras de contenção (onde dealers atuam mais forte)
        if (direction === 'ALTA') {
          // Resistência: próximo strike redondo acima + 2%
          barriers.resistance = Math.ceil(spot / 1.00) * 1.00 + (spot * 0.02);
        } else {
          // Suporte: próximo strike redondo abaixo - 2%
          barriers.support = Math.floor(spot / 1.00) * 1.00 - (spot * 0.02);
        }
        
        // Barreira de mudança de regime = Gamma Flip - margem
        barriers.regimeChange = flip - 0.25;
      }
      
      return barriers;
    }
    
    function renderMasterTable(activeScenario) {
      const tbody = document.getElementById('masterTableBody');
      tbody.innerHTML = '';
      
      for (let i = 1; i <= 16; i++) {
        const s = SCENARIOS_TABLE[i];
        const isActive = activeScenario === i;
        
        const tr = document.createElement('tr');
        if (isActive) tr.classList.add('active-scenario');
        
        tr.innerHTML = `
          <td class="font-mono">${i}</td>
          <td><span class="dim-indicator ${s.gex === 'SHORT' ? 'dim-negative' : 'dim-positive'}">${s.gex}</span></td>
          <td><span class="dim-indicator ${s.dex === 'POS' ? 'dim-positive' : 'dim-negative'}">${s.dex}</span></td>
          <td><span class="dim-indicator ${s.vex === 'ALTO' ? 'dim-high' : 'dim-low'}">${s.vex}</span></td>
          <td><span class="dim-indicator ${s.tex === 'ALTO' ? 'dim-high' : 'dim-low'}">${s.tex}</span></td>
          <td class="font-medium">${s.name}</td>
          <td class="text-green-400 text-xs">${s.structures.slice(0, 2).join(', ')}</td>
          <td class="text-red-400 text-xs">${s.avoid.slice(0, 2).join(', ')}</td>
        `;
        
        tbody.appendChild(tr);
      }
    }

    function renderDiagnostic(scenario, signalStrength) {
      document.getElementById('scenarioName').textContent = scenario.name || '--';
      document.getElementById('scenarioNumber').textContent = `Cenario #${scenario.number || '--'}`;
      
      const gexInd = document.getElementById('gexIndicator');
      const dexInd = document.getElementById('dexIndicator');
      const vexInd = document.getElementById('vexIndicator');
      const texInd = document.getElementById('texIndicator');
      
      gexInd.textContent = scenario.raw?.gexSign || '--';
      gexInd.className = `dim-indicator ${scenario.raw?.gexSign === 'SHORT' ? 'dim-negative' : 'dim-positive'}`;
      
      dexInd.textContent = scenario.raw?.dexSign || '--';
      dexInd.className = `dim-indicator ${scenario.raw?.dexSign === 'POS' ? 'dim-positive' : 'dim-negative'}`;
      
      vexInd.textContent = scenario.raw?.vexLevel || '--';
      vexInd.className = `dim-indicator ${scenario.raw?.vexLevel === 'ALTO' ? 'dim-high' : 'dim-low'}`;
      
      texInd.textContent = scenario.raw?.texLevel || '--';
      texInd.className = `dim-indicator ${scenario.raw?.texLevel === 'ALTO' ? 'dim-high' : 'dim-low'}`;
      
      document.getElementById('scenarioInterpretation').textContent = scenario.interpretation || '--';
      
      const strengthEl = document.getElementById('signalStrength');
      strengthEl.textContent = signalStrength.level;
      strengthEl.className = `text-2xl font-black ${signalStrength.class}`;
      document.getElementById('signalDescription').textContent = signalStrength.description;
      
      const dirEl = document.getElementById('probableDirection');
      dirEl.textContent = scenario.direction || '--';
      dirEl.className = `text-2xl font-black ${scenario.direction === 'ALTA' ? 'text-green-400' : 'text-red-400'}`;
      
      document.getElementById('intensityLevel').textContent = scenario.intensity || '--';
    }

    function renderStructures(structures) {
      const container = document.getElementById('structuresContainer');
      container.innerHTML = '';
      
      structures.forEach((struct, idx) => {
        const card = document.createElement('div');
        card.className = `structure-card ${struct.primary ? 'primary' : ''}`;
        
        const legsHtml = struct.legs.map(leg => {
          return `<div class="text-sm mb-2">
            <div class="flex items-center gap-2">
              <span class="${leg.action === 'Compra' ? 'text-green-400' : 'text-red-400'} font-semibold">${leg.action}</span>
              <span class="text-gray-300">${leg.type}</span>
              
            </div>
            ${leg.note ? `<div class="text-gray-500 text-xs ml-4 mt-1"><i class="fas fa-info-circle mr-1"></i>${leg.note}</div>` : ''}
          </div>`;
        }).join('');
        
        const reasoningHtml = struct.reasoning ? `
          <div class="reasoning-box">
            <div class="text-xs font-semibold text-blue-400 mb-1">
              <i class="fas fa-lightbulb mr-1"></i>Por que funciona?
            </div>
            <div class="text-xs text-gray-300">${struct.reasoning}</div>
          </div>
        ` : '';

        const conditionsHtml = struct.ideal_conditions ? `
          <div class="conditions-box">
            <div class="text-xs font-semibold text-amber-400 mb-1">
              <i class="fas fa-check-circle mr-1"></i>Condições ideais
            </div>
            <div class="text-xs text-gray-300">${struct.ideal_conditions}</div>
          </div>
        ` : '';

        const metricsHtml = `
          <div class="mt-3 pt-3 border-t border-white/10 text-xs text-gray-500 space-y-1">
            
          </div>
        `;
        
        card.innerHTML = `
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-bold text-white">${struct.name}</h4>
            <div class="flex items-center gap-2">
              ${struct.primary ? '<span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">PRINCIPAL</span>' : ''}
            </div>
          </div>
          <div class="space-y-1 mb-3">${legsHtml}</div>
          <div class="text-xs text-gray-400 bg-black/20 p-3 rounded-lg">${struct.logic}</div>
          ${reasoningHtml}
          ${conditionsHtml}
          ${metricsHtml}
          <div class="educational-badge">
            <i class="fas fa-graduation-cap mr-1"></i>
            Material educacional
          </div>
        `;
        
        container.appendChild(card);
      });
    }

    function renderAlerts(alerts) {
      const container = document.getElementById('alertsContainer');
      container.innerHTML = '';
      
      alerts.forEach(alert => {
        const item = document.createElement('div');
        item.className = `alert-item alert-${alert.type}`;
        item.innerHTML = `
          <div class="font-semibold text-sm text-white mb-1">${alert.title}</div>
          <div class="text-xs text-gray-400">${alert.message}</div>
        `;
        container.appendChild(item);
      });
    }

    function renderAvoid(scenario) {
      const container = document.getElementById('avoidContainer');
      container.innerHTML = '';
      
      (scenario.avoid || []).forEach(item => {
        const div = document.createElement('div');
        div.className = 'alert-item alert-danger';
        div.innerHTML = `
          <div class="flex items-center gap-2">
            <i class="fas fa-times-circle text-red-400"></i>
            <span class="text-sm text-gray-300">${item}</span>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function renderCharts() {
      if (typeof Plotly === 'undefined') {
        console.error('Plotly nao carregado');
        return;
      }

      try {
        renderSingleChart('gexDescChart', gammaData.plot_json, 'GEX Descoberto');
        renderSingleChart('dexMomentumChart', deltaData.plot_json, 'DEX Momentum');
        renderSingleChart('vexDescChart', vegaData.plot_json, 'VEX Descoberto');
        renderSingleChart('texCumChart', thetaData.plot_json, 'TEX Cumulativo');

      } catch (error) {
        console.error('Erro ao renderizar graficos:', error);
      }
    }

    function renderSingleChart(elementId, plotJson, title) {
      if (!plotJson) {
        console.warn(`Plot JSON nao encontrado para ${elementId}`);
        return;
      }

      try {
        const plotData = JSON.parse(plotJson);
        
        const config = {
          responsive: true,
          displayModeBar: false,
          displaylogo: false
        };

        const layout = {
          ...plotData.layout,
          height: 380,
          margin: { l: 60, r: 20, t: 30, b: 50 },
          paper_bgcolor: 'rgba(0,0,0,0)',
          plot_bgcolor: 'rgba(0,0,0,0)',
          font: { 
            color: '#888888', 
            family: 'Inter, sans-serif', 
            size: 10 
          },
          xaxis: {
            ...plotData.layout.xaxis,
            gridcolor: 'rgba(255,255,255,0.08)',
            color: '#666666',
            showgrid: true,
            zeroline: false,
            showline: false
          },
          yaxis: {
            ...plotData.layout.yaxis,
            gridcolor: 'rgba(255,255,255,0.08)',
            color: '#666666',
            showgrid: true,
            zeroline: true,
            zerolinecolor: 'rgba(255,255,255,0.2)',
            showline: false
          },
          showlegend: false,
          hovermode: 'x unified',
          hoverlabel: {
            bgcolor: 'rgba(20, 20, 20, 0.95)',
            bordercolor: '#fb1ebb',
            font: {
              family: 'Inter, sans-serif',
              size: 13,
              color: '#ffffff'
            }
          },
          title: {
            text: '',
            font: { size: 14, color: '#ffffff' }
          },
          annotations: []
        };

        Plotly.newPlot(elementId, plotData.data, layout, config);
        
        setTimeout(() => {
          try {
            Plotly.Plots.resize(elementId);
          } catch (e) {
            console.warn('Resize falhou:', e);
          }
        }, 100);

      } catch (error) {
        console.error(`Erro ao renderizar ${elementId}:`, error);
        document.getElementById(elementId).innerHTML = 
          '<div class="text-center text-red-400 text-xs p-4">Erro ao carregar grafico</div>';
      }
    }

    async function displayResults() {
      // ========================================
      // MÉTRICAS PRINCIPAIS - CÓPIA EXATA DO delta-levels.html
      // ========================================
      
      // 1. SPOT PRICE (OK)
      document.getElementById('spotPrice').textContent = `R$ ${gammaData.spot_price?.toFixed(2) || '--'}`;
      
      // 2. GAMMA FLIP (OK)
      document.getElementById('flipStrike').textContent = gammaData.flip_strike ? `R$ ${gammaData.flip_strike.toFixed(2)}` : 'N/A';
      
      // 3. GEX DESCOBERTO (OK - esse está certo)
      document.getElementById('gexDescoberto').textContent = formatLargeNumber(gammaData.gex_levels?.total_gex_descoberto);
      
      // 4. ✅ DEX DESCOBERTO (CORREÇÃO)
      const dex_levels = deltaData.dex_levels || {};
      const netDexTotal = dex_levels.total_dex || 0;
      document.getElementById('volumeHedge').textContent = formatLargeNumber(netDexTotal);
      
      // 5. IV ATUAL (OK)
      document.getElementById('ivAtual').textContent = vegaData.vol_regime?.weighted_iv ? `${vegaData.vol_regime.weighted_iv.toFixed(1)}%` : '--';
      
      // 6. DIAS VENCIMENTO (OK)
      document.getElementById('diasVenc').textContent = thetaData.decay_regime?.weighted_days ? `${Math.round(thetaData.decay_regime.weighted_days)}d` : '--';
      
      // ========================================
      // CENÁRIO 4D
      // ========================================
      currentScenario = classifyScenario(gammaData, deltaData, vegaData, thetaData);
      const signalStrength = calculateSignalStrength(currentScenario, gammaData, deltaData, vegaData, thetaData);
      
      renderMasterTable(currentScenario.number);
      renderDiagnostic(currentScenario, signalStrength);
      
      const structures = await calculateStructuresReal(currentScenario, gammaData, deltaData);
      renderStructures(structures);
      
      const alerts = calculateAlerts(currentScenario, gammaData, deltaData, vegaData, thetaData);
      renderAlerts(alerts);
      
      renderAvoid(currentScenario);
      renderCharts();
      
      document.getElementById('resultsSection').classList.remove('hidden');
  }

    async function loadExpirations() {
      const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
      if (!ticker) { showStatus('Digite um ticker primeiro', 'error'); return; }

      const btn = document.getElementById('loadExpirationsBtn');
      setLoading(btn, true);

      try {
        const response = await fetch('/pro/gamma/expirations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
          body: JSON.stringify({ ticker })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error);

        const select = document.getElementById('expirationSelect');
        select.innerHTML = '<option value="">Vencimento Automatico</option>';
        
        data.expirations.forEach(exp => {
          const option = document.createElement('option');
          option.value = exp.code;
          option.textContent = `${exp.desc} (${exp.data_count} contratos)`;
          option.disabled = !exp.available;
          select.appendChild(option);
        });
        
        showStatus(`${data.total_available} vencimentos carregados`, 'success');

      } catch (error) {
        showStatus('Erro: ' + error.message, 'error');
      } finally {
        setLoading(btn, false);
      }
    }

    async function runFullAnalysis() {
      const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
      if (!ticker) { 
        showStatus('Digite um ticker', 'error'); 
        return; 
      }

      const btn = document.getElementById('analyzeBtn');
      setLoading(btn, true);

      try {
        const expirationSelect = document.getElementById('expirationSelect');
        const selectedExpiration = expirationSelect.value;
        
        const baseRequestBody = { 
          ticker, 
          days_back: 60 
        };
        
        if (selectedExpiration && selectedExpiration !== '') {
          baseRequestBody.expiration_code = selectedExpiration;
          showStatus(`Analisando ${ticker} - Vencimento: ${expirationSelect.options[expirationSelect.selectedIndex].text}`, 'info');
        } else {
          showStatus(`Analisando ${ticker} - Vencimento automático (próximo disponível)`, 'info');
        }
        
        const [gammaRes, deltaRes, vegaRes, thetaRes] = await Promise.all([
          fetch('/pro/gamma/analyze', { 
            method: 'POST', 
            headers: { 
              'Content-Type': 'application/json', 
              'Authorization': `Bearer ${userToken}` 
            }, 
            body: JSON.stringify(baseRequestBody)
          }),
          fetch('/pro/delta/analyze', { 
            method: 'POST', 
            headers: { 
              'Content-Type': 'application/json', 
              'Authorization': `Bearer ${userToken}` 
            }, 
            body: JSON.stringify(baseRequestBody)
          }),
          fetch('/pro/vega/analyze', { 
            method: 'POST', 
            headers: { 
              'Content-Type': 'application/json', 
              'Authorization': `Bearer ${userToken}` 
            }, 
            body: JSON.stringify(baseRequestBody)
          }),
          fetch('/pro/theta/analyze', { 
            method: 'POST', 
            headers: { 
              'Content-Type': 'application/json', 
              'Authorization': `Bearer ${userToken}` 
            }, 
            body: JSON.stringify(baseRequestBody)
          })
        ]);

        gammaData = await gammaRes.json();
        deltaData = await deltaRes.json();
        vegaData = await vegaRes.json();
        thetaData = await thetaRes.json();
        
        if (!gammaRes.ok) throw new Error(gammaData.error);
        if (!deltaRes.ok) throw new Error(deltaData.error);
        if (!vegaRes.ok) throw new Error(vegaData.error);
        if (!thetaRes.ok) throw new Error(thetaData.error);

        await displayResults();
        
        const vencimentoUsado = gammaData.data_quality?.expiration || 'Automático';
        showStatus(`✅ Análise 4D de ${ticker} concluída! Vencimento: ${vencimentoUsado}`, 'success');

      } catch (error) {
        showStatus('Erro: ' + error.message, 'error');
      } finally {
        setLoading(btn, false);
      }
    }
   
   
    document.getElementById('loadExpirationsBtn').addEventListener('click', loadExpirations);
    document.getElementById('analyzeBtn').addEventListener('click', runFullAnalysis);
    document.getElementById('tickerInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') runFullAnalysis(); });

    let resizeTimeout;
    window.addEventListener('resize', function() {
      if (document.getElementById('resultsSection').classList.contains('hidden')) return;
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        ['gexDescChart', 'dexMomentumChart', 'vexDescChart', 'texCumChart'].forEach(id => {
          try { 
            Plotly.Plots.resize(id);
            if (window.innerWidth < 768) {
              const element = document.getElementById(id);
              if (element && element.layout) {
                Plotly.relayout(id, {
                  'xaxis.autorange': true,
                  'yaxis.autorange': true
                });
              }
            }
          } catch (e) {}
        });
      }, 200);
    });

    window.addEventListener('orientationchange', function() {
      setTimeout(() => {
        ['gexDescChart', 'dexMomentumChart', 'vexDescChart', 'texCumChart'].forEach(id => {
          try { Plotly.Plots.resize(id); } catch (e) {}
        });
      }, 300);
    });

    document.addEventListener('DOMContentLoaded', function() {
      if (typeof Plotly === 'undefined') {
        console.error('Plotly nao carregou - tentando carregar alternativo');
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/plotly.js-dist@2.26.0/plotly.min.js';
        document.head.appendChild(script);
      }
      
      renderMasterTable(0);
      showStatus('Sistema Greeks Micro 4D carregado. Digite um ticker para comecar.', 'info');
    });

    function autoLoadFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const tickerFromUrl = urlParams.get('ticker');
      
      if (tickerFromUrl) {
        const tickerInput = document.getElementById('tickerInput');
        tickerInput.value = tickerFromUrl.toUpperCase();
        
        console.log(`[AUTO-LOAD] Ticker detectado na URL: ${tickerFromUrl}`);
        
        // Aguardar 500ms para garantir que página carregou
        setTimeout(() => {
          runFullAnalysis();
        }, 500);
      }
    }

    // Chamar quando página carregar
    window.addEventListener('load', autoLoadFromURL);

  </script>

    <!-- DISCLAIMER LEGAL -->
  
    <div class="mt-6 max-w-4xl mx-auto bg-red-900/20 border-2 border-red-500/40 rounded-xl p-6">
        <div class="flex items-start gap-4">
          <i class="fas fa-exclamation-triangle text-red-400 text-2xl mt-1 flex-shrink-0"></i>
          <div class="text-left">
            <h3 class="text-red-400 font-bold text-base mb-3">AVISO LEGAL IMPORTANTE</h3>
            <p class="text-gray-300 text-xs leading-relaxed mb-3">
              As informações e sinais fornecidos por esta ferramenta são de caráter educativo e informativo. <strong>Não constituem recomendação de investimento nem garantia de rentabilidade.</strong> Investimentos em valores mobiliários envolvem riscos de perda patrimonial. Rentabilidade passada não garante resultados futuros. Os modelos quantitativos utilizados são baseados em dados históricos e podem não capturar adequadamente mudanças nas condições de mercado. Recomendamos a consulta a profissionais qualificados antes de tomar decisões de investimento. <strong>Operações de swing trade e day trade envolvem alto risco e podem resultar em perdas significativas.</strong> Este tipo de operação requer conhecimento técnico e não é adequado para todos os perfis de investidor.
            </p>
            <div class="pt-3 border-t border-gray-700 text-gray-400 text-xs">
              <p><strong>Geminii Research Ltda</strong> - CNPJ 60.897.331/0001-06 | Analista Responsável: Diego Doneda - CNPI 9668</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  
</body>
</html>