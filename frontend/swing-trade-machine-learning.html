<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Swing Trade Machine Learning - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#000000',
            light: '#ffffff',
            subtle: 'rgba(255,255,255,0.1)',
            geminii: '#ba39af'
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
      min-height: 100vh;
    }
    
    .ml-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      transition: all 0.3s ease;
    }
    
    .ml-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(186, 57, 175, 0.15);
      border-color: rgba(186, 57, 175, 0.3);
    }
    
    .signal-badge {
      padding: 8px 16px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 700;
      border: 1px solid;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .signal-buy {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border-color: #10b981;
    }
    
    .signal-sell {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border-color: #ef4444;
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .spinner {
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 2px solid #ba39af;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .ticker-suggestion {
      background: rgba(186, 57, 175, 0.1);
      border: 1px solid rgba(186, 57, 175, 0.3);
      border-radius: 8px;
      padding: 8px 12px;
      margin: 2px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-block;
      color: rgba(255, 255, 255, 0.8);
      font-size: 12px;
    }
    
    .ticker-suggestion:hover {
      background: rgba(186, 57, 175, 0.2);
      border-color: #ba39af;
      color: white;
      transform: translateY(-1px);
    }

    .results-section {
      display: none;
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .chart-container {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      min-height: 600px;
    }
    select {
      background-color: rgba(255, 255, 255, 0.1) !important;
      color: white !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      border-radius: 8px !important;
      padding: 12px 16px !important;
      backdrop-filter: blur(20px) !important;
      appearance: none !important;
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e") !important;
      background-repeat: no-repeat !important;
      background-position: right 12px center !important;
      background-size: 16px !important;
      padding-right: 40px !important;
    }
  
    select:hover {
      border-color: rgba(186, 57, 175, 0.5) !important;
      background-color: rgba(255, 255, 255, 0.15) !important;
    }
  
    select:focus {
      outline: none !important;
      border-color: #ba39af !important;
      box-shadow: 0 0 0 2px rgba(186, 57, 175, 0.2) !important;
    }
  
    select option {
      background-color: #1a1a1a !important;
      color: white !important;
      padding: 8px 12px !important;
    }
  </style>
</head>
<body class="text-white">
  
  <!-- Navbar -->
  <nav class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-opacity-5 border-opacity-10 bg-white border-white border rounded-full px-4 py-3 shadow-xl backdrop-blur-md">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <img src="logo.png" alt="Geminii Logo" class="w-6 h-6 cursor-pointer" onclick="window.location.href='/'">
      </div>
      <div class="hidden md:flex items-center space-x-6 text-xs text-gray-300 ml-8">
        <a href="/dashboard" class="hover:text-white transition-colors">Dashboard</a>
        <a href="/atsmom.html" class="hover:text-white transition-colors">ATSMOM</a>
        <a href="/beta-regression" class="hover:text-white transition-colors">Beta Regression</a>
        <span class="text-white font-medium">ML Trading</span>
      </div>
      <div class="flex items-center space-x-3 ml-8">
        <div id="apiStatus" class="w-8 h-8 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-full flex items-center justify-center relative">
          <i class="fas fa-brain text-green-500 text-xs"></i>
          <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Content -->
  <div class="pt-32 pb-16">
    <div class="max-w-7xl mx-auto px-6">
      
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">
          <span style="color: #ba39af; font-weight: 900;">Swing Trade</span>
          <span class="text-white font-light">Machine Learning</span>
        </h1>
        <p class="text-neutral-300 text-lg max-w-2xl mx-auto">
          Análise preditiva com IA, stops dinâmicos e ensemble de modelos avançados
        </p>
      </div>

      <!-- Controles -->
      <div class="ml-card p-6 mb-8">
        <div class="flex flex-col gap-6">
          <div class="flex flex-col md:flex-row gap-4 items-end">
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-300 mb-2">
                <i class="fas fa-chart-bar mr-2"></i>Código da Ação
              </label>
              <input 
                id="ticker" 
                type="text" 
                placeholder="Ex: PETR4, VALE3, ITUB4..." 
                class="w-full px-4 py-3 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-geminii backdrop-blur-sm"
              >
            </div>
            
            <div class="md:w-48">
              <label class="block text-sm font-medium text-gray-300 mb-2">
                <i class="fas fa-calendar-alt mr-2"></i>Dias para Previsão
              </label>
              <select id="predictionDays" class="w-full px-4 py-3 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg text-white focus:outline-none focus:border-geminii backdrop-blur-sm">
                <option value="5" selected>5 dias</option>
                <option value="10">10 dias</option>
                <option value="15">15 dias</option>
                <option value="30">30 dias</option>
              </select>
            </div>

            <button id="analyzeBtn" class="px-8 py-3 bg-gradient-to-r from-pink-500 to-purple-600 hover:shadow-lg rounded-lg transition-all font-medium whitespace-nowrap">
              <i class="fas fa-brain mr-2"></i>Executar Análise ML
            </button>
          </div>
          
          <!-- Ações Sugeridas -->
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-3">
              <i class="fas fa-lightbulb mr-2"></i>Ações Sugeridas (clique para selecionar)
            </label>
            <div id="tickerSuggestions" class="flex flex-wrap gap-2">
              <div class="spinner"></div>
              <span class="text-gray-400 ml-2">Carregando sugestões...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Status -->
      <div id="statusMsg" class="mb-6 p-4 rounded-lg hidden backdrop-blur-sm"></div>

      <!-- Results Section -->
      <div id="resultsSection" class="results-section space-y-6">
        
        <!-- Trading Signal Card -->
        <!-- Trading Signal Card -->
        <div class="ml-card p-6">
          <div class="text-center">
            <h3 class="text-xl font-bold mb-4">
              <i class="fas fa-signal mr-2"></i>Sinal de Trading
            </h3>
            <div id="tradingSignal" class="inline-block mb-6">
              <!-- Preenchido via JS -->
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="bg-white bg-opacity-5 p-4 rounded-lg">
                <div class="text-sm text-gray-400 mb-1">Preço Atual</div>
                <div id="currentPrice" class="text-2xl font-bold text-white">--</div>
              </div>
              <div class="bg-white bg-opacity-5 p-4 rounded-lg">
                <div class="text-sm text-gray-400 mb-1">Take Profit</div>
                <div id="takeProfitPrice" class="text-2xl font-bold text-green-400">--</div>
              </div>
              <div class="bg-white bg-opacity-5 p-4 rounded-lg">
                <div class="text-sm text-gray-400 mb-1">Stop Loss</div>
                <div id="stopLossPrice" class="text-2xl font-bold text-red-400">--</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Estratégia Explicativa -->
        <div class="ml-card p-6">
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-r from-pink-500 to-purple-600 rounded-full flex items-center justify-center">
              <i class="fas fa-brain text-white text-lg"></i>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-bold mb-3 text-white">
                <i class="fas fa-lightbulb mr-2 text-yellow-400"></i>Como Funciona Nossa Estratégia de Machine Learning
              </h3>
              <div class="space-y-3 text-gray-300 leading-relaxed">
                <p>
                  Nosso modelo de <strong class="text-white">Machine Learning altamente completo</strong> analisa múltiplos indicadores técnicos, 
                  padrões históricos e volatilidade do mercado para prever a direção futura do preço do ativo. 
                  O sistema utiliza algoritmos avançados de ensemble que combinam diferentes técnicas de aprendizado para maximizar a precisão.
                </p>
                <p>
                  <strong class="text-geminii">Logo abaixo você encontra:</strong> análise gráfica com previsões visuais, 
                  métricas de volatilidade (ATR, volatilidade 60 dias), performance histórica do modelo e matriz de confusão 
                  que demonstra a eficácia das predições em operações passadas.
                </p>
                <p>
                  <strong class="text-white">O sinal consiste na direção recomendada</strong> (COMPRA ou VENDA) baseada na análise preditiva. 
                  Com base na <span class="text-yellow-400 font-medium">volatilidade atual do ativo</span>, o sistema calcula automaticamente:
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                  <div class="bg-white bg-opacity-5 p-4 rounded-lg border-l-4 border-red-400">
                    <div class="flex items-center gap-2 mb-2">
                      <i class="fas fa-shield-alt text-red-400"></i>
                      <span class="font-semibold text-red-400">Stop Loss Sugerido</span>
                    </div>
                    <p class="text-sm text-gray-400">
                      Calculado dinamicamente com base no ATR e volatilidade para proteger seu capital
                    </p>
                  </div>
                  <div class="bg-white bg-opacity-5 p-4 rounded-lg border-l-4 border-green-400">
                    <div class="flex items-center gap-2 mb-2">
                      <i class="fas fa-target text-green-400"></i>
                      <span class="font-semibold text-green-400">Take Profit Otimizado</span>
                    </div>
                    <p class="text-sm text-gray-400">
                      Previamente analisado pelo sistema para maximizar o potencial de lucro
                    </p>
                  </div>
                </div>
                <div class="mt-4 p-4 bg-blue-600 bg-opacity-20 border border-blue-500 border-opacity-30 rounded-lg">
                  <p class="text-sm">
                    <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                    <strong class="text-blue-400">Importante:</strong> Você é livre para utilizar os níveis de stop e gain onde desejar. 
                    Nossos valores são sugestões baseadas em análise técnica, mas a decisão final é sempre sua.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Chart Container -->
        <div class="ml-card p-6">
          <h3 class="text-xl font-bold mb-4">
            <i class="fas fa-chart-line mr-2"></i>Análise Gráfica com Previsões
          </h3>
          <div class="chart-container">
            <canvas id="tradingChart" width="100%" height="400"></canvas>
          </div>
        </div>

        <!-- Metrics Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          
          <!-- Níveis de Operação -->
          <div class="ml-card p-6">
            <h3 class="text-lg font-bold mb-4">
              <i class="fas fa-target mr-2"></i>Níveis de Operação
            </h3>
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-white bg-opacity-5 p-4 rounded-lg">
                <div class="text-sm text-gray-400 mb-1">Take Profit</div>
                <div id="takeProfitPct" class="text-xl font-bold text-green-400">--</div>
              </div>
              <div class="bg-white bg-opacity-5 p-4 rounded-lg">
                <div class="text-sm text-gray-400 mb-1">Stop Loss</div>
                <div id="stopLossPct" class="text-xl font-bold text-red-400">--</div>
              </div>
            </div>
          </div>

          <!-- Métricas de Volatilidade -->
          <div class="ml-card p-6">
            <h3 class="text-lg font-bold mb-4">
              <i class="fas fa-chart-area mr-2"></i>Métricas de Volatilidade
            </h3>
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-white bg-opacity-5 p-4 rounded-lg">
                <div class="text-sm text-gray-400 mb-1">ATR Atual</div>
                <div id="atrPct" class="text-lg font-bold">--</div>
              </div>
              <div class="bg-white bg-opacity-5 p-4 rounded-lg">
                <div class="text-sm text-gray-400 mb-1">Vol. 60d</div>
                <div id="vol60d" class="text-lg font-bold">--</div>
              </div>
              <div class="bg-white bg-opacity-5 p-4 rounded-lg">
                <div class="text-sm text-gray-400 mb-1">ATR Médio</div>
                <div id="atrMedio" class="text-sm text-gray-300">--</div>
              </div>
              <div class="bg-white bg-opacity-5 p-4 rounded-lg">
                <div class="text-sm text-gray-400 mb-1">Vol. Máx. 60d</div>
                <div id="volMaxima" class="text-sm text-gray-300">--</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Analysis Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          
          <!-- Análise Histórica -->
          <div class="ml-card p-6">
            <h3 class="text-lg font-bold mb-4">
              <i class="fas fa-history mr-2"></i>Análise Histórica
            </h3>
            <div class="space-y-4">
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-400">Data Histórica:</span>
                <span id="dataHistorica" class="font-medium">--</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-400">Sinal Histórico:</span>
                <span id="sinalHistorico">--</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-400">Preço Histórico:</span>
                <span id="precoHistorico" class="font-medium">--</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-400">Resultado:</span>
                <span id="resultadoHistorico">--</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-400">Movimento:</span>
                <span id="movimentoPreco" class="font-medium">--</span>
              </div>
            </div>
          </div>

          <!-- Performance do Modelo -->
          <div class="ml-card p-6">
            <h3 class="text-lg font-bold mb-4">
              <i class="fas fa-brain mr-2"></i>Performance do Modelo
            </h3>
            <div class="grid grid-cols-3 gap-4 mb-4">
              <div class="bg-white bg-opacity-5 p-3 rounded-lg text-center">
                <div class="text-xs text-gray-400 mb-1">Acurácia</div>
                <div id="accuracy" class="text-lg font-bold">--</div>
              </div>
              <div class="bg-white bg-opacity-5 p-3 rounded-lg text-center">
                <div class="text-xs text-gray-400 mb-1">Precisão</div>
                <div id="precision" class="text-lg font-bold">--</div>
              </div>
              <div class="bg-white bg-opacity-5 p-3 rounded-lg text-center">
                <div class="text-xs text-gray-400 mb-1">Recall</div>
                <div id="recall" class="text-lg font-bold">--</div>
              </div>
            </div>
            <div>
              <div class="text-sm text-gray-400 mb-2">Matriz de Confusão</div>
              <div class="grid grid-cols-2 gap-2 text-xs">
                <div class="bg-white bg-opacity-5 p-2 rounded text-center">
                  <div class="text-gray-400">VP</div>
                  <div id="truePositives" class="font-bold">--</div>
                </div>
                <div class="bg-white bg-opacity-5 p-2 rounded text-center">
                  <div class="text-gray-400">FP</div>
                  <div id="falsePositives" class="font-bold">--</div>
                </div>
                <div class="bg-white bg-opacity-5 p-2 rounded text-center">
                  <div class="text-gray-400">VN</div>
                  <div id="trueNegatives" class="font-bold">--</div>
                </div>
                <div class="bg-white bg-opacity-5 p-2 rounded text-center">
                  <div class="text-gray-400">FN</div>
                  <div id="falseNegatives" class="font-bold">--</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Performance dos Stops -->
        <div class="ml-card p-6">
          <h3 class="text-lg font-bold mb-4">
            <i class="fas fa-shield-alt mr-2"></i>Performance dos Stops Dinâmicos
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white bg-opacity-5 p-4 rounded-lg text-center">
              <div class="text-sm text-gray-400 mb-2">Stop Loss Médio</div>
              <div id="stopLossMedio" class="text-2xl font-bold text-red-400">--</div>
            </div>
            <div class="bg-white bg-opacity-5 p-4 rounded-lg text-center">
              <div class="text-sm text-gray-400 mb-2">Take Profit Médio</div>
              <div id="takeProfitMedio" class="text-2xl font-bold text-green-400">--</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    console.log('=== SCRIPT INICIANDO ===');
    
    // Configurações
    const API_BASE = '/api/swing-trade-ml';
    
    // Elementos DOM
    let ticker, predictionDays, analyzeBtn, statusMsg, resultsSection, tickerSuggestions;
    let tradingChart = null;
    
    // Inicializar elementos após DOM carregar
    function initElements() {
      ticker = document.getElementById('ticker');
      predictionDays = document.getElementById('predictionDays');
      analyzeBtn = document.getElementById('analyzeBtn');
      statusMsg = document.getElementById('statusMsg');
      resultsSection = document.getElementById('resultsSection');
      tickerSuggestions = document.getElementById('tickerSuggestions');
      
      console.log('Elementos inicializados:', {
        ticker: !!ticker,
        analyzeBtn: !!analyzeBtn,
        statusMsg: !!statusMsg,
        resultsSection: !!resultsSection
      });
    }
    
    // Funções utilitárias
    function showStatus(message, type = 'info') {
      console.log('Status:', message, '(', type, ')');
      
      if (!statusMsg) return;
      
      const bgClasses = {
        success: 'bg-green-600 bg-opacity-20 border-green-500 border-opacity-30 border',
        error: 'bg-red-600 bg-opacity-20 border-red-500 border-opacity-30 border',
        info: 'bg-blue-600 bg-opacity-20 border-blue-500 border-opacity-30 border'
      };
      
      statusMsg.className = `mb-6 p-4 rounded-lg backdrop-blur-sm ${bgClasses[type]}`;
      statusMsg.textContent = message;
      statusMsg.classList.remove('hidden');
      
      if (type === 'success' || type === 'error') {
        setTimeout(() => statusMsg.classList.add('hidden'), 5000);
      }
    }
    
    function setLoading(element, loading) {
      if (!element) return;
      
      if (loading) {
        element.classList.add('loading');
        element.innerHTML = '<span class="spinner mr-2"></span>Processando...';
      } else {
        element.classList.remove('loading');
        element.innerHTML = '<i class="fas fa-brain mr-2"></i>Executar Análise ML';
      }
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(value);
    }

    function selectTicker(symbol) {
      if (ticker) {
        ticker.value = symbol;
        ticker.focus();
      }
    }

    // Função para criar gráfico com Chart.js
    function createTradingChart(chartData) {
      console.log('=== CRIANDO GRÁFICO CHART.JS ===');
      console.log('Dados recebidos:', chartData);
      
      const canvas = document.getElementById('tradingChart');
      if (!canvas) {
        console.error('Canvas não encontrado!');
        return;
      }
      
      // Destruir gráfico anterior se existir
      if (tradingChart) {
        tradingChart.destroy();
      }
      
      // Usar dados reais se disponíveis, senão usar dados de exemplo
      let labels, priceData, predictionData, stopLossData, takeProfitData;
      
      if (chartData && chartData.labels && chartData.prices) {
        console.log('Usando dados reais do backend');
        labels = chartData.labels;
        priceData = chartData.prices;
        predictionData = chartData.predictions || [];
        stopLossData = chartData.stop_loss || [];
        takeProfitData = chartData.take_profit || [];
      } else {
        console.log('Usando dados de exemplo');
        // Gerar dados de exemplo para teste
        labels = [];
        priceData = [];
        predictionData = [];
        
        const today = new Date();
        for (let i = 252; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          labels.push(date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
          
          const basePrice = 30 + Math.sin(i * 0.1) * 5 + Math.random() * 2;
          priceData.push(basePrice);
          
          // Alternar entre compra (1) e venda (0) para exemplo
          predictionData.push(Math.random() > 0.6 ? 1 : 0);
        }
      }
      
      console.log('Dados preparados:', { 
        labels: labels.length, 
        priceData: priceData.length,
        predictionData: predictionData.length 
      });
      
      const ctx = canvas.getContext('2d');
      
      // Criar datasets para segmentos coloridos
      const datasets = [];
      
      // Criar segmentos de linha coloridos baseados nas predições
      for (let i = 1; i < priceData.length; i++) {
        const isCompra = predictionData[i] === 1;
        const color = isCompra ? '#10b981' : '#ef4444'; // Verde para compra, vermelho para venda
        
        datasets.push({
          label: '', // Sem label para não aparecer na legenda
          data: [
            { x: labels[i-1], y: priceData[i-1] },
            { x: labels[i], y: priceData[i] }
          ],
          borderColor: color,
          backgroundColor: color,
          borderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 0,
          showLine: true,
          tension: 0,
          fill: false
        });
      }
      
      // Adicionar dataset invisível para a legenda
      datasets.push({
        label: 'Sinal de Compra',
        data: [],
        borderColor: '#10b981',
        backgroundColor: '#10b981',
        borderWidth: 2
      });
      
      datasets.push({
        label: 'Sinal de Venda', 
        data: [],
        borderColor: '#ef4444',
        backgroundColor: '#ef4444',
        borderWidth: 2
      });
      
      tradingChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: {
              labels: {
                color: '#ffffff',
                font: {
                  size: 12
                },
                usePointStyle: true,
                filter: function(item, chart) {
                  // Mostrar apenas as legendas nomeadas
                  return item.text !== '';
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#ba39af',
              borderWidth: 1,
              filter: function(tooltipItem) {
                // Mostrar tooltip apenas para datasets com label
                return tooltipItem.dataset.label && tooltipItem.dataset.label !== '';
              },
              callbacks: {
                label: function(context) {
                  const label = context.dataset.label || '';
                  if (label === 'Sinal de Compra' || label === 'Sinal de Venda') {
                    // Para os datasets de legenda, mostrar o preço do ponto mais próximo
                    const pointIndex = context.dataIndex;
                    if (priceData[pointIndex]) {
                      return 'Preço: R$ ' + priceData[pointIndex].toFixed(2);
                    }
                  }
                  return null;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: '#9ca3af',
                maxTicksLimit: 10
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            },
            y: {
              ticks: {
                color: '#9ca3af',
                callback: function(value) {
                  return 'R$ ' + value.toFixed(2);
                }
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            }
          }
        }
      });
      
      console.log('Gráfico Chart.js criado com sucesso!');
    }

    // Carregar sugestões de tickers
    async function loadTickerSuggestions() {
      if (!tickerSuggestions) return;
      
      try {
        console.log('Carregando sugestões de tickers...');
        const response = await fetch(`${API_BASE}/tickers`);
        const data = await response.json();
        
        if (data.success) {
          tickerSuggestions.innerHTML = '';
          data.tickers.forEach(tickerData => {
            const suggestion = document.createElement('span');
            suggestion.className = 'ticker-suggestion';
            suggestion.innerHTML = `<strong>${tickerData.symbol}</strong> - ${tickerData.name}`;
            suggestion.onclick = () => selectTicker(tickerData.symbol);
            tickerSuggestions.appendChild(suggestion);
          });
          console.log('Sugestões carregadas:', data.tickers.length);
        } else {
          tickerSuggestions.innerHTML = '<span class="text-red-400">Erro ao carregar sugestões</span>';
        }
      } catch (error) {
        console.error('Erro ao carregar sugestões:', error);
        if (tickerSuggestions) {
          tickerSuggestions.innerHTML = '<span class="text-red-400">Erro ao carregar sugestões</span>';
        }
      }
    }

    // Executar análise
    async function runAnalysis() {
      console.log('=== INICIANDO ANÁLISE ===');
      
      if (!ticker || !predictionDays) {
        console.error('Elementos não encontrados');
        return;
      }
      
      const tickerValue = ticker.value.trim().toUpperCase();
      const predictionDaysValue = parseInt(predictionDays.value);

      console.log('Parâmetros:', { tickerValue, predictionDaysValue });

      if (!tickerValue) {
        showStatus('Por favor, digite o código da ação', 'error');
        ticker.focus();
        return;
      }

      // Verificar autenticação
      const token = localStorage.getItem('geminii_token');
      if (!token) {
        showStatus('Sessão expirada. Redirecionando para login...', 'error');
        setTimeout(() => window.location.href = '/login.html', 2000);
        return;
      }

      setLoading(analyzeBtn, true);
      showStatus('Executando análise de Machine Learning... Isso pode levar alguns minutos', 'info');

      try {
        console.log('Fazendo requisição para:', `${API_BASE}/analysis`);
        
        const response = await fetch(`${API_BASE}/analysis`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            ticker: tickerValue,
            prediction_days: predictionDaysValue
          })
        });

        console.log('Response status:', response.status);
        
        const data = await response.json();
        console.log('=== DADOS RECEBIDOS ===');
        console.log('Success:', data.success);
        console.log('Chart data:', data.chart_data);
        
        if (data.success) {
          displayResults(data.analysis_data, data.chart_data);
          showStatus(`Análise de ${tickerValue} concluída com sucesso!`, 'success');
        } else {
          if (response.status === 401) {
            showStatus('Sessão expirada. Redirecionando para login...', 'error');
            localStorage.removeItem('geminii_token');
            localStorage.removeItem('geminii_user');
            setTimeout(() => window.location.href = '/login.html', 2000);
          } else {
            showStatus('Erro na análise: ' + data.error, 'error');
          }
        }
      } catch (error) {
        showStatus('Erro ao executar análise: ' + error.message, 'error');
        console.error('Erro na requisição:', error);
      }

      setLoading(analyzeBtn, false);
    }

    // Exibir resultados
    function displayResults(analysisData, chartData) {
      console.log('=== DISPLAY RESULTS ===');
      console.log('analysisData:', analysisData);
      console.log('chartData:', chartData);
      
      // Criar o gráfico primeiro
      createTradingChart(chartData);
      
      // Preencher dados dos cards
      try {
        // Sinal de Trading
        const tradingSignal = document.getElementById('tradingSignal');
        if (tradingSignal && analysisData) {
          const isCompra = analysisData.direcao === 'COMPRA';
          tradingSignal.innerHTML = `
            <div class="signal-badge ${isCompra ? 'signal-buy' : 'signal-sell'}">
              <i class="fas fa-${isCompra ? 'arrow-up' : 'arrow-down'} mr-2"></i>
              ${analysisData.direcao}
            </div>
          `;
        }

        // Preços
        const currentPrice = document.getElementById('currentPrice');
        const takeProfitPrice = document.getElementById('takeProfitPrice');
        const stopLossPrice = document.getElementById('stopLossPrice');
        
        if (currentPrice && analysisData) currentPrice.textContent = formatCurrency(analysisData.preco_atual);
        if (takeProfitPrice && analysisData) takeProfitPrice.textContent = formatCurrency(analysisData.take_profit_price);
        if (stopLossPrice && analysisData) stopLossPrice.textContent = formatCurrency(analysisData.stop_loss_price);

        // Níveis
        const takeProfitPct = document.getElementById('takeProfitPct');
        const stopLossPct = document.getElementById('stopLossPct');
        
        if (takeProfitPct && analysisData) takeProfitPct.textContent = `${analysisData.take_profit_pct.toFixed(1)}%`;
        if (stopLossPct && analysisData) stopLossPct.textContent = `${analysisData.stop_loss_pct.toFixed(1)}%`;

        // Volatilidade
        const atrPct = document.getElementById('atrPct');
        const vol60d = document.getElementById('vol60d');
        const atrMedio = document.getElementById('atrMedio');
        const volMaxima = document.getElementById('volMaxima');
        
        if (atrPct && analysisData) atrPct.textContent = `${analysisData.atr_pct.toFixed(2)}%`;
        if (vol60d && analysisData) vol60d.textContent = `${analysisData.volatilidade_60d.toFixed(2)}%`;
        if (atrMedio && analysisData) atrMedio.textContent = `${analysisData.atr_medio.toFixed(2)}%`;
        if (volMaxima && analysisData) volMaxima.textContent = `${analysisData.vol_maxima_60d.toFixed(2)}%`;

        // Análise Histórica
        const dataHistorica = document.getElementById('dataHistorica');
        const sinalHistoricoEl = document.getElementById('sinalHistorico');
        const precoHistorico = document.getElementById('precoHistorico');
        const resultadoHistorico = document.getElementById('resultadoHistorico');
        const movimentoPreco = document.getElementById('movimentoPreco');
        
        if (dataHistorica && analysisData) dataHistorica.textContent = analysisData.data_historica;
        
        if (sinalHistoricoEl && analysisData) {
          const isCompraHistorico = analysisData.sinal_historico === 'COMPRA';
          sinalHistoricoEl.innerHTML = `
            <span class="signal-badge ${isCompraHistorico ? 'signal-buy' : 'signal-sell'}" style="padding: 4px 8px; font-size: 10px;">
              ${analysisData.sinal_historico}
            </span>
          `;
        }
        
        if (precoHistorico && analysisData) precoHistorico.textContent = formatCurrency(analysisData.preco_historico);
        
        if (resultadoHistorico && analysisData) {
          const isLucro = analysisData.resultado_status === 'LUCRO';
          resultadoHistorico.innerHTML = `
            <span class="${isLucro ? 'text-green-400' : 'text-red-400'} font-bold">
              ${analysisData.resultado_historico.toFixed(2)}% ${analysisData.resultado_status}
            </span>
          `;
        }
        
        if (movimentoPreco && analysisData) {
          movimentoPreco.textContent = `Preço ${analysisData.direcao_movimento} ${Math.abs(analysisData.variacao_percentual).toFixed(2)}%`;
        }

        // Performance do Modelo
        const accuracy = document.getElementById('accuracy');
        const precision = document.getElementById('precision');
        const recall = document.getElementById('recall');
        
        if (accuracy && analysisData) accuracy.textContent = (analysisData.accuracy * 100).toFixed(1) + '%';
        if (precision && analysisData) precision.textContent = (analysisData.precision * 100).toFixed(1) + '%';
        if (recall && analysisData) recall.textContent = (analysisData.recall * 100).toFixed(1) + '%';

        // Matriz de Confusão
        const truePositives = document.getElementById('truePositives');
        const falsePositives = document.getElementById('falsePositives');
        const trueNegatives = document.getElementById('trueNegatives');
        const falseNegatives = document.getElementById('falseNegatives');
        
        if (truePositives && analysisData) truePositives.textContent = analysisData.confusion_matrix.tp;
        if (falsePositives && analysisData) falsePositives.textContent = analysisData.confusion_matrix.fp;
        if (trueNegatives && analysisData) trueNegatives.textContent = analysisData.confusion_matrix.tn;
        if (falseNegatives && analysisData) falseNegatives.textContent = analysisData.confusion_matrix.fn;

        // Performance dos Stops
        const stopLossMedio = document.getElementById('stopLossMedio');
        const takeProfitMedio = document.getElementById('takeProfitMedio');
        
        if (stopLossMedio && analysisData) stopLossMedio.textContent = `${analysisData.stop_loss_medio.toFixed(2)}%`;
        if (takeProfitMedio && analysisData) takeProfitMedio.textContent = `${analysisData.take_profit_medio.toFixed(2)}%`;

        console.log('Cards preenchidos com sucesso');
      } catch (error) {
        console.error('Erro ao preencher cards:', error);
      }

      // Mostrar seção de resultados
      if (resultsSection) {
        resultsSection.style.display = 'block';
        console.log('Seção de resultados mostrada');
        
        // Scroll para os resultados
        setTimeout(() => {
          resultsSection.scrollIntoView({ 
            behavior: 'smooth' 
          });
        }, 500);
      }
    }

    // Event Listeners
    function setupEventListeners() {
      if (analyzeBtn) {
        analyzeBtn.addEventListener('click', runAnalysis);
        console.log('Event listener do botão configurado');
      }
      
      if (ticker) {
        ticker.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            runAnalysis();
          }
        });
        console.log('Event listener do ticker configurado');
      }
    }

    // Verificar autenticação na inicialização
    function checkAuth() {
      const token = localStorage.getItem('geminii_token');
      if (!token) {
        showStatus('Você precisa estar logado para usar esta funcionalidade', 'error');
        setTimeout(() => window.location.href = '/login.html', 3000);
        return false;
      }
      return true;
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
      console.log('=== DOM CARREGADO ===');
      
      // Inicializar elementos
      initElements();
      
      // Configurar event listeners
      setupEventListeners();
      
      console.log('Verificando autenticação...');
      if (checkAuth()) {
        loadTickerSuggestions();
        showStatus('Swing Trade ML carregado! Digite o código de uma ação para começar.', 'info');
      }
      
      console.log('=== INICIALIZAÇÃO COMPLETA ===');
    });
  </script>
</body>
</html>