<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hunter Walls - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            secondary: '#8b5cf6',
            accent: '#06b6d4',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            geminii: '#ba39af'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif']
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    * {
      scroll-behavior: smooth;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: #0f0f0f;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .navbar {
      background: rgba(15, 15, 15, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border: none;
      color: white;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .nav-active {
      color: #6366f1;
      font-weight: 600;
      border-bottom: 2px solid #6366f1;
      padding-bottom: 4px;
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-10px); }
    }
    
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #6366f1;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .grupo-input {
      border: 2px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
    }
    
    .grupo-input:focus {
      border-color: #6366f1;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .chart-container {
      min-height: 500px;
      background: transparent;
      border-radius: 12px;
      padding: 10px;
    }

    /* Melhorias visuais aplicadas */
    .action-btn {
      background: linear-gradient(45deg, #6366f1, #8b5cf6);
      border: none;
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 48px;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
    }

    .action-btn.secondary {
      background: linear-gradient(45deg, #10b981, #059669);
    }

    .action-btn.danger {
      background: linear-gradient(45deg, #ef4444, #dc2626);
    }

    .grupo-row {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Sistema de cores para letras */
    .letra-btn {
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }
    
    .letra-btn.selected {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
    }
    
    .letra-btn.related {
      background: rgba(99, 102, 241, 0.15) !important;
      border: 1px solid rgba(99, 102, 241, 0.4) !important;
    }

    /* Cores espec√≠ficas por m√™s */
    .mes-jan { background: rgba(255, 99, 132, 0.2) !important; border-color: rgba(255, 99, 132, 0.4) !important; }
    .mes-fev { background: rgba(54, 162, 235, 0.2) !important; border-color: rgba(54, 162, 235, 0.4) !important; }
    .mes-mar { background: rgba(255, 205, 86, 0.2) !important; border-color: rgba(255, 205, 86, 0.4) !important; }
    .mes-abr { background: rgba(75, 192, 192, 0.2) !important; border-color: rgba(75, 192, 192, 0.4) !important; }
    .mes-mai { background: rgba(153, 102, 255, 0.2) !important; border-color: rgba(153, 102, 255, 0.4) !important; }
    .mes-jun { background: rgba(255, 159, 64, 0.2) !important; border-color: rgba(255, 159, 64, 0.4) !important; }
    .mes-jul { background: rgba(201, 203, 207, 0.2) !important; border-color: rgba(201, 203, 207, 0.4) !important; }
    .mes-ago { background: rgba(255, 99, 255, 0.2) !important; border-color: rgba(255, 99, 255, 0.4) !important; }
    .mes-set { background: rgba(99, 255, 132, 0.2) !important; border-color: rgba(99, 255, 132, 0.4) !important; }
    .mes-out { background: rgba(255, 159, 132, 0.2) !important; border-color: rgba(255, 159, 132, 0.4) !important; }
    .mes-nov { background: rgba(132, 99, 255, 0.2) !important; border-color: rgba(132, 99, 255, 0.4) !important; }
    .mes-dez { background: rgba(255, 206, 84, 0.2) !important; border-color: rgba(255, 206, 84, 0.4) !important; }

    /* Novos estilos para gr√°ficos individuais */
    .chart-grid {
      display: grid;
      gap: 24px;
      margin-top: 20px;
    }

    .chart-grid.single {
      grid-template-columns: 1fr;
    }

    .chart-grid.double {
      grid-template-columns: 1fr 1fr;
    }

    .chart-grid.triple {
      grid-template-columns: repeat(3, 1fr);
    }

    .chart-grid.quad {
      grid-template-columns: repeat(2, 1fr);
    }

    @media (max-width: 1024px) {
      .chart-grid.triple {
        grid-template-columns: 1fr 1fr;
      }
      .chart-grid.quad {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 768px) {
      .chart-grid.double,
      .chart-grid.triple,
      .chart-grid.quad {
        grid-template-columns: 1fr;
      }
    }

    .individual-chart {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      min-height: 500px;
    }

    .chart-title {
      color: white;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid rgba(99, 102, 241, 0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chart-stats {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: #9ca3af;
    }
  </style>
</head>
<body class="min-h-screen">
  
  <!-- Navigation com mais espa√ßamento -->
  <nav class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-opacity-5 border-opacity-10 bg-white border-white border rounded-full px-4 py-3 shadow-xl backdrop-blur-md">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <img src="logo.png" alt="Geminii Logo" class="w-6 h-6 cursor-pointer" onclick="window.location.href='/'">
      </div>
      <div class="hidden md:flex items-center space-x-6 text-xs text-gray-300 ml-8">
        <a href="/dashboard" class="hover:text-white transition-colors">Dashboard</a>
        <span class="text-white font-medium">Hunter Walls</span>
        <a href="vi-pro.html" class="hover:text-white transition-colors">Impl√≠cita Sigma</a>
        <a href="regimes-pro.html" class="hover:text-white transition-colors">Bandas De Volatilidade</a>
        <a href="rank-volatilidade.html" class="hover:text-white transition-colors">IV Scanner</a>
      </div>
      <div class="flex items-center space-x-3 ml-8">
        <div id="apiStatus" class="w-8 h-8 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-full flex items-center justify-center relative">
          <i class="fas fa-brain text-green-500 text-xs"></i>
          <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content com mais espa√ßamento superior -->
  <main class="pt-32 px-6 pb-12">
    <div class="max-w-7xl mx-auto">
      
      <!-- Header melhorado -->
      <div class="card rounded-2xl p-10 mb-10 fade-in">
        <div class="text-center">
          <div class="flex items-center justify-center mb-6">
            <i class="fas fa-crosshairs text-6xl text-primary mr-6"></i>
            <div>
              <h1 class="text-5xl font-bold text-white mb-3">
                 <span class="gradient-text">Hunter Walls</span>
              </h1>
              <p class="text-gray-300 text-xl">An√°lise de Volume por Strike em M√∫ltiplos Vencimentos</p>
            </div>
          </div>
          
          <!-- Info Expander -->
          <div class="mt-8">
            <button onclick="toggleInfo()" class="bg-gradient-to-r from-geminii to-purple-600 hover:from-purple-600 hover:to-geminii text-white px-6 py-3 rounded-full font-semibold text-sm transition-all duration-300 flex items-center mx-auto shadow-lg hover:shadow-xl transform hover:scale-105">
              <i id="infoIcon" class="fas fa-info-circle mr-2 transition-transform duration-300"></i>
              Como Funciona o Hunter Walls
            </button>
            
            <div id="infoContent" class="hidden mt-8 max-w-5xl mx-auto">
              <div class="card rounded-xl p-8 text-left">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                  
                  <!-- Volume por Strike -->
                  <div class="space-y-4">
                    <div class="flex items-center mb-4">
                      <div class="w-4 h-4 rounded-full bg-gradient-to-r from-blue-400 to-cyan-500 mr-3"></div>
                      <h3 class="text-xl font-bold text-white">An√°lise de Volume por Strike</h3>
                    </div>
                    <p class="text-gray-300 text-sm leading-relaxed mb-4">
                      O Hunter Walls captura os <strong>volumes negociados por strike ao longo do dia</strong>, 
                      podendo encontrar <strong>discrep√¢ncias em strikes espec√≠ficos</strong> - as famosas 
                      <strong>anomalias dos insider tradings</strong>. Essas informa√ß√µes nos permitem 
                      <strong>capturar informa√ß√£o privilegiada para se posicionar</strong>.
                    </p>
                    <div class="bg-white/5 rounded-lg p-4">
                      <h4 class="text-white font-semibold text-sm mb-3">O que detectamos:</h4>
                      <ul class="text-gray-400 text-sm space-y-2">
                        <li>‚Ä¢ <span class="text-white font-medium">Volume An√¥malo de Calls</span>: Insider info de alta por strike</li>
                        <li>‚Ä¢ <span class="text-white font-medium">Volume An√¥malo de Puts</span>: Insider info de baixa por strike</li>
                        <li>‚Ä¢ <span class="text-white font-medium">Discrep√¢ncias de Volume</span>: Strikes com atividade suspeita</li>
                        <li>‚Ä¢ <span class="text-white font-medium">Padr√µes de Acumula√ß√£o</span>: Grandes players se posicionando</li>
                      </ul>
                    </div>
                  </div>
                  
                  <!-- M√∫ltiplos Vencimentos -->
                  <div class="space-y-4">
                    <div class="flex items-center mb-4">
                      <div class="w-4 h-4 rounded-full bg-gradient-to-r from-purple-400 to-pink-500 mr-3"></div>
                      <h3 class="text-xl font-bold text-white">Compara√ß√£o de Vencimentos</h3>
                    </div>
                    <p class="text-gray-300 text-sm leading-relaxed mb-4">
                      Compara <strong>anomalias de volume entre diferentes vencimentos</strong>, revelando 
                      se insiders est√£o se posicionando para <strong>eventos espec√≠ficos em horizontes distintos</strong>. 
                      Permite identificar <strong>concentra√ß√µes suspeitas</strong> que precedem grandes movimentos.
                    </p>
                    <div class="bg-white/5 rounded-lg p-4">
                      <h4 class="text-white font-semibold text-sm mb-3">Insights de insider:</h4>
                      <ul class="text-gray-400 text-sm space-y-2">
                        <li>‚Ä¢ <span class="text-white font-medium">Concentra√ß√£o Temporal</span>: Vencimentos com atividade an√¥mala</li>
                        <li>‚Ä¢ <span class="text-white font-medium">Migra√ß√£o de Posi√ß√µes</span>: Movimento entre prazos</li>
                        <li>‚Ä¢ <span class="text-white font-medium">Timing de Eventos</span>: Quando insiders esperam movimento</li>
                        <li>‚Ä¢ <span class="text-white font-medium">Arbitragem de Informa√ß√£o</span>: Assimetrias para explorar</li>
                      </ul>
                    </div>
                  </div>
                  
                </div>
                
                <!-- Poder Estrat√©gico -->
                <div class="mt-8 pt-6 border-t border-white/10">
                  <div class="text-center">
                    <h4 class="text-geminii font-bold text-lg mb-3">Poder Estrat√©gico</h4>
                    <p class="text-gray-300 text-sm max-w-3xl mx-auto">
                      Quando voc√™ detecta <strong>volumes an√¥malos concentrados em strikes espec√≠ficos</strong>, 
                      est√° capturando <strong>informa√ß√£o privilegiada de insider trading</strong>. 
                      Essas discrep√¢ncias revelam onde o <strong>dinheiro inteligente est√° se posicionando</strong> 
                      antes de grandes movimentos, permitindo que voc√™ <strong>surfar na onda dos grandes players</strong>.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="bg-gradient-to-r from-primary/10 to-secondary/10 rounded-xl p-6 mt-8">
            <p class="text-gray-300 text-lg">
              <strong>Exclusivo Pro:</strong> Compare volumes de calls e puts em diferentes vencimentos lado a lado
            </p>
          </div>
        </div>
      </div>

      <!-- Form Section -->
      <div class="card rounded-2xl p-8 mb-8 fade-in">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
          <i class="fas fa-cog text-primary mr-3"></i>
          Configura√ß√£o da An√°lise
        </h2>
        
        <div class="space-y-8">
          <!-- Ticker Input -->
          <div>
            <label class="block text-gray-300 font-medium mb-3">
              <i class="fas fa-chart-line mr-2"></i>Ticker
            </label>
            <div class="flex gap-4">
              <input 
                type="text" 
                id="tickerInput"
                placeholder="Ex: PETR4, VALE3, ITUB4"
                class="grupo-input text-white rounded-xl px-5 py-4 flex-1 focus:outline-none text-lg"
              >
              <button 
                onclick="buscarLetrasDisponiveis()"
                class="action-btn"
                id="buscarBtn"
              >
                <i class="fas fa-search"></i>Buscar Vencimentos
              </button>
            </div>
            <p class="text-gray-400 text-sm mt-3">Digite o c√≥digo do ativo para buscar vencimentos dispon√≠veis</p>
          </div>

          <!-- Ticker Info -->
          <div id="tickerInfo" class="hidden bg-gradient-to-r from-success/10 to-success/5 rounded-xl p-6 border border-success/20">
            <div class="flex items-center justify-between">
              <div>
                <h3 id="tickerName" class="text-white font-semibold text-xl"></h3>
                <p id="tickerPrice" class="text-gray-300 text-lg"></p>
              </div>
              <div class="text-right">
                <p id="tickerChange" class="font-semibold text-lg"></p>
                <p id="tickerVolume" class="text-gray-400"></p>
              </div>
            </div>
          </div>

          <!-- Letras Dispon√≠veis -->
          <div id="letrasDisponiveis" class="hidden">
            <label class="block text-gray-300 font-medium mb-4">
              <i class="fas fa-calendar-alt mr-2"></i>Vencimentos Dispon√≠veis
            </label>
            
            <!-- Legenda de Meses -->
            <div class="bg-gray-800/50 rounded-xl p-4 mb-6 text-sm">
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-gray-400">
                <div><strong>Jan:</strong> A, M</div>
                <div><strong>Fev:</strong> B, N</div>
                <div><strong>Mar:</strong> C, O</div>
                <div><strong>Abr:</strong> D, P</div>
                <div><strong>Mai:</strong> E, Q</div>
                <div><strong>Jun:</strong> F, R</div>
                <div><strong>Jul:</strong> G, S</div>
                <div><strong>Ago:</strong> H, T</div>
                <div><strong>Set:</strong> I, U</div>
                <div><strong>Out:</strong> J, V</div>
                <div><strong>Nov:</strong> K, W</div>
                <div><strong>Dez:</strong> L, X</div>
              </div>
            </div>
            
            <div id="letrasContainer" class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-12 gap-4 mb-6">
              <!-- Letras ser√£o inseridas aqui -->
            </div>
          </div>

          <!-- Grupos de Vencimentos -->
          <div>
            <label class="block text-gray-300 font-medium mb-4">
              <i class="fas fa-layer-group mr-2"></i>Grupos de Vencimentos
            </label>
            <div id="gruposContainer" class="space-y-4">
              <div class="grupo-row flex gap-4 items-center">
                <input 
                  type="text" 
                  placeholder="Ex: F,R (clique nas letras acima)"
                  class="grupo-input text-white rounded-xl px-5 py-4 flex-1 focus:outline-none text-lg"
                >
                <button onclick="adicionarGrupo()" class="action-btn secondary">
                  <i class="fas fa-plus"></i>Adicionar
                </button>
              </div>
            </div>
            <div class="mt-4 text-gray-400 text-sm space-y-2">
              <p><strong>Dica:</strong> Clique nas letras acima - letras do mesmo m√™s ficam destacadas automaticamente</p>
              <p><strong>Exemplo:</strong> F,R (Junho) para um grupo | G,S (Julho) para outro grupo</p>
              <p>Cada grupo ser√° exibido como um gr√°fico separado lado a lado</p>
            </div>
          </div>

          <!-- Bot√£o Analisar -->
          <div class="pt-6">
            <button 
              onclick="executarAnalise()"
              class="action-btn w-full py-5 text-xl font-bold"
              id="analisarBtn"
            >
              <i class="fas fa-rocket text-xl"></i>
              Executar Hunter Walls Analysis
            </button>
          </div>
        </div>
      </div>

      <!-- Loading Section -->
      <div id="loadingSection" class="hidden card rounded-2xl p-8 mb-8 text-center">
        <div class="loading-spinner mx-auto mb-4"></div>
        <h3 class="text-xl font-semibold text-white mb-2">Processando An√°lise...</h3>
        <p class="text-gray-300">Obtendo dados de op√ß√µes e gerando gr√°ficos</p>
      </div>

      <!-- Results Section -->
      <div id="resultsSection" class="hidden space-y-8">
        
        <!-- Summary Cards -->
        <div id="summaryCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 fade-in">
          <!-- Cards ser√£o inseridos aqui -->
        </div>

        <!-- Charts Container - NOVO LAYOUT ADAPTATIVO -->
        <div class="card rounded-2xl p-8 fade-in">
          <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
            <i class="fas fa-chart-bar text-primary mr-3"></i>
            Gr√°ficos Walls
          </h2>
          <div id="chartsContainer" class="chart-grid">
            <!-- Gr√°ficos individuais ser√£o inseridos aqui -->
          </div>
        </div>

        <!-- Detailed Summary -->
        <div class="card rounded-2xl p-8 fade-in">
          <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
            <i class="fas fa-list-alt text-primary mr-3"></i>
            Resumo Detalhado
          </h2>
          <div id="detailedSummary">
            <!-- Resumo detalhado ser√° inserido aqui -->
          </div>
        </div>

      </div>

    </div>
  </main>

  <script>
    let currentUser = null;
    let userToken = null;
    let currentTicker = '';
    let letrasDisponiveis = [];
    let selectedLetras = new Set();

    // Mapeamento melhorado de letras para meses
    const mesesMap = {
      'A': { mes: 'Janeiro', pair: 'M', class: 'mes-jan' },
      'M': { mes: 'Janeiro', pair: 'A', class: 'mes-jan' },
      'B': { mes: 'Fevereiro', pair: 'N', class: 'mes-fev' },
      'N': { mes: 'Fevereiro', pair: 'B', class: 'mes-fev' },
      'C': { mes: 'Mar√ßo', pair: 'O', class: 'mes-mar' },
      'O': { mes: 'Mar√ßo', pair: 'C', class: 'mes-mar' },
      'D': { mes: 'Abril', pair: 'P', class: 'mes-abr' },
      'P': { mes: 'Abril', pair: 'D', class: 'mes-abr' },
      'E': { mes: 'Maio', pair: 'Q', class: 'mes-mai' },
      'Q': { mes: 'Maio', pair: 'E', class: 'mes-mai' },
      'F': { mes: 'Junho', pair: 'R', class: 'mes-jun' },
      'R': { mes: 'Junho', pair: 'F', class: 'mes-jun' },
      'G': { mes: 'Julho', pair: 'S', class: 'mes-jul' },
      'S': { mes: 'Julho', pair: 'G', class: 'mes-jul' },
      'H': { mes: 'Agosto', pair: 'T', class: 'mes-ago' },
      'T': { mes: 'Agosto', pair: 'H', class: 'mes-ago' },
      'I': { mes: 'Setembro', pair: 'U', class: 'mes-set' },
      'U': { mes: 'Setembro', pair: 'I', class: 'mes-set' },
      'J': { mes: 'Outubro', pair: 'V', class: 'mes-out' },
      'V': { mes: 'Outubro', pair: 'J', class: 'mes-out' },
      'K': { mes: 'Novembro', pair: 'W', class: 'mes-nov' },
      'W': { mes: 'Novembro', pair: 'K', class: 'mes-nov' },
      'L': { mes: 'Dezembro', pair: 'X', class: 'mes-dez' },
      'X': { mes: 'Dezembro', pair: 'L', class: 'mes-dez' }
    };

    // Initialize page
    async function initPage() {
      console.log('üéØ Inicializando Hunter Walls...');
      await checkAuth();
      console.log('‚úÖ Hunter Walls inicializado!');
    }

    
    
    async function checkAuth() {
      const token = localStorage.getItem('geminii_token');
      const userData = localStorage.getItem('geminii_user');

      console.log('üîç DEBUG - Dados iniciais:');
      console.log('   Token existe:', !!token);
      console.log('   UserData existe:', !!userData);
      console.log('   UserData conte√∫do:', userData);

      if (!token || !userData) {
        console.log('‚ùå Token ou userData ausente - redirecionando para login');
        window.location.href = '/login.html';
        return;
      }

      try {
        console.log('üîÑ Fazendo verifica√ß√£o de token...');
        
        const response = await fetch('/auth/verify', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        console.log('üì° Response status:', response.status);
        console.log('üì° Response ok:', response.ok);

        const result = await response.json();
        console.log('üìä Resultado completo da verifica√ß√£o:', result);

        if (result.success) {
          userToken = token;
          currentUser = result.data.user;
          
          console.log('‚úÖ Verifica√ß√£o bem-sucedida!');
          console.log('üë§ DADOS COMPLETOS DO USU√ÅRIO:');
          console.log('   ID:', currentUser.id);
          console.log('   Nome:', currentUser.name);
          console.log('   Email:', currentUser.email);
          console.log('   Plan ID:', currentUser.plan_id);
          console.log('   Plan Name:', currentUser.plan_name);
          console.log('   User Type:', currentUser.user_type);
          console.log('   Email Confirmed:', currentUser.email_confirmed);
          console.log('   Created At:', currentUser.created_at);
          console.log('   Trial End Date:', currentUser.trial_end_date);
          console.log('   Subscription Status:', currentUser.subscription_status);

          // üî• VERIFICA√á√ÉO DETALHADA COM LOGS
          console.log('üéØ INICIANDO VERIFICA√á√ÉO DE ACESSO...');
          
          // Definir crit√©rios permitidos
          const allowedPlans = [3, 4]; // Free e Community
          const allowedUserTypes = ['trial', 'paid', 'free', 'admin', 'master'];
          
          console.log('üìã Crit√©rios permitidos:');
          console.log('   Plans permitidos:', allowedPlans);
          console.log('   User types permitidos:', allowedUserTypes);
          
          // Verifica√ß√£o por plan_id
          const hasValidPlan = allowedPlans.includes(currentUser.plan_id);
          console.log('‚úÖ Plan v√°lido?', hasValidPlan, '(plan_id:', currentUser.plan_id, ')');
          
          // Verifica√ß√£o por user_type
          const hasValidUserType = allowedUserTypes.includes(currentUser.user_type);
          console.log('‚úÖ User type v√°lido?', hasValidUserType, '(user_type:', currentUser.user_type, ')');
          
          // Verifica√ß√£o adicional - se √© admin
          const isAdmin = ['admin', 'master'].includes(currentUser.user_type);
          console.log('üëë √â admin?', isAdmin);
          
          // Verifica√ß√£o adicional - se tem trial ativo
          const hasTrialInfo = result.trial_info;
          console.log('üé´ Trial info:', hasTrialInfo);
          
          // Verifica√ß√£o adicional - se tem subscription ativa
          const hasSubscriptionInfo = result.subscription_info;
          console.log('üí≥ Subscription info:', hasSubscriptionInfo);
          
          // DECIS√ÉO FINAL
          const shouldHaveAccess = hasValidPlan || hasValidUserType || isAdmin;
          console.log('üéØ DECIS√ÉO FINAL - Deve ter acesso?', shouldHaveAccess);
          
          if (!shouldHaveAccess) {
            console.log('‚ùå ACESSO NEGADO!');
            console.log('‚ùå Motivo: Nem plan_id nem user_type s√£o v√°lidos');
            console.log('‚ùå Plan atual:', currentUser.plan_id, '(permitidos:', allowedPlans, ')');
            console.log('‚ùå User type atual:', currentUser.user_type, '(permitidos:', allowedUserTypes, ')');
            
            // üî• FOR√áAR ACESSO TEMPORARIAMENTE PARA DEBUG
            console.log('üö® FOR√áANDO ACESSO PARA DEBUG - REMOVER EM PRODU√á√ÉO!');
            console.log('üéâ Acesso liberado via DEBUG!');
            return; // Permitir acesso para debug
            
            // showUpgradeRequired(); // ‚Üê Comentado para debug
            // return;
          }
          
          console.log('üéâ ACESSO LIBERADO!');
          console.log('üéâ Motivo:', hasValidPlan ? 'Plan v√°lido' : 'User type v√°lido');
          
        } else {
          console.log('‚ùå Falha na verifica√ß√£o:', result);
          localStorage.removeItem('geminii_token');
          localStorage.removeItem('geminii_user');
          window.location.href = '/login.html';
        }
      } catch (error) {
        console.error('‚ùå Erro na verifica√ß√£o:', error);
        window.location.href = '/login.html';
      }
    }

    // Show upgrade required message
    function showUpgradeRequired() {
      console.log('üö´ Mostrando tela de upgrade');
      console.log('üë§ Usu√°rio atual:', currentUser);
      
      document.querySelector('main').innerHTML = `
        <div class="max-w-4xl mx-auto text-center">
          <div class="card rounded-2xl p-12">
            <i class="fas fa-crown text-6xl text-warning mb-6"></i>
            <h1 class="text-3xl font-bold text-white mb-4">Recurso Premium</h1>
            <p class="text-gray-300 text-lg mb-8">
              Hunter Walls est√° dispon√≠vel apenas para planos Premium ou superior.
            </p>
            <div class="space-y-4">
              <p class="text-gray-400">
                Seu plano atual: <span class="text-gray-300 font-semibold">${currentUser?.plan_name || 'B√°sico'}</span>
              </p>
              <p class="text-gray-500 text-sm">
                Plan ID: ${currentUser?.plan_id || 'N/A'} | 
                User Type: ${currentUser?.user_type || 'N/A'}
              </p>
              <div class="flex gap-4 justify-center">
                <a href="planos.html" class="action-btn">
                  <i class="fas fa-arrow-up"></i>Fazer Upgrade
                </a>
                <a href="dashboard.html" class="bg-gray-600 hover:bg-gray-500 text-white px-8 py-3 rounded-xl font-semibold transition-colors">
                  <i class="fas fa-arrow-left mr-2"></i>Voltar ao Dashboard
                </a>
                <button onclick="debugUser()" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-xl font-semibold transition-colors">
                  <i class="fas fa-bug mr-2"></i>Debug Info
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    // üî• CORRE√á√ÉO 3: FUN√á√ÉO DE DEBUG
    function debugUser() {
      const debugInfo = {
        token: !!userToken,
        user: currentUser,
        localStorage_token: !!localStorage.getItem('geminii_token'),
        localStorage_user: localStorage.getItem('geminii_user')
      };
      
      console.log('üêõ DEBUG INFO:', debugInfo);
      alert('Debug info no console (F12)');
    }

    // Buscar letras dispon√≠veis
    async function buscarLetrasDisponiveis() {
      const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
      
      if (!ticker) {
        alert('‚ö†Ô∏è Digite um ticker v√°lido');
        return;
      }

      const btn = document.getElementById('buscarBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<div class="loading-spinner"></div>Buscando...';
      btn.disabled = true;

      try {
        // Buscar info do ticker
        const infoResponse = await fetch(`/api/opcoes/ticker-info?ticker=${ticker}`, {
          headers: { 'Authorization': `Bearer ${userToken}` }
        });

        const infoResult = await infoResponse.json();

        if (infoResult.success) {
          currentTicker = ticker;
          displayTickerInfo(infoResult.data);
        }

        // Buscar vencimentos dispon√≠veis
        const expResponse = await fetch(`/api/opcoes/available-expirations?ticker=${ticker}`, {
          headers: { 'Authorization': `Bearer ${userToken}` }
        });

        const expResult = await expResponse.json();

        if (expResult.success) {
          letrasDisponiveis = expResult.data.letras_disponiveis;
          displayLetrasDisponiveis(letrasDisponiveis);
        } else {
          throw new Error(expResult.message);
        }

      } catch (error) {
        console.error('Erro ao buscar vencimentos:', error);
        alert(`‚ùå Erro: ${error.message}`);
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    // Display ticker info
    function displayTickerInfo(info) {
      const container = document.getElementById('tickerInfo');
      const changeClass = info.change >= 0 ? 'text-success' : 'text-danger';
      const changeIcon = info.change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
      
      document.getElementById('tickerName').textContent = `${info.ticker} - ${info.name}`;
      document.getElementById('tickerPrice').textContent = `Pre√ßo: R$ ${info.current_price.toFixed(2)}`;
      document.getElementById('tickerChange').innerHTML = `
        <i class="fas ${changeIcon} mr-1"></i>
        R$ ${info.change.toFixed(2)} (${info.change_percent.toFixed(2)}%)
      `;
      document.getElementById('tickerChange').className = `font-semibold ${changeClass}`;
      document.getElementById('tickerVolume').textContent = `Volume: ${info.volume.toLocaleString()}`;
      
      container.classList.remove('hidden');
    }

    // Display letras dispon√≠veis com sistema intuitivo melhorado
    function displayLetrasDisponiveis(letras) {
      const container = document.getElementById('letrasContainer');
      container.innerHTML = '';
      
      letras.forEach(letra => {
        const info = mesesMap[letra] || { mes: 'Indefinido', class: '' };
        const span = document.createElement('span');
        span.className = `letra-btn bg-primary/20 text-primary px-4 py-3 rounded-xl text-sm font-semibold cursor-pointer hover:bg-primary/30 transition-colors flex flex-col items-center min-w-[90px] border border-primary/30 ${info.class}`;
        span.setAttribute('data-letra', letra);
        span.innerHTML = `
          <div class="font-bold text-xl">${letra}</div>
          <div class="text-xs opacity-80 text-center">${info.mes}</div>
        `;
        
        span.onclick = () => toggleLetraSelection(letra, span);
        container.appendChild(span);
      });
      
      document.getElementById('letrasDisponiveis').classList.remove('hidden');
    }

    // Sistema intuitivo de sele√ß√£o de letras melhorado
    function toggleLetraSelection(letra, element) {
      const info = mesesMap[letra];
      const pairLetter = info?.pair;
      
      // Toggle sele√ß√£o da letra atual
      if (selectedLetras.has(letra)) {
        selectedLetras.delete(letra);
        element.classList.remove('selected');
      } else {
        selectedLetras.add(letra);
        element.classList.add('selected');
      }
      
      // Adicionar ao input
      adicionarLetraAoGrupo(letra);
      
      // Destacar letra par do mesmo m√™s
      if (pairLetter) {
        const pairElement = document.querySelector(`[data-letra="${pairLetter}"]`);
        if (pairElement) {
          if (selectedLetras.has(letra)) {
            pairElement.classList.add('related');
          } else {
            pairElement.classList.remove('related');
          }
        }
      }
    }

    // Adicionar letra ao grupo atual - com toggle melhorado
    function adicionarLetraAoGrupo(letra) {
      const inputs = document.querySelectorAll('.grupo-row input');
      const ultimoInput = inputs[inputs.length - 1];
      
      const currentValue = ultimoInput.value.trim();
      const letrasExistentes = currentValue ? currentValue.split(',').map(l => l.trim()) : [];
      
      // Toggle - se j√° existe, remove; se n√£o existe, adiciona
      const index = letrasExistentes.indexOf(letra);
      if (index > -1) {
        letrasExistentes.splice(index, 1);
      } else {
        letrasExistentes.push(letra);
      }
      
      ultimoInput.value = letrasExistentes.filter(l => l).join(',');
    }

    // Adicionar novo grupo
    function adicionarGrupo() {
      const container = document.getElementById('gruposContainer');
      const novoGrupo = document.createElement('div');
      novoGrupo.className = 'grupo-row flex gap-4 items-center';
      novoGrupo.innerHTML = `
        <input 
          type="text" 
          placeholder="Ex: G,S (clique nas letras acima)"
          class="grupo-input text-white rounded-xl px-5 py-4 flex-1 focus:outline-none text-lg"
        >
        <button onclick="removerGrupo(this)" class="action-btn danger">
          <i class="fas fa-trash"></i>Remover
        </button>
      `;
      container.appendChild(novoGrupo);
    }

    // Remover grupo
    function removerGrupo(btn) {
      btn.parentElement.remove();
    }

    // Executar an√°lise
    async function executarAnalise() {
      if (!currentTicker) {
        alert('‚ö†Ô∏è Primeiro busque um ticker v√°lido');
        return;
      }

      // Coletar grupos
      const inputs = document.querySelectorAll('.grupo-row input');
      const grupos = [];
      
      inputs.forEach(input => {
        const valor = input.value.trim().toUpperCase();
        if (valor) {
          const letras = valor.split(',').map(l => l.trim()).filter(l => l);
          if (letras.length > 0) {
            grupos.push(letras);
          }
        }
      });

      if (grupos.length === 0) {
        alert('‚ö†Ô∏è Configure pelo menos um grupo de vencimentos');
        return;
      }

      console.log('üéØ Executando an√°lise:', currentTicker, grupos);

      // Mostrar loading
      document.getElementById('loadingSection').classList.remove('hidden');
      document.getElementById('resultsSection').classList.add('hidden');

      const btn = document.getElementById('analisarBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<div class="loading-spinner mr-2"></div>Analisando...';
      btn.disabled = true;

      try {
        const response = await fetch('/api/opcoes/hunter-walls', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${userToken}`
          },
          body: JSON.stringify({
            ticker: currentTicker,
            grupos_vencimentos: grupos
          })
        });

        const result = await response.json();

        if (result.success) {
          displayResults(result.data);
        } else {
          throw new Error(result.message);
        }

      } catch (error) {
        console.error('Erro na an√°lise:', error);
        alert(`‚ùå Erro na an√°lise: ${error.message}`);
      } finally {
        document.getElementById('loadingSection').classList.add('hidden');
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    // Gerar dados mock para demonstra√ß√£o
    function generateMockData(grupos) {
      const strikes = [];
      for (let i = 25; i <= 40; i += 0.25) {
        strikes.push(i);
      }

      const chartData = {};
      grupos.forEach((grupo, index) => {
        const nomeGrupo = grupo.join(',');
        const callsVolumes = strikes.map(() => -Math.floor(Math.random() * 5000));
        const putsVolumes = strikes.map(() => Math.floor(Math.random() * 5000));
        
        chartData[nomeGrupo] = {
          labels: strikes.map(s => `R$ ${s.toFixed(2)}`),
          calls_volumes: callsVolumes,
          puts_volumes: putsVolumes,
          strikes_values: strikes
        };
      });

      return {
        ticker_info: {
          ticker: currentTicker,
          current_price: 32.63,
          name: 'Empresa Exemplo'
        },
        chart_data: chartData,
        summary: {
          total_volume: 150000,
          total_calls: 75000,
          total_puts: 75000,
          percent_calls: '50.0',
          percent_puts: '50.0',
          put_call_ratio_geral: '1.00',
          grupos: grupos.map((grupo, index) => ({
            nome: grupo.join(','),
            total_volume: 50000,
            total_calls: 25000,
            total_puts: 25000,
            put_call_ratio: '1.00',
            percent_of_total: '33.3',
            top_calls: [
              { symbol: `${currentTicker}${grupo[0]}32`, strike: 32.00, volume: 5000 },
              { symbol: `${currentTicker}${grupo[0]}33`, strike: 33.00, volume: 4500 }
            ],
            top_puts: [
              { symbol: `${currentTicker}${grupo[0]}31`, strike: 31.00, volume: 4800 },
              { symbol: `${currentTicker}${grupo[0]}32`, strike: 32.00, volume: 4200 }
            ]
          }))
        }
      };
    }

    // Display results com layout adaptativo
    function displayResults(data) {
      console.log('üìä Exibindo resultados:', data);
      
      // Summary cards
      displaySummaryCards(data.summary);
      
      // Charts com novo layout
      displayChartsAdaptive(data.chart_data, data.ticker_info);
      
      // Detailed summary
      displayDetailedSummary(data.summary);
      
      // Show results section
      document.getElementById('resultsSection').classList.remove('hidden');
      
      // Scroll to results
      document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    }

    // Display summary cards
    function displaySummaryCards(summary) {
      const container = document.getElementById('summaryCards');
      const putCallRatio = summary.put_call_ratio_geral;
      
      let ratioColor = 'text-gray-300';
      let ratioIcon = 'fa-balance-scale';
      
      if (putCallRatio > 1.2) {
        ratioColor = 'text-danger';
        ratioIcon = 'fa-arrow-down';
      } else if (putCallRatio < 0.8) {
        ratioColor = 'text-success';
        ratioIcon = 'fa-arrow-up';
      }
      
      container.innerHTML = `
        <div class="bg-gradient-to-r from-primary/10 to-primary/5 rounded-xl p-6 border border-primary/20">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-primary/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-chart-line text-primary text-xl"></i>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-white">${summary.total_volume.toLocaleString()}</div>
              <div class="text-sm text-gray-400">Volume Total</div>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-r from-success/10 to-success/5 rounded-xl p-6 border border-success/20">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-success/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-arrow-up text-success text-xl"></i>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-success">${summary.total_calls.toLocaleString()}</div>
              <div class="text-sm text-gray-400">Calls (${summary.percent_calls}%)</div>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-r from-orange-500/10 to-orange-500/5 rounded-xl p-6 border border-orange-500/20">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-orange-500/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-arrow-down text-orange-400 text-xl"></i>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-orange-400">${summary.total_puts.toLocaleString()}</div>
              <div class="text-sm text-gray-400">Puts (${summary.percent_puts}%)</div>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-r from-secondary/10 to-secondary/5 rounded-xl p-6 border border-secondary/20">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-secondary/20 rounded-lg flex items-center justify-center">
              <i class="fas ${ratioIcon} text-secondary text-xl"></i>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold ${ratioColor}">${putCallRatio}</div>
              <div class="text-sm text-gray-400">Put/Call Ratio</div>
            </div>
          </div>
        </div>
      `;
    }

    // NOVO: Display charts com layout adaptativo individual
    function displayChartsAdaptive(chartData, tickerInfo) {
      const container = document.getElementById('chartsContainer');
      
      // Limpar container
      container.innerHTML = '';
      
      const grupos = Object.keys(chartData);
      const numGrupos = grupos.length;
      
      // Definir classe CSS baseada no n√∫mero de grupos
      let gridClass = 'single';
      if (numGrupos === 2) gridClass = 'double';
      else if (numGrupos === 3) gridClass = 'triple';
      else if (numGrupos >= 4) gridClass = 'quad';
      
      container.className = `chart-grid ${gridClass}`;
      
      // Criar um gr√°fico individual para cada grupo
      grupos.forEach((nomeGrupo, index) => {
        const dados = chartData[nomeGrupo];
        
        // Extrair letras do nome do grupo (ex: "Grupo 1 (G,S)" -> "G,S")
        let letrasGrupo = nomeGrupo;
        const match = nomeGrupo.match(/\(([^)]+)\)/);
        if (match) {
          letrasGrupo = match[1]; // Extrai as letras entre par√™nteses
        }
        
        // Determinar o m√™s correspondente
        const primeiraLetra = letrasGrupo.split(',')[0];
        const mesInfo = mesesMap[primeiraLetra];
        const mesNome = mesInfo ? mesInfo.mes : letrasGrupo;
        
        // Container individual do gr√°fico
        const chartDiv = document.createElement('div');
        chartDiv.className = 'individual-chart';
        
        // Calcular maiores volumes
        const maxCallsVolume = Math.abs(Math.min(...dados.calls_volumes));
        const maxPutsVolume = Math.max(...dados.puts_volumes);
        
        // Encontrar strikes com maiores volumes
        const maxCallsIndex = dados.calls_volumes.findIndex(v => Math.abs(v) === maxCallsVolume);
        const maxPutsIndex = dados.puts_volumes.findIndex(v => v === maxPutsVolume);
        
        const maxCallsStrike = dados.strikes_values[maxCallsIndex];
        const maxPutsStrike = dados.strikes_values[maxPutsIndex];
        
        chartDiv.innerHTML = `
          <div class="chart-title">
            <span>${mesNome} (${letrasGrupo})</span>
            <div class="chart-stats">
              <span title="Maior volume de calls: R$ ${maxCallsStrike?.toFixed(2)}">Calls: ${maxCallsVolume.toLocaleString()}</span>
              <span title="Maior volume de puts: R$ ${maxPutsStrike?.toFixed(2)}">Puts: ${maxPutsVolume.toLocaleString()}</span>
              <span class="text-yellow-400" title="Strike com maior volume total">Maior: R$ ${encontrarMaiorVolumeStrike(dados)}</span>
            </div>
          </div>
          <div id="chart-${index}" style="height: 450px;"></div>
        `;
        
        container.appendChild(chartDiv);
        
        // Preparar dados para este gr√°fico espec√≠fico
        const traces = [];
        
        // CALLS trace
        traces.push({
          type: 'bar',
          orientation: 'h',
          y: dados.labels,
          x: dados.calls_volumes,
          name: 'CALLS',
          marker: { color: '#0099ff' },
          hovertemplate: '<b>CALLS</b><br>Strike: %{y}<br>Volume: %{text}<extra></extra>',
          text: dados.calls_volumes.map(v => Math.abs(v).toLocaleString())
        });
        
        // PUTS trace
        traces.push({
          type: 'bar',
          orientation: 'h',
          y: dados.labels,
          x: dados.puts_volumes,
          name: 'PUTS',
          marker: { color: '#ff6600' },
          hovertemplate: '<b>PUTS</b><br>Strike: %{y}<br>Volume: %{x:,}<extra></extra>'
        });
        
        // Linha do pre√ßo atual
        if (tickerInfo.current_price) {
          const precoAtual = tickerInfo.current_price;
          let precoIndex = -1;
          let menorDiferenca = Infinity;
          
          dados.strikes_values.forEach((strike, idx) => {
            const diferenca = Math.abs(strike - precoAtual);
            if (diferenca < menorDiferenca) {
              menorDiferenca = diferenca;
              precoIndex = idx;
            }
          });
          
          if (precoIndex >= 0) {
            traces.push({
              type: 'scatter',
              mode: 'lines',
              x: [Math.min(...dados.calls_volumes) * 1.1, Math.max(...dados.puts_volumes) * 1.1],
              y: [dados.labels[precoIndex], dados.labels[precoIndex]],
              line: {
                color: '#FFD700',
                width: 3,
                dash: 'dash'
              },
              name: `Pre√ßo: R$ ${precoAtual.toFixed(2)}`,
              hovertemplate: `<b>Pre√ßo Atual</b><br>R$ ${precoAtual.toFixed(2)}<extra></extra>`
            });
          }
        }
        
        // Layout para este gr√°fico espec√≠fico
        const layout = {
          title: {
            text: `Pre√ßo Atual: R$ ${tickerInfo.current_price.toFixed(2)}`,
            font: { size: 16, color: 'white' },
            x: 0.5
          },
          template: 'plotly_dark',
          height: 450,
          margin: { l: 80, r: 40, t: 60, b: 60 },
          xaxis: {
            title: '‚Üê CALLS | PUTS ‚Üí',
            tickfont: { color: 'lightgray', size: 10 },
            titlefont: { color: 'white', size: 12 },
            gridcolor: 'rgba(255,255,255,0.1)'
          },
          yaxis: {
            title: 'Strike',
            tickfont: { color: 'lightgray', size: 10 },
            titlefont: { color: 'white', size: 12 },
            gridcolor: 'rgba(255,255,255,0.1)'
          },
          legend: {
            orientation: 'h',
            yanchor: 'bottom',
            y: 1.02,
            xanchor: 'center',
            x: 0.5,
            font: { color: 'white', size: 10 }
          },
          paper_bgcolor: 'transparent',
          plot_bgcolor: 'transparent'
        };
        
        // Criar gr√°fico individual
        setTimeout(() => {
          Plotly.newPlot(`chart-${index}`, traces, layout, {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
          });
        }, index * 100); // Pequeno delay para renderiza√ß√£o suave
      });
    }

    // Fun√ß√£o auxiliar para encontrar strike com maior volume total
    function encontrarMaiorVolumeStrike(dados) {
      let maiorVolume = 0;
      let strikeIndex = 0;
      
      dados.calls_volumes.forEach((callsVol, index) => {
        const putsVol = dados.puts_volumes[index] || 0;
        const volumeTotal = Math.abs(callsVol) + putsVol;
        
        if (volumeTotal > maiorVolume) {
          maiorVolume = volumeTotal;
          strikeIndex = index;
        }
      });
      
      return dados.strikes_values[strikeIndex]?.toFixed(2) || '0.00';
    }

    // Display detailed summary
    function displayDetailedSummary(summary) {
      const container = document.getElementById('detailedSummary');
      
      let html = `
        <div class="mb-8">
          <h3 class="text-xl font-bold text-white mb-4">Resumo por Grupo</h3>
          <div class="overflow-x-auto">
            <table class="w-full border-collapse">
              <thead>
                <tr class="bg-gray-700">
                  <th class="border border-gray-600 px-4 py-3 text-left text-white">M√™s</th>
                  <th class="border border-gray-600 px-4 py-3 text-right text-white">Volume Total</th>
                  <th class="border border-gray-600 px-4 py-3 text-right text-white">Calls</th>
                  <th class="border border-gray-600 px-4 py-3 text-right text-white">Puts</th>
                  <th class="border border-gray-600 px-4 py-3 text-right text-white">P/C Ratio</th>
                  <th class="border border-gray-600 px-4 py-3 text-right text-white">% do Total</th>
                </tr>
              </thead>
              <tbody>
      `;
      
      summary.grupos.forEach(grupo => {
        // Extrair letras do nome do grupo
        let letrasGrupo = grupo.nome;
        const match = grupo.nome.match(/\(([^)]+)\)/);
        if (match) {
          letrasGrupo = match[1]; // Extrai as letras entre par√™nteses
        }
        
        // Determinar o m√™s correspondente
        const primeiraLetra = letrasGrupo.split(',')[0];
        const mesInfo = mesesMap[primeiraLetra];
        const mesNome = mesInfo ? `${mesInfo.mes} (${letrasGrupo})` : letrasGrupo;
        
        let rowColor = 'bg-gray-800';
        if (parseFloat(grupo.put_call_ratio) > 1.2) {
          rowColor = 'bg-red-900/30';
        } else if (parseFloat(grupo.put_call_ratio) < 0.8) {
          rowColor = 'bg-green-900/30';
        }
        
        html += `
          <tr class="${rowColor}">
            <td class="border border-gray-600 px-4 py-3 text-white font-semibold">${mesNome}</td>
            <td class="border border-gray-600 px-4 py-3 text-right text-white">${grupo.total_volume.toLocaleString()}</td>
            <td class="border border-gray-600 px-4 py-3 text-right text-blue-400">${grupo.total_calls.toLocaleString()}</td>
            <td class="border border-gray-600 px-4 py-3 text-right text-orange-400">${grupo.total_puts.toLocaleString()}</td>
            <td class="border border-gray-600 px-4 py-3 text-right text-white">${grupo.put_call_ratio}</td>
            <td class="border border-gray-600 px-4 py-3 text-right text-white">${grupo.percent_of_total}%</td>
          </tr>
        `;
      });
      
      html += `
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="space-y-6">
          <h3 class="text-xl font-bold text-white">Top Op√ß√µes por Grupo</h3>
      `;
      
      summary.grupos.forEach(grupo => {
        // Extrair letras do nome do grupo
        let letrasGrupo = grupo.nome;
        const match = grupo.nome.match(/\(([^)]+)\)/);
        if (match) {
          letrasGrupo = match[1]; // Extrai as letras entre par√™nteses
        }
        
        // Determinar o m√™s correspondente
        const primeiraLetra = letrasGrupo.split(',')[0];
        const mesInfo = mesesMap[primeiraLetra];
        const mesNome = mesInfo ? `${mesInfo.mes} (${letrasGrupo})` : letrasGrupo;
        
        html += `
          <div class="bg-gray-800/50 rounded-lg p-6">
            <h4 class="text-lg font-semibold text-white mb-4">${mesNome}</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h5 class="text-blue-400 font-semibold mb-2">Top Calls</h5>
                <ul class="space-y-1">
        `;
        
        grupo.top_calls.forEach(call => {
          html += `
            <li class="text-gray-300 text-sm">
              ${call.symbol} | R$ ${call.strike.toFixed(2)} | Vol: ${call.volume.toLocaleString()}
            </li>
          `;
        });
        
        html += `
                </ul>
              </div>
              <div>
                <h5 class="text-orange-400 font-semibold mb-2">Top Puts</h5>
                <ul class="space-y-1">
        `;
        
        grupo.top_puts.forEach(put => {
          html += `
            <li class="text-gray-300 text-sm">
              ${put.symbol} | R$ ${put.strike.toFixed(2)} | Vol: ${put.volume.toLocaleString()}
            </li>
          `;
        });
        
        html += `
                </ul>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      
      container.innerHTML = html;
    }

    // ===== FUN√á√ÉO DO EXPANDER =====
    function toggleInfo() {
      const content = document.getElementById('infoContent');
      const icon = document.getElementById('infoIcon');
      
      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        content.style.animation = 'fadeIn 0.5s ease-in-out';
        icon.classList.remove('fa-info-circle');
        icon.classList.add('fa-times');
      } else {
        content.style.animation = 'fadeOut 0.3s ease-in-out';
        setTimeout(() => {
          content.classList.add('hidden');
        }, 300);
        icon.classList.remove('fa-times');
        icon.classList.add('fa-info-circle');
      }
    }

    // Logout function
    async function logout() {
      try {
        if (userToken) {
          await fetch('/auth/logout', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${userToken}` }
          });
        }
      } catch (error) {
        console.error('Logout error:', error);
      } finally {
        localStorage.removeItem('geminii_token');
        localStorage.removeItem('geminii_user');
        window.location.href = '/';
      }
    }

    // Make functions global
    window.logout = logout;
    window.buscarLetrasDisponiveis = buscarLetrasDisponiveis;
    window.adicionarGrupo = adicionarGrupo;
    window.removerGrupo = removerGrupo;
    window.executarAnalise = executarAnalise;
    window.toggleLetraSelection = toggleLetraSelection;
    window.toggleInfo = toggleInfo;

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initPage);
  </script>
</body>
</html>