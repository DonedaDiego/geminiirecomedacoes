<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hunter Walls - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            secondary: '#8b5cf6',
            accent: '#06b6d4',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            geminii: '#ba39af'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif']
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    * {
      scroll-behavior: smooth;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: #0f0f0f;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .navbar {
      background: rgba(15, 15, 15, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border: none;
      color: white;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .nav-active {
      color: #6366f1;
      font-weight: 600;
      border-bottom: 2px solid #6366f1;
      padding-bottom: 4px;
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-10px); }
    }
    
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #6366f1;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .grupo-input {
      border: 2px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
    }
    
    .grupo-input:focus {
      border-color: #6366f1;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .chart-container {
      min-height: 500px;
      background: transparent;
      border-radius: 12px;
      padding: 10px;
    }

    /* Melhorias visuais aplicadas */
    .action-btn {
      background: linear-gradient(45deg, #6366f1, #8b5cf6);
      border: none;
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 48px;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
    }

    .action-btn.secondary {
      background: linear-gradient(45deg, #10b981, #059669);
    }

    .action-btn.danger {
      background: linear-gradient(45deg, #ef4444, #dc2626);
    }

    .grupo-row {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Sistema de cores para letras */
    .letra-btn {
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }
    
    .letra-btn.selected {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
    }
    
    .letra-btn.related {
      background: rgba(99, 102, 241, 0.15) !important;
      border: 1px solid rgba(99, 102, 241, 0.4) !important;
    }

    /* Cores específicas por mês */
    .mes-jan { background: rgba(255, 99, 132, 0.2) !important; border-color: rgba(255, 99, 132, 0.4) !important; }
    .mes-fev { background: rgba(54, 162, 235, 0.2) !important; border-color: rgba(54, 162, 235, 0.4) !important; }
    .mes-mar { background: rgba(255, 205, 86, 0.2) !important; border-color: rgba(255, 205, 86, 0.4) !important; }
    .mes-abr { background: rgba(75, 192, 192, 0.2) !important; border-color: rgba(75, 192, 192, 0.4) !important; }
    .mes-mai { background: rgba(153, 102, 255, 0.2) !important; border-color: rgba(153, 102, 255, 0.4) !important; }
    .mes-jun { background: rgba(255, 159, 64, 0.2) !important; border-color: rgba(255, 159, 64, 0.4) !important; }
    .mes-jul { background: rgba(201, 203, 207, 0.2) !important; border-color: rgba(201, 203, 207, 0.4) !important; }
    .mes-ago { background: rgba(255, 99, 255, 0.2) !important; border-color: rgba(255, 99, 255, 0.4) !important; }
    .mes-set { background: rgba(99, 255, 132, 0.2) !important; border-color: rgba(99, 255, 132, 0.4) !important; }
    .mes-out { background: rgba(255, 159, 132, 0.2) !important; border-color: rgba(255, 159, 132, 0.4) !important; }
    .mes-nov { background: rgba(132, 99, 255, 0.2) !important; border-color: rgba(132, 99, 255, 0.4) !important; }
    .mes-dez { background: rgba(255, 206, 84, 0.2) !important; border-color: rgba(255, 206, 84, 0.4) !important; }

    /* Novos estilos para gráficos individuais */
    .chart-grid {
      display: grid;
      gap: 24px;
      margin-top: 20px;
    }

    .chart-grid.single {
      grid-template-columns: 1fr;
    }

    .chart-grid.double {
      grid-template-columns: 1fr 1fr;
    }

    .chart-grid.triple {
      grid-template-columns: repeat(3, 1fr);
    }

    .chart-grid.quad {
      grid-template-columns: repeat(2, 1fr);
    }

    @media (max-width: 1024px) {
      .chart-grid.triple {
        grid-template-columns: 1fr 1fr;
      }
      .chart-grid.quad {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 768px) {
      .chart-grid.double,
      .chart-grid.triple,
      .chart-grid.quad {
        grid-template-columns: 1fr;
      }
    }

    .individual-chart {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      min-height: 500px;
    }

    .chart-title {
      color: white;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid rgba(99, 102, 241, 0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chart-stats {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: #9ca3af;
    }
  </style>
</head>
<body class="min-h-screen">
  
  <!-- Navigation com mais espaçamento -->
  <nav class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-opacity-5 border-opacity-10 bg-white border-white border rounded-full px-4 py-3 shadow-xl backdrop-blur-md">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <img src="logo.png" alt="Geminii Logo" class="w-6 h-6 cursor-pointer" onclick="window.location.href='/'">
      </div>
      <div class="hidden md:flex items-center space-x-6 text-xs text-gray-300 ml-8">
        <a href="/dashboard" class="hover:text-white transition-colors">Dashboard</a>
        <span class="text-white font-medium">Hunter Walls</span>
        <a href="vi-pro.html" class="hover:text-white transition-colors">Implícita Sigma</a>
        <a href="regimes-pro.html" class="hover:text-white transition-colors">Bandas De Volatilidade</a>
        <a href="rank-volatilidade.html" class="hover:text-white transition-colors">IV Scanner</a>
        <a href="gamma-levels.html" class="hover:text-white transition-colors">Gamma Levels</a>
      </div>
      <div class="flex items-center space-x-3 ml-8">
        <div id="apiStatus" class="w-8 h-8 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-full flex items-center justify-center relative">
          <i class="fas fa-brain text-green-500 text-xs"></i>
          <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content com mais espaçamento superior -->
  <main class="pt-32 px-6 pb-12">
    <div class="max-w-7xl mx-auto">
      
      <!-- Header melhorado -->
      <div class="card rounded-2xl p-10 mb-10 fade-in">
        <div class="text-center">
          <div class="flex items-center justify-center mb-6">
            <i class="fas fa-crosshairs text-6xl text-primary mr-6"></i>
            <div>
              <h1 class="text-5xl font-bold text-white mb-3">
                 <span class="gradient-text">Hunter Walls</span>
              </h1>
              <p class="text-gray-300 text-xl">Análise de Volume por Strike em Múltiplos Vencimentos</p>
            </div>
          </div>
          
          <!-- Info Expander -->
          <div class="mt-8">
            <button onclick="toggleInfo()" class="bg-gradient-to-r from-geminii to-purple-600 hover:from-purple-600 hover:to-geminii text-white px-6 py-3 rounded-full font-semibold text-sm transition-all duration-300 flex items-center mx-auto shadow-lg hover:shadow-xl transform hover:scale-105">
              <i id="infoIcon" class="fas fa-info-circle mr-2 transition-transform duration-300"></i>
              Como Funciona o Hunter Walls
            </button>
            
            <div id="infoContent" class="hidden mt-8 max-w-5xl mx-auto">
              <div class="card rounded-xl p-8 text-left">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                  
                  <!-- Volume por Strike -->
                  <div class="space-y-4">
                    <div class="flex items-center mb-4">
                      <div class="w-4 h-4 rounded-full bg-gradient-to-r from-blue-400 to-cyan-500 mr-3"></div>
                      <h3 class="text-xl font-bold text-white">Análise de Volume por Strike</h3>
                    </div>
                    <p class="text-gray-300 text-sm leading-relaxed mb-4">
                      O Hunter Walls captura os <strong>volumes negociados por strike ao longo do dia</strong>, 
                      podendo encontrar <strong>discrepâncias em strikes específicos</strong> - as famosas 
                      <strong>anomalias dos insider tradings</strong>. Essas informações nos permitem 
                      <strong>capturar informação privilegiada para se posicionar</strong>.
                    </p>
                    <div class="bg-white/5 rounded-lg p-4">
                      <h4 class="text-white font-semibold text-sm mb-3">O que detectamos:</h4>
                      <ul class="text-gray-400 text-sm space-y-2">
                        <li>• <span class="text-white font-medium">Volume Anômalo de Calls</span>: Insider info de alta por strike</li>
                        <li>• <span class="text-white font-medium">Volume Anômalo de Puts</span>: Insider info de baixa por strike</li>
                        <li>• <span class="text-white font-medium">Discrepâncias de Volume</span>: Strikes com atividade suspeita</li>
                        <li>• <span class="text-white font-medium">Padrões de Acumulação</span>: Grandes players se posicionando</li>
                      </ul>
                    </div>
                  </div>
                  
                  <!-- Múltiplos Vencimentos -->
                  <div class="space-y-4">
                    <div class="flex items-center mb-4">
                      <div class="w-4 h-4 rounded-full bg-gradient-to-r from-purple-400 to-pink-500 mr-3"></div>
                      <h3 class="text-xl font-bold text-white">Comparação de Vencimentos</h3>
                    </div>
                    <p class="text-gray-300 text-sm leading-relaxed mb-4">
                      Compara <strong>anomalias de volume entre diferentes vencimentos</strong>, revelando 
                      se insiders estão se posicionando para <strong>eventos específicos em horizontes distintos</strong>. 
                      Permite identificar <strong>concentrações suspeitas</strong> que precedem grandes movimentos.
                    </p>
                    <div class="bg-white/5 rounded-lg p-4">
                      <h4 class="text-white font-semibold text-sm mb-3">Insights de insider:</h4>
                      <ul class="text-gray-400 text-sm space-y-2">
                        <li>• <span class="text-white font-medium">Concentração Temporal</span>: Vencimentos com atividade anômala</li>
                        <li>• <span class="text-white font-medium">Migração de Posições</span>: Movimento entre prazos</li>
                        <li>• <span class="text-white font-medium">Timing de Eventos</span>: Quando insiders esperam movimento</li>
                        <li>• <span class="text-white font-medium">Arbitragem de Informação</span>: Assimetrias para explorar</li>
                      </ul>
                    </div>
                  </div>
                  
                </div>
                
                <!-- Poder Estratégico -->
                <div class="mt-8 pt-6 border-t border-white/10">
                  <div class="text-center">
                    <h4 class="text-geminii font-bold text-lg mb-3">Poder Estratégico</h4>
                    <p class="text-gray-300 text-sm max-w-3xl mx-auto">
                      Quando você detecta <strong>volumes anômalos concentrados em strikes específicos</strong>, 
                      está capturando <strong>informação privilegiada de insider trading</strong>. 
                      Essas discrepâncias revelam onde o <strong>dinheiro inteligente está se posicionando</strong> 
                      antes de grandes movimentos, permitindo que você <strong>surfar na onda dos grandes players</strong>.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="bg-gradient-to-r from-primary/10 to-secondary/10 rounded-xl p-6 mt-8">
            <p class="text-gray-300 text-lg">
              <strong>Exclusivo Pro:</strong> Compare volumes de calls e puts em diferentes vencimentos lado a lado
            </p>
          </div>
        </div>
      </div>

      <!-- Form Section -->
      <div class="card rounded-2xl p-8 mb-8 fade-in">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
          <i class="fas fa-cog text-primary mr-3"></i>
          Configuração da Análise
        </h2>
        
        <div class="space-y-8">
          <!-- Ticker Input -->
          <div>
            <label class="block text-gray-300 font-medium mb-3">
              <i class="fas fa-chart-line mr-2"></i>Ticker
            </label>
            <div class="flex gap-4">
              <input 
                type="text" 
                id="tickerInput"
                placeholder="Ex: PETR4, VALE3, ITUB4"
                class="grupo-input text-white rounded-xl px-5 py-4 flex-1 focus:outline-none text-lg"
              >
              <button 
                onclick="buscarLetrasDisponiveis()"
                class="action-btn"
                id="buscarBtn"
              >
                <i class="fas fa-search"></i>Buscar Vencimentos
              </button>
            </div>
            <p class="text-gray-400 text-sm mt-3">Digite o código do ativo para buscar vencimentos disponíveis</p>
          </div>

          <!-- Ticker Info -->
          <div id="tickerInfo" class="hidden bg-gradient-to-r from-success/10 to-success/5 rounded-xl p-6 border border-success/20">
            <div class="flex items-center justify-between">
              <div>
                <h3 id="tickerName" class="text-white font-semibold text-xl"></h3>
                <p id="tickerPrice" class="text-gray-300 text-lg"></p>
              </div>
              <div class="text-right">
                <p id="tickerChange" class="font-semibold text-lg"></p>
                <p id="tickerVolume" class="text-gray-400"></p>
              </div>
            </div>
          </div>

          
          <div id="volumeHistoricoCard" class="hidden bg-gradient-to-r from-purple-500/10 to-purple-500/5 rounded-xl p-6 border border-purple-500/20 fade-in">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h3 class="text-white font-semibold text-xl flex items-center">
                  <i class="fas fa-history text-purple-400 mr-3"></i>
                  Volume Histórico (7 dias)  <!-- ✅ CORRIGIDO -->
                </h3>
                <p class="text-gray-300">Volume atual vs média histórica</p>
              </div>
              <div class="text-right">
                <div id="volumeStatus" class="text-2xl font-bold">-</div>
                <div id="volumeMultiplier" class="text-sm text-gray-400">Carregando...</div>
              </div>
            </div>
            
            <!-- Loading do volume histórico -->
            <div id="volumeHistoricoLoading" class="text-center py-8">
              <div class="loading-spinner mx-auto mb-3"></div>
              <p class="text-gray-400">Analisando volume histórico...</p>
            </div>
            
            <!-- Conteúdo do volume histórico -->
            <div id="volumeHistoricoContent" class="hidden">
              <!-- Mini gráfico de volume -->
              <div id="volumeHistoricoChart" style="height: 200px; margin-bottom: 16px;"></div>
              
              <!-- Métricas rápidas -->
              <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="bg-black/20 rounded-lg p-3 text-center">
                  <div id="volumeAtualDisplay" class="text-white font-semibold text-sm">-</div>
                  <div class="text-xs text-gray-400">Hoje</div>
                </div>
                <div class="bg-black/20 rounded-lg p-3 text-center">
                  <div id="volumeMedioDisplay" class="text-white font-semibold text-sm">-</div>
                  <div class="text-xs text-gray-400">Média 7d</div>
                </div>
                <div class="bg-black/20 rounded-lg p-3 text-center">
                  <div id="diasAnalisados" class="text-white font-semibold text-sm">-</div>
                  <div class="text-xs text-gray-400">Dias</div>
                </div>
              </div>
              
              <!-- Indicadores principais -->
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-black/20 rounded-lg p-4">
                  <div class="text-center">
                    <i class="fas fa-crown text-yellow-400 text-xl mb-2"></i>
                    <div id="dominantType" class="text-white font-semibold text-sm">-</div>
                    <div class="text-xs text-gray-400">Tipo Dominante</div>
                  </div>
                </div>
                <div class="bg-black/20 rounded-lg p-4">
                  <div class="text-center">
                    <i class="fas fa-crosshairs text-cyan-400 text-xl mb-2"></i>
                    <div id="hotStrike" class="text-white font-semibold text-sm">-</div>
                    <div class="text-xs text-gray-400">Strike Mais Ativo</div>
                  </div>
                </div>
              </div>
              
              <!-- Botão de drill-down -->
              <button onclick="analisarHotStrike()" id="hotStrikeBtn" class="w-full bg-gradient-to-r from-cyan-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-cyan-600 transition-all text-sm">
                <i class="fas fa-search-plus mr-2"></i>
                Analisar Strike Mais Ativo
              </button>
            </div>
          </div>

          <!-- Letras Disponíveis -->
          <div id="letrasDisponiveis" class="hidden">
            <label class="block text-gray-300 font-medium mb-4">
              <i class="fas fa-calendar-alt mr-2"></i>Vencimentos Disponíveis
            </label>
            
            <!-- Legenda de Meses -->
            <div class="bg-gray-800/50 rounded-xl p-4 mb-6 text-sm">
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-gray-400">
                <div><strong>Jan:</strong> A, M</div>
                <div><strong>Fev:</strong> B, N</div>
                <div><strong>Mar:</strong> C, O</div>
                <div><strong>Abr:</strong> D, P</div>
                <div><strong>Mai:</strong> E, Q</div>
                <div><strong>Jun:</strong> F, R</div>
                <div><strong>Jul:</strong> G, S</div>
                <div><strong>Ago:</strong> H, T</div>
                <div><strong>Set:</strong> I, U</div>
                <div><strong>Out:</strong> J, V</div>
                <div><strong>Nov:</strong> K, W</div>
                <div><strong>Dez:</strong> L, X</div>
              </div>
            </div>
            
            <div id="letrasContainer" class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-12 gap-4 mb-6">
              <!-- Letras serão inseridas aqui -->
            </div>
          </div>

          <!-- Grupos de Vencimentos -->
          <div>
            <label class="block text-gray-300 font-medium mb-4">
              <i class="fas fa-layer-group mr-2"></i>Grupos de Vencimentos
            </label>
            <div id="gruposContainer" class="space-y-4">
              <div class="grupo-row flex gap-4 items-center">
                <input 
                  type="text" 
                  placeholder="Ex: F,R (clique nas letras acima)"
                  class="grupo-input text-white rounded-xl px-5 py-4 flex-1 focus:outline-none text-lg"
                >
                <button onclick="adicionarGrupo()" class="action-btn secondary">
                  <i class="fas fa-plus"></i>Adicionar
                </button>
              </div>
            </div>
            <div class="mt-4 text-gray-400 text-sm space-y-2">
              <p><strong>Dica:</strong> Clique nas letras acima - letras do mesmo mês ficam destacadas automaticamente</p>
              <p><strong>Exemplo:</strong> F,R (Junho) para um grupo | G,S (Julho) para outro grupo</p>
              <p>Cada grupo será exibido como um gráfico separado lado a lado</p>
            </div>
          </div>

          <!-- Botão Analisar -->
          <div class="pt-6">
            <button 
              onclick="executarAnalise()"
              class="action-btn w-full py-5 text-xl font-bold"
              id="analisarBtn"
            >
              <i class="fas fa-rocket text-xl"></i>
              Executar Hunter Walls Analysis
            </button>
          </div>
        </div>
      </div>

      <!-- Loading Section -->
      <div id="loadingSection" class="hidden card rounded-2xl p-8 mb-8 text-center">
        <div class="loading-spinner mx-auto mb-4"></div>
        <h3 class="text-xl font-semibold text-white mb-2">Processando Análise...</h3>
        <p class="text-gray-300">Obtendo dados de opções e gerando gráficos</p>
      </div>

      <!-- Results Section -->
      <div id="resultsSection" class="hidden space-y-8">
        
        <!-- Summary Cards -->
        <div id="summaryCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 fade-in">
          <!-- Cards serão inseridos aqui -->
        </div>

        <!-- Charts Container - NOVO LAYOUT ADAPTATIVO -->
        <div class="card rounded-2xl p-8 fade-in">
          <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
            <i class="fas fa-chart-bar text-primary mr-3"></i>
            Gráficos Walls
          </h2>
          <div id="chartsContainer" class="chart-grid">
            <!-- Gráficos individuais serão inseridos aqui -->
          </div>
        </div>
 
        <!-- Detailed Summary -->
        <div class="card rounded-2xl p-8 fade-in">
          <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
            <i class="fas fa-list-alt text-primary mr-3"></i>
            Resumo Detalhado
          </h2>
          <div id="detailedSummary">
            <!-- Resumo detalhado será inserido aqui -->
          </div>
        </div>
 
      </div>
 
    </div>
  </main>
 
  <script>
    let currentUser = null;
    let userToken = null;
    let currentTicker = '';
    let letrasDisponiveis = [];
    let selectedLetras = new Set();
    let currentVolumeData = null; // Nova variável para dados históricos
 
    // Mapeamento melhorado de letras para meses
    const mesesMap = {
      'A': { mes: 'Janeiro', pair: 'M', class: 'mes-jan' },
      'M': { mes: 'Janeiro', pair: 'A', class: 'mes-jan' },
      'B': { mes: 'Fevereiro', pair: 'N', class: 'mes-fev' },
      'N': { mes: 'Fevereiro', pair: 'B', class: 'mes-fev' },
      'C': { mes: 'Março', pair: 'O', class: 'mes-mar' },
      'O': { mes: 'Março', pair: 'C', class: 'mes-mar' },
      'D': { mes: 'Abril', pair: 'P', class: 'mes-abr' },
      'P': { mes: 'Abril', pair: 'D', class: 'mes-abr' },
      'E': { mes: 'Maio', pair: 'Q', class: 'mes-mai' },
      'Q': { mes: 'Maio', pair: 'E', class: 'mes-mai' },
      'F': { mes: 'Junho', pair: 'R', class: 'mes-jun' },
      'R': { mes: 'Junho', pair: 'F', class: 'mes-jun' },
      'G': { mes: 'Julho', pair: 'S', class: 'mes-jul' },
      'S': { mes: 'Julho', pair: 'G', class: 'mes-jul' },
      'H': { mes: 'Agosto', pair: 'T', class: 'mes-ago' },
      'T': { mes: 'Agosto', pair: 'H', class: 'mes-ago' },
      'I': { mes: 'Setembro', pair: 'U', class: 'mes-set' },
      'U': { mes: 'Setembro', pair: 'I', class: 'mes-set' },
      'J': { mes: 'Outubro', pair: 'V', class: 'mes-out' },
      'V': { mes: 'Outubro', pair: 'J', class: 'mes-out' },
      'K': { mes: 'Novembro', pair: 'W', class: 'mes-nov' },
      'W': { mes: 'Novembro', pair: 'K', class: 'mes-nov' },
      'L': { mes: 'Dezembro', pair: 'X', class: 'mes-dez' },
      'X': { mes: 'Dezembro', pair: 'L', class: 'mes-dez' }
    };
 
    // Initialize page
    async function initPage() {
      console.log('🚀 Inicializando Hunter Walls...');
      await checkAuth();
      console.log('✅ Hunter Walls inicializado!');
    }
 
    async function checkAuth() {
      const token = localStorage.getItem('geminii_token');
      const userData = localStorage.getItem('geminii_user');
 
      console.log('🔍 DEBUG - Dados iniciais:');
      console.log('   Token existe:', !!token);
      console.log('   UserData existe:', !!userData);
      console.log('   UserData conteúdo:', userData);
 
      if (!token || !userData) {
        console.log('❌ Token ou userData ausente - redirecionando para login');
        window.location.href = '/login.html';
        return;
      }
 
      try {
        console.log('🔄 Fazendo verificação de token...');
        
        const response = await fetch('/auth/verify', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
 
        console.log('📡 Response status:', response.status);
        console.log('📡 Response ok:', response.ok);
 
        const result = await response.json();
        console.log(' Resultado completo da verificação:', result);
 
        if (result.success) {
          userToken = token;
          currentUser = result.data.user;
  
          console.log('🔥 INICIANDO VERIFICAÇÃO DE ACESSO...');
          
          const allowedPlans = [3, 4];
          const allowedUserTypes = ['trial', 'paid', 'free', 'admin', 'master'];
          
          console.log('📋 Critérios permitidos:');
          console.log('   Plans permitidos:', allowedPlans);
          console.log('   User types permitidos:', allowedUserTypes);
          
          const hasValidPlan = allowedPlans.includes(currentUser.plan_id);
          console.log('✅ Plan válido?', hasValidPlan, '(plan_id:', currentUser.plan_id, ')');
          
          const hasValidUserType = allowedUserTypes.includes(currentUser.user_type);
          console.log('✅ User type válido?', hasValidUserType, '(user_type:', currentUser.user_type, ')');
          
          const isAdmin = ['admin', 'master'].includes(currentUser.user_type);
          console.log('👑 É admin?', isAdmin);
          
          const shouldHaveAccess = hasValidPlan || hasValidUserType || isAdmin;
          console.log(' DECISÃO FINAL - Deve ter acesso?', shouldHaveAccess);
          
          if (!shouldHaveAccess) {
            console.log('❌ ACESSO NEGADO!');
            console.log('🚨 FORÇANDO ACESSO PARA DEBUG - REMOVER EM PRODUÇÃO!');
            console.log('🎉 Acesso liberado via DEBUG!');
            return;
          }
          
          console.log('🎉 ACESSO LIBERADO!');
          
        } else {
          console.log('❌ Falha na verificação:', result);
          localStorage.removeItem('geminii_token');
          localStorage.removeItem('geminii_user');
          window.location.href = '/login.html';
        }
      } catch (error) {
        console.error('❌ Erro na verificação:', error);
        window.location.href = '/login.html';
      }
    }
 
    // Buscar letras disponíveis - FUNÇÃO MODIFICADA
    async function buscarLetrasDisponiveis() {
      const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
      
      if (!ticker) {
        alert('⚠️ Digite um ticker válido');
        return;
      }
 
      const btn = document.getElementById('buscarBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<div class="loading-spinner"></div>Buscando...';
      btn.disabled = true;
 
      try {
        // Buscar info do ticker (CÓDIGO EXISTENTE)
        const infoResponse = await fetch(`/api/opcoes/ticker-info?ticker=${ticker}`, {
          headers: { 'Authorization': `Bearer ${userToken}` }
        });
 
        const infoResult = await infoResponse.json();
 
        if (infoResult.success) {
          currentTicker = ticker;
          displayTickerInfo(infoResult.data);
          
          // 🔥 NOVA CHAMADA - Buscar volume histórico
          await buscarDadosHistoricos();
        }
 
        // Buscar vencimentos disponíveis (CÓDIGO EXISTENTE)
        const expResponse = await fetch(`/api/opcoes/available-expirations?ticker=${ticker}`, {
          headers: { 'Authorization': `Bearer ${userToken}` }
        });
 
        const expResult = await expResponse.json();
 
        if (expResult.success) {
          letrasDisponiveis = expResult.data.letras_disponiveis;
          displayLetrasDisponiveis(letrasDisponiveis);
        } else {
          throw new Error(expResult.message);
        }
 
      } catch (error) {
        console.error('Erro ao buscar vencimentos:', error);
        alert(`❌ Erro: ${error.message}`);
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }
 
    // 🔥 NOVA FUNÇÃO - Buscar dados históricos
    async function buscarDadosHistoricos() {
      if (!currentTicker) return;
      
      try {
        // Mostrar card de volume histórico
        document.getElementById('volumeHistoricoCard').classList.remove('hidden');
        document.getElementById('volumeHistoricoLoading').classList.remove('hidden');
        document.getElementById('volumeHistoricoContent').classList.add('hidden');
        
        console.log(' Buscando dados históricos para:', currentTicker);
        
        const response = await fetch('/api/opcoes/volume-historico', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${userToken}`
          },
          body: JSON.stringify({ ticker: currentTicker })
        });
 
        const result = await response.json();
        
        if (result.success) {
          currentVolumeData = result.data;
          displayVolumeHistorico(result.data);
        } else {
          throw new Error(result.message);
        }
        
      } catch (error) {
        console.error('❌ Erro dados históricos:', error);
        
        // Mostrar erro no card
        document.getElementById('volumeHistoricoLoading').innerHTML = `
          <div class="text-center py-4">
            <i class="fas fa-exclamation-triangle text-orange-400 text-2xl mb-2"></i>
            <p class="text-gray-400 text-sm">Erro ao carregar dados históricos</p>
            <p class="text-gray-500 text-xs">${error.message}</p>
          </div>
        `;
      }
    }
 
  
    function displayVolumeHistorico(data) {
      console.log(' Exibindo volume histórico:', data);
      
      // Esconder loading
      document.getElementById('volumeHistoricoLoading').classList.add('hidden');
      document.getElementById('volumeHistoricoContent').classList.remove('hidden');
      
      // Status do volume com base no multiplier
      const status = document.getElementById('volumeStatus');
      const multiplierDiv = document.getElementById('volumeMultiplier');
      const multiplier = data.volume_multiplier;
      const statusInfo = data.status;
      
      status.innerHTML = `<span class="text-${statusInfo.color}-400">${statusInfo.icon} ${statusInfo.level}</span>`;
      multiplierDiv.textContent = `${multiplier}x da média`;
      
      // ✅ CORREÇÃO PRINCIPAL - usar volume_medio_7d
      document.getElementById('volumeAtualDisplay').textContent = data.volume_atual.toLocaleString();
      document.getElementById('volumeMedioDisplay').textContent = data.volume_medio_7d.toLocaleString();
      document.getElementById('diasAnalisados').textContent = data.dias_analisados;
      
      // Indicadores principais
      document.getElementById('dominantType').textContent = data.dominant_type;
      document.getElementById('hotStrike').innerHTML = `
        <div>R$ ${data.hot_strike.toFixed(2)}</div>
        <div class="text-xs text-gray-500">${data.hot_strike_type} (${data.hot_strike_volume.toLocaleString()})</div>
      `;
      
      // Gráfico histórico
      createVolumeHistoricoChart(data.chart_data);
      
      console.log('✅ Volume histórico exibido com sucesso');
    }
 
    // 🔥 NOVA FUNÇÃO - Criar gráfico de volume histórico
    function createVolumeHistoricoChart(chartData) {
      try {
        console.log(' Criando gráfico histórico:', chartData);
        
        const traces = [];
        
        // Barras de volume histórico
        traces.push({
          x: chartData.labels,
          y: chartData.volumes.slice(0, -1), // Todos exceto o último (hoje)
          type: 'bar',
          marker: { 
            color: '#8b5cf6',
            opacity: 0.7
          },
          name: 'Volume Histórico',
          hovertemplate: '<b>%{x}</b><br>Volume: %{y:,}<extra></extra>'
        });
        
        // Barra de hoje (destacada)
        const hoje = chartData.volumes[chartData.volumes.length - 1];
        traces.push({
          x: [chartData.labels[chartData.labels.length - 1]],
          y: [hoje],
          type: 'bar',
          marker: { 
            color: '#fbbf24',
            opacity: 0.9
          },
          name: 'Hoje',
          hovertemplate: '<b>HOJE</b><br>Volume: %{y:,}<extra></extra>'
        });
        
        // Linha da média
        const media = chartData.volumes.slice(0, -1).reduce((a, b) => a + b, 0) / (chartData.volumes.length - 1);
        traces.push({
          x: chartData.labels,
          y: Array(chartData.labels.length).fill(media),
          type: 'scatter',
          mode: 'lines',
          line: { 
            color: '#06b6d4', 
            width: 2, 
            dash: 'dash'
          },
          name: 'Média 30d',
          hovertemplate: '<b>Média</b><br>%{y:,}<extra></extra>'
        });
        
        const layout = {
          height: 200,
          margin: { l: 50, r: 20, t: 20, b: 40 },
          template: 'plotly_dark',
          paper_bgcolor: 'transparent',
          plot_bgcolor: 'transparent',
          showlegend: false,
          xaxis: {
            tickfont: { color: 'lightgray', size: 10 },
            gridcolor: 'rgba(255,255,255,0.1)'
          },
          yaxis: {
            tickfont: { color: 'lightgray', size: 10 },
            gridcolor: 'rgba(255,255,255,0.1)',
            title: 'Volume'
          }
        };
        
        Plotly.newPlot('volumeHistoricoChart', traces, layout, {
          responsive: true,
          displayModeBar: false
        });
        
        console.log('✅ Gráfico histórico criado');
        
      } catch (error) {
        console.error('❌ Erro ao criar gráfico histórico:', error);
      }
    }
 
    // 🔥 NOVA FUNÇÃO - Analisar hot strike específico
    function analisarHotStrike() {
      if (!currentVolumeData || !currentVolumeData.hot_strike) {
        alert('⚠️ Nenhum strike ativo identificado');
        return;
      }
      
      const hotStrike = currentVolumeData.hot_strike;
      const hotType = currentVolumeData.hot_strike_type;
      const hotVolume = currentVolumeData.hot_strike_volume;
      
      // Buscar detalhes do strike
      buscarDetalhesStrike(hotStrike);
    }
    
    // NOVA FUNÇÃO - Buscar detalhes
    async function buscarDetalhesStrike(strike) {
      try {
        const response = await fetch('/api/opcoes/strike-detalhado', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${userToken}`
          },
          body: JSON.stringify({ ticker: currentTicker, strike: strike })
        });
    
        const result = await response.json();
        
        if (result.success) {
          mostrarModalComDetalhes(result.data);
        } else {
          // Fallback para modal simples se não conseguir detalhes
          mostrarModalSimples(strike);
        }
      } catch (error) {
        mostrarModalSimples(strike);
      }
    }
    
    // MODAL COM DETALHES
    function mostrarModalComDetalhes(data) {
      const modalHTML = `
        <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50" id="hotStrikeModal">
          <div class="bg-gray-900 rounded-2xl p-8 max-w-4xl mx-4 border border-gray-700 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-2xl font-bold text-white"> Strike R$ ${data.strike.toFixed(2)}</h3>
              <button onclick="closeHotStrikeModal()" class="text-gray-400 hover:text-white text-2xl">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <div class="space-y-6">
              <!-- Resumo -->
              <div class="grid grid-cols-3 gap-4">
                <div class="bg-cyan-500/10 rounded-lg p-4 border border-cyan-500/20 text-center">
                  <div class="text-2xl font-bold text-cyan-400">${data.total_volume.toLocaleString()}</div>
                  <div class="text-sm text-gray-400">Volume Total</div>
                </div>
                <div class="bg-green-500/10 rounded-lg p-4 border border-green-500/20 text-center">
                  <div class="text-2xl font-bold text-green-400">${data.calls_volume.toLocaleString()}</div>
                  <div class="text-sm text-gray-400">Calls (${data.calls.length})</div>
                </div>
                <div class="bg-orange-500/10 rounded-lg p-4 border border-orange-500/20 text-center">
                  <div class="text-2xl font-bold text-orange-400">${data.puts_volume.toLocaleString()}</div>
                  <div class="text-sm text-gray-400">Puts (${data.puts.length})</div>
                </div>
              </div>
    
              <!-- Calls -->
              ${data.calls.length > 0 ? `
              <div class="bg-green-500/5 rounded-lg p-4 border border-green-500/20">
                <h4 class="text-green-400 font-semibold mb-3"> Calls Ativas</h4>
                <div class="space-y-2">
                  ${data.calls.map(call => `
                    <div class="flex justify-between items-center bg-black/20 rounded p-3">
                      <span class="text-white font-mono text-sm">${call.symbol}</span>
                      <span class="text-green-400 font-semibold">${call.volume.toLocaleString()} contratos</span>
                    </div>
                  `).join('')}
                </div>
              </div>
              ` : ''}
    
              <!-- Puts -->
              ${data.puts.length > 0 ? `
              <div class="bg-orange-500/5 rounded-lg p-4 border border-orange-500/20">
                <h4 class="text-orange-400 font-semibold mb-3"> Puts Ativas</h4>
                <div class="space-y-2">
                  ${data.puts.map(put => `
                    <div class="flex justify-between items-center bg-black/20 rounded p-3">
                      <span class="text-white font-mono text-sm">${put.symbol}</span>
                      <span class="text-orange-400 font-semibold">${put.volume.toLocaleString()} contratos</span>
                    </div>
                  `).join('')}
                </div>
              </div>
              ` : ''}
    
              <!-- Insight -->
              <div class="bg-yellow-500/10 rounded-lg p-4 border border-yellow-500/20">
                <h4 class="text-yellow-400 font-semibold mb-2">⚠️ Insight Estratégico</h4>
                <p class="text-gray-300 text-sm">
                  Strike R$ ${data.strike.toFixed(2)} concentra <strong>${data.total_volume.toLocaleString()}</strong> contratos.
                  Dominância: <strong>${data.calls_volume > data.puts_volume ? 'CALLS' : 'PUTS'}</strong>
                  ${data.calls_volume > data.puts_volume ? 
                    '- Grandes players apostando na alta.' : 
                    '- Grandes players se protegendo ou apostando na baixa.'}
                </p>
              </div>
              
              <button onclick="closeHotStrikeModal()" class="w-full bg-gradient-to-r from-cyan-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-cyan-600 transition-all">
                <i class="fas fa-check mr-2"></i>Entendido
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
    
    // MODAL SIMPLES (fallback)
    function mostrarModalSimples(strike) {
      const modalHTML = `
        <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50" id="hotStrikeModal">
          <div class="bg-gray-900 rounded-2xl p-8 max-w-2xl mx-4 border border-gray-700">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-2xl font-bold text-white"> Strike Mais Ativo</h3>
              <button onclick="closeHotStrikeModal()" class="text-gray-400 hover:text-white text-2xl">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <div class="space-y-4">
              <div class="bg-gradient-to-r from-cyan-500/10 to-purple-500/10 rounded-lg p-6 border border-cyan-500/20">
                <div class="text-center">
                  <div class="text-4xl font-bold text-white mb-2">R$ ${strike.toFixed(2)}</div>
                  <div class="text-cyan-400 font-semibold">Carregando detalhes...</div>
                </div>
              </div>
              
              <button onclick="closeHotStrikeModal()" class="w-full bg-gradient-to-r from-cyan-600 to-purple-600 text-white py-3 rounded-lg font-semibold">
                Fechar
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
 
    // 🔥 NOVA FUNÇÃO - Fechar modal do hot strike
    function closeHotStrikeModal() {
      const modal = document.getElementById('hotStrikeModal');
      if (modal) {
        modal.remove();
      }
    }
 
    // 🔥 NOVA FUNÇÃO - Adicionar hot strike ao grupo
    function adicionarHotStrikeAoGrupo() {
      if (!currentVolumeData) return;
      
      // Lógica para identificar a letra do vencimento baseada no hot strike
      const letrasComuns = ['F', 'G', 'H', 'I']; // Jun, Jul, Ago, Set
      const sugestao = letrasComuns.join(',');
      
      // Adicionar ao último grupo
      const inputs = document.querySelectorAll('.grupo-row input');
      const ultimoInput = inputs[inputs.length - 1];
      
      if (ultimoInput.value.trim()) {
        // Se já tem valor, adicionar novo grupo
        adicionarGrupo();
        const novosInputs = document.querySelectorAll('.grupo-row input');
        novosInputs[novosInputs.length - 1].value = sugestao;
      } else {
        ultimoInput.value = sugestao;
      }
      
      closeHotStrikeModal();
      
      // Scroll para a área de grupos
      document.getElementById('gruposContainer').scrollIntoView({ behavior: 'smooth' });
      
      alert(`✅ Sugestão adicionada: ${sugestao}\n\nBaseado no volume concentrado no strike R$ ${currentVolumeData.hot_strike.toFixed(2)}`);
    }
 
    // Display ticker info
    function displayTickerInfo(info) {
      const container = document.getElementById('tickerInfo');
      const changeClass = info.change >= 0 ? 'text-success' : 'text-danger';
      const changeIcon = info.change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
      
      document.getElementById('tickerName').textContent = `${info.ticker} - ${info.name}`;
      document.getElementById('tickerPrice').textContent = `Preço: R$ ${info.current_price.toFixed(2)}`;
      document.getElementById('tickerChange').innerHTML = `
        <i class="fas ${changeIcon} mr-1"></i>
        R$ ${info.change.toFixed(2)} (${info.change_percent.toFixed(2)}%)
      `;
      document.getElementById('tickerChange').className = `font-semibold ${changeClass}`;
      document.getElementById('tickerVolume').textContent = `Volume: ${info.volume.toLocaleString()}`;
      
      container.classList.remove('hidden');
    }
 
    // Display letras disponíveis
    function displayLetrasDisponiveis(letras) {
      const container = document.getElementById('letrasContainer');
      container.innerHTML = '';
      
      letras.forEach(letra => {
        const info = mesesMap[letra] || { mes: 'Indefinido', class: '' };
        const span = document.createElement('span');
        span.className = `letra-btn bg-primary/20 text-primary px-4 py-3 rounded-xl text-sm font-semibold cursor-pointer hover:bg-primary/30 transition-colors flex flex-col items-center min-w-[90px] border border-primary/30 ${info.class}`;
        span.setAttribute('data-letra', letra);
        span.innerHTML = `
          <div class="font-bold text-xl">${letra}</div>
          <div class="text-xs opacity-80 text-center">${info.mes}</div>
        `;
        
        span.onclick = () => toggleLetraSelection(letra, span);
        container.appendChild(span);
      });
      
      document.getElementById('letrasDisponiveis').classList.remove('hidden');
    }
 
    // Toggle letra selection
    function toggleLetraSelection(letra, element) {
      const info = mesesMap[letra];
      const pairLetter = info?.pair;
      
      if (selectedLetras.has(letra)) {
        selectedLetras.delete(letra);
        element.classList.remove('selected');
      } else {
        selectedLetras.add(letra);
        element.classList.add('selected');
      }
      
      adicionarLetraAoGrupo(letra);
      
      if (pairLetter) {
        const pairElement = document.querySelector(`[data-letra="${pairLetter}"]`);
        if (pairElement) {
          if (selectedLetras.has(letra)) {
            pairElement.classList.add('related');
          } else {
            pairElement.classList.remove('related');
          }
        }
      }
    }
 
    // Adicionar letra ao grupo atual
    function adicionarLetraAoGrupo(letra) {
      const inputs = document.querySelectorAll('.grupo-row input');
      const ultimoInput = inputs[inputs.length - 1];
      
      const currentValue = ultimoInput.value.trim();
      const letrasExistentes = currentValue ? currentValue.split(',').map(l => l.trim()) : [];
      
      const index = letrasExistentes.indexOf(letra);
      if (index > -1) {
        letrasExistentes.splice(index, 1);
      } else {
        letrasExistentes.push(letra);
      }
      
      ultimoInput.value = letrasExistentes.filter(l => l).join(',');
    }
 
    // Adicionar novo grupo
    function adicionarGrupo() {
      const container = document.getElementById('gruposContainer');
      const novoGrupo = document.createElement('div');
      novoGrupo.className = 'grupo-row flex gap-4 items-center';
      novoGrupo.innerHTML = `
        <input 
          type="text" 
          placeholder="Ex: G,S (clique nas letras acima)"
          class="grupo-input text-white rounded-xl px-5 py-4 flex-1 focus:outline-none text-lg"
        >
        <button onclick="removerGrupo(this)" class="action-btn danger">
          <i class="fas fa-trash"></i>Remover
        </button>
      `;
      container.appendChild(novoGrupo);
    }
 
    // Remover grupo
    function removerGrupo(btn) {
      btn.parentElement.remove();
    }
 
    // Executar análise
    async function executarAnalise() {
      if (!currentTicker) {
        alert('⚠️ Primeiro busque um ticker válido');
        return;
      }
 
      const inputs = document.querySelectorAll('.grupo-row input');
      const grupos = [];
      
      inputs.forEach(input => {
        const valor = input.value.trim().toUpperCase();
        if (valor) {
          const letras = valor.split(',').map(l => l.trim()).filter(l => l);
          if (letras.length > 0) {
            grupos.push(letras);
          }
        }
      });
 
      if (grupos.length === 0) {
        alert('⚠️ Configure pelo menos um grupo de vencimentos');
        return;
      }
 
      console.log('🚀 Executando análise:', currentTicker, grupos);
 
      document.getElementById('loadingSection').classList.remove('hidden');
      document.getElementById('resultsSection').classList.add('hidden');
 
      const btn = document.getElementById('analisarBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<div class="loading-spinner mr-2"></div>Analisando...';
      btn.disabled = true;
 
      try {
        const response = await fetch('/api/opcoes/hunter-walls', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${userToken}`
          },
          body: JSON.stringify({
            ticker: currentTicker,
            grupos_vencimentos: grupos
          })
        });
 
        const result = await response.json();
 
        if (result.success) {
          displayResults(result.data);
        } else {
          throw new Error(result.message);
        }
 
      } catch (error) {
        console.error('Erro na análise:', error);
        alert(`❌ Erro na análise: ${error.message}`);
      } finally {
        document.getElementById('loadingSection').classList.add('hidden');
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }
 
    // Display results
    function displayResults(data) {
      console.log(' Exibindo resultados:', data);
      
      displaySummaryCards(data.summary);
      displayChartsAdaptive(data.chart_data, data.ticker_info);
      displayDetailedSummary(data.summary);
      
      document.getElementById('resultsSection').classList.remove('hidden');
      document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    }
 
    // Display summary cards
    // Display summary cards - VERSÃO CORRIGIDA
    function displaySummaryCards(summary) {
      const container = document.getElementById('summaryCards');
      const putCallRatio = summary.put_call_ratio_geral;
      
      let ratioColor = 'text-gray-300';
      let ratioIcon = 'fa-balance-scale';
      
      if (putCallRatio > 1.2) {
        ratioColor = 'text-danger';
        ratioIcon = 'fa-arrow-down';
      } else if (putCallRatio < 0.8) {
        ratioColor = 'text-success';
        ratioIcon = 'fa-arrow-up';
      }
      
      container.innerHTML = `
        <div class="bg-gradient-to-r from-primary/10 to-primary/5 rounded-xl p-6 border border-primary/20">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-primary/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-chart-line text-primary text-xl"></i>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-white">${summary.total_volume.toLocaleString()}</div>
              <div class="text-sm text-gray-400">Volume Total</div>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-r from-success/10 to-success/5 rounded-xl p-6 border border-success/20">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-success/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-arrow-up text-success text-xl"></i>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-success">${summary.total_calls.toLocaleString()}</div>
              <div class="text-sm text-gray-400">Calls (${summary.percent_calls}%)</div>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-r from-orange-500/10 to-orange-500/5 rounded-xl p-6 border border-orange-500/20">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-orange-500/20 rounded-lg flex items-center justify-center">
              <i class="fas fa-arrow-down text-orange-400 text-xl"></i>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-orange-400">${summary.total_puts.toLocaleString()}</div>
              <div class="text-sm text-gray-400">Puts (${summary.percent_puts}%)</div>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-r from-secondary/10 to-secondary/5 rounded-xl p-6 border border-secondary/20">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-secondary/20 rounded-lg flex items-center justify-center">
              <i class="fas ${ratioIcon} text-secondary text-xl"></i>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold ${ratioColor}">${putCallRatio}</div>
              <div class="text-sm text-gray-400">Put/Call Ratio</div>
            </div>
          </div>
        </div>
      `;
    }

   // Display charts adaptativo
   function displayChartsAdaptive(chartData, tickerInfo) {
     const container = document.getElementById('chartsContainer');
     
     container.innerHTML = '';
     
     const grupos = Object.keys(chartData);
     const numGrupos = grupos.length;
     
     let gridClass = 'single';
     if (numGrupos === 2) gridClass = 'double';
     else if (numGrupos === 3) gridClass = 'triple';
     else if (numGrupos >= 4) gridClass = 'quad';
     
     container.className = `chart-grid ${gridClass}`;
     
     grupos.forEach((nomeGrupo, index) => {
       const dados = chartData[nomeGrupo];
       
       let letrasGrupo = nomeGrupo;
       const match = nomeGrupo.match(/\(([^)]+)\)/);
       if (match) {
         letrasGrupo = match[1];
       }
       
       const primeiraLetra = letrasGrupo.split(',')[0];
       const mesInfo = mesesMap[primeiraLetra];
       const mesNome = mesInfo ? mesInfo.mes : letrasGrupo;
       
       const chartDiv = document.createElement('div');
       chartDiv.className = 'individual-chart';
       
       const maxCallsVolume = Math.abs(Math.min(...dados.calls_volumes));
       const maxPutsVolume = Math.max(...dados.puts_volumes);
       
       const maxCallsIndex = dados.calls_volumes.findIndex(v => Math.abs(v) === maxCallsVolume);
       const maxPutsIndex = dados.puts_volumes.findIndex(v => v === maxPutsVolume);
       
       const maxCallsStrike = dados.strikes_values[maxCallsIndex];
       const maxPutsStrike = dados.strikes_values[maxPutsIndex];
       
       chartDiv.innerHTML = `
         <div class="chart-title">
           <span>${mesNome} (${letrasGrupo})</span>
           <div class="chart-stats">
             <span title="Maior volume de calls: R$ ${maxCallsStrike?.toFixed(2)}">Calls: ${maxCallsVolume.toLocaleString()}</span>
             <span title="Maior volume de puts: R$ ${maxPutsStrike?.toFixed(2)}">Puts: ${maxPutsVolume.toLocaleString()}</span>
             <span class="text-yellow-400" title="Strike com maior volume total">Maior: R$ ${encontrarMaiorVolumeStrike(dados)}</span>
           </div>
         </div>
         <div id="chart-${index}" style="height: 450px;"></div>
       `;
       
       container.appendChild(chartDiv);
       
       const traces = [];
       
       traces.push({
         type: 'bar',
         orientation: 'h',
         y: dados.labels,
         x: dados.calls_volumes,
         name: 'CALLS',
         marker: { color: '#0099ff' },
         hovertemplate: '<b>CALLS</b><br>Strike: %{y}<br>Volume: %{text}<extra></extra>',
         text: dados.calls_volumes.map(v => Math.abs(v).toLocaleString())
       });
       
       traces.push({
         type: 'bar',
         orientation: 'h',
         y: dados.labels,
         x: dados.puts_volumes,
         name: 'PUTS',
         marker: { color: '#ff6600' },
         hovertemplate: '<b>PUTS</b><br>Strike: %{y}<br>Volume: %{x:,}<extra></extra>'
       });
       
       if (tickerInfo.current_price) {
         const precoAtual = tickerInfo.current_price;
         let precoIndex = -1;
         let menorDiferenca = Infinity;
         
         dados.strikes_values.forEach((strike, idx) => {
           const diferenca = Math.abs(strike - precoAtual);
           if (diferenca < menorDiferenca) {
             menorDiferenca = diferenca;
             precoIndex = idx;
           }
         });
         
         if (precoIndex >= 0) {
           traces.push({
             type: 'scatter',
             mode: 'lines',
             x: [Math.min(...dados.calls_volumes) * 1.1, Math.max(...dados.puts_volumes) * 1.1],
             y: [dados.labels[precoIndex], dados.labels[precoIndex]],
             line: {
               color: '#FFD700',
               width: 3,
               dash: 'dash'
             },
             name: `Preço: R$ ${precoAtual.toFixed(2)}`,
             hovertemplate: `<b>Preço Atual</b><br>R$ ${precoAtual.toFixed(2)}<extra></extra>`
           });
         }
       }
       
       const layout = {
         title: {
           text: `Preço Atual: R$ ${tickerInfo.current_price.toFixed(2)}`,
           font: { size: 16, color: 'white' },
           x: 0.5
         },
         template: 'plotly_dark',
         height: 450,
         margin: { l: 80, r: 40, t: 60, b: 60 },
         xaxis: {
           title: '← CALLS | PUTS →',
           tickfont: { color: 'lightgray', size: 10 },
           titlefont: { color: 'white', size: 12 },
           gridcolor: 'rgba(255,255,255,0.1)'
         },
         yaxis: {
           title: 'Strike',
           tickfont: { color: 'lightgray', size: 10 },
           titlefont: { color: 'white', size: 12 },
           gridcolor: 'rgba(255,255,255,0.1)'
         },
         legend: {
           orientation: 'h',
           yanchor: 'bottom',
           y: 1.02,
           xanchor: 'center',
           x: 0.5,
           font: { color: 'white', size: 10 }
         },
         paper_bgcolor: 'transparent',
         plot_bgcolor: 'transparent'
       };
       
       setTimeout(() => {
         Plotly.newPlot(`chart-${index}`, traces, layout, {
           responsive: true,
           displayModeBar: true,
           modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
         });
       }, index * 100);
     });
   }

   // Função auxiliar para encontrar strike com maior volume total
   function encontrarMaiorVolumeStrike(dados) {
     let maiorVolume = 0;
     let strikeIndex = 0;
     
     dados.calls_volumes.forEach((callsVol, index) => {
       const putsVol = dados.puts_volumes[index] || 0;
       const volumeTotal = Math.abs(callsVol) + putsVol;
       
       if (volumeTotal > maiorVolume) {
         maiorVolume = volumeTotal;
         strikeIndex = index;
       }
     });
     
     return dados.strikes_values[strikeIndex]?.toFixed(2) || '0.00';
   }

   // Display detailed summary
   function displayDetailedSummary(summary) {
     const container = document.getElementById('detailedSummary');
     
     let html = `
       <div class="mb-8">
         <h3 class="text-xl font-bold text-white mb-4">Resumo por Grupo</h3>
         <div class="overflow-x-auto">
           <table class="w-full border-collapse">
             <thead>
               <tr class="bg-gray-700">
                 <th class="border border-gray-600 px-4 py-3 text-left text-white">Mês</th>
                 <th class="border border-gray-600 px-4 py-3 text-right text-white">Volume Total</th>
                 <th class="border border-gray-600 px-4 py-3 text-right text-white">Calls</th>
                 <th class="border border-gray-600 px-4 py-3 text-right text-white">Puts</th>
                 <th class="border border-gray-600 px-4 py-3 text-right text-white">P/C Ratio</th>
                 <th class="border border-gray-600 px-4 py-3 text-right text-white">% do Total</th>
               </tr>
             </thead>
             <tbody>
     `;
     
     summary.grupos.forEach(grupo => {
       let letrasGrupo = grupo.nome;
       const match = grupo.nome.match(/\(([^)]+)\)/);
       if (match) {
         letrasGrupo = match[1];
       }
       
       const primeiraLetra = letrasGrupo.split(',')[0];
       const mesInfo = mesesMap[primeiraLetra];
       const mesNome = mesInfo ? `${mesInfo.mes} (${letrasGrupo})` : letrasGrupo;
       
       let rowColor = 'bg-gray-800';
       if (parseFloat(grupo.put_call_ratio) > 1.2) {
         rowColor = 'bg-red-900/30';
       } else if (parseFloat(grupo.put_call_ratio) < 0.8) {
         rowColor = 'bg-green-900/30';
       }
       
       html += `
         <tr class="${rowColor}">
           <td class="border border-gray-600 px-4 py-3 text-white font-semibold">${mesNome}</td>
           <td class="border border-gray-600 px-4 py-3 text-right text-white">${grupo.total_volume.toLocaleString()}</td>
           <td class="border border-gray-600 px-4 py-3 text-right text-blue-400">${grupo.total_calls.toLocaleString()}</td>
           <td class="border border-gray-600 px-4 py-3 text-right text-orange-400">${grupo.total_puts.toLocaleString()}</td>
           <td class="border border-gray-600 px-4 py-3 text-right text-white">${grupo.put_call_ratio}</td>
           <td class="border border-gray-600 px-4 py-3 text-right text-white">${grupo.percent_of_total}%</td>
         </tr>
       `;
     });
     
     html += `
             </tbody>
           </table>
         </div>
       </div>
       
       <div class="space-y-6">
         <h3 class="text-xl font-bold text-white">Top Opções por Grupo</h3>
     `;
     
     summary.grupos.forEach(grupo => {
       let letrasGrupo = grupo.nome;
       const match = grupo.nome.match(/\(([^)]+)\)/);
       if (match) {
         letrasGrupo = match[1];
       }
       
       const primeiraLetra = letrasGrupo.split(',')[0];
       const mesInfo = mesesMap[primeiraLetra];
       const mesNome = mesInfo ? `${mesInfo.mes} (${letrasGrupo})` : letrasGrupo;
       
       html += `
         <div class="bg-gray-800/50 rounded-lg p-6">
           <h4 class="text-lg font-semibold text-white mb-4">${mesNome}</h4>
           <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
             <div>
               <h5 class="text-blue-400 font-semibold mb-2">Top Calls</h5>
               <ul class="space-y-1">
       `;
       
       grupo.top_calls.forEach(call => {
         html += `
           <li class="text-gray-300 text-sm">
             ${call.symbol} | R$ ${call.strike.toFixed(2)} | Vol: ${call.volume.toLocaleString()}
           </li>
         `;
       });
       
       html += `
               </ul>
             </div>
             <div>
               <h5 class="text-orange-400 font-semibold mb-2">Top Puts</h5>
               <ul class="space-y-1">
       `;
       
       grupo.top_puts.forEach(put => {
         html += `
           <li class="text-gray-300 text-sm">
             ${put.symbol} | R$ ${put.strike.toFixed(2)} | Vol: ${put.volume.toLocaleString()}
           </li>
         `;
       });
       
       html += `
               </ul>
             </div>
           </div>
         </div>
       `;
     });
     
     html += '</div>';
     
     container.innerHTML = html;
   }

   // ===== FUNÇÃO DO EXPANDER =====
   function toggleInfo() {
     const content = document.getElementById('infoContent');
     const icon = document.getElementById('infoIcon');
     
     if (content.classList.contains('hidden')) {
       content.classList.remove('hidden');
       content.style.animation = 'fadeIn 0.5s ease-in-out';
       icon.classList.remove('fa-info-circle');
       icon.classList.add('fa-times');
     } else {
       content.style.animation = 'fadeOut 0.3s ease-in-out';
       setTimeout(() => {
         content.classList.add('hidden');
       }, 300);
       icon.classList.remove('fa-times');
       icon.classList.add('fa-info-circle');
     }
   }

   // Logout function
   async function logout() {
     try {
       if (userToken) {
         await fetch('/auth/logout', {
           method: 'POST',
           headers: { 'Authorization': `Bearer ${userToken}` }
         });
       }
     } catch (error) {
       console.error('Logout error:', error);
     } finally {
       localStorage.removeItem('geminii_token');
       localStorage.removeItem('geminii_user');
       window.location.href = '/';
     }
   }

   // Make functions global
   window.logout = logout;
   window.buscarLetrasDisponiveis = buscarLetrasDisponiveis;
   window.adicionarGrupo = adicionarGrupo;
   window.removerGrupo = removerGrupo;
   window.executarAnalise = executarAnalise;
   window.toggleLetraSelection = toggleLetraSelection;
   window.toggleInfo = toggleInfo;
   window.buscarDetalhesStrike = buscarDetalhesStrike;
   window.mostrarModalComDetalhes = mostrarModalComDetalhes;
   window.mostrarModalSimples = mostrarModalSimples;
   
   
   window.analisarHotStrike = analisarHotStrike;
   window.closeHotStrikeModal = closeHotStrikeModal;
   window.adicionarHotStrikeAoGrupo = adicionarHotStrikeAoGrupo;

   // Initialize when page loads
   document.addEventListener('DOMContentLoaded', initPage);
 </script>
</body>
</html>