<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gamma Flip Screening - Geminii Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#000000',
            light: '#ffffff',
            subtle: 'rgba(255,255,255,0.1)',
            geminii: '#fb1ebb'
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
      min-height: 100vh;
    }
    
    .screening-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      transition: all 0.3s ease;
    }
    
    .screening-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(186, 57, 175, 0.15);
      border-color: rgba(186, 57, 175, 0.3);
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .spinner {
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 2px solid #fb1ebb;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-10px); }
    }

    .regime-long {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .regime-short {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .regime-neutral {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .liquidity-badge {
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .liquidity-alta {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.4);
    }

    .liquidity-media {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
      border: 1px solid rgba(251, 191, 36, 0.4);
    }

    .liquidity-baixa {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.4);
    }

    .screening-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .screening-table thead th {
      background: rgba(255, 255, 255, 0.05);
      color: #9ca3af;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .screening-table tbody tr {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.2s ease;
    }

    .screening-table tbody tr:hover {
      background: rgba(186, 57, 175, 0.1);
    }

    .screening-table tbody td {
      padding: 14px 16px;
      font-size: 13px;
      color: white;
    }

    .preset-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .preset-btn:hover {
      background: rgba(186, 57, 175, 0.2);
      border-color: rgba(186, 57, 175, 0.4);
      transform: translateY(-1px);
    }

    .preset-btn.active {
      background: linear-gradient(135deg, #fb1ebb, #9333ea);
      border-color: #fb1ebb;
      box-shadow: 0 4px 12px rgba(186, 57, 175, 0.3);
    }

    .summary-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .distance-positive {
      color: #22c55e;
      font-weight: 600;
    }

    .distance-negative {
      color: #ef4444;
      font-weight: 600;
    }

    .ticker-link {
      color: #fb1ebb;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ticker-link:hover {
      color: #c916a3;
      text-decoration: underline;
    }

    .custom-input {
      background: rgba(30, 30, 30, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      transition: all 0.3s ease;
    }

    .custom-input:focus {
      outline: none;
      border-color: #fb1ebb;
      box-shadow: 0 0 0 2px rgba(186, 57, 175, 0.2);
    }

    .custom-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #fb1ebb, #9333ea);
      transition: width 0.3s ease;
      animation: progressPulse 1.5s ease-in-out infinite;
    }

    @keyframes progressPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
</head>
<body class="text-white">
  
  <!-- Navbar -->
  <nav class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-opacity-5 border-opacity-10 bg-white border-white border rounded-full px-4 py-3 shadow-xl backdrop-blur-md">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <img src="logo.png" alt="Geminii Logo" class="w-6 h-6 cursor-pointer" onclick="window.location.href='/'">
      </div>
      <div class="hidden md:flex items-center space-x-6 text-xs text-gray-300 ml-8">
        <a href="/dashboard" class="hover:text-white transition-colors">Dashboard</a>
        <a href="opcoes.html" class="hover:text-white transition-colors">Hunter Walls</a>
        <a href="vi-pro.html" class="hover:text-white transition-colors">Implícita Sigma</a>
        <a href="gamma-levels.html" class="hover:text-white transition-colors">Gamma Levels</a>
        <span class="text-white font-medium">Flip Screening</span>
      </div>
      <div class="flex items-center space-x-3 ml-8">
        <div id="apiStatus" class="w-8 h-8 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-full flex items-center justify-center relative">
          <i class="fas fa-chart-line text-green-500 text-xs"></i>
          <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Content -->
  <div class="pt-32 pb-16">
    <div class="max-w-7xl mx-auto px-6">
      
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">
          <span style="color: #fb1ebb; font-weight: 900;">Gamma Flip</span>
          <span class="text-white font-light">Screening</span>
        </h1>
        <p class="text-neutral-300 text-lg max-w-3xl mx-auto">
          Rastreamento em tempo real do Gamma Flip para múltiplos ativos. Identifique rapidamente quais ações estão próximas de seus níveis críticos e o regime de gamma atual.
        </p>
        
        <!-- Info Expander -->
        <div class="mt-8">
          <button onclick="toggleInfo()" class="bg-gradient-to-r from-geminii to-purple-600 hover:from-purple-600 hover:to-geminii text-white px-6 py-3 rounded-full font-semibold text-sm transition-all duration-300 flex items-center mx-auto shadow-lg hover:shadow-xl transform hover:scale-105">
            <i id="infoIcon" class="fas fa-info-circle mr-2 transition-transform duration-300"></i>
            Como Funciona o Gamma Flip Screening
          </button>
          
          <div id="infoContent" class="hidden mt-8 max-w-5xl mx-auto">
            <div class="screening-card p-8 text-left">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                
                <!-- O que é -->
                <div class="space-y-4">
                  <div class="flex items-center mb-4">
                    <div class="w-4 h-4 rounded-full bg-geminii mr-3"></div>
                    <h3 class="text-xl font-bold text-white">O que é</h3>
                  </div>
                  <p class="text-gray-300 text-sm leading-relaxed">
                    O <strong>Gamma Flip</strong> é o nível de preço onde o mercado muda de regime. Acima do flip = <strong>Long Gamma</strong> (mercado contido). Abaixo do flip = <strong>Short Gamma</strong> (mercado explosivo).
                  </p>
                </div>
                
                <!-- Para que serve -->
                <div class="space-y-4">
                  <div class="flex items-center mb-4">
                    <div class="w-4 h-4 rounded-full bg-purple-500 mr-3"></div>
                    <h3 class="text-xl font-bold text-white">Para que serve</h3>
                  </div>
                  <p class="text-gray-300 text-sm leading-relaxed">
                    Este screening permite <strong>monitorar simultaneamente dezenas de ativos</strong>, identificando quais estão próximos do flip (oportunidade) e qual o regime atual de cada um.
                  </p>
                </div>
                
                <!-- Como usar -->
                <div class="space-y-4">
                  <div class="flex items-center mb-4">
                    <div class="w-4 h-4 rounded-full bg-blue-500 mr-3"></div>
                    <h3 class="text-xl font-bold text-white">Como usar</h3>
                  </div>
                  <p class="text-gray-300 text-sm leading-relaxed">
                    Escolha um <strong>preset de ativos</strong> ou crie sua lista personalizada. O sistema analisa todos em paralelo e ordena por <strong>proximidade ao flip</strong>.
                  </p>
                </div>
                
              </div>
              
              <!-- Interpretação -->
              <div class="mt-8 pt-6 border-t border-white/10">
                <h4 class="text-geminii font-bold text-lg mb-4">Interpretação dos Resultados</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="bg-white/5 rounded-lg p-4">
                    <h5 class="text-white font-semibold text-sm mb-2">
                      <i class="fas fa-arrow-up text-green-400 mr-2"></i>Long Gamma (Verde)
                    </h5>
                    <p class="text-gray-400 text-xs">
                      Preço <strong>acima</strong> do flip. Market makers vendem volatilidade, mercado tende a ficar contido com movimentos menores.
                    </p>
                  </div>
                  <div class="bg-white/5 rounded-lg p-4">
                    <h5 class="text-white font-semibold text-sm mb-2">
                      <i class="fas fa-arrow-down text-red-400 mr-2"></i>Short Gamma (Vermelho)
                    </h5>
                    <p class="text-gray-400 text-xs">
                      Preço <strong>abaixo</strong> do flip. Market makers compram volatilidade, mercado pode ter movimentos explosivos e amplificados.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Controles -->
      <div class="screening-card p-6 mb-8">
        <div class="space-y-6">
          
          <!-- Linha 1: Presets -->
          <div>
            <label class="text-sm font-semibold text-gray-300 mb-3 block">
              <i class="fas fa-list mr-2"></i>Listas Pré-definidas
            </label>
            <div class="flex flex-wrap gap-3">
              <button class="preset-btn" data-preset="ibovespa_liquidos">
                <i class="fas fa-chart-line mr-1"></i>Ibovespa Líquidos
              </button>
              <button class="preset-btn" data-preset="alta_liquidez">
                <i class="fas fa-fire mr-1"></i>Alta Liquidez
              </button>
              <button class="preset-btn" data-preset="media_liquidez">
                <i class="fas fa-water mr-1"></i>Média Liquidez
              </button>
              <button class="preset-btn" data-preset="small_caps">
                <i class="fas fa-seedling mr-1"></i>Small Caps
              </button>
              <button class="preset-btn" data-preset="commodities">
                <i class="fas fa-oil-can mr-1"></i>Commodities
              </button>
              <button class="preset-btn" data-preset="financeiro">
                <i class="fas fa-university mr-1"></i>Financeiro
              </button>
            </div>
          </div>

          <!-- Linha 2: Input customizado -->
          <div>
            <label class="text-sm font-semibold text-gray-300 mb-3 block">
              <i class="fas fa-edit mr-2"></i>Lista Personalizada
            </label>
            <div class="flex gap-3">
              <input 
                id="customTickers" 
                type="text" 
                placeholder="Digite os tickers separados por vírgula (ex: PETR4, VALE3, BBAS3)" 
                class="custom-input flex-1"
              >
              <button id="screenBtn" class="px-6 py-2 bg-gradient-to-r from-pink-500 to-purple-600 hover:shadow-lg rounded-lg transition-all font-medium whitespace-nowrap">
                <i class="fas fa-search mr-2"></i>Iniciar Screening
              </button>
            </div>
          </div>

          <!-- Progress Bar -->
          <div id="progressContainer" class="hidden">
            <div class="flex justify-between text-xs text-gray-400 mb-2">
              <span id="progressText">Analisando...</span>
              <span id="progressPercent">0%</span>
            </div>
            <div class="progress-bar">
              <div id="progressFill" class="progress-bar-fill" style="width: 0%"></div>
            </div>
          </div>

        </div>
      </div>

      <!-- Status -->
      <div id="statusMsg" class="mb-6 p-4 rounded-lg hidden backdrop-blur-sm"></div>

      <!-- Summary -->
      <div id="summarySection" class="mb-8 hidden">
        <div class="screening-card p-6">
          <h3 class="text-xl font-bold mb-6 flex items-center">
            <i class="fas fa-chart-pie text-geminii mr-3"></i>Resumo do Screening
          </h3>
          
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="summary-card">
              <div class="text-sm text-gray-400 mb-1">Total Analisado</div>
              <div id="totalAnalyzed" class="text-2xl font-bold text-white">--</div>
            </div>
            <div class="summary-card">
              <div class="text-sm text-gray-400 mb-1">Long Gamma</div>
              <div id="totalLong" class="text-2xl font-bold text-green-400">--</div>
            </div>
            <div class="summary-card">
              <div class="text-sm text-gray-400 mb-1">Short Gamma</div>
              <div id="totalShort" class="text-2xl font-bold text-red-400">--</div>
            </div>
            <div class="summary-card">
              <div class="text-sm text-gray-400 mb-1">Dist. Média Flip</div>
              <div id="avgDistance" class="text-2xl font-bold text-purple-400">--</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Results Table -->
      <div id="resultsSection" class="hidden">
        <div class="screening-card p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold flex items-center">
              <i class="fas fa-table text-geminii mr-3"></i>Resultados do Screening
            </h3>
            <button id="exportBtn" class="px-4 py-2 bg-white bg-opacity-10 hover:bg-opacity-20 rounded-lg text-sm font-medium transition-all">
              <i class="fas fa-download mr-2"></i>Exportar CSV
            </button>
          </div>
          
          <div class="overflow-x-auto">
            <table class="screening-table">
              <thead>
                <tr>
                  <th>Ticker</th>
                  <th>Preço Atual</th>
                  <th>Flip Strike</th>
                  <th>Distância</th>
                  <th>Dist. %</th>
                  <th>Regime</th>
                  <th>Liquidez</th>
                  <th>Vencimento</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="resultsTableBody">
                <!-- Preenchido via JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // Configurações
    const API_BASE = window.location.origin + '/pro/screening';
    
    // Elementos DOM
    const customTickers = document.getElementById('customTickers');
    const screenBtn = document.getElementById('screenBtn');
    const statusMsg = document.getElementById('statusMsg');
    const summarySection = document.getElementById('summarySection');
    const resultsSection = document.getElementById('resultsSection');
    const resultsTableBody = document.getElementById('resultsTableBody');
    const progressContainer = document.getElementById('progressContainer');
    const progressText = document.getElementById('progressText');
    const progressPercent = document.getElementById('progressPercent');
    const progressFill = document.getElementById('progressFill');
    const exportBtn = document.getElementById('exportBtn');
    
    // State
    let currentResults = [];
    let presets = {};
    
    // Função do expander
    function toggleInfo() {
      const content = document.getElementById('infoContent');
      const icon = document.getElementById('infoIcon');
      
      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        content.style.animation = 'fadeIn 0.5s ease-in-out';
        icon.classList.remove('fa-info-circle');
        icon.classList.add('fa-times');
      } else {
        content.style.animation = 'fadeOut 0.3s ease-in-out';
        setTimeout(() => {
          content.classList.add('hidden');
        }, 300);
        icon.classList.remove('fa-times');
        icon.classList.add('fa-info-circle');
      }
    }
    window.toggleInfo = toggleInfo;
    
    // Funções utilitárias
    function showStatus(message, type = 'info') {
      const bgClass = type === 'success' ? 'bg-green-600 bg-opacity-20 border-green-500 border-opacity-30' : 
                     type === 'error' ? 'bg-red-600 bg-opacity-20 border-red-500 border-opacity-30' : 
                     'bg-blue-600 bg-opacity-20 border-blue-500 border-opacity-30';
      
      statusMsg.className = `mb-6 p-4 rounded-lg border backdrop-blur-sm ${bgClass}`;
      statusMsg.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} mr-2"></i>${message}`;
      statusMsg.classList.remove('hidden');
      
      if (type === 'success') {
        setTimeout(() => statusMsg.classList.add('hidden'), 5000);
      }
    }
    
    function formatCurrency(value) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(value);
    }
    
    function setLoading(button, loading) {
      if (loading) {
        button.classList.add('loading');
        button.innerHTML = '<span class="spinner mr-2"></span>Screening em andamento...';
      } else {
        button.classList.remove('loading');
        button.innerHTML = '<i class="fas fa-search mr-2"></i>Iniciar Screening';
      }
    }
    
    function showProgress(current, total) {
      progressContainer.classList.remove('hidden');
      const percent = Math.round((current / total) * 100);
      progressText.textContent = `Carregando ${current} de ${total} ativos...`;
      progressPercent.textContent = `${percent}%`;
      progressFill.style.width = `${percent}%`;
    }
    
    function hideProgress() {
      progressContainer.classList.add('hidden');
      progressFill.style.width = '0%';
    }
    
    // Testar conectividade da API
    async function testAPI() {
      try {
        const response = await fetch(`${API_BASE}/health`);
        const data = await response.json();
        
        if (response.ok) {
          document.getElementById('apiStatus').className = 'w-8 h-8 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-full flex items-center justify-center relative';
          return true;
        } else {
          throw new Error('API retornou erro');
        }
      } catch (error) {
        document.getElementById('apiStatus').className = 'w-8 h-8 bg-red-500 bg-opacity-10 border border-red-500 border-opacity-30 rounded-full flex items-center justify-center relative';
        return false;
      }
    }
    
    // Carregar presets
    async function loadPresets() {
      try {
        const response = await fetch(`${API_BASE}/presets`);
        const data = await response.json();
        
        if (response.ok && data.success) {
          presets = data.presets;
          console.log('Presets carregados:', Object.keys(presets).length);
        }
      } catch (error) {
        console.error('Erro ao carregar presets:', error);
      }
    }
    
    // Event listeners para presets
    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        const presetName = this.dataset.preset;
        const tickers = presets[presetName];
        
        if (tickers) {
          customTickers.value = tickers.join(', ');
          showStatus(`Lista "${presetName}" carregada com ${tickers.length} ativos`, 'info');
        }
      });
    });
    
    // Executar screening
    async function runScreening() {
      let tickersInput = customTickers.value.trim();
      
      if (!tickersInput) {
        showStatus('Digite os tickers ou selecione um preset', 'error');
        return;
      }
      
      const tickers = tickersInput
        .split(',')
        .map(t => t.trim().toUpperCase().replace('.SA', ''))
        .filter(t => t.length > 0);
      
      if (tickers.length === 0) {
        showStatus('Nenhum ticker válido encontrado', 'error');
        return;
      }
      
      setLoading(screenBtn, true);
      showProgress(0, tickers.length);
      showStatus(`Iniciando screening de ${tickers.length} ativos...`, 'info');
      
      summarySection.classList.add('hidden');
      resultsSection.classList.add('hidden');
      currentResults = [];
      
      try {
        const response = await fetch(`${API_BASE}/flip`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            tickers: tickers,
            max_workers: 5
          })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          currentResults = data.results || [];
          
          displaySummary(data.summary);
          displayResults(currentResults);
          
          showStatus(`Screening concluído: ${data.successful_analysis}/${data.total_tickers} ativos analisados`, 'success');
          
          if (data.errors && data.errors.length > 0) {
            console.warn('Erros no screening:', data.errors);
          }
        } else {
          const errorMsg = data.error || `Erro HTTP ${response.status}`;
          showStatus(errorMsg, 'error');
        }
      } catch (error) {
        showStatus('Erro ao conectar com o servidor', 'error');
        console.error(error);
      }
      
      hideProgress();
      setLoading(screenBtn, false);
    }
    
    // Auto-load screening completo
    async function autoLoadScreening() {
      try {
        showStatus('Carregando screening completo de 85 ativos...', 'info');
        showProgress(0, 85);
        
        const response = await fetch(`${API_BASE}/flip`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            max_workers: 5
          })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          currentResults = data.results || [];
          
          displaySummary(data.summary);
          displayResults(currentResults);
          
          showStatus(`✓ Screening carregado: ${data.successful_analysis} ativos`, 'success');
          
          if (data.errors && data.errors.length > 0) {
            console.warn('Erros no screening:', data.errors);
          }
        } else {
          const errorMsg = data.error || `Erro HTTP ${response.status}`;
          showStatus(errorMsg, 'error');
        }
      } catch (error) {
        showStatus('Erro ao carregar screening', 'error');
        console.error(error);
      }
      
      hideProgress();
    }
    
    // Exibir resumo
    function displaySummary(summary) {
      if (!summary) return;
      
      document.getElementById('totalAnalyzed').textContent = summary.total_analyzed || 0;
      
      const regimeDist = summary.regime_distribution || {};
      document.getElementById('totalLong').textContent = regimeDist['Long Gamma'] || 0;
      document.getElementById('totalShort').textContent = regimeDist['Short Gamma'] || 0;
      
      const distStats = summary.distance_statistics || {};
      const avgDist = distStats.mean ? Math.abs(distStats.mean).toFixed(1) : '--';
      document.getElementById('avgDistance').textContent = avgDist !== '--' ? `${avgDist}%` : '--';
      
      summarySection.classList.remove('hidden');
    }
    
    // Exibir resultados
    function displayResults(results) {
      if (!results || results.length === 0) {
        resultsTableBody.innerHTML = `
          <tr>
            <td colspan="9" class="text-center text-gray-400 py-8">
              <i class="fas fa-inbox text-4xl mb-2 block"></i>
              Nenhum resultado encontrado
            </td>
          </tr>
        `;
        return;
      }
      
      resultsTableBody.innerHTML = '';
      
      results.forEach(result => {
        const row = document.createElement('tr');
        
        let regimeBadge = `<span class="regime-neutral">Neutral</span>`;
        if (result.regime === 'Long Gamma') {
          regimeBadge = `<span class="regime-long"><i class="fas fa-arrow-up mr-1"></i>Long</span>`;
        } else if (result.regime === 'Short Gamma') {
          regimeBadge = `<span class="regime-short"><i class="fas fa-arrow-down mr-1"></i>Short</span>`;
        }
        
        let liquidityBadge = `<span class="liquidity-badge liquidity-media">Média</span>`;
        if (result.liquidity_category === 'ALTA') {
          liquidityBadge = `<span class="liquidity-badge liquidity-alta">Alta</span>`;
        } else if (result.liquidity_category === 'BAIXA') {
          liquidityBadge = `<span class="liquidity-badge liquidity-baixa">Baixa</span>`;
        }
        
        const distAbs = result.distance_abs || 0;
        const distPct = result.distance_pct || 0;
        const distClass = distPct > 0 ? 'distance-positive' : 'distance-negative';
        const distSign = distPct > 0 ? '+' : '';
        
        row.innerHTML = `
          <td>
            <span class="ticker-link" onclick="goToGammaLevels('${result.ticker}')">
              ${result.ticker}
            </span>
          </td>
          <td>${formatCurrency(result.spot_price || 0)}</td>
          <td>${result.flip_strike ? formatCurrency(result.flip_strike) : '--'}</td>
          <td class="${distClass}">${formatCurrency(distAbs)}</td>
          <td class="${distClass}">${distSign}${distPct.toFixed(2)}%</td>
          <td>${regimeBadge}</td>
          <td>${liquidityBadge}</td>
          <td class="text-xs text-gray-400">${result.expiration || '--'}</td>
          <td>
            <button 
              onclick="goToGammaLevels('${result.ticker}')"
              class="px-3 py-1 bg-geminii bg-opacity-20 hover:bg-opacity-30 text-geminii rounded text-xs font-medium transition-all"
            >
              <i class="fas fa-chart-line mr-1"></i>Analisar
            </button>
          </td>
        `;
        
        resultsTableBody.appendChild(row);
      });
      
      resultsSection.classList.remove('hidden');
    }
    
    // Navegar para Gamma Levels
    function goToGammaLevels(ticker) {
      window.location.href = `gamma-levels.html?ticker=${ticker}`;
    }
    window.goToGammaLevels = goToGammaLevels;
    
    // Exportar CSV
    function exportToCSV() {
      if (currentResults.length === 0) {
        showStatus('Nenhum resultado para exportar', 'error');
        return;
      }
      
      const headers = ['Ticker', 'Preço', 'Flip Strike', 'Distância Abs', 'Distância %', 'Regime', 'Liquidez', 'Vencimento'];
      const rows = currentResults.map(r => [
        r.ticker,
        r.spot_price?.toFixed(2) || '',
        r.flip_strike?.toFixed(2) || '',
        r.distance_abs?.toFixed(2) || '',
        r.distance_pct?.toFixed(2) || '',
        r.regime || '',
        r.liquidity_category || '',
        r.expiration || ''
      ]);
      
      let csvContent = headers.join(',') + '\n';
      csvContent += rows.map(row => row.join(',')).join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `screening_gamma_flip_${new Date().toISOString().slice(0,10)}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showStatus('CSV exportado com sucesso!', 'success');
    }
    
    // Event Listeners
    screenBtn.addEventListener('click', runScreening);
    exportBtn.addEventListener('click', exportToCSV);
    
    customTickers.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') runScreening();
    });
    
    // Inicialização
    async function initialize() {
      const apiConnected = await testAPI();
      
      if (apiConnected) {
        showStatus('Sistema de Screening carregado!', 'info');
        await loadPresets();
        await autoLoadScreening();
      } else {
        showStatus('Erro na conectividade da API', 'error');
      }
    }
    
    initialize();
  </script>
</body>
</html>