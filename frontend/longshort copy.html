<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Long&Short - Geminii Research</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#282a36',
                        light: '#ffffff',
                        subtle: 'rgba(255,255,255,0.1)',
                        geminii: '#ba39af'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
            background: #282a36;
        }

        .radar-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px) brightness(0.9);
            -webkit-backdrop-filter: blur(20px) brightness(0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            padding: 2.5rem;
        }

        .radar-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(186, 57, 175, 0.15);
            border-color: rgba(186, 57, 175, 0.3);
        }

        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 2px solid #ba39af;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            background: rgba(186, 57, 175, 0.1);
            border-color: rgba(186, 57, 175, 0.3);
            transform: translateY(-2px);
        }

        .metric-card.green {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .metric-card.blue {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.875rem;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.875rem;
        }

        tr:hover {
            background: rgba(186, 57, 175, 0.1);
            cursor: pointer;
        }

        .tab {
            padding: 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #9ca3af;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .tab.active {
            background: rgba(186, 57, 175, 0.2);
            border-color: rgba(186, 57, 175, 0.5);
            color: #fff;
        }

        .tab:hover {
            background: rgba(186, 57, 175, 0.1);
            border-color: rgba(186, 57, 175, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .direction-buy {
            color: #10b981;
            font-weight: bold;
        }

        .direction-sell {
            color: #ef4444;
            font-weight: bold;
        }

        .stop-loss {
            color: #ef4444;
        }

        .gain {
            color: #10b981;
        }

        .hidden {
            display: none;
        }

        .info-note {
            color: #9ca3af;
            font-style: italic;
            padding: 1rem;
            border-left: 3px solid rgba(186, 57, 175, 0.5);
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            margin-top: 1rem;
        }

        input, select {
            background: rgba(0, 0, 0, 0.5) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: white !important;
            padding: 0.5rem !important;
            border-radius: 8px !important;
            width: 100%;
        }

        input:focus, select:focus {
            outline: none;
            border-color: rgba(186, 57, 175, 0.5) !important;
        }

        .btn-primary {
            background: linear-gradient(90deg, #ba39af, #d946ef);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(186, 57, 175, 0.3);
        }

        nav {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        nav:hover {
            background: rgba(186, 57, 175, 0.05);
            border-color: rgba(186, 57, 175, 0.3);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 20px rgba(186, 57, 175, 0.2);
        }

        nav a:hover {
            color: #ba39af;
            text-shadow: 0 0 10px #ba39af;
        }

        .neon-logo {
            transition: all 0.3s ease;
            border-radius: 4px;
            cursor: pointer;
        }

        .neon-logo:hover {
            filter: drop-shadow(0 0 10px #ba39af) brightness(1.2);
            transform: scale(1.1);
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 2rem;
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .sidebar-section label {
            display: block;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            color: #9ca3af;
            font-weight: 500;
        }

        .financial-row {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.25rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .financial-row:hover {
            background: rgba(186, 57, 175, 0.1);
            border-color: rgba(186, 57, 175, 0.3);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .detail-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .detail-item strong {
            color: #9ca3af;
            display: block;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }

        .info-box {
            background: rgba(59, 130, 246, 0.1);
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        #zscoreChart, #betaChart, #spreadChart {
            min-height: 500px;
            width: 100%;
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.3);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 2rem;
        }

        .status-favoravel {
            color: #10b981;
            font-weight: bold;
        }

        .status-cautela {
            color: #f59e0b;
            font-weight: bold;
        }

        .status-naorecomendado {
            color: #ef4444;
            font-weight: bold;
        }

        .hurst-good {
            color: #10b981;
        }

        .hurst-bad {
            color: #ef4444;
        }
    </style>
</head>
<body class="text-white">
    <div class="relative min-h-screen">
        <nav class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 rounded-full px-4 py-3 shadow-xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <a href="/dashboard.html">
                    <img src="logo.png" alt="Geminii Logo" class="w-6 h-6 neon-logo">
                    </a>
                </div>
                <div class="hidden md:flex items-center space-x-6 text-xs text-gray-300 ml-8">
                    <span class="text-white font-medium">Long&Short</span>
                
                </div>
                <div class="flex items-center space-x-3 ml-8">
                    <div class="w-8 h-8 bg-green-500 bg-opacity-10 border border-green-500 border-opacity-30 rounded-full flex items-center justify-center relative">
                        <i class="fas fa-chart-line text-green-500 text-xs"></i>
                        <div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="relative z-10 pt-32 pb-16">
            <div class="px-6">
                <div class="fixed left-6 top-32 w-80 sidebar" style="max-height: calc(100vh - 10rem); overflow-y: auto;">
                    <div class="text-center mb-6"></div>
            
                    <div class="sidebar-section">
                        <label><i class="fas fa-dollar-sign mr-2"></i>Valor a ser investido (R$)</label>
                        <input type="number" id="investimento" value="10000" min="1000" step="1000">
                    </div>

                    <div class="sidebar-section">
                        <label><i class="fas fa-calendar mr-2"></i>Numero de dias para analise</label>
                        <select id="dias">
                            <option value="60">60</option>
                            <option value="90">90</option>
                            <option value="120" selected>120</option>
                            <option value="140">140</option>
                            <option value="180">180</option>
                        </select>
                    </div>

                    <div class="sidebar-section">
                        <label><i class="fas fa-chart-line mr-2"></i>Janela para Beta Rotation (dias)</label>
                        <input type="number" id="janelaBeta" value="60" min="30">
                    </div>

                    <div class="sidebar-section">
                        <label><i class="fas fa-signal mr-2"></i>Z-Score Minimo para Filtro</label>
                        <input type="number" id="zscoreMinimo" value="2.0" min="1.0" max="3.0" step="0.1">
                    </div>

                    <button class="btn-primary" onclick="analisarPares()">
                        <i class="fas fa-sync-alt mr-2"></i>Analisar Pares
                    </button>
                </div>

                <div style="margin-left: 400px; padding-right: 2rem;">
                    <div class="text-center mb-12">
                        <h1 class="text-4xl md:text-5xl font-bold mb-4">
                            <span class="text-geminii font-bold">Long&Short</span>
                            <span class="text-white font-light"> - Analise por Cointegracao</span>
                        </h1>
                        <p class="text-gray-300 text-lg max-w-4xl mx-auto">
                            Sistema inteligente de analise quantitativa para identificacao de pares cointegrados no mercado brasileiro, 
                            com calculo automatico de RSL, stops e gerenciamento de risco.
                        </p>
                    </div>

                    <div id="loadingSection" class="hidden text-center py-16">
                        <div class="loading-spinner"></div>
                        <p class="mt-4 text-gray-300">Analisando pares cointegrados...</p>
                    </div>

                    <div id="resultsSection">
                        <div class="radar-card" style="margin-bottom: 2rem;">
                            <h3 class="text-2xl font-bold text-white mb-6">
                                <i class="fas fa-search mr-2 text-geminii"></i>
                                Resultado da Analise de Pares
                            </h3>
                            <p id="volumeProcessado" class="text-gray-300 mb-8">Clique em "Analisar Pares" para iniciar</p>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="metric-card green">
                                    <div id="paresEncontrados" class="text-white text-center text-gray-400">Aguardando analise...</div>
                                </div>
                                <div class="metric-card blue">
                                    <div id="setoresUnicos" class="text-white text-center text-gray-400">Aguardando analise...</div>
                                </div>
                            </div>
                        </div>

                        <div class="radar-card" style="margin-bottom: 2rem;">
                            <table id="paresTable">
                                <thead>
                                    <tr>
                                        <th>Acao1</th>
                                        <th>Acao2</th>
                                        <th>Meia-vida</th>
                                        <th>P-valor Coint</th>
                                        <th>Status Beta</th>
                                        <th>Z-score</th>
                                        <th>Direcao 1</th>
                                        <th>Direcao 2</th>
                                    </tr>
                                </thead>
                                <tbody id="paresTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center text-gray-400 py-8">Nenhum par analisado ainda</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div id="detailSection" class="hidden">
                            <div class="radar-card" style="margin-bottom: 2rem;">
                                <h3 class="text-2xl font-bold text-white mb-8">
                                    <i class="fas fa-chart-bar mr-2 text-geminii"></i>
                                    Analise Detalhada de Par
                                </h3>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    <div class="info-box">
                                        <strong id="acao1Setor" class="text-white"></strong>
                                    </div>
                                    <div class="info-box">
                                        <strong id="acao2Setor" class="text-white"></strong>
                                    </div>
                                </div>

                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <strong>Detalhes do Par:</strong>
                                        <div id="detalhesParInfo" class="text-white mt-2"></div>
                                    </div>
                                    <div class="detail-item">
                                        <strong>Testes Estatisticos:</strong>
                                        <div id="testesEstatisticos" class="text-white mt-2"></div>
                                    </div>
                                </div>

                                <h3 id="financialHeader" class="text-xl font-bold text-geminii mb-6"></h3>

                                <div class="flex gap-3 mb-6 flex-wrap">
                                    <button class="tab active" onclick="switchTab(0)">Z-score</button>
                                    <button class="tab" onclick="switchTab(1)">Resumo Financeiro</button>
                                    <button class="tab" onclick="switchTab(2)">Stop/Gain ATR</button>
                                    <button class="tab" onclick="switchTab(3)">Beta Rotation</button>
                                    <button class="tab" onclick="switchTab(4)">Spread</button>
                                    <button class="tab" onclick="switchTab(5)">Margem e Custos</button>
                                    <button class="tab" onclick="switchTab(6)">Analise Periodos</button>
                                </div>

                                <div class="tab-content active" id="tab0">
                                    <div class="chart-container">
                                        <div id="zscoreChart"></div>
                                    </div>
                                </div>

                                <div class="tab-content" id="tab1">
                                    <div id="resumoFinanceiro"></div>
                                </div>

                                <div class="tab-content" id="tab2">
                                    <div id="stopGain"></div>
                                </div>

                                <div class="tab-content" id="tab3">
                                    <div class="chart-container">
                                        <div id="betaChart"></div>
                                    </div>
                                    <div id="betaAnalise"></div>
                                </div>

                                <div class="tab-content" id="tab4">
                                    <div class="chart-container">
                                        <div id="spreadChart"></div>
                                    </div>
                                </div>

                                <div class="tab-content" id="tab5">
                                    <div id="margemCustos"></div>
                                </div>

                                <div class="tab-content" id="tab6">
                                    <div id="analiseEstabilidade"></div>
                                </div>
                            </div>
                        </div>

                        <div class="radar-card" style="margin-bottom: 2rem;">
                            <h3 class="text-xl font-bold text-white mb-6">
                                <i class="fas fa-info-circle mr-2 text-blue-400"></i>
                                Dinamica de Mercado
                            </h3>
                            <p class="text-gray-300 leading-relaxed text-base">
                                E importante lembrar que a eficacia dessa estrategia depende da <strong class="text-white">dinamica do mercado</strong>. 
                                Nem sempre os pares se comportam como esperado, pois eventos inesperados, mudancas no cenario economico, 
                                noticias ou fundamentos das empresas podem afetar a relacao entre os precos.
                            </p>
                            <p class="text-gray-300 leading-relaxed text-base mt-6">
                                Portanto, o sucesso da estrategia depende de <strong class="text-white">monitorar constantemente os trades</strong> 
                                e adaptar os parametros conforme as condicoes do mercado mudam.
                            </p>
                        </div>

                        <div class="radar-card">
                            <h3 class="text-xl font-bold text-white mb-6">
                                <i class="fas fa-exclamation-triangle mr-2 text-yellow-400"></i>
                                Disclaimer
                            </h3>
                            <p class="text-gray-300 leading-relaxed text-base">
                                O conteudo deste material e destinado exclusivamente a fins informativos e educacionais. 
                                As analises, opinioes e informacoes apresentadas nao constituem recomendacao de investimento. 
                                Cada investidor deve fazer sua propria analise e tomar suas decisoes de forma independente, 
                                considerando seu perfil, objetivos e tolerancia a risco.
                            </p>
                            <p class="text-geminii font-semibold mt-6 text-base">
                                Diego Doneda, Analista CNPI - 9668<br>
                                Geminii Learn Ai & Machine Learning
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api/longshort';
        let paresData = [];
        let currentPar = null;

        function switchTab(index) {
            document.querySelectorAll('.tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            document.querySelectorAll('.tab-content').forEach((content, i) => {
                content.classList.toggle('active', i === index);
            });
        }

        function getStatusClass(status) {
            if (status === 'Favoravel') return 'status-favoravel';
            if (status === 'Cautela') return 'status-cautela';
            return 'status-naorecomendado';
        }

        function getHurstClass(hurst) {
            return hurst < 0.5 ? 'hurst-good' : 'hurst-bad';
        }

        async function analisarPares() {
            const investimento = parseFloat(document.getElementById('investimento').value);
            const dias = parseInt(document.getElementById('dias').value);
            const janelaBeta = parseInt(document.getElementById('janelaBeta').value);
            const zscoreMinimo = parseFloat(document.getElementById('zscoreMinimo').value);

            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('resultsSection').style.opacity = '0.5';
            document.getElementById('detailSection').classList.add('hidden');

            try {
                const response = await fetch(`${API_URL}/analisar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ investimento, dias, janelaBeta, zscoreMinimo })
                });

                const data = await response.json();

                if (data.sucesso) {
                    paresData = data.pares;
                    displayResults(data);
                    document.getElementById('resultsSection').style.opacity = '1';
                } else {
                    alert('Erro: ' + data.erro);
                }
            } catch (error) {
                alert('Erro ao conectar com a API: ' + error.message);
            } finally {
                document.getElementById('loadingSection').classList.add('hidden');
            }
        }

        function displayResults(data) {
            document.getElementById('volumeProcessado').textContent = 
                `Volume Total Processado: ${data.totalParesAnalisados} pares analisados`;
            
            document.getElementById('paresEncontrados').innerHTML = 
                `<i class="fas fa-check-circle mr-2"></i>${data.paresEncontrados} pares identificados com oportunidade de trading`;
            
            document.getElementById('setoresUnicos').innerHTML = 
                `<i class="fas fa-chart-pie mr-2"></i>${data.setoresUnicos} setores diferentes identificados nas oportunidades`;

            const tbody = document.getElementById('paresTableBody');
            tbody.innerHTML = '';

            if (data.pares.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-400 py-8">Nenhum par encontrado com os criterios selecionados</td></tr>';
                return;
            }

            data.pares.forEach((par, index) => {
                const row = tbody.insertRow();
                row.onclick = () => selecionarPar(par);
                
                const statusClass = getStatusClass(par.status);
                const pvalorCoint = par.pvalorCointegracao || par.PvalorCointegracao || 0;
                const pvalorClass = pvalorCoint < 0.05 ? 'direction-buy' : 'direction-sell';
                
                row.innerHTML = `
                    <td>${par.acao1}</td>
                    <td>${par.acao2}</td>
                    <td>${(par.meiaVida || 0).toFixed(2)}</td>
                    <td class="${pvalorClass}">${pvalorCoint.toFixed(4)}</td>
                    <td class="${statusClass}">${par.status}</td>
                    <td>${(par.zscoreAtual || 0).toFixed(2)}</td>
                    <td class="${par.direcaoAcao1 === 'Compra' ? 'direction-buy' : 'direction-sell'}">${par.direcaoAcao1}</td>
                    <td class="${par.direcaoAcao2 === 'Compra' ? 'direction-buy' : 'direction-sell'}">${par.direcaoAcao2}</td>
                `;
            });
        }

        async function selecionarPar(par) {
            currentPar = par;
            const investimento = parseFloat(document.getElementById('investimento').value);
            const dias = parseInt(document.getElementById('dias').value);
            const janelaBeta = parseInt(document.getElementById('janelaBeta').value);

            const acao1 = par.acao1;
            const acao2 = par.acao2;

            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('detailSection').classList.add('hidden');

            // USAR setorAcao1 e setorAcao2 da resposta da API
            document.getElementById('acao1Setor').textContent = `${acao1}: Carregando...`;
            document.getElementById('acao2Setor').textContent = `${acao2}: Carregando...`;

            try {
                const response = await fetch(`${API_URL}/par/${acao1}/${acao2}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ investimento, dias, janelaBeta })
                });

                const data = await response.json();

                console.log('Resposta da API:', data); 

                if (data.sucesso) {
                    // ATUALIZAR SETORES COM DADOS DA API
                    document.getElementById('acao1Setor').textContent = `${acao1}: ${data.par.setorAcao1}`;
                    document.getElementById('acao2Setor').textContent = `${acao2}: ${data.par.setorAcao2}`;
                    
                    displayParDetails(data, par);
                    loadCharts(data.par, dias, janelaBeta, investimento, data);
                    document.getElementById('detailSection').classList.remove('hidden');
                    
                    setTimeout(() => {
                        document.getElementById('detailSection').scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }, 100);
                }
            } catch (error) {
                console.error('Erro ao carregar detalhes do par:', error);
                alert('Erro ao carregar analise detalhada: ' + error.message);
            } finally {
                document.getElementById('loadingSection').classList.add('hidden');
            }
        }

        function displayParDetails(data, parOriginal) {
            // Validação básica
            if (!data || !data.par) {
                console.error('Dados inválidos:', data);
                alert('Erro: Dados do par não foram recebidos corretamente');
                return;
            }
            
            const par = data.par;
            const qtd = data.quantidades || {};
            const sg = data.stopGain || {};
            
            const acao1 = par.acao1 || 'N/A';
            const acao2 = par.acao2 || 'N/A';
            
            // Detalhes do Par com validações
            const correlacao = par.correlacao ?? 0;
            const beta = par.beta ?? 0;
            const meiaVida = par.meiaVida ?? 0;
            const r2 = par.r2 ?? 0;
            
            document.getElementById('detalhesParInfo').innerHTML = `
                Correlacao: ${correlacao.toFixed(4)}<br>
                Beta: ${beta.toFixed(4)}<br>
                Meia-vida: ${meiaVida.toFixed(2)} dias<br>
                R²: ${r2.toFixed(4)}
            `;
            
            // Testes Estatísticos com validações
            const pvalorCoint = par.pvalorCointegracao ?? 1;
            const pvalorADF = par.pvalorADF ?? 1;
            const zscore = par.zscoreAtual ?? 0;
            
            document.getElementById('testesEstatisticos').innerHTML = `
                P-valor Cointegracao: ${pvalorCoint.toFixed(4)} ${pvalorCoint < 0.05 ? '<span class="direction-buy">(OK)</span>' : '<span class="direction-sell">(FALHOU)</span>'}<br>
                P-valor ADF: ${pvalorADF.toFixed(4)} ${pvalorADF < 0.05 ? '<span class="direction-buy">(OK)</span>' : '<span class="direction-sell">(FALHOU)</span>'}<br>
                Z-score atual: ${zscore.toFixed(4)}
            `;

            // Header Financeiro
            const investimento = parseFloat(document.getElementById('investimento').value);
            document.getElementById('financialHeader').textContent = 
                `Financeiro a ser Investido R$ ${investimento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;

            // Resumo Financeiro com validações
            const qtd1 = qtd.qtd1 ?? 0;
            const qtd2 = qtd.qtd2 ?? 0;
            const preco1 = qtd.ultimoPreco1 ?? 0;
            const preco2 = qtd.ultimoPreco2 ?? 0;
            const valor1 = qtd.valorTotal1 ?? 0;
            const valor2 = qtd.valorTotal2 ?? 0;
            const impacto = qtd.impactoLiquido ?? 0;
            const direcao1 = par.direcaoAcao1 || 'N/A';
            const direcao2 = par.direcaoAcao2 || 'N/A';
            
            document.getElementById('resumoFinanceiro').innerHTML = `
                <div class="financial-row">
                    <span>${acao1}</span>
                    <span class="${direcao1 === 'Compra' ? 'direction-buy' : 'direction-sell'}">${direcao1}</span>
                    <span>${qtd1} acoes</span>
                    <span>R$ ${preco1.toFixed(2)}</span>
                    <span>R$ ${valor1.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                </div>
                <div class="financial-row">
                    <span>${acao2}</span>
                    <span class="${direcao2 === 'Compra' ? 'direction-buy' : 'direction-sell'}">${direcao2}</span>
                    <span>${qtd2} acoes</span>
                    <span>R$ ${preco2.toFixed(2)}</span>
                    <span>R$ ${valor2.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                </div>
                <div class="financial-row" style="background-color: #2a2a2a; font-weight: bold;">
                    <span>Impacto financeiro liquido na conta:</span>
                    <span>R$ ${impacto.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                </div>
                <div class="info-note">
                    * As quantidades podem nao coincidir exatamente com os valores financeiros, 
                    pois sao arredondadas para manter a neutralidade da operacao.
                </div>
            `;

            // Stop/Gain com validações
            const valorStop = sg.valorStop ?? 0;
            const valorGain = sg.valorGain ?? 0;
            const percentualStop = sg.percentualStop ?? 0;
            const percentualGain = sg.percentualGain ?? 0;
            
            document.getElementById('stopGain').innerHTML = `
                <div class="financial-row">
                    <span class="stop-loss">Stop-Loss:</span>
                    <span class="stop-loss">R$ ${valorStop.toLocaleString('pt-BR', {minimumFractionDigits: 2})} (${percentualStop.toFixed(2)}%)</span>
                </div>
                <div class="financial-row">
                    <span class="gain">Gain:</span>
                    <span class="gain">R$ ${valorGain.toLocaleString('pt-BR', {minimumFractionDigits: 2})} (${percentualGain.toFixed(2)}%)</span>
                </div>
                <div class="info-note">
                    A analise sugere gain e stop considerando a volatilidade dos ativos, alem de avaliar o retorno a media.
                </div>
            `;
        }

        async function loadCharts(par, dias, janelaBeta, investimento, parData) {
            const acao1 = par.Acao1 || par.acao1;
            const acao2 = par.Acao2 || par.acao2;
            
            loadZscoreChart({acao1, acao2}, dias);
            loadSpreadChart({acao1, acao2}, dias);
            loadBetaChart({acao1, acao2}, dias, janelaBeta);
            loadEstabilidadeTable({acao1, acao2}, dias);
            loadMargemCustos(parData, par);
        }

        async function loadZscoreChart(par, dias) {
            try {
                const response = await fetch(`${API_URL}/zscore/${par.acao1}/${par.acao2}?dias=${dias}`);
                const data = await response.json();

                if (data.sucesso) {
                    const trace = {
                        x: data.zscore.datas,
                        y: data.zscore.zscore,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Z-score',
                        line: { color: '#1DA1F2' }
                    };

                    const layout = {
                        title: `Z-score para ${par.acao1} vs ${par.acao2}`,
                        xaxis: { title: 'Data', showgrid: false, zeroline: false },
                        yaxis: { title: 'Z-score', showgrid: false, zeroline: false },                        
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        font: { color: '#fafafa' },
                        height: 500,
                        shapes: [
                            { type: 'line', x0: data.zscore.datas[0], x1: data.zscore.datas[data.zscore.datas.length-1], y0: 0, y1: 0, line: { color: 'white', dash: 'dash', width: 1 } },
                            { type: 'line', x0: data.zscore.datas[0], x1: data.zscore.datas[data.zscore.datas.length-1], y0: 2, y1: 2, line: { color: '#10b981', dash: 'dash' } },
                            { type: 'line', x0: data.zscore.datas[0], x1: data.zscore.datas[data.zscore.datas.length-1], y0: -2, y1: -2, line: { color: '#10b981', dash: 'dash' } },
                            { type: 'line', x0: data.zscore.datas[0], x1: data.zscore.datas[data.zscore.datas.length-1], y0: 3, y1: 3, line: { color: '#ef4444', dash: 'dash' } },
                            { type: 'line', x0: data.zscore.datas[0], x1: data.zscore.datas[data.zscore.datas.length-1], y0: -3, y1: -3, line: { color: '#ef4444', dash: 'dash' } }
                        ]
                    };

                    Plotly.newPlot('zscoreChart', [trace], layout, {responsive: true, displayModeBar: true});
                }
            } catch (error) {
                console.error('Erro ao carregar Z-score:', error);
            }
        }

        async function loadBetaChart(par, dias, janela) {
            try {
                const response = await fetch(`${API_URL}/beta/${par.acao1}/${par.acao2}?dias=${dias}&janela=${janela}`);
                const data = await response.json();

                if (data.sucesso) {
                    const beta = data.beta;
                    
                    const trace = {
                        x: beta.datas,
                        y: beta.beta,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Beta Rotation',
                        line: { color: '#1DA1F2', width: 2 }
                    };

                    const layout = {
                        title: `Beta Rotation: ${par.acao1} vs ${par.acao2} (Janela: ${janela} dias)`,
                        xaxis: { title: 'Data', showgrid: false, zeroline: false },
                        yaxis: { title: 'Beta', showgrid: false, zeroline: false },
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        font: { color: '#fafafa' },
                        height: 500,
                        shapes: [
                            { 
                                type: 'line', 
                                x0: beta.datas[0], 
                                x1: beta.datas[beta.datas.length-1], 
                                y0: beta.mediaBeta, 
                                y1: beta.mediaBeta, 
                                line: { color: 'white', dash: 'dash', width: 2 } 
                            },
                            { 
                                type: 'line', 
                                x0: beta.datas[0], 
                                x1: beta.datas[beta.datas.length-1], 
                                y0: beta.limiteSuperior, 
                                y1: beta.limiteSuperior, 
                                line: { color: '#10b981', dash: 'dot', width: 1 } 
                            },
                            { 
                                type: 'line', 
                                x0: beta.datas[0], 
                                x1: beta.datas[beta.datas.length-1], 
                                y0: beta.limiteInferior, 
                                y1: beta.limiteInferior, 
                                line: { color: '#10b981', dash: 'dot', width: 1 } 
                            }
                        ]
                    };

                    Plotly.newPlot('betaChart', [trace], layout, {responsive: true, displayModeBar: true});

                    const analise = data.analise;
                    if (analise) {
                        const statusClass = getStatusClass(analise.status);
                        document.getElementById('betaAnalise').innerHTML = `
                            <div class="detail-grid" style="margin-top: 1.5rem;">
                                <div class="detail-item">
                                    <strong>Status da Operacao:</strong>
                                    <span class="${statusClass}">${analise.status}</span>
                                </div>
                                <div class="detail-item">
                                    <strong>Nivel de Risco:</strong>
                                    <span>${analise.nivelRisco}</span>
                                </div>
                            </div>
                            <div class="info-box" style="margin-top: 1rem;">
                                <strong>Explicacao:</strong> ${analise.explicacaoStatus || 'N/A'}
                            </div>
                            <div class="info-box" style="margin-top: 1rem;">
                                <strong>Interpretacao:</strong> ${analise.interpretacao || 'N/A'}
                            </div>
                            ${analise.sugestoes && analise.sugestoes.length > 0 ? `
                            <div class="detail-item" style="margin-top: 1rem;">
                                <strong>Sugestoes Praticas:</strong>
                                <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                    ${analise.sugestoes.map(s => `<li>${s}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}
                        `;
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar Beta:', error);
            }
        }

        async function loadSpreadChart(par, dias) {
            try {
                const response = await fetch(`${API_URL}/spread/${par.acao1}/${par.acao2}?dias=${dias}`);
                const data = await response.json();

                if (data.sucesso) {
                    const spread = data.spread;
                    
                    const valores = spread.spread;
                    const media = valores.reduce((a, b) => a + b, 0) / valores.length;
                    const variancia = valores.reduce((sum, val) => sum + Math.pow(val - media, 2), 0) / valores.length;
                    const desvio = Math.sqrt(variancia);
                    
                    const trace = {
                        x: spread.datas,
                        y: spread.spread,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Spread',
                        line: { color: '#ba39af', width: 2 }
                    };

                    const layout = {
                        title: `Spread Cointegrado: ${par.acao1} vs ${par.acao2}`,
                        xaxis: { title: 'Data', showgrid: false, zeroline: false },
                        yaxis: { title: 'Spread (Ratio)', showgrid: false, zeroline: false },
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        font: { color: '#fafafa' },
                        height: 500,
                        shapes: [
                            { 
                                type: 'line', 
                                x0: spread.datas[0], 
                                x1: spread.datas[spread.datas.length-1], 
                                y0: media, 
                                y1: media, 
                                line: { color: 'white', dash: 'dash', width: 2 } 
                            },
                            { 
                                type: 'line', 
                                x0: spread.datas[0], 
                                x1: spread.datas[spread.datas.length-1], 
                                y0: media + 2 * desvio, 
                                y1: media + 2 * desvio, 
                                line: { color: '#10b981', dash: 'dot', width: 1 } 
                            },
                            { 
                                type: 'line', 
                                x0: spread.datas[0], 
                                x1: spread.datas[spread.datas.length-1], 
                                y0: media - 2 * desvio, 
                                y1: media - 2 * desvio, 
                                line: { color: '#10b981', dash: 'dot', width: 1 } 
                            }
                        ]
                    };

                    Plotly.newPlot('spreadChart', [trace], layout, {responsive: true, displayModeBar: true});
                }
            } catch (error) {
                console.error('Erro ao carregar Spread:', error);
            }
        }

        async function loadEstabilidadeTable(par, dias) {
            try {
                const response = await fetch(`${API_URL}/estabilidade/${par.acao1}/${par.acao2}?dias=${dias}`);
                const data = await response.json();

                if (data.sucesso) {
                    let html = `
                            <h3 class="text-xl font-bold text-white mb-4">Analise de Estabilidade por Periodos</h3>
                            <div class="detail-grid">
                                <div>
                                    <table style="width: 100%;">
                                        <thead>
                                            <tr>
                                                <th>Periodo</th>
                                                <th>P-valor Coint</th>
                                                <th>Meia-vida</th>
                                                <th>R²</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                        `;

                        (data.periodos || []).forEach(p => {
                            const statusClass = p.status === 'Cointegrado' ? 'direction-buy' : 'direction-sell';
                            const meiaVida = p.meiaVida !== null ? p.meiaVida.toFixed(2) : 'N/A';
                            html += `
                                <tr>
                                    <td>${p.periodo} dias</td>
                                    <td>${p.pvalorCoint.toFixed(4)}</td>
                                    <td>${meiaVida}</td>
                                    <td>${p.r2.toFixed(4)}</td>
                                    <td class="${statusClass}">${p.status}</td>
                                </tr>
                            `;
                        });

             
                    html += `
                                    </tbody>
                                </table>
                            </div>
                            <div class="detail-item">
                                <strong>Diagnostico</strong>
                                <p style="margin-top: 0.5rem;">${data.diagnostico ? data.diagnostico.mensagem : 'N/A'}</p>
                                ${data.diagnostico ? `
                                <p style="margin-top: 1rem;">
                                    Periodos cointegrados: ${data.diagnostico.periodosCointegrados} de ${data.diagnostico.totalPeriodos}<br>
                                    R² medio: ${(data.diagnostico.r2Medio || 0).toFixed(4)}
                                </p>
                                ` : ''}
                            </div>
                        </div>
                    `;

                    document.getElementById('analiseEstabilidade').innerHTML = html;
                }
            } catch (error) {
                console.error('Erro ao carregar estabilidade:', error);
            }
        }

        function loadMargemCustos(parData, parOriginal) {
            const qtd = parData.quantidades || parData.operacao || {};
            const par = parData.par || parOriginal;
            const sinal = parData.sinal || par;
            
            const direcaoAcao1 = sinal.direcaoAcao1 || sinal.DirecaoAcao1 || par.DirecaoAcao1 || par.direcaoAcao1;
            
            const valor1 = qtd.valorTotal1 || (qtd.acao1 && qtd.acao1.valor) || 0;
            const valor2 = qtd.valorTotal2 || (qtd.acao2 && qtd.acao2.valor) || 0;
            
            const valorVendido = direcaoAcao1 === 'Venda' ? valor1 : valor2;
            const valorComprado = direcaoAcao1 === 'Compra' ? valor1 : valor2;

            document.getElementById('margemCustos').innerHTML = `
                <h3 class="text-xl font-bold text-white mb-4">Analise de Margem e Custos Operacionais</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <strong>Parametros</strong>
                        <label style="display: block; margin-top: 0.5rem;">Percentual de Garantia (%):</label>
                        <input type="number" id="percGarantia" value="25.0" style="width: 100%; padding: 0.5rem;">
                        
                        <label style="display: block; margin-top: 0.5rem;">Taxa BTC Anual (%):</label>
                        <input type="number" id="taxaBtc" value="2.0" style="width: 100%; padding: 0.5rem;">
                    </div>
                    <div class="detail-item">
                        <strong>Execucao</strong>
                        <label style="display: block; margin-top: 0.5rem;">Dias da Operacao:</label>
                        <input type="number" id="diasOp" value="10" style="width: 100%; padding: 0.5rem;">
                        
                        <label style="display: block; margin-top: 0.5rem;">Taxa Corretora sobre BTC (%):</label>
                        <input type="number" id="taxaCorr" value="35.0" style="width: 100%; padding: 0.5rem;">
                    </div>
                </div>
                <button class="btn-primary" onclick="calcularMargem(${valorVendido}, ${valorComprado})">Calcular Margem e Custos</button>
                <div id="resultadoMargem" style="margin-top: 1rem;"></div>
            `;
        }

        async function calcularMargem(valorVendido, valorComprado) {
            const percGarantia = parseFloat(document.getElementById('percGarantia').value);
            const taxaBtc = parseFloat(document.getElementById('taxaBtc').value);
            const diasOp = parseInt(document.getElementById('diasOp').value);
            const taxaCorr = parseFloat(document.getElementById('taxaCorr').value);

            try {
                const response = await fetch(`${API_URL}/margem`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        valorVendido,
                        valorComprado,
                        percentualGarantia: percGarantia,
                        taxaBtcAnual: taxaBtc,
                        diasOperacao: diasOp,
                        taxaCorretoraBtc: taxaCorr
                    })
                });

                const data = await response.json();

                if (data.sucesso) {
                    const m = data.margem;
                    document.getElementById('resultadoMargem').innerHTML = `
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>Valores da Operacao</strong>
                                <div style="margin-top: 0.5rem;">
                                    Total Vendido: R$ ${m.valorVendido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>
                                    Total Comprado: R$ ${m.valorComprado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>
                                    Garantia sobre Vendas: R$ ${m.garantiaVenda.toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>
                                    Contragarantia sobre Compras: R$ ${m.garantiaCompra.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                                </div>
                            </div>
                            <div class="detail-item">
                                <strong>Margem e Custos</strong>
                                <div style="margin-top: 0.5rem;">
                                    Margem Necessaria: R$ ${m.margemNecessaria.toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>
                                    Emolumentos B3: R$ ${m.emolumentos.toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>
                                    Custo BTC: R$ ${m.custoBTC.toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>
                                    Taxa Corretora BTC: R$ ${m.taxaCorretora.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                                </div>
                            </div>
                        </div>
                        <div class="financial-row" style="background: linear-gradient(90deg, rgba(186,57,175,0.3), rgba(217,70,239,0.3)); font-weight: bold; margin-top: 1rem;">
                            <span>Custo Total Estimado:</span>
                            <span>R$ ${m.custoTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao calcular margem:', error);
            }
        }
    </script>
</body>
</html>